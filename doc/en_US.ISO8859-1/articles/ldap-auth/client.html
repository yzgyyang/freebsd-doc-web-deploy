<?xml version="1.0" encoding="iso-8859-1" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" /><title>3. Client Configuration</title><link rel="stylesheet" type="text/css" href="docbook.css" /><link rev="made" href="mailto:doc@FreeBSD.org" /><meta name="generator" content="DocBook XSL Stylesheets V1.79.1" /><link rel="home" href="index.html" title="LDAP Authentication" /><link rel="up" href="index.html" title="LDAP Authentication" /><link rel="prev" href="ldap.html" title="2. Configuring LDAP" /><link rel="next" href="secure.html" title="4. Security Considerations" /><link rel="copyright" href="trademarks.html" title="Legal Notice" /><script xmlns="" type="text/javascript" src="/layout/js/google.js"></script></head><body><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">3. Client Configuration</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="ldap.html">Prev</a> </td><th width="60%" align="center"> </th><td width="20%" align="right"> <a accesskey="n" href="secure.html">Next</a></td></tr></table><hr /></div><div class="sect1"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="client"></a>3. Client Configuration</h2></div></div></div><p>The client should already have
      <span class="application">OpenLDAP</span> libraries from <a class="xref" href="ldap.html#ldap-connect-client" title="2.1.3. Configuring the Client">Section 2.1.3, &#8220;Configuring the Client&#8221;</a>, but if you are installing
      several client machines you will need to install
      <a xmlns="" class="package" href="https://www.freebsd.org/cgi/url.cgi?ports/net/openldap24-client/pkg-descr">net/openldap24-client</a> on each of them.</p><p>FreeBSD requires two ports to be installed to authenticate
      against an LDAP server, <a xmlns="" class="package" href="https://www.freebsd.org/cgi/url.cgi?ports/security/pam_ldap/pkg-descr">security/pam_ldap</a> and
      <a xmlns="" class="package" href="https://www.freebsd.org/cgi/url.cgi?ports/net/nss_ldap/pkg-descr">net/nss_ldap</a>.</p><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="client-auth"></a>3.1. Authentication</h3></div></div></div><p><a xmlns="" class="package" href="https://www.freebsd.org/cgi/url.cgi?ports/security/pam_ldap/pkg-descr">security/pam_ldap</a> is configured via
	<code class="filename">/usr/local/etc/ldap.conf</code>.</p><div xmlns="" class="note"><h3 class="admontitle">Note: </h3><p xmlns="http://www.w3.org/1999/xhtml">This is a <span class="emphasis"><em>different file</em></span> than the
	  <span class="application">OpenLDAP</span> library functions'
	  configuration file,
	  <code class="filename">/usr/local/etc/openldap/ldap.conf</code>;
	  however, it takes many of the same options; in fact it is a
	  superset of that file.  For the rest of this section,
	  references to <code class="filename">ldap.conf</code> will mean
	  <code class="filename">/usr/local/etc/ldap.conf</code>.</p></div><p>Thus, we will want to copy all of our original
	configuration parameters from
	<code class="filename">openldap/ldap.conf</code> to the new
	<code class="filename">ldap.conf</code>.  Once this is done, we want to
	tell <a xmlns="" class="package" href="https://www.freebsd.org/cgi/url.cgi?ports/security/pam_ldap/pkg-descr">security/pam_ldap</a> what to look for on
	the directory server.</p><p>We are identifying our users with the
	<code class="literal">uid</code> attribute.  To configure this (though
	it is the default), set the
	<code class="literal">pam_login_attribute</code> directive in
	<code class="filename">ldap.conf</code>:</p><div class="example"><a id="set-pam-login-attr"></a><div class="example-title">Example 4. Setting <code class="literal">pam_login_attribute</code></div><div class="example-contents"><pre class="programlisting">pam_login_attribute uid</pre></div></div><br class="example-break" /><p>With this set, <a xmlns="" class="package" href="https://www.freebsd.org/cgi/url.cgi?ports/security/pam_ldap/pkg-descr">security/pam_ldap</a> will
	search the entire LDAP directory under <code class="literal">base</code>
	for the value
	<code class="literal">uid=<em class="replaceable"><code>username</code></em></code>.
	If it finds one and only one entry, it will attempt to bind as
	that user with the password it was given.  If it binds
	correctly, then it will allow access.  Otherwise it will
	fail.</p><p>Users whose shell is not in
	<code class="filename">/etc/shells</code> will not be able to log in.
	This is particularly important when
	<span class="application">Bash</span> is set as the user shell on
	the LDAP server.  <span class="application">Bash</span> is not
	included with a default installation of FreeBSD.  When installed
	from a package or port, it is located at
	<code class="filename">/usr/local/bin/bash</code>.  Verify that the
	path to the shell on the server is set correctly:</p><pre class="screen"><code class="prompt">%</code> <strong class="userinput"><code>getent passwd <em class="replaceable"><code>username</code></em></code></strong></pre><p>There are two choices when the output shows
	<code class="literal">/bin/bash</code> in the last column.  The first is
	to change the user's entry on the LDAP server to
	<code class="filename">/usr/local/bin/bash</code>.  The second option
	is to create a symlink on the LDAP client computer so
	<span class="application">Bash</span> is found at the correct
	location:</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>ln -s /usr/local/bin/bash /bin/bash</code></strong></pre><p>Make sure that <code class="filename">/etc/shells</code> contains
	entries for both <code class="literal">/usr/local/bin/bash</code> and
	<code class="literal">/bin/bash</code>.  The user will then be able to
	log in to the system with <span class="application">Bash</span> as
	their shell.</p><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="client-auth-pam"></a>3.1.1. PAM</h4></div></div></div><p>PAM, which stands for <span class="quote">&#8220;<span class="quote">Pluggable Authentication
	    Modules</span>&#8221;</span>, is the method by which FreeBSD authenticates
	  most of its sessions.  To tell FreeBSD we wish to use an LDAP
	  server, we will have to add a line to the appropriate PAM
	  file.</p><p>Most of the time the appropriate PAM file is
	  <code class="filename">/etc/pam.d/sshd</code>, if you want to use
	  <span class="application">SSH</span> (remember to set the relevant
	  options in <code class="filename">/etc/ssh/sshd_config</code>,
	  otherwise <span class="application">SSH</span> will not use
	  PAM).</p><p>To use PAM for authentication, add the line</p><pre class="programlisting">auth  sufficient  /usr/local/lib/pam_ldap.so  no_warn</pre><p>Exactly where this line shows up in the file and which
	  options appear in the fourth column determine the exact
	  behavior of the authentication mechanism; see
	  <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=pam.d&amp;sektion=5&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">pam.d</span>(5)</span></a></p><p>With this configuration you should be able to
	  authenticate a user against an LDAP directory.
	  <span class="application">PAM</span> will perform a bind with your
	  credentials, and if successful will tell
	  <span class="application">SSH</span> to allow access.</p><p>However it is not a good idea to allow
	  <span class="emphasis"><em>every</em></span> user in the directory into
	  <span class="emphasis"><em>every</em></span> client machine.  With the current
	  configuration, all that a user needs to log into a machine
	  is an LDAP entry.  Fortunately there are a few ways to
	  restrict user access.</p><p><code class="filename">ldap.conf</code> supports a
	  <code class="literal">pam_groupdn</code> directive; every account that
	  connects to this machine needs to be a member of the group
	  specified here.  For example, if you have</p><pre class="programlisting">pam_groupdn cn=servername,ou=accessgroups,dc=example,dc=org</pre><p>in <code class="filename">ldap.conf</code>, then only members of
	  that group will be able to log in.  There are a few things
	  to bear in mind, however.</p><p>Members of this group are specified in one or more
	  <code class="literal">memberUid</code> attributes, and each attribute
	  must have the full distinguished name of the member.  So
	  <code class="literal">memberUid: someuser</code> will not work; it
	  must be:</p><pre class="programlisting">memberUid: uid=someuser,ou=people,dc=example,dc=org</pre><p>Additionally, this directive is not checked in PAM
	  during authentication, it is checked during account
	  management, so you will need a second line in your PAM files
	  under <code class="literal">account</code>.  This will require, in
	  turn, <span class="emphasis"><em>every</em></span> user to be listed in the
	  group, which is not necessarily what we want.  To avoid
	  blocking users that are not in LDAP, you should enable the
	  <code class="literal">ignore_unknown_user</code> attribute.  Finally,
	  you should set the
	  <code class="literal">ignore_authinfo_unavail</code> option so that
	  you are not locked out of every computer when the LDAP
	  server is unavailable.</p><p>Your <code class="filename">pam.d/sshd</code> might then end up
	  looking like this:</p><div class="example"><a id="pam"></a><div class="example-title">Example 5. Sample <code class="filename">pam.d/sshd</code></div><div class="example-contents"><pre class="programlisting">auth            required        pam_nologin.so          no_warn
auth            sufficient      pam_opie.so             no_warn no_fake_prompts
auth            requisite       pam_opieaccess.so       no_warn allow_local
auth            sufficient      /usr/local/lib/pam_ldap.so      no_warn
auth            required        pam_unix.so             no_warn try_first_pass

account         required        pam_login_access.so
account         required        /usr/local/lib/pam_ldap.so      no_warn ignore_authinfo_unavail ignore_unknown_user</pre></div></div><br class="example-break" /><div xmlns="" class="note"><h3 class="admontitle">Note: </h3><p xmlns="http://www.w3.org/1999/xhtml">Since we are adding these lines specifically to
	    <code class="filename">pam.d/sshd</code>, this will only have an
	    effect on <span class="application">SSH</span> sessions.  LDAP
	    users will be unable to log in at the console.  To change
	    this behavior, examine the other files in
	    <code class="filename">/etc/pam.d</code> and modify them
	    accordingly.</p></div></div></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="client-nss"></a>3.2. Name Service Switch</h3></div></div></div><p><span class="application">NSS</span> is the service that maps
	attributes to names.  So, for example, if a file is owned by
	user <code class="literal">1001</code>, an application will query
	<span class="application">NSS</span> for the name of
	<code class="literal">1001</code>, and it might get
	<code class="literal">bob</code> or <code class="literal">ted</code> or whatever
	the user's name is.</p><p>Now that our user information is kept in LDAP, we need to
	tell <span class="application">NSS</span> to look there when
	queried.</p><p>The <a xmlns="" class="package" href="https://www.freebsd.org/cgi/url.cgi?ports/net/nss_ldap/pkg-descr">net/nss_ldap</a> port does this.  It
	uses the same configuration file as
	<a xmlns="" class="package" href="https://www.freebsd.org/cgi/url.cgi?ports/security/pam_ldap/pkg-descr">security/pam_ldap</a>, and should not need any
	extra parameters once it is installed.  Instead, what is left
	is simply to edit <code class="filename">/etc/nsswitch.conf</code> to
	take advantage of the directory.  Simply replace the following
	lines:</p><pre class="programlisting">group: compat
passwd: compat</pre><p>with</p><pre class="programlisting">group: files ldap
passwd: files ldap</pre><p>This will allow you to map usernames to UIDs and UIDs to
	usernames.</p><p>Congratulations!  You should now have working LDAP
	authentication.</p></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="caveats"></a>3.3. Caveats</h3></div></div></div><p>Unfortunately, as of the time this was written FreeBSD did
	not support changing user passwords with <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=passwd&amp;sektion=1&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">passwd</span>(1)</span></a>.
	Because of this, most administrators are left to implement a
	solution themselves.  I provide some examples here.  Note that
	if you write your own password change script, there are some
	security issues you should be made aware of; see <a class="xref" href="secure.html#security-passwd" title="4.3. Password Storage">Section 4.3, &#8220;Password Storage&#8221;</a></p><div class="example"><a id="chpw-shell"></a><div class="example-title">Example 6. Shell Script for Changing Passwords</div><div class="example-contents"><pre class="programlisting">#!/bin/sh

stty -echo
read -p "Old Password: " oldp; echo
read -p "New Password: " np1; echo
read -p "Retype New Password: " np2; echo
stty echo

if [ "$np1" != "$np2" ]; then
  echo "Passwords do not match."
  exit 1
fi

ldappasswd -D uid="$USER",ou=people,dc=example,dc=org \
  -w "$oldp" \
  -a "$oldp" \
  -s "$np1"</pre></div></div><br class="example-break" /><div xmlns="" class="caution"><h3 class="admontitle">Caution: </h3><p xmlns="http://www.w3.org/1999/xhtml">This script does hardly any error checking, but more
	  important it is very cavalier about how it stores your
	  passwords.  If you do anything like this, at least adjust
	  the <code class="literal">security.bsd.see_other_uids</code> sysctl
	  value:</p><pre xmlns="http://www.w3.org/1999/xhtml" class="screen"><code class="prompt">#</code> <strong class="userinput"><code>sysctl security.bsd.see_other_uids=0</code></strong></pre></div><p>A more flexible (and probably more secure) approach can be
	used by writing a custom program, or even a web interface.
	The following is part of a <span class="application">Ruby</span>
	library that can change LDAP passwords.  It sees use both on
	the command line, and on the web.</p><div class="example"><a id="chpw-ruby"></a><div class="example-title">Example 7. Ruby Script for Changing Passwords</div><div class="example-contents"><pre class="programlisting">require 'ldap'
require 'base64'
require 'digest'
require 'password' # ruby-password

ldap_server = "ldap.example.org"
luser = "uid=#{ENV['USER']},ou=people,dc=example,dc=org"

# get the new password, check it, and create a salted hash from it
def get_password
  pwd1 = Password.get("New Password: ")
  pwd2 = Password.get("Retype New Password: ")

  raise if pwd1 != pwd2
  pwd1.check # check password strength

  salt = rand.to_s.gsub(/0\./, '')
  pass = pwd1.to_s
  hash = "{SSHA}"+Base64.encode64(Digest::SHA1.digest("#{pass}#{salt}")+salt).chomp!
  return hash
end

oldp = Password.get("Old Password: ")
newp = get_password

# We'll just replace it.  That we can bind proves that we either know
# the old password or are an admin.

replace = LDAP::Mod.new(LDAP::LDAP_MOD_REPLACE | LDAP::LDAP_MOD_BVALUES,
                        "userPassword",
                        [newp])

conn = LDAP::SSLConn.new(ldap_server, 389, true)
conn.set_option(LDAP::LDAP_OPT_PROTOCOL_VERSION, 3)
conn.bind(luser, oldp)
conn.modify(luser, [replace])</pre></div></div><br class="example-break" /><p>Although not guaranteed to be free of security holes (the
	password is kept in memory, for example) this is cleaner and
	more flexible than a simple <code class="command">sh</code>
	script.</p></div></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="ldap.html">Prev</a> </td><td width="20%" align="center"> </td><td width="40%" align="right"> <a accesskey="n" href="secure.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top">2. Configuring LDAP </td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right" valign="top"> 4. Security Considerations</td></tr></table></div><p xmlns="" align="center"><small>All FreeBSD documents are available for download
    at <a href="https://download.freebsd.org/ftp/doc/">https://download.freebsd.org/ftp/doc/</a></small></p><p xmlns="" align="center"><small>Questions that are not answered by the
    <a href="https://www.FreeBSD.org/docs.html">documentation</a> may be
    sent to &lt;<a href="mailto:freebsd-questions@FreeBSD.org">freebsd-questions@FreeBSD.org</a>&gt;.<br />
    Send questions about this document to &lt;<a href="mailto:freebsd-doc@FreeBSD.org">freebsd-doc@FreeBSD.org</a>&gt;.</small></p></body></html>