<?xml version="1.0" encoding="iso-8859-1" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" /><title>2. Configuring LDAP</title><link rel="stylesheet" type="text/css" href="docbook.css" /><link rev="made" href="mailto:doc@FreeBSD.org" /><meta name="generator" content="DocBook XSL Stylesheets V1.79.1" /><link rel="home" href="index.html" title="LDAP Authentication" /><link rel="up" href="index.html" title="LDAP Authentication" /><link rel="prev" href="index.html" title="LDAP Authentication" /><link rel="next" href="client.html" title="3. Client Configuration" /><link rel="copyright" href="trademarks.html" title="Legal Notice" /><script xmlns="" type="text/javascript" src="/layout/js/google.js"></script></head><body><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">2. Configuring LDAP</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="index.html">Prev</a> </td><th width="60%" align="center"> </th><td width="20%" align="right"> <a accesskey="n" href="client.html">Next</a></td></tr></table><hr /></div><div class="sect1"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="ldap"></a>2. Configuring LDAP</h2></div></div></div><p>LDAP stands for <span class="quote">&#8220;<span class="quote">Lightweight Directory Access
	Protocol</span>&#8221;</span> and is a subset of the X.500 Directory Access
      Protocol.  Its most recent specifications are in <a class="link" href="http://www.ietf.org/rfc/rfc4510.txt" target="_top">RFC4510</a>
      and friends.  Essentially it is a database that expects to be
      read from more often than it is written to.</p><p>The LDAP server <a class="link" href="http://www.openldap.org/" target="_top">OpenLDAP</a> will be
      used in the examples in this document; while the principles here
      should be generally applicable to many different servers, most
      of the concrete administration is
      <span class="application">OpenLDAP</span>-specific.  There are several
      server versions in ports, for example
      <a xmlns="" class="package" href="https://www.freebsd.org/cgi/url.cgi?ports/net/openldap24-server/pkg-descr">net/openldap24-server</a>.  Client servers will
      need the corresponding <a xmlns="" class="package" href="https://www.freebsd.org/cgi/url.cgi?ports/net/openldap24-client/pkg-descr">net/openldap24-client</a>
      libraries.</p><p>There are (basically) two areas of the LDAP service which
      need configuration.  The first is setting up a server to receive
      connections properly, and the second is adding entries to the
      server's directory so that FreeBSD tools know how to interact with
      it.</p><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="ldap-connect"></a>2.1. Setting Up the Server for Connections</h3></div></div></div><div xmlns="" class="note"><h3 class="admontitle">Note: </h3><p xmlns="http://www.w3.org/1999/xhtml">This section is specific to
	  <span class="application">OpenLDAP</span>.  If you are using
	  another server, you will need to consult that server's
	  documentation.</p></div><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="ldap-connect-install"></a>2.1.1. Installing <span class="application">OpenLDAP</span></h4></div></div></div><p>First, install
	  <span class="application">OpenLDAP</span>:</p><div class="example"><a id="oldap-install"></a><div class="example-title">Example 1. Installing
	    <span class="application">OpenLDAP</span></div><div class="example-contents"><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>cd /usr/ports/net/openldap24-server</code></strong>
<code class="prompt">#</code> make install clean</pre></div></div><br class="example-break" /><p>This installs the <code class="command">slapd</code> and
	  <code class="command">slurpd</code> binaries, along with the required
	  <span class="application">OpenLDAP</span> libraries.</p></div><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="ldap-connect-config"></a>2.1.2. Configuring <span class="application">OpenLDAP</span></h4></div></div></div><p>Next we must configure
	  <span class="application">OpenLDAP</span>.</p><p>You will want to require encryption in your connections
	  to the LDAP server; otherwise your users' passwords will be
	  transferred in plain text, which is considered insecure.
	  The tools we will be using support two very similar kinds of
	  encryption, SSL and TLS.</p><p>TLS stands for <span class="quote">&#8220;<span class="quote">Transportation Layer
	    Security</span>&#8221;</span>.  Services that employ TLS tend to
	  connect on the <span class="emphasis"><em>same</em></span> ports as the same
	  services without TLS; thus an SMTP server which supports TLS
	  will listen for connections on port 25, and an LDAP server
	  will listen on 389.</p><p>SSL stands for <span class="quote">&#8220;<span class="quote">Secure Sockets Layer</span>&#8221;</span>, and
	  services that implement SSL do <span class="emphasis"><em>not</em></span>
	  listen on the same ports as their non-SSL counterparts.
	  Thus SMTPS listens on port 465 (not 25), HTTPS listens on
	  443, and LDAPS on 636.</p><p>The reason SSL uses a different port than TLS is because
	  a TLS connection begins as plain text, and switches to
	  encrypted traffic after the <code class="literal">STARTTLS</code>
	  directive.  SSL connections are encrypted from the
	  beginning.  Other than that there are no substantial
	  differences between the two.</p><div xmlns="" class="note"><h3 class="admontitle">Note: </h3><p xmlns="http://www.w3.org/1999/xhtml">We will adjust <span class="application">OpenLDAP</span> to
	    use TLS, as SSL is considered deprecated.</p></div><p>Once <span class="application">OpenLDAP</span> is installed
	  via ports, the following configuration parameters in
	  <code class="filename">/usr/local/etc/openldap/slapd.conf</code> will
	  enable TLS:</p><pre class="programlisting">security ssf=128

TLSCertificateFile /path/to/your/cert.crt
TLSCertificateKeyFile /path/to/your/cert.key
TLSCACertificateFile /path/to/your/cacert.crt</pre><p>Here, <code class="literal">ssf=128</code> tells
	  <span class="application">OpenLDAP</span> to require 128-bit
	  encryption for all connections, both search and update.
	  This parameter may be configured based on the security needs
	  of your site, but rarely you need to weaken it, as most LDAP
	  client libraries support strong encryption.</p><p>The <code class="filename">cert.crt</code>,
	  <code class="filename">cert.key</code>, and
	  <code class="filename">cacert.crt</code> files are necessary for
	  clients to authenticate <span class="emphasis"><em>you</em></span> as the
	  valid LDAP server.  If you simply want a server that runs,
	  you can create a self-signed certificate with
	  OpenSSL:</p><div class="example"><a id="genrsa"></a><div class="example-title">Example 2. Generating an RSA Key</div><div class="example-contents"><pre class="screen"><code class="prompt">%</code> <strong class="userinput"><code>openssl genrsa -out cert.key 1024</code></strong>
Generating RSA private key, 1024 bit long modulus
....................++++++
...++++++
e is 65537 (0x10001)
<code class="prompt">%</code> <strong class="userinput"><code>openssl req -new -key cert.key -out cert.csr</code></strong></pre></div></div><br class="example-break" /><p>At this point you should be prompted for some values.
	  You may enter whatever values you like; however, it is
	  important the <span class="quote">&#8220;<span class="quote">Common Name</span>&#8221;</span> value be the fully
	  qualified domain name of the
	  <span class="application">OpenLDAP</span> server.  In our case,
	  and the examples here, the server is
	  <em class="replaceable"><code>server.example.org</code></em>.  Incorrectly
	  setting this value will cause clients to fail when making
	  connections.  This can the cause of great frustration, so
	  ensure that you follow these steps closely.</p><p>Finally, the certificate signing request needs to be
	  signed:</p><div class="example"><a id="self-sign"></a><div class="example-title">Example 3. Self-signing the Certificate</div><div class="example-contents"><pre class="screen"><code class="prompt">%</code> <strong class="userinput"><code>openssl x509 -req -in cert.csr -days 365 -signkey cert.key -out cert.crt</code></strong>
Signature ok
subject=/C=AU/ST=Some-State/O=Internet Widgits Pty Ltd
Getting Private key</pre></div></div><br class="example-break" /><p>This will create a self-signed certificate that can be
	  used for the directives in <code class="filename">slapd.conf</code>,
	  where <code class="filename">cert.crt</code> and
	  <code class="filename">cacert.crt</code> are the same file.  If you
	  are going to use many <span class="application">OpenLDAP</span>
	  servers (for replication via <code class="literal">slurpd</code>) you
	  will want to see <a class="xref" href="ssl-ca.html" title="B. OpenSSL Certificates for LDAP">Appendix B, <em><span class="application">OpenSSL</span> Certificates for
      LDAP</em></a> to generate a CA
	  key and use it to sign individual server
	  certificates.</p><p>Once this is done, put the following in
	  <code class="filename">/etc/rc.conf</code>:</p><pre class="programlisting">slapd_enable="YES"</pre><p>Then run <strong class="userinput"><code>/usr/local/etc/rc.d/slapd
	  start</code></strong>.  This should start
	  <span class="application">OpenLDAP</span>.  Confirm that it is
	  listening on 389 with</p><pre class="screen"><code class="prompt">%</code> <strong class="userinput"><code>sockstat -4 -p 389</code></strong>
ldap     slapd      3261  7  tcp4   *:389                 *:*</pre></div><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="ldap-connect-client"></a>2.1.3. Configuring the Client</h4></div></div></div><p>Install the <a xmlns="" class="package" href="https://www.freebsd.org/cgi/url.cgi?ports/net/openldap24-client/pkg-descr">net/openldap24-client</a>
	  port for the <span class="application">OpenLDAP</span> libraries.
	  The client machines will always have
	  <span class="application">OpenLDAP</span> libraries since that is
	  all <a xmlns="" class="package" href="https://www.freebsd.org/cgi/url.cgi?ports/security/pam_ldap/pkg-descr">security/pam_ldap</a> and
	  <a xmlns="" class="package" href="https://www.freebsd.org/cgi/url.cgi?ports/net/nss_ldap/pkg-descr">net/nss_ldap</a> support, at least for the
	  moment.</p><p>The configuration file for the
	  <span class="application">OpenLDAP</span> libraries is
	  <code class="filename">/usr/local/etc/openldap/ldap.conf</code>.
	  Edit this file to contain the following values:</p><pre class="programlisting">base dc=example,dc=org
uri ldap://server.example.org/
ssl start_tls
tls_cacert /path/to/your/cacert.crt</pre><div xmlns="" class="note"><h3 class="admontitle">Note: </h3><p xmlns="http://www.w3.org/1999/xhtml">It is important that your clients have access to
	    <code class="filename">cacert.crt</code>, otherwise they will not
	    be able to connect.</p></div><div xmlns="" class="note"><h3 class="admontitle">Note: </h3><p xmlns="http://www.w3.org/1999/xhtml">There are two files called
	    <code class="filename">ldap.conf</code>.  The first is this file,
	    which is for the <span class="application">OpenLDAP</span>
	    libraries and defines how to talk to the server.  The
	    second is <code class="filename">/usr/local/etc/ldap.conf</code>,
	    and is for <span class="application">pam_ldap</span>.</p></div><p>At this point you should be able to run
	  <strong class="userinput"><code>ldapsearch -Z</code></strong> on the client machine;
	  <code class="option">-Z</code> means <span class="quote">&#8220;<span class="quote">use TLS</span>&#8221;</span>.  If you
	  encounter an error, then something is configured wrong; most
	  likely it is your certificates.  Use <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=openssl&amp;sektion=1&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">openssl</span>(1)</span></a>'s
	  <code class="command">s_client</code> and <code class="command">s_server</code>
	  to ensure you have them configured and signed
	  properly.</p></div></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="ldap-database"></a>2.2. Entries in the Database</h3></div></div></div><p>Authentication against an LDAP directory is generally
	accomplished by attempting to bind to the directory as the
	connecting user.  This is done by establishing a
	<span class="quote">&#8220;<span class="quote">simple</span>&#8221;</span> bind on the directory with the user name
	supplied.  If there is an entry with the
	<code class="literal">uid</code> equal to the user name and that entry's
	<code class="literal">userPassword</code> attribute matches the password
	supplied, then the bind is successful.</p><p>The first thing we have to do is figure out is where in
	the directory our users will live.</p><p>The base entry for our database is
	<code class="literal">dc=example,dc=org</code>.  The default location
	for users that most clients seem to expect is something like
	<code class="literal">ou=people,<em class="replaceable"><code>base</code></em></code>,
	so that is what will be used here.  However keep in mind that
	this is configurable.</p><p>So the ldif entry for the <code class="literal">people</code>
	organizational unit will look like:</p><pre class="programlisting">dn: ou=people,dc=example,dc=org
objectClass: top
objectClass: organizationalUnit
ou: people</pre><p>All users will be created as subentries of this
	organizational unit.</p><p>Some thought might be given to the object class your users
	will belong to.  Most tools by default will use
	<code class="literal">people</code>, which is fine if you simply want to
	provide entries against which to authenticate.  However, if
	you are going to store user information in the LDAP database
	as well, you will probably want to use
	<code class="literal">inetOrgPerson</code>, which has many useful
	attributes.  In either case, the relevant schemas need to be
	loaded in <code class="filename">slapd.conf</code>.</p><p>For this example we will use the <code class="literal">person</code>
	object class.  If you are using
	<code class="literal">inetOrgPerson</code>, the steps are basically
	identical, except that the <code class="literal">sn</code> attribute is
	required.</p><p>To add a user <code class="literal">testuser</code>, the ldif would
	be:</p><pre class="programlisting">dn: uid=tuser,ou=people,dc=example,dc=org
objectClass: person
objectClass: posixAccount
objectClass: shadowAccount
objectClass: top
uidNumber: 10000
gidNumber: 10000
homeDirectory: /home/tuser
loginShell: /bin/csh
uid: tuser
cn: tuser</pre><p>I start my LDAP users' UIDs at 10000 to avoid collisions
	with system accounts; you can configure whatever number you
	wish here, as long as it is less than 65536.</p><p>We also need group entries.  They are as configurable as
	user entries, but we will use the defaults below:</p><pre class="programlisting">dn: ou=groups,dc=example,dc=org
objectClass: top
objectClass: organizationalUnit
ou: groups

dn: cn=tuser,ou=groups,dc=example,dc=org
objectClass: posixGroup
objectClass: top
gidNumber: 10000
cn: tuser</pre><p>To enter these into your database, you can use
	<code class="command">slapadd</code> or <code class="command">ldapadd</code> on a
	file containing these entries.  Alternatively, you can use
	<a xmlns="" class="package" href="https://www.freebsd.org/cgi/url.cgi?ports/sysutils/ldapvi/pkg-descr">sysutils/ldapvi</a>.</p><p>The <code class="command">ldapsearch</code> utility on the client
	machine should now return these entries.  If it does, your
	database is properly configured to be used as an LDAP
	authentication server.</p></div></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="index.html">Prev</a> </td><td width="20%" align="center"> </td><td width="40%" align="right"> <a accesskey="n" href="client.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top">LDAP Authentication </td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right" valign="top"> 3. Client Configuration</td></tr></table></div><p xmlns="" align="center"><small>All FreeBSD documents are available for download
    at <a href="https://download.freebsd.org/ftp/doc/">https://download.freebsd.org/ftp/doc/</a></small></p><p xmlns="" align="center"><small>Questions that are not answered by the
    <a href="https://www.FreeBSD.org/docs.html">documentation</a> may be
    sent to &lt;<a href="mailto:freebsd-questions@FreeBSD.org">freebsd-questions@FreeBSD.org</a>&gt;.<br />
    Send questions about this document to &lt;<a href="mailto:freebsd-doc@FreeBSD.org">freebsd-doc@FreeBSD.org</a>&gt;.</small></p></body></html>