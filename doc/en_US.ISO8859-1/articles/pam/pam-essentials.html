<?xml version="1.0" encoding="iso-8859-1" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" /><title>3. PAM Essentials</title><link rel="stylesheet" type="text/css" href="docbook.css" /><link rev="made" href="mailto:doc@FreeBSD.org" /><meta name="generator" content="DocBook XSL Stylesheets V1.79.1" /><link rel="home" href="index.html" title="Pluggable Authentication Modules" /><link rel="up" href="index.html" title="Pluggable Authentication Modules" /><link rel="prev" href="pam-terms.html" title="2. Terms and Conventions" /><link rel="next" href="pam-config.html" title="4. PAM Configuration" /><link rel="copyright" href="pam-legalnotice.html" title="Legal Notice" /><script xmlns="" type="text/javascript" src="/layout/js/google.js"></script></head><body><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">3. PAM Essentials</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="pam-terms.html">Prev</a> </td><th width="60%" align="center"> </th><td width="20%" align="right"> <a accesskey="n" href="pam-config.html">Next</a></td></tr></table><hr /></div><div class="section"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="pam-essentials"></a>3. PAM Essentials</h2></div></div></div><div class="section"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="pam-facilities-primitives"></a>3.1. Facilities and
	Primitives</h3></div></div></div><p>The PAM API offers six different authentication primitives
	grouped in four facilities, which are described below.</p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">auth</code></span></dt><dd><p><span class="emphasis"><em>Authentication.</em></span> This facility
	      concerns itself with authenticating the applicant and
	      establishing the account credentials.  It provides two
	      primitives:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p><a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=pam_authenticate&amp;sektion=3&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">pam_authenticate</span>(3)</span></a> authenticates the
		  applicant, usually by requesting an authentication
		  token and comparing it with a value stored in a
		  database or obtained from an authentication
		  server.</p></li><li class="listitem"><p><a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=pam_setcred&amp;sektion=3&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">pam_setcred</span>(3)</span></a> establishes account
		  credentials such as user ID, group membership and
		  resource limits.</p></li></ul></div></dd><dt><span class="term"><code class="literal">account</code></span></dt><dd><p><span class="emphasis"><em>Account management.</em></span> This
	      facility handles non-authentication-related issues of
	      account availability, such as access restrictions based
	      on the time of day or the server's work load.  It
	      provides a single primitive:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p><a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=pam_acct_mgmt&amp;sektion=3&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">pam_acct_mgmt</span>(3)</span></a> verifies that the
		  requested account is available.</p></li></ul></div></dd><dt><span class="term"><code class="literal">session</code></span></dt><dd><p><span class="emphasis"><em>Session management.</em></span> This
	      facility handles tasks associated with session set-up
	      and tear-down, such as login accounting.  It provides
	      two primitives:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p><a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=pam_open_session&amp;sektion=3&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">pam_open_session</span>(3)</span></a> performs tasks
		  associated with session set-up: add an entry in the
		  <code class="filename">utmp</code> and
		  <code class="filename">wtmp</code> databases, start an SSH
		  agent, etc.</p></li><li class="listitem"><p><a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=pam_close_session&amp;sektion=3&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">pam_close_session</span>(3)</span></a> performs tasks
		  associated with session tear-down: add an entry in
		  the <code class="filename">utmp</code> and
		  <code class="filename">wtmp</code> databases, stop the SSH
		  agent, etc.</p></li></ul></div></dd><dt><span class="term"><code class="literal">password</code></span></dt><dd><p><span class="emphasis"><em>Password management.</em></span> This
	      facility is used to change the authentication token
	      associated with an account, either because it has
	      expired or because the user wishes to change it.  It
	      provides a single primitive:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p><a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=pam_chauthtok&amp;sektion=3&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">pam_chauthtok</span>(3)</span></a> changes the authentication
		  token, optionally verifying that it is sufficiently
		  hard to guess, has not been used previously,
		  etc.</p></li></ul></div></dd></dl></div></div><div class="section"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="pam-modules"></a>3.2. Modules</h3></div></div></div><p>Modules are a very central concept in PAM; after all,
	they are the <span class="quote">&#8220;<span class="quote">M</span>&#8221;</span> in <span class="quote">&#8220;<span class="quote">PAM</span>&#8221;</span>.  A PAM
	module is a self-contained piece of program code that
	implements the primitives in one or more facilities for one
	particular mechanism; possible mechanisms for the
	authentication facility, for instance, include the <span class="trademark">UNIX</span>®
	password database, NIS, LDAP and Radius.</p><div class="section"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="pam-module-naming"></a>3.2.1. Module Naming</h4></div></div></div><p>FreeBSD implements each mechanism in a single module,
	  named
	  <code class="literal">pam_<em class="replaceable"><code>mechanism</code></em>.so</code>
	  (for instance, <code class="literal">pam_unix.so</code> for the <span class="trademark">UNIX</span>®
	  mechanism.)  Other implementations sometimes have separate
	  modules for separate facilities, and include the facility
	  name as well as the mechanism name in the module name.  To
	  name one example, <span class="trademark">Solaris</span>&#8482; has a
	  <code class="literal">pam_dial_auth.so.1</code> module which is
	  commonly used to authenticate dialup users.</p></div><div class="section"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="pam-module-versioning"></a>3.2.2. Module
	  Versioning</h4></div></div></div><p>FreeBSD's original PAM implementation, based on
	  Linux-PAM, did not use version numbers for PAM modules.
	  This would commonly cause problems with legacy applications,
	  which might be linked against older versions of the system
	  libraries, as there was no way to load a matching version of
	  the required modules.</p><p>OpenPAM, on the other hand, looks for modules that have
	  the same version number as the PAM library (currently 2),
	  and only falls back to an unversioned module if no versioned
	  module could be loaded.  Thus legacy modules can be provided
	  for legacy applications, while allowing new (or newly built)
	  applications to take advantage of the most recent
	  modules.</p><p>Although <span class="trademark">Solaris</span>&#8482; PAM modules commonly have a version
	  number, they are not truly versioned, because the number is
	  a part of the module name and must be included in the
	  configuration.</p></div></div><div class="section"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="pam-chains-policies"></a>3.3. Chains and
	Policies</h3></div></div></div><p>When a server initiates a PAM transaction, the PAM library
	tries to load a policy for the service specified in the
	<a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=pam_start&amp;sektion=3&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">pam_start</span>(3)</span></a> call.  The policy specifies how
	authentication requests should be processed, and is defined in
	a configuration file.  This is the other central concept in
	PAM: the possibility for the admin to tune the system security
	policy (in the wider sense of the word) simply by editing a
	text file.</p><p>A policy consists of four chains, one for each of the four
	PAM facilities.  Each chain is a sequence of configuration
	statements, each specifying a module to invoke, some
	(optional) parameters to pass to the module, and a control
	flag that describes how to interpret the return code from the
	module.</p><p>Understanding the control flags is essential to
	understanding PAM configuration files.  There are four
	different control flags:</p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">binding</code></span></dt><dd><p>If the module succeeds and no earlier module in the
	      chain has failed, the chain is immediately terminated
	      and the request is granted.  If the module fails, the
	      rest of the chain is executed, but the request is
	      ultimately denied.</p><p>This control flag was introduced by Sun in <span class="trademark">Solaris</span>&#8482;
	      9 (<span class="trademark">SunOS</span>&#8482; 5.9), and is also supported by
	      OpenPAM.</p></dd><dt><span class="term"><code class="literal">required</code></span></dt><dd><p>If the module succeeds, the rest of the chain is
	      executed, and the request is granted unless some other
	      module fails.  If the module fails, the rest of the
	      chain is also executed, but the request is ultimately
	      denied.</p></dd><dt><span class="term"><code class="literal">requisite</code></span></dt><dd><p>If the module succeeds, the rest of the chain is
	      executed, and the request is granted unless some other
	      module fails.  If the module fails, the chain is
	      immediately terminated and the request is denied.</p></dd><dt><span class="term"><code class="literal">sufficient</code></span></dt><dd><p>If the module succeeds and no earlier module in the
	      chain has failed, the chain is immediately terminated
	      and the request is granted.  If the module fails, the
	      module is ignored and the rest of the chain is
	      executed.</p><p>As the semantics of this flag may be somewhat
	      confusing, especially when it is used for the last
	      module in a chain, it is recommended that the
	      <code class="literal">binding</code> control flag be used instead
	      if the implementation supports it.</p></dd><dt><span class="term"><code class="literal">optional</code></span></dt><dd><p>The module is executed, but its result is ignored.
	      If all modules in a chain are marked
	      <code class="literal">optional</code>, all requests will always be
	      granted.</p></dd></dl></div><p>When a server invokes one of the six PAM primitives, PAM
	retrieves the chain for the facility the primitive belongs to,
	and invokes each of the modules listed in the chain, in the
	order they are listed, until it reaches the end, or determines
	that no further processing is necessary (either because a
	<code class="literal">binding</code> or
	<code class="literal">sufficient</code> module succeeded, or because a
	<code class="literal">requisite</code> module failed.)  The request is
	granted if and only if at least one module was invoked, and
	all non-optional modules succeeded.</p><p>Note that it is possible, though not very common, to have
	the same module listed several times in the same chain.  For
	instance, a module that looks up user names and passwords in a
	directory server could be invoked multiple times with
	different parameters specifying different directory servers to
	contact.  PAM treat different occurrences of the same module
	in the same chain as different, unrelated modules.</p></div><div class="section"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="pam-transactions"></a>3.4. Transactions</h3></div></div></div><p>The lifecycle of a typical PAM transaction is described
	below.  Note that if any of these steps fails, the server
	should report a suitable error message to the client and abort
	the transaction.</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>If necessary, the server obtains arbitrator
	    credentials through a mechanism independent of
	    PAM&#8212;most commonly by virtue of having been started
	    by <code class="literal">root</code>, or of being setuid
	    <code class="literal">root</code>.</p></li><li class="listitem"><p>The server calls <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=pam_start&amp;sektion=3&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">pam_start</span>(3)</span></a> to initialize the
	    PAM library and specify its service name and the target
	    account, and register a suitable conversation
	    function.</p></li><li class="listitem"><p>The server obtains various information relating to the
	    transaction (such as the applicant's user name and the
	    name of the host the client runs on) and submits it to PAM
	    using <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=pam_set_item&amp;sektion=3&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">pam_set_item</span>(3)</span></a>.</p></li><li class="listitem"><p>The server calls <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=pam_authenticate&amp;sektion=3&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">pam_authenticate</span>(3)</span></a> to
	    authenticate the applicant.</p></li><li class="listitem"><p>The server calls <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=pam_acct_mgmt&amp;sektion=3&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">pam_acct_mgmt</span>(3)</span></a> to verify that
	    the requested account is available and valid.  If the
	    password is correct but has expired, <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=pam_acct_mgmt&amp;sektion=3&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">pam_acct_mgmt</span>(3)</span></a>
	    will return <code class="literal">PAM_NEW_AUTHTOK_REQD</code>
	    instead of <code class="literal">PAM_SUCCESS</code>.</p></li><li class="listitem"><p>If the previous step returned
	    <code class="literal">PAM_NEW_AUTHTOK_REQD</code>, the server now
	    calls <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=pam_chauthtok&amp;sektion=3&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">pam_chauthtok</span>(3)</span></a> to force the client to change
	    the authentication token for the requested account.</p></li><li class="listitem"><p>Now that the applicant has been properly
	    authenticated, the server calls <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=pam_setcred&amp;sektion=3&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">pam_setcred</span>(3)</span></a> to
	    establish the credentials of the requested account.  It is
	    able to do this because it acts on behalf of the
	    arbitrator, and holds the arbitrator's credentials.</p></li><li class="listitem"><p>Once the correct credentials have been established,
	    the server calls <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=pam_open_session&amp;sektion=3&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">pam_open_session</span>(3)</span></a> to set up the
	    session.</p></li><li class="listitem"><p>The server now performs whatever service the client
	    requested&#8212;for instance, provide the applicant with a
	    shell.</p></li><li class="listitem"><p>Once the server is done serving the client, it calls
	    <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=pam_close_session&amp;sektion=3&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">pam_close_session</span>(3)</span></a> to tear down the session.</p></li><li class="listitem"><p>Finally, the server calls <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=pam_end&amp;sektion=3&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">pam_end</span>(3)</span></a> to notify
	    the PAM library that it is done and that it can release
	    whatever resources it has allocated in the course of the
	    transaction.</p></li></ol></div></div></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="pam-terms.html">Prev</a> </td><td width="20%" align="center"> </td><td width="40%" align="right"> <a accesskey="n" href="pam-config.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top">2. Terms and Conventions </td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right" valign="top"> 4. PAM Configuration</td></tr></table></div><p xmlns="" align="center"><small>All FreeBSD documents are available for download
    at <a href="https://download.freebsd.org/ftp/doc/">https://download.freebsd.org/ftp/doc/</a></small></p><p xmlns="" align="center"><small>Questions that are not answered by the
    <a href="https://www.FreeBSD.org/docs.html">documentation</a> may be
    sent to &lt;<a href="mailto:freebsd-questions@FreeBSD.org">freebsd-questions@FreeBSD.org</a>&gt;.<br />
    Send questions about this document to &lt;<a href="mailto:freebsd-doc@FreeBSD.org">freebsd-doc@FreeBSD.org</a>&gt;.</small></p></body></html>