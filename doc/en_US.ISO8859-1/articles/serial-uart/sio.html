<?xml version="1.0" encoding="iso-8859-1" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" /><title>2. Configuring the sio driver</title><link rel="stylesheet" type="text/css" href="docbook.css" /><link rev="made" href="mailto:doc@FreeBSD.org" /><meta name="generator" content="DocBook XSL Stylesheets V1.79.1" /><link rel="home" href="index.html" title="Serial and UART Tutorial" /><link rel="up" href="index.html" title="Serial and UART Tutorial" /><link rel="prev" href="index.html" title="Serial and UART Tutorial" /><link rel="next" href="cy.html" title="3. Configuring the cy driver" /><link rel="copyright" href="trademarks.html" title="Legal Notice" /><script xmlns="" type="text/javascript" src="/layout/js/google.js"></script></head><body><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">2. Configuring the <code class="filename">sio</code> driver</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="index.html">Prev</a> </td><th width="60%" align="center"> </th><td width="20%" align="right"> <a accesskey="n" href="cy.html">Next</a></td></tr></table><hr /></div><div class="sect1"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="sio"></a>2. Configuring the <code class="filename">sio</code> driver</h2></div></div></div><p>The <code class="filename">sio</code> driver provides support
	for NS8250-, NS16450-, NS16550 and NS16550A-based EIA RS-232C
	(CCITT V.24) communications interfaces.  Several multiport
	cards are supported as well.  See the <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=sio&amp;sektion=4&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">sio</span>(4)</span></a> manual page
	for detailed technical documentation.</p><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp48129400"></a>2.1. Digi International (DigiBoard) PC/8</h3></div></div></div><p><span class="emphasis"><em>Contributed by Andrew Webster <code class="email">&lt;<a xmlns="" class="email" href="mailto:awebster@pubnix.net">awebster@pubnix.net</a>&gt;</code>.  26 August
	  1995.</em></span></p><p>Here is a config snippet from a machine with a Digi
	  International PC/8 with 16550.  It has 8 modems connected to
	  these 8 lines, and they work just great.  Do not forget to
	  add <code class="literal">options COM_MULTIPORT</code> or it will not
	  work very well!</p><pre class="programlisting">device          sio4    at isa? port 0x100 flags 0xb05
device          sio5    at isa? port 0x108 flags 0xb05
device          sio6    at isa? port 0x110 flags 0xb05
device          sio7    at isa? port 0x118 flags 0xb05
device          sio8    at isa? port 0x120 flags 0xb05
device          sio9    at isa? port 0x128 flags 0xb05
device          sio10   at isa? port 0x130 flags 0xb05
device          sio11   at isa? port 0x138 flags 0xb05 irq 9</pre><p>The trick in setting this up is that the MSB of the
	  flags represent the last SIO port, in this case 11 so flags
	  are 0xb05.</p></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp48137080"></a>2.2. Boca 16</h3></div></div></div><p><span class="emphasis"><em>Contributed by Don Whiteside <code class="email">&lt;<a xmlns="" class="email" href="mailto:whiteside@acm.org">whiteside@acm.org</a>&gt;</code>.  26 August
	  1995.</em></span></p><p>The procedures to make a Boca 16 port board with FreeBSD
	  are pretty straightforward, but you will need a couple
	  things to make it work:</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>You either need the kernel sources installed so you
		can recompile the necessary options or you will need
		someone else to compile it for you.  The 2.0.5 default
		kernel does <span class="emphasis"><em>not</em></span> come with
		multiport support enabled and you will need to add a
		device entry for each port anyways.</p></li><li class="listitem"><p>Two, you will need to know the interrupt and IO
	      setting for your Boca Board so you can set these options
	      properly in the kernel.</p></li></ol></div><p>One important note &#8212; the actual UART chips for the
	  Boca 16 are in the connector box, not on the internal board
	  itself.  So if you have it unplugged, probes of those ports
	  will fail.  I have never tested booting with the box
	  unplugged and plugging it back in, and I suggest you do not
	  either.</p><p>If you do not already have a custom kernel
	  configuration file set up, refer to <a class="link" href="../../../../doc/en_US.ISO8859-1/books/handbook/kernelconfig.html" target="_top">Kernel
	  Configuration</a> chapter of the FreeBSD Handbook for
	  general procedures.  The following are the specifics for the
	  Boca 16 board and assume you are using the kernel name
	  MYKERNEL and editing with vi.</p><div class="procedure"><ol class="procedure" type="1"><li class="step"><p>Add the line

	      </p><pre class="programlisting">options COM_MULTIPORT</pre><p>

	      to the config file.</p></li><li class="step"><p>Where the current <code class="literal">device
	      sio<em class="replaceable"><code>n</code></em></code> lines are, you
	      will need to add 16 more devices.  The
	      following example is for a Boca Board with an interrupt
	      of 3, and a base IO address 100h.  The IO address for
	      Each port is +8 hexadecimal from the previous port, thus
	      the 100h, 108h, 110h...  addresses.</p><pre class="programlisting">device sio1 at isa? port 0x100 flags 0x1005
device sio2 at isa? port 0x108 flags 0x1005
device sio3 at isa? port 0x110 flags 0x1005
device sio4 at isa? port 0x118 flags 0x1005
&#8230;
device sio15 at isa? port 0x170 flags 0x1005
device sio16 at isa? port 0x178 flags 0x1005 irq 3</pre><p>The flags entry <span class="emphasis"><em>must</em></span> be changed
	      from this example unless you are using the exact same
	      sio assignments. Flags are set according to
	      0x<em class="replaceable"><code>M</code></em><em class="replaceable"><code>YY</code></em>
	      where <em class="replaceable"><code>M</code></em> indicates the minor
	      number of the master port (the last port on a Boca 16)
	      and <em class="replaceable"><code>YY</code></em> indicates if FIFO is
	      enabled or disabled(enabled), IRQ sharing is used(yes)
	      and if there is an AST/4 compatible IRQ control
	      register(no).  In this example, </p><pre class="programlisting"> flags
	      0x1005</pre><p> indicates that the master port
	      is sio16.  If I added another board and assigned sio17
	      through sio28, the flags for all 16 ports on
	      <span class="emphasis"><em>that</em></span> board would be 0x1C05, where
	      1C indicates the minor number of the master port.  Do
	      not change the 05 setting.</p></li><li class="step"><p>Save and complete the kernel configuration,
	      recompile, install and reboot.  Presuming you have
	      successfully installed the recompiled kernel and have it
	      set to the correct address and IRQ, your boot message
	      should indicate the successful probe of the Boca ports
	      as follows: (obviously the sio numbers, IO and IRQ could
	      be different)</p><pre class="screen">sio1 at 0x100-0x107 flags 0x1005 on isa
sio1: type 16550A (multiport)
sio2 at 0x108-0x10f flags 0x1005 on isa
sio2: type 16550A (multiport)
sio3 at 0x110-0x117 flags 0x1005 on isa
sio3: type 16550A (multiport)
sio4 at 0x118-0x11f flags 0x1005 on isa
sio4: type 16550A (multiport)
sio5 at 0x120-0x127 flags 0x1005 on isa
sio5: type 16550A (multiport)
sio6 at 0x128-0x12f flags 0x1005 on isa
sio6: type 16550A (multiport)
sio7 at 0x130-0x137 flags 0x1005 on isa
sio7: type 16550A (multiport)
sio8 at 0x138-0x13f flags 0x1005 on isa
sio8: type 16550A (multiport)
sio9 at 0x140-0x147 flags 0x1005 on isa
sio9: type 16550A (multiport)
sio10 at 0x148-0x14f flags 0x1005 on isa
sio10: type 16550A (multiport)
sio11 at 0x150-0x157 flags 0x1005 on isa
sio11: type 16550A (multiport)
sio12 at 0x158-0x15f flags 0x1005 on isa
sio12: type 16550A (multiport)
sio13 at 0x160-0x167 flags 0x1005 on isa
sio13: type 16550A (multiport)
sio14 at 0x168-0x16f flags 0x1005 on isa
sio14: type 16550A (multiport)
sio15 at 0x170-0x177 flags 0x1005 on isa
sio15: type 16550A (multiport)
sio16 at 0x178-0x17f irq 3 flags 0x1005 on isa
sio16: type 16550A (multiport master)</pre><p>If the messages go by too fast to see,

	    </p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>dmesg | more</code></strong></pre><p>
	      will show you the boot messages.</p></li><li class="step"><p>Next, appropriate entries in
	      <code class="filename">/dev</code> for the devices must be made
	      using the <code class="filename">/dev/MAKEDEV</code>
	      script.  This step can be omitted if you are running
	      FreeBSD 5.X with a kernel that has <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=devfs&amp;sektion=5&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">devfs</span>(5)</span></a>
	      support compiled in.</p><p>If you do need to create the <code class="filename">/dev</code>
	      entries, run the following as <code class="systemitem">root</code>:</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>cd /dev</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>./MAKEDEV tty1</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>./MAKEDEV cua1</code></strong>
<span class="emphasis"><em>(everything in between)</em></span>
<code class="prompt">#</code> <strong class="userinput"><code>./MAKEDEV ttyg</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>./MAKEDEV cuag</code></strong></pre><p>If you do not want or need call-out devices for some
	      reason, you can dispense with making the
	      <code class="filename">cua*</code> devices.</p></li><li class="step"><p>If you want a quick and sloppy way to make sure the
	      devices are working, you can simply plug a modem into
	      each port and (as root)

            </p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>echo at &gt; ttyd*</code></strong></pre><p>
	      for each device you have made.  You
	      <span class="emphasis"><em>should</em></span> see the RX lights flash for each
	      working port.</p></li></ol></div></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp48233464"></a>2.3. Support for Cheap Multi-UART Cards</h3></div></div></div><p><span class="emphasis"><em>Contributed by Helge Oldach
	  <code class="email">&lt;<a xmlns="" class="email" href="mailto:hmo@sep.hamburg.com">hmo@sep.hamburg.com</a>&gt;</code>, September
	  1999</em></span></p><p>Ever wondered about FreeBSD support for your 20$
	  multi-I/O card with two (or more) COM ports, sharing IRQs?
	  Here is how:</p><p>Usually the only option to support these kind of boards
	  is to use a distinct IRQ for each port.  For example, if
	  your CPU board has an on-board <code class="filename">COM1</code>
	  port (aka <code class="filename">sio0</code>&#8211;I/O address
	  0x3F8 and IRQ 4) and you have an extension board with two
	  UARTs, you will commonly need to configure them as
	  <code class="filename">COM2</code> (aka
	  <code class="filename">sio1</code>&#8211;I/O address 0x2F8 and
	  IRQ 3), and the third port (aka
	  <code class="filename">sio2</code>) as I/O 0x3E8 and IRQ 5.
	  Obviously this is a waste of IRQ resources, as it should be
	  basically possible to run both extension board ports using a
	  single IRQ with the <code class="literal">COM_MULTIPORT</code>
	  configuration described in the previous sections.</p><p>Such cheap I/O boards commonly have a 4 by 3 jumper
	  matrix for the COM ports, similar to the following:</p><pre class="programlisting">            o  o  o  *
Port A               |
            o  *  o  *
Port B         |
            o  *  o  o
IRQ         2  3  4  5</pre><p>Shown here is port A wired for IRQ 5 and port B wired
	  for IRQ 3.  The IRQ columns on your specific board may
	  vary&#8212;other boards may supply jumpers for IRQs 3, 4, 5,
	  and 7 instead.</p><p>One could conclude that wiring both ports for IRQ 3
	  using a handcrafted wire-made jumper covering all three
	  connection points in the IRQ 3 column would solve the issue,
	  but no.  You cannot duplicate IRQ 3 because the output
	  drivers of each UART are wired in a <span class="quote">&#8220;<span class="quote">totem
	  pole</span>&#8221;</span> fashion, so if one of the UARTs drives IRQ 3,
	  the output signal will not be what you would expect.
	  Depending on the implementation of the extension board or
	  your motherboard, the IRQ 3 line will continuously stay up,
	  or always stay low.</p><p>You need to decouple the IRQ drivers for the two UARTs,
	  so that the IRQ line of the board only goes up if (and only
	  if) one of the UARTs asserts a IRQ, and stays low otherwise.
	  The solution was proposed by Joerg Wunsch
	  <code class="email">&lt;<a xmlns="" class="email" href="mailto:j@ida.interface-business.de">j@ida.interface-business.de</a>&gt;</code>: To solder up a
	  wired-or consisting of two diodes (Germanium or
	  Schottky-types strongly preferred) and a 1 kOhm resistor.
	  Here is the schematic, starting from the 4 by 3 jumper field
	  above:</p><pre class="programlisting">                          Diode
                +----------&gt;|-------+
               /                    |
            o  *  o  o              |     1 kOhm
Port A                              +----|######|-------+
            o  *  o  o              |                   |
Port B          `-------------------+                 ==+==
            o  *  o  o              |                 Ground
                \                   |
                 +---------&gt;|-------+
IRQ         2  3  4  5    Diode</pre><p>The cathodes of the diodes are connected to a common
	  point, together with a 1 kOhm pull-down resistor.  It is
	  essential to connect the resistor to ground to avoid
	  floating of the IRQ line on the bus.</p><p>Now we are ready to configure a kernel.  Staying with
	  this example, we would configure:</p><pre class="programlisting"># standard on-board COM1 port
device          sio0    at isa? port "IO_COM1" flags 0x10
# patched-up multi-I/O extension board
options         COM_MULTIPORT
device          sio1    at isa? port "IO_COM2" flags 0x205
device          sio2    at isa? port "IO_COM3" flags 0x205 irq 3</pre><p>Note that the <code class="literal">flags</code> setting for
	  <code class="filename">sio1</code> and
	  <code class="filename">sio2</code> is truly essential; refer to
	  <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=sio&amp;sektion=4&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">sio</span>(4)</span></a> for details. (Generally, the
	  <code class="literal">2</code> in the "flags" attribute refers to
	  <code class="filename">sio</code>2 which holds the IRQ, and you
	  surely want a <code class="literal">5</code> low nibble.)  With kernel
	  verbose mode turned on this should yield something similar
	  to this:</p><pre class="screen">sio0: irq maps: 0x1 0x11 0x1 0x1
sio0 at 0x3f8-0x3ff irq 4 flags 0x10 on isa
sio0: type 16550A
sio1: irq maps: 0x1 0x9 0x1 0x1
sio1 at 0x2f8-0x2ff flags 0x205 on isa
sio1: type 16550A (multiport)
sio2: irq maps: 0x1 0x9 0x1 0x1
sio2 at 0x3e8-0x3ef irq 3 flags 0x205 on isa
sio2: type 16550A (multiport master)</pre><p>Though <code class="filename">/sys/i386/isa/sio.c</code> is
	  somewhat cryptic with its use of the <span class="quote">&#8220;<span class="quote">irq maps</span>&#8221;</span>
	  array above, the basic idea is that you observe
	  <code class="literal">0x1</code> in the first, third, and fourth
	  place.  This means that the corresponding IRQ was set upon
	  output and cleared after, which is just what we would
	  expect. If your kernel does not display this behavior, most
	  likely there is something wrong with your wiring.</p></div></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="index.html">Prev</a> </td><td width="20%" align="center"> </td><td width="40%" align="right"> <a accesskey="n" href="cy.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top">Serial and UART Tutorial </td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right" valign="top"> 3. Configuring the <code class="filename">cy</code> driver</td></tr></table></div><p xmlns="" align="center"><small>All FreeBSD documents are available for download
    at <a href="https://download.freebsd.org/ftp/doc/">https://download.freebsd.org/ftp/doc/</a></small></p><p xmlns="" align="center"><small>Questions that are not answered by the
    <a href="https://www.FreeBSD.org/docs.html">documentation</a> may be
    sent to &lt;<a href="mailto:freebsd-questions@FreeBSD.org">freebsd-questions@FreeBSD.org</a>&gt;.<br />
    Send questions about this document to &lt;<a href="mailto:freebsd-doc@FreeBSD.org">freebsd-doc@FreeBSD.org</a>&gt;.</small></p></body></html>