<?xml version="1.0" encoding="iso-8859-1" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" /><title>3. On FreeBSD Kernel Programming</title><link rel="stylesheet" type="text/css" href="docbook.css" /><link rev="made" href="mailto:doc@FreeBSD.org" /><meta name="generator" content="DocBook XSL Stylesheets V1.79.1" /><link rel="home" href="index.html" title="Writing a GEOM Class" /><link rel="up" href="index.html" title="Writing a GEOM Class" /><link rel="prev" href="prelim.html" title="2. Preliminaries" /><link rel="next" href="geom.html" title="4. On GEOM Programming" /><link rel="copyright" href="trademarks.html" title="Legal Notice" /><script xmlns="" type="text/javascript" src="/layout/js/google.js"></script></head><body><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">3. On FreeBSD Kernel Programming</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="prelim.html">Prev</a> </td><th width="60%" align="center"> </th><td width="20%" align="right"> <a accesskey="n" href="geom.html">Next</a></td></tr></table><hr /></div><div class="sect1"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="kernelprog"></a>3. On FreeBSD Kernel Programming</h2></div></div></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="kernelprog-memalloc"></a>3.1. Memory Allocation</h3></div></div></div><p>See <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=malloc&amp;sektion=9&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">malloc</span>(9)</span></a>.  Basic memory allocation is only
	slightly different than its userland equivalent.  Most
	notably, <code class="function">malloc</code>() and
	<code class="function">free</code>() accept additional parameters as is
	described in the man page.</p><p>A <span class="quote">&#8220;<span class="quote">malloc type</span>&#8221;</span> must be declared in the
	declaration section of a source file, like this:</p><pre class="programlisting">  static MALLOC_DEFINE(M_GJOURNAL, "gjournal data", "GEOM_JOURNAL Data");</pre><p>To use this macro, <code class="filename">sys/param.h</code>,
	<code class="filename">sys/kernel.h</code> and
	<code class="filename">sys/malloc.h</code> headers must be
	included.</p><p>There is another mechanism for allocating memory, the UMA
	(Universal Memory Allocator).  See <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=uma&amp;sektion=9&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">uma</span>(9)</span></a> for details,
	but it is a special type of allocator mainly used for speedy
	allocation of lists comprised of same-sized items (for
	example, dynamic arrays of structs).</p></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="kernelprog-lists"></a>3.2. Lists and Queues</h3></div></div></div><p>See <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=queue&amp;sektion=3&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">queue</span>(3)</span></a>.  There are a LOT of cases when a list
	of things needs to be maintained.  Fortunately, this data
	structure is implemented (in several ways) by C macros
	included in the system.  The most used list type is TAILQ
	because it is the most flexible.  It is also the one with
	largest memory requirements (its elements are doubly-linked)
	and also the slowest (although the speed variation is on the
	order of several CPU instructions more, so it should not be
	taken seriously).</p><p>If data retrieval speed is very important, see
	<a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=tree&amp;sektion=3&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">tree</span>(3)</span></a> and <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=hashinit&amp;sektion=9&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">hashinit</span>(9)</span></a>.</p></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="kernelprog-bios"></a>3.3. BIOs</h3></div></div></div><p>Structure <code class="varname">bio</code> is
	used for any and all Input/Output operations concerning GEOM.
	It basically contains information about what device
	('provider') should satisfy the request, request type, offset,
	length, pointer to a buffer, and a bunch of
	<span class="quote">&#8220;<span class="quote">user-specific</span>&#8221;</span> flags and fields that can help
	implement various hacks.</p><p>The important thing here is that <code class="varname">bio</code>s are handled
	asynchronously.  That means that, in most parts of the code,
	there is no analogue to userland's <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=read&amp;sektion=2&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">read</span>(2)</span></a> and
	<a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=write&amp;sektion=2&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">write</span>(2)</span></a> calls that do not return until a request is
	done.  Rather, a developer-supplied function is called as a
	notification when the request gets completed (or results in
	error).</p><p>The asynchronous programming model (also called
	<span class="quote">&#8220;<span class="quote">event-driven</span>&#8221;</span>) is somewhat harder than the much
	more used imperative one used in userland (at least it takes a
	while to get used to it).  In some cases the helper routines
	<code class="function">g_write_data</code>() and
	<code class="function">g_read_data</code>() can be used, but
	<span class="emphasis"><em>not always</em></span>.  In particular, they cannot
	be used when a mutex is held; for example, the GEOM topology
	mutex or the internal mutex held during the
	<code class="function">.start</code>() and <code class="function">.stop</code>()
	functions.</p></div></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="prelim.html">Prev</a> </td><td width="20%" align="center"> </td><td width="40%" align="right"> <a accesskey="n" href="geom.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top">2. Preliminaries </td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right" valign="top"> 4. On GEOM Programming</td></tr></table></div><p xmlns="" align="center"><small>All FreeBSD documents are available for download
    at <a href="https://download.freebsd.org/ftp/doc/">https://download.freebsd.org/ftp/doc/</a></small></p><p xmlns="" align="center"><small>Questions that are not answered by the
    <a href="https://www.FreeBSD.org/docs.html">documentation</a> may be
    sent to &lt;<a href="mailto:freebsd-questions@FreeBSD.org">freebsd-questions@FreeBSD.org</a>&gt;.<br />
    Send questions about this document to &lt;<a href="mailto:freebsd-doc@FreeBSD.org">freebsd-doc@FreeBSD.org</a>&gt;.</small></p></body></html>