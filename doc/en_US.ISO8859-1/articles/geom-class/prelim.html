<?xml version="1.0" encoding="iso-8859-1" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" /><title>2. Preliminaries</title><link rel="stylesheet" type="text/css" href="docbook.css" /><link rev="made" href="mailto:doc@FreeBSD.org" /><meta name="generator" content="DocBook XSL Stylesheets V1.79.1" /><link rel="home" href="index.html" title="Writing a GEOM Class" /><link rel="up" href="index.html" title="Writing a GEOM Class" /><link rel="prev" href="index.html" title="Writing a GEOM Class" /><link rel="next" href="kernelprog.html" title="3. On FreeBSD Kernel Programming" /><link rel="copyright" href="trademarks.html" title="Legal Notice" /><script xmlns="" type="text/javascript" src="/layout/js/google.js"></script></head><body><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">2. Preliminaries</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="index.html">Prev</a> </td><th width="60%" align="center"> </th><td width="20%" align="right"> <a accesskey="n" href="kernelprog.html">Next</a></td></tr></table><hr /></div><div class="sect1"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="prelim"></a>2. Preliminaries</h2></div></div></div><p>The best way to do kernel development is to have (at least)
      two separate computers.  One of these would contain the
      development environment and sources, and the other would be used
      to test the newly written code by network-booting and
      network-mounting filesystems from the first one.  This way if
      the new code contains bugs and crashes the machine, it will not
      mess up the sources (and other <span class="quote">&#8220;<span class="quote">live</span>&#8221;</span> data).  The
      second system does not even require a proper display.  Instead,
      it could be connected with a serial cable or KVM to the first
      one.</p><p>But, since not everybody has two or more computers handy,
      there are a few things that can be done to prepare an otherwise
      <span class="quote">&#8220;<span class="quote">live</span>&#8221;</span> system for developing kernel code.  This
      setup is also applicable for developing in a <a class="link" href="http://www.vmware.com/" target="_top">VMWare</a> or <a class="link" href="http://www.qemu.org/" target="_top">QEmu</a> virtual machine
      (the next best thing after a dedicated development
      machine).</p><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="prelim-system"></a>2.1. Modifying a System for Development</h3></div></div></div><p>For any kernel programming a kernel with
	<code class="option">INVARIANTS</code> enabled is a must-have.  So enter
	these in your kernel configuration file:</p><pre class="programlisting">options INVARIANT_SUPPORT
options INVARIANTS</pre><p>For more debugging you should also include WITNESS
	support, which will alert you of mistakes in locking:</p><pre class="programlisting">options WITNESS_SUPPORT
options WITNESS</pre><p>For debugging crash dumps, a kernel with debug symbols is
	needed:</p><pre class="programlisting">  makeoptions    DEBUG=-g</pre><p>With the usual way of installing the kernel (<code class="command">make
	  installkernel</code>) the debug kernel will not be
	automatically installed.  It is called
	<code class="filename">kernel.debug</code> and located in
	<code class="filename">/usr/obj/usr/src/sys/KERNELNAME/</code>.  For
	convenience it should be copied to
	<code class="filename">/boot/kernel/</code>.</p><p>Another convenience is enabling the kernel debugger so you
	can examine a kernel panic when it happens.  For this, enter
	the following lines in your kernel configuration file:</p><pre class="programlisting">options KDB
options DDB
options KDB_TRACE</pre><p>For this to work you might need to set a sysctl (if it is
	not on by default):</p><pre class="programlisting">  debug.debugger_on_panic=1</pre><p>Kernel panics will happen, so care should be taken with
	the filesystem cache.  In particular, having softupdates might
	mean the latest file version could be lost if a panic occurs
	before it is committed to storage.  Disabling softupdates
	yields a great performance hit, and still does not guarantee
	data consistency.  Mounting filesystem with the
	<span class="quote">&#8220;<span class="quote">sync</span>&#8221;</span> option is needed for that.  For a
	compromise, the softupdates cache delays can be shortened.
	There are three sysctl's that are useful for this (best to be
	set in <code class="filename">/etc/sysctl.conf</code>):</p><pre class="programlisting">kern.filedelay=5
kern.dirdelay=4
kern.metadelay=3</pre><p>The numbers represent seconds.</p><p>For debugging kernel panics, kernel core dumps are
	required.  Since a kernel panic might make filesystems
	unusable, this crash dump is first written to a raw partition.
	Usually, this is the swap partition.  This partition must be
	at least as large as the physical RAM in the machine.  On the
	next boot, the dump is copied to a regular file.  This happens
	after filesystems are checked and mounted, and before swap is
	enabled.  This is controlled with two
	<code class="filename">/etc/rc.conf</code> variables:</p><pre class="programlisting">dumpdev="/dev/ad0s4b"
dumpdir="/usr/core </pre><p>The <code class="varname">dumpdev</code> variable specifies the swap
	partition and <code class="varname">dumpdir</code> tells the system
	where in the filesystem to relocate the core dump on
	reboot.</p><p>Writing kernel core dumps is slow and takes a long time so
	if you have lots of memory (&gt;256M) and lots of panics it
	could be frustrating to sit and wait while it is done (twice
	&#8212; first to write it to swap, then to relocate it to
	filesystem).  It is convenient then to limit the amount of RAM
	the system will use via a
	<code class="filename">/boot/loader.conf</code> tunable:</p><pre class="programlisting">  hw.physmem="256M"</pre><p>If the panics are frequent and filesystems large (or you
	simply do not trust softupdates+background fsck) it is
	advisable to turn background fsck off via
	<code class="filename">/etc/rc.conf</code> variable:</p><pre class="programlisting">  background_fsck="NO"</pre><p>This way, the filesystems will always get checked when
	needed.  Note that with background fsck, a new panic could
	happen while it is checking the disks.  Again, the safest way
	is not to have many local filesystems by using another
	computer as an NFS server.</p></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="prelim-starting"></a>2.2. Starting the Project</h3></div></div></div><p>For the purpose of creating a new GEOM class, an empty
	subdirectory has to be created under an arbitrary
	user-accessible directory.  You do not have to create the
	module directory under <code class="filename">/usr/src</code>.</p></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="prelim-makefile"></a>2.3. The Makefile</h3></div></div></div><p>It is good practice to create
	<code class="filename">Makefile</code>s for every nontrivial coding
	project, which of course includes kernel modules.</p><p>Creating the <code class="filename">Makefile</code> is simple
	thanks to an extensive set of helper routines provided by the
	system.  In short, here is how a minimal
	<code class="filename">Makefile</code> looks for a kernel
	module:</p><pre class="programlisting">SRCS=g_journal.c
KMOD=geom_journal

.include &lt;bsd.kmod.mk&gt;</pre><p>This <code class="filename">Makefile</code> (with changed
	filenames) will do for any kernel module, and a GEOM class can
	reside in just one kernel module.  If more than one file is
	required, list it in the <code class="envar">SRCS</code> variable,
	separated with whitespace from other filenames.</p></div></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="index.html">Prev</a> </td><td width="20%" align="center"> </td><td width="40%" align="right"> <a accesskey="n" href="kernelprog.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top">Writing a GEOM Class </td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right" valign="top"> 3. On FreeBSD Kernel Programming</td></tr></table></div><p xmlns="" align="center"><small>All FreeBSD documents are available for download
    at <a href="https://download.freebsd.org/ftp/doc/">https://download.freebsd.org/ftp/doc/</a></small></p><p xmlns="" align="center"><small>Questions that are not answered by the
    <a href="https://www.FreeBSD.org/docs.html">documentation</a> may be
    sent to &lt;<a href="mailto:freebsd-questions@FreeBSD.org">freebsd-questions@FreeBSD.org</a>&gt;.<br />
    Send questions about this document to &lt;<a href="mailto:freebsd-doc@FreeBSD.org">freebsd-doc@FreeBSD.org</a>&gt;.</small></p></body></html>