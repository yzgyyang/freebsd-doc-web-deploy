<?xml version="1.0" encoding="iso-8859-1" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" /><title>4. Setting Up Journaling</title><link rel="stylesheet" type="text/css" href="docbook.css" /><link rev="made" href="mailto:doc@FreeBSD.org" /><meta name="generator" content="DocBook XSL Stylesheets V1.79.1" /><link rel="home" href="index.html" title="Implementing UFS Journaling on a Desktop PC" /><link rel="up" href="index.html" title="Implementing UFS Journaling on a Desktop PC" /><link rel="prev" href="reserve-space.html" title="3. Steps During the Installation of FreeBSD" /><link rel="next" href="troubleshooting-gjournal.html" title="5. Troubleshooting Journaling" /><link rel="copyright" href="trademarks.html" title="Legal Notice" /><script xmlns="" type="text/javascript" src="/layout/js/google.js"></script></head><body><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">4. Setting Up Journaling</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="reserve-space.html">Prev</a> </td><th width="60%" align="center"> </th><td width="20%" align="right"> <a accesskey="n" href="troubleshooting-gjournal.html">Next</a></td></tr></table><hr /></div><div class="sect1"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="configure-journal"></a>4. Setting Up Journaling</h2></div></div></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="running-gjournal"></a>4.1. Executing <code class="command">gjournal</code></h3></div></div></div><p>Having prepared all the required partitions, it is quite easy
	to configure journaling.  We will need to switch to single user
	mode, so login as <code class="systemitem">root</code> and type:</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>shutdown now</code></strong></pre><p>Press <span class="keycap"><strong>Enter</strong></span> to get the default shell.  We will need to unmount
	the partitions that will be journaled, in our example
	<code class="filename">/usr</code> and <code class="filename">/var</code>:</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>umount /usr /var</code></strong></pre><p>Load the module required for journaling:</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>gjournal load</code></strong></pre><p>Now, use your notes to determine which partition will be used
	for each journal.  In our example,  <code class="filename">/usr</code> is
	<code class="filename">ad0s1f</code> and its journal will be
	<code class="filename">ad0s1g</code>, while
	<code class="filename">/var</code> is <code class="filename">ad0s1d</code> and will
	be journaled to <code class="filename">ad0s1h</code>.
	The following commands are required:</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>gjournal label ad0s1f ad0s1g</code></strong>

GEOM_JOURNAL: Journal 2948326772: ad0s1f contains data.
GEOM_JOURNAL: Journal 2948326772: ad0s1g contains journal.

<code class="prompt">#</code> <strong class="userinput"><code>gjournal label ad0s1d ad0s1h</code></strong>

GEOM_JOURNAL: Journal 3193218002: ad0s1d contains data.
GEOM_JOURNAL: Journal 3193218002: ad0s1h contains journal.</pre><div xmlns="" class="note"><h3 class="admontitle">Note: </h3><p xmlns="http://www.w3.org/1999/xhtml">If the last sector of either partition is used,
	  <code class="command">gjournal</code> will return an error.  You will have
	  to run the command using the <code class="option">-f</code> flag to force an
	  overwrite, i.e.:</p><pre xmlns="http://www.w3.org/1999/xhtml" class="screen"><code class="prompt">#</code> <strong class="userinput"><code>gjournal label -f ad0s1d ad0s1h</code></strong></pre><p xmlns="http://www.w3.org/1999/xhtml">Since this is a new installation, it is highly unlikely that
	  anything will be actually overwritten.</p></div><p>At this point, two new devices are created, namely
	<code class="filename">ad0s1d.journal</code> and
	<code class="filename">ad0s1f.journal</code>.  These represent
	the <code class="filename">/var</code> and <code class="filename">/usr</code>
	partitions we have to mount.  Before mounting, we must however set
	the journal flag on them and clear the Soft Updates flag:</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>tunefs -J enable -n disable ad0s1d.journal</code></strong>

tunefs: gjournal set
tunefs: soft updates cleared

<code class="prompt">#</code> <strong class="userinput"><code>tunefs -J enable -n disable ad0s1f.journal</code></strong>

tunefs: gjournal set
tunefs: soft updates cleared</pre><p>Now, mount the new devices manually at their respective places
	(note that we can now use the <code class="option">async</code> mount
	option):</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>mount -o async /dev/ad0s1d.journal /var</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>mount -o async /dev/ad0s1f.journal /usr</code></strong></pre><p>Edit <code class="filename">/etc/fstab</code> and update the entries for
	<code class="filename">/usr</code> and <code class="filename">/var</code>:</p><pre class="programlisting">/dev/ad0s1f.journal     /usr            ufs     rw,async      2       2
/dev/ad0s1d.journal     /var            ufs     rw,async      2       2</pre><div xmlns="" class="warning"><h3 class="admontitle">Warning: </h3><p xmlns="http://www.w3.org/1999/xhtml">Make sure the above entries are correct, or you will have
	  trouble starting up normally after you reboot!</p></div><p>Finally, edit <code class="filename">/boot/loader.conf</code> and add the
	following line so the <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=gjournal&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">gjournal</span>(8)</span></a> module is loaded at every
	boot:</p><pre class="programlisting">geom_journal_load="YES"</pre><p>Congratulations! Your system is now set for journaling.  You can
	either type <strong class="userinput"><code>exit</code></strong> to return to multi-user mode, or
	reboot to test your configuration (recommended).  During the boot you
	will see messages like the following:</p><pre class="screen">ad0: 76293MB XEC XE800JD-00HBC0 08.02D08 at ata0-master SATA150
GEOM_JOURNAL: Journal 2948326772: ad0s1g contains journal.
GEOM_JOURNAL: Journal 3193218002: ad0s1h contains journal.
GEOM_JOURNAL: Journal 3193218002: ad0s1d contains data.
GEOM_JOURNAL: Journal ad0s1d clean.
GEOM_JOURNAL: Journal 2948326772: ad0s1f contains data.
GEOM_JOURNAL: Journal ad0s1f clean.</pre><p>After an unclean shutdown, the messages will vary slightly,
	i.e.:</p><pre class="screen">GEOM_JOURNAL: Journal ad0s1d consistent.</pre><p>This usually means that <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=gjournal&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">gjournal</span>(8)</span></a> used the information in
	the journal provider to return the file system to a consistent
	state.</p></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="gjournal-new"></a>4.2. Journaling Newly Created Partitions</h3></div></div></div><p>While the above procedure is necessary for journaling partitions
	that already contain data, journaling an empty partition is somewhat
	easier, since both the data and the journal provider can be stored
	in the same partition.  For example, assume a new disk was installed,
	and a new partition <code class="filename">/dev/ad1s1d</code>
	was created.  Creating the journal would be as simple as:</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>gjournal label ad1s1d</code></strong></pre><p>The journal size will be 1 GB by default. You may adjust it by
	using the <code class="option">-s</code> option.  The value can be given in
	bytes, or appended by <code class="literal">K</code>, <code class="literal">M</code> or
	<code class="literal">G</code> to denote Kilobytes, Megabytes or Gigabytes
	respectively.  Note that <code class="command">gjournal</code> will not allow
	you to create unsuitably small journal sizes.</p><p>For example, to create a 2 GB journal, you could use the following
	command:</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>gjournal label -s 2G ad1s1d</code></strong></pre><p>You can then create a file system on your new partition, and
	enable journaling using the <code class="option">-J</code> option:</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>newfs -J /dev/ad1s1d.journal</code></strong></pre></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="configure-kernel"></a>4.3. Building Journaling into Your Custom Kernel</h3></div></div></div><p>If you do not wish to load <code class="literal">geom_journal</code> as a
	module, you can build its functions right into your kernel.  Edit your
	custom kernel configuration file, and make sure it includes these two
	lines:</p><pre class="programlisting">options UFS_GJOURNAL # Note: This is already in GENERIC

options GEOM_JOURNAL # You will have to add this one</pre><p>Rebuild and reinstall your kernel following the relevant
	<a class="link" href="../../../../doc/en_US.ISO8859-1/books/handbook/kernelconfig.html" target="_top">instructions in
	the FreeBSD Handbook.</a></p><p>Do not forget to remove the relevant <span class="quote">&#8220;<span class="quote">load</span>&#8221;</span> entry
	from <code class="filename">/boot/loader.conf</code> if you have previously
	used it.</p></div></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="reserve-space.html">Prev</a> </td><td width="20%" align="center"> </td><td width="40%" align="right"> <a accesskey="n" href="troubleshooting-gjournal.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top">3. Steps During the Installation of FreeBSD </td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right" valign="top"> 5. Troubleshooting Journaling</td></tr></table></div><p xmlns="" align="center"><small>All FreeBSD documents are available for download
    at <a href="https://download.freebsd.org/ftp/doc/">https://download.freebsd.org/ftp/doc/</a></small></p><p xmlns="" align="center"><small>Questions that are not answered by the
    <a href="https://www.FreeBSD.org/docs.html">documentation</a> may be
    sent to &lt;<a href="mailto:freebsd-questions@FreeBSD.org">freebsd-questions@FreeBSD.org</a>&gt;.<br />
    Send questions about this document to &lt;<a href="mailto:freebsd-doc@FreeBSD.org">freebsd-doc@FreeBSD.org</a>&gt;.</small></p></body></html>