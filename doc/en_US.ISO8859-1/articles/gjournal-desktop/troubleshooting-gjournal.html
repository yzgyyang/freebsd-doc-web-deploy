<?xml version="1.0" encoding="iso-8859-1" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" /><title>5. Troubleshooting Journaling</title><link rel="stylesheet" type="text/css" href="docbook.css" /><link rev="made" href="mailto:doc@FreeBSD.org" /><meta name="generator" content="DocBook XSL Stylesheets V1.79.1" /><link rel="home" href="index.html" title="Implementing UFS Journaling on a Desktop PC" /><link rel="up" href="index.html" title="Implementing UFS Journaling on a Desktop PC" /><link rel="prev" href="configure-journal.html" title="4. Setting Up Journaling" /><link rel="next" href="further-reading.html" title="6. Further Reading" /><link rel="copyright" href="trademarks.html" title="Legal Notice" /><script xmlns="" type="text/javascript" src="/layout/js/google.js"></script></head><body><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">5. Troubleshooting Journaling</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="configure-journal.html">Prev</a> </td><th width="60%" align="center"> </th><td width="20%" align="right"> <a accesskey="n" href="further-reading.html">Next</a></td></tr></table><hr /></div><div class="sect1"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="troubleshooting-gjournal"></a>5. Troubleshooting Journaling</h2></div></div></div><p>The following section covers frequently asked questions regarding
      problems related to journaling.</p><div class="qandaset"><a id="idp47197048"></a><dl><dt>5.1. <a href="troubleshooting-gjournal.html#idp47197816">I am getting kernel panics during periods of high disk
	    activity.  How is this related to journaling?</a></dt><dt>5.2. <a href="troubleshooting-gjournal.html#idp47204088">I made some mistake during configuration, and I cannot boot
	    normally now.  Can this be fixed some way?</a></dt><dt>5.3. <a href="troubleshooting-gjournal.html#idp47224312">Can I remove journaling and return to my standard file system
	      with Soft Updates?</a></dt></dl><table border="0" style="width: 100%;"><colgroup><col align="left" width="1%" /><col /></colgroup><tbody><tr class="question"><td align="left" valign="top"><a id="idp47197816"></a><a id="kernel-panic"></a><p><strong>5.1.</strong></p></td><td align="left" valign="top"><p>I am getting kernel panics during periods of high disk
	    activity.  How is this related to journaling?</p></td></tr><tr class="answer"><td align="left" valign="top"></td><td align="left" valign="top"><p>The journal probably fills up before it has a chance to get
	    committed (flushed) to disk.  Keep in mind the size of the
	    journal depends on the usage load, and not the size of the data
	    provider.  If your disk activity is high, you need a larger
	    partition for the journal.  See the note in the <a class="link" href="understanding-journaling.html" title="2. Understanding Journaling in FreeBSD">Understanding Journaling</a> section.</p></td></tr><tr class="question"><td align="left" valign="top"><a id="idp47204088"></a><a id="unable-boot"></a><p><strong>5.2.</strong></p></td><td align="left" valign="top"><p>I made some mistake during configuration, and I cannot boot
	    normally now.  Can this be fixed some way?</p></td></tr><tr class="answer"><td align="left" valign="top"></td><td align="left" valign="top"><p>You either forgot (or misspelled) the entry in
	    <code class="filename">/boot/loader.conf</code>, or there are errors in
	    your <code class="filename">/etc/fstab</code> file.  These are usually easy
	    to fix.  Press <span class="keycap"><strong>Enter</strong></span> to get to the default single user shell.  Then
	    locate the root of the problem:</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>cat /boot/loader.conf</code></strong></pre><p>If the <code class="literal">geom_journal_load</code> entry is missing
	    or misspelled, the journaled devices are never created. Load the
	    module manually,  mount all partitions, and continue with
	    multi-user boot:</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>gjournal load</code></strong>

GEOM_JOURNAL: Journal 2948326772: ad0s1g contains journal.
GEOM_JOURNAL: Journal 3193218002: ad0s1h contains journal.
GEOM_JOURNAL: Journal 3193218002: ad0s1d contains data.
GEOM_JOURNAL: Journal ad0s1d clean.
GEOM_JOURNAL: Journal 2948326772: ad0s1f contains data.
GEOM_JOURNAL: Journal ad0s1f clean.

<code class="prompt">#</code> <strong class="userinput"><code>mount -a</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>exit</code></strong>
<span class="emphasis"><em>(boot continues)</em></span></pre><p>If, on the other hand, this entry is correct, have a look at
	    <code class="filename">/etc/fstab</code>.  You will probably find a
	    misspelled or missing entry.  In this case, mount all remaining
	    partitions by hand and continue with the multi-user boot.</p></td></tr><tr class="question"><td align="left" valign="top"><a id="idp47224312"></a><a id="remove-journaling"></a><p><strong>5.3.</strong></p></td><td align="left" valign="top"><p>Can I remove journaling and return to my standard file system
	      with Soft Updates?</p></td></tr><tr class="answer"><td align="left" valign="top"></td><td align="left" valign="top"><p>Sure. Use the following procedure, which reverses the
	    changes.  The partitions you created for the journal providers
	    can then be used for other purposes, if you so wish.</p><p>Login as <code class="systemitem">root</code> and switch to single user mode:</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>shutdown now</code></strong></pre><p>Unmount the journaled partitions:</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>umount /usr /var</code></strong></pre><p>Synchronize the journals:</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>gjournal sync</code></strong></pre><p>Stop the journaling providers:</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>gjournal stop ad0s1d.journal</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>gjournal stop ad0s1f.journal</code></strong></pre><p>Clear journaling metadata from all the devices used:</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>gjournal clear ad0s1d</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>gjournal clear ad0s1f</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>gjournal clear ad0s1g</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>gjournal clear ad0s1h</code></strong></pre><p>Clear the file system journaling flag, and restore the Soft
	    Updates flag:</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>tunefs -J disable -n enable ad0s1d</code></strong>

tunefs: gjournal cleared
tunefs: soft updates set

<code class="prompt">#</code> <strong class="userinput"><code>tunefs -J disable -n enable ad0s1f</code></strong>

tunefs: gjournal cleared
tunefs: soft updates set</pre><p>Remount the old devices by hand:</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>mount -o rw /dev/ad0s1d /var</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>mount -o rw /dev/ad0s1f /usr</code></strong></pre><p>Edit <code class="filename">/etc/fstab</code> and restore it to its
	    original state:</p><pre class="programlisting">/dev/ad0s1f     /usr            ufs     rw      2       2
/dev/ad0s1d     /var            ufs     rw      2       2</pre><p>Finally, edit <code class="filename">/boot/loader.conf</code>, remove
	    the entry that loads the <code class="literal">geom_journal</code> module
	    and reboot.</p></td></tr></tbody></table></div></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="configure-journal.html">Prev</a> </td><td width="20%" align="center"> </td><td width="40%" align="right"> <a accesskey="n" href="further-reading.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top">4. Setting Up Journaling </td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right" valign="top"> 6. Further Reading</td></tr></table></div><p xmlns="" align="center"><small>All FreeBSD documents are available for download
    at <a href="https://download.freebsd.org/ftp/doc/">https://download.freebsd.org/ftp/doc/</a></small></p><p xmlns="" align="center"><small>Questions that are not answered by the
    <a href="https://www.FreeBSD.org/docs.html">documentation</a> may be
    sent to &lt;<a href="mailto:freebsd-questions@FreeBSD.org">freebsd-questions@FreeBSD.org</a>&gt;.<br />
    Send questions about this document to &lt;<a href="mailto:freebsd-doc@FreeBSD.org">freebsd-doc@FreeBSD.org</a>&gt;.</small></p></body></html>