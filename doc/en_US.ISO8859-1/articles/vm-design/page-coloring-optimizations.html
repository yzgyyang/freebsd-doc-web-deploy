<?xml version="1.0" encoding="iso-8859-1" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" /><title>7. Page Coloring</title><link rel="stylesheet" type="text/css" href="docbook.css" /><link rev="made" href="mailto:doc@FreeBSD.org" /><meta name="generator" content="DocBook XSL Stylesheets V1.79.1" /><link rel="home" href="index.html" title="Design elements of the FreeBSD VM system" /><link rel="up" href="index.html" title="Design elements of the FreeBSD VM system" /><link rel="prev" href="page-table-optimizations.html" title="6. Page Table Optimizations" /><link rel="next" href="conclusion.html" title="8. Conclusion" /><link rel="copyright" href="trademarks.html" title="Legal Notice" /><script xmlns="" type="text/javascript" src="/layout/js/google.js"></script></head><body><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">7. Page Coloring</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="page-table-optimizations.html">Prev</a> </td><th width="60%" align="center"> </th><td width="20%" align="right"> <a accesskey="n" href="conclusion.html">Next</a></td></tr></table><hr /></div><div class="sect1"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="page-coloring-optimizations"></a>7. Page Coloring</h2></div></div></div><p>We will end with the page coloring optimizations.  Page coloring is a
      performance optimization designed to ensure that accesses to contiguous
      pages in virtual memory make the best use of the processor cache.  In
      ancient times (i.e. 10+ years ago) processor caches tended to map
      virtual memory rather than physical memory.  This led to a huge number of
      problems including having to clear the cache on every context switch in
      some cases, and problems with data aliasing in the cache.  Modern
      processor caches map physical memory precisely to solve those problems.
      This means that two side-by-side pages in a processes address space may
      not correspond to two side-by-side pages in the cache.  In fact, if you
      are not careful side-by-side pages in virtual memory could wind up using
      the same page in the processor cache&#8212;leading to cacheable data
      being thrown away prematurely and reducing CPU performance.  This is true
      even with multi-way set-associative caches (though the effect is
      mitigated somewhat).</p><p>FreeBSD's memory allocation code implements page coloring
      optimizations, which means that the memory allocation code will attempt
      to locate free pages that are contiguous from the point of view of the
      cache.  For example, if page 16 of physical memory is assigned to page 0
      of a process's virtual memory and the cache can hold 4 pages, the page
      coloring code will not assign page 20 of physical memory to page 1 of a
      process's virtual memory.  It would, instead, assign page 21 of physical
      memory.  The page coloring code attempts to avoid assigning page 20
      because this maps over the same cache memory as page 16 and would result
      in non-optimal caching.  This code adds a significant amount of
      complexity to the VM memory allocation subsystem as you can well
      imagine, but the result is well worth the effort.  Page Coloring makes VM
      memory as deterministic as physical memory in regards to cache
      performance.</p></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="page-table-optimizations.html">Prev</a> </td><td width="20%" align="center"> </td><td width="40%" align="right"> <a accesskey="n" href="conclusion.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top">6. Page Table Optimizations </td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right" valign="top"> 8. Conclusion</td></tr></table></div><p xmlns="" align="center"><small>All FreeBSD documents are available for download
    at <a href="https://download.freebsd.org/ftp/doc/">https://download.freebsd.org/ftp/doc/</a></small></p><p xmlns="" align="center"><small>Questions that are not answered by the
    <a href="https://www.FreeBSD.org/docs.html">documentation</a> may be
    sent to &lt;<a href="mailto:freebsd-questions@FreeBSD.org">freebsd-questions@FreeBSD.org</a>&gt;.<br />
    Send questions about this document to &lt;<a href="mailto:freebsd-doc@FreeBSD.org">freebsd-doc@FreeBSD.org</a>&gt;.</small></p></body></html>