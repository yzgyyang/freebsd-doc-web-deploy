<?xml version="1.0" encoding="iso-8859-1" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" /><title>3. SWAP Layers</title><link rel="stylesheet" type="text/css" href="docbook.css" /><link rev="made" href="mailto:doc@FreeBSD.org" /><meta name="generator" content="DocBook XSL Stylesheets V1.79.1" /><link rel="home" href="index.html" title="Design elements of the FreeBSD VM system" /><link rel="up" href="index.html" title="Design elements of the FreeBSD VM system" /><link rel="prev" href="vm-objects.html" title="2. VM Objects" /><link rel="next" href="freeing-pages.html" title="4. When to free a page" /><link rel="copyright" href="trademarks.html" title="Legal Notice" /><script xmlns="" type="text/javascript" src="/layout/js/google.js"></script></head><body><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">3. SWAP Layers</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="vm-objects.html">Prev</a> </td><th width="60%" align="center"> </th><td width="20%" align="right"> <a accesskey="n" href="freeing-pages.html">Next</a></td></tr></table><hr /></div><div class="sect1"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="swap-layers"></a>3. SWAP Layers</h2></div></div></div><p>Private data pages are initially either copy-on-write or zero-fill
      pages.  When a change, and therefore a copy, is made, the original
      backing object (usually a file) can no longer be used to save a copy of
      the page when the VM system needs to reuse it for other purposes.  This
      is where SWAP comes in.  SWAP is allocated to create backing store for
      memory that does not otherwise have it.  FreeBSD allocates the swap
      management structure for a VM Object only when it is actually needed.
      However, the swap management structure has had problems
      historically:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Under FreeBSD 3.X the swap management structure preallocates an
          array that encompasses the entire object requiring swap backing
          store&#8212;even if only a few pages of that object are
          swap-backed.  This creates a kernel memory fragmentation problem
          when large objects are mapped, or processes with large runsizes
         (RSS) fork.</p></li><li class="listitem"><p>Also, in order to keep track of swap space, a <span class="quote">&#8220;<span class="quote">list of
          holes</span>&#8221;</span> is kept in kernel memory, and this tends to get
          severely fragmented as well.  Since the <span class="quote">&#8220;<span class="quote">list of
          holes</span>&#8221;</span> is a linear list, the swap allocation and freeing
          performance is a non-optimal O(n)-per-page.</p></li><li class="listitem"><p>It requires kernel memory allocations to take place during
          the swap freeing process, and that creates low memory deadlock
          problems.</p></li><li class="listitem"><p>The problem is further exacerbated by holes created due to
          the interleaving algorithm.</p></li><li class="listitem"><p>Also, the swap block map can become fragmented fairly easily
          resulting in non-contiguous allocations.</p></li><li class="listitem"><p>Kernel memory must also be allocated on the fly for additional
          swap management structures when a swapout occurs.</p></li></ul></div><p>It is evident from that list that there was plenty of room for
       improvement.  For FreeBSD 4.X, I completely rewrote the swap
       subsystem:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Swap management structures are allocated through a hash
          table rather than a linear array giving them a fixed allocation
          size and much finer granularity.</p></li><li class="listitem"><p>Rather then using a linearly linked list to keep track of
          swap space reservations, it now uses a bitmap of swap blocks
          arranged in a radix tree structure with free-space hinting in
          the radix  node structures.  This effectively makes swap
          allocation and freeing an O(1) operation.</p></li><li class="listitem"><p>The entire radix tree bitmap is also preallocated in
          order to avoid having to allocate kernel memory during critical
          low memory swapping operations.  After all, the system tends to
          swap when it is low on memory so we should avoid allocating
          kernel memory at such times in order to avoid potential
          deadlocks.</p></li><li class="listitem"><p>To reduce fragmentation the radix tree is capable
          of allocating large contiguous chunks at once, skipping over
          smaller fragmented chunks.</p></li></ul></div><p>I did not take the final step of having an
      <span class="quote">&#8220;<span class="quote">allocating hint pointer</span>&#8221;</span> that would trundle
      through a portion of swap as allocations were made in order to further
      guarantee contiguous allocations or at least locality of reference, but
      I ensured that such an addition could be made.</p></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="vm-objects.html">Prev</a> </td><td width="20%" align="center"> </td><td width="40%" align="right"> <a accesskey="n" href="freeing-pages.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top">2. VM Objects </td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right" valign="top"> 4. When to free a page</td></tr></table></div><p xmlns="" align="center"><small>All FreeBSD documents are available for download
    at <a href="https://download.freebsd.org/ftp/doc/">https://download.freebsd.org/ftp/doc/</a></small></p><p xmlns="" align="center"><small>Questions that are not answered by the
    <a href="https://www.FreeBSD.org/docs.html">documentation</a> may be
    sent to &lt;<a href="mailto:freebsd-questions@FreeBSD.org">freebsd-questions@FreeBSD.org</a>&gt;.<br />
    Send questions about this document to &lt;<a href="mailto:freebsd-doc@FreeBSD.org">freebsd-doc@FreeBSD.org</a>&gt;.</small></p></body></html>