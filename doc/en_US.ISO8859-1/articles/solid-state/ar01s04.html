<?xml version="1.0" encoding="iso-8859-1" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" /><title>4. Building a File System from Scratch</title><link rel="stylesheet" type="text/css" href="docbook.css" /><link rev="made" href="mailto:doc@FreeBSD.org" /><meta name="generator" content="DocBook XSL Stylesheets V1.79.1" /><link rel="home" href="index.html" title="FreeBSD and Solid State Devices" /><link rel="up" href="index.html" title="FreeBSD and Solid State Devices" /><link rel="prev" href="ro-fs.html" title="3. The rc Subsystem and Read-Only Filesystems" /><link rel="next" href="strategies.html" title="5. System Strategies for Small and Read Only Environments" /><link rel="copyright" href="trademarks.html" title="Legal Notice" /><script xmlns="" type="text/javascript" src="/layout/js/google.js"></script></head><body><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">4. Building a File System from Scratch</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="ro-fs.html">Prev</a> </td><th width="60%" align="center"> </th><td width="20%" align="right"> <a accesskey="n" href="strategies.html">Next</a></td></tr></table><hr /></div><div class="sect1"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="idp46965880"></a>4. Building a File System from Scratch</h2></div></div></div><p>Because ATA compatible compact-flash cards are seen by FreeBSD
      as normal IDE hard drives, you could theoretically install FreeBSD
      from the network using the kern and mfsroot floppies or from a
      CD.</p><p>However, even a small installation of FreeBSD using normal
      installation procedures can produce a system in size of greater
      than 200 megabytes.  Because most people will be using smaller
      flash memory devices (128 megabytes is considered fairly large -
      32 or even 16 megabytes is common) an installation using normal
      mechanisms is not possible&#8212;there is simply not enough disk
      space for even the smallest of conventional
      installations.</p><p>The easiest way to overcome this space limitation is to
      install FreeBSD using conventional means to a normal hard disk.
      After the installation is complete, pare down the operating
      system to a size that will fit onto your flash media, then tar
      the entire filesystem.  The following steps will guide you
      through the process of preparing a piece of flash memory for
      your tarred filesystem.  Remember, because a normal installation
      is not being performed, operations such as partitioning,
      labeling, file-system creation, etc. need to be performed by
      hand.  In addition to the kern and mfsroot floppy disks, you
      will also need to use the fixit floppy.</p><div class="procedure"><ol class="procedure" type="1"><li class="step"><p class="title"><strong>Partitioning Your Flash Media Device</strong></p><p>After booting with the kern and mfsroot floppies, choose
	  <code class="literal">custom</code> from the installation menu.  In
	  the custom installation menu, choose
	  <code class="literal">partition</code>.  In the partition menu, you
	  should delete all existing partitions using
	  <span class="keycap"><strong>d</strong></span>.  After deleting all existing
	  partitions, create a partition using <span class="keycap"><strong>c</strong></span>
	  and accept the default value for the size of the
	  partition.  When asked for the type of the partition, make
	  sure the value is set to <code class="literal">165</code>.  Now write
	  this partition table to the disk by pressing
	  <span class="keycap"><strong>w</strong></span> (this is a hidden option on this
	  screen).  If you are using an ATA compatible compact flash
	  card, you should choose the FreeBSD Boot Manager.  Now press
	  <span class="keycap"><strong>q</strong></span> to quit the partition menu.  You
	  will be shown the boot manager menu once more - repeat the
	  choice you made earlier.</p></li><li class="step"><p class="title"><strong>Creating Filesystems on Your Flash Memory
	  Device</strong></p><p>Exit the custom installation menu, and from the main
	  installation menu choose the <code class="literal">fixit</code>
	  option.  After entering the fixit environment, enter the
	  following command:</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>disklabel -e /dev/ad0c</code></strong></pre><p>At this point you will have entered the vi editor under
	  the auspices of the disklabel command.  Next, you need to
	  add an <code class="literal">a:</code> line at the end of the file.
	  This <code class="literal">a:</code> line should look like:</p><pre class="programlisting">a:      <em class="replaceable"><code>123456</code></em>  0       4.2BSD  0       0</pre><p>Where <em class="replaceable"><code>123456</code></em> is a number that
	  is exactly the same as the number in the existing
	  <code class="literal">c:</code> entry for size.  Basically you are
	  duplicating the existing <code class="literal">c:</code> line as an
	  <code class="literal">a:</code> line, making sure that fstype is
	  <code class="literal">4.2BSD</code>.  Save the file and exit.</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>disklabel -B -r /dev/ad0c</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>newfs /dev/ad0a</code></strong></pre></li><li class="step"><p class="title"><strong>Placing Your Filesystem on the Flash Media</strong></p><p>Mount the newly prepared flash media:</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>mount /dev/ad0a /flash</code></strong></pre><p>Bring this machine up on the network so we may transfer
	  our tar file and explode it onto our flash media filesystem.
	  One example of how to do this is:</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>ifconfig xl0 192.168.0.10 netmask 255.255.255.0</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>route add default 192.168.0.1</code></strong></pre><p>Now that the machine is on the network, transfer your
	  tar file.  You may be faced with a bit of a dilemma at this
	  point - if your flash memory part is 128 megabytes, for
	  instance, and your tar file is larger than 64 megabytes, you
	  cannot have your tar file on the flash media at the same
	  time as you explode it - you will run out of
	  space.  One solution to this problem, if you are using FTP,
	  is to untar the file while it is transferred over FTP.  If
	  you perform your transfer in this manner, you will never
	  have the tar file and the tar contents on your disk at the
	  same time:</p><pre class="screen"><code class="prompt">ftp&gt;</code> <strong class="userinput"><code>get tarfile.tar "| tar xvf -"</code></strong></pre><p>If your tarfile is gzipped, you can accomplish this as
	  well:</p><pre class="screen"><code class="prompt">ftp&gt;</code> <strong class="userinput"><code>get tarfile.tar "| zcat | tar xvf -"</code></strong></pre><p>After the contents of your tarred filesystem are on your
	  flash memory filesystem, you can unmount the flash memory
	  and reboot:</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>cd /</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>umount /flash</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>exit</code></strong></pre><p>Assuming that you configured your filesystem correctly
	  when it was built on the normal hard disk (with your
	  filesystems mounted read-only, and with the necessary
	  options compiled into the kernel) you should now be
	  successfully booting your FreeBSD embedded system.</p></li></ol></div></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="ro-fs.html">Prev</a> </td><td width="20%" align="center"> </td><td width="40%" align="right"> <a accesskey="n" href="strategies.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top">3. The <code class="literal">rc</code> Subsystem and Read-Only
      Filesystems </td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right" valign="top"> 5. System Strategies for Small and Read Only
      Environments</td></tr></table></div><p xmlns="" align="center"><small>All FreeBSD documents are available for download
    at <a href="https://download.freebsd.org/ftp/doc/">https://download.freebsd.org/ftp/doc/</a></small></p><p xmlns="" align="center"><small>Questions that are not answered by the
    <a href="https://www.FreeBSD.org/docs.html">documentation</a> may be
    sent to &lt;<a href="mailto:freebsd-questions@FreeBSD.org">freebsd-questions@FreeBSD.org</a>&gt;.<br />
    Send questions about this document to &lt;<a href="mailto:freebsd-doc@FreeBSD.org">freebsd-doc@FreeBSD.org</a>&gt;.</small></p></body></html>