<?xml version="1.0" encoding="iso-8859-1" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" /><title>5. Building Update Code</title><link rel="stylesheet" type="text/css" href="docbook.css" /><link rev="made" href="mailto:doc@FreeBSD.org" /><meta name="generator" content="DocBook XSL Stylesheets V1.79.1" /><link rel="home" href="index.html" title="Build Your Own FreeBSD Update Server" /><link rel="up" href="index.html" title="Build Your Own FreeBSD Update Server" /><link rel="prev" href="Configuration.html" title="4. Configuration: Installation &amp; Setup" /><link rel="next" href="patch.html" title="6. Building a Patch" /><link rel="copyright" href="trademarks.html" title="Legal Notice" /><script xmlns="" type="text/javascript" src="/layout/js/google.js"></script></head><body><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">5. Building Update Code</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="Configuration.html">Prev</a> </td><th width="60%" align="center"> </th><td width="20%" align="right"> <a accesskey="n" href="patch.html">Next</a></td></tr></table><hr /></div><div class="sect1"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="build"></a>5. Building Update Code</h2></div></div></div><p>The first step is to run
      <code class="filename">scripts/make.sh</code>.  This will build some
      binaries, create directories, and generate an RSA signing key
      used for approving builds.  In this step, a passphrase will have
      to be supplied for the final creation of the signing key.</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>sh scripts/make.sh</code></strong>
cc -O2 -fno-strict-aliasing -pipe   findstamps.c  -o findstamps
findstamps.c: In function 'usage':
findstamps.c:45: warning: incompatible implicit declaration of built-in function 'exit'
cc -O2 -fno-strict-aliasing -pipe   unstamp.c  -o unstamp
install findstamps ../bin
install unstamp ../bin
rm -f findstamps unstamp
Generating RSA private key, 4096 bit long modulus
................................................................................++
...................++
e is 65537 (0x10001)

Public key fingerprint:
27ef53e48dc869eea6c3136091cc6ab8589f967559824779e855d58a2294de9e

Encrypting signing key for root
enter aes-256-cbc encryption password:
Verifying - enter aes-256-cbc encryption password:</pre><div xmlns="" class="note"><h3 class="admontitle">Note: </h3><p xmlns="http://www.w3.org/1999/xhtml">Keep a note of the generated key fingerprint.  This value
	is required in <code class="filename">/etc/freebsd-update.conf</code>
	for binary updates.</p></div><p>At this point, we are ready to stage a build.</p><div class="informalexample"><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>cd /usr/local/freebsd-update-server</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>sh scripts/init.sh <em class="replaceable"><code>amd64 7.2-RELEASE</code></em></code></strong></pre></div><p>What follows is a sample of an <span class="emphasis"><em>initial</em></span>
      build run.</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>sh scripts/init.sh amd64 7.2-RELEASE</code></strong>
Mon Aug 24 16:04:36 PDT 2009 Starting fetch for FreeBSD/amd64 7.2-RELEASE
/usr/local/freebsd-update-server/work/7.2-RELE100% of  588 MB  359 kBps 00m00s
Mon Aug 24 16:32:38 PDT 2009 Verifying disc1 hash for FreeBSD/amd64 7.2-RELEASE
Mon Aug 24 16:32:44 PDT 2009 Extracting components for FreeBSD/amd64 7.2-RELEASE
Mon Aug 24 16:34:05 PDT 2009 Constructing world+src image for FreeBSD/amd64 7.2-RELEASE
Mon Aug 24 16:35:57 PDT 2009 Extracting world+src for FreeBSD/amd64 7.2-RELEASE
Mon Aug 24 23:36:24 UTC 2009 Building world for FreeBSD/amd64 7.2-RELEASE
Tue Aug 25 00:31:29 UTC 2009 Distributing world for FreeBSD/amd64 7.2-RELEASE
Tue Aug 25 00:32:36 UTC 2009 Building and distributing kernels for FreeBSD/amd64 7.2-RELEASE
Tue Aug 25 00:44:44 UTC 2009 Constructing world components for FreeBSD/amd64 7.2-RELEASE
Tue Aug 25 00:44:56 UTC 2009 Distributing source for FreeBSD/amd64 7.2-RELEASE
Mon Aug 24 17:46:18 PDT 2009 Moving components into staging area for FreeBSD/amd64 7.2-RELEASE
Mon Aug 24 17:46:33 PDT 2009 Identifying extra documentation for FreeBSD/amd64 7.2-RELEASE
Mon Aug 24 17:47:13 PDT 2009 Extracting extra docs for FreeBSD/amd64 7.2-RELEASE
Mon Aug 24 17:47:18 PDT 2009 Indexing release for FreeBSD/amd64 7.2-RELEASE
Mon Aug 24 17:50:44 PDT 2009 Indexing world0 for FreeBSD/amd64 7.2-RELEASE

Files built but not released:
Files released but not built:
Files which differ by more than contents:
Files which differ between release and build:
kernel|generic|/GENERIC/hptrr.ko
kernel|generic|/GENERIC/kernel
src|sys|/sys/conf/newvers.sh
world|base|/boot/loader
world|base|/boot/pxeboot
world|base|/etc/mail/freebsd.cf
world|base|/etc/mail/freebsd.submit.cf
world|base|/etc/mail/sendmail.cf
world|base|/etc/mail/submit.cf
world|base|/lib/libcrypto.so.5
world|base|/usr/bin/ntpq
world|base|/usr/lib/libalias.a
world|base|/usr/lib/libalias_cuseeme.a
world|base|/usr/lib/libalias_dummy.a
world|base|/usr/lib/libalias_ftp.a
...</pre><p>Then the build of the world is performed again, with world
      patches.  A more detailed explanation may be found
      in <code class="filename">scripts/build.subr</code>.</p><div xmlns="" class="warning"><h3 class="admontitle">Warning: </h3><p xmlns="http://www.w3.org/1999/xhtml">During this second build cycle, the network time protocol
	daemon, <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=ntpd&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">ntpd</span>(8)</span></a>, is turned off.  Per Colin Percival <code class="email">&lt;<a xmlns="" class="email" href="mailto:cperciva@FreeBSD.org">cperciva@FreeBSD.org</a>&gt;</code>,
	Security Officer Emeritus of FreeBSD, "the <a class="link" href="https://svnweb.freebsd.org/base/user/cperciva/freebsd-update-build/" target="_top">freebsd-update-server</a>
	build code needs to identify timestamps which are stored in
	files so that they can be ignored when comparing builds to
	determine which files need to be updated.  This
	timestamp-finding works by doing two builds 400 days apart and
	comparing the results."</p></div><pre class="screen">Mon Aug 24 17:54:07 PDT 2009 Extracting world+src for FreeBSD/amd64 7.2-RELEASE
Wed Sep 29 00:54:34 UTC 2010 Building world for FreeBSD/amd64 7.2-RELEASE
Wed Sep 29 01:49:42 UTC 2010 Distributing world for FreeBSD/amd64 7.2-RELEASE
Wed Sep 29 01:50:50 UTC 2010 Building and distributing kernels for FreeBSD/amd64 7.2-RELEASE
Wed Sep 29 02:02:56 UTC 2010 Constructing world components for FreeBSD/amd64 7.2-RELEASE
Wed Sep 29 02:03:08 UTC 2010 Distributing source for FreeBSD/amd64 7.2-RELEASE
Tue Sep 28 19:04:31 PDT 2010 Moving components into staging area for FreeBSD/amd64 7.2-RELEASE
Mon Aug 24 19:04:46 PDT 2009 Extracting extra docs for FreeBSD/amd64 7.2-RELEASE
Mon Aug 24 19:04:51 PDT 2009 Indexing world1 for FreeBSD/amd64 7.2-RELEASE
Mon Aug 24 19:08:04 PDT 2009 Locating build stamps for FreeBSD/amd64 7.2-RELEASE
Mon Aug 24 19:10:19 PDT 2009 Cleaning staging area for FreeBSD/amd64 7.2-RELEASE
Mon Aug 24 19:10:19 PDT 2009 Preparing to copy files into staging area for FreeBSD/amd64 7.2-RELEASE
Mon Aug 24 19:10:20 PDT 2009 Copying data files into staging area for FreeBSD/amd64 7.2-RELEASE
Mon Aug 24 12:16:57 PDT 2009 Copying metadata files into staging area for FreeBSD/amd64 7.2-RELEASE
Mon Aug 24 12:16:59 PDT 2009 Constructing metadata index and tag for FreeBSD/amd64 7.2-RELEASE

Files found which include build stamps:
kernel|generic|/GENERIC/hptrr.ko
kernel|generic|/GENERIC/kernel
world|base|/boot/loader
world|base|/boot/pxeboot
world|base|/etc/mail/freebsd.cf
world|base|/etc/mail/freebsd.submit.cf
world|base|/etc/mail/sendmail.cf
world|base|/etc/mail/submit.cf
world|base|/lib/libcrypto.so.5
world|base|/usr/bin/ntpq
world|base|/usr/include/osreldate.h
world|base|/usr/lib/libalias.a
world|base|/usr/lib/libalias_cuseeme.a
world|base|/usr/lib/libalias_dummy.a
world|base|/usr/lib/libalias_ftp.a
...</pre><p>Finally, the build completes.</p><pre class="screen">Values of build stamps, excluding library archive headers:
v1.2 (Aug 25 2009 00:40:36)
v1.2 (Aug 25 2009 00:38:22)
@(#)FreeBSD 7.2-RELEASE #0: Tue Aug 25 00:38:29 UTC 2009
FreeBSD 7.2-RELEASE #0: Tue Aug 25 00:38:29 UTC 2009
    root@server.myhost.com:/usr/obj/usr/src/sys/GENERIC
7.2-RELEASE
Mon Aug 24 23:55:25 UTC 2009
Mon Aug 24 23:55:25 UTC 2009
##### built by root@server.myhost.com on Tue Aug 25 00:16:15 UTC 2009
##### built by root@server.myhost.com on Tue Aug 25 00:16:15 UTC 2009
##### built by root@server.myhost.com on Tue Aug 25 00:16:15 UTC 2009
##### built by root@server.myhost.com on Tue Aug 25 00:16:15 UTC 2009
Mon Aug 24 23:46:47 UTC 2009
ntpq 4.2.4p5-a Mon Aug 24 23:55:53 UTC 2009 (1)
 * Copyright (c) 1992-2009 The FreeBSD Project.
Mon Aug 24 23:46:47 UTC 2009
Mon Aug 24 23:55:40 UTC 2009
Aug 25 2009
ntpd 4.2.4p5-a Mon Aug 24 23:55:52 UTC 2009 (1)
ntpdate 4.2.4p5-a Mon Aug 24 23:55:53 UTC 2009 (1)
ntpdc 4.2.4p5-a Mon Aug 24 23:55:53 UTC 2009 (1)
Tue Aug 25 00:21:21 UTC 2009
Tue Aug 25 00:21:21 UTC 2009
Tue Aug 25 00:21:21 UTC 2009
Mon Aug 24 23:46:47 UTC 2009

FreeBSD/amd64 7.2-RELEASE initialization build complete.  Please
review the list of build stamps printed above to confirm that
they look sensible, then run
# sh -e approve.sh amd64 7.2-RELEASE
to sign the release.</pre><p>Approve the build if everything is correct.  More
      information on determining this can be found in the distributed
      source file named <code class="filename">USAGE</code>.  Execute
      <code class="filename">scripts/approve.sh</code>, as directed.  This will
      sign the release, and move components into a staging area
      suitable for uploading.</p><div class="informalexample"><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>cd /usr/local/freebsd-update-server</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>sh scripts/mountkey.sh</code></strong></pre></div><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>sh -e scripts/approve.sh amd64 7.2-RELEASE</code></strong>
Wed Aug 26 12:50:06 PDT 2009 Signing build for FreeBSD/amd64 7.2-RELEASE
Wed Aug 26 12:50:06 PDT 2009 Copying files to patch source directories for FreeBSD/amd64 7.2-RELEASE
Wed Aug 26 12:50:06 PDT 2009 Copying files to upload staging area for FreeBSD/amd64 7.2-RELEASE
Wed Aug 26 12:50:07 PDT 2009 Updating databases for FreeBSD/amd64 7.2-RELEASE
Wed Aug 26 12:50:07 PDT 2009 Cleaning staging area for FreeBSD/amd64 7.2-RELEASE</pre><p>After the approval process is complete, the upload procedure
      may be started.</p><div class="informalexample"><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>cd /usr/local/freebsd-update-server</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>sh scripts/upload.sh <em class="replaceable"><code>amd64 7.2-RELEASE</code></em></code></strong></pre></div><div xmlns="" class="note"><h3 class="admontitle">Note: </h3><p xmlns="http://www.w3.org/1999/xhtml">In the event update code needs to be re-uploaded, this may
	be done by changing to the public distributions directory for
	the target release and updating attributes of the
	<span class="emphasis"><em>uploaded</em></span> file.</p><div xmlns="http://www.w3.org/1999/xhtml" class="informalexample"><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>cd /usr/local/freebsd-update-server/pub/<em class="replaceable"><code>7.2-RELEASE/amd64</code></em></code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>touch -t <em class="replaceable"><code>200801010101.01</code></em> uploaded</code></strong></pre></div></div><p>The uploaded files will need to be in the document root of
      the webserver in order for updates to be distributed.  The exact
      configuration will vary depending on the web server used.  For
      the <span class="application">Apache</span> web server, please refer
      to the <a class="link" href="../../../../doc/en_US.ISO8859-1/books/handbook/network-apache.html" target="_top">Configuration
	of Apache servers</a> section in the Handbook.</p><p>Update client's <code class="literal">KeyPrint</code> and
	<code class="literal">ServerName</code> in
	<code class="filename">/etc/freebsd-update.conf</code>, and perform
	updates as instructed in the <a class="link" href="../../../../doc/en_US.ISO8859-1/books/handbook/updating-upgrading-freebsdupdate.html" target="_top">FreeBSD
	Update</a>
      
       section of the
	   Handbook.</p><div xmlns="" class="important"><h3 class="admontitle">Important: </h3><p xmlns="http://www.w3.org/1999/xhtml">In order for <span class="application">FreeBSD
  Update Server</span> to work properly, updates for both
	the <span class="emphasis"><em>current</em></span> release and the release
	<span class="emphasis"><em>one wants to upgrade to</em></span> need to be built.
	This is necessary for determining the differences of files
	between releases.  For example, when upgrading a FreeBSD system
	from 7.1-RELEASE to 7.2-RELEASE, updates will need to be built
	and uploaded to your distribution server for both
	versions.</p></div><p>For reference, the entire run of <a class="link" href="init.txt" target="_top"><code class="filename">init.sh</code></a> is
      attached.</p></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="Configuration.html">Prev</a> </td><td width="20%" align="center"> </td><td width="40%" align="right"> <a accesskey="n" href="patch.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top">4. Configuration: Installation &amp; Setup </td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right" valign="top"> 6. Building a Patch</td></tr></table></div><p xmlns="" align="center"><small>All FreeBSD documents are available for download
    at <a href="https://download.freebsd.org/ftp/doc/">https://download.freebsd.org/ftp/doc/</a></small></p><p xmlns="" align="center"><small>Questions that are not answered by the
    <a href="https://www.FreeBSD.org/docs.html">documentation</a> may be
    sent to &lt;<a href="mailto:freebsd-questions@FreeBSD.org">freebsd-questions@FreeBSD.org</a>&gt;.<br />
    Send questions about this document to &lt;<a href="mailto:freebsd-doc@FreeBSD.org">freebsd-doc@FreeBSD.org</a>&gt;.</small></p></body></html>