<?xml version="1.0" encoding="iso-8859-1" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" /><title>7. Building FreeBSD Installation Media</title><link rel="stylesheet" type="text/css" href="docbook.css" /><link rev="made" href="mailto:doc@FreeBSD.org" /><meta name="generator" content="DocBook XSL Stylesheets V1.79.1" /><link rel="home" href="index.html" title="FreeBSD Release Engineering" /><link rel="up" href="index.html" title="FreeBSD Release Engineering" /><link rel="prev" href="releng-stable.html" title="6. Release from stable/" /><link rel="next" href="releng-mirrors.html" title="8. Publishing FreeBSD Installation Media to Project Mirrors" /><link rel="copyright" href="trademarks.html" title="Legal Notice" /><script xmlns="" type="text/javascript" src="/layout/js/google.js"></script></head><body><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">7. Building FreeBSD Installation Media</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="releng-stable.html">Prev</a> </td><th width="60%" align="center"> </th><td width="20%" align="right"> <a accesskey="n" href="releng-mirrors.html">Next</a></td></tr></table><hr /></div><div class="sect1"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="releng-building"></a>7. Building FreeBSD Installation Media</h2></div></div></div><p>This section describes the general procedures producing FreeBSD
    development snapshots and releases.</p><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="releng-build-scripts"></a>7.1. Release Build Scripts</h3></div></div></div><p>This section describes the build scripts used by FreeBSD Release Engineering Team
      to produce development snapshots and releases.</p><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="releng-build-scripts-single"></a>7.1.1. The <code class="filename">release.sh</code> Script</h4></div></div></div><p>Prior to FreeBSD 9.0-RELEASE,
	<code class="filename">src/release/Makefile</code> was updated to
	support <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=bsdinstall&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">bsdinstall</span>(8)</span></a>, and the
	<code class="filename">src/release/generate-release.sh</code> script
	was introduced as a wrapper to automate invoking the
	<a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=release&amp;sektion=7&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">release</span>(7)</span></a> targets.</p><p>Prior to FreeBSD 9.2-RELEASE,
	<code class="filename">src/release/release.sh</code> was introduced,
	which heavily based on
	<code class="filename">src/release/generate-release.sh</code> included
	support to specify configuration files to override various
	options and environment variables.  Support for configuration
	files provided support for cross building each architecture
	for a release by specifying a separate configuration file for
	each invocation.</p><p>As a brief example of using
	<code class="filename">src/release/release.sh</code> to build a single
	release in <code class="filename">/scratch</code>:</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>/bin/sh /usr/src/release/release.sh</code></strong></pre><p>As a brief example of using
	<code class="filename">src/release/release.sh</code> to build a single,
	cross-built release using a different target directory, create
	a custom <code class="filename">release.conf</code> containing:</p><pre class="programlisting"># release.sh configuration for powerpc/powerpc64
CHROOTDIR="/scratch-powerpc64"
TARGET="powerpc"
TARGET_ARCH="powerpc64"
KERNEL="GENERIC64"</pre><p>Then invoke <code class="filename">src/release/release.sh</code>
	as:</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>/bin/sh /usr/src/release/release.sh -c <em class="replaceable"><code>$HOME/release.conf</code></em></code></strong></pre><p>See <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=release&amp;sektion=7&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">release</span>(7)</span></a> and
	<code class="filename">src/release/release.conf.sample</code> for more
	details and example usage.</p></div><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="releng-build-scripts-multiple"></a>7.1.2. The <code class="filename">thermite.sh</code> Wrapper
	Script</h4></div></div></div><p>In order to make cross building the full set of
	architectures supported on a given branch faster, easier, and
	reduce human error factors, a wrapper script around
	<code class="filename">src/release/release.sh</code> was written to
	iterate through the various combinations of architectures and
	invoke <code class="filename">src/release/release.sh</code> using
	a configuration file specific to that architecture.</p><p>The wrapper script is called
	<code class="filename">thermite.sh</code>, which is available in the
	FreeBSD Subversion repository at
	<code class="literal">svn://svn.freebsd.org/base/user/gjb/thermite/</code>,
	in addition to configuration files used to build
	<code class="literal">head/</code> and <code class="literal">stable/<em class="replaceable"><code>12</code></em>/</code> development
	snapshots.</p><p>Using <code class="filename">thermite.sh</code> is covered in <a class="xref" href="releng-building.html#releng-build-snapshot" title="7.2. Building FreeBSD Development Snapshots">Section 7.2, &#8220;Building FreeBSD Development Snapshots&#8221;</a> and <a class="xref" href="releng-building.html#releng-build-release" title="7.3. Building FreeBSD Releases">Section 7.3, &#8220;Building FreeBSD Releases&#8221;</a>.</p><p>Each architecture and individual kernel have their own
	configuration file used by <code class="filename">release.sh</code>.
	Each branch has its own <code class="filename">defaults-X.conf</code>
	configuration which contains entries common throughout each
	architecture, where overrides or special variables are set
	and/or overridden in the per-build files.</p><p>The per-build configuration file naming scheme is in the
	form of
	<code class="filename">${revision}-${TARGET_ARCH}-${KERNCONF}-${type}.conf</code>,
	where the uppercase variables are equivalent to what
	<a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=make&amp;sektion=1&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">make</span>(1)</span></a> uses in the build system, and lowercase variables
	are set within the configuration files, mapping to the major
	version of the respective branch.</p><p>Each branch also has its own
	<code class="filename">builds-X.conf</code> configuration, which is
	used by <code class="filename">thermite.sh</code>.  The
	<code class="filename">thermite.sh</code> script iterates through each
	${revision}, ${TARGET_ARCH},
	${KERNCONF}, and ${type} value, creating
	a master list of what to build.  However, a given
	combination from the list will only be built if the
	respective configuration file exists, which is where the
	naming scheme above is relevant.</p><p>There are two paths of file sourcing:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p><code class="filename">builds-<em class="replaceable"><code>12</code></em>.conf</code>
	    -&gt; <code class="filename">main.conf</code></p><p>This controls <code class="filename">thermite.sh</code>
	    behavior</p></li><li class="listitem"><p><code class="filename"><em class="replaceable"><code>12</code></em>-<em class="replaceable"><code>amd64</code></em>-<em class="replaceable"><code>GENERIC</code></em>-<em class="replaceable"><code>snap</code></em>.conf</code>
	    -&gt;
	    <code class="filename">defaults-<em class="replaceable"><code>12</code></em>.conf</code>
	    -&gt; <code class="filename">main.conf</code></p><p>This controls <code class="filename">release/release.sh</code>
	    behavior within the build <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=chroot&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">chroot</span>(8)</span></a></p></li></ul></div><div xmlns="" class="note"><h3 class="admontitle">Note: </h3><p xmlns="http://www.w3.org/1999/xhtml">The
	  <code class="filename">builds-<em class="replaceable"><code>12</code></em>.conf</code>,
	  <code class="filename">defaults-<em class="replaceable"><code>12</code></em>.conf</code>,
	  and <code class="filename">main.conf</code> configuration files exist
	  to reduce repetition between the various per-build
	  files.</p></div></div></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="releng-build-snapshot"></a>7.2. Building FreeBSD Development Snapshots</h3></div></div></div><p>The official release build machines have a specific
      filesystem layout, which using <acronym class="acronym">ZFS</acronym>,
      <code class="filename">thermite.sh</code> takes heavy advantage of with
      clones and snapshots, ensuring a pristine build
      environment.</p><p>The build scripts reside in <code class="filename">/releng/scripts-snapshot/scripts</code>
      or <code class="filename">/releng/scripts-release/scripts</code>
      respectively, to avoid collisions between an
      <code class="literal">RC</code> build from a releng branch versus
      a <code class="literal">STABLE</code> snapshot from the respective stable
      branch.</p><p>A separate dataset exists for the final build images,
      <code class="filename">/snap/ftp</code>.  This
      directory contains both snapshots and releases directories.
      They are only used if the <code class="literal">EVERYTHINGISFINE</code>
      variable is defined in <code class="filename">main.conf</code>.</p><div xmlns="" class="note"><h3 class="admontitle">Note: </h3><p xmlns="http://www.w3.org/1999/xhtml">The <code class="literal">EVERYTHINGISFINE</code> variable name was
	chosen to avoid colliding with a variable that might be
	possibly set in the user environment, accidentally enabling
	the behavior that depends on it being defined.</p></div><p>As <code class="filename">thermite.sh</code> iterates through the
      master list of combinations and locates the per-build
      configuration file, a <acronym class="acronym">ZFS</acronym> dataset is created
      under <code class="filename">/releng</code>, such as
      <code class="filename">/releng/12-amd64-GENERIC-snap</code>.
      The <code class="literal">src/</code>, <code class="literal">ports/</code>, and
      <code class="literal">doc/</code> trees are checked out to separate
      <acronym class="acronym">ZFS</acronym> datasets, such as <code class="filename">/releng/12-src-snap</code>, which are
      then cloned and mounted into the respective build datasets.
      This is done to avoid checking out a given tree more than
      once.</p><p>Assuming these filesystem paths,
      <code class="filename">thermite.sh</code> would be invoked as:</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>cd /releng/scripts-snapshot/scripts</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>./setrev.sh -b <code class="literal">stable/<em class="replaceable"><code>12</code></em>/</code></code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>./zfs-cleanup.sh -c ./builds-<em class="replaceable"><code>12</code></em>.conf</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>./thermite.sh -c ./builds-<em class="replaceable"><code>12</code></em>.conf</code></strong></pre><p>Once the builds have completed, additional helper scripts
      are available to generate development snapshot emails which are
      sent to the <code class="literal">freebsd-snapshots@freebsd.org</code>
      mailing list:</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>cd /releng/scripts-snapshot/scripts</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>./get-checksums.sh -c ./builds-<em class="replaceable"><code>12</code></em>.conf | ./generate-email.pl &gt; snapshot-<em class="replaceable"><code>12</code></em>-mail</code></strong></pre><div xmlns="" class="note"><h3 class="admontitle">Note: </h3><p xmlns="http://www.w3.org/1999/xhtml">The generated output should be double-checked for
	correctness, and the email itself should be PGP signed,
	in-line.</p></div><div xmlns="" class="note"><h3 class="admontitle">Note: </h3><p xmlns="http://www.w3.org/1999/xhtml">These helper scripts only apply to development snapshot
	builds.  Announcements during the release cycle (excluding the
	final release announcement) are created from an email
	template.  A sample of the email template currently used can
	be found <a class="link" href="https://svn.freebsd.org/base/user/gjb/thermite/non-release-template-mail.txt" target="_top">here</a>.</p></div></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="releng-build-release"></a>7.3. Building FreeBSD Releases</h3></div></div></div><p>Similar to building FreeBSD development snapshots,
      <code class="filename">thermite.sh</code> would be invoked the same way.
      The difference between development snapshots and release builds,
      <code class="literal">BETA</code> and <code class="literal">RC</code> included, is
      that the <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=chroot&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">chroot</span>(8)</span></a> configuration files must be named with
      <code class="literal">release</code> instead of <code class="literal">snap</code> as
      the "type", as mentioned above.</p><p>In addition, the <code class="literal">BUILDTYPE</code> and
      <code class="literal">types</code> must be changed from
      <code class="literal">snap</code> to <code class="literal">release</code> in
      <code class="filename">defaults-<em class="replaceable"><code>12</code></em>.conf</code>
      and
      <code class="filename">builds-<em class="replaceable"><code>12</code></em>.conf</code>,
      respectively.</p><p>When building <code class="literal">BETA</code>,
      <code class="literal">RC</code>, and the final <code class="literal">RELEASE</code>,
      also statically set <code class="literal">BUILDSVNREV</code> to the
      revision on the branch reflecting the name change,
      <code class="literal">BUILDDATE</code> to the date the builds are started
      in <code class="literal">YYYYMMDD</code> format.  If the
      <code class="literal">doc/</code> and <code class="literal">ports/</code> trees have
      been tagged, also set <code class="literal">PORTBRANCH</code> and
      <code class="literal">DOCBRANCH</code> to the relevant tag path in the
      Subversion repository, replacing <code class="literal">HEAD</code> with
      the last changed revision.  Also set
      <code class="literal">releasesrc</code> in
      <code class="filename">builds-<em class="replaceable"><code>12</code></em>.conf</code>
      to the relevant branch, such as <code class="literal">stable/<em class="replaceable"><code>12</code></em>/</code> or
      <code class="literal">releng/<em class="replaceable"><code>12.0</code></em>/</code>.</p><p>During the release cycle, a copy of
      <code class="filename">CHECKSUM.SHA512</code> and
      <code class="filename">CHECKSUM.SHA256</code> for each architecture are
      stored in the FreeBSD Release Engineering Team internal repository in addition to being
      included in the various announcement emails.  Each
      <code class="filename">MANIFEST</code> containing the hashes of
      <code class="filename">base.txz</code>, <code class="filename">kernel.txz</code>,
      etc. are added to
      <a xmlns="" class="package" href="https://www.freebsd.org/cgi/url.cgi?ports/misc/freebsd-release-manifests/pkg-descr">misc/freebsd-release-manifests</a> in the Ports
      Collection, as well.</p><p>In preparation for the release build, several files need to
      be updated:</p><div class="informaltable"><table class="informaltable" border="0"><colgroup><col /><col /></colgroup><thead><tr><th>File to Edit</th><th>What to Change</th></tr></thead><tbody><tr><td><code class="filename">sys/conf/newvers.sh</code></td><td>Update the <code class="varname">BRANCH</code> value to
	      <code class="literal">RELEASE</code></td></tr><tr><td><code class="filename">UPDATING</code></td><td>Add the anticipated announcement date</td></tr><tr><td><code class="filename">lib/csu/common/crtbrand.c</code></td><td>Replace <code class="literal">__FreeBSD_version</code> with
	      the value in
	      <code class="filename">sys/sys/param.h</code></td></tr></tbody></table></div><p>After building the final <code class="literal">RELEASE</code>, the
      <code class="literal">releng/<em class="replaceable"><code>12.0</code></em>/</code> branch is tagged as <code class="literal">release/<em class="replaceable"><code>12.0.0</code></em>/</code> using the
      revision from which the <code class="literal">RELEASE</code> was built.
      Similar to creating the <code class="literal">stable/<em class="replaceable"><code>12</code></em>/</code> and <code class="literal">releng/<em class="replaceable"><code>12.0</code></em>/</code>
      branches, this is done with <code class="command">svn cp</code>.  From the
      repository root:</p><pre class="screen"><code class="prompt">%</code> <strong class="userinput"><code>svn cp ^/<code class="literal">releng/<em class="replaceable"><code>12.0</code></em>/</code>@r<em class="replaceable"><code>306420</code></em> <code class="literal">release/<em class="replaceable"><code>12.0.0</code></em>/</code></code></strong>
<code class="prompt">%</code> <strong class="userinput"><code>svn commit <code class="literal">release/<em class="replaceable"><code>12.0.0</code></em>/</code></code></strong></pre></div></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="releng-stable.html">Prev</a> </td><td width="20%" align="center"> </td><td width="40%" align="right"> <a accesskey="n" href="releng-mirrors.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top">6. Release from <code class="literal">stable/</code> </td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right" valign="top"> 8. Publishing FreeBSD Installation Media to Project Mirrors</td></tr></table></div><p xmlns="" align="center"><small>All FreeBSD documents are available for download
    at <a href="https://download.freebsd.org/ftp/doc/">https://download.freebsd.org/ftp/doc/</a></small></p><p xmlns="" align="center"><small>Questions that are not answered by the
    <a href="https://www.FreeBSD.org/docs.html">documentation</a> may be
    sent to &lt;<a href="mailto:freebsd-questions@FreeBSD.org">freebsd-questions@FreeBSD.org</a>&gt;.<br />
    Send questions about this document to &lt;<a href="mailto:freebsd-doc@FreeBSD.org">freebsd-doc@FreeBSD.org</a>&gt;.</small></p></body></html>