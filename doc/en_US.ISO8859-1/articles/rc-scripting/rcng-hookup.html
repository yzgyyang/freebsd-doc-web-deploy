<?xml version="1.0" encoding="iso-8859-1" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" /><title>7. Connecting a script to the rc.d framework</title><link rel="stylesheet" type="text/css" href="docbook.css" /><link rev="made" href="mailto:doc@FreeBSD.org" /><meta name="generator" content="DocBook XSL Stylesheets V1.79.1" /><link rel="home" href="index.html" title="Practical rc.d scripting in BSD" /><link rel="up" href="index.html" title="Practical rc.d scripting in BSD" /><link rel="prev" href="rcng-daemon-adv.html" title="6. Startup and shutdown of an advanced daemon" /><link rel="next" href="rcng-args.html" title="8. Giving more flexibility to an rc.d script" /><link rel="copyright" href="trademarks.html" title="Legal Notice" /><script xmlns="" type="text/javascript" src="/layout/js/google.js"></script></head><body><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">7. Connecting a script to the rc.d framework</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="rcng-daemon-adv.html">Prev</a> </td><th width="60%" align="center"> </th><td width="20%" align="right"> <a accesskey="n" href="rcng-args.html">Next</a></td></tr></table><hr /></div><div class="sect1"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="rcng-hookup"></a>7. Connecting a script to the rc.d framework</h2></div></div></div><p>After a script has been written, it needs to be integrated
      into <code class="filename">rc.d</code>.  The crucial step is to install
      the script in <code class="filename">/etc/rc.d</code> (for the base
      system) or <code class="filename">/usr/local/etc/rc.d</code> (for
      ports).  Both &lt;<code class="filename">bsd.prog.mk</code>&gt; and
      &lt;<code class="filename">bsd.port.mk</code>&gt; provide convenient
      hooks for that, and usually you do not have to worry about
      the proper ownership and mode.  System scripts should be
      installed from <code class="filename">src/etc/rc.d</code> through the
      <code class="filename">Makefile</code> found there.  Port scripts can
      be installed using <code class="varname">USE_RC_SUBR</code> as described
      <a class="link" href="../../../../doc/en_US.ISO8859-1/books/porters-handbook/rc-scripts.html" target="_top">in
      the Porter's Handbook</a>.</p><p>However, we should consider beforehand the place of
      our script in the system startup sequence.  The service handled
      by our script is likely to depend on other services.  For
      instance, a network daemon cannot function without the network
      interfaces and routing up and running.  Even if a service
      seems to demand nothing, it can hardly start before the basic
      filesystems have been checked and mounted.</p><p>We mentioned <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=rcorder&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">rcorder</span>(8)</span></a> already.  Now it is time to
      have a close look at it.  In a nutshell, <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=rcorder&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">rcorder</span>(8)</span></a> takes
      a set of files, examines their contents, and prints a
      dependency-ordered list of files from the set to
      <code class="varname">stdout</code>.  The point is to keep dependency
      information <span class="emphasis"><em>inside</em></span> the files so that
      each file can speak for itself only.  A file can specify the
      following information:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>the names of the <span class="quote">&#8220;<span class="quote">conditions</span>&#8221;</span> (which means
	  services to us) it <span class="emphasis"><em>provides</em></span>;</p></li><li class="listitem"><p>the names of the <span class="quote">&#8220;<span class="quote">conditions</span>&#8221;</span>
	  it <span class="emphasis"><em>requires</em></span>;</p></li><li class="listitem"><p>the names of the <span class="quote">&#8220;<span class="quote">conditions</span>&#8221;</span> this file
	  should run <span class="emphasis"><em>before</em></span>;</p></li><li class="listitem"><p>additional <span class="emphasis"><em>keywords</em></span> that can be
	  used to select a subset from the whole set of files
	  (<a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=rcorder&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">rcorder</span>(8)</span></a> can be instructed via options to include
	  or omit the files having particular keywords listed.)</p></li></ul></div><p>It is no surprise that <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=rcorder&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">rcorder</span>(8)</span></a> can handle only
      text files with a syntax close to that of <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=sh&amp;sektion=1&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">sh</span>(1)</span></a>.  That
      is, special lines understood by <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=rcorder&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">rcorder</span>(8)</span></a> look like
      <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=sh&amp;sektion=1&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">sh</span>(1)</span></a> comments.  The syntax of such special lines is
      rather rigid to simplify their processing.  See <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=rcorder&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">rcorder</span>(8)</span></a>
      for details.</p><p>Besides using <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=rcorder&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">rcorder</span>(8)</span></a> special lines, a script can
      insist on its dependency upon another service by just starting
      it forcibly.  This can be needed when the other service is
      optional and will not start by itself because the system admin
      has disabled it mistakenly in <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=rc.conf&amp;sektion=5&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">rc.conf</span>(5)</span></a>.</p><p>With this general knowledge in mind, let us consider the
      simple daemon script enhanced with dependency stuff:</p><div class="informalexample"><pre class="programlisting">#!/bin/sh

# PROVIDE: mumbled oldmumble <a id="rcng-hookup-provide"></a><span><img src="./imagelib/callouts/1.png" alt="1" border="0" /></span>
# REQUIRE: DAEMON cleanvar frotz<a id="rcng-hookup-require"></a><span><img src="./imagelib/callouts/2.png" alt="2" border="0" /></span>
# BEFORE:  LOGIN<a id="rcng-hookup-before"></a><span><img src="./imagelib/callouts/3.png" alt="3" border="0" /></span>
# KEYWORD: nojail shutdown<a id="rcng-hookup-keyword"></a><span><img src="./imagelib/callouts/4.png" alt="4" border="0" /></span>

. /etc/rc.subr

name=mumbled
rcvar=mumbled_enable

command="/usr/sbin/${name}"
start_precmd="${name}_prestart"

mumbled_prestart()
{
	if ! checkyesno frotz_enable &amp;&amp; \
	    ! /etc/rc.d/frotz forcestatus 1&gt;/dev/null 2&gt;&amp;1; then
		force_depend frotz || return 1<a id="rcng-hookup-force"></a><span><img src="./imagelib/callouts/5.png" alt="5" border="0" /></span>
	fi
	return 0
}

load_rc_config $name
run_rc_command "$1"</pre></div><p>As before, detailed analysis follows:</p><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#rcng-hookup-provide"><span><img src="./imagelib/callouts/1.png" alt="1" border="0" /></span></a> </p></td><td valign="top" align="left"><p>That line declares the names of <span class="quote">&#8220;<span class="quote">conditions</span>&#8221;</span>
	  our script provides.  Now other scripts can record a
	  dependency on our script by those names.</p><div xmlns="" class="note"><h3 class="admontitle">Note: </h3><p xmlns="http://www.w3.org/1999/xhtml">Usually a script specifies a single condition
	    provided.  However, nothing prevents us from listing
	    several conditions there, e.g., for compatibility
	    reasons.</p><p xmlns="http://www.w3.org/1999/xhtml">In any case, the name of the main, or the only,
	    <code class="literal">PROVIDE:</code> condition should be the
	    same as <code class="envar">${name}</code>.</p></div></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#rcng-hookup-require"><span><img src="./imagelib/callouts/2.png" alt="2" border="0" /></span></a> <a href="#rcng-hookup-before"><span><img src="./imagelib/callouts/3.png" alt="3" border="0" /></span></a> </p></td><td valign="top" align="left"><p>So our script indicates which <span class="quote">&#8220;<span class="quote">conditions</span>&#8221;</span>
	  provided by other scripts it depends on.  According to
	  the lines, our script asks <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=rcorder&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">rcorder</span>(8)</span></a> to put it after
	  the script(s) providing <code class="filename">DAEMON</code> and
	  <code class="filename">cleanvar</code>, but before that providing
	  <code class="filename">LOGIN</code>.</p><div xmlns="" class="note"><h3 class="admontitle">Note: </h3><p xmlns="http://www.w3.org/1999/xhtml">The <code class="literal">BEFORE:</code> line should not be
	    abused to work around an incomplete dependency list in
	    the other script.  The appropriate case for using
	    <code class="literal">BEFORE:</code> is when the other script
	    does not care about ours, but our script can do its
	    task better if run before the other one.  A typical
	    real-life example is the network interfaces vs. the
	    firewall: While the interfaces do not depend on the
	    firewall in doing their job, the system security will
	    benefit from the firewall being ready before there is
	    any network traffic.</p><p xmlns="http://www.w3.org/1999/xhtml">Besides conditions corresponding to a single service
	    each, there are meta-conditions and their
	    <span class="quote">&#8220;<span class="quote">placeholder</span>&#8221;</span> scripts used to ensure that
	    certain groups of operations are performed before others.
	    These are denoted by
	    <code class="filename"><em class="replaceable"><code>UPPERCASE</code></em></code>
	    names.  Their list and purposes can be found in
	    <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=rc&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">rc</span>(8)</span></a>.</p><p xmlns="http://www.w3.org/1999/xhtml">Keep in mind that putting a service name in the
	    <code class="literal">REQUIRE:</code> line does not guarantee
	    that the service will actually be running by the time
	    our script starts.  The required service may fail to
	    start or just be disabled in <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=rc.conf&amp;sektion=5&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">rc.conf</span>(5)</span></a>.  Obviously,
	    <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=rcorder&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">rcorder</span>(8)</span></a> cannot track such details, and <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=rc&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">rc</span>(8)</span></a>
	    will not do that either.  Consequently, the application
	    started by our script should be able to cope with any
	    required services being unavailable.  In certain cases,
	    we can help it as discussed <a class="link" href="rcng-hookup.html#forcedep">below.</a></p></div></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#rcng-hookup-keyword"><span><img src="./imagelib/callouts/4.png" alt="4" border="0" /></span></a> </p></td><td valign="top" align="left"><p><a id="keywords"></a>As we remember from the above text,
	  <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=rcorder&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">rcorder</span>(8)</span></a> keywords can be used to select or leave
	  out some scripts.  Namely any <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=rcorder&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">rcorder</span>(8)</span></a> consumer
	  can specify through <code class="option">-k</code> and <code class="option">-s</code>
	  options which keywords are on the <span class="quote">&#8220;<span class="quote">keep list</span>&#8221;</span> and
	  <span class="quote">&#8220;<span class="quote">skip list</span>&#8221;</span>, respectively.  From all the
	  files to be dependency sorted, <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=rcorder&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">rcorder</span>(8)</span></a> will pick
	  only those having a keyword from the keep list (unless empty)
	  and not having a keyword from the skip list.</p><p>In FreeBSD, <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=rcorder&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">rcorder</span>(8)</span></a> is used by
	  <code class="filename">/etc/rc</code> and
	  <code class="filename">/etc/rc.shutdown</code>.  These two scripts
	  define the standard list of FreeBSD <code class="filename">rc.d</code>
	  keywords and their meanings as follows:</p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">nojail</code></span></dt><dd><p>The service is not for <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=jail&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">jail</span>(8)</span></a> environment.
		The automatic startup and shutdown procedures will
		ignore the script if inside a jail.</p></dd><dt><span class="term"><code class="literal">nostart</code></span></dt><dd><p>The service is to be started manually or not
		started at all.  The automatic startup procedure
		will ignore the script.  In conjunction with the
		<code class="literal">shutdown</code> keyword, this can be
		used to write scripts that do something only at
		system shutdown.</p></dd><dt><span class="term"><code class="literal">shutdown</code></span></dt><dd><p>This keyword is to be listed
		<span class="emphasis"><em>explicitly</em></span> if the service needs
		to be stopped before system shutdown.</p><div xmlns="" class="note"><h3 class="admontitle">Note: </h3><p xmlns="http://www.w3.org/1999/xhtml">When the system is going to shut down,
		  <code class="filename">/etc/rc.shutdown</code> runs.  It
		  assumes that most <code class="filename">rc.d</code> scripts
		  have nothing to do at that time.  Therefore
		  <code class="filename">/etc/rc.shutdown</code>
		  selectively invokes <code class="filename">rc.d</code>
		  scripts with the <code class="literal">shutdown</code>
		  keyword, effectively ignoring the
		  rest of the scripts.  For even faster shutdown,
		  <code class="filename">/etc/rc.shutdown</code> passes
		  the <code class="option">faststop</code> command to the scripts
		  it runs so that they skip preliminary checks, e.g.,
		  the pidfile check.  As dependent services should be
		  stopped before their prerequisites,
		  <code class="filename">/etc/rc.shutdown</code> runs the scripts
		  in reverse dependency order.</p><p xmlns="http://www.w3.org/1999/xhtml">If writing a real
		  <code class="filename">rc.d</code> script, you should
		  consider whether it is relevant at system shutdown
		  time.  E.g., if your script does its work in
		  response to the <code class="option">start</code> command
		  only, then you need not include this keyword.
		  However, if your script manages a service, it is
		  probably a good idea to stop it before the system
		  proceeds to the final stage of its shutdown
		  sequence described in <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=halt&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">halt</span>(8)</span></a>.  In particular,
		  a service should be stopped explicitly if it needs
		  considerable time or special actions to shut down
		  cleanly.  A typical example of such a service is
		  a database engine.</p></div></dd></dl></div></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#rcng-hookup-force"><span><img src="./imagelib/callouts/5.png" alt="5" border="0" /></span></a> </p></td><td valign="top" align="left"><p><a id="forcedep"></a>To begin with,
	  <code class="function">force_depend</code> should be used with
	  much care.  It is generally better to revise the hierarchy
	  of configuration variables for your <code class="filename">rc.d</code>
	  scripts if they are interdependent.</p><p>If you still cannot do without
	  <code class="function">force_depend</code>, the example offers an
	  idiom of how to invoke it conditionally.  In the example,
	  our <code class="command">mumbled</code> daemon requires that another
	  one, <code class="command">frotz</code>, be started in advance.
	  However, <code class="command">frotz</code> is optional, too; and
	  <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=rcorder&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">rcorder</span>(8)</span></a> knows nothing about such details.
	  Fortunately, our script has access to all <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=rc.conf&amp;sektion=5&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">rc.conf</span>(5)</span></a>
	  variables.  If <code class="envar">frotz_enable</code> is true, we
	  hope for the best and rely on <code class="filename">rc.d</code>
	  to have started <code class="command">frotz</code>.  Otherwise we
	  forcibly check the status of <code class="command">frotz</code>.
	  Finally, we enforce our dependency on <code class="command">frotz</code>
	  if it is found to be not running.  A warning message will
	  be emitted by <code class="function">force_depend</code> because
	  it should be invoked only if a misconfiguration has been
	  detected.</p></td></tr></table></div></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="rcng-daemon-adv.html">Prev</a> </td><td width="20%" align="center"> </td><td width="40%" align="right"> <a accesskey="n" href="rcng-args.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top">6. Startup and shutdown of an advanced daemon </td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right" valign="top"> 8. Giving more flexibility to an rc.d script</td></tr></table></div><p xmlns="" align="center"><small>All FreeBSD documents are available for download
    at <a href="https://download.freebsd.org/ftp/doc/">https://download.freebsd.org/ftp/doc/</a></small></p><p xmlns="" align="center"><small>Questions that are not answered by the
    <a href="https://www.FreeBSD.org/docs.html">documentation</a> may be
    sent to &lt;<a href="mailto:freebsd-questions@FreeBSD.org">freebsd-questions@FreeBSD.org</a>&gt;.<br />
    Send questions about this document to &lt;<a href="mailto:freebsd-doc@FreeBSD.org">freebsd-doc@FreeBSD.org</a>&gt;.</small></p></body></html>