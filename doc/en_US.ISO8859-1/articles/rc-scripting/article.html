<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" /><title>Practical rc.d scripting in BSD</title><link rel="stylesheet" type="text/css" href="docbook.css" /><link rev="made" href="mailto:doc@FreeBSD.org" /><meta name="generator" content="DocBook XSL Stylesheets V1.79.1" /><meta name="description" content="Beginners may find it difficult to relate the facts from the formal documentation on the BSD rc.d framework with the practical tasks of rc.d scripting. In this article, we consider a few typical cases of increasing complexity, show rc.d features suited for each case, and discuss how they work. Such an examination should provide reference points for further study of the design and efficient application of rc.d." /><script xmlns="" type="text/javascript" src="/layout/js/google.js"></script></head><body><div xml:lang="en" class="article" lang="en"><div xmlns="" class="titlepage"><div><div><h1 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp44807800"></a>Practical rc.d scripting in BSD</h1></div><div><div xmlns="http://www.w3.org/1999/xhtml" class="author"><h3 class="author"><span class="firstname">Yar</span> <span class="surname">Tikhiy</span></h3><div class="affiliation"><div class="address"><p><code class="email">&lt;<a xmlns="" class="email" href="mailto:yar@FreeBSD.org">yar@FreeBSD.org</a>&gt;</code></p></div></div></div></div><div>Revision: <a href="https://svnweb.freebsd.org/changeset/doc/c5d00c16fb"><span class="svnref">c5d00c16fb</span></a></div><div><p xmlns="http://www.w3.org/1999/xhtml" class="copyright">Copyright © 2005-2006, 2012 The FreeBSD Project</p></div><div><div xmlns="http://www.w3.org/1999/xhtml" class="legalnotice"><a id="trademarks"></a><p>FreeBSD is a registered trademark of
  the FreeBSD Foundation.</p><p>NetBSD is a registered trademark of
  the NetBSD Foundation.</p><p>Many of the designations used by
  manufacturers and sellers to distinguish their products are claimed
  as trademarks.  Where those designations appear in this document,
  and the FreeBSD Project was aware of the trademark claim, the
  designations have been followed by the <span class="quote">&#8220;<span class="quote">&#8482;</span>&#8221;</span> or the
  <span class="quote">&#8220;<span class="quote">®</span>&#8221;</span> symbol.</p></div></div><div>Last modified on 2014-04-29 21:39:27 +0000 by wblock.</div><div><div xmlns="http://www.w3.org/1999/xhtml" class="abstract"><div class="abstract-title">Abstract</div><p>Beginners may find it difficult to relate the
	facts from the formal documentation on the BSD
	<code class="filename">rc.d</code> framework with the practical tasks
	of <code class="filename">rc.d</code> scripting.  In this article,
	we consider a few typical cases of increasing complexity,
	show <code class="filename">rc.d</code> features suited for each
	case, and discuss how they work.  Such an examination should
	provide reference points for further study of the design
	and efficient application of <code class="filename">rc.d</code>.</p></div></div></div><div class="docformatnavi">
      [
      <a href="index.html">Split HTML</a>
      /
      
	  Single HTML
	
      ]
    </div><hr /></div><div class="toc"><div class="toc-title">Table of Contents</div><dl class="toc"><dt><span class="sect1"><a href="#rcng-intro">1. Introduction</a></span></dt><dt><span class="sect1"><a href="#rcng-task">2. Outlining the task</a></span></dt><dt><span class="sect1"><a href="#rcng-dummy">3. A dummy script</a></span></dt><dt><span class="sect1"><a href="#rcng-confdummy">4. A configurable dummy script</a></span></dt><dt><span class="sect1"><a href="#rcng-daemon">5. Startup and shutdown of a simple daemon</a></span></dt><dt><span class="sect1"><a href="#rcng-daemon-adv">6. Startup and shutdown of an advanced daemon</a></span></dt><dt><span class="sect1"><a href="#rcng-hookup">7. Connecting a script to the rc.d framework</a></span></dt><dt><span class="sect1"><a href="#rcng-args">8. Giving more flexibility to an rc.d script</a></span></dt><dt><span class="sect1"><a href="#rcng-furthur">9. Further reading</a></span></dt></dl></div><div class="sect1"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="rcng-intro"></a>1. Introduction</h2></div></div></div><p>The historical BSD had a monolithic startup script,
      <code class="filename">/etc/rc</code>.  It was invoked by
      <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=init&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">init</span>(8)</span></a> at system boot time and performed all userland
      tasks required for multi-user operation: checking and
      mounting file systems, setting up the network, starting
      daemons, and so on.  The precise list of tasks was not the
      same in every system; admins needed to customize it.  With
      few exceptions, <code class="filename">/etc/rc</code> had to be modified,
      and true hackers liked it.</p><p>The real problem with the monolithic approach was that
      it provided no control over the individual components started
      from <code class="filename">/etc/rc</code>.  For instance,
      <code class="filename">/etc/rc</code> could not restart a single daemon.
      The system admin had to find the daemon process by hand, kill it,
      wait until it actually exited, then browse through
      <code class="filename">/etc/rc</code> for the flags, and finally type
      the full command line to start the daemon again.  The task
      would become even more difficult and prone to errors if the
      service to restart consisted of more than one daemon or
      demanded additional actions.  In a few words, the single
      script failed to fulfil what scripts are for: to make the
      system admin's life easier.</p><p>Later there was an attempt to split out some parts of
      <code class="filename">/etc/rc</code> for the sake of starting the
      most important subsystems separately.  The notorious example
      was <code class="filename">/etc/netstart</code> to bring up networking.
      It did allow for accessing the network from single-user
      mode, but it did not integrate well into the automatic startup
      process because parts of its code needed to interleave with
      actions essentially unrelated to networking.  That was why
      <code class="filename">/etc/netstart</code> mutated into
      <code class="filename">/etc/rc.network</code>.  The latter was no
      longer an ordinary script; it comprised of large, tangled
      <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=sh&amp;sektion=1&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">sh</span>(1)</span></a> functions called from <code class="filename">/etc/rc</code>
      at different stages of system startup.  However, as the startup
      tasks grew diverse and sophisticated, the
      <span class="quote">&#8220;<span class="quote">quasi-modular</span>&#8221;</span> approach became even more of a
      drag than the monolithic <code class="filename">/etc/rc</code> had
      been.</p><p>Without a clean and well-designed framework, the startup
      scripts had to bend over backwards to satisfy the needs of
      rapidly developing BSD-based operating systems.  It became
      obvious at last that more steps are necessary on the way to
      a fine-grained and extensible <code class="filename">rc</code> system.
      Thus BSD <code class="filename">rc.d</code> was born.  Its acknowledged
      fathers were Luke Mewburn and the NetBSD community.  Later
      it was imported into FreeBSD.  Its name refers to the location
      of system scripts for individual services, which is in
      <code class="filename">/etc/rc.d</code>.  Soon we
      will learn about more components of the <code class="filename">rc.d</code>
      system and see how the individual scripts are invoked.</p><p>The basic ideas behind BSD <code class="filename">rc.d</code> are
      <span class="emphasis"><em>fine modularity</em></span> and <span class="emphasis"><em>code
      reuse</em></span>.  <span class="emphasis"><em>Fine modularity</em></span> means
      that each basic <span class="quote">&#8220;<span class="quote">service</span>&#8221;</span> such as a system daemon
      or primitive startup task gets its own <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=sh&amp;sektion=1&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">sh</span>(1)</span></a> script able
      to start the service, stop it, reload it, check its status.
      A particular action is chosen by the command-line argument
      to the script.  The <code class="filename">/etc/rc</code> script still
      drives system startup, but now it merely invokes the smaller
      scripts one by one with the <code class="option">start</code> argument.
      It is easy to perform shutdown tasks as well by running the
      same set of scripts with the <code class="option">stop</code> argument,
      which is done by <code class="filename">/etc/rc.shutdown</code>.  Note
      how closely this follows the Unix way of having a set of small
      specialized tools, each fulfilling its task as well as possible.
      <span class="emphasis"><em>Code reuse</em></span> means that common operations
      are implemented as <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=sh&amp;sektion=1&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">sh</span>(1)</span></a> functions and collected in
      <code class="filename">/etc/rc.subr</code>.  Now a typical script can
      be just a few lines' worth of <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=sh&amp;sektion=1&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">sh</span>(1)</span></a> code.  Finally, an
      important part of the <code class="filename">rc.d</code> framework is
      <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=rcorder&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">rcorder</span>(8)</span></a>, which helps <code class="filename">/etc/rc</code> to
      run the small scripts orderly with respect to dependencies
      between them.  It can help <code class="filename">/etc/rc.shutdown</code>,
      too, because the proper order for the shutdown sequence is
      opposite to that of startup.</p><p>The BSD <code class="filename">rc.d</code> design is described in
      <a class="link" href="#lukem">the original article by Luke Mewburn</a>,
      and the <code class="filename">rc.d</code> components are documented
      in great detail in <a class="link" href="#manpages">the respective
      manual pages</a>.  However, it might not appear obvious
      to an <code class="filename">rc.d</code> newbie how to tie the numerous
      bits and pieces together in order to create a well-styled
      script for a particular task.  Therefore this article will
      try a different approach to describe <code class="filename">rc.d</code>.
      It will show which features should be used in a number of
      typical cases, and why.  Note that this is not a how-to
      document because our aim is not at giving ready-made recipes,
      but at showing a few easy entrances into the
      <code class="filename">rc.d</code> realm.  Neither is this article a
      replacement for the relevant manual pages.  Do not hesitate
      to refer to them for more formal and complete documentation
      while reading this article.</p><p>There are prerequisites to understanding this article.
      First of all, you should be familiar with the <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=sh&amp;sektion=1&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">sh</span>(1)</span></a>
      scripting language in order to master <code class="filename">rc.d</code>.
      In addition, you should know how the system performs
      userland startup and shutdown tasks, which is described in
      <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=rc&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">rc</span>(8)</span></a>.</p><p>This article focuses on the FreeBSD branch of
      <code class="filename">rc.d</code>.  Nevertheless, it may be useful
      to NetBSD developers, too, because the two branches of BSD
      <code class="filename">rc.d</code> not only share the same design
      but also stay similar in their aspects visible to script
      authors.</p></div><div class="sect1"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="rcng-task"></a>2. Outlining the task</h2></div></div></div><p>A little consideration before starting
      <code class="envar">$EDITOR</code> will not hurt.  In order to write a
      well-tempered <code class="filename">rc.d</code> script for a system
      service, we should be able to answer the following questions
      first:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Is the service mandatory or optional?</p></li><li class="listitem"><p>Will the script serve a single program, e.g.,
	  a daemon, or perform more complex actions?</p></li><li class="listitem"><p>Which other services will our service depend on,
	  and vice versa?</p></li></ul></div><p>From the examples that follow we will see why it is
      important to know the answers to these questions.</p></div><div class="sect1"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="rcng-dummy"></a>3. A dummy script</h2></div></div></div><p>The following script just emits a message each time the
      system boots up:</p><div class="informalexample"><pre class="programlisting">#!/bin/sh<a id="rcng-dummy-shebang"></a><span><img src="./imagelib/callouts/1.png" alt="1" border="0" /></span>

. /etc/rc.subr<a id="rcng-dummy-include"></a><span><img src="./imagelib/callouts/2.png" alt="2" border="0" /></span>

name="dummy"<a id="rcng-dummy-name"></a><span><img src="./imagelib/callouts/3.png" alt="3" border="0" /></span>
start_cmd="${name}_start"<a id="rcng-dummy-startcmd"></a><span><img src="./imagelib/callouts/4.png" alt="4" border="0" /></span>
stop_cmd=":"<a id="rcng-dummy-stopcmd"></a><span><img src="./imagelib/callouts/5.png" alt="5" border="0" /></span>

dummy_start()<a id="rcng-dummy-startfn"></a><span><img src="./imagelib/callouts/6.png" alt="6" border="0" /></span>
{
	echo "Nothing started."
}

load_rc_config $name<a id="rcng-dummy-loadconfig"></a><span><img src="./imagelib/callouts/7.png" alt="7" border="0" /></span>
run_rc_command "$1"<a id="rcng-dummy-runcommand"></a><span><img src="./imagelib/callouts/8.png" alt="8" border="0" /></span></pre></div><p>Things to note are:</p><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#rcng-dummy-shebang"><span><img src="./imagelib/callouts/1.png" alt="1" border="0" /></span></a> </p></td><td valign="top" align="left"><p>An interpreted script should begin with the magic
	  <span class="quote">&#8220;<span class="quote">shebang</span>&#8221;</span> line.  That line specifies the
	  interpreter program for the script.  Due to the shebang
	  line, the script can be invoked exactly like a binary
	  program provided that it has the execute bit set.
	  (See <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=chmod&amp;sektion=1&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">chmod</span>(1)</span></a>.)
	  For example, a system admin can run our script manually,
	  from the command line:</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>/etc/rc.d/dummy start</code></strong></pre><div xmlns="" class="note"><h3 class="admontitle">Note: </h3><p xmlns="http://www.w3.org/1999/xhtml">In order to be properly managed by the
	    <code class="filename">rc.d</code> framework, its scripts need
	    to be written in the <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=sh&amp;sektion=1&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">sh</span>(1)</span></a> language.  If you have
	    a service or port that uses a binary control utility
	    or a startup routine written in another language,
	    install that element in <code class="filename">/usr/sbin</code>
	    (for the system) or <code class="filename">/usr/local/sbin</code>
	    (for ports) and call it from a <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=sh&amp;sektion=1&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">sh</span>(1)</span></a> script in the
	    appropriate <code class="filename">rc.d</code> directory.</p></div><div xmlns="" class="tip"><h3 class="admontitle">Tip: </h3><p xmlns="http://www.w3.org/1999/xhtml">If you would like to learn the details of why
	    <code class="filename">rc.d</code> scripts must be written in
	    the <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=sh&amp;sektion=1&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">sh</span>(1)</span></a> language, see how <code class="filename">/etc/rc</code>
	    invokes them by means of <code class="function">run_rc_script</code>,
	    then study the implementation of
	    <code class="function">run_rc_script</code> in
	    <code class="filename">/etc/rc.subr</code>.</p></div></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#rcng-dummy-include"><span><img src="./imagelib/callouts/2.png" alt="2" border="0" /></span></a> </p></td><td valign="top" align="left"><p>In <code class="filename">/etc/rc.subr</code>, a number of
	  <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=sh&amp;sektion=1&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">sh</span>(1)</span></a> functions are defined for an <code class="filename">rc.d</code>
	  script to use.  The functions are documented in
	  <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=rc.subr&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">rc.subr</span>(8)</span></a>.  While it is theoretically possible to
	  write an <code class="filename">rc.d</code> script without ever
	  using <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=rc.subr&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">rc.subr</span>(8)</span></a>, its functions prove extremely handy
	  and make the job an order of magnitude easier.  So it is
	  no surprise that everybody resorts to <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=rc.subr&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">rc.subr</span>(8)</span></a> in
	  <code class="filename">rc.d</code> scripts.  We are not going to
	  be an exception.</p><p>An <code class="filename">rc.d</code> script must
	  <span class="quote">&#8220;<span class="quote">source</span>&#8221;</span> <code class="filename">/etc/rc.subr</code>
	  (include it using <span class="quote">&#8220;<span class="quote"><code class="command">.</code></span>&#8221;</span>)
	  <span class="emphasis"><em>before</em></span> it calls <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=rc.subr&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">rc.subr</span>(8)</span></a>
	  functions so that <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=sh&amp;sektion=1&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">sh</span>(1)</span></a> has an opportunity to learn
	  the functions.  The preferred style is to source
	  <code class="filename">/etc/rc.subr</code> first of all.</p><div xmlns="" class="note"><h3 class="admontitle">Note: </h3><p xmlns="http://www.w3.org/1999/xhtml">Some useful functions related to networking
	    are provided by another include file,
	    <code class="filename">/etc/network.subr</code>.</p></div></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#rcng-dummy-name"><span><img src="./imagelib/callouts/3.png" alt="3" border="0" /></span></a> </p></td><td valign="top" align="left"><p><a id="name-var"></a>The mandatory variable
	  <code class="envar">name</code> specifies the name of our script.  It
	  is required by <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=rc.subr&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">rc.subr</span>(8)</span></a>.  That is, each
	  <code class="filename">rc.d</code> script <span class="emphasis"><em>must</em></span>
	  set <code class="envar">name</code> before it calls <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=rc.subr&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">rc.subr</span>(8)</span></a>
	  functions.</p><p>Now it is the right time to choose a unique name for
	  our script once and for all.  We will use it in a number
	  of places while developing the script.  For a start, let
	  us give the same name to the script file, too.</p><div xmlns="" class="note"><h3 class="admontitle">Note: </h3><p xmlns="http://www.w3.org/1999/xhtml">The current style of <code class="filename">rc.d</code>
	    scripting is to enclose values assigned to variables
	    in double quotes.  Keep in mind that it is just a style
	    issue that may not always be applicable.  You can
	    safely omit quotes from around simple words without
	    <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=sh&amp;sektion=1&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">sh</span>(1)</span></a> metacharacters in them, while in certain
	    cases you will need single quotes to prevent any
	    interpretation of the value by <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=sh&amp;sektion=1&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">sh</span>(1)</span></a>.  A programmer
	    should be able to tell the language syntax from style
	    conventions and use both of them wisely.</p></div></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#rcng-dummy-startcmd"><span><img src="./imagelib/callouts/4.png" alt="4" border="0" /></span></a> </p></td><td valign="top" align="left"><p>The main idea behind <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=rc.subr&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">rc.subr</span>(8)</span></a> is that an
	  <code class="filename">rc.d</code> script provides handlers, or
	  methods, for <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=rc.subr&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">rc.subr</span>(8)</span></a> to invoke.  In particular,
	  <code class="option">start</code>, <code class="option">stop</code>, and other
	  arguments to an <code class="filename">rc.d</code> script are
	  handled this way.  A method is a <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=sh&amp;sektion=1&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">sh</span>(1)</span></a> expression
	  stored in a variable named
	  <code class="envar"><em class="replaceable"><code>argument</code></em>_cmd</code>,
	  where <em class="replaceable"><code>argument</code></em> corresponds to
	  what can be specified on the script's command line.  We
	  will see later how <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=rc.subr&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">rc.subr</span>(8)</span></a> provides default methods
	  for the standard arguments.</p><div xmlns="" class="note"><h3 class="admontitle">Note: </h3><p xmlns="http://www.w3.org/1999/xhtml">To make the code in <code class="filename">rc.d</code> more
	    uniform, it is common to use <code class="envar">${name}</code>
	    wherever appropriate.  Thus a number of lines can be just
	    copied from one script to another.</p></div></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#rcng-dummy-stopcmd"><span><img src="./imagelib/callouts/5.png" alt="5" border="0" /></span></a> </p></td><td valign="top" align="left"><p>We should keep in mind that <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=rc.subr&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">rc.subr</span>(8)</span></a> provides
	  default methods for the standard arguments.  Consequently,
	  we must override a standard method with a no-op <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=sh&amp;sektion=1&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">sh</span>(1)</span></a>
	  expression if we want it to do nothing.</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#rcng-dummy-startfn"><span><img src="./imagelib/callouts/6.png" alt="6" border="0" /></span></a> </p></td><td valign="top" align="left"><p>The body of a sophisticated method can be implemented
	  as a function.  It is a good idea to make the function
	  name meaningful.</p><div xmlns="" class="important"><h3 class="admontitle">Important: </h3><p xmlns="http://www.w3.org/1999/xhtml">It is strongly recommended to add the prefix
	    <code class="envar">${name}</code> to the names of all functions
	    defined in our script so they never clash with the
	    functions from <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=rc.subr&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">rc.subr</span>(8)</span></a> or another common include
	    file.</p></div></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#rcng-dummy-loadconfig"><span><img src="./imagelib/callouts/7.png" alt="7" border="0" /></span></a> </p></td><td valign="top" align="left"><p>This call to <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=rc.subr&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">rc.subr</span>(8)</span></a> loads <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=rc.conf&amp;sektion=5&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">rc.conf</span>(5)</span></a>
	  variables.  Our script makes no use of them yet, but it
	  still is recommended to load <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=rc.conf&amp;sektion=5&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">rc.conf</span>(5)</span></a> because there
	  can be <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=rc.conf&amp;sektion=5&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">rc.conf</span>(5)</span></a> variables controlling <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=rc.subr&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">rc.subr</span>(8)</span></a>
	  itself.</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#rcng-dummy-runcommand"><span><img src="./imagelib/callouts/8.png" alt="8" border="0" /></span></a> </p></td><td valign="top" align="left"><p>Usually this is the last command in an
	  <code class="filename">rc.d</code> script.  It invokes the
	  <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=rc.subr&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">rc.subr</span>(8)</span></a> machinery to perform the requested action
	  using the variables and methods our script has provided.</p></td></tr></table></div></div><div class="sect1"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="rcng-confdummy"></a>4. A configurable dummy script</h2></div></div></div><p>Now let us add some controls to our dummy script.  As you
      may know, <code class="filename">rc.d</code> scripts are controlled
      with <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=rc.conf&amp;sektion=5&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">rc.conf</span>(5)</span></a>.  Fortunately, <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=rc.subr&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">rc.subr</span>(8)</span></a> hides all
      the complications from us.  The following script uses
      <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=rc.conf&amp;sektion=5&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">rc.conf</span>(5)</span></a> via <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=rc.subr&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">rc.subr</span>(8)</span></a> to see whether it is
      enabled in the first place, and to fetch a message to show
      at boot time.  These two tasks in fact are independent.  On
      the one hand, an <code class="filename">rc.d</code> script can just
      support enabling and disabling its service.  On the other
      hand, a mandatory <code class="filename">rc.d</code> script can have
      configuration variables.  We will do both things in the same
      script though:</p><div class="informalexample"><pre class="programlisting">#!/bin/sh

. /etc/rc.subr

name=dummy
rcvar=dummy_enable<a id="rcng-confdummy-rcvar"></a><span><img src="./imagelib/callouts/1.png" alt="1" border="0" /></span>

start_cmd="${name}_start"
stop_cmd=":"

load_rc_config $name<a id="rcng-confdummy-loadconfig"></a><span><img src="./imagelib/callouts/2.png" alt="2" border="0" /></span>
: ${dummy_enable:=no} <a id="rcng-confdummy-enable"></a><span><img src="./imagelib/callouts/3.png" alt="3" border="0" /></span>
: ${dummy_msg="Nothing started."}<a id="rcng-confdummy-opt"></a><span><img src="./imagelib/callouts/4.png" alt="4" border="0" /></span>

dummy_start()
{
	echo "$dummy_msg"<a id="rcng-confdummy-msg"></a><span><img src="./imagelib/callouts/5.png" alt="5" border="0" /></span>
}

run_rc_command "$1"</pre></div><p>What changed in this example?</p><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#rcng-confdummy-rcvar"><span><img src="./imagelib/callouts/1.png" alt="1" border="0" /></span></a> </p></td><td valign="top" align="left"><p>The variable <code class="envar">rcvar</code> specifies
	  the name of the ON/OFF knob variable.</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#rcng-confdummy-loadconfig"><span><img src="./imagelib/callouts/2.png" alt="2" border="0" /></span></a> </p></td><td valign="top" align="left"><p>Now <code class="function">load_rc_config</code> is invoked
	  earlier in the script, before any <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=rc.conf&amp;sektion=5&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">rc.conf</span>(5)</span></a> variables
	  are accessed.</p><div xmlns="" class="note"><h3 class="admontitle">Note: </h3><p xmlns="http://www.w3.org/1999/xhtml">While examining <code class="filename">rc.d</code> scripts,
	    keep in mind that <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=sh&amp;sektion=1&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">sh</span>(1)</span></a> defers the evaluation of
	    expressions in a function until the latter is called.
	    Therefore it is not an error to invoke
	    <code class="function">load_rc_config</code> as late as just
	    before <code class="function">run_rc_command</code> and still
	    access <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=rc.conf&amp;sektion=5&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">rc.conf</span>(5)</span></a> variables from the method functions
	    exported to <code class="function">run_rc_command</code>.  This
	    is because the method functions are to be called by
	    <code class="function">run_rc_command</code>, which is invoked
	    <span class="emphasis"><em>after</em></span>
	    <code class="function">load_rc_config</code>.</p></div></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#rcng-confdummy-enable"><span><img src="./imagelib/callouts/3.png" alt="3" border="0" /></span></a> </p></td><td valign="top" align="left"><p>A warning will be emitted by
	  <code class="function">run_rc_command</code> if <code class="envar">rcvar</code>
	  itself is set, but the indicated knob variable is unset.
	  If your <code class="filename">rc.d</code> script is for the base
	  system, you should add a default setting for the knob to
	  <code class="filename">/etc/defaults/rc.conf</code> and document
	  it in <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=rc.conf&amp;sektion=5&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">rc.conf</span>(5)</span></a>.  Otherwise it is your script that
	  should provide a default setting for the knob.  The canonical
	  approach to the latter case is shown in the example.</p><div xmlns="" class="note"><h3 class="admontitle">Note: </h3><p xmlns="http://www.w3.org/1999/xhtml">You can make <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=rc.subr&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">rc.subr</span>(8)</span></a> act as though the knob
	    is set to <code class="literal">ON</code>, irrespective of its
	    current setting, by prefixing the argument to the script
	    with <code class="literal">one</code> or <code class="literal">force</code>,
	    as in <code class="option">onestart</code> or <code class="option">forcestop</code>.
	    Keep in mind though that <code class="literal">force</code> has
	    other dangerous effects we will touch upon below, while
	    <code class="literal">one</code> just overrides the ON/OFF knob.
	    E.g., assume that <code class="envar">dummy_enable</code> is
	    <code class="literal">OFF</code>.  The following command will run
	    the <code class="option">start</code> method in spite of the
	    setting:</p><pre xmlns="http://www.w3.org/1999/xhtml" class="screen"><code class="prompt">#</code> <strong class="userinput"><code>/etc/rc.d/dummy onestart</code></strong></pre></div></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#rcng-confdummy-opt"><span><img src="./imagelib/callouts/4.png" alt="4" border="0" /></span></a> </p></td><td valign="top" align="left"><p>Now the message to be shown at boot time is no
	  longer hard-coded in the script.  It is specified by an
	  <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=rc.conf&amp;sektion=5&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">rc.conf</span>(5)</span></a> variable named <code class="envar">dummy_msg</code>.
	  This is a trivial example of how <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=rc.conf&amp;sektion=5&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">rc.conf</span>(5)</span></a> variables
	  can control an <code class="filename">rc.d</code> script.</p><div xmlns="" class="important"><h3 class="admontitle">Important: </h3><p xmlns="http://www.w3.org/1999/xhtml">The names of all <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=rc.conf&amp;sektion=5&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">rc.conf</span>(5)</span></a> variables used
	    exclusively by our script <span class="emphasis"><em>must</em></span>
	    have the same prefix: <code class="envar">${name}_</code>.  For
	    example: <code class="envar">dummy_mode</code>,
	    <code class="envar">dummy_state_file</code>, and so on.</p></div><div xmlns="" class="note"><h3 class="admontitle">Note: </h3><p xmlns="http://www.w3.org/1999/xhtml">While it is possible to use a shorter name internally,
	    e.g., just <code class="envar">msg</code>, adding the unique prefix
	    <code class="envar">${name}_</code> to all global names introduced by
	    our script will save us from possible
	    collisions with the <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=rc.subr&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">rc.subr</span>(8)</span></a> namespace.</p><p xmlns="http://www.w3.org/1999/xhtml">As a rule, <code class="filename">rc.d</code> scripts of the
	    base system need not provide defaults for their
	    <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=rc.conf&amp;sektion=5&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">rc.conf</span>(5)</span></a> variables because the defaults should
	    be set in <code class="filename">/etc/defaults/rc.conf</code>
	    instead.  On the other hand, <code class="filename">rc.d</code>
	    scripts for ports should provide the defaults as shown
	    in the example.</p></div></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#rcng-confdummy-msg"><span><img src="./imagelib/callouts/5.png" alt="5" border="0" /></span></a> </p></td><td valign="top" align="left"><p>Here we use <code class="envar">dummy_msg</code> to actually
	  control our script, i.e., to emit a variable message.
	  Use of a shell function is overkill here, since it only
	  runs a single command; an equally valid alternative is:</p><pre class="programlisting">start_cmd="echo \"$dummy_msg\""</pre></td></tr></table></div></div><div class="sect1"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="rcng-daemon"></a>5. Startup and shutdown of a simple daemon</h2></div></div></div><p>We said earlier that <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=rc.subr&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">rc.subr</span>(8)</span></a> could provide default
      methods.  Obviously, such defaults cannot be too general.
      They are suited for the common case of starting and shutting
      down a simple daemon program.  Let us assume now that we need
      to write an <code class="filename">rc.d</code> script for such a daemon
      called <code class="command">mumbled</code>.  Here it is:</p><div class="informalexample"><pre class="programlisting">#!/bin/sh

. /etc/rc.subr

name=mumbled
rcvar=mumbled_enable

command="/usr/sbin/${name}"<a id="rcng-daemon-basic-cmd"></a><span><img src="./imagelib/callouts/1.png" alt="1" border="0" /></span>

load_rc_config $name
run_rc_command "$1"</pre></div><p>Pleasingly simple, isn't it?  Let us examine our little
      script.  The only new thing to note is as follows:</p><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#rcng-daemon-basic-cmd"><span><img src="./imagelib/callouts/1.png" alt="1" border="0" /></span></a> </p></td><td valign="top" align="left"><p>The <code class="envar">command</code> variable is meaningful to
	  <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=rc.subr&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">rc.subr</span>(8)</span></a>.  If it is set, <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=rc.subr&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">rc.subr</span>(8)</span></a> will act
	  according to the scenario of serving a conventional daemon.
	  In particular, the default methods will be provided for
	  such arguments: <code class="option">start</code>, <code class="option">stop</code>,
	  <code class="option">restart</code>, <code class="option">poll</code>, and
	  <code class="option">status</code>.</p><p>The daemon will be started by running
	  <code class="envar">$command</code> with command-line flags specified
	  by <code class="envar">$mumbled_flags</code>.  Thus all the input
	  data for the default <code class="option">start</code> method are
	  available in the variables set by our script.  Unlike
	  <code class="option">start</code>, other methods may require additional
	  information about the process started.  For instance,
	  <code class="option">stop</code> must know the PID of the process
	  to terminate it.  In the present case, <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=rc.subr&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">rc.subr</span>(8)</span></a>
	  will scan through the list of all processes, looking for
	  a process with its name equal to <code class="envar">$procname</code>.
	  The latter is another variable of meaning to <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=rc.subr&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">rc.subr</span>(8)</span></a>,
	  and its value defaults to that of <code class="envar">command</code>.
	  In other words, when we set <code class="envar">command</code>,
	  <code class="envar">procname</code> is effectively set to the same
	  value.  This enables our script to kill the daemon and
	  to check if it is running in the first place.</p><div xmlns="" class="note"><h3 class="admontitle">Note: </h3><p xmlns="http://www.w3.org/1999/xhtml">Some programs are in fact executable scripts.  The
	    system runs such a script by starting its interpreter
	    and passing the name of the script to it as a command-line
	    argument.  This is reflected in the list of processes,
	    which can confuse <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=rc.subr&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">rc.subr</span>(8)</span></a>.  You should additionally
	    set <code class="envar">command_interpreter</code> to let <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=rc.subr&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">rc.subr</span>(8)</span></a>
	    know the actual name of the process if <code class="envar">$command</code>
	    is a script.</p><p xmlns="http://www.w3.org/1999/xhtml">For each <code class="filename">rc.d</code> script, there
	    is an optional <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=rc.conf&amp;sektion=5&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">rc.conf</span>(5)</span></a> variable that takes
	    precedence over <code class="envar">command</code>.  Its name is
	    constructed as follows: <code class="envar">${name}_program</code>,
	    where <code class="envar">name</code> is the mandatory variable we
	    discussed <a class="link" href="#name-var">earlier</a>.
	    E.g., in this case it will be <code class="envar">mumbled_program</code>.
	    It is <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=rc.subr&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">rc.subr</span>(8)</span></a> that arranges
	    <code class="envar">${name}_program</code> to override
	    <code class="envar">command</code>.</p><p xmlns="http://www.w3.org/1999/xhtml">Of course, <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=sh&amp;sektion=1&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">sh</span>(1)</span></a> will permit you to set
	    <code class="envar">${name}_program</code> from <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=rc.conf&amp;sektion=5&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">rc.conf</span>(5)</span></a> or
	    the script itself even if <code class="envar">command</code> is
	    unset.  In that case, the special properties of
	    <code class="envar">${name}_program</code> are lost, and it becomes
	    an ordinary variable your script can use for its own
	    purposes.  However, the sole use of
	    <code class="envar">${name}_program</code> is discouraged because
	    using it together with <code class="envar">command</code> became
	    an idiom of <code class="filename">rc.d</code> scripting.</p></div><p>For more detailed information on default methods,
	  refer to <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=rc.subr&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">rc.subr</span>(8)</span></a>.</p></td></tr></table></div></div><div class="sect1"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="rcng-daemon-adv"></a>6. Startup and shutdown of an advanced daemon</h2></div></div></div><p>Let us add some meat onto the bones of the previous
      script and make it more complex and featureful.  The default
      methods can do a good job for us, but we may need some of
      their aspects tweaked.  Now we will learn how to tune the
      default methods to our needs.</p><div class="informalexample"><pre class="programlisting">#!/bin/sh

. /etc/rc.subr

name=mumbled
rcvar=mumbled_enable

command="/usr/sbin/${name}"
command_args="mock arguments &gt; /dev/null 2&gt;&amp;1"<a id="rcng-daemon-adv-args"></a><span><img src="./imagelib/callouts/1.png" alt="1" border="0" /></span>

pidfile="/var/run/${name}.pid"<a id="rcng-daemon-adv-pid"></a><span><img src="./imagelib/callouts/2.png" alt="2" border="0" /></span>

required_files="/etc/${name}.conf /usr/share/misc/${name}.rules"<a id="rcng-daemon-adv-reqfiles"></a><span><img src="./imagelib/callouts/3.png" alt="3" border="0" /></span>

sig_reload="USR1"<a id="rcng-daemon-adv-sig"></a><span><img src="./imagelib/callouts/4.png" alt="4" border="0" /></span>

start_precmd="${name}_prestart"<a id="rcng-daemon-adv-precmd"></a><span><img src="./imagelib/callouts/5.png" alt="5" border="0" /></span>
stop_postcmd="echo Bye-bye"<a id="rcng-daemon-adv-postcmd"></a><span><img src="./imagelib/callouts/6.png" alt="6" border="0" /></span>

extra_commands="reload plugh xyzzy"<a id="rcng-daemon-adv-extra"></a><span><img src="./imagelib/callouts/7.png" alt="7" border="0" /></span>

plugh_cmd="mumbled_plugh"<a id="rcng-daemon-adv-methods"></a><span><img src="./imagelib/callouts/8.png" alt="8" border="0" /></span>
xyzzy_cmd="echo 'Nothing happens.'"

mumbled_prestart()
{
	if checkyesno mumbled_smart; then<a id="rcng-daemon-adv-yn"></a><span><img src="./imagelib/callouts/9.png" alt="9" border="0" /></span>
		rc_flags="-o smart ${rc_flags}"<a id="rcng-daemon-adv-rcflags"></a><span><img src="./imagelib/callouts/10.png" alt="10" border="0" /></span>
	fi
	case "$mumbled_mode" in
	foo)
		rc_flags="-frotz ${rc_flags}"
		;;
	bar)
		rc_flags="-baz ${rc_flags}"
		;;
	*)
		warn "Invalid value for mumbled_mode"<a id="rcng-daemon-adv-warn"></a><span><img src="./imagelib/callouts/11.png" alt="11" border="0" /></span>
		return 1<a id="rcng-daemon-adv-preret"></a><span><img src="./imagelib/callouts/12.png" alt="12" border="0" /></span>
		;;
	esac
	run_rc_command xyzzy<a id="rcng-daemon-adv-run"></a><span><img src="./imagelib/callouts/13.png" alt="13" border="0" /></span>
	return 0
}

mumbled_plugh()<a id="rcng-daemon-adv-plugh"></a><span><img src="./imagelib/callouts/14.png" alt="14" border="0" /></span>
{
	echo 'A hollow voice says "plugh".'
}

load_rc_config $name
run_rc_command "$1"</pre></div><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#rcng-daemon-adv-args"><span><img src="./imagelib/callouts/1.png" alt="1" border="0" /></span></a> </p></td><td valign="top" align="left"><p>Additional arguments to <code class="envar">$command</code> can
	  be passed in <code class="envar">command_args</code>.  They will be
	  added to the command line after <code class="envar">$mumbled_flags</code>.
	  Since the final command line is passed to <code class="command">eval</code>
	  for its actual execution, input and output redirections
	  can be specified in <code class="envar">command_args</code>.</p><div xmlns="" class="note"><h3 class="admontitle">Note: </h3><p xmlns="http://www.w3.org/1999/xhtml"><span class="emphasis"><em>Never</em></span> include dashed options,
	    like <code class="option">-X</code> or <code class="option">--foo</code>, in
	    <code class="envar">command_args</code>.
	    The contents of <code class="envar">command_args</code> will
	    appear at the end of the final command line, hence
	    they are likely to follow arguments present in
	    <code class="envar">${name}_flags</code>; but most commands will
	    not recognize dashed options after ordinary arguments.
	    A better way of passing additional options
	    to <code class="envar">$command</code> is to add them
	    to the beginning of <code class="envar">${name}_flags</code>.
	    Another way is to modify <code class="envar">rc_flags</code> <a class="link" href="#rc-flags">as shown later</a>.</p></div></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#rcng-daemon-adv-pid"><span><img src="./imagelib/callouts/2.png" alt="2" border="0" /></span></a> </p></td><td valign="top" align="left"><p>A good-mannered daemon should create a
	  <span class="emphasis"><em>pidfile</em></span> so that its process can be
	  found more easily and reliably.  The variable
	  <code class="envar">pidfile</code>, if set, tells <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=rc.subr&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">rc.subr</span>(8)</span></a>
	  where it can find the pidfile for its default methods to
	  use.</p><div xmlns="" class="note"><h3 class="admontitle">Note: </h3><p xmlns="http://www.w3.org/1999/xhtml">In fact, <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=rc.subr&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">rc.subr</span>(8)</span></a> will also use the pidfile
	    to see if the daemon is already running before starting
	    it.  This check can be skipped by using the
	    <code class="option">faststart</code> argument.</p></div></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#rcng-daemon-adv-reqfiles"><span><img src="./imagelib/callouts/3.png" alt="3" border="0" /></span></a> </p></td><td valign="top" align="left"><p>If the daemon cannot run unless certain files exist,
	  just list them in <code class="envar">required_files</code>, and
	  <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=rc.subr&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">rc.subr</span>(8)</span></a> will check that those files do exist
	  before starting the daemon.  There also are
	  <code class="envar">required_dirs</code> and <code class="envar">required_vars</code>
	  for directories and environment variables, respectively.
	  They all are described in detail in <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=rc.subr&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">rc.subr</span>(8)</span></a>.</p><div xmlns="" class="note"><h3 class="admontitle">Note: </h3><p xmlns="http://www.w3.org/1999/xhtml">The default method from <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=rc.subr&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">rc.subr</span>(8)</span></a> can be
	    forced to skip the prerequisite checks by using
	    <code class="option">forcestart</code> as the argument to the
	    script.</p></div></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#rcng-daemon-adv-sig"><span><img src="./imagelib/callouts/4.png" alt="4" border="0" /></span></a> </p></td><td valign="top" align="left"><p>We can customize signals to send to the daemon in
	  case they differ from the well-known ones.  In particular,
	  <code class="envar">sig_reload</code> specifies the signal that makes
	  the daemon reload its configuration; it is
	  <span class="symbol">SIGHUP</span> by default.  Another signal is
	  sent to stop the daemon process; the default is
	  <span class="symbol">SIGTERM</span>, but this can be changed by
	  setting <code class="envar">sig_stop</code> appropriately.</p><div xmlns="" class="note"><h3 class="admontitle">Note: </h3><p xmlns="http://www.w3.org/1999/xhtml">The signal names should be specified to <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=rc.subr&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">rc.subr</span>(8)</span></a>
	    without the <code class="literal">SIG</code> prefix, as it is
	    shown in the example.  The FreeBSD version of <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=kill&amp;sektion=1&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">kill</span>(1)</span></a>
	    can recognize the <code class="literal">SIG</code> prefix, but
	    the versions from other OS types may not.</p></div></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#rcng-daemon-adv-precmd"><span><img src="./imagelib/callouts/5.png" alt="5" border="0" /></span></a> <a href="#rcng-daemon-adv-postcmd"><span><img src="./imagelib/callouts/6.png" alt="6" border="0" /></span></a> </p></td><td valign="top" align="left"><p>Performing additional tasks before or after the default
	  methods is easy.  For each command-argument supported by
	  our script, we can define
	  <code class="envar"><em class="replaceable"><code>argument</code></em>_precmd</code> and
	  <code class="envar"><em class="replaceable"><code>argument</code></em>_postcmd</code>.
	  These <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=sh&amp;sektion=1&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">sh</span>(1)</span></a> commands are invoked before and after
	  the respective method, as it is evident from their
	  names.</p><div xmlns="" class="note"><h3 class="admontitle">Note: </h3><p xmlns="http://www.w3.org/1999/xhtml">Overriding a default method with a custom
	    <code class="envar"><em class="replaceable"><code>argument</code></em>_cmd</code>
	    still does not prevent us from making use of
	    <code class="envar"><em class="replaceable"><code>argument</code></em>_precmd</code> or
	    <code class="envar"><em class="replaceable"><code>argument</code></em>_postcmd</code>
	    if we need to.  In particular, the former is good for
	    checking custom, sophisticated conditions that should
	    be met before performing the command itself.  Using
	    <code class="envar"><em class="replaceable"><code>argument</code></em>_precmd</code> along
	    with <code class="envar"><em class="replaceable"><code>argument</code></em>_cmd</code>
	    lets us logically separate the checks from the
	    action.</p><p xmlns="http://www.w3.org/1999/xhtml">Do not forget that you can cram any valid <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=sh&amp;sektion=1&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">sh</span>(1)</span></a>
	    expressions into the methods, pre-, and post-commands
	    you define.  Just invoking a function that makes the
	    real job is a good style in most cases, but never let
	    style limit your understanding of what is going on
	    behind the curtain.</p></div></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#rcng-daemon-adv-extra"><span><img src="./imagelib/callouts/7.png" alt="7" border="0" /></span></a> </p></td><td valign="top" align="left"><p>If we would like to implement custom arguments, which
	  can also be thought of as <span class="emphasis"><em>commands</em></span>
	  to our script, we need to list them in
	  <code class="envar">extra_commands</code> and provide methods to
	  handle them.</p><div xmlns="" class="note"><h3 class="admontitle">Note: </h3><p xmlns="http://www.w3.org/1999/xhtml">The <code class="option">reload</code> command is special.  On
	    the one hand, it has a preset method in <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=rc.subr&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">rc.subr</span>(8)</span></a>.
	    On the other hand, <code class="option">reload</code> is not offered
	    by default.  The reason is that not all daemons use the
	    same reload mechanism and some have nothing to reload
	    at all.  So we need to ask explicitly that the builtin
	    functionality be provided.  We can do so via
	    <code class="envar">extra_commands</code>.</p><p xmlns="http://www.w3.org/1999/xhtml">What do we get from the default method for
	    <code class="option">reload</code>?  Quite often daemons reload
	    their configuration upon reception of a signal &#8212;
	    typically, <span class="symbol">SIGHUP</span>.  Therefore
	    <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=rc.subr&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">rc.subr</span>(8)</span></a> attempts to reload the daemon by sending
	    a signal to it.  The signal is preset to
	    <span class="symbol">SIGHUP</span> but can be customized via
	    <code class="envar">sig_reload</code> if necessary.</p></div></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#rcng-daemon-adv-methods"><span><img src="./imagelib/callouts/8.png" alt="8" border="0" /></span></a> <a href="#rcng-daemon-adv-plugh"><span><img src="./imagelib/callouts/14.png" alt="14" border="0" /></span></a> </p></td><td valign="top" align="left"><p>Our script supports two non-standard commands,
	  <code class="option">plugh</code> and <code class="option">xyzzy</code>.  We
	  saw them listed in <code class="envar">extra_commands</code>, and now
	  it is time to provide methods for them.  The method for
	  <code class="option">xyzzy</code> is just inlined while that for
	  <code class="option">plugh</code> is implemented as the
	  <code class="function">mumbled_plugh</code> function.</p><p>Non-standard commands are not invoked during startup
	  or shutdown.  Usually they are for the system admin's
	  convenience.  They can also be used from other subsystems,
	  e.g., <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=devd&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">devd</span>(8)</span></a> if specified in <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=devd.conf&amp;sektion=5&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">devd.conf</span>(5)</span></a>.</p><p>The full list of available commands can be found in
	  the usage line printed by <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=rc.subr&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">rc.subr</span>(8)</span></a> when the script
	  is invoked without arguments.  For example, here is the
	  usage line from the script under study:</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>/etc/rc.d/mumbled</code></strong>
Usage: /etc/rc.d/mumbled [fast|force|one](start|stop|restart|rcvar|reload|plugh|xyzzy|status|poll)</pre></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#rcng-daemon-adv-run"><span><img src="./imagelib/callouts/13.png" alt="13" border="0" /></span></a> </p></td><td valign="top" align="left"><p>A script can invoke its own standard or non-standard
	  commands if needed.  This may look similar to calling
	  functions, but we know that commands and shell functions
	  are not always the same thing.  For instance,
	  <code class="command">xyzzy</code> is not implemented as a function
	  here.  In addition, there can be a pre-command and
	  post-command, which should be invoked orderly.  So the
	  proper way for a script to run its own command is by means
	  of <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=rc.subr&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">rc.subr</span>(8)</span></a>, as shown in the example.</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#rcng-daemon-adv-yn"><span><img src="./imagelib/callouts/9.png" alt="9" border="0" /></span></a> </p></td><td valign="top" align="left"><p>A handy function named <code class="function">checkyesno</code>
	  is provided by <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=rc.subr&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">rc.subr</span>(8)</span></a>.  It takes a variable name
	  as its argument and returns a zero exit code if and only
	  if the variable is set to <code class="literal">YES</code>, or
	  <code class="literal">TRUE</code>, or <code class="literal">ON</code>, or
	  <code class="literal">1</code>, case insensitive; a non-zero exit
	  code is returned otherwise.  In the latter case, the
	  function tests the variable for being set to
	  <code class="literal">NO</code>, <code class="literal">FALSE</code>,
	  <code class="literal">OFF</code>, or <code class="literal">0</code>, case
	  insensitive; it prints a warning message if the variable
	  contains anything else, i.e., junk.</p><p>Keep in mind that for <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=sh&amp;sektion=1&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">sh</span>(1)</span></a> a zero exit code
	  means true and a non-zero exit code means false.</p><div xmlns="" class="important"><h3 class="admontitle">Important: </h3><p xmlns="http://www.w3.org/1999/xhtml">The <code class="function">checkyesno</code> function takes
	    a <span class="emphasis"><em>variable name</em></span>.  Do not pass the
	    expanded <span class="emphasis"><em>value</em></span> of a variable to
	    it; it will not work as expected.</p><p xmlns="http://www.w3.org/1999/xhtml">The following is the correct usage of
	    <code class="function">checkyesno</code>:</p><pre xmlns="http://www.w3.org/1999/xhtml" class="programlisting">if checkyesno mumbled_enable; then
        foo
fi</pre><p xmlns="http://www.w3.org/1999/xhtml">On the contrary, calling <code class="function">checkyesno</code>
	    as shown below will not work &#8212; at least not as
	    expected:</p><pre xmlns="http://www.w3.org/1999/xhtml" class="programlisting">if checkyesno "${mumbled_enable}"; then
        foo
fi</pre></div></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#rcng-daemon-adv-rcflags"><span><img src="./imagelib/callouts/10.png" alt="10" border="0" /></span></a> </p></td><td valign="top" align="left"><p><a id="rc-flags"></a>We can affect the flags to be
	  passed to <code class="envar">$command</code> by modifying
	  <code class="envar">rc_flags</code> in <code class="envar">$start_precmd</code>.</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#rcng-daemon-adv-warn"><span><img src="./imagelib/callouts/11.png" alt="11" border="0" /></span></a> </p></td><td valign="top" align="left"><p>In certain cases we may need to emit an important
	  message that should go to <span class="application">syslog</span>
	  as well.  This can be done easily with the following
	  <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=rc.subr&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">rc.subr</span>(8)</span></a> functions: <code class="function">debug</code>,
	  <code class="function">info</code>, <code class="function">warn</code>, and
	  <code class="function">err</code>.  The latter function then exits
	  the script with the code specified.</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#rcng-daemon-adv-preret"><span><img src="./imagelib/callouts/12.png" alt="12" border="0" /></span></a> </p></td><td valign="top" align="left"><p>The exit codes from methods and their pre-commands
	  are not just ignored by default.  If
	  <code class="envar"><em class="replaceable"><code>argument</code></em>_precmd</code> returns
	  a non-zero exit code, the main method will not be performed.
	  In turn,
	  <code class="envar"><em class="replaceable"><code>argument</code></em>_postcmd</code> will
	  not be invoked unless the main method returns a zero exit
	  code.</p><div xmlns="" class="note"><h3 class="admontitle">Note: </h3><p xmlns="http://www.w3.org/1999/xhtml">However, <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=rc.subr&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">rc.subr</span>(8)</span></a> can be instructed from the
	    command line to ignore those exit codes and invoke all
	    commands anyway by prefixing an argument with
	    <code class="literal">force</code>, as in
	    <code class="option">forcestart</code>.</p></div></td></tr></table></div></div><div class="sect1"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="rcng-hookup"></a>7. Connecting a script to the rc.d framework</h2></div></div></div><p>After a script has been written, it needs to be integrated
      into <code class="filename">rc.d</code>.  The crucial step is to install
      the script in <code class="filename">/etc/rc.d</code> (for the base
      system) or <code class="filename">/usr/local/etc/rc.d</code> (for
      ports).  Both &lt;<code class="filename">bsd.prog.mk</code>&gt; and
      &lt;<code class="filename">bsd.port.mk</code>&gt; provide convenient
      hooks for that, and usually you do not have to worry about
      the proper ownership and mode.  System scripts should be
      installed from <code class="filename">src/etc/rc.d</code> through the
      <code class="filename">Makefile</code> found there.  Port scripts can
      be installed using <code class="varname">USE_RC_SUBR</code> as described
      <a class="link" href="../../../../doc/en_US.ISO8859-1/books/porters-handbook/rc-scripts.html" target="_top">in
      the Porter's Handbook</a>.</p><p>However, we should consider beforehand the place of
      our script in the system startup sequence.  The service handled
      by our script is likely to depend on other services.  For
      instance, a network daemon cannot function without the network
      interfaces and routing up and running.  Even if a service
      seems to demand nothing, it can hardly start before the basic
      filesystems have been checked and mounted.</p><p>We mentioned <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=rcorder&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">rcorder</span>(8)</span></a> already.  Now it is time to
      have a close look at it.  In a nutshell, <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=rcorder&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">rcorder</span>(8)</span></a> takes
      a set of files, examines their contents, and prints a
      dependency-ordered list of files from the set to
      <code class="varname">stdout</code>.  The point is to keep dependency
      information <span class="emphasis"><em>inside</em></span> the files so that
      each file can speak for itself only.  A file can specify the
      following information:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>the names of the <span class="quote">&#8220;<span class="quote">conditions</span>&#8221;</span> (which means
	  services to us) it <span class="emphasis"><em>provides</em></span>;</p></li><li class="listitem"><p>the names of the <span class="quote">&#8220;<span class="quote">conditions</span>&#8221;</span>
	  it <span class="emphasis"><em>requires</em></span>;</p></li><li class="listitem"><p>the names of the <span class="quote">&#8220;<span class="quote">conditions</span>&#8221;</span> this file
	  should run <span class="emphasis"><em>before</em></span>;</p></li><li class="listitem"><p>additional <span class="emphasis"><em>keywords</em></span> that can be
	  used to select a subset from the whole set of files
	  (<a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=rcorder&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">rcorder</span>(8)</span></a> can be instructed via options to include
	  or omit the files having particular keywords listed.)</p></li></ul></div><p>It is no surprise that <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=rcorder&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">rcorder</span>(8)</span></a> can handle only
      text files with a syntax close to that of <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=sh&amp;sektion=1&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">sh</span>(1)</span></a>.  That
      is, special lines understood by <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=rcorder&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">rcorder</span>(8)</span></a> look like
      <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=sh&amp;sektion=1&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">sh</span>(1)</span></a> comments.  The syntax of such special lines is
      rather rigid to simplify their processing.  See <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=rcorder&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">rcorder</span>(8)</span></a>
      for details.</p><p>Besides using <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=rcorder&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">rcorder</span>(8)</span></a> special lines, a script can
      insist on its dependency upon another service by just starting
      it forcibly.  This can be needed when the other service is
      optional and will not start by itself because the system admin
      has disabled it mistakenly in <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=rc.conf&amp;sektion=5&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">rc.conf</span>(5)</span></a>.</p><p>With this general knowledge in mind, let us consider the
      simple daemon script enhanced with dependency stuff:</p><div class="informalexample"><pre class="programlisting">#!/bin/sh

# PROVIDE: mumbled oldmumble <a id="rcng-hookup-provide"></a><span><img src="./imagelib/callouts/1.png" alt="1" border="0" /></span>
# REQUIRE: DAEMON cleanvar frotz<a id="rcng-hookup-require"></a><span><img src="./imagelib/callouts/2.png" alt="2" border="0" /></span>
# BEFORE:  LOGIN<a id="rcng-hookup-before"></a><span><img src="./imagelib/callouts/3.png" alt="3" border="0" /></span>
# KEYWORD: nojail shutdown<a id="rcng-hookup-keyword"></a><span><img src="./imagelib/callouts/4.png" alt="4" border="0" /></span>

. /etc/rc.subr

name=mumbled
rcvar=mumbled_enable

command="/usr/sbin/${name}"
start_precmd="${name}_prestart"

mumbled_prestart()
{
	if ! checkyesno frotz_enable &amp;&amp; \
	    ! /etc/rc.d/frotz forcestatus 1&gt;/dev/null 2&gt;&amp;1; then
		force_depend frotz || return 1<a id="rcng-hookup-force"></a><span><img src="./imagelib/callouts/5.png" alt="5" border="0" /></span>
	fi
	return 0
}

load_rc_config $name
run_rc_command "$1"</pre></div><p>As before, detailed analysis follows:</p><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#rcng-hookup-provide"><span><img src="./imagelib/callouts/1.png" alt="1" border="0" /></span></a> </p></td><td valign="top" align="left"><p>That line declares the names of <span class="quote">&#8220;<span class="quote">conditions</span>&#8221;</span>
	  our script provides.  Now other scripts can record a
	  dependency on our script by those names.</p><div xmlns="" class="note"><h3 class="admontitle">Note: </h3><p xmlns="http://www.w3.org/1999/xhtml">Usually a script specifies a single condition
	    provided.  However, nothing prevents us from listing
	    several conditions there, e.g., for compatibility
	    reasons.</p><p xmlns="http://www.w3.org/1999/xhtml">In any case, the name of the main, or the only,
	    <code class="literal">PROVIDE:</code> condition should be the
	    same as <code class="envar">${name}</code>.</p></div></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#rcng-hookup-require"><span><img src="./imagelib/callouts/2.png" alt="2" border="0" /></span></a> <a href="#rcng-hookup-before"><span><img src="./imagelib/callouts/3.png" alt="3" border="0" /></span></a> </p></td><td valign="top" align="left"><p>So our script indicates which <span class="quote">&#8220;<span class="quote">conditions</span>&#8221;</span>
	  provided by other scripts it depends on.  According to
	  the lines, our script asks <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=rcorder&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">rcorder</span>(8)</span></a> to put it after
	  the script(s) providing <code class="filename">DAEMON</code> and
	  <code class="filename">cleanvar</code>, but before that providing
	  <code class="filename">LOGIN</code>.</p><div xmlns="" class="note"><h3 class="admontitle">Note: </h3><p xmlns="http://www.w3.org/1999/xhtml">The <code class="literal">BEFORE:</code> line should not be
	    abused to work around an incomplete dependency list in
	    the other script.  The appropriate case for using
	    <code class="literal">BEFORE:</code> is when the other script
	    does not care about ours, but our script can do its
	    task better if run before the other one.  A typical
	    real-life example is the network interfaces vs. the
	    firewall: While the interfaces do not depend on the
	    firewall in doing their job, the system security will
	    benefit from the firewall being ready before there is
	    any network traffic.</p><p xmlns="http://www.w3.org/1999/xhtml">Besides conditions corresponding to a single service
	    each, there are meta-conditions and their
	    <span class="quote">&#8220;<span class="quote">placeholder</span>&#8221;</span> scripts used to ensure that
	    certain groups of operations are performed before others.
	    These are denoted by
	    <code class="filename"><em class="replaceable"><code>UPPERCASE</code></em></code>
	    names.  Their list and purposes can be found in
	    <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=rc&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">rc</span>(8)</span></a>.</p><p xmlns="http://www.w3.org/1999/xhtml">Keep in mind that putting a service name in the
	    <code class="literal">REQUIRE:</code> line does not guarantee
	    that the service will actually be running by the time
	    our script starts.  The required service may fail to
	    start or just be disabled in <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=rc.conf&amp;sektion=5&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">rc.conf</span>(5)</span></a>.  Obviously,
	    <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=rcorder&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">rcorder</span>(8)</span></a> cannot track such details, and <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=rc&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">rc</span>(8)</span></a>
	    will not do that either.  Consequently, the application
	    started by our script should be able to cope with any
	    required services being unavailable.  In certain cases,
	    we can help it as discussed <a class="link" href="#forcedep">below.</a></p></div></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#rcng-hookup-keyword"><span><img src="./imagelib/callouts/4.png" alt="4" border="0" /></span></a> </p></td><td valign="top" align="left"><p><a id="keywords"></a>As we remember from the above text,
	  <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=rcorder&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">rcorder</span>(8)</span></a> keywords can be used to select or leave
	  out some scripts.  Namely any <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=rcorder&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">rcorder</span>(8)</span></a> consumer
	  can specify through <code class="option">-k</code> and <code class="option">-s</code>
	  options which keywords are on the <span class="quote">&#8220;<span class="quote">keep list</span>&#8221;</span> and
	  <span class="quote">&#8220;<span class="quote">skip list</span>&#8221;</span>, respectively.  From all the
	  files to be dependency sorted, <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=rcorder&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">rcorder</span>(8)</span></a> will pick
	  only those having a keyword from the keep list (unless empty)
	  and not having a keyword from the skip list.</p><p>In FreeBSD, <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=rcorder&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">rcorder</span>(8)</span></a> is used by
	  <code class="filename">/etc/rc</code> and
	  <code class="filename">/etc/rc.shutdown</code>.  These two scripts
	  define the standard list of FreeBSD <code class="filename">rc.d</code>
	  keywords and their meanings as follows:</p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">nojail</code></span></dt><dd><p>The service is not for <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=jail&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">jail</span>(8)</span></a> environment.
		The automatic startup and shutdown procedures will
		ignore the script if inside a jail.</p></dd><dt><span class="term"><code class="literal">nostart</code></span></dt><dd><p>The service is to be started manually or not
		started at all.  The automatic startup procedure
		will ignore the script.  In conjunction with the
		<code class="literal">shutdown</code> keyword, this can be
		used to write scripts that do something only at
		system shutdown.</p></dd><dt><span class="term"><code class="literal">shutdown</code></span></dt><dd><p>This keyword is to be listed
		<span class="emphasis"><em>explicitly</em></span> if the service needs
		to be stopped before system shutdown.</p><div xmlns="" class="note"><h3 class="admontitle">Note: </h3><p xmlns="http://www.w3.org/1999/xhtml">When the system is going to shut down,
		  <code class="filename">/etc/rc.shutdown</code> runs.  It
		  assumes that most <code class="filename">rc.d</code> scripts
		  have nothing to do at that time.  Therefore
		  <code class="filename">/etc/rc.shutdown</code>
		  selectively invokes <code class="filename">rc.d</code>
		  scripts with the <code class="literal">shutdown</code>
		  keyword, effectively ignoring the
		  rest of the scripts.  For even faster shutdown,
		  <code class="filename">/etc/rc.shutdown</code> passes
		  the <code class="option">faststop</code> command to the scripts
		  it runs so that they skip preliminary checks, e.g.,
		  the pidfile check.  As dependent services should be
		  stopped before their prerequisites,
		  <code class="filename">/etc/rc.shutdown</code> runs the scripts
		  in reverse dependency order.</p><p xmlns="http://www.w3.org/1999/xhtml">If writing a real
		  <code class="filename">rc.d</code> script, you should
		  consider whether it is relevant at system shutdown
		  time.  E.g., if your script does its work in
		  response to the <code class="option">start</code> command
		  only, then you need not include this keyword.
		  However, if your script manages a service, it is
		  probably a good idea to stop it before the system
		  proceeds to the final stage of its shutdown
		  sequence described in <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=halt&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">halt</span>(8)</span></a>.  In particular,
		  a service should be stopped explicitly if it needs
		  considerable time or special actions to shut down
		  cleanly.  A typical example of such a service is
		  a database engine.</p></div></dd></dl></div></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#rcng-hookup-force"><span><img src="./imagelib/callouts/5.png" alt="5" border="0" /></span></a> </p></td><td valign="top" align="left"><p><a id="forcedep"></a>To begin with,
	  <code class="function">force_depend</code> should be used with
	  much care.  It is generally better to revise the hierarchy
	  of configuration variables for your <code class="filename">rc.d</code>
	  scripts if they are interdependent.</p><p>If you still cannot do without
	  <code class="function">force_depend</code>, the example offers an
	  idiom of how to invoke it conditionally.  In the example,
	  our <code class="command">mumbled</code> daemon requires that another
	  one, <code class="command">frotz</code>, be started in advance.
	  However, <code class="command">frotz</code> is optional, too; and
	  <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=rcorder&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">rcorder</span>(8)</span></a> knows nothing about such details.
	  Fortunately, our script has access to all <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=rc.conf&amp;sektion=5&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">rc.conf</span>(5)</span></a>
	  variables.  If <code class="envar">frotz_enable</code> is true, we
	  hope for the best and rely on <code class="filename">rc.d</code>
	  to have started <code class="command">frotz</code>.  Otherwise we
	  forcibly check the status of <code class="command">frotz</code>.
	  Finally, we enforce our dependency on <code class="command">frotz</code>
	  if it is found to be not running.  A warning message will
	  be emitted by <code class="function">force_depend</code> because
	  it should be invoked only if a misconfiguration has been
	  detected.</p></td></tr></table></div></div><div class="sect1"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="rcng-args"></a>8. Giving more flexibility to an rc.d script</h2></div></div></div><p>When invoked during startup or shutdown, an
      <code class="filename">rc.d</code> script is supposed to act on the
      entire subsystem it is responsible for.  E.g.,
      <code class="filename">/etc/rc.d/netif</code> should start or stop all
      network interfaces described by <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=rc.conf&amp;sektion=5&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">rc.conf</span>(5)</span></a>.  Either task
      can be uniquely indicated by a single command argument such
      as <code class="option">start</code> or <code class="option">stop</code>.  Between
      startup and shutdown, <code class="filename">rc.d</code> scripts help
      the admin to control the running system, and it is when the
      need for more flexibility and precision arises.  For instance,
      the admin may want to add the settings of a new network
      interface to <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=rc.conf&amp;sektion=5&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">rc.conf</span>(5)</span></a> and then to start it without
      interfering with the operation of the existing interfaces.
      Next time the admin may need to shut down a single network
      interface.  In the spirit of the command line, the respective
      <code class="filename">rc.d</code> script calls for an extra argument,
      the interface name.</p><p>Fortunately, <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=rc.subr&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">rc.subr</span>(8)</span></a> allows for passing any number
      of arguments to script's methods (within the system limits).
      Due to that, the changes in the script itself can be minimal.</p><p>How can <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=rc.subr&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">rc.subr</span>(8)</span></a> gain
      access to the extra command-line arguments.  Should it just
      grab them directly?  Not by any means.  Firstly, an <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=sh&amp;sektion=1&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">sh</span>(1)</span></a>
      function has no access to the positional parameters of
      its caller, but <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=rc.subr&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">rc.subr</span>(8)</span></a> is just a sack of such
      functions.  Secondly, the good manner of
      <code class="filename">rc.d</code> dictates that it is for the
      main script to decide which arguments are to be passed
      to its methods.</p><p>So the approach adopted by <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=rc.subr&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">rc.subr</span>(8)</span></a> is as follows:
      <code class="function">run_rc_command</code> passes on all its
      arguments but the first one to the respective method verbatim.
      The first, omitted, argument is the name of the method itself:
      <code class="option">start</code>, <code class="option">stop</code>, etc.  It will
      be shifted out by <code class="function">run_rc_command</code>,
      so what is <code class="envar">$2</code> in the original command line will
      be presented as <code class="envar">$1</code> to the method, and so on.</p><p>To illustrate this opportunity, let us modify the primitive
      dummy script so that its messages depend on the additional
      arguments supplied.  Here we go:</p><div class="informalexample"><pre class="programlisting">#!/bin/sh

. /etc/rc.subr

name="dummy"
start_cmd="${name}_start"
stop_cmd=":"
kiss_cmd="${name}_kiss"
extra_commands="kiss"

dummy_start()
{
        if [ $# -gt 0 ]; then<a id="rcng-args-start"></a><span><img src="./imagelib/callouts/1.png" alt="1" border="0" /></span>
                echo "Greeting message: $*"
        else
                echo "Nothing started."
        fi
}

dummy_kiss()
{
        echo -n "A ghost gives you a kiss"
        if [ $# -gt 0 ]; then<a id="rcng-args-kiss"></a><span><img src="./imagelib/callouts/2.png" alt="2" border="0" /></span>
                echo -n " and whispers: $*"
        fi
        case "$*" in
        *[.!?])
                echo
                ;;
        *)
                echo .
                ;;
        esac
}

load_rc_config $name
run_rc_command "$@"<a id="rcng-args-all"></a><span><img src="./imagelib/callouts/3.png" alt="3" border="0" /></span></pre></div><p>What essential changes can we notice in the script?</p><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#rcng-args-start"><span><img src="./imagelib/callouts/1.png" alt="1" border="0" /></span></a> </p></td><td valign="top" align="left"><p>All arguments you type after <code class="option">start</code>
	  can end up as positional parameters to the respective
	  method.  We can use them in any way according to our
	  task, skills, and fancy.  In the current example, we just
	  pass all of them to <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=echo&amp;sektion=1&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">echo</span>(1)</span></a> as one string in the
	  next line &#8212; note <code class="envar">$*</code> within the double
	  quotes.  Here is how the script can be invoked now:</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>/etc/rc.d/dummy start</code></strong>
Nothing started.
<code class="prompt">#</code> <strong class="userinput"><code>/etc/rc.d/dummy start Hello world!</code></strong>
Greeting message: Hello world!</pre></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#rcng-args-kiss"><span><img src="./imagelib/callouts/2.png" alt="2" border="0" /></span></a> </p></td><td valign="top" align="left"><p>The same applies to any method our script provides,
	  not only to a standard one.  We have added a custom method
	  named <code class="option">kiss</code>, and it can take advantage of
	  the extra arguments not less than <code class="option">start</code>
	  does.  E.g.:</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>/etc/rc.d/dummy kiss</code></strong>
A ghost gives you a kiss.
<code class="prompt">#</code> <strong class="userinput"><code>/etc/rc.d/dummy kiss Once I was Etaoin Shrdlu...</code></strong>
A ghost gives you a kiss and whispers: Once I was Etaoin Shrdlu...</pre></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#rcng-args-all"><span><img src="./imagelib/callouts/3.png" alt="3" border="0" /></span></a> </p></td><td valign="top" align="left"><p>If we want just to pass all extra arguments to
	  any method, we can merely substitute <code class="literal">"$@"</code>
	  for <code class="literal">"$1"</code> in the last line of our script,
	  where we invoke <code class="function">run_rc_command</code>.</p><div xmlns="" class="important"><h3 class="admontitle">Important: </h3><p xmlns="http://www.w3.org/1999/xhtml">An <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=sh&amp;sektion=1&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">sh</span>(1)</span></a> programmer ought to understand the
	    subtle difference between <code class="envar">$*</code> and
	    <code class="envar">$@</code> as the ways to designate all positional
	    parameters.  For its in-depth discussion, refer to a
	    good handbook on <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=sh&amp;sektion=1&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">sh</span>(1)</span></a> scripting.  <span class="emphasis"><em>Do
	    not</em></span> use the expressions until you fully
	    understand them because their misuse will result in
	    buggy and insecure scripts.</p></div><div xmlns="" class="note"><h3 class="admontitle">Note: </h3><p xmlns="http://www.w3.org/1999/xhtml">Currently <code class="function">run_rc_command</code> may
	    have a bug that prevents it from keeping the original
	    boundaries between arguments.  That is, arguments with
	    embedded whitespace may not be processed correctly.
	    The bug stems from <code class="envar">$*</code> misuse.</p></div></td></tr></table></div></div><div class="sect1"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="rcng-furthur"></a>9. Further reading</h2></div></div></div><p><a id="lukem"></a><a class="link" href="http://www.mewburn.net/luke/papers/rc.d.pdf" target="_top">The original
      article by Luke Mewburn</a> offers a general overview of
      <code class="filename">rc.d</code> and detailed rationale for its
      design decisions.  It provides insight on the whole
      <code class="filename">rc.d</code> framework and its place in a modern
      BSD operating system.</p><p><a id="manpages"></a>The manual pages <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=rc&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">rc</span>(8)</span></a>,
      <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=rc.subr&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">rc.subr</span>(8)</span></a>, and <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=rcorder&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">rcorder</span>(8)</span></a> document the
      <code class="filename">rc.d</code> components in great detail.  You
      cannot fully use the <code class="filename">rc.d</code> power without
      studying the manual pages and referring to them while writing
      your own scripts.</p><p>The major source of working, real-life examples is
      <code class="filename">/etc/rc.d</code> in a live system.  Its contents
      are easy and pleasant to read because most rough corners are
      hidden deep in <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=rc.subr&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">rc.subr</span>(8)</span></a>.  Keep in mind though that the
      <code class="filename">/etc/rc.d</code> scripts were not written by
      angels, so they might suffer from bugs and suboptimal design
      decisions.  Now you can improve them!</p></div></div></body></html>