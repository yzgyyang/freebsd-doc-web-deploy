<?xml version="1.0" encoding="iso-8859-1" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" /><title>6. Startup and shutdown of an advanced daemon</title><link rel="stylesheet" type="text/css" href="docbook.css" /><link rev="made" href="mailto:doc@FreeBSD.org" /><meta name="generator" content="DocBook XSL Stylesheets V1.79.1" /><link rel="home" href="index.html" title="Practical rc.d scripting in BSD" /><link rel="up" href="index.html" title="Practical rc.d scripting in BSD" /><link rel="prev" href="rcng-daemon.html" title="5. Startup and shutdown of a simple daemon" /><link rel="next" href="rcng-hookup.html" title="7. Connecting a script to the rc.d framework" /><link rel="copyright" href="trademarks.html" title="Legal Notice" /><script xmlns="" type="text/javascript" src="/layout/js/google.js"></script></head><body><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">6. Startup and shutdown of an advanced daemon</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="rcng-daemon.html">Prev</a> </td><th width="60%" align="center"> </th><td width="20%" align="right"> <a accesskey="n" href="rcng-hookup.html">Next</a></td></tr></table><hr /></div><div class="sect1"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="rcng-daemon-adv"></a>6. Startup and shutdown of an advanced daemon</h2></div></div></div><p>Let us add some meat onto the bones of the previous
      script and make it more complex and featureful.  The default
      methods can do a good job for us, but we may need some of
      their aspects tweaked.  Now we will learn how to tune the
      default methods to our needs.</p><div class="informalexample"><pre class="programlisting">#!/bin/sh

. /etc/rc.subr

name=mumbled
rcvar=mumbled_enable

command="/usr/sbin/${name}"
command_args="mock arguments &gt; /dev/null 2&gt;&amp;1"<a id="rcng-daemon-adv-args"></a><span><img src="./imagelib/callouts/1.png" alt="1" border="0" /></span>

pidfile="/var/run/${name}.pid"<a id="rcng-daemon-adv-pid"></a><span><img src="./imagelib/callouts/2.png" alt="2" border="0" /></span>

required_files="/etc/${name}.conf /usr/share/misc/${name}.rules"<a id="rcng-daemon-adv-reqfiles"></a><span><img src="./imagelib/callouts/3.png" alt="3" border="0" /></span>

sig_reload="USR1"<a id="rcng-daemon-adv-sig"></a><span><img src="./imagelib/callouts/4.png" alt="4" border="0" /></span>

start_precmd="${name}_prestart"<a id="rcng-daemon-adv-precmd"></a><span><img src="./imagelib/callouts/5.png" alt="5" border="0" /></span>
stop_postcmd="echo Bye-bye"<a id="rcng-daemon-adv-postcmd"></a><span><img src="./imagelib/callouts/6.png" alt="6" border="0" /></span>

extra_commands="reload plugh xyzzy"<a id="rcng-daemon-adv-extra"></a><span><img src="./imagelib/callouts/7.png" alt="7" border="0" /></span>

plugh_cmd="mumbled_plugh"<a id="rcng-daemon-adv-methods"></a><span><img src="./imagelib/callouts/8.png" alt="8" border="0" /></span>
xyzzy_cmd="echo 'Nothing happens.'"

mumbled_prestart()
{
	if checkyesno mumbled_smart; then<a id="rcng-daemon-adv-yn"></a><span><img src="./imagelib/callouts/9.png" alt="9" border="0" /></span>
		rc_flags="-o smart ${rc_flags}"<a id="rcng-daemon-adv-rcflags"></a><span><img src="./imagelib/callouts/10.png" alt="10" border="0" /></span>
	fi
	case "$mumbled_mode" in
	foo)
		rc_flags="-frotz ${rc_flags}"
		;;
	bar)
		rc_flags="-baz ${rc_flags}"
		;;
	*)
		warn "Invalid value for mumbled_mode"<a id="rcng-daemon-adv-warn"></a><span><img src="./imagelib/callouts/11.png" alt="11" border="0" /></span>
		return 1<a id="rcng-daemon-adv-preret"></a><span><img src="./imagelib/callouts/12.png" alt="12" border="0" /></span>
		;;
	esac
	run_rc_command xyzzy<a id="rcng-daemon-adv-run"></a><span><img src="./imagelib/callouts/13.png" alt="13" border="0" /></span>
	return 0
}

mumbled_plugh()<a id="rcng-daemon-adv-plugh"></a><span><img src="./imagelib/callouts/14.png" alt="14" border="0" /></span>
{
	echo 'A hollow voice says "plugh".'
}

load_rc_config $name
run_rc_command "$1"</pre></div><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#rcng-daemon-adv-args"><span><img src="./imagelib/callouts/1.png" alt="1" border="0" /></span></a> </p></td><td valign="top" align="left"><p>Additional arguments to <code class="envar">$command</code> can
	  be passed in <code class="envar">command_args</code>.  They will be
	  added to the command line after <code class="envar">$mumbled_flags</code>.
	  Since the final command line is passed to <code class="command">eval</code>
	  for its actual execution, input and output redirections
	  can be specified in <code class="envar">command_args</code>.</p><div xmlns="" class="note"><h3 class="admontitle">Note: </h3><p xmlns="http://www.w3.org/1999/xhtml"><span class="emphasis"><em>Never</em></span> include dashed options,
	    like <code class="option">-X</code> or <code class="option">--foo</code>, in
	    <code class="envar">command_args</code>.
	    The contents of <code class="envar">command_args</code> will
	    appear at the end of the final command line, hence
	    they are likely to follow arguments present in
	    <code class="envar">${name}_flags</code>; but most commands will
	    not recognize dashed options after ordinary arguments.
	    A better way of passing additional options
	    to <code class="envar">$command</code> is to add them
	    to the beginning of <code class="envar">${name}_flags</code>.
	    Another way is to modify <code class="envar">rc_flags</code> <a class="link" href="rcng-daemon-adv.html#rc-flags">as shown later</a>.</p></div></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#rcng-daemon-adv-pid"><span><img src="./imagelib/callouts/2.png" alt="2" border="0" /></span></a> </p></td><td valign="top" align="left"><p>A good-mannered daemon should create a
	  <span class="emphasis"><em>pidfile</em></span> so that its process can be
	  found more easily and reliably.  The variable
	  <code class="envar">pidfile</code>, if set, tells <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=rc.subr&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">rc.subr</span>(8)</span></a>
	  where it can find the pidfile for its default methods to
	  use.</p><div xmlns="" class="note"><h3 class="admontitle">Note: </h3><p xmlns="http://www.w3.org/1999/xhtml">In fact, <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=rc.subr&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">rc.subr</span>(8)</span></a> will also use the pidfile
	    to see if the daemon is already running before starting
	    it.  This check can be skipped by using the
	    <code class="option">faststart</code> argument.</p></div></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#rcng-daemon-adv-reqfiles"><span><img src="./imagelib/callouts/3.png" alt="3" border="0" /></span></a> </p></td><td valign="top" align="left"><p>If the daemon cannot run unless certain files exist,
	  just list them in <code class="envar">required_files</code>, and
	  <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=rc.subr&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">rc.subr</span>(8)</span></a> will check that those files do exist
	  before starting the daemon.  There also are
	  <code class="envar">required_dirs</code> and <code class="envar">required_vars</code>
	  for directories and environment variables, respectively.
	  They all are described in detail in <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=rc.subr&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">rc.subr</span>(8)</span></a>.</p><div xmlns="" class="note"><h3 class="admontitle">Note: </h3><p xmlns="http://www.w3.org/1999/xhtml">The default method from <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=rc.subr&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">rc.subr</span>(8)</span></a> can be
	    forced to skip the prerequisite checks by using
	    <code class="option">forcestart</code> as the argument to the
	    script.</p></div></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#rcng-daemon-adv-sig"><span><img src="./imagelib/callouts/4.png" alt="4" border="0" /></span></a> </p></td><td valign="top" align="left"><p>We can customize signals to send to the daemon in
	  case they differ from the well-known ones.  In particular,
	  <code class="envar">sig_reload</code> specifies the signal that makes
	  the daemon reload its configuration; it is
	  <span class="symbol">SIGHUP</span> by default.  Another signal is
	  sent to stop the daemon process; the default is
	  <span class="symbol">SIGTERM</span>, but this can be changed by
	  setting <code class="envar">sig_stop</code> appropriately.</p><div xmlns="" class="note"><h3 class="admontitle">Note: </h3><p xmlns="http://www.w3.org/1999/xhtml">The signal names should be specified to <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=rc.subr&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">rc.subr</span>(8)</span></a>
	    without the <code class="literal">SIG</code> prefix, as it is
	    shown in the example.  The FreeBSD version of <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=kill&amp;sektion=1&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">kill</span>(1)</span></a>
	    can recognize the <code class="literal">SIG</code> prefix, but
	    the versions from other OS types may not.</p></div></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#rcng-daemon-adv-precmd"><span><img src="./imagelib/callouts/5.png" alt="5" border="0" /></span></a> <a href="#rcng-daemon-adv-postcmd"><span><img src="./imagelib/callouts/6.png" alt="6" border="0" /></span></a> </p></td><td valign="top" align="left"><p>Performing additional tasks before or after the default
	  methods is easy.  For each command-argument supported by
	  our script, we can define
	  <code class="envar"><em class="replaceable"><code>argument</code></em>_precmd</code> and
	  <code class="envar"><em class="replaceable"><code>argument</code></em>_postcmd</code>.
	  These <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=sh&amp;sektion=1&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">sh</span>(1)</span></a> commands are invoked before and after
	  the respective method, as it is evident from their
	  names.</p><div xmlns="" class="note"><h3 class="admontitle">Note: </h3><p xmlns="http://www.w3.org/1999/xhtml">Overriding a default method with a custom
	    <code class="envar"><em class="replaceable"><code>argument</code></em>_cmd</code>
	    still does not prevent us from making use of
	    <code class="envar"><em class="replaceable"><code>argument</code></em>_precmd</code> or
	    <code class="envar"><em class="replaceable"><code>argument</code></em>_postcmd</code>
	    if we need to.  In particular, the former is good for
	    checking custom, sophisticated conditions that should
	    be met before performing the command itself.  Using
	    <code class="envar"><em class="replaceable"><code>argument</code></em>_precmd</code> along
	    with <code class="envar"><em class="replaceable"><code>argument</code></em>_cmd</code>
	    lets us logically separate the checks from the
	    action.</p><p xmlns="http://www.w3.org/1999/xhtml">Do not forget that you can cram any valid <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=sh&amp;sektion=1&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">sh</span>(1)</span></a>
	    expressions into the methods, pre-, and post-commands
	    you define.  Just invoking a function that makes the
	    real job is a good style in most cases, but never let
	    style limit your understanding of what is going on
	    behind the curtain.</p></div></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#rcng-daemon-adv-extra"><span><img src="./imagelib/callouts/7.png" alt="7" border="0" /></span></a> </p></td><td valign="top" align="left"><p>If we would like to implement custom arguments, which
	  can also be thought of as <span class="emphasis"><em>commands</em></span>
	  to our script, we need to list them in
	  <code class="envar">extra_commands</code> and provide methods to
	  handle them.</p><div xmlns="" class="note"><h3 class="admontitle">Note: </h3><p xmlns="http://www.w3.org/1999/xhtml">The <code class="option">reload</code> command is special.  On
	    the one hand, it has a preset method in <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=rc.subr&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">rc.subr</span>(8)</span></a>.
	    On the other hand, <code class="option">reload</code> is not offered
	    by default.  The reason is that not all daemons use the
	    same reload mechanism and some have nothing to reload
	    at all.  So we need to ask explicitly that the builtin
	    functionality be provided.  We can do so via
	    <code class="envar">extra_commands</code>.</p><p xmlns="http://www.w3.org/1999/xhtml">What do we get from the default method for
	    <code class="option">reload</code>?  Quite often daemons reload
	    their configuration upon reception of a signal &#8212;
	    typically, <span class="symbol">SIGHUP</span>.  Therefore
	    <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=rc.subr&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">rc.subr</span>(8)</span></a> attempts to reload the daemon by sending
	    a signal to it.  The signal is preset to
	    <span class="symbol">SIGHUP</span> but can be customized via
	    <code class="envar">sig_reload</code> if necessary.</p></div></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#rcng-daemon-adv-methods"><span><img src="./imagelib/callouts/8.png" alt="8" border="0" /></span></a> <a href="#rcng-daemon-adv-plugh"><span><img src="./imagelib/callouts/14.png" alt="14" border="0" /></span></a> </p></td><td valign="top" align="left"><p>Our script supports two non-standard commands,
	  <code class="option">plugh</code> and <code class="option">xyzzy</code>.  We
	  saw them listed in <code class="envar">extra_commands</code>, and now
	  it is time to provide methods for them.  The method for
	  <code class="option">xyzzy</code> is just inlined while that for
	  <code class="option">plugh</code> is implemented as the
	  <code class="function">mumbled_plugh</code> function.</p><p>Non-standard commands are not invoked during startup
	  or shutdown.  Usually they are for the system admin's
	  convenience.  They can also be used from other subsystems,
	  e.g., <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=devd&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">devd</span>(8)</span></a> if specified in <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=devd.conf&amp;sektion=5&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">devd.conf</span>(5)</span></a>.</p><p>The full list of available commands can be found in
	  the usage line printed by <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=rc.subr&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">rc.subr</span>(8)</span></a> when the script
	  is invoked without arguments.  For example, here is the
	  usage line from the script under study:</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>/etc/rc.d/mumbled</code></strong>
Usage: /etc/rc.d/mumbled [fast|force|one](start|stop|restart|rcvar|reload|plugh|xyzzy|status|poll)</pre></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#rcng-daemon-adv-run"><span><img src="./imagelib/callouts/13.png" alt="13" border="0" /></span></a> </p></td><td valign="top" align="left"><p>A script can invoke its own standard or non-standard
	  commands if needed.  This may look similar to calling
	  functions, but we know that commands and shell functions
	  are not always the same thing.  For instance,
	  <code class="command">xyzzy</code> is not implemented as a function
	  here.  In addition, there can be a pre-command and
	  post-command, which should be invoked orderly.  So the
	  proper way for a script to run its own command is by means
	  of <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=rc.subr&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">rc.subr</span>(8)</span></a>, as shown in the example.</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#rcng-daemon-adv-yn"><span><img src="./imagelib/callouts/9.png" alt="9" border="0" /></span></a> </p></td><td valign="top" align="left"><p>A handy function named <code class="function">checkyesno</code>
	  is provided by <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=rc.subr&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">rc.subr</span>(8)</span></a>.  It takes a variable name
	  as its argument and returns a zero exit code if and only
	  if the variable is set to <code class="literal">YES</code>, or
	  <code class="literal">TRUE</code>, or <code class="literal">ON</code>, or
	  <code class="literal">1</code>, case insensitive; a non-zero exit
	  code is returned otherwise.  In the latter case, the
	  function tests the variable for being set to
	  <code class="literal">NO</code>, <code class="literal">FALSE</code>,
	  <code class="literal">OFF</code>, or <code class="literal">0</code>, case
	  insensitive; it prints a warning message if the variable
	  contains anything else, i.e., junk.</p><p>Keep in mind that for <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=sh&amp;sektion=1&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">sh</span>(1)</span></a> a zero exit code
	  means true and a non-zero exit code means false.</p><div xmlns="" class="important"><h3 class="admontitle">Important: </h3><p xmlns="http://www.w3.org/1999/xhtml">The <code class="function">checkyesno</code> function takes
	    a <span class="emphasis"><em>variable name</em></span>.  Do not pass the
	    expanded <span class="emphasis"><em>value</em></span> of a variable to
	    it; it will not work as expected.</p><p xmlns="http://www.w3.org/1999/xhtml">The following is the correct usage of
	    <code class="function">checkyesno</code>:</p><pre xmlns="http://www.w3.org/1999/xhtml" class="programlisting">if checkyesno mumbled_enable; then
        foo
fi</pre><p xmlns="http://www.w3.org/1999/xhtml">On the contrary, calling <code class="function">checkyesno</code>
	    as shown below will not work &#8212; at least not as
	    expected:</p><pre xmlns="http://www.w3.org/1999/xhtml" class="programlisting">if checkyesno "${mumbled_enable}"; then
        foo
fi</pre></div></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#rcng-daemon-adv-rcflags"><span><img src="./imagelib/callouts/10.png" alt="10" border="0" /></span></a> </p></td><td valign="top" align="left"><p><a id="rc-flags"></a>We can affect the flags to be
	  passed to <code class="envar">$command</code> by modifying
	  <code class="envar">rc_flags</code> in <code class="envar">$start_precmd</code>.</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#rcng-daemon-adv-warn"><span><img src="./imagelib/callouts/11.png" alt="11" border="0" /></span></a> </p></td><td valign="top" align="left"><p>In certain cases we may need to emit an important
	  message that should go to <span class="application">syslog</span>
	  as well.  This can be done easily with the following
	  <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=rc.subr&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">rc.subr</span>(8)</span></a> functions: <code class="function">debug</code>,
	  <code class="function">info</code>, <code class="function">warn</code>, and
	  <code class="function">err</code>.  The latter function then exits
	  the script with the code specified.</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#rcng-daemon-adv-preret"><span><img src="./imagelib/callouts/12.png" alt="12" border="0" /></span></a> </p></td><td valign="top" align="left"><p>The exit codes from methods and their pre-commands
	  are not just ignored by default.  If
	  <code class="envar"><em class="replaceable"><code>argument</code></em>_precmd</code> returns
	  a non-zero exit code, the main method will not be performed.
	  In turn,
	  <code class="envar"><em class="replaceable"><code>argument</code></em>_postcmd</code> will
	  not be invoked unless the main method returns a zero exit
	  code.</p><div xmlns="" class="note"><h3 class="admontitle">Note: </h3><p xmlns="http://www.w3.org/1999/xhtml">However, <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=rc.subr&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">rc.subr</span>(8)</span></a> can be instructed from the
	    command line to ignore those exit codes and invoke all
	    commands anyway by prefixing an argument with
	    <code class="literal">force</code>, as in
	    <code class="option">forcestart</code>.</p></div></td></tr></table></div></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="rcng-daemon.html">Prev</a> </td><td width="20%" align="center"> </td><td width="40%" align="right"> <a accesskey="n" href="rcng-hookup.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top">5. Startup and shutdown of a simple daemon </td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right" valign="top"> 7. Connecting a script to the rc.d framework</td></tr></table></div><p xmlns="" align="center"><small>All FreeBSD documents are available for download
    at <a href="https://download.freebsd.org/ftp/doc/">https://download.freebsd.org/ftp/doc/</a></small></p><p xmlns="" align="center"><small>Questions that are not answered by the
    <a href="https://www.FreeBSD.org/docs.html">documentation</a> may be
    sent to &lt;<a href="mailto:freebsd-questions@FreeBSD.org">freebsd-questions@FreeBSD.org</a>&gt;.<br />
    Send questions about this document to &lt;<a href="mailto:freebsd-doc@FreeBSD.org">freebsd-doc@FreeBSD.org</a>&gt;.</small></p></body></html>