<?xml version="1.0" encoding="iso-8859-1" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" /><title>4. A configurable dummy script</title><link rel="stylesheet" type="text/css" href="docbook.css" /><link rev="made" href="mailto:doc@FreeBSD.org" /><meta name="generator" content="DocBook XSL Stylesheets V1.79.1" /><link rel="home" href="index.html" title="Practical rc.d scripting in BSD" /><link rel="up" href="index.html" title="Practical rc.d scripting in BSD" /><link rel="prev" href="rcng-dummy.html" title="3. A dummy script" /><link rel="next" href="rcng-daemon.html" title="5. Startup and shutdown of a simple daemon" /><link rel="copyright" href="trademarks.html" title="Legal Notice" /><script xmlns="" type="text/javascript" src="/layout/js/google.js"></script></head><body><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">4. A configurable dummy script</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="rcng-dummy.html">Prev</a> </td><th width="60%" align="center"> </th><td width="20%" align="right"> <a accesskey="n" href="rcng-daemon.html">Next</a></td></tr></table><hr /></div><div class="sect1"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="rcng-confdummy"></a>4. A configurable dummy script</h2></div></div></div><p>Now let us add some controls to our dummy script.  As you
      may know, <code class="filename">rc.d</code> scripts are controlled
      with <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=rc.conf&amp;sektion=5&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">rc.conf</span>(5)</span></a>.  Fortunately, <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=rc.subr&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">rc.subr</span>(8)</span></a> hides all
      the complications from us.  The following script uses
      <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=rc.conf&amp;sektion=5&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">rc.conf</span>(5)</span></a> via <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=rc.subr&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">rc.subr</span>(8)</span></a> to see whether it is
      enabled in the first place, and to fetch a message to show
      at boot time.  These two tasks in fact are independent.  On
      the one hand, an <code class="filename">rc.d</code> script can just
      support enabling and disabling its service.  On the other
      hand, a mandatory <code class="filename">rc.d</code> script can have
      configuration variables.  We will do both things in the same
      script though:</p><div class="informalexample"><pre class="programlisting">#!/bin/sh

. /etc/rc.subr

name=dummy
rcvar=dummy_enable<a id="rcng-confdummy-rcvar"></a><span><img src="./imagelib/callouts/1.png" alt="1" border="0" /></span>

start_cmd="${name}_start"
stop_cmd=":"

load_rc_config $name<a id="rcng-confdummy-loadconfig"></a><span><img src="./imagelib/callouts/2.png" alt="2" border="0" /></span>
: ${dummy_enable:=no} <a id="rcng-confdummy-enable"></a><span><img src="./imagelib/callouts/3.png" alt="3" border="0" /></span>
: ${dummy_msg="Nothing started."}<a id="rcng-confdummy-opt"></a><span><img src="./imagelib/callouts/4.png" alt="4" border="0" /></span>

dummy_start()
{
	echo "$dummy_msg"<a id="rcng-confdummy-msg"></a><span><img src="./imagelib/callouts/5.png" alt="5" border="0" /></span>
}

run_rc_command "$1"</pre></div><p>What changed in this example?</p><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#rcng-confdummy-rcvar"><span><img src="./imagelib/callouts/1.png" alt="1" border="0" /></span></a> </p></td><td valign="top" align="left"><p>The variable <code class="envar">rcvar</code> specifies
	  the name of the ON/OFF knob variable.</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#rcng-confdummy-loadconfig"><span><img src="./imagelib/callouts/2.png" alt="2" border="0" /></span></a> </p></td><td valign="top" align="left"><p>Now <code class="function">load_rc_config</code> is invoked
	  earlier in the script, before any <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=rc.conf&amp;sektion=5&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">rc.conf</span>(5)</span></a> variables
	  are accessed.</p><div xmlns="" class="note"><h3 class="admontitle">Note: </h3><p xmlns="http://www.w3.org/1999/xhtml">While examining <code class="filename">rc.d</code> scripts,
	    keep in mind that <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=sh&amp;sektion=1&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">sh</span>(1)</span></a> defers the evaluation of
	    expressions in a function until the latter is called.
	    Therefore it is not an error to invoke
	    <code class="function">load_rc_config</code> as late as just
	    before <code class="function">run_rc_command</code> and still
	    access <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=rc.conf&amp;sektion=5&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">rc.conf</span>(5)</span></a> variables from the method functions
	    exported to <code class="function">run_rc_command</code>.  This
	    is because the method functions are to be called by
	    <code class="function">run_rc_command</code>, which is invoked
	    <span class="emphasis"><em>after</em></span>
	    <code class="function">load_rc_config</code>.</p></div></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#rcng-confdummy-enable"><span><img src="./imagelib/callouts/3.png" alt="3" border="0" /></span></a> </p></td><td valign="top" align="left"><p>A warning will be emitted by
	  <code class="function">run_rc_command</code> if <code class="envar">rcvar</code>
	  itself is set, but the indicated knob variable is unset.
	  If your <code class="filename">rc.d</code> script is for the base
	  system, you should add a default setting for the knob to
	  <code class="filename">/etc/defaults/rc.conf</code> and document
	  it in <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=rc.conf&amp;sektion=5&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">rc.conf</span>(5)</span></a>.  Otherwise it is your script that
	  should provide a default setting for the knob.  The canonical
	  approach to the latter case is shown in the example.</p><div xmlns="" class="note"><h3 class="admontitle">Note: </h3><p xmlns="http://www.w3.org/1999/xhtml">You can make <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=rc.subr&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">rc.subr</span>(8)</span></a> act as though the knob
	    is set to <code class="literal">ON</code>, irrespective of its
	    current setting, by prefixing the argument to the script
	    with <code class="literal">one</code> or <code class="literal">force</code>,
	    as in <code class="option">onestart</code> or <code class="option">forcestop</code>.
	    Keep in mind though that <code class="literal">force</code> has
	    other dangerous effects we will touch upon below, while
	    <code class="literal">one</code> just overrides the ON/OFF knob.
	    E.g., assume that <code class="envar">dummy_enable</code> is
	    <code class="literal">OFF</code>.  The following command will run
	    the <code class="option">start</code> method in spite of the
	    setting:</p><pre xmlns="http://www.w3.org/1999/xhtml" class="screen"><code class="prompt">#</code> <strong class="userinput"><code>/etc/rc.d/dummy onestart</code></strong></pre></div></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#rcng-confdummy-opt"><span><img src="./imagelib/callouts/4.png" alt="4" border="0" /></span></a> </p></td><td valign="top" align="left"><p>Now the message to be shown at boot time is no
	  longer hard-coded in the script.  It is specified by an
	  <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=rc.conf&amp;sektion=5&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">rc.conf</span>(5)</span></a> variable named <code class="envar">dummy_msg</code>.
	  This is a trivial example of how <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=rc.conf&amp;sektion=5&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">rc.conf</span>(5)</span></a> variables
	  can control an <code class="filename">rc.d</code> script.</p><div xmlns="" class="important"><h3 class="admontitle">Important: </h3><p xmlns="http://www.w3.org/1999/xhtml">The names of all <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=rc.conf&amp;sektion=5&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">rc.conf</span>(5)</span></a> variables used
	    exclusively by our script <span class="emphasis"><em>must</em></span>
	    have the same prefix: <code class="envar">${name}_</code>.  For
	    example: <code class="envar">dummy_mode</code>,
	    <code class="envar">dummy_state_file</code>, and so on.</p></div><div xmlns="" class="note"><h3 class="admontitle">Note: </h3><p xmlns="http://www.w3.org/1999/xhtml">While it is possible to use a shorter name internally,
	    e.g., just <code class="envar">msg</code>, adding the unique prefix
	    <code class="envar">${name}_</code> to all global names introduced by
	    our script will save us from possible
	    collisions with the <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=rc.subr&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">rc.subr</span>(8)</span></a> namespace.</p><p xmlns="http://www.w3.org/1999/xhtml">As a rule, <code class="filename">rc.d</code> scripts of the
	    base system need not provide defaults for their
	    <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=rc.conf&amp;sektion=5&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">rc.conf</span>(5)</span></a> variables because the defaults should
	    be set in <code class="filename">/etc/defaults/rc.conf</code>
	    instead.  On the other hand, <code class="filename">rc.d</code>
	    scripts for ports should provide the defaults as shown
	    in the example.</p></div></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#rcng-confdummy-msg"><span><img src="./imagelib/callouts/5.png" alt="5" border="0" /></span></a> </p></td><td valign="top" align="left"><p>Here we use <code class="envar">dummy_msg</code> to actually
	  control our script, i.e., to emit a variable message.
	  Use of a shell function is overkill here, since it only
	  runs a single command; an equally valid alternative is:</p><pre class="programlisting">start_cmd="echo \"$dummy_msg\""</pre></td></tr></table></div></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="rcng-dummy.html">Prev</a> </td><td width="20%" align="center"> </td><td width="40%" align="right"> <a accesskey="n" href="rcng-daemon.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top">3. A dummy script </td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right" valign="top"> 5. Startup and shutdown of a simple daemon</td></tr></table></div><p xmlns="" align="center"><small>All FreeBSD documents are available for download
    at <a href="https://download.freebsd.org/ftp/doc/">https://download.freebsd.org/ftp/doc/</a></small></p><p xmlns="" align="center"><small>Questions that are not answered by the
    <a href="https://www.FreeBSD.org/docs.html">documentation</a> may be
    sent to &lt;<a href="mailto:freebsd-questions@FreeBSD.org">freebsd-questions@FreeBSD.org</a>&gt;.<br />
    Send questions about this document to &lt;<a href="mailto:freebsd-doc@FreeBSD.org">freebsd-doc@FreeBSD.org</a>&gt;.</small></p></body></html>