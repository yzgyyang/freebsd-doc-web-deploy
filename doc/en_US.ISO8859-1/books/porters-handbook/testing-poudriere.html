<?xml version="1.0" encoding="iso-8859-1" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" /><title>10.5. Poudriere</title><link rel="stylesheet" type="text/css" href="docbook.css" /><link rev="made" href="mailto:doc@FreeBSD.org" /><meta name="generator" content="DocBook XSL Stylesheets V1.79.1" /><link rel="home" href="index.html" title="FreeBSD Porter's Handbook" /><link rel="up" href="testing.html" title="Chapter 10. Testing the Port" /><link rel="prev" href="porting-prefix.html" title="10.4. PREFIX and DESTDIR" /><link rel="next" href="port-upgrading.html" title="Chapter 11. Upgrading a Port" /><link rel="copyright" href="legalnotice.html" title="Copyright" /><script xmlns="" type="text/javascript" src="/layout/js/google.js"></script></head><body><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">10.5. <span class="application">Poudriere</span></th></tr><tr><td width="20%" align="left"><a accesskey="p" href="porting-prefix.html">Prev</a> </td><th width="60%" align="center">Chapter 10. Testing the Port</th><td width="20%" align="right"> <a accesskey="n" href="port-upgrading.html">Next</a></td></tr></table><hr /></div><div class="sect1"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="testing-poudriere"></a>10.5. <span class="application">Poudriere</span></h2></div></div></div><p>For a ports contributor,
      <span class="application">Poudriere</span> is one of the most
      important and helpful testing and build tools.  Its main
      features include:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Bulk building of the entire ports tree, specific subsets
	  of the ports tree, or a single port including its
	  dependencies</p></li><li class="listitem"><p>Automatic packaging of build results</p></li><li class="listitem"><p>Generation of build log files per port</p></li><li class="listitem"><p>Providing a signed <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=pkg&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">pkg</span>(8)</span></a> repository</p></li><li class="listitem"><p>Testing of port builds before submitting a patch to the
	  FreeBSD bug tracker or committing to the ports tree</p></li><li class="listitem"><p>Testing for successful ports builds using different
	  options</p></li></ul></div><p>Because <span class="application">Poudriere</span> performs its
      building in a clean <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=jail&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">jail</span>(8)</span></a> environment and uses
      <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=zfs&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">zfs</span>(8)</span></a> features, it has several advantages over traditional
      testing on the host system:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>No pollution of the host environment: No leftover files,
	  no accidental removals, no changes of existing configuration
	  files.</p></li><li class="listitem"><p>Verify <code class="filename">pkg-plist</code> for missing or
	  superfluous entries</p></li><li class="listitem"><p>Ports committers sometimes ask for a
	  <span class="application">Poudriere</span> log alongside a patch
	  submission to assess whether the patch is ready for
	  integration into the ports tree</p></li></ul></div><p>It is also quite straightforward to set up and use, has no
      dependencies, and will run on any supported FreeBSD release.  This
      section shows how to install, configure, and run
      <span class="application">Poudriere</span> as part of the normal
      workflow of a ports contributor.</p><p>The examples in this section show a default file layout, as
      standard in FreeBSD.  Substitute any local changes accordingly.
      The ports tree, represented by <code class="varname">${PORTSDIR}</code>,
      is located in <code class="filename">/usr/ports</code>.  Both
      <code class="varname">${LOCALBASE}</code> and <code class="varname">${PREFIX}</code>
      are <code class="filename">/usr/local</code> by default.</p><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="testing-poudriere-installing"></a>10.5.1. Installing <span class="application">Poudriere</span></h3></div></div></div><p><span class="application">Poudriere</span> is available in the
	ports tree in <a xmlns="" class="package" href="https://www.freebsd.org/cgi/url.cgi?ports/ports-mgmt/poudriere/pkg-descr">ports-mgmt/poudriere</a>.  It can be
	installed using <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=pkg&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">pkg</span>(8)</span></a> or from ports:</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>pkg install poudriere</code></strong></pre><p>or</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>make -C /usr/ports/ports-mgmt/poudriere install clean</code></strong></pre><p>There is also a work-in-progress version of
	<span class="application">Poudriere</span> which will eventually
	become the next release.  It is available in <a xmlns="" class="package" href="https://www.freebsd.org/cgi/url.cgi?ports/ports-mgmt/poudriere-devel/pkg-descr">ports-mgmt/poudriere-devel</a>.  This
	development version is used for the official FreeBSD package
	builds, so it is well tested.  It often has newer interesting
	features.  A ports committer will want to use the development
	version because it is what is used in production, and has all
	the new features that will make sure everything is exactly
	right.  A contributor will not necessarily need those as the
	most important fixes are backported to released version.  The
	main reason for the use of the development version to build
	the official package is because it is faster, in a way that
	will shorten a full build from 18 hours to 17 hours when using
	a high end 32 <acronym class="acronym">CPU</acronym> server with 128GB of
	<acronym class="acronym">RAM</acronym>.  Those optimizations will not matter a
	lot when building ports on a desktop machine.</p></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="testing-poudriere-setup"></a>10.5.2. Setting Up <span class="application">Poudriere</span></h3></div></div></div><p>The port installs a default configuration file,
	<code class="filename">/usr/local/etc/poudriere.conf</code>.  Each
	parameter is documented in the configuration file and in
	<a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=poudriere&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">poudriere</span>(8)</span></a>.  Here is a minimal example config
	file:</p><pre class="programlisting">ZPOOL=tank
ZROOTFS=/poudriere
BASEFS=/poudriere
DISTFILES_CACHE=/usr/ports/distfiles
RESOLV_CONF=/etc/resolv.conf
FREEBSD_HOST=ftp://ftp.freebsd.org
SVN_HOST=svn.FreeBSD.org</pre><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="varname">ZPOOL</code></span></dt><dd><p>The name of the <acronym class="acronym">ZFS</acronym> storage pool
	      which <span class="application">Poudriere</span> shall use.
	      Must be listed in the output of <code class="command">zpool
		status</code>.</p></dd><dt><span class="term"><code class="varname">ZROOTFS</code></span></dt><dd><p>The root of
	      <span class="application">Poudriere</span>-managed file
	      systems.  This entry will cause
	      <span class="application">Poudriere</span> to create
	      <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=zfs&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">zfs</span>(8)</span></a> file systems under
	      <code class="literal">tank/poudriere</code>.</p></dd><dt><span class="term"><code class="varname">BASEFS</code></span></dt><dd><p>The root mount point for
	      <span class="application">Poudriere</span> file systems.  This
	      entry will cause <span class="application">Poudriere</span> to
	      mount <code class="literal">tank/poudriere</code> to
	      <code class="literal">/poudriere</code>.</p></dd><dt><span class="term"><code class="varname">DISTFILES_CACHE</code></span></dt><dd><p>Defines where distfiles are stored.  In this
	      example, <span class="application">Poudriere</span> and the
	      host share the distfiles storage directory.  This avoids
	      downloading tarballs which are already present on the
	      system.  Please create this directory if it does not
	      already exist so that <span class="application">Poudriere</span>
	      can find it.</p></dd><dt><span class="term"><code class="varname">RESOLV_CONF</code></span></dt><dd><p>Use the host <code class="filename">/etc/resolv.conf</code>
	      inside jails for <acronym class="acronym">DNS</acronym>.  This is needed
	      so jails can resolve the <acronym class="acronym">URL</acronym>s of
	      distfiles when downloading.  It is not needed when using
	      a proxy.  Refer to the default configuration file for
	      proxy configuration.</p></dd><dt><span class="term"><code class="varname">FREEBSD_HOST</code></span></dt><dd><p>The <acronym class="acronym">FTP</acronym>/<acronym class="acronym">HTTP</acronym>
	      server to use when the jails are installed from FreeBSD
	      releases and updated with <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=freebsd-update&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">freebsd-update</span>(8)</span></a>.
	      Choose a server location which is close, for example if
	      the machine is located in Australia, use
	      <code class="literal">ftp.au.freebsd.org</code>.</p></dd><dt><span class="term"><code class="varname">SVN_HOST</code></span></dt><dd><p>The server from where jails are installed and
	      updated when using
	      <span class="application">Subversion</span>.  Also used for
	      ports tree when not using <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=portsnap&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">portsnap</span>(8)</span></a>.  Again,
	      choose a nearby location.  A list of official
	      <span class="application">Subversion</span> mirrors can be
	      found in the <a class="link" href="../../../../doc/en_US.ISO8859-1/books/handbook/svn.html#svn-mirrors" target="_top">FreeBSD
		Handbook <span class="application">Subversion</span>
		section</a>.</p></dd></dl></div></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="testing-poudriere-create-jails"></a>10.5.3. Creating <span class="application">Poudriere</span>
	Jails</h3></div></div></div><p>Create the base jails which
	<span class="application">Poudriere</span> will use for
	building:</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>poudriere jail -c -j 113Ramd64 -v 11.3-RELEASE -a amd64</code></strong></pre><p>Fetch a <code class="literal">11.3-RELEASE</code> for
	<code class="literal">amd64</code> from the <acronym class="acronym">FTP</acronym>
	server given by <code class="varname">FREEBSD_HOST</code> in
	<code class="filename">poudriere.conf</code>, create the zfs file
	system <code class="literal">tank/poudriere/jails/113Ramd64</code>, mount
	it on <code class="filename">/poudriere/jails/113Ramd64</code> and
	extract the <code class="literal">11.3-RELEASE</code> tarballs into this
	file system.</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>poudriere jail -c -j 11i386 -v stable/11 -a i386 -m svn+https</code></strong></pre><p>Create <code class="literal">tank/poudriere/jails/11i386</code>,
	mount it on <code class="filename">/poudriere/jails/11i386</code>, then
	check out the tip of the <span class="application">Subversion</span>
	branch of <code class="literal">FreeBSD-11-STABLE</code> from
	<code class="literal">SVN_HOST</code> in
	<code class="filename">poudriere.conf</code> into
	<code class="filename">/poudriere/jails/11i386/usr/src</code>, then
	complete a <code class="buildtarget">buildworld</code> and install
	it into <code class="filename">/poudriere/jails/11i386</code>.</p><div xmlns="" class="tip"><h3 class="admontitle">Tip: </h3><p xmlns="http://www.w3.org/1999/xhtml">If a specific <span class="application">Subversion</span>
	  revision is needed, append it to the version string.  For
	  example:</p><pre xmlns="http://www.w3.org/1999/xhtml" class="screen"><code class="prompt">#</code> <strong class="userinput"><code>poudriere jail -c -j 11i386 -v stable/11@123456 -a i386 -m svn+https</code></strong></pre></div><div xmlns="" class="note"><h3 class="admontitle">Note: </h3><p xmlns="http://www.w3.org/1999/xhtml">While it is possible to build a newer version of FreeBSD on
	  an older version, most of the time it will not run.  For
	  example, if a <code class="literal">stable/11</code> jail is needed,
	  the host will have to run <code class="literal">stable/11</code> too.
	  Running <code class="literal">11.3-RELEASE</code> is not
	  enough.</p></div><div xmlns="" class="note"><h3 class="admontitle">Note: </h3><p xmlns="http://www.w3.org/1999/xhtml">To create a <span class="application">Poudriere</span> jail
	  for <code class="literal">13.0-CURRENT</code>:</p><pre xmlns="http://www.w3.org/1999/xhtml" class="screen"><code class="prompt">#</code> <strong class="userinput"><code>poudriere jail -c -j 13amd64 -v head -a amd64 -m svn+https</code></strong></pre><p xmlns="http://www.w3.org/1999/xhtml">In order to run a <code class="literal">13.0-CURRENT</code>
	    <span class="application">Poudriere</span> jail you must be
	    running <code class="literal">13.0-CURRENT</code>.  In general, newer
	    kernels can build and run older jails.  For instance, a
	    <code class="literal">13.0-CURRENT</code> kernel can build and run a
	    <code class="literal">11.3-STABLE</code>
	    <span class="application">Poudriere</span> jail if the
	    <code class="literal">COMPAT_FREEBSD11</code> kernel option was
	    compiled in (on by default in
	    <code class="literal">13.0-CURRENT</code>
	    <code class="filename">GENERIC</code> kernel config).</p></div><div xmlns="" class="caution"><h3 class="admontitle">Caution: </h3><p xmlns="http://www.w3.org/1999/xhtml">The default <code class="literal">svn</code> protocol works but is
	  not very secure.  Using <code class="literal">svn+https</code> along
	  with verifying the remote server's <acronym class="acronym">SSL</acronym>
	  fingerprint is advised.  It will ensure that the files used
	  for building the jail are from a trusted source.</p></div><p>A list of jails currently known to
	<span class="application">Poudriere</span> can be shown with
	<code class="command">poudriere jail -l</code>:</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>poudriere jail -l</code></strong>
JAILNAME             VERSION              ARCH    METHOD
113Ramd64            11.3-RELEASE         amd64   ftp
11i386               11.3-STABLE          i386    svn+https</pre></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="testing-poudriere-maintaining-jails"></a>10.5.4. Keeping <span class="application">Poudriere</span> Jails
	Updated</h3></div></div></div><p>Managing updates is very straightforward.  The
	command:</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>poudriere jail -u -j <em class="replaceable"><code>JAILNAME</code></em></code></strong></pre><p>updates the specified jail to the latest version
	available.  For FreeBSD releases, update to the latest patchlevel
	with <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=freebsd-update&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">freebsd-update</span>(8)</span></a>.  For FreeBSD versions built from
	source, update to the latest
	<span class="application">Subversion</span> revision in the
	branch.</p><div xmlns="" class="tip"><h3 class="admontitle">Tip: </h3><p xmlns="http://www.w3.org/1999/xhtml">For jails employing a
	  <code class="literal">svn+<em class="replaceable"><code>*</code></em></code> method,
	  it is helpful to add <code class="command">-J
	    <em class="replaceable"><code>NumberOfParallelBuildJobs</code></em></code>
	  to speed up the build by increasing the number of parallel
	  compile jobs used.  For example, if the building machine has
	  6 <acronym class="acronym">CPU</acronym>s, use:</p><pre xmlns="http://www.w3.org/1999/xhtml" class="screen"><code class="prompt">#</code> <strong class="userinput"><code>poudriere jail -u -J 6 -j <em class="replaceable"><code>JAILNAME</code></em></code></strong></pre></div></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="testing-poudriere-ports-tree"></a>10.5.5. Setting Up Ports Trees for Use with
	<span class="application">Poudriere</span></h3></div></div></div><p>There are multiple ways to use ports trees in
	<span class="application">Poudriere</span>.  The most
	straightforward way is to have
	<span class="application">Poudriere</span> create a default ports
	tree for itself, using either <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=portsnap&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">portsnap</span>(8)</span></a> (if running
	FreeBSD 12.1 or 11.4) or
	<span class="application">Subversion</span> (if running
	FreeBSD-CURRENT):</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>poudriere ports -c -m portsnap</code></strong></pre><p>or</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>poudriere ports -c -m svn+https</code></strong></pre><p>These commands create
	<code class="literal">tank/poudriere/ports/default</code>, mount it on
	<code class="filename">/poudriere/ports/default</code>, and populate it
	using either <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=portsnap&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">portsnap</span>(8)</span></a> or
	<span class="application">Subversion</span>.  Afterward it is
	included in the list of known ports trees:</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>poudriere ports -l</code></strong>
PORTSTREE METHOD    TIMESTAMP           PATH
default   svn+https 2020-07-20 04:23:56 /poudriere/ports/default</pre><div xmlns="" class="note"><h3 class="admontitle">Note: </h3><p xmlns="http://www.w3.org/1999/xhtml">Note that the <span class="quote">&#8220;<span class="quote">default</span>&#8221;</span> ports tree is
	  special.  Each of the build commands explained later will
	  implicitly use this ports tree unless specifically specified
	  otherwise.  To use another tree, add <code class="command">-p
	    <em class="replaceable"><code>treename</code></em></code> to the
	  commands.</p></div><p>While useful for regular bulk builds, having this default
	ports tree with the <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=portsnap&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">portsnap</span>(8)</span></a> method may not be the
	best way to deal with local modifications for a ports
	contributor.  As with the creation of jails, it is possible to
	use a different method for creating the ports tree.  To add an
	additional ports tree for testing local modifications and
	ports development, checking out the tree via
	<span class="application">Subversion</span> (as described above)
	is preferable.</p><div xmlns="" class="note"><h3 class="admontitle">Note: </h3><p xmlns="http://www.w3.org/1999/xhtml">The <acronym class="acronym">http</acronym> and <acronym class="acronym">https</acronym>
	  methods need <a xmlns="" class="package" href="https://www.freebsd.org/cgi/url.cgi?ports/devel/subversion/pkg-descr">devel/subversion</a>
	  built with the <code class="literal">SERF</code> option enabled.  It
	  is enabled by default.</p></div><div xmlns="" class="tip"><h3 class="admontitle">Tip: </h3><p xmlns="http://www.w3.org/1999/xhtml">The <code class="literal">svn</code> method allows extra
	  qualifiers to tell <span class="application">Subversion</span>
	  exactly how to fetch data.  This is explained in
	  <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=poudriere&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">poudriere</span>(8)</span></a>.  For instance, <code class="command">poudriere ports
	    -c -m svn+ssh -p subversive</code> uses
	  <span class="application">SSH</span> for the checkout.</p></div></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="testing-poudriere-ports-tree-manual"></a>10.5.6. Using Manually Managed Ports Trees with Poudriere</h3></div></div></div><p>Depending on the workflow, it can be extremely helpful to
	use ports trees which are maintained manually.  For instance,
	if there is a local copy of the ports tree in
	<code class="filename">/work/ports</code>, point
	<span class="application">Poudriere</span> to the location:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>For <span class="application">Poudriere</span> older than
	    version 3.1.20:</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>poudriere ports -c -F -f none -M /work/ports -p development</code></strong></pre></li><li class="listitem"><p>For <span class="application">Poudriere</span> version 3.1.20
	    and later:</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>poudriere ports -c -m null -M /work/ports -p development</code></strong></pre></li></ul></div><p>This will be listed in the table of known trees:</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>poudriere ports -l</code></strong>
PORTSTREE   METHOD    TIMESTAMP           PATH
development null      2020-07-20 05:06:33 /work/ports</pre><div xmlns="" class="note"><h3 class="admontitle">Note: </h3><p xmlns="http://www.w3.org/1999/xhtml">The dash or <code class="literal">null</code> in the <code class="literal">METHOD</code> column means
	  that <span class="application">Poudriere</span> will not update or
	  change this ports tree, ever.  It is completely up to the
	  user to maintain this tree, including all local
	  modifications that may be used for testing new ports and
	  submitting patches.</p></div></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="testing-poudriere-ports-tree-updating"></a>10.5.7. Keeping Poudriere Ports Trees Updated</h3></div></div></div><p>As straightforward as with jails described earlier:</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>poudriere ports -u -p <em class="replaceable"><code>PORTSTREE</code></em></code></strong></pre><p>Will update the given
	<em class="replaceable"><code>PORTSTREE</code></em>, one tree given by the
	output of <code class="command">poudriere -l</code>, to the latest
	revision available on the official servers.</p><div xmlns="" class="note"><h3 class="admontitle">Note: </h3><p xmlns="http://www.w3.org/1999/xhtml">Ports trees without a method, see <a class="xref" href="testing-poudriere.html#testing-poudriere-ports-tree-manual" title="10.5.6. Using Manually Managed Ports Trees with Poudriere">Section 10.5.6, &#8220;Using Manually Managed Ports Trees with Poudriere&#8221;</a>, cannot be
	  updated like this.  They must be updated manually by the
	  porter.</p></div></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="testing-poudriere-testing-ports"></a>10.5.8. Testing Ports</h3></div></div></div><p>After jails and ports trees have been set up, the result
	of a contributor's modifications to the ports tree can be
	tested.</p><p>For example, local modifications to the <a xmlns="" class="package" href="https://www.freebsd.org/cgi/url.cgi?ports/www/firefox/pkg-descr">www/firefox</a> port located in
	<code class="filename">/work/ports/www/firefox</code> can be tested in
	the previously created 11.3-RELEASE jail:</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>poudriere testport -j 113Ramd64 -p development -o www/firefox</code></strong></pre><p>This will build all dependencies of
	<span class="application">Firefox</span>.  If a dependency has been
	built previously and is still up-to-date, the pre-built
	package is installed.  If a dependency has no up-to-date
	package, one will be built with default options in a jail.
	Then <span class="application">Firefox</span> itself is
	built.</p><p>The complete build of every port is logged to
	<code class="filename">/poudriere/data/logs/bulk/113Ri386-development/<em class="replaceable"><code>build-time</code></em>/logs</code>.</p><p>The directory name <code class="literal">113Ri386-development</code>
	is derived from the arguments to <code class="literal">-j</code> and
	<code class="literal">-p</code>, respectively.  For convenience, a
	symbolic link
	<code class="filename">/poudriere/data/logs/bulk/113Ri386-development/latest</code>
	is also maintained.  The link points to the latest
	<em class="replaceable"><code>build-time</code></em> directory.  Also in this
	directory is an <code class="filename">index.html</code> for observing
	the build process with a web browser.</p><p>By default, <span class="application">Poudriere</span> cleans up
	the jails and leaves log files in the directories mentioned
	above.  To ease investigation, jails can be kept running after
	the build by adding <code class="option">-i</code> to
	<code class="command">testport</code>:</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>poudriere testport -j 113Ramd64 -p development -i -o www/firefox</code></strong></pre><p>After the build completes, and regardless of whether it
	was successful, a shell is provided within the jail.  The
	shell is used to investigate further.
	<span class="application">Poudriere</span> can be told to leave the
	jail running after the build finishes with
	<code class="option">-I</code>.  <span class="application">Poudriere</span>
	will show the command to run when the jail is no longer
	needed.  It is then possible to <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=jexec&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">jexec</span>(8)</span></a> into it:</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>poudriere testport -j 113Ramd64 -p development -I -o www/firefox</code></strong>
[...]
====&gt;&gt; Installing local Pkg repository to /usr/local/etc/pkg/repos
====&gt;&gt; Leaving jail 113Ramd64-development-n running, mounted at /poudriere/data/.m/113Ramd64-development/ref for interactive run testing
====&gt;&gt; To enter jail: jexec 113Ramd64-development-n env -i TERM=$TERM /usr/bin/login -fp root
====&gt;&gt; To stop jail: poudriere jail -k -j 113Ramd64 -p development
<code class="prompt">#</code> <strong class="userinput"><code>jexec 113Ramd64-development-n env -i TERM=$TERM /usr/bin/login -fp root</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code><em class="replaceable"><code>[do some stuff in the jail]</code></em></code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>exit</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>poudriere jail -k -j 113Ramd64 -p development</code></strong>
====&gt;&gt; Umounting file systems</pre><p>An integral part of the FreeBSD ports build infrastructure is
	the ability to tweak ports to personal preferences with
	options.  These can be tested with
	<span class="application">Poudriere</span> as well.  Adding the
	<code class="option">-c</code>:</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>poudriere testport -c -o www/firefox</code></strong></pre><p>Presents the port configuration dialog before the port is
	built.  The ports given after <code class="option">-o</code> in the
	format
	<code class="literal"><em class="replaceable"><code>category</code></em>/<em class="replaceable"><code>portname</code></em></code>
	will use the specified options, all dependencies will use the
	default options.  Testing dependent ports with non-default
	options can be accomplished using sets, see <a class="xref" href="testing-poudriere.html#testing-poudriere-sets" title="10.5.9. Using Sets">Section 10.5.9, &#8220;Using Sets&#8221;</a>.</p><div xmlns="" class="tip"><h3 class="admontitle">Tip: </h3><p xmlns="http://www.w3.org/1999/xhtml">When testing ports where <code class="filename">pkg-plist</code>
	  is altered during build depending on the selected options,
	  it is recommended to perform a test run with all options
	  selected <span class="emphasis"><em>and</em></span> one with all options
	  deselected.</p></div></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="testing-poudriere-sets"></a>10.5.9. Using Sets</h3></div></div></div><p>For all actions involving builds, a so-called
	<span class="emphasis"><em>set</em></span> can be specified using <code class="literal">-z
	  <em class="replaceable"><code>setname</code></em></code>.  A set refers
	to a fully independent build.  This allows, for instance,
	usage of <code class="command">testport</code> with non-standard options
	for the dependent ports.</p><p>To use sets, <span class="application">Poudriere</span> expects
	an existing directory structure similar to
	<code class="varname">PORT_DBDIR</code>, defaults to
	<code class="filename">/var/db/ports</code> in its configuration
	directory.  This directory is then <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=nullfs&amp;sektion=5&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">nullfs</span>(5)</span></a>-mounted into the
	jails where the ports and their dependencies are built.
	Usually a suitable starting point can be obtained by
	recursively copying the existing <code class="varname">PORT_DBDIR</code>
	to
	<code class="filename">/usr/local/etc/poudriere.d/<em class="replaceable"><code>jailname</code></em>-<em class="replaceable"><code>portname</code></em>-<em class="replaceable"><code>setname</code></em>-options</code>.
	This is described in detail in <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=poudriere&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">poudriere</span>(8)</span></a>.  For
	instance, testing <a xmlns="" class="package" href="https://www.freebsd.org/cgi/url.cgi?ports/www/firefox/pkg-descr">www/firefox</a>
	in a specific set named <code class="literal">devset</code>, add the
	<code class="literal">-z devset</code> parameter to the testport
	command:</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>poudriere testport -j 113Ramd64 -p development -z devset -o www/firefox</code></strong></pre><p>This will look for the existence of these directories in
	this order:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p><code class="filename">/usr/local/etc/poudriere.d/113Ramd64-development-devset-options</code></p></li><li class="listitem"><p><code class="filename">/usr/local/etc/poudriere.d/113Ramd64-devset-options</code></p></li><li class="listitem"><p><code class="filename">/usr/local/etc/poudriere.d/113Ramd64-development-options</code></p></li><li class="listitem"><p><code class="filename">/usr/local/etc/poudriere.d/devset-options</code></p></li><li class="listitem"><p><code class="filename">/usr/local/etc/poudriere.d/development-options</code></p></li><li class="listitem"><p><code class="filename">/usr/local/etc/poudriere.d/113Ramd64-options</code></p></li><li class="listitem"><p><code class="filename">/usr/local/etc/poudriere.d/options</code></p></li></ul></div><p>From this list, <span class="application">Poudriere</span>
	<a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=nullfs&amp;sektion=5&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">nullfs</span>(5)</span></a>-mounts the <span class="emphasis"><em>first existing</em></span>
	directory tree into the <code class="filename">/var/db/ports</code>
	directory of the build jails.  Hence, all custom options are
	used for all the ports during this run of
	<code class="command">testport</code>.</p><p>After the directory structure for a set is provided, the
	options for a particular port can be altered.  For
	example:</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>poudriere options -c www/firefox -z devset</code></strong></pre><p>The configuration dialog for <a xmlns="" class="package" href="https://www.freebsd.org/cgi/url.cgi?ports/www/firefox/pkg-descr">www/firefox</a> is shown, and options can
	be edited.  The selected options are saved to the
	<code class="literal">devset</code> set.</p><div xmlns="" class="note"><h3 class="admontitle">Note: </h3><p xmlns="http://www.w3.org/1999/xhtml"><span class="application">Poudriere</span> is very flexible in
	  the option configuration.  They can be set for particular
	  jails, ports trees, and for multiple ports by one command.
	  Refer to <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=poudriere&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">poudriere</span>(8)</span></a> for details.</p></div></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="testing-poudriere-make-conf"></a>10.5.10. Providing a Custom <code class="filename">make.conf</code>
	File</h3></div></div></div><p>Similar to using sets,
	<span class="application">Poudriere</span> will also use a custom
	<code class="filename">make.conf</code> if it is provided.  No special
	command line argument is necessary.  Instead,
	<span class="application">Poudriere</span> looks for existing files
	matching a name scheme derived from the command line.  For
	instance:</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>poudriere testport -j 113Ramd64 -p development -z devset -o www/firefox</code></strong></pre><p>causes <span class="application">Poudriere</span> to check for
	the existence of these files in this order:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p><code class="filename">/usr/local/etc/poudriere.d/make.conf</code></p></li><li class="listitem"><p><code class="filename">/usr/local/etc/poudriere.d/devset-make.conf</code></p></li><li class="listitem"><p><code class="filename">/usr/local/etc/poudriere.d/development-make.conf</code></p></li><li class="listitem"><p><code class="filename">/usr/local/etc/poudriere.d/113Ramd64-make.conf</code></p></li><li class="listitem"><p><code class="filename">/usr/local/etc/poudriere.d/113Ramd64-development-make.conf</code></p></li><li class="listitem"><p><code class="filename">/usr/local/etc/poudriere.d/113Ramd64-devset-make.conf</code></p></li><li class="listitem"><p><code class="filename">/usr/local/etc/poudriere.d/113Ramd64-development-devset-make.conf</code></p></li></ul></div><p>Unlike with sets, all of the found files will be appended,
	<span class="emphasis"><em>in that order</em></span>, into one
	<code class="filename">make.conf</code> inside the build jails.  It is
	hence possible to have general make variables, intended to
	affect all builds in
	<code class="filename">/usr/local/etc/poudriere.d/make.conf</code>.
	Special variables, intended to affect only certain jails or
	sets can be set in specialised <code class="filename">make.conf</code>
	files, such as
	<code class="filename">/usr/local/etc/poudriere.d/113Ramd64-development-devset-make.conf</code>.</p><div class="example"><a id="testing-poudriere-sets-perl"></a><div class="example-title">Example 10.1. Using <code class="filename">make.conf</code> to Change Default
	  <span class="application">Perl</span></div><div class="example-contents"><p>To build a set with a non default
	  <span class="application">Perl</span> version, for example,
	  <code class="literal">5.20</code>, using a set named
	  <code class="literal">perl5-20</code>, create a
	  <code class="filename">perl5-20-make.conf</code> with this
	  line:</p><pre class="programlisting">DEFAULT_VERSIONS+= perl=5.20</pre><div xmlns="" class="note"><h3 class="admontitle">Note: </h3><p xmlns="http://www.w3.org/1999/xhtml">Note the use of <code class="literal">+=</code> so that if the
	    variable is already set in the default
	    <code class="filename">make.conf</code> its content will not be
	    overwritten.</p></div></div></div><br class="example-break" /></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="testing-poudriere-pruning-distfiles"></a>10.5.11. Pruning no Longer Needed Distfiles</h3></div></div></div><p><span class="application">Poudriere</span> comes with a built-in
	mechanism to remove outdated distfiles that are no longer used
	by any port of a given tree.  The command</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>poudriere distclean -p <em class="replaceable"><code>portstree</code></em></code></strong></pre><p>will scan the distfiles folder,
	<code class="varname">DISTFILES_CACHE</code> in
	<code class="filename">poudriere.conf</code>, versus the ports tree
	given by the <code class="literal">-p
	  <em class="replaceable"><code>portstree</code></em></code> argument and
	prompt for removal of those distfiles.  To skip the prompt and
	remove all unused files unconditionally, the
	<code class="literal">-y</code> argument can be added:</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>poudriere distclean -p <em class="replaceable"><code>portstree</code></em> -y</code></strong></pre></div></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="porting-prefix.html">Prev</a> </td><td width="20%" align="center"><a accesskey="u" href="testing.html">Up</a></td><td width="40%" align="right"> <a accesskey="n" href="port-upgrading.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top">10.4. <code class="varname">PREFIX</code> and
      <code class="varname">DESTDIR</code> </td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right" valign="top"> Chapter 11. Upgrading a Port</td></tr></table></div><p xmlns="" align="center"><small>All FreeBSD documents are available for download
    at <a href="https://download.freebsd.org/ftp/doc/">https://download.freebsd.org/ftp/doc/</a></small></p><p xmlns="" align="center"><small>Questions that are not answered by the
    <a href="https://www.FreeBSD.org/docs.html">documentation</a> may be
    sent to &lt;<a href="mailto:freebsd-questions@FreeBSD.org">freebsd-questions@FreeBSD.org</a>&gt;.<br />
    Send questions about this document to &lt;<a href="mailto:freebsd-doc@FreeBSD.org">freebsd-doc@FreeBSD.org</a>&gt;.</small></p></body></html>