<?xml version="1.0" encoding="iso-8859-1" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" /><title>6.26. Starting and Stopping Services (rc Scripts)</title><link rel="stylesheet" type="text/css" href="docbook.css" /><link rev="made" href="mailto:doc@FreeBSD.org" /><meta name="generator" content="DocBook XSL Stylesheets V1.79.1" /><link rel="home" href="index.html" title="FreeBSD Porter's Handbook" /><link rel="up" href="special.html" title="Chapter 6. Special Considerations" /><link rel="prev" href="using-databases.html" title="6.25. Using Databases" /><link rel="next" href="users-and-groups.html" title="6.27. Adding Users and Groups" /><link rel="copyright" href="legalnotice.html" title="Copyright" /><script xmlns="" type="text/javascript" src="/layout/js/google.js"></script></head><body><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">6.26. Starting and Stopping Services (<code class="literal">rc</code>
      Scripts)</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="using-databases.html">Prev</a> </td><th width="60%" align="center">Chapter 6. Special Considerations</th><td width="20%" align="right"> <a accesskey="n" href="users-and-groups.html">Next</a></td></tr></table><hr /></div><div class="sect1"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="rc-scripts"></a>6.26. Starting and Stopping Services (<code class="literal">rc</code>
      Scripts)</h2></div></div></div><p><code class="filename">rc.d</code> scripts are used to start
      services on system startup, and to give administrators a
      standard way of stopping, starting and restarting the service.
      Ports integrate into the system <code class="filename">rc.d</code>
      framework.  Details on its usage can be found in <a class="link" href="../../../../doc/en_US.ISO8859-1/books/handbook/configtuning-rcd.html" target="_top">the
	rc.d Handbook chapter</a>.  Detailed explanation of
      the available commands is provided in <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=rc&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">rc</span>(8)</span></a> and
      <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=rc.subr&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">rc.subr</span>(8)</span></a>.  Finally, there is
      <a class="link" href="../../../../doc/en_US.ISO8859-1/articles/rc-scripting" target="_top">an
	article</a> on practical aspects of
      <code class="filename">rc.d</code> scripting.</p><p>With a mythical port called
      <em class="replaceable"><code>doorman</code></em>, which needs to start a
      <em class="replaceable"><code>doormand</code></em> daemon.  Add the following
      to the <code class="filename">Makefile</code>:</p><pre class="programlisting">USE_RC_SUBR=	<em class="replaceable"><code>doormand</code></em></pre><p>Multiple scripts may be listed and will be installed.
      Scripts must be placed in the <code class="filename">files</code>
      subdirectory and a <code class="literal">.in</code> suffix must be added
      to their filename.  Standard <code class="varname">SUB_LIST</code>
      expansions will be ran against this file.  Use of the
      <code class="literal">%%PREFIX%%</code> and
      <code class="literal">%%LOCALBASE%%</code> expansions is strongly
      encouraged as well.  More on <code class="varname">SUB_LIST</code> in
      <a class="link" href="using-sub-files.html" title="9.5. Making Use of SUB_FILES and SUB_LIST">the relevant
	section</a>.</p><p>As of FreeBSD 6.1-RELEASE, local
      <code class="filename">rc.d</code> scripts (including those installed
      by ports) are included in the overall <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=rcorder&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">rcorder</span>(8)</span></a> of the
      base system.</p><p>An example simple <code class="filename">rc.d</code> script to start
      the doormand daemon:</p><pre class="programlisting">#!/bin/sh

# $FreeBSD$
#
# PROVIDE: <em class="replaceable"><code>doormand</code></em>
# REQUIRE: LOGIN
# KEYWORD: shutdown
#
# Add these lines to /etc/rc.conf.local or /etc/rc.conf
# to enable this service:
#
# <em class="replaceable"><code>doormand</code></em>_enable (bool):	Set to NO by default.
#				Set it to YES to enable <em class="replaceable"><code>doormand</code></em>.
# <em class="replaceable"><code>doormand</code></em>_config (path):	Set to %%PREFIX%%/etc/<em class="replaceable"><code>doormand/doormand.cf</code></em>
#				by default.

. /etc/rc.subr

name=<em class="replaceable"><code>doormand</code></em>
rcvar=<em class="replaceable"><code>doormand</code></em>_enable

load_rc_config $name

: ${<em class="replaceable"><code>doormand</code></em>_enable:="NO"}
: ${<em class="replaceable"><code>doormand</code></em>_config="%%PREFIX%%/etc/<em class="replaceable"><code>doormand/doormand.cf</code></em>"}

command=%%PREFIX%%/sbin/${name}
pidfile=/var/run/${name}.pid

command_args="<em class="replaceable"><code>-p $pidfile -f $doormand_config</code></em>"

run_rc_command "$1"</pre><p>Unless there is a very good reason to start the service
      earlier, or it runs as a particular user (other than root), all
      ports scripts must use:</p><pre class="programlisting">REQUIRE: LOGIN</pre><p>If the startup script launches a daemon that must be
      shutdown, the following will trigger a stop of the service on
      system shutdown:</p><pre class="programlisting">KEYWORD: shutdown</pre><p>If the script is not starting a persistent service this is
      not necessary.</p><p>For optional configuration elements the "="
      style of default variable assignment is preferable to the
      ":=" style here, since the former sets a default
      value only if the variable is unset, and the latter sets one
      if the variable is unset <span class="emphasis"><em>or</em></span> null.  A user
      might very well include something like:</p><pre class="programlisting"><em class="replaceable"><code>doormand</code></em>_flags=""</pre><p>in their <code class="filename">rc.conf.local</code>, and a
      variable substitution using ":=" would
      inappropriately override the user's intention.  The
      <code class="literal">_enable</code> variable is not optional,
      and must use the ":" for the default.</p><div xmlns="" class="important"><h3 class="admontitle">Important: </h3><p xmlns="http://www.w3.org/1999/xhtml">Ports <span class="emphasis"><em>must not</em></span> start and stop
	their services when installing and deinstalling.  Do not abuse
	the <code class="filename">plist</code> keywords described in <a class="xref" href="plist-keywords.html#plist-keywords-base-exec" title="8.6.13.2. @preexec command, @postexec command, @preunexec command, @postunexec command">Section 8.6.13.2, &#8220;<code class="literal">@preexec</code>
	  <em class="replaceable"><code>command</code></em>,
	  <code class="literal">@postexec</code>
	  <em class="replaceable"><code>command</code></em>,
	  <code class="literal">@preunexec</code>
	  <em class="replaceable"><code>command</code></em>,
	  <code class="literal">@postunexec</code>
	  <em class="replaceable"><code>command</code></em>&#8221;</a> by running commands
	that modify the currently running system, including starting
	or stopping services.</p></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="rc-scripts-checklist"></a>6.26.1. Pre-Commit Checklist</h3></div></div></div><p>Before contributing a port with an
	<code class="filename">rc.d</code> script, and more importantly,
	before committing one, please consult this
	checklist to be sure that it is ready.</p><p>The <a xmlns="" class="package" href="https://www.freebsd.org/cgi/url.cgi?ports/devel/rclint/pkg-descr">devel/rclint</a>
	port can check for most of these, but it is not a
	substitute for proper review.</p><div class="procedure"><ol class="procedure" type="1"><li class="step"><p>If this is a new file, does it have a
	    <code class="filename">.sh</code> extension?  If so, that must be
	    changed to just
	    <code class="filename"><em class="replaceable"><code>file</code></em>.in</code>
	    since <code class="filename">rc.d</code> files may not end with
	    that extension.</p></li><li class="step"><p>Does the file have a
	    <code class="literal">$FreeBSD$</code> tag?</p></li><li class="step"><p>Do the name of the file (minus
	    <code class="filename">.in</code>), the
	    <code class="literal">PROVIDE</code> line, and
	    <code class="literal">$</code><em class="replaceable"><code>name</code></em>
	    all match?  The file name matching
	    <code class="literal">PROVIDE</code> makes debugging easier,
	    especially for <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=rcorder&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">rcorder</span>(8)</span></a> issues.  Matching the
	    file name and
	    <code class="literal">$</code><em class="replaceable"><code>name</code></em>
	    makes it easier to figure out which variables are
	    relevant in <code class="filename">rc.conf[.local]</code>.  It is
	    also a policy
	    for all new scripts, including those in the base
	    system.</p></li><li class="step"><p>Is the <code class="literal">REQUIRE</code> line set to
	    <code class="literal">LOGIN</code>?  This is mandatory for scripts
	    that run as a non-root user.  If it runs as root, is
	    there a good reason for it to run prior to
	    <code class="literal">LOGIN</code>?  If not, it must run after
	    so that local scrips can be loosely grouped to a point in
	    <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=rcorder&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">rcorder</span>(8)</span></a> after most everything in the base is
	    already running.</p></li><li class="step"><p>Does the script start a persistent service?  If so,
	    it must have <code class="literal">KEYWORD:
	      shutdown</code>.</p></li><li class="step"><p>Make sure there is no
	    <code class="literal">KEYWORD: FreeBSD</code> present.  This has
	    not been necessary nor desirable for years.  It is also
	    an indication that the new script was copy/pasted from
	    an old script, so extra caution must be given to the
	    review.</p></li><li class="step"><p>If the script uses an interpreted language like
	    <code class="command">perl</code>, <code class="command">python</code>, or
	    <code class="command">ruby</code>, make certain that
	    <code class="varname">command_interpreter</code> is set
	    appropriately, for example, for
	    <span class="application">Perl</span>, by adding
	    <code class="literal">PERL=${PERL}</code> to
	    <code class="varname">SUB_LIST</code> and using
	    <code class="literal">%%PERL%%</code>.  Otherwise,</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>service <em class="replaceable"><code>name</code></em> stop</code></strong></pre><p>will probably not work properly.  See
	    <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=service&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">service</span>(8)</span></a> for more information.</p></li><li class="step"><p>Have all occurrences of
	    <code class="filename">/usr/local</code> been replaced with
	    <code class="literal">%%PREFIX%%</code>?</p></li><li class="step"><p>Do the default variable assignments come after
	    <code class="function">load_rc_config</code>?</p></li><li class="step"><p>Are there default assignments to empty strings?
	    They should be removed, but double-check that the option
	    is documented in the comments at the top of the
	    file.</p></li><li class="step"><p>Are things that are set in variables actually used
	    in the script?</p></li><li class="step"><p>Are options listed in the default
	    <em class="replaceable"><code>name</code></em><code class="varname">_flags</code>
	    things that are actually mandatory?  If so, they must
	    be in <code class="varname">command_args</code>.
	    <code class="option">-d</code> is a red flag (pardon the
	    pun) here, since it is usually the option to
	    &#8220;daemonize&#8221; the process, and therefore is
	    actually mandatory.</p></li><li class="step"><p><code class="varname"><em class="replaceable"><code>name</code></em>_flags</code>
	    must never be included in
	    <code class="varname">command_args</code> (and vice versa,
	    although that error is less common).</p></li><li class="step"><p>Does the script execute any code unconditionally?
	    This is frowned on.  Usually these things must be
	    dealt with through a
	    <code class="function">start_precmd</code>.</p></li><li class="step"><p>All boolean tests must use the
	    <code class="function">checkyesno</code> function.  No
	    hand-rolled tests for <code class="literal">[Yy][Ee][Ss]</code>,
	    etc.</p></li><li class="step"><p>If there is a loop (for example, waiting for
	    something to start) does it have a counter to terminate
	    the loop?  We do not want the boot to be stuck forever
	    if there is an error.</p></li><li class="step"><p>Does the script create files or directories that
	    need specific permissions, for example, a
	    <code class="filename">pid</code> that needs to be owned by
	    the user that runs the process?  Rather than the
	    traditional <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=touch&amp;sektion=1&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">touch</span>(1)</span></a>/<a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=chown&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">chown</span>(8)</span></a>/<a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=chmod&amp;sektion=1&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">chmod</span>(1)</span></a>
	    routine, consider using <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=install&amp;sektion=1&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">install</span>(1)</span></a> with the proper
	    command line arguments to do the whole procedure with
	    one step.</p></li></ol></div></div></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="using-databases.html">Prev</a> </td><td width="20%" align="center"><a accesskey="u" href="special.html">Up</a></td><td width="40%" align="right"> <a accesskey="n" href="users-and-groups.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top">6.25. Using Databases </td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right" valign="top"> 6.27. Adding Users and Groups</td></tr></table></div><p xmlns="" align="center"><small>All FreeBSD documents are available for download
    at <a href="https://download.freebsd.org/ftp/doc/">https://download.freebsd.org/ftp/doc/</a></small></p><p xmlns="" align="center"><small>Questions that are not answered by the
    <a href="https://www.FreeBSD.org/docs.html">documentation</a> may be
    sent to &lt;<a href="mailto:freebsd-questions@FreeBSD.org">freebsd-questions@FreeBSD.org</a>&gt;.<br />
    Send questions about this document to &lt;<a href="mailto:freebsd-doc@FreeBSD.org">freebsd-doc@FreeBSD.org</a>&gt;.</small></p></body></html>