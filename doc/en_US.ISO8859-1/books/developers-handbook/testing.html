<?xml version="1.0" encoding="iso-8859-1" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" /><title>Chapter 6. Regression and Performance Testing</title><link rel="stylesheet" type="text/css" href="docbook.css" /><link rev="made" href="mailto:doc@FreeBSD.org" /><meta name="generator" content="DocBook XSL Stylesheets V1.79.1" /><link rel="home" href="index.html" title="FreeBSD Developers' Handbook" /><link rel="up" href="Basics.html" title="Part I. Basics" /><link rel="prev" href="policies-shlib.html" title="5.5. Shared Libraries" /><link rel="next" href="testing-tinderbox.html" title="6.2. The FreeBSD Source Tinderbox" /><link rel="copyright" href="legalnotice.html" title="Copyright" /><script xmlns="" type="text/javascript" src="/layout/js/google.js"></script></head><body><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">Chapter 6. Regression and Performance Testing</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="policies-shlib.html">Prev</a> </td><th width="60%" align="center">Part I. Basics</th><td width="20%" align="right"> <a accesskey="n" href="testing-tinderbox.html">Next</a></td></tr></table><hr /></div><div class="chapter"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="testing"></a>Chapter 6. Regression and Performance Testing</h2></div></div></div><div class="toc"><div class="toc-title">Table of Contents</div><dl class="toc"><dt><span class="section"><a href="testing.html#testing-micro-benchmark">6.1. Micro Benchmark Checklist</a></span></dt><dt><span class="section"><a href="testing-tinderbox.html">6.2. The FreeBSD Source Tinderbox</a></span></dt></dl></div><p>Regression tests are used to exercise a particular bit of the
    system to check that it works as expected, and to make sure that
    old bugs are not reintroduced.</p><p>The FreeBSD regression testing tools can be found in the FreeBSD
    source tree in the directory
    <code class="filename">src/tools/regression</code>.</p><div class="section"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="testing-micro-benchmark"></a>6.1. Micro Benchmark Checklist</h2></div></div></div><p>This section contains hints for doing proper
      micro-benchmarking on FreeBSD or of FreeBSD itself.</p><p>It is not possible to use all of the suggestions below every
      single time, but the more used, the better the benchmark's
      ability to test small differences will be.</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Disable <acronym class="acronym">APM</acronym> and any other kind of
	  clock fiddling (<acronym class="acronym">ACPI</acronym> ?).</p></li><li class="listitem"><p>Run in single user mode.  E.g., <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=cron&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">cron</span>(8)</span></a>, and other
	  daemons only add noise.  The <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=sshd&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">sshd</span>(8)</span></a> daemon can also
	  cause problems.  If ssh access is required during testing
	  either disable the SSHv1 key regeneration, or kill the
	  parent <code class="command">sshd</code> daemon during the
	  tests.</p></li><li class="listitem"><p>Do not run <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=ntpd&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">ntpd</span>(8)</span></a>.</p></li><li class="listitem"><p>If <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=syslog&amp;sektion=3&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">syslog</span>(3)</span></a> events are generated, run
	  <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=syslogd&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">syslogd</span>(8)</span></a> with an empty
	  <code class="filename">/etc/syslogd.conf</code>, otherwise, do not
	  run it.</p></li><li class="listitem"><p>Minimize disk-I/O, avoid it entirely if possible.</p></li><li class="listitem"><p>Do not mount file systems that are not needed.</p></li><li class="listitem"><p>Mount <code class="filename">/</code>,
	  <code class="filename">/usr</code>, and any other
	  file system as read-only if possible.  This removes atime
	  updates to disk (etc.) from the I/O picture.</p></li><li class="listitem"><p>Reinitialize the read/write test file system with
	  <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=newfs&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">newfs</span>(8)</span></a> and populate it from a <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=tar&amp;sektion=1&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">tar</span>(1)</span></a> or
	  <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=dump&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">dump</span>(8)</span></a> file before every run.  Unmount and mount it
	  before starting the test.  This results in a consistent file
	  system layout.  For a worldstone test this would apply to
	  <code class="filename">/usr/obj</code> (just
	  reinitialize with <code class="command">newfs</code> and mount).  To
	  get 100% reproducibility, populate the file system from a
	  <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=dd&amp;sektion=1&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">dd</span>(1)</span></a> file (i.e.: <code class="command">dd
	    if=myimage of=/dev/ad0s1h
	    bs=1m</code>)</p></li><li class="listitem"><p>Use malloc backed or preloaded <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=md&amp;sektion=4&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">md</span>(4)</span></a>
	  partitions.</p></li><li class="listitem"><p>Reboot between individual iterations of the test, this
	  gives a more consistent state.</p></li><li class="listitem"><p>Remove all non-essential device drivers from the kernel.
	  For instance if USB is not needed for the test, do not put
	  USB in the kernel.  Drivers which attach often have timeouts
	  ticking away.</p></li><li class="listitem"><p>Unconfigure hardware that are not in use.  Detach disks
	  with <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=atacontrol&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">atacontrol</span>(8)</span></a> and <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=camcontrol&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">camcontrol</span>(8)</span></a> if the disks
	  are not used for the test.</p></li><li class="listitem"><p>Do not configure the network unless it is being tested,
	  or wait until after the test has been performed to ship the
	  results off to another computer.</p><p>If the system must be connected to a public network,
	  watch out for spikes of broadcast traffic.  Even though it
	  is hardly noticeable, it will take up CPU cycles.  Multicast
	  has similar caveats.</p></li><li class="listitem"><p>Put each file system on its own disk.  This minimizes
	  jitter from head-seek optimizations.</p></li><li class="listitem"><p>Minimize output to serial or VGA consoles.  Running
	  output into files gives less jitter.  (Serial consoles
	  easily become a bottleneck.)  Do not touch keyboard while
	  the test is running, even <span class="keycap"><strong>space</strong></span> or
	  <span class="keycap"><strong>back-space</strong></span> shows up in the numbers.</p></li><li class="listitem"><p>Make sure the test is long enough, but not too long.  If
	  the test is too short, timestamping is a problem.  If it is
	  too long temperature changes and drift will affect the
	  frequency of the quartz crystals in the computer.  Rule of
	  thumb: more than a minute, less than an hour.</p></li><li class="listitem"><p>Try to keep the temperature as stable as possible around
	  the machine.  This affects both quartz crystals and disk
	  drive algorithms.  To get real stable clock, consider
	  stabilized clock injection.  E.g., get a OCXO + PLL, inject
	  output into clock circuits instead of motherboard xtal.
	  Contact Poul-Henning Kamp <code class="email">&lt;<a xmlns="" class="email" href="mailto:phk@FreeBSD.org">phk@FreeBSD.org</a>&gt;</code> for more information about
	  this.</p></li><li class="listitem"><p>Run the test at least 3 times but it is better to run
	  more than 20 times both for <span class="quote">&#8220;<span class="quote">before</span>&#8221;</span> and
	  <span class="quote">&#8220;<span class="quote">after</span>&#8221;</span> code.  Try to interleave if possible
	  (i.e.: do not run 20 times before then 20 times after), this
	  makes it possible to spot environmental effects.  Do not
	  interleave 1:1, but 3:3, this makes it possible to spot
	  interaction effects.</p><p>A good pattern is: <code class="literal">bababa{bbbaaa}*</code>.
	  This gives hint after the first 1+1 runs (so it is possible
	  to stop the test if it goes entirely the wrong way), a
	  standard deviation after the first 3+3 (gives a good
	  indication if it is going to be worth a long run) and
	  trending and interaction numbers later on.</p></li><li class="listitem"><p>Use <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=ministat&amp;sektion=1&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">ministat</span>(1)</span></a>
	  to see if the numbers are significant.  Consider buying
	  <span class="quote">&#8220;<span class="quote">Cartoon guide to statistics</span>&#8221;</span> ISBN:
	  0062731025, highly recommended, if you have forgotten or
	  never learned about standard deviation and Student's
	  T.</p></li><li class="listitem"><p>Do not use background <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=fsck&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">fsck</span>(8)</span></a> unless the test is a
	  benchmark of background <code class="command">fsck</code>.  Also,
	  disable <code class="varname">background_fsck</code> in
	  <code class="filename">/etc/rc.conf</code> unless the benchmark is
	  not started at least 60+<span class="quote">&#8220;<span class="quote"><code class="command">fsck</code>
	    runtime</span>&#8221;</span> seconds after the boot, as <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=rc&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">rc</span>(8)</span></a>
	  wakes up and checks if <code class="command">fsck</code> needs to run
	  on any file systems when background <code class="command">fsck</code>
	  is enabled.  Likewise, make sure there are no snapshots
	  lying around unless the benchmark is a test with
	  snapshots.</p></li><li class="listitem"><p>If the benchmark show unexpected bad performance, check
	  for things like high interrupt volume from an unexpected
	  source.  Some versions of <acronym class="acronym">ACPI</acronym> have been
	  reported to <span class="quote">&#8220;<span class="quote">misbehave</span>&#8221;</span> and generate excess
	  interrupts.  To help diagnose odd test results, take a few
	  snapshots of <code class="command">vmstat -i</code> and look for
	  anything unusual.</p></li><li class="listitem"><p>Make sure to be careful about optimization parameters
	  for kernel and userspace, likewise debugging.  It is easy to
	  let something slip through and realize later the test was
	  not comparing the same thing.</p></li><li class="listitem"><p>Do not ever benchmark with the
	  <code class="literal">WITNESS</code> and <code class="literal">INVARIANTS</code>
	  kernel options enabled unless the test is interested to
	  benchmarking those features.  <code class="literal">WITNESS</code> can
	  cause 400%+ drops in performance.  Likewise, userspace
	  <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=malloc&amp;sektion=3&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">malloc</span>(3)</span></a> parameters default differently in -CURRENT
	  from the way they ship in production releases.</p></li></ul></div></div></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="policies-shlib.html">Prev</a> </td><td width="20%" align="center"><a accesskey="u" href="Basics.html">Up</a></td><td width="40%" align="right"> <a accesskey="n" href="testing-tinderbox.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top">5.5. Shared Libraries </td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right" valign="top"> 6.2. The FreeBSD Source Tinderbox</td></tr></table></div><p xmlns="" align="center"><small>All FreeBSD documents are available for download
    at <a href="https://download.freebsd.org/ftp/doc/">https://download.freebsd.org/ftp/doc/</a></small></p><p xmlns="" align="center"><small>Questions that are not answered by the
    <a href="https://www.FreeBSD.org/docs.html">documentation</a> may be
    sent to &lt;<a href="mailto:freebsd-questions@FreeBSD.org">freebsd-questions@FreeBSD.org</a>&gt;.<br />
    Send questions about this document to &lt;<a href="mailto:freebsd-doc@FreeBSD.org">freebsd-doc@FreeBSD.org</a>&gt;.</small></p></body></html>