<?xml version="1.0" encoding="iso-8859-1" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" /><title>10.7. Kernel debugging with Dcons</title><link rel="stylesheet" type="text/css" href="docbook.css" /><link rev="made" href="mailto:doc@FreeBSD.org" /><meta name="generator" content="DocBook XSL Stylesheets V1.79.1" /><link rel="home" href="index.html" title="FreeBSD Developers' Handbook" /><link rel="up" href="kerneldebug.html" title="Chapter 10. Kernel Debugging" /><link rel="prev" href="kerneldebug-deadlocks.html" title="10.6. Debugging Deadlocks" /><link rel="next" href="kerneldebug-options.html" title="10.8. Glossary of Kernel Options for Debugging" /><link rel="copyright" href="legalnotice.html" title="Copyright" /><script xmlns="" type="text/javascript" src="/layout/js/google.js"></script></head><body><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">10.7. Kernel debugging with Dcons</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="kerneldebug-deadlocks.html">Prev</a> </td><th width="60%" align="center">Chapter 10. Kernel Debugging</th><td width="20%" align="right"> <a accesskey="n" href="kerneldebug-options.html">Next</a></td></tr></table><hr /></div><div class="sect1"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="kerneldebug-dcons"></a>10.7. Kernel debugging with Dcons</h2></div></div></div><p><a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=dcons&amp;sektion=4&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">dcons</span>(4)</span></a> is a very simple console driver that is
      not directly connected with any physical devices.  It just reads
      and writes characters from and to a buffer in a kernel or
      loader.  Due to its simple nature, it is very useful for kernel
      debugging, especially with a <span class="trademark">FireWire</span>® device.  Currently, FreeBSD
      provides two ways to interact with the buffer from outside of
      the kernel using <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=dconschat&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">dconschat</span>(8)</span></a>.</p><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp53067640"></a>10.7.1. Dcons over <span class="trademark">FireWire</span>®</h3></div></div></div><p>Most <span class="trademark">FireWire</span>® (IEEE1394) host controllers are
	based on the <acronym class="acronym">OHCI</acronym> specification that
	supports physical access to the host memory.  This means that
	once the host controller is initialized, we can access the
	host memory without the help of software (kernel).   We can
	exploit this facility for interaction with <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=dcons&amp;sektion=4&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">dcons</span>(4)</span></a>.
	<a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=dcons&amp;sektion=4&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">dcons</span>(4)</span></a> provides similar functionality as a serial
	console.  It emulates two serial ports, one for the console
	and <acronym class="acronym">DDB</acronym>, the other for
	<acronym class="acronym">GDB</acronym>.  Because remote memory access is fully
	handled by the hardware, the <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=dcons&amp;sektion=4&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">dcons</span>(4)</span></a> buffer is
	accessible even when the system crashes.</p><p><span class="trademark">FireWire</span>® devices are not limited to those
	integrated into motherboards.  <acronym class="acronym">PCI</acronym> cards
	exist for desktops, and a cardbus interface can be purchased
	for laptops.</p><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp53074168"></a>10.7.1.1. Enabling <span class="trademark">FireWire</span>® and Dcons support on the target
	  machine</h4></div></div></div><p>To enable <span class="trademark">FireWire</span>® and Dcons support in the kernel of
	  the <span class="emphasis"><em>target machine</em></span>:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Make sure your kernel supports
	      <code class="literal">dcons</code>, <code class="literal">dcons_crom</code>
	      and <code class="literal">firewire</code>.
	      <code class="literal">Dcons</code> should be statically linked
	      with the kernel.  For <code class="literal">dcons_crom</code> and
	      <code class="literal">firewire</code>, modules should be
	      OK.</p></li><li class="listitem"><p>Make sure physical <acronym class="acronym">DMA</acronym> is enabled.
	      You may need to add
	      <code class="literal">hw.firewire.phydma_enable=1</code> to
	      <code class="filename">/boot/loader.conf</code>.</p></li><li class="listitem"><p>Add options for debugging.</p></li><li class="listitem"><p>Add <code class="literal">dcons_gdb=1</code> in
	      <code class="filename">/boot/loader.conf</code> if you use GDB
	      over <span class="trademark">FireWire</span>®.</p></li><li class="listitem"><p>Enable <code class="literal">dcons</code> in
	      <code class="filename">/etc/ttys</code>.</p></li><li class="listitem"><p>Optionally, to force <code class="literal">dcons</code> to
	      be the high-level console, add 
	      <code class="literal">hw.firewire.dcons_crom.force_console=1</code> 
	      to <code class="filename">loader.conf</code>.</p></li></ul></div><p>To enable <span class="trademark">FireWire</span>® and Dcons support in <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=loader&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">loader</span>(8)</span></a>
	  on i386 or amd64:</p><p>Add
	  <code class="literal">LOADER_FIREWIRE_SUPPORT=YES</code> in
	  <code class="filename">/etc/make.conf</code> and rebuild
	  <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=loader&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">loader</span>(8)</span></a>:</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>cd /sys/boot/i386 &amp;&amp; make clean &amp;&amp; make &amp;&amp; make install</code></strong></pre><p>To enable <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=dcons&amp;sektion=4&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">dcons</span>(4)</span></a> as an active low-level
	  console, add <code class="literal">boot_multicons="YES"</code> to 
	  <code class="filename">/boot/loader.conf</code>.</p><p>Here are a few configuration examples.  A sample kernel
	  configuration file would contain:</p><pre class="screen">device dcons
device dcons_crom
options KDB
options DDB
options GDB
options ALT_BREAK_TO_DEBUGGER</pre><p>And a sample <code class="filename">/boot/loader.conf</code>
	  would contain:</p><pre class="screen">dcons_crom_load="YES"
dcons_gdb=1
boot_multicons="YES"
hw.firewire.phydma_enable=1
hw.firewire.dcons_crom.force_console=1</pre></div><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp53117304"></a>10.7.1.2. Enabling <span class="trademark">FireWire</span>® and Dcons support on the host
	  machine</h4></div></div></div><p>To enable <span class="trademark">FireWire</span>® support in the kernel on the
	  <span class="emphasis"><em>host machine</em></span>:</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>kldload firewire</code></strong></pre><p>Find out the <acronym class="acronym">EUI64</acronym> (the unique 64
	  bit identifier) of the <span class="trademark">FireWire</span>® host controller, and
	  use <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=fwcontrol&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">fwcontrol</span>(8)</span></a> or <code class="command">dmesg</code> to
	  find the <acronym class="acronym">EUI64</acronym> of the target machine.</p><p>Run <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=dconschat&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">dconschat</span>(8)</span></a>, with:</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>dconschat -e \# -br -G 12345 -t <em class="replaceable"><code>00-11-22-33-44-55-66-77</code></em></code></strong></pre><p>The following key combinations can be used once
	  <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=dconschat&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">dconschat</span>(8)</span></a> is running:</p><div class="informaltable"><table class="informaltable" width="100%" border="1"><colgroup><col /><col /></colgroup><tbody><tr><td>
		  <span class="keycap"><strong>~</strong></span> <span class="keycap"><strong>.</strong></span>
		</td><td>Disconnect</td></tr><tr><td>
		  <span class="keycap"><strong>~</strong></span> <span class="keycap"><strong>Ctrl</strong></span>+<span class="keycap"><strong>B</strong></span>
		</td><td>ALT BREAK</td></tr><tr><td>
		  <span class="keycap"><strong>~</strong></span> <span class="keycap"><strong>Ctrl</strong></span>+<span class="keycap"><strong>R</strong></span>
		</td><td>RESET target</td></tr><tr><td>
		  <span class="keycap"><strong>~</strong></span> <span class="keycap"><strong>Ctrl</strong></span>+<span class="keycap"><strong>Z</strong></span>
		</td><td>Suspend dconschat</td></tr></tbody></table></div><p>Attach remote <acronym class="acronym">GDB</acronym> by starting
	  <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=kgdb&amp;sektion=1&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">kgdb</span>(1)</span></a> with a remote debugging session:</p><pre class="screen"><strong class="userinput"><code>kgdb -r :12345 kernel</code></strong></pre></div><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp53147000"></a>10.7.1.3. Some general tips</h4></div></div></div><p>Here are some general tips:</p><p>To take full advantage of the speed of <span class="trademark">FireWire</span>®,
	  disable other slow console drivers:</p><pre class="screen"><code class="prompt">#</code> conscontrol delete ttyd0	     # serial console
<code class="prompt">#</code> conscontrol delete consolectl	# video/keyboard</pre><p>There exists a <acronym class="acronym">GDB</acronym> mode for
	  <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=emacs&amp;sektion=1&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">emacs</span>(1)</span></a>; this is what you will need to add to your
	  <code class="filename">.emacs</code>:</p><pre class="screen"><strong class="userinput"><code>(setq gud-gdba-command-name "kgdb -a -a -a -r :12345")
(setq gdb-many-windows t)
(xterm-mouse-mode 1)
M-x gdba</code></strong></pre><p>And for <acronym class="acronym">DDD</acronym> (<code class="filename">devel/ddd</code>):</p><pre class="screen"># remote serial protocol
LANG=C ddd --debugger kgdb -r :12345 kernel
# live core debug
LANG=C ddd --debugger kgdb kernel /dev/fwmem0.2</pre></div></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp53166584"></a>10.7.2. Dcons with KVM</h3></div></div></div><p>We can directly read the <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=dcons&amp;sektion=4&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">dcons</span>(4)</span></a> buffer via
	<code class="filename">/dev/mem</code> for live systems, and in the
	core dump for crashed systems.  These give you similar output
	to <code class="command">dmesg -a</code>, but the <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=dcons&amp;sektion=4&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">dcons</span>(4)</span></a> buffer
	includes more information.</p><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp53169912"></a>10.7.2.1. Using Dcons with KVM</h4></div></div></div><p>To use <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=dcons&amp;sektion=4&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">dcons</span>(4)</span></a> with <acronym class="acronym">KVM</acronym>:</p><p>Dump a <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=dcons&amp;sektion=4&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">dcons</span>(4)</span></a> buffer of a live system:</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>dconschat -1</code></strong></pre><p>Dump a <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=dcons&amp;sektion=4&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">dcons</span>(4)</span></a> buffer of a crash dump:</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>dconschat -1 -M vmcore.XX</code></strong></pre><p>Live core debugging can be done via:</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>fwcontrol -m target_eui64</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>kgdb kernel /dev/fwmem0.2</code></strong></pre></div></div></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="kerneldebug-deadlocks.html">Prev</a> </td><td width="20%" align="center"><a accesskey="u" href="kerneldebug.html">Up</a></td><td width="40%" align="right"> <a accesskey="n" href="kerneldebug-options.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top">10.6. Debugging Deadlocks </td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right" valign="top"> 10.8. Glossary of Kernel Options for Debugging</td></tr></table></div><p xmlns="" align="center"><small>All FreeBSD documents are available for download
    at <a href="https://download.freebsd.org/ftp/doc/">https://download.freebsd.org/ftp/doc/</a></small></p><p xmlns="" align="center"><small>Questions that are not answered by the
    <a href="https://www.FreeBSD.org/docs.html">documentation</a> may be
    sent to &lt;<a href="mailto:freebsd-questions@FreeBSD.org">freebsd-questions@FreeBSD.org</a>&gt;.<br />
    Send questions about this document to &lt;<a href="mailto:freebsd-doc@FreeBSD.org">freebsd-doc@FreeBSD.org</a>&gt;.</small></p></body></html>