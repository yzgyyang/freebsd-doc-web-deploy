<?xml version="1.0" encoding="iso-8859-1" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" /><title>10.3. On-Line Kernel Debugging Using DDB</title><link rel="stylesheet" type="text/css" href="docbook.css" /><link rev="made" href="mailto:doc@FreeBSD.org" /><meta name="generator" content="DocBook XSL Stylesheets V1.79.1" /><link rel="home" href="index.html" title="FreeBSD Developers' Handbook" /><link rel="up" href="kerneldebug.html" title="Chapter 10. Kernel Debugging" /><link rel="prev" href="kerneldebug-gdb.html" title="10.2. Debugging a Kernel Crash Dump with kgdb" /><link rel="next" href="kerneldebug-online-gdb.html" title="10.4. On-Line Kernel Debugging Using Remote GDB" /><link rel="copyright" href="legalnotice.html" title="Copyright" /><script xmlns="" type="text/javascript" src="/layout/js/google.js"></script></head><body><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">10.3. On-Line Kernel Debugging Using DDB</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="kerneldebug-gdb.html">Prev</a> </td><th width="60%" align="center">Chapter 10. Kernel Debugging</th><td width="20%" align="right"> <a accesskey="n" href="kerneldebug-online-gdb.html">Next</a></td></tr></table><hr /></div><div class="sect1"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="kerneldebug-online-ddb"></a>10.3. On-Line Kernel Debugging Using DDB</h2></div></div></div><p>While <code class="command">kgdb</code> as an off-line debugger provides a very
      high level of user interface, there are some things it cannot do.  The
      most important ones being breakpointing and single-stepping kernel
      code.</p><p>If you need to do low-level debugging on your kernel, there is an
      on-line debugger available called DDB.  It allows setting of
      breakpoints, single-stepping kernel functions, examining and changing
      kernel variables, etc.  However, it cannot access kernel source files,
      and only has access to the global and static symbols, not to the full
      debug information like <code class="command">kgdb</code> does.</p><p>To configure your kernel to include DDB, add the options

      </p><pre class="programlisting">options KDB</pre><p>
      </p><pre class="programlisting">options DDB</pre><p>

      to your config file, and rebuild.  (See <a class="link" href="../../../../doc/en_US.ISO8859-1/books/handbook/index.html" target="_top">The FreeBSD Handbook</a> for details on
      configuring the FreeBSD kernel).</p><p>Once your DDB kernel is running, there are several ways to enter
      DDB.  The first, and earliest way is to use the boot flag
      <code class="option">-d</code>.  The kernel will start up
      in debug mode and enter DDB prior to any device probing.  Hence you can
      even debug the device probe/attach functions.  To use this, exit
      the loader's boot menu and enter <code class="command">boot -d</code> at
      the loader prompt.</p><p>The second scenario is to drop to the debugger once the
      system has booted.  There are two simple ways to accomplish
      this.  If you would like to break to the debugger from the
      command prompt, simply type the command:</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>sysctl debug.kdb.enter=1</code></strong></pre><p>Alternatively, if you are at the system console, you may use
      a hot-key on the keyboard.  The default break-to-debugger
      sequence is <span class="keycap"><strong>Ctrl</strong></span>+<span class="keycap"><strong>Alt</strong></span>+<span class="keycap"><strong>ESC</strong></span>.  For
      syscons, this sequence can be remapped and some of the
      distributed maps out there do this, so check to make sure you
      know the right sequence to use.  There is an option available
      for serial consoles that allows the use of a serial line BREAK on the
      console line to enter DDB (<code class="literal">options BREAK_TO_DEBUGGER</code>
      in the kernel config file).  It is not the default since there are a lot
      of serial adapters around that gratuitously generate a BREAK
      condition, for example when pulling the cable.</p><p>The third way is that any panic condition will branch to DDB if the
      kernel is configured to use it.  For this reason, it is not wise to
      configure a kernel with DDB for a machine running unattended.</p><p>To obtain the unattended functionality, add:</p><pre class="programlisting">options	KDB_UNATTENDED</pre><p>to the kernel configuration file and rebuild/reinstall.</p><p>The DDB commands roughly resemble some <code class="command">gdb</code>
      commands.  The first thing you probably need to do is to set a
      breakpoint:</p><pre class="screen"><strong class="userinput"><code>break function-name address</code></strong></pre><p>Numbers are taken hexadecimal by default, but to make them distinct
      from symbol names; hexadecimal numbers starting with the letters
      <code class="literal">a-f</code> need to be preceded with <code class="literal">0x</code>
      (this is optional for other numbers).  Simple expressions are allowed,
      for example: <code class="literal">function-name + 0x103</code>.</p><p>To exit the debugger and continue execution,
      type:</p><pre class="screen"><strong class="userinput"><code>continue</code></strong></pre><p>To get a stack trace of the current thread, use:</p><pre class="screen"><strong class="userinput"><code>trace</code></strong></pre><p>To get a stack trace of an arbitrary thread, specify a
      process ID or thread ID as a second argument to
      <code class="command">trace</code>.</p><p>If you want to remove a breakpoint, use</p><pre class="screen"><strong class="userinput"><code>del</code></strong>
<strong class="userinput"><code>del address-expression</code></strong></pre><p>The first form will be accepted immediately after a breakpoint hit,
      and deletes the current breakpoint.  The second form can remove any
      breakpoint, but you need to specify the exact address; this can be
      obtained from:</p><pre class="screen"><strong class="userinput"><code>show b</code></strong></pre><p>or:</p><pre class="screen"><strong class="userinput"><code>show break</code></strong></pre><p>To single-step the kernel, try:</p><pre class="screen"><strong class="userinput"><code>s</code></strong></pre><p>This will step into functions, but you can make DDB trace them until
      the matching return statement is reached by:</p><pre class="screen"><strong class="userinput"><code>n</code></strong></pre><div xmlns="" class="note"><h3 class="admontitle">Note: </h3><p xmlns="http://www.w3.org/1999/xhtml">This is different from <code class="command">gdb</code>'s
	<code class="command">next</code> statement; it is like <code class="command">gdb</code>'s
	<code class="command">finish</code>.  Pressing <span class="keycap"><strong>n</strong></span> more than once
        will cause a continue.</p></div><p>To examine data from memory, use (for example):

      </p><pre class="screen"><strong class="userinput"><code>x/wx 0xf0133fe0,40</code></strong>
<strong class="userinput"><code>x/hd db_symtab_space</code></strong>
<strong class="userinput"><code>x/bc termbuf,10</code></strong>
<strong class="userinput"><code>x/s stringbuf</code></strong></pre><p>

      for word/halfword/byte access, and hexadecimal/decimal/character/ string
      display.  The number after the comma is the object count.  To display
      the next 0x10 items, simply use:</p><pre class="screen"><strong class="userinput"><code>x ,10</code></strong></pre><p>Similarly, use

      </p><pre class="screen"><strong class="userinput"><code>x/ia foofunc,10</code></strong></pre><p>

      to disassemble the first 0x10 instructions of
      <code class="function">foofunc</code>, and display them along with their offset
      from the beginning of <code class="function">foofunc</code>.</p><p>To modify memory, use the write command:</p><pre class="screen"><strong class="userinput"><code>w/b termbuf 0xa 0xb 0</code></strong>
<strong class="userinput"><code>w/w 0xf0010030 0 0</code></strong></pre><p>The command modifier
      (<code class="literal">b</code>/<code class="literal">h</code>/<code class="literal">w</code>)
      specifies the size of the data to be written, the first following
      expression is the address to write to and the remainder is interpreted
      as data to write to successive memory locations.</p><p>If you need to know the current registers, use:</p><pre class="screen"><strong class="userinput"><code>show reg</code></strong></pre><p>Alternatively, you can display a single register value by e.g.

      </p><pre class="screen"><strong class="userinput"><code>p $eax</code></strong></pre><p>

      and modify it by:</p><pre class="screen"><strong class="userinput"><code>set $eax new-value</code></strong></pre><p>Should you need to call some kernel functions from DDB, simply
      say:</p><pre class="screen"><strong class="userinput"><code>call func(arg1, arg2, ...)</code></strong></pre><p>The return value will be printed.</p><p>For a <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=ps&amp;sektion=1&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">ps</span>(1)</span></a> style summary of all running processes, use:</p><pre class="screen"><strong class="userinput"><code>ps</code></strong></pre><p>Now you have examined why your kernel failed, and you wish to
      reboot.  Remember that, depending on the severity of previous
      malfunctioning, not all parts of the kernel might still be working as
      expected.  Perform one of the following actions to shut down and reboot
      your system:</p><pre class="screen"><strong class="userinput"><code>panic</code></strong></pre><p>This will cause your kernel to dump core and reboot, so you can
      later analyze the core on a higher level with <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=kgdb&amp;sektion=1&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">kgdb</span>(1)</span></a>.</p><pre class="screen"><strong class="userinput"><code>call boot(0)</code></strong></pre><p>Might be a good way to cleanly shut down the running system,
      <code class="function">sync()</code> all disks, and finally, in some cases,
      reboot.  As long as
      the disk and filesystem interfaces of the kernel are not damaged, this
      could be a good way for an almost clean shutdown.</p><pre class="screen"><strong class="userinput"><code>reset</code></strong></pre><p>This is the final way out of disaster and almost the same as hitting the
      Big Red Button.</p><p>If you need a short command summary, simply type:</p><pre class="screen"><strong class="userinput"><code>help</code></strong></pre><p>It is highly recommended to have a printed copy of the
	<a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=ddb&amp;sektion=4&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">ddb</span>(4)</span></a> manual page ready for a debugging
      session.  Remember that it is hard to read the on-line manual while
      single-stepping the kernel.</p></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="kerneldebug-gdb.html">Prev</a> </td><td width="20%" align="center"><a accesskey="u" href="kerneldebug.html">Up</a></td><td width="40%" align="right"> <a accesskey="n" href="kerneldebug-online-gdb.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top">10.2. Debugging a Kernel Crash Dump with <code class="command">kgdb</code> </td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right" valign="top"> 10.4. On-Line Kernel Debugging Using Remote GDB</td></tr></table></div><p xmlns="" align="center"><small>All FreeBSD documents are available for download
    at <a href="https://download.freebsd.org/ftp/doc/">https://download.freebsd.org/ftp/doc/</a></small></p><p xmlns="" align="center"><small>Questions that are not answered by the
    <a href="https://www.FreeBSD.org/docs.html">documentation</a> may be
    sent to &lt;<a href="mailto:freebsd-questions@FreeBSD.org">freebsd-questions@FreeBSD.org</a>&gt;.<br />
    Send questions about this document to &lt;<a href="mailto:freebsd-doc@FreeBSD.org">freebsd-doc@FreeBSD.org</a>&gt;.</small></p></body></html>