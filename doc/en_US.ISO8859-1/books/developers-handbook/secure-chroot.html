<?xml version="1.0" encoding="iso-8859-1" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" /><title>3.5. Limiting your program's environment</title><link rel="stylesheet" type="text/css" href="docbook.css" /><link rev="made" href="mailto:doc@FreeBSD.org" /><meta name="generator" content="DocBook XSL Stylesheets V1.79.1" /><link rel="home" href="index.html" title="FreeBSD Developers' Handbook" /><link rel="up" href="secure.html" title="Chapter 3. Secure Programming" /><link rel="prev" href="secure-setuid.html" title="3.4. SetUID issues" /><link rel="next" href="secure-trust.html" title="3.6. Trust" /><link rel="copyright" href="legalnotice.html" title="Copyright" /><script xmlns="" type="text/javascript" src="/layout/js/google.js"></script></head><body><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">3.5. Limiting your program's environment</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="secure-setuid.html">Prev</a> </td><th width="60%" align="center">Chapter 3. Secure Programming</th><td width="20%" align="right"> <a accesskey="n" href="secure-trust.html">Next</a></td></tr></table><hr /></div><div class="sect1"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="secure-chroot"></a>3.5. Limiting your program's environment</h2></div></div></div><a id="idp51368696" class="indexterm"></a><p>The traditional method of restricting a process
      is with the <code class="function">chroot()</code> system call.  This
      system call changes the root directory from which all other
      paths are referenced for a process and any child processes.  For
      this call to succeed the process must have execute (search)
      permission on the directory being referenced.  The new
      environment does not actually take effect until you
      <code class="function">chdir()</code> into your new environment.  It
      should also be noted that a process can easily break out of a
      chroot environment if it has root privilege.  This could be
      accomplished by creating device nodes to read kernel memory,
      attaching a debugger to a process outside of the <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=chroot&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">chroot</span>(8)</span></a>
      environment, or in
      many other creative ways.</p><p>The behavior of the <code class="function">chroot()</code> system
      call can be controlled somewhat with the
      kern.chroot_allow_open_directories <code class="command">sysctl</code>
      variable.  When this value is set to 0,
      <code class="function">chroot()</code> will fail with EPERM if there are
      any directories open.  If set to the default value of 1, then
      <code class="function">chroot()</code> will fail with EPERM if there are
      any directories open and the process is already subject to a
      <code class="function">chroot()</code> call.  For any other value, the
      check for open directories will be bypassed completely.</p><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp51393912"></a>3.5.1. FreeBSD's jail functionality</h3></div></div></div><a id="idp51394424" class="indexterm"></a><p>The concept of a Jail extends upon the
      <code class="function">chroot()</code> by limiting the powers of the
      superuser to create a true `virtual server'.  Once a prison is
      set up all network communication must take place through the
      specified IP address, and the power of "root privilege" in this
      jail is severely constrained.</p><p>While in a prison, any tests of superuser power within the
      kernel using the <code class="function">suser()</code> call will fail.
      However, some calls to <code class="function">suser()</code> have been
      changed to a new interface <code class="function">suser_xxx()</code>.
      This function is responsible for recognizing or denying access
      to superuser power for imprisoned processes.</p><p>A superuser process within a jailed environment has the
      power to:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">Manipulate credential with
        <code class="function">setuid</code>, <code class="function">seteuid</code>,
        <code class="function">setgid</code>, <code class="function">setegid</code>,
        <code class="function">setgroups</code>, <code class="function">setreuid</code>,
        <code class="function">setregid</code>, <code class="function">setlogin</code></li><li class="listitem">Set resource limits with <code class="function">setrlimit</code></li><li class="listitem">Modify some sysctl nodes
        (kern.hostname)</li><li class="listitem"><code class="function">chroot()</code></li><li class="listitem">Set flags on a vnode:
        <code class="function">chflags</code>,
        <code class="function">fchflags</code></li><li class="listitem">Set attributes of a vnode such as file
        permission, owner, group, size, access time, and modification
        time.</li><li class="listitem">Bind to privileged ports in the Internet
        domain (ports &lt; 1024)</li></ul></div><p><code class="function">Jail</code> is a very useful tool for
      running applications in a secure environment but it does have
      some shortcomings.  Currently, the IPC mechanisms have not been
      converted to the <code class="function">suser_xxx</code> so applications
      such as MySQL cannot be run within a jail.  Superuser access
      may have a very limited meaning within a jail, but there is
      no way to specify exactly what "very limited" means.</p></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp51431544"></a>3.5.2. <span class="trademark">POSIX</span>®.1e Process Capabilities</h3></div></div></div><a id="idp51432440" class="indexterm"></a><a id="idp51432952" class="indexterm"></a><p><span class="trademark">POSIX</span>® has released a working draft that adds event
      auditing, access control lists, fine grained privileges,
      information labeling, and mandatory access control.</p><p>This is a work in progress and is the focus of the <a class="link" href="http://www.trustedbsd.org/" target="_top">TrustedBSD</a> project.  Some
      of the initial work has been committed to FreeBSD-CURRENT
      (cap_set_proc(3)).</p></div></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="secure-setuid.html">Prev</a> </td><td width="20%" align="center"><a accesskey="u" href="secure.html">Up</a></td><td width="40%" align="right"> <a accesskey="n" href="secure-trust.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top">3.4. SetUID issues </td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right" valign="top"> 3.6. Trust</td></tr></table></div><p xmlns="" align="center"><small>All FreeBSD documents are available for download
    at <a href="https://download.freebsd.org/ftp/doc/">https://download.freebsd.org/ftp/doc/</a></small></p><p xmlns="" align="center"><small>Questions that are not answered by the
    <a href="https://www.FreeBSD.org/docs.html">documentation</a> may be
    sent to &lt;<a href="mailto:freebsd-questions@FreeBSD.org">freebsd-questions@FreeBSD.org</a>&gt;.<br />
    Send questions about this document to &lt;<a href="mailto:freebsd-doc@FreeBSD.org">freebsd-doc@FreeBSD.org</a>&gt;.</small></p></body></html>