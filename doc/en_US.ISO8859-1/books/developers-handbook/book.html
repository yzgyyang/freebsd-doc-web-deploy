<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" /><title>FreeBSD Developers' Handbook</title><link rel="stylesheet" type="text/css" href="docbook.css" /><link rev="made" href="mailto:doc@FreeBSD.org" /><meta name="generator" content="DocBook XSL Stylesheets V1.79.1" /><meta name="description" content="Welcome to the Developers' Handbook. This manual is a work in progress and is the work of many individuals. Many sections do not yet exist and some of those that do exist need to be updated. If you are interested in helping with this project, send email to the FreeBSD documentation project mailing list. The latest version of this document is always available from the FreeBSD World Wide Web server. It may also be downloaded in a variety of formats and compression options from the FreeBSD FTP server or one of the numerous mirror sites." /><script xmlns="" type="text/javascript" src="/layout/js/google.js"></script></head><body><div xml:lang="en" class="book" lang="en"><div xmlns="" class="titlepage"><div><div><h1 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp43958648"></a>FreeBSD Developers' Handbook</h1></div><div><div xmlns="http://www.w3.org/1999/xhtml" class="author"><h3 class="author"><span class="orgname">The FreeBSD Documentation Project</span></h3></div></div><div>Revision: <a href="https://svnweb.freebsd.org/changeset/doc/6261f7ec30"><span class="svnref">6261f7ec30</span></a></div><div><p xmlns="http://www.w3.org/1999/xhtml" class="copyright">Copyright © 2000-2020 The FreeBSD Documentation Project</p></div><div><div xmlns="http://www.w3.org/1999/xhtml" class="legalnotice"><a id="legalnotice"></a><p class="legalnotice-title"><strong>Copyright</strong></p><p>Redistribution and use in source (XML DocBook) and 'compiled'
    forms (XML, HTML, PDF, PostScript, RTF and so forth) with or without
    modification, are permitted provided that the following conditions are
    met:</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>Redistributions of source code (XML DocBook) must retain the
        above copyright notice, this list of conditions and the following
        disclaimer as the first lines of this file unmodified.</p></li><li class="listitem"><p>Redistributions in compiled form (transformed to other DTDs,
        converted to PDF, PostScript, RTF and other formats) must
        reproduce the above copyright notice, this list of conditions and
        the following disclaimer in the documentation and/or other
        materials provided with the distribution.</p></li></ol></div><div xmlns="" class="important"><h3 class="admontitle">Important: </h3><p xmlns="http://www.w3.org/1999/xhtml">THIS DOCUMENTATION IS PROVIDED BY THE FREEBSD DOCUMENTATION
      PROJECT "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING,
      BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND
      FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL
      THE FREEBSD DOCUMENTATION PROJECT BE LIABLE FOR ANY DIRECT, INDIRECT,
      INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING,
      BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS
      OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
      ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR
      TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE
      USE OF THIS DOCUMENTATION, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH
      DAMAGE.</p></div></div></div><div><div xmlns="http://www.w3.org/1999/xhtml" class="legalnotice"><a id="trademarks"></a><p>FreeBSD is a registered trademark of
  the FreeBSD Foundation.</p><p>Apple, AirPort, FireWire,
  iMac, iPhone, iPad,
  Mac, Macintosh, Mac OS,
  Quicktime, and TrueType are trademarks of Apple Inc.,
  registered in the U.S. and other countries.</p><p>IBM, AIX, OS/2,
  PowerPC, PS/2, S/390, and ThinkPad are
  trademarks of International Business Machines Corporation in the
  United States, other countries, or both.</p><p>IEEE, POSIX, and 802 are registered
  trademarks of Institute of Electrical and Electronics Engineers,
  Inc. in the United States.</p><p>Intel, Celeron, Centrino, Core, EtherExpress, i386,
  i486, Itanium, Pentium, and Xeon are trademarks or registered
  trademarks of Intel Corporation or its subsidiaries in the United
  States and other countries.</p><p>Linux is a registered trademark of
  Linus Torvalds.</p><p>Microsoft, IntelliMouse, MS-DOS,
  Outlook, Windows, Windows Media and Windows NT are either
  registered trademarks or trademarks of Microsoft Corporation in the
  United States and/or other countries.</p><p>Motif, OSF/1, and UNIX are
  registered trademarks and IT DialTone and The Open Group are
  trademarks of The Open Group in the United States and other
  countries.</p><p>Sun, Sun Microsystems, Java, Java
  Virtual Machine, JDK, JRE, JSP, JVM, Netra, OpenJDK,
  Solaris, StarOffice, SunOS
  and VirtualBox are trademarks or registered trademarks of
  Sun Microsystems, Inc. in the United States and other countries.</p><p>Many of the designations used by
  manufacturers and sellers to distinguish their products are claimed
  as trademarks.  Where those designations appear in this document,
  and the FreeBSD Project was aware of the trademark claim, the
  designations have been followed by the <span class="quote">&#8220;<span class="quote">&#8482;</span>&#8221;</span> or the
  <span class="quote">&#8220;<span class="quote">®</span>&#8221;</span> symbol.</p></div></div><div>Last modified on 2020-07-24 18:15:05 +0000 by bcr.</div><div><div xmlns="http://www.w3.org/1999/xhtml" class="abstract"><div class="abstract-title">Abstract</div><p>Welcome to the Developers' Handbook.  This manual is a
	<span class="emphasis"><em>work in progress</em></span> and is the work of many
	individuals.  Many sections do not yet exist and some of those
	that do exist need to be updated.  If you are interested in
	helping with this project, send email to the <a class="link" href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-doc" target="_top">FreeBSD documentation project mailing list</a>.</p><p>The latest version of this document is always available
        from the <a class="link" href="../../../../index.html" target="_top">FreeBSD World
        Wide Web server</a>.  It may also be downloaded in a
        variety of formats and compression options from the <a class="link" href="https://download.freebsd.org/ftp/doc/" target="_top">FreeBSD FTP
        server</a> or one of the numerous <a class="link" href="../../../../doc/en_US.ISO8859-1/books/handbook/mirrors-ftp.html" target="_top">mirror
        sites</a>.</p></div></div></div><div class="docformatnavi">
      [
      <a href="index.html">Split HTML</a>
      /
      
	  Single HTML
	
      ]
    </div><hr /></div><div class="toc"><div class="toc-title">Table of Contents</div><dl class="toc"><dt><span class="part"><a href="#Basics">I. Basics</a></span></dt><dd><dl><dt><span class="chapter"><a href="#introduction">1. Introduction</a></span></dt><dd><dl><dt><span class="sect1"><a href="#introduction-devel">1.1. Developing on FreeBSD</a></span></dt><dt><span class="sect1"><a href="#introduction-bsdvision">1.2. The BSD Vision</a></span></dt><dt><span class="sect1"><a href="#introduction-archguide">1.3. Architectural Guidelines</a></span></dt><dt><span class="sect1"><a href="#introduction-layout">1.4. The Layout of
      <code class="filename">/usr/src</code></a></span></dt></dl></dd><dt><span class="chapter"><a href="#tools">2. Programming Tools</a></span></dt><dd><dl><dt><span class="sect1"><a href="#tools-synopsis">2.1. Synopsis</a></span></dt><dt><span class="sect1"><a href="#tools-intro">2.2. Introduction</a></span></dt><dt><span class="sect1"><a href="#tools-programming">2.3. Introduction to Programming</a></span></dt><dt><span class="sect1"><a href="#tools-compiling">2.4. Compiling with <code class="command">cc</code></a></span></dt><dt><span class="sect1"><a href="#tools-make">2.5. Make</a></span></dt><dt><span class="sect1"><a href="#debugging">2.6. Debugging</a></span></dt><dt><span class="sect1"><a href="#emacs">2.7. Using Emacs as a Development Environment</a></span></dt><dt><span class="sect1"><a href="#tools-reading">2.8. Further Reading</a></span></dt></dl></dd><dt><span class="chapter"><a href="#secure">3. Secure Programming</a></span></dt><dd><dl><dt><span class="sect1"><a href="#secure-synopsis">3.1. Synopsis</a></span></dt><dt><span class="sect1"><a href="#secure-philosophy">3.2. Secure Design
      Methodology</a></span></dt><dt><span class="sect1"><a href="#secure-bufferov">3.3. Buffer Overflows</a></span></dt><dt><span class="sect1"><a href="#secure-setuid">3.4. SetUID issues</a></span></dt><dt><span class="sect1"><a href="#secure-chroot">3.5. Limiting your program's environment</a></span></dt><dt><span class="sect1"><a href="#secure-trust">3.6. Trust</a></span></dt><dt><span class="sect1"><a href="#secure-race-conditions">3.7. Race Conditions</a></span></dt></dl></dd><dt><span class="chapter"><a href="#l10n">4. Localization and Internationalization - L10N and I18N</a></span></dt><dd><dl><dt><span class="sect1"><a href="#l10n-programming">4.1. Programming I18N Compliant Applications</a></span></dt><dt><span class="sect1"><a href="#posix-nls">4.2. Localized Messages with POSIX.1 Native Language Support (NLS)</a></span></dt></dl></dd><dt><span class="chapter"><a href="#policies">5. Source Tree Guidelines and Policies</a></span></dt><dd><dl><dt><span class="sect1"><a href="#policies-style">5.1. Style Guidelines</a></span></dt><dt><span class="sect1"><a href="#policies-maintainer">5.2. <code class="varname">MAINTAINER</code> on Makefiles</a></span></dt><dt><span class="sect1"><a href="#policies-contributed">5.3. Contributed Software</a></span></dt><dt><span class="sect1"><a href="#policies-encumbered">5.4. Encumbered Files</a></span></dt><dt><span class="sect1"><a href="#policies-shlib">5.5. Shared Libraries</a></span></dt></dl></dd><dt><span class="chapter"><a href="#testing">6. Regression and Performance Testing</a></span></dt><dd><dl><dt><span class="section"><a href="#testing-micro-benchmark">6.1. Micro Benchmark Checklist</a></span></dt><dt><span class="section"><a href="#testing-tinderbox">6.2. The FreeBSD Source Tinderbox</a></span></dt></dl></dd></dl></dd><dt><span class="part"><a href="#ipc">II. Interprocess Communication</a></span></dt><dd><dl><dt><span class="chapter"><a href="#sockets">7. Sockets</a></span></dt><dd><dl><dt><span class="sect1"><a href="#sockets-synopsis">7.1. Synopsis</a></span></dt><dt><span class="sect1"><a href="#sockets-diversity">7.2. Networking and Diversity</a></span></dt><dt><span class="sect1"><a href="#sockets-protocols">7.3. Protocols</a></span></dt><dt><span class="sect1"><a href="#sockets-model">7.4. The Sockets Model</a></span></dt><dt><span class="sect1"><a href="#sockets-essential-functions">7.5. Essential Socket Functions</a></span></dt><dt><span class="sect1"><a href="#sockets-helper-functions">7.6. Helper Functions</a></span></dt><dt><span class="sect1"><a href="#sockets-concurrent-servers">7.7. Concurrent Servers</a></span></dt></dl></dd><dt><span class="chapter"><a href="#ipv6">8. IPv6 Internals</a></span></dt><dd><dl><dt><span class="sect1"><a href="#ipv6-implementation">8.1. IPv6/IPsec Implementation</a></span></dt></dl></dd></dl></dd><dt><span class="part"><a href="#kernel">III. Kernel</a></span></dt><dd><dl><dt><span class="chapter"><a href="#kernelbuild">9. Building and Installing a FreeBSD Kernel</a></span></dt><dd><dl><dt><span class="sect1"><a href="#kernelbuild-traditional">9.1. Building the Faster but Brittle Way</a></span></dt></dl></dd><dt><span class="chapter"><a href="#kerneldebug">10. Kernel Debugging</a></span></dt><dd><dl><dt><span class="sect1"><a href="#kerneldebug-obtain">10.1. Obtaining a Kernel Crash Dump</a></span></dt><dt><span class="sect1"><a href="#kerneldebug-gdb">10.2. Debugging a Kernel Crash Dump with <code class="command">kgdb</code></a></span></dt><dt><span class="sect1"><a href="#kerneldebug-online-ddb">10.3. On-Line Kernel Debugging Using DDB</a></span></dt><dt><span class="sect1"><a href="#kerneldebug-online-gdb">10.4. On-Line Kernel Debugging Using Remote GDB</a></span></dt><dt><span class="sect1"><a href="#kerneldebug-console">10.5. Debugging a Console Driver</a></span></dt><dt><span class="sect1"><a href="#kerneldebug-deadlocks">10.6. Debugging Deadlocks</a></span></dt><dt><span class="sect1"><a href="#kerneldebug-dcons">10.7. Kernel debugging with Dcons</a></span></dt><dt><span class="sect1"><a href="#kerneldebug-options">10.8. Glossary of Kernel Options for Debugging</a></span></dt></dl></dd></dl></dd><dt><span class="part"><a href="#architectures">IV. Architectures</a></span></dt><dd><dl><dt><span class="chapter"><a href="#x86">11. x86 Assembly Language Programming</a></span></dt><dd><dl><dt><span class="sect1"><a href="#x86-intro">11.1. Synopsis</a></span></dt><dt><span class="sect1"><a href="#x86-the-tools">11.2. The Tools</a></span></dt><dt><span class="sect1"><a href="#x86-system-calls">11.3. System Calls</a></span></dt><dt><span class="sect1"><a href="#x86-return-values">11.4. Return Values</a></span></dt><dt><span class="sect1"><a href="#x86-portable-code">11.5. Creating Portable Code</a></span></dt><dt><span class="sect1"><a href="#x86-first-program">11.6. Our First Program</a></span></dt><dt><span class="sect1"><a href="#x86-unix-filters">11.7. Writing <span class="trademark">UNIX</span>® Filters</a></span></dt><dt><span class="sect1"><a href="#x86-buffered-io">11.8. Buffered Input and Output</a></span></dt><dt><span class="sect1"><a href="#x86-command-line">11.9. Command Line Arguments</a></span></dt><dt><span class="sect1"><a href="#x86-environment">11.10. <span class="trademark">UNIX</span>® Environment</a></span></dt><dt><span class="sect1"><a href="#x86-files">11.11. Working with Files</a></span></dt><dt><span class="sect1"><a href="#x86-one-pointed-mind">11.12. One-Pointed Mind</a></span></dt><dt><span class="sect1"><a href="#x86-fpu">11.13. Using the <acronym class="acronym">FPU</acronym></a></span></dt><dt><span class="sect1"><a href="#x86-caveats">11.14. Caveats</a></span></dt><dt><span class="sect1"><a href="#x86-acknowledgements">11.15. Acknowledgements</a></span></dt></dl></dd></dl></dd><dt><span class="part"><a href="#appendices">V. Appendices</a></span></dt><dd><dl><dt><span class="bibliography"><a href="#idp52615288">Bibliography</a></span></dt></dl></dd><dt><span class="index"><a href="#idp52655352">Index</a></span></dt></dl></div><div class="list-of-examples"><div class="toc-title">List of Examples</div><dl><dt>2.1. <a href="#idp49109112">A Sample <code class="filename">.emacs</code></a></dt></dl></div><div class="part"><div xmlns="" class="titlepage"><div><div><h1 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="Basics"></a>Part I. Basics</h1></div></div></div><div class="toc"><div class="toc-title">Table of Contents</div><dl class="toc"><dt><span class="chapter"><a href="#introduction">1. Introduction</a></span></dt><dd><dl><dt><span class="sect1"><a href="#introduction-devel">1.1. Developing on FreeBSD</a></span></dt><dt><span class="sect1"><a href="#introduction-bsdvision">1.2. The BSD Vision</a></span></dt><dt><span class="sect1"><a href="#introduction-archguide">1.3. Architectural Guidelines</a></span></dt><dt><span class="sect1"><a href="#introduction-layout">1.4. The Layout of
      <code class="filename">/usr/src</code></a></span></dt></dl></dd><dt><span class="chapter"><a href="#tools">2. Programming Tools</a></span></dt><dd><dl><dt><span class="sect1"><a href="#tools-synopsis">2.1. Synopsis</a></span></dt><dt><span class="sect1"><a href="#tools-intro">2.2. Introduction</a></span></dt><dt><span class="sect1"><a href="#tools-programming">2.3. Introduction to Programming</a></span></dt><dt><span class="sect1"><a href="#tools-compiling">2.4. Compiling with <code class="command">cc</code></a></span></dt><dt><span class="sect1"><a href="#tools-make">2.5. Make</a></span></dt><dt><span class="sect1"><a href="#debugging">2.6. Debugging</a></span></dt><dt><span class="sect1"><a href="#emacs">2.7. Using Emacs as a Development Environment</a></span></dt><dt><span class="sect1"><a href="#tools-reading">2.8. Further Reading</a></span></dt></dl></dd><dt><span class="chapter"><a href="#secure">3. Secure Programming</a></span></dt><dd><dl><dt><span class="sect1"><a href="#secure-synopsis">3.1. Synopsis</a></span></dt><dt><span class="sect1"><a href="#secure-philosophy">3.2. Secure Design
      Methodology</a></span></dt><dt><span class="sect1"><a href="#secure-bufferov">3.3. Buffer Overflows</a></span></dt><dt><span class="sect1"><a href="#secure-setuid">3.4. SetUID issues</a></span></dt><dt><span class="sect1"><a href="#secure-chroot">3.5. Limiting your program's environment</a></span></dt><dt><span class="sect1"><a href="#secure-trust">3.6. Trust</a></span></dt><dt><span class="sect1"><a href="#secure-race-conditions">3.7. Race Conditions</a></span></dt></dl></dd><dt><span class="chapter"><a href="#l10n">4. Localization and Internationalization - L10N and I18N</a></span></dt><dd><dl><dt><span class="sect1"><a href="#l10n-programming">4.1. Programming I18N Compliant Applications</a></span></dt><dt><span class="sect1"><a href="#posix-nls">4.2. Localized Messages with POSIX.1 Native Language Support (NLS)</a></span></dt></dl></dd><dt><span class="chapter"><a href="#policies">5. Source Tree Guidelines and Policies</a></span></dt><dd><dl><dt><span class="sect1"><a href="#policies-style">5.1. Style Guidelines</a></span></dt><dt><span class="sect1"><a href="#policies-maintainer">5.2. <code class="varname">MAINTAINER</code> on Makefiles</a></span></dt><dt><span class="sect1"><a href="#policies-contributed">5.3. Contributed Software</a></span></dt><dt><span class="sect1"><a href="#policies-encumbered">5.4. Encumbered Files</a></span></dt><dt><span class="sect1"><a href="#policies-shlib">5.5. Shared Libraries</a></span></dt></dl></dd><dt><span class="chapter"><a href="#testing">6. Regression and Performance Testing</a></span></dt><dd><dl><dt><span class="section"><a href="#testing-micro-benchmark">6.1. Micro Benchmark Checklist</a></span></dt><dt><span class="section"><a href="#testing-tinderbox">6.2. The FreeBSD Source Tinderbox</a></span></dt></dl></dd></dl></div><div class="chapter"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="introduction"></a>Chapter 1. Introduction</h2></div><div><span class="authorgroup">Contributed by <span xmlns="http://www.w3.org/1999/xhtml" class="author"><span class="firstname">Murray</span> <span class="surname">Stokely</span></span> and <span xmlns="http://www.w3.org/1999/xhtml" class="author"><span class="firstname">Jeroen</span> <span class="surname">Ruigrok van der Werven</span></span>. </span></div></div></div><div class="toc"><div class="toc-title">Table of Contents</div><dl class="toc"><dt><span class="sect1"><a href="#introduction-devel">1.1. Developing on FreeBSD</a></span></dt><dt><span class="sect1"><a href="#introduction-bsdvision">1.2. The BSD Vision</a></span></dt><dt><span class="sect1"><a href="#introduction-archguide">1.3. Architectural Guidelines</a></span></dt><dt><span class="sect1"><a href="#introduction-layout">1.4. The Layout of
      <code class="filename">/usr/src</code></a></span></dt></dl></div><div class="sect1"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="introduction-devel"></a>1.1. Developing on FreeBSD</h2></div></div></div><p>So here we are.  System all installed and you are ready to
      start programming.  But where to start?  What does FreeBSD
      provide?  What can it do for me, as a programmer?</p><p>These are some questions which this chapter tries to answer.
      Of course, programming has different levels of proficiency like
      any other trade.  For some it is a hobby, for others it is their
      profession.  The information in this chapter might be aimed
      toward the beginning programmer; indeed, it could serve useful
      for the programmer unfamiliar with the FreeBSD platform.</p></div><div class="sect1"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="introduction-bsdvision"></a>1.2. The BSD Vision</h2></div></div></div><p>To produce the best <span class="trademark">UNIX</span>® like operating system package
      possible, with due respect to the original software tools
      ideology as well as usability, performance and
      stability.</p></div><div class="sect1"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="introduction-archguide"></a>1.3. Architectural Guidelines</h2></div></div></div><p>Our ideology can be described by the following
      guidelines</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Do not add new functionality unless an implementor
	  cannot complete a real application without it.</p></li><li class="listitem"><p>It is as important to decide what a system is
	  not as to decide what it is.  Do not serve all the world's
	  needs; rather, make the system extensible so that additional
	  needs can be met in an upwardly compatible
	  fashion.</p></li><li class="listitem"><p>The only thing worse than generalizing from one example
	  is generalizing from no examples at all.</p></li><li class="listitem"><p>If a problem is not completely understood, it is
	  probably best to provide no solution at all.</p></li><li class="listitem"><p>If you can get 90 percent of the desired effect for 10
	  percent of the work, use the simpler solution.</p></li><li class="listitem"><p>Isolate complexity as much as possible.</p></li><li class="listitem"><p>Provide mechanism, rather than policy.  In particular,
	  place user interface policy in the client's hands.</p></li></ul></div><p>From Scheifler &amp; Gettys: "X Window System"</p></div><div class="sect1"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="introduction-layout"></a>1.4. The Layout of
      <code class="filename">/usr/src</code></h2></div></div></div><p>The complete source code to FreeBSD is available from our
      public repository.  The source code is normally installed in
      <code class="filename">/usr/src</code> which contains
      the following subdirectories:</p><p>
      </p><div class="informaltable"><table class="informaltable" width="100%" border="0"><colgroup><col /><col /></colgroup><thead><tr><th>Directory</th><th>Description</th></tr></thead><tbody><tr><td><code class="filename">bin/</code></td><td>Source for files in
		<code class="filename">/bin</code></td></tr><tr><td><code class="filename">cddl/</code></td><td>Utilities covered by the Common Development and
		Distribution License</td></tr><tr><td><code class="filename">contrib/</code></td><td>Source for files from contributed
		software</td></tr><tr><td><code class="filename">crypto/</code></td><td>Cryptographical sources</td></tr><tr><td><code class="filename">etc/</code></td><td>Source for files in <code class="filename">/etc</code></td></tr><tr><td><code class="filename">gnu/</code></td><td>Utilities covered by the GNU Public
		License</td></tr><tr><td><code class="filename">include/</code></td><td>Source for files in <code class="filename">/usr/include</code></td></tr><tr><td><code class="filename">kerberos5/</code></td><td>Source for Kerberos version 5</td></tr><tr><td><code class="filename">lib/</code></td><td>Source for files in <code class="filename">/usr/lib</code></td></tr><tr><td><code class="filename">libexec/</code></td><td>Source for files in <code class="filename">/usr/libexec</code></td></tr><tr><td><code class="filename">release/</code></td><td>Files required to produce a FreeBSD
		release</td></tr><tr><td><code class="filename">rescue/</code></td><td>Build system for the
		<code class="filename">/rescue</code>
		utilities</td></tr><tr><td><code class="filename">sbin/</code></td><td>Source for files in <code class="filename">/sbin</code></td></tr><tr><td><code class="filename">secure/</code></td><td>Contributed cryptographic sources</td></tr><tr><td><code class="filename">share/</code></td><td>Source for files in <code class="filename">/usr/share</code></td></tr><tr><td><code class="filename">sys/</code></td><td>Kernel source files</td></tr><tr><td><code class="filename">tests/</code></td><td>The FreeBSD test suite</td></tr><tr><td><code class="filename">tools/</code></td><td>Tools used for maintenance and testing of
		FreeBSD</td></tr><tr><td><code class="filename">usr.bin/</code></td><td>Source for files in <code class="filename">/usr/bin</code></td></tr><tr><td><code class="filename">usr.sbin/</code></td><td>Source for files in <code class="filename">/usr/sbin</code></td></tr></tbody></table></div></div></div><div class="chapter"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="tools"></a>Chapter 2. Programming Tools</h2></div><div><span class="authorgroup">Contributed by <span xmlns="http://www.w3.org/1999/xhtml" class="author"><span class="firstname">James</span> <span class="surname">Raynard</span></span> and <span xmlns="http://www.w3.org/1999/xhtml" class="author"><span class="firstname">Murray</span> <span class="surname">Stokely</span></span>. </span></div></div></div><div class="toc"><div class="toc-title">Table of Contents</div><dl class="toc"><dt><span class="sect1"><a href="#tools-synopsis">2.1. Synopsis</a></span></dt><dt><span class="sect1"><a href="#tools-intro">2.2. Introduction</a></span></dt><dt><span class="sect1"><a href="#tools-programming">2.3. Introduction to Programming</a></span></dt><dt><span class="sect1"><a href="#tools-compiling">2.4. Compiling with <code class="command">cc</code></a></span></dt><dt><span class="sect1"><a href="#tools-make">2.5. Make</a></span></dt><dt><span class="sect1"><a href="#debugging">2.6. Debugging</a></span></dt><dt><span class="sect1"><a href="#emacs">2.7. Using Emacs as a Development Environment</a></span></dt><dt><span class="sect1"><a href="#tools-reading">2.8. Further Reading</a></span></dt></dl></div><div class="sect1"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="tools-synopsis"></a>2.1. Synopsis</h2></div></div></div><p>This chapter is an introduction to using some of the
      programming tools supplied with FreeBSD, although much of it
      will be applicable to many other versions of <span class="trademark">UNIX</span>®.  It does
      <span class="emphasis"><em>not</em></span> attempt to describe coding in any
      detail.  Most of the chapter assumes little or no previous
      programming knowledge, although it is hoped that most
      programmers will find something of value in it.</p></div><div class="sect1"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="tools-intro"></a>2.2. Introduction</h2></div></div></div><p>FreeBSD offers an excellent development environment.
      Compilers for C and C++ and an assembler come with the basic
      system, not to mention classic <span class="trademark">UNIX</span>® tools such as
      <code class="command">sed</code> and <code class="command">awk</code>.  If that is
      not enough, there are many more compilers and interpreters in
      the Ports collection.  The following section, <a class="link" href="#tools-programming" title="2.3. Introduction to Programming">Introduction to
	Programming</a>, lists some of the available options.
      FreeBSD is very compatible with standards such as
      <acronym class="acronym"><span class="trademark">POSIX</span>®</acronym> and <acronym class="acronym">ANSI</acronym> C, as
      well with its own BSD heritage, so it is possible to write
      applications that will compile and run with little or no
      modification on a wide range of platforms.</p><p>However, all this power can be rather overwhelming at first
      if you have never written programs on a <span class="trademark">UNIX</span>® platform before.
      This document aims to help you get up and running, without
      getting too deeply into more advanced topics.  The intention is
      that this document should give you enough of the basics to be
      able to make some sense of the documentation.</p><p>Most of the document requires little or no knowledge of
      programming, although it does assume a basic competence with
      using <span class="trademark">UNIX</span>® and a willingness to learn!</p></div><div class="sect1"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="tools-programming"></a>2.3. Introduction to Programming</h2></div></div></div><p>A program is a set of instructions that tell the computer to
      do various things; sometimes the instruction it has to perform
      depends on what happened when it performed a previous
      instruction.  This section gives an overview of the two main
      ways in which you can give these instructions, or
      <span class="quote">&#8220;<span class="quote">commands</span>&#8221;</span> as they are usually called.  One way
      uses an <em class="firstterm">interpreter</em>, the other a
      <em class="firstterm">compiler</em>.  As human languages are too
      difficult for a computer to understand in an unambiguous way,
      commands are usually written in one or other languages specially
      designed for the purpose.</p><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp45289848"></a>2.3.1. Interpreters</h3></div></div></div><p>With an interpreter, the language comes as an environment,
	where you type in commands at a prompt and the environment
	executes them for you.  For more complicated programs, you can
	type the commands into a file and get the interpreter to load
	the file and execute the commands in it.  If anything goes
	wrong, many interpreters will drop you into a debugger to help
	you track down the problem.</p><p>The advantage of this is that you can see the results of
	your commands immediately, and mistakes can be corrected
	readily.  The biggest disadvantage comes when you want to
	share your programs with someone.  They must have the same
	interpreter, or you must have some way of giving it to them,
	and they need to understand how to use it.  Also users may not
	appreciate being thrown into a debugger if they press the
	wrong key! From a performance point of view, interpreters can
	use up a lot of memory, and generally do not generate code as
	efficiently as compilers.</p><p>In my opinion, interpreted languages are the best way to
	start if you have not done any programming before.  This kind
	of environment is typically found with languages like Lisp,
	Smalltalk, Perl and Basic.  It could also be argued that the
	<span class="trademark">UNIX</span>® shell (<code class="command">sh</code>, <code class="command">csh</code>)
	is itself an interpreter, and many people do in fact write
	shell <span class="quote">&#8220;<span class="quote">scripts</span>&#8221;</span> to help with various
	<span class="quote">&#8220;<span class="quote">housekeeping</span>&#8221;</span> tasks on their machine.  Indeed,
	part of the original <span class="trademark">UNIX</span>® philosophy was to provide lots of
	small utility programs that could be linked together in shell
	scripts to perform useful tasks.</p></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp45309432"></a>2.3.2. Interpreters Available with FreeBSD</h3></div></div></div><p>Here is a list of interpreters that are available from the
	FreeBSD Ports Collection, with a brief discussion of some of the
	more popular interpreted languages.</p><p>Instructions on how to get and install applications from
	the Ports Collection can be found in the <a class="link" href="../../../../doc/en_US.ISO8859-1/books/handbook/ports-using.html" target="_top">Ports
	  section</a> of the handbook.</p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><acronym class="acronym">BASIC</acronym></span></dt><dd><p>Short for Beginner's All-purpose Symbolic
	      Instruction Code.  Developed in the 1950s for teaching
	      University students to program and provided with every
	      self-respecting personal computer in the 1980s,
	      <acronym class="acronym">BASIC</acronym> has been the first programming
	      language for many programmers.  It is also the
	      foundation for Visual Basic.</p><p>The Bywater Basic Interpreter can be found in the
	      Ports Collection as <a xmlns="" class="package" href="https://www.freebsd.org/cgi/url.cgi?ports/lang/bwbasic/pkg-descr">lang/bwbasic</a> and
	      the Phil Cockroft's Basic Interpreter (formerly Rabbit
	      Basic) is available as
	      <a xmlns="" class="package" href="https://www.freebsd.org/cgi/url.cgi?ports/lang/pbasic/pkg-descr">lang/pbasic</a>.</p></dd><dt><span class="term">Lisp</span></dt><dd><p>A language that was developed in the late 1950s as
	      an alternative to the <span class="quote">&#8220;<span class="quote">number-crunching</span>&#8221;</span>
	      languages that were popular at the time.  Instead of
	      being based on numbers, Lisp is based on lists; in fact,
	      the name is short for <span class="quote">&#8220;<span class="quote">List Processing</span>&#8221;</span>.
	      It is very popular in <acronym class="acronym">AI</acronym> (Artificial
	      Intelligence) circles.</p><p>Lisp is an extremely powerful and sophisticated
	      language, but can be rather large and unwieldy.</p><p>Various implementations of Lisp that can run on
	      <span class="trademark">UNIX</span>® systems are available in the Ports Collection for
	      FreeBSD.  GNU Common Lisp can be found as
	      <a xmlns="" class="package" href="https://www.freebsd.org/cgi/url.cgi?ports/lang/gcl/pkg-descr">lang/gcl</a>.  CLISP by Bruno Haible and
	      Michael Stoll is available as
	      <a xmlns="" class="package" href="https://www.freebsd.org/cgi/url.cgi?ports/lang/clisp/pkg-descr">lang/clisp</a>.  For CMUCL, which
	      includes a highly-optimizing compiler too, or simpler
	      Lisp implementations like SLisp, which implements most
	      of the Common Lisp constructs in a few hundred lines of
	      C code, <a xmlns="" class="package" href="https://www.freebsd.org/cgi/url.cgi?ports/lang/cmucl/pkg-descr">lang/cmucl</a> and
	      <a xmlns="" class="package" href="https://www.freebsd.org/cgi/url.cgi?ports/lang/slisp/pkg-descr">lang/slisp</a> are available
	      respectively.</p></dd><dt><span class="term">Perl</span></dt><dd><p>Very popular with system administrators for writing
	      scripts; also often used on World Wide Web servers for
	      writing <acronym class="acronym">CGI</acronym> scripts.</p><p>Perl is available in the Ports Collection as
	      <a xmlns="" class="package" href="https://www.freebsd.org/cgi/url.cgi?ports/lang/perl5.24/pkg-descr">lang/perl5.24</a> for all
	      FreeBSD releases.</p></dd><dt><span class="term">Scheme</span></dt><dd><p>A dialect of Lisp that is rather more compact and
	      cleaner than Common Lisp.  Popular in Universities as it
	      is simple enough to teach to undergraduates as a first
	      language, while it has a high enough level of
	      abstraction to be used in research work.</p><p>Scheme is available from the Ports Collection as
	      <a xmlns="" class="package" href="https://www.freebsd.org/cgi/url.cgi?ports/lang/elk/pkg-descr">lang/elk</a> for the
		Elk Scheme Interpreter.  The MIT Scheme Interpreter
		can be found in
		<a xmlns="" class="package" href="https://www.freebsd.org/cgi/url.cgi?ports/lang/mit-scheme/pkg-descr">lang/mit-scheme</a>
		and the SCM Scheme Interpreter in
		<a xmlns="" class="package" href="https://www.freebsd.org/cgi/url.cgi?ports/lang/scm/pkg-descr">lang/scm</a>.</p></dd><dt><span class="term">Icon</span></dt><dd><p>Icon is a high-level language with extensive
	      facilities for processing strings and structures.
	      The version of Icon for FreeBSD can be found in the
	      Ports Collection as
	      <a xmlns="" class="package" href="https://www.freebsd.org/cgi/url.cgi?ports/lang/icon/pkg-descr">lang/icon</a>.</p></dd><dt><span class="term">Logo</span></dt><dd><p>Logo is a language that is easy to learn, and has
	      been used as an introductory programming language in
	      various courses.  It is an excellent tool to work with
	      when teaching programming to smaller age groups, as it
	      makes creation of elaborate geometric shapes an easy
	      task.</p><p>The latest version of Logo for FreeBSD is available
	      from the Ports Collection in
	      <a xmlns="" class="package" href="https://www.freebsd.org/cgi/url.cgi?ports/lang/logo/pkg-descr">lang/logo</a>.</p></dd><dt><span class="term">Python</span></dt><dd><p>Python is an Object-Oriented, interpreted language.
	      Its advocates argue that it is one of the best languages
	      to start programming with, since it is relatively easy
	      to start with, but is not limited in comparison to other
	      popular interpreted languages that are used for the
	      development of large, complex applications (Perl and Tcl
	      are two other languages that are popular for such
	      tasks).</p><p>The latest version of Python is available from the
	      Ports Collection in
	      <a xmlns="" class="package" href="https://www.freebsd.org/cgi/url.cgi?ports/lang/python/pkg-descr">lang/python</a>.</p></dd><dt><span class="term">Ruby</span></dt><dd><p>Ruby is an interpreter, pure object-oriented
	      programming language.  It has become widely popular
	      because of its easy to understand syntax, flexibility
	      when writing code, and the ability to easily develop and
	      maintain large, complex programs.</p><p>Ruby is available from the Ports Collection as
	      <a xmlns="" class="package" href="https://www.freebsd.org/cgi/url.cgi?ports/lang/ruby25/pkg-descr">lang/ruby25</a>.</p></dd><dt><span class="term">Tcl and Tk</span></dt><dd><p>Tcl is an embeddable, interpreted language, that has
	      become widely used and became popular mostly because of
	      its portability to many platforms.  It can be used both
	      for quickly writing small, prototype applications, or
	      (when combined with Tk, a GUI toolkit) fully-fledged,
	      featureful programs.</p><p>Various versions of Tcl are available as ports for
	      FreeBSD.  The latest version, Tcl 8.5, can be found in
	      <a xmlns="" class="package" href="https://www.freebsd.org/cgi/url.cgi?ports/lang/tcl87/pkg-descr">lang/tcl87</a>.</p></dd></dl></div></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp45402872"></a>2.3.3. Compilers</h3></div></div></div><p>Compilers are rather different.  First of all, you write
	your code in a file (or files) using an editor.  You then run
	the compiler and see if it accepts your program.  If it did
	not compile, grit your teeth and go back to the editor; if it
	did compile and gave you a program, you can run it either at a
	shell command prompt or in a debugger to see if it works
	properly.<a href="#ftn.idp45404920" class="footnote" id="idp45404920"><sup class="footnote">[1]</sup></a></p><p>Obviously, this is not quite as direct as using an
	interpreter.  However it allows you to do a lot of things
	which are very difficult or even impossible with an
	interpreter, such as writing code which interacts closely with
	the operating system&#8212;or even writing your own operating
	system! It is also useful if you need to write very efficient
	code, as the compiler can take its time and optimize the code,
	which would not be acceptable in an interpreter.  Moreover,
	distributing a program written for a compiler is usually more
	straightforward than one written for an interpreter&#8212;you
	can just give them a copy of the executable, assuming they
	have the same operating system as you.</p><p>As the edit-compile-run-debug cycle is rather tedious when
	using separate programs, many commercial compiler makers have
	produced Integrated Development Environments
	(<acronym class="acronym">IDE</acronym>s for short).  FreeBSD does not include
	an IDE in the base system, but
	<a xmlns="" class="package" href="https://www.freebsd.org/cgi/url.cgi?ports/devel/kdevelop/pkg-descr">devel/kdevelop</a> is available in the Ports
	Collection and many use <span class="application">Emacs</span> for
	this purpose.  Using <span class="application">Emacs</span> as an
	IDE is discussed in <a class="xref" href="#emacs" title="2.7. Using Emacs as a Development Environment">Section 2.7, &#8220;Using Emacs as a Development Environment&#8221;</a>.</p></div></div><div class="sect1"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="tools-compiling"></a>2.4. Compiling with <code class="command">cc</code></h2></div></div></div><p>This section deals with the <span class="application">gcc</span>
      and <span class="application">clang</span> compilers for C and C++,
      since they come with the FreeBSD base system.  Starting with
      FreeBSD 10.X <code class="command">clang</code> is installed as
      <code class="command">cc</code>.  The details of producing a program with
      an interpreter vary considerably between interpreters, and are
      usually well covered in the documentation and on-line help for
      the interpreter.</p><p>Once you have written your masterpiece, the next step is to
      convert it into something that will (hopefully!) run on FreeBSD.
      This usually involves several steps, each of which is done by a
      separate program.</p><div class="procedure"><ol class="procedure" type="1"><li class="step"><p>Pre-process your source code to remove comments and do
	  other tricks like expanding macros in C.</p></li><li class="step"><p>Check the syntax of your code to see if you have obeyed
	  the rules of the language.  If you have not, it will
	  complain!</p></li><li class="step"><p>Convert the source code into assembly
	  language&#8212;this is very close to machine code, but still
	  understandable by humans.  Allegedly.</p></li><li class="step"><p>Convert the assembly language into machine
	  code&#8212;yep, we are talking bits and bytes, ones and
	  zeros here.</p></li><li class="step"><p>Check that you have used things like functions and
	  global variables in a consistent way.  For example, if you
	  have called a non-existent function, it will
	  complain.</p></li><li class="step"><p>If you are trying to produce an executable from several
	  source code files, work out how to fit them all
	  together.</p></li><li class="step"><p>Work out how to produce something that the system's
	  run-time loader will be able to load into memory and
	  run.</p></li><li class="step"><p>Finally, write the executable on the filesystem.</p></li></ol></div><p>The word <em class="firstterm">compiling</em> is often used to
      refer to just steps 1 to 4&#8212;the others are referred to as
      <em class="firstterm">linking</em>.  Sometimes step 1 is referred to
      as <em class="firstterm">pre-processing</em> and steps 3-4 as
      <em class="firstterm">assembling</em>.</p><p>Fortunately, almost all this detail is hidden from you, as
      <code class="command">cc</code> is a front end that manages calling all
      these programs with the right arguments for you; simply
      typing</p><pre class="screen"><code class="prompt">%</code> <strong class="userinput"><code>cc foobar.c</code></strong></pre><p>will cause <code class="filename">foobar.c</code> to be compiled by
      all the steps above.  If you have more than one file to compile,
      just do something like</p><pre class="screen"><code class="prompt">%</code> <strong class="userinput"><code>cc foo.c bar.c</code></strong></pre><p>Note that the syntax checking is just that&#8212;checking
      the syntax.  It will not check for any logical mistakes you may
      have made, like putting the program into an infinite loop, or
      using a bubble sort when you meant to use a binary
      sort.<a href="#ftn.idp45463288" class="footnote" id="idp45463288"><sup class="footnote">[2]</sup></a></p><p>There are lots and lots of options for
      <code class="command">cc</code>, which are all in the manual page.  Here
      are a few of the most important ones, with examples of how to
      use them.</p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
	  <code class="option">-o <em class="replaceable"><code>filename</code></em></code>
	</span></dt><dd><p>The output name of the file.  If you do not use this
	    option, <code class="command">cc</code> will produce an executable
	    called <code class="filename">a.out</code>.<a href="#ftn.idp45485304" class="footnote" id="idp45485304"><sup class="footnote">[3]</sup></a></p><div class="informalexample"><pre class="screen"><code class="prompt">%</code> <strong class="userinput"><code>cc foobar.c</code></strong>               <em class="lineannotation"><span class="lineannotation">executable is a.out</span></em>
<code class="prompt">%</code> <strong class="userinput"><code>cc -o foobar foobar.c</code></strong>     <em class="lineannotation"><span class="lineannotation">executable is foobar</span></em></pre></div></dd><dt><span class="term"><code class="option">-c</code></span></dt><dd><p>Just compile the file, do not link it.  Useful for toy
	    programs where you just want to check the syntax, or if
	    you are using a <code class="filename">Makefile</code>.</p><div class="informalexample"><pre class="screen"><code class="prompt">%</code> <strong class="userinput"><code>cc -c foobar.c</code></strong></pre></div><p>This will produce an <em class="firstterm">object
	      file</em> (not an executable) called
	    <code class="filename">foobar.o</code>.  This can be linked
	    together with other object files into an
	    executable.</p></dd><dt><span class="term"><code class="option">-g</code></span></dt><dd><p>Create a debug version of the executable.  This makes
	    the compiler put information into the executable about
	    which line of which source file corresponds to which
	    function call.  A debugger can use this information to
	    show the source code as you step through the program,
	    which is <span class="emphasis"><em>very</em></span> useful; the
	    disadvantage is that all this extra information makes the
	    program much bigger.  Normally, you compile with
	    <code class="option">-g</code> while you are developing a program and
	    then compile a <span class="quote">&#8220;<span class="quote">release version</span>&#8221;</span> without
	    <code class="option">-g</code> when you are satisfied it works
	    properly.</p><div class="informalexample"><pre class="screen"><code class="prompt">%</code> <strong class="userinput"><code>cc -g foobar.c</code></strong></pre></div><p>This will produce a debug version of the
	    program.

	    <a href="#ftn.idp45515128" class="footnote" id="idp45515128"><sup class="footnote">[4]</sup></a></p></dd><dt><span class="term"><code class="option">-O</code></span></dt><dd><p>Create an optimized version of the executable.  The
	    compiler performs various clever tricks to try to produce
	    an executable that runs faster than normal.  You can add a
	    number after the <code class="option">-O</code> to specify a higher
	    level of optimization, but this often exposes bugs in the
	    compiler's optimizer.</p><div class="informalexample"><pre class="screen"><code class="prompt">%</code> <strong class="userinput"><code>cc -O -o foobar foobar.c</code></strong></pre></div><p>This will produce an optimized version of
	    <code class="filename">foobar</code>.</p></dd></dl></div><p>The following three flags will force <code class="command">cc</code>
      to check that your code complies to the relevant international
      standard, often referred to as the <acronym class="acronym">ANSI</acronym>
      standard, though strictly speaking it is an
      <acronym class="acronym">ISO</acronym> standard.</p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="option">-Wall</code></span></dt><dd><p>Enable all the warnings which the authors of
	    <code class="command">cc</code> believe are worthwhile.  Despite the
	    name, it will not enable all the warnings
	    <code class="command">cc</code> is capable of.</p></dd><dt><span class="term"><code class="option">-ansi</code></span></dt><dd><p>Turn off most, but not all, of the
	    non-<acronym class="acronym">ANSI</acronym> C features provided by
	    <code class="command">cc</code>.  Despite the name, it does not
	    guarantee strictly that your code will comply to the
	    standard.</p></dd><dt><span class="term"><code class="option">-pedantic</code></span></dt><dd><p>Turn off <span class="emphasis"><em>all</em></span>
	    <code class="command">cc</code>'s non-<acronym class="acronym">ANSI</acronym> C
	    features.</p></dd></dl></div><p>Without these flags, <code class="command">cc</code> will allow you to
      use some of its non-standard extensions to the standard.  Some
      of these are very useful, but will not work with other
      compilers&#8212;in fact, one of the main aims of the standard is
      to allow people to write code that will work with any compiler
      on any system.  This is known as <em class="firstterm">portable
	code</em>.</p><p>Generally, you should try to make your code as portable as
      possible, as otherwise you may have to completely rewrite the
      program later to get it to work somewhere else&#8212;and who
      knows what you may be using in a few years time?</p><div class="informalexample"><pre class="screen"><code class="prompt">%</code> <strong class="userinput"><code>cc -Wall -ansi -pedantic -o foobar foobar.c</code></strong></pre></div><p>This will produce an executable <code class="filename">foobar</code>
      after checking <code class="filename">foobar.c</code> for standard
      compliance.</p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="option">-l<em class="replaceable"><code>library</code></em></code></span></dt><dd><p>Specify a function library to be used at link
	    time.</p><p>The most common example of this is when compiling a
	    program that uses some of the mathematical functions in C.
	    Unlike most other platforms, these are in a separate
	    library from the standard C one and you have to tell the
	    compiler to add it.</p><p>The rule is that if the library is called
	    <code class="filename">lib<em class="replaceable"><code>something</code></em>.a</code>,
	    you give <code class="command">cc</code> the argument
	    <code class="option">-l<em class="replaceable"><code>something</code></em></code>.
	    For example, the math library is
	    <code class="filename">libm.a</code>, so you give
	    <code class="command">cc</code> the argument <code class="option">-lm</code>.
	    A common <span class="quote">&#8220;<span class="quote">gotcha</span>&#8221;</span> with the math library is
	    that it has to be the last library on the command
	    line.</p><div class="informalexample"><pre class="screen"><code class="prompt">%</code> <strong class="userinput"><code>cc -o foobar foobar.c -lm</code></strong></pre></div><p>This will link the math library functions into
	    <code class="filename">foobar</code>.</p><p>If you are compiling C++ code, use
	    <code class="command">c++</code>.  <code class="command">c++</code> can also
	    be invoked as <code class="command">clang++</code> on FreeBSD.</p><div class="informalexample"><pre class="screen"><code class="prompt">%</code> <strong class="userinput"><code>c++ -o foobar foobar.cc</code></strong></pre></div><p>This will both produce an executable
	    <code class="filename">foobar</code> from the C++ source file
	    <code class="filename">foobar.cc</code>.</p></dd></dl></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp45631480"></a>2.4.1. Common <code class="command">cc</code> Queries and Problems</h3></div></div></div><div class="qandaset"><a id="idp45634424"></a><dl><dt>2.4.1.1. <a href="#idp45634680">I am trying to write a program which uses the
	      sin() function and I get an error
	      like this.  What does it mean?</a></dt><dt>2.4.1.2. <a href="#idp45665528">All right, I wrote this simple program to practice
	      using -lm.  All it does is raise 2.1 to
	      the power of 6.</a></dt><dt>2.4.1.3. <a href="#idp45683576">So how do I fix this?</a></dt><dt>2.4.1.4. <a href="#idp45697656">I compiled a file called
	      foobar.c and I cannot find an
	      executable called foobar.  Where
	      has it gone?</a></dt><dt>2.4.1.5. <a href="#idp45724024">OK, I have an executable called
	      foobar, I can see it when I run
	      ls, but when I type in
	      foobar at the command prompt it tells
	      me there is no such file.  Why can it not find
	      it?</a></dt><dt>2.4.1.6. <a href="#idp45742328">I called my executable test,
	      but nothing happens when I run it.  What is going
	      on?</a></dt><dt>2.4.1.7. <a href="#idp45759608">I compiled my program and it seemed to run all right
	      at first, then there was an error and it said something
	      about core dumped.  What does
	      that mean?</a></dt><dt>2.4.1.8. <a href="#idp45767416">Fascinating stuff, but what I am supposed to do
	      now?</a></dt><dt>2.4.1.9. <a href="#idp45773688">When my program dumped core, it said something about
	      a segmentation fault.  What is
	      that?</a></dt><dt>2.4.1.10. <a href="#idp45834616">Sometimes when I get a core dump it says
	      bus error.  It says in my UNIX®
	      book that this means a hardware problem, but the
	      computer still seems to be working.  Is this
	      true?</a></dt><dt>2.4.1.11. <a href="#idp45841912">This dumping core business sounds as though it could
	      be quite useful, if I can make it happen when I want to.
	      Can I do this, or do I have to wait until there is an
	      error?</a></dt></dl><table border="0" style="width: 100%;"><colgroup><col align="left" width="1%" /><col /></colgroup><tbody><tr class="question"><td align="left" valign="top"><a id="idp45634680"></a><a id="idp45635704"></a><p><strong>2.4.1.1.</strong></p></td><td align="left" valign="top"><p>I am trying to write a program which uses the
	      <code class="function">sin()</code> function and I get an error
	      like this.  What does it mean?</p><div class="informalexample"><pre class="screen">/var/tmp/cc0143941.o: Undefined symbol `_sin' referenced from text segment</pre></div></td></tr><tr class="answer"><td align="left" valign="top"></td><td align="left" valign="top"><p>When using mathematical functions like
	      <code class="function">sin()</code>, you have to tell
	      <code class="command">cc</code> to link in the math library, like
	      so:</p><div class="informalexample"><pre class="screen"><code class="prompt">%</code> <strong class="userinput"><code>cc -o foobar foobar.c -lm</code></strong></pre></div></td></tr><tr class="question"><td align="left" valign="top"><a id="idp45665528"></a><a id="idp45666040"></a><p><strong>2.4.1.2.</strong></p></td><td align="left" valign="top"><p>All right, I wrote this simple program to practice
	      using <code class="option">-lm</code>.  All it does is raise 2.1 to
	      the power of 6.</p><div class="informalexample"><pre class="programlisting">#include &lt;stdio.h&gt;

int main() {
	float f;

	f = pow(2.1, 6);
	printf("2.1 ^ 6 = %f\n", f);
	return 0;
}</pre></div><p>and I compiled it as:</p><div class="informalexample"><pre class="screen"><code class="prompt">%</code> <strong class="userinput"><code>cc temp.c -lm</code></strong></pre></div><p>like you said I should, but I get this when I run
	      it:</p><div class="informalexample"><pre class="screen"><code class="prompt">%</code> <strong class="userinput"><code>./a.out</code></strong>
2.1 ^ 6 = 1023.000000</pre></div><p>This is <span class="emphasis"><em>not</em></span> the right answer!
	      What is going on?</p></td></tr><tr class="answer"><td align="left" valign="top"></td><td align="left" valign="top"><p>When the compiler sees you call a function, it
	      checks if it has already seen a prototype for it.  If it
	      has not, it assumes the function returns an
	      <span class="type">int</span>, which is definitely not what you want
	      here.</p></td></tr><tr class="question"><td align="left" valign="top"><a id="idp45683576"></a><a id="idp45684216"></a><p><strong>2.4.1.3.</strong></p></td><td align="left" valign="top"><p>So how do I fix this?</p></td></tr><tr class="answer"><td align="left" valign="top"></td><td align="left" valign="top"><p>The prototypes for the mathematical functions are in
	      <code class="filename">math.h</code>.  If you include this file,
	      the compiler will be able to find the prototype and it
	      will stop doing strange things to your
	      calculation!</p><div class="informalexample"><pre class="programlisting">#include &lt;math.h&gt;
#include &lt;stdio.h&gt;

int main() {
...</pre></div><p>After recompiling it as you did before, run
	      it:</p><div class="informalexample"><pre class="screen"><code class="prompt">%</code> <strong class="userinput"><code>./a.out</code></strong>
2.1 ^ 6 = 85.766121</pre></div><p>If you are using any of the mathematical functions,
	      <span class="emphasis"><em>always</em></span> include
	      <code class="filename">math.h</code> and remember to link in the
	      math library.</p></td></tr><tr class="question"><td align="left" valign="top"><a id="idp45697656"></a><a id="idp45698552"></a><p><strong>2.4.1.4.</strong></p></td><td align="left" valign="top"><p>I compiled a file called
	      <code class="filename">foobar.c</code> and I cannot find an
	      executable called <code class="filename">foobar</code>.  Where
	      has it gone?</p></td></tr><tr class="answer"><td align="left" valign="top"></td><td align="left" valign="top"><p>Remember, <code class="command">cc</code> will call the
	      executable <code class="filename">a.out</code> unless you tell it
	      differently.  Use the
	      <code class="option">-o <em class="replaceable"><code>filename</code></em></code>
	      option:</p><div class="informalexample"><pre class="screen"><code class="prompt">%</code> <strong class="userinput"><code>cc -o foobar foobar.c</code></strong></pre></div></td></tr><tr class="question"><td align="left" valign="top"><a id="idp45724024"></a><a id="idp45724280"></a><p><strong>2.4.1.5.</strong></p></td><td align="left" valign="top"><p>OK, I have an executable called
	      <code class="filename">foobar</code>, I can see it when I run
	      <code class="command">ls</code>, but when I type in
	      <code class="command">foobar</code> at the command prompt it tells
	      me there is no such file.  Why can it not find
	      it?</p></td></tr><tr class="answer"><td align="left" valign="top"></td><td align="left" valign="top"><p>Unlike <span class="trademark">MS-DOS</span>®, <span class="trademark">UNIX</span>® does not look in the current
	      directory when it is trying to find out which executable
	      you want it to run, unless you tell it to.  Type
	      <code class="command">./foobar</code>, which means <span class="quote">&#8220;<span class="quote">run the
		file called <code class="filename">foobar</code> in the current
		directory.</span>&#8221;</span></p></td></tr><tr class="question"><td align="left" valign="top"><a id="idp45742328"></a><a id="idp45742840"></a><p><strong>2.4.1.6.</strong></p></td><td align="left" valign="top"><p>I called my executable <code class="filename">test</code>,
	      but nothing happens when I run it.  What is going
	      on?</p></td></tr><tr class="answer"><td align="left" valign="top"></td><td align="left" valign="top"><p>Most <span class="trademark">UNIX</span>® systems have a program called
	      <code class="command">test</code> in <code class="filename">/usr/bin</code>
	      and the shell is picking that one up before it gets to
	      checking the current directory.  Either type:</p><div class="informalexample"><pre class="screen"><code class="prompt">%</code> <strong class="userinput"><code>./test</code></strong></pre></div><p>or choose a better name for your program!</p></td></tr><tr class="question"><td align="left" valign="top"><a id="idp45759608"></a><a id="idp45759864"></a><p><strong>2.4.1.7.</strong></p></td><td align="left" valign="top"><p>I compiled my program and it seemed to run all right
	      at first, then there was an error and it said something
	      about <span class="errorname">core dumped</span>.  What does
	      that mean?</p></td></tr><tr class="answer"><td align="left" valign="top"></td><td align="left" valign="top"><p>The name <em class="firstterm">core dump</em> dates back
	      to the very early days of <span class="trademark">UNIX</span>®, when the machines used
	      core memory for storing data.  Basically, if the program
	      failed under certain conditions, the system would write
	      the contents of core memory to disk in a file called
	      <code class="filename">core</code>, which the programmer could
	      then pore over to find out what went wrong.</p></td></tr><tr class="question"><td align="left" valign="top"><a id="idp45767416"></a><a id="idp45768312"></a><p><strong>2.4.1.8.</strong></p></td><td align="left" valign="top"><p>Fascinating stuff, but what I am supposed to do
	      now?</p></td></tr><tr class="answer"><td align="left" valign="top"></td><td align="left" valign="top"><p>Use a debugger to analyze the core (see
	      <a class="xref" href="#debugging" title="2.6. Debugging">Section 2.6, &#8220;Debugging&#8221;</a>).</p></td></tr><tr class="question"><td align="left" valign="top"><a id="idp45773688"></a><a id="idp45773944"></a><p><strong>2.4.1.9.</strong></p></td><td align="left" valign="top"><p>When my program dumped core, it said something about
	      a <span class="errorname">segmentation fault</span>.  What is
	      that?</p></td></tr><tr class="answer"><td align="left" valign="top"></td><td align="left" valign="top"><p>This basically means that your program tried to
	      perform some sort of illegal operation on memory; <span class="trademark">UNIX</span>®
	      is designed to protect the operating system and other
	      programs from rogue programs.</p><p>Common causes for this are:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Trying to write to a <span class="symbol">NULL</span>
		  pointer, eg</p><pre class="programlisting">char *foo = NULL;
strcpy(foo, "bang!");</pre></li><li class="listitem"><p>Using a pointer that has not been initialized,
		  eg</p><pre class="programlisting">char *foo;
strcpy(foo, "bang!");</pre><p>The pointer will have some random value that,
		  with luck, will point into an area of memory that is
		  not available to your program and the kernel will
		  kill your program before it can do any damage.  If
		  you are unlucky, it will point somewhere inside your
		  own program and corrupt one of your data structures,
		  causing the program to fail mysteriously.</p></li><li class="listitem"><p>Trying to access past the end of an array,
		  eg</p><pre class="programlisting">int bar[20];
bar[27] = 6;</pre></li><li class="listitem"><p>Trying to store something in read-only memory,
		  eg</p><pre class="programlisting">char *foo = "My string";
strcpy(foo, "bang!");</pre><p><span class="trademark">UNIX</span>® compilers often put string literals like
		  <code class="literal">"My string"</code> into read-only areas
		  of memory.</p></li><li class="listitem"><p>Doing naughty things with
		  <code class="function">malloc()</code> and
		  <code class="function">free()</code>, eg</p><pre class="programlisting">char bar[80];
free(bar);</pre><p>or</p><pre class="programlisting">char *foo = malloc(27);
free(foo);
free(foo);</pre></li></ul></div><p>Making one of these mistakes will not always lead to
	      an error, but they are always bad practice.  Some
	      systems and compilers are more tolerant than others,
	      which is why programs that ran well on one system can
	      crash when you try them on an another.</p></td></tr><tr class="question"><td align="left" valign="top"><a id="idp45834616"></a><a id="idp45835512"></a><p><strong>2.4.1.10.</strong></p></td><td align="left" valign="top"><p>Sometimes when I get a core dump it says
	      <span class="errorname">bus error</span>.  It says in my <span class="trademark">UNIX</span>®
	      book that this means a hardware problem, but the
	      computer still seems to be working.  Is this
	      true?</p></td></tr><tr class="answer"><td align="left" valign="top"></td><td align="left" valign="top"><p>No, fortunately not (unless of course you really do
	      have a hardware problem&#8230;).  This is usually
	      another way of saying that you accessed memory in a way
	      you should not have.</p></td></tr><tr class="question"><td align="left" valign="top"><a id="idp45841912"></a><a id="idp45842168"></a><p><strong>2.4.1.11.</strong></p></td><td align="left" valign="top"><p>This dumping core business sounds as though it could
	      be quite useful, if I can make it happen when I want to.
	      Can I do this, or do I have to wait until there is an
	      error?</p></td></tr><tr class="answer"><td align="left" valign="top"></td><td align="left" valign="top"><p>Yes, just go to another console or xterm, do</p><pre class="screen"><code class="prompt">%</code> <strong class="userinput"><code>ps</code></strong></pre><p>to find out the process ID of your program, and
	      do</p><pre class="screen"><code class="prompt">%</code> <strong class="userinput"><code>kill -ABRT <em class="replaceable"><code>pid</code></em></code></strong></pre><p>where
	      <em class="parameter"><code><em class="replaceable"><code>pid</code></em></code></em> is
	      the process ID you looked up.</p><p>This is useful if your program has got stuck in an
	      infinite loop, for instance.  If your program happens to
	      trap <span class="symbol">SIGABRT</span>, there are several other
	      signals which have a similar effect.</p><p>Alternatively, you can create a core dump from
	      inside your program, by calling the
	      <code class="function">abort()</code> function.  See the manual
	      page of <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=abort&amp;sektion=3&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">abort</span>(3)</span></a> to learn more.</p><p>If you want to create a core dump from outside your
	      program, but do not want the process to terminate, you
	      can use the <code class="command">gcore</code> program.  See the
	      manual page of <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=gcore&amp;sektion=1&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">gcore</span>(1)</span></a> for more
	      information.</p></td></tr></tbody></table></div></div></div><div class="sect1"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="tools-make"></a>2.5. Make</h2></div></div></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp45885432"></a>2.5.1. What is <code class="command">make</code>?</h3></div></div></div><p>When you are working on a simple program with only one or
	two source files, typing in</p><pre class="screen"><code class="prompt">%</code> <strong class="userinput"><code>cc file1.c file2.c</code></strong></pre><p>is not too bad, but it quickly becomes very tedious when
	there are several files&#8212;and it can take a while to
	compile, too.</p><p>One way to get around this is to use object files and only
	recompile the source file if the source code has changed.  So
	we could have something like:</p><pre class="screen"><code class="prompt">%</code> <strong class="userinput"><code>cc file1.o file2.o</code></strong> &#8230; <strong class="userinput"><code>file37.c</code></strong> &#8230;</pre><p>if we had changed <code class="filename">file37.c</code>, but not
	any of the others, since the last time we compiled.  This may
	speed up the compilation quite a bit, but does not solve the
	typing problem.</p><p>Or we could write a shell script to solve the typing
	problem, but it would have to re-compile everything, making it
	very inefficient on a large project.</p><p>What happens if we have hundreds of source files lying
	about? What if we are working in a team with other people who
	forget to tell us when they have changed one of their source
	files that we use?</p><p>Perhaps we could put the two solutions together and write
	something like a shell script that would contain some kind of
	magic rule saying when a source file needs compiling.  Now all
	we need now is a program that can understand these rules, as
	it is a bit too complicated for the shell.</p><p>This program is called <code class="command">make</code>.  It reads
	in a file, called a <em class="firstterm">makefile</em>, that
	tells it how different files depend on each other, and works
	out which files need to be re-compiled and which ones do not.
	For example, a rule could say something like <span class="quote">&#8220;<span class="quote">if
	  <code class="filename">fromboz.o</code> is older than
	  <code class="filename">fromboz.c</code>, that means someone must have
	  changed <code class="filename">fromboz.c</code>, so it needs to be
	  re-compiled.</span>&#8221;</span> The makefile also has rules telling
	make <span class="emphasis"><em>how</em></span> to re-compile the source file,
	making it a much more powerful tool.</p><p>Makefiles are typically kept in the same directory as the
	source they apply to, and can be called
	<code class="filename">makefile</code>, <code class="filename">Makefile</code>
	or <code class="filename">MAKEFILE</code>.  Most programmers use the
	name <code class="filename">Makefile</code>, as this puts it near the
	top of a directory listing, where it can easily be
	seen.<a href="#ftn.idp45926008" class="footnote" id="idp45926008"><sup class="footnote">[5]</sup></a></p></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp45929464"></a>2.5.2. Example of Using <code class="command">make</code></h3></div></div></div><p>Here is a very simple make file:</p><pre class="programlisting">foo: foo.c
	cc -o foo foo.c</pre><p>It consists of two lines, a dependency line and a creation
	line.</p><p>The dependency line here consists of the name of the
	program (known as the <em class="firstterm">target</em>), followed
	by a colon, then whitespace, then the name of the source file.
	When <code class="command">make</code> reads this line, it looks to see
	if <code class="filename">foo</code> exists; if it exists, it compares
	the time <code class="filename">foo</code> was last modified to the
	time <code class="filename">foo.c</code> was last modified.  If
	<code class="filename">foo</code> does not exist, or is older than
	<code class="filename">foo.c</code>, it then looks at the creation line
	to find out what to do.  In other words, this is the rule for
	working out when <code class="filename">foo.c</code> needs to be
	re-compiled.</p><p>The creation line starts with a <span class="token">tab</span> (press
	<span class="keycap"><strong>tab</strong></span>) and then the command you would type to
	create <code class="filename">foo</code> if you were doing it at a
	command prompt.  If <code class="filename">foo</code> is out of date,
	or does not exist, <code class="command">make</code> then executes this
	command to create it.  In other words, this is the rule which
	tells make how to re-compile
	<code class="filename">foo.c</code>.</p><p>So, when you type <strong class="userinput"><code>make</code></strong>, it will
	make sure that <code class="filename">foo</code> is up to date with
	respect to your latest changes to <code class="filename">foo.c</code>.
	This principle can be extended to
	<code class="filename">Makefile</code>s with hundreds of
	targets&#8212;in fact, on FreeBSD, it is possible to compile
	the entire operating system just by typing <strong class="userinput"><code>make
	  world</code></strong> in the appropriate directory!</p><p>Another useful property of makefiles is that the targets
	do not have to be programs.  For instance, we could have a
	make file that looks like this:</p><pre class="programlisting">foo: foo.c
	cc -o foo foo.c

install:
	cp foo /home/me</pre><p>We can tell make which target we want to make by
	typing:</p><pre class="screen"><code class="prompt">%</code> <strong class="userinput"><code>make <em class="replaceable"><code>target</code></em></code></strong></pre><p><code class="command">make</code> will then only look at that target
	and ignore any others.  For example, if we type
	<strong class="userinput"><code>make foo</code></strong> with the makefile above, make
	will ignore the <code class="buildtarget">install</code>
	target.</p><p>If we just type <strong class="userinput"><code>make</code></strong> on its own,
	make will always look at the first target and then stop
	without looking at any others.  So if we typed
	<strong class="userinput"><code>make</code></strong> here, it will just go to the
	<code class="buildtarget">foo</code> target, re-compile
	<code class="filename">foo</code> if necessary, and then stop without
	going on to the <code class="buildtarget">install</code>
	target.</p><p>Notice that the <code class="buildtarget">install</code> target
	does not actually depend on anything! This means that the
	command on the following line is always executed when we try
	to make that target by typing <strong class="userinput"><code>make
	  install</code></strong>.  In this case, it will copy
	<code class="filename">foo</code> into the user's home directory.  This
	is often used by application makefiles, so that the
	application can be installed in the correct directory when it
	has been correctly compiled.</p><p>This is a slightly confusing subject to try to explain.
	If you do not quite understand how <code class="command">make</code>
	works, the best thing to do is to write a simple program like
	<span class="quote">&#8220;<span class="quote">hello world</span>&#8221;</span> and a make file like the one above
	and experiment.  Then progress to using more than one source
	file, or having the source file include a header file.
	<code class="command">touch</code> is very useful here&#8212;it changes
	the date on a file without you having to edit it.</p></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp45999224"></a>2.5.3. Make and include-files</h3></div></div></div><p>C code often starts with a list of files to include, for
	example stdio.h.  Some of these files are system-include
	files, some of them are from the project you are now working
	on:</p><pre class="programlisting">#include &lt;stdio.h&gt;
#include "foo.h"

int main(....</pre><p>To make sure that this file is recompiled the moment
	<code class="filename">foo.h</code> is changed, you have to add it in
	your <code class="filename">Makefile</code>:</p><pre class="programlisting">foo: foo.c foo.h</pre><p>The moment your project is getting bigger and you have
	more and more own include-files to maintain, it will be a pain
	to keep track of all include files and the files which are
	depending on it.  If you change an include-file but forget to
	recompile all the files which are depending on it, the results
	will be devastating.  <code class="command">clang</code> has an option
	to analyze your files and to produce a list of include-files
	and their dependencies: <code class="option">-MM</code>.</p><p>If you add this to your Makefile:</p><pre class="programlisting">depend:
	cc -E -MM *.c &gt; .depend</pre><p>and run <strong class="userinput"><code>make depend</code></strong>, the file
	<code class="filename">.depend</code> will appear with a list of
	object-files, C-files and the include-files:</p><pre class="programlisting">foo.o: foo.c foo.h</pre><p>If you change <code class="filename">foo.h</code>, next time you
	run <code class="command">make</code> all files depending on
	<code class="filename">foo.h</code> will be recompiled.</p><p>Do not forget to run <code class="command">make depend</code> each
	time you add an include-file to one of your files.</p></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp46037496"></a>2.5.4. FreeBSD Makefiles</h3></div></div></div><p>Makefiles can be rather complicated to write.
	Fortunately, BSD-based systems like FreeBSD come with some
	very powerful ones as part of the system.  One very good
	example of this is the FreeBSD ports system.  Here is the
	essential part of a typical ports
	<code class="filename">Makefile</code>:</p><pre class="programlisting">MASTER_SITES=   ftp://freefall.cdrom.com/pub/FreeBSD/LOCAL_PORTS/
DISTFILES=      scheme-microcode+dist-7.3-freebsd.tgz

.include &lt;bsd.port.mk&gt;</pre><p>Now, if we go to the directory for this port and type
	<strong class="userinput"><code>make</code></strong>, the following happens:</p><div class="procedure"><ol class="procedure" type="1"><li class="step"><p>A check is made to see if the source code for this
	    port is already on the system.</p></li><li class="step"><p>If it is not, an FTP connection to the URL in
	    <span class="symbol">MASTER_SITES</span> is set up to download the
	    source.</p></li><li class="step"><p>The checksum for the source is calculated and compared
	    it with one for a known, good, copy of the source.  This
	    is to make sure that the source was not corrupted while in
	    transit.</p></li><li class="step"><p>Any changes required to make the source work on
	    FreeBSD are applied&#8212;this is known as
	    <em class="firstterm">patching</em>.</p></li><li class="step"><p>Any special configuration needed for the source is
	    done.  (Many <span class="trademark">UNIX</span>® program distributions try to work out
	    which version of <span class="trademark">UNIX</span>® they are being compiled on and
	    which optional <span class="trademark">UNIX</span>® features are present&#8212;this is
	    where they are given the information in the FreeBSD ports
	    scenario).</p></li><li class="step"><p>The source code for the program is compiled.  In
	    effect, we change to the directory where the source was
	    unpacked and do <code class="command">make</code>&#8212;the
	    program's own make file has the necessary information to
	    build the program.</p></li><li class="step"><p>We now have a compiled version of the program.  If we
	    wish, we can test it now; when we feel confident about the
	    program, we can type <strong class="userinput"><code>make install</code></strong>.
	    This will cause the program and any supporting files it
	    needs to be copied into the correct location; an entry is
	    also made into a <span class="database">package database</span>, so
	    that the port can easily be uninstalled later if we change
	    our mind about it.</p></li></ol></div><p>Now I think you will agree that is rather impressive for a
	four line script!</p><p>The secret lies in the last line, which tells
	<code class="command">make</code> to look in the system makefile called
	<code class="filename">bsd.port.mk</code>.  It is easy to overlook this
	line, but this is where all the clever stuff comes
	from&#8212;someone has written a makefile that tells
	<code class="command">make</code> to do all the things above (plus a
	couple of other things I did not mention, including handling
	any errors that may occur) and anyone can get access to that
	just by putting a single line in their own make file!</p><p>If you want to have a look at these system makefiles, they
	are in <code class="filename">/usr/share/mk</code>, but it is probably
	best to wait until you have had a bit of practice with
	makefiles, as they are very complicated (and if you do look at
	them, make sure you have a flask of strong coffee
	handy!)</p></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp46092408"></a>2.5.5. More Advanced Uses of <code class="command">make</code></h3></div></div></div><p><code class="command">Make</code> is a very powerful tool, and can
	do much more than the simple example above shows.
	Unfortunately, there are several different versions of
	<code class="command">make</code>, and they all differ considerably.
	The best way to learn what they can do is probably to read the
	documentation&#8212;hopefully this introduction will have
	given you a base from which you can do this.</p><p>The version of make that comes with FreeBSD is the
	<span class="application">Berkeley make</span>; there is a tutorial
	for it in <code class="filename">/usr/share/doc/psd/12.make</code>.  To
	view it, do</p><pre class="screen"><code class="prompt">%</code> <strong class="userinput"><code>zmore paper.ascii.gz</code></strong></pre><p>in that directory.</p><p>Many applications in the ports use <span class="application">GNU
	  make</span>, which has a very good set of
	<span class="quote">&#8220;<span class="quote">info</span>&#8221;</span> pages.  If you have installed any of these
	ports, <span class="application">GNU make</span> will automatically
	have been installed as <code class="command">gmake</code>.  It is also
	available as a port and package in its own right.</p><p>To view the info pages for <span class="application">GNU
	  make</span>, you will have to edit
	<code class="filename">dir</code> in the
	<code class="filename">/usr/local/info</code> directory to add an entry
	for it.  This involves adding a line like</p><pre class="programlisting"> * Make: (make).                 The GNU Make utility.</pre><p>to the file.  Once you have done this, you can type
	<strong class="userinput"><code>info</code></strong> and then select
	<span class="guimenuitem">make</span> from the menu (or in
	<span class="application">Emacs</span>, do <strong class="userinput"><code>C-h
	  i</code></strong>).</p></div></div><div class="sect1"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="debugging"></a>2.6. Debugging</h2></div></div></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp46131960"></a>2.6.1. Introduction to Available Debuggers</h3></div></div></div><p>Using a debugger allows running the program under more
	controlled circumstances.  Typically, it is possible to step
	through the program a line at a time, inspect the value of
	variables, change them, tell the debugger to run up to a
	certain point and then stop, and so on.  It is also possible
	to attach to a program that is already running, or load a core
	file to investigate why the program crashed.  It is even
	possible to debug the kernel, though that is a little trickier
	than the user applications we will be discussing in this
	section.</p><p>This section is intended to be a quick introduction to
	using debuggers and does not cover specialized topics such as
	debugging the kernel.  For more information about that, refer
	to <a class="xref" href="#kerneldebug" title="Chapter 10. Kernel Debugging">Chapter 10, <em>Kernel Debugging</em></a>.</p><p>The standard debugger supplied with
	FreeBSD 12.1 is called <code class="command">lldb</code>
	(<span class="application">LLVM debugger</span>).  As it is part of
	the standard installation for that release, there is no need
	to do anything special to use it.  It has good command help,
	accessible via the <strong class="userinput"><code>help</code></strong> command, as
	well as <a class="link" href="https://lldb.llvm.org/" target="_top">a web
	tutorial and documentation</a>.</p><div xmlns="" class="note"><h3 class="admontitle">Note: </h3><p xmlns="http://www.w3.org/1999/xhtml">The <code class="command">lldb</code> command is available for
	  FreeBSD 11.3 <a class="link" href="../../../../doc/en_US.ISO8859-1/books/handbook/ports-using.html" target="_top">from
	    ports or packages</a> as
	  <a xmlns="" class="package" href="https://www.freebsd.org/cgi/url.cgi?ports/devel/llvm/pkg-descr">devel/llvm</a>.  This will install the
	  default version of lldb (currently 9.0).</p></div><p>The other debugger available with FreeBSD is called
	<code class="command">gdb</code> (<span class="application">GNU
	  debugger</span>).  Unlike lldb, it is not installed
	by default on FreeBSD 12.1; to use it, <a class="link" href="../../../../doc/en_US.ISO8859-1/books/handbook/ports-using.html" target="_top">install</a>
	<a xmlns="" class="package" href="https://www.freebsd.org/cgi/url.cgi?ports/devel/gdb/pkg-descr">devel/gdb</a> from ports or packages.  The
	version installed by default on FreeBSD 11.3 is
	old; instead, install <a xmlns="" class="package" href="https://www.freebsd.org/cgi/url.cgi?ports/devel/gdb/pkg-descr">devel/gdb</a> there as
	well.  It has quite good on-line help, as well as a set of
	info pages.</p><p>Which one to use is largely a matter of taste.  If
	familiar with one only, use that one.  People familiar
	with neither or both but wanting to use one from inside
	<span class="application">Emacs</span> will need to use
	<code class="command">gdb</code> as <code class="command">lldb</code> is
	unsupported by <span class="application">Emacs</span>.  Otherwise,
	try both and see which one you prefer.</p></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp46163960"></a>2.6.2. Using lldb</h3></div></div></div><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp46166520"></a>2.6.2.1. Starting lldb</h4></div></div></div><p>Start up lldb by typing</p><pre class="screen"><code class="prompt">%</code> <strong class="userinput"><code>lldb -- <em class="replaceable"><code>progname</code></em></code></strong></pre></div><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp46173176"></a>2.6.2.2. Running a Program with lldb</h4></div></div></div><p>Compile the program with <code class="option">-g</code> to get the
	  most out of using <code class="command">lldb</code>.  It will work
	  without, but will only display the name of the function
	  currently running, instead of the source code.  If it
	  displays a line like:</p><pre class="screen">Breakpoint 1: where = temp`main, address = &#8230;</pre><p>(without an indication of source code filename and line
	  number) when setting a breakpoint, this means that the
	  program was not compiled with <code class="option">-g</code>.</p><div xmlns="" class="tip"><h3 class="admontitle">Tip: </h3><p xmlns="http://www.w3.org/1999/xhtml">Most <code class="command">lldb</code> commands have shorter
	    forms that can be used instead.  The longer forms are
	    used here for clarity.</p></div><p>At the <code class="command">lldb</code> prompt, type
	  <strong class="userinput"><code>breakpoint set -n main</code></strong>.  This will
	  tell the debugger not to display the preliminary set-up code
	  in the program being run and to stop execution at the
	  beginning of the program's code.  Now type
	  <strong class="userinput"><code>process launch</code></strong> to actually start the
	  program&#8212; it will start at the beginning of the set-up
	  code and then get stopped by the debugger when it calls
	  <code class="function">main()</code>.</p><p>To step through the program a line at a time, type
	  <strong class="userinput"><code>thread step-over</code></strong>.  When the program
	  gets to a function call, step into it by typing
	  <strong class="userinput"><code>thread step-in</code></strong>.  Once in a function
	  call, return from it by typing
	  <strong class="userinput"><code>thread step-out</code></strong> or use
	  <strong class="userinput"><code>up</code></strong> and <strong class="userinput"><code>down</code></strong> to
	  take a quick look at the caller.</p><p>Here is a simple example of how to spot a mistake in a
	  program with <code class="command">lldb</code>.  This is our program
	  (with a deliberate mistake):</p><pre class="programlisting">#include &lt;stdio.h&gt;

int bazz(int anint);

main() {
	int i;

	printf("This is my program\n");
	bazz(i);
	return 0;
}

int bazz(int anint) {
	printf("You gave me %d\n", anint);
	return anint;
}</pre><p>This program sets <span class="symbol">i</span> to be
	  <code class="literal">5</code> and passes it to a function
	  <code class="function">bazz()</code> which prints out the number we
	  gave it.</p><p>Compiling and running the program displays</p><pre class="screen"><code class="prompt">%</code> <strong class="userinput"><code>cc -g -o temp temp.c</code></strong>
<code class="prompt">%</code> <strong class="userinput"><code>./temp</code></strong>
This is my program
anint = -5360</pre><p>That is not what was expected! Time to see what is going
	  on!</p><pre class="screen"><code class="prompt">%</code> <strong class="userinput"><code>lldb -- temp</code></strong>
(lldb) target create "temp"
Current executable set to 'temp' (x86_64).
(lldb) <strong class="userinput"><code>breakpoint set -n main</code></strong>				<em class="lineannotation"><span class="lineannotation">Skip the set-up code</span></em>
Breakpoint 1: where = temp`main + 15 at temp.c:8:2, address = 0x00000000002012ef	<em class="lineannotation"><span class="lineannotation">lldb puts breakpoint at main()</span></em>
(lldb) <strong class="userinput"><code>process launch</code></strong>					<em class="lineannotation"><span class="lineannotation">Run as far as main()</span></em>
Process 9992 launching
Process 9992 launched: '/home/pauamma/tmp/temp' (x86_64)	<em class="lineannotation"><span class="lineannotation">Program starts running</span></em>

Process 9992 stopped
* thread #1, name = 'temp', stop reason = breakpoint 1.1	<em class="lineannotation"><span class="lineannotation">lldb stops at main()</span></em>
    frame #0: 0x00000000002012ef temp`main at temp.c:8:2
   5	main() {
   6		int i;
   7
-&gt; 8		printf("This is my program\n");			<em class="lineannotation"><span class="lineannotation">Indicates the line where it stopped</span></em>
   9		bazz(i);
   10		return 0;
   11	}
(lldb) <strong class="userinput"><code>thread step-over</code></strong>			<em class="lineannotation"><span class="lineannotation">Go to next line</span></em>
This is my program						<em class="lineannotation"><span class="lineannotation">Program prints out</span></em>
Process 9992 stopped
* thread #1, name = 'temp', stop reason = step over
    frame #0: 0x0000000000201300 temp`main at temp.c:9:7
   6		int i;
   7
   8		printf("This is my program\n");
-&gt; 9		bazz(i);
   10		return 0;
   11	}
   12
(lldb) <strong class="userinput"><code>thread step-in</code></strong>			<em class="lineannotation"><span class="lineannotation">step into bazz()</span></em>
Process 9992 stopped
* thread #1, name = 'temp', stop reason = step in
    frame #0: 0x000000000020132b temp`bazz(anint=-5360) at temp.c:14:29	<em class="lineannotation"><span class="lineannotation">lldb displays stack frame</span></em>
   11	}
   12
   13	int bazz(int anint) {
-&gt; 14		printf("You gave me %d\n", anint);
   15		return anint;
   16	}
(lldb)</pre><p>Hang on a minute! How did <span class="symbol">anint</span> get to
	  be <code class="literal">-5360</code>? Was it not set to
	  <code class="literal">5</code> in <code class="function">main()</code>? Let us
	  move up to <code class="function">main()</code> and have a
	  look.</p><pre class="screen">(lldb) <strong class="userinput"><code>up</code></strong>		<em class="lineannotation"><span class="lineannotation">Move up call stack</span></em>
frame #1: 0x000000000020130b temp`main at temp.c:9:2		<em class="lineannotation"><span class="lineannotation">lldb displays stack frame</span></em>
   6		int i;
   7
   8		printf("This is my program\n");
-&gt; 9		bazz(i);
   10		return 0;
   11	}
   12
(lldb) <strong class="userinput"><code>frame variable i</code></strong>			<em class="lineannotation"><span class="lineannotation">Show us the value of i</span></em>
(int) i = -5360							<em class="lineannotation"><span class="lineannotation">lldb displays -5360</span></em></pre><p>Oh dear! Looking at the code, we forgot to initialize
	  <span class="symbol">i</span>.  We meant to put</p><pre class="programlisting"><em class="lineannotation"><span class="lineannotation">&#8230;</span></em>
main() {
	int i;

	i = 5;
	printf("This is my program\n");
<em class="lineannotation"><span class="lineannotation">&#8230;</span></em></pre><p>but we left the <code class="literal">i=5;</code> line out.  As we
	  did not initialize <span class="symbol">i</span>, it had whatever
	  number happened to be in that area of memory when the
	  program ran, which in this case happened to be
	  <code class="literal">-5360</code>.</p><div xmlns="" class="note"><h3 class="admontitle">Note: </h3><p xmlns="http://www.w3.org/1999/xhtml">The <code class="command">lldb</code> command displays the stack
	    frame every time we go into or out of a function, even if
	    we are using <strong class="userinput"><code>up</code></strong> and
	    <strong class="userinput"><code>down</code></strong> to move around the call stack.
	    This shows the name of the function and the values of its
	    arguments, which helps us keep track of where we are and
	    what is going on.  (The stack is a storage area where the
	    program stores information about the arguments passed to
	    functions and where to go when it returns from a function
	    call.)</p></div></div><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp46280056"></a>2.6.2.3. Examining a Core File with lldb</h4></div></div></div><p>A core file is basically a file which contains the
	  complete state of the process when it crashed.  In
	  <span class="quote">&#8220;<span class="quote">the good old days</span>&#8221;</span>, programmers had to print
	  out hex listings of core files and sweat over machine code
	  manuals, but now life is a bit easier.  Incidentally, under
	  FreeBSD and other 4.4BSD systems, a core file is called
	  <code class="filename"><em class="replaceable"><code>progname</code></em>.core</code>
	  instead of just <code class="filename">core</code>, to make it
	  clearer which program a core file belongs to.</p><p>To examine a core file, specify the name of the core
	  file in addition to the program itself.  Instead of starting
	  up <code class="command">lldb</code> in the usual way, type
	  <strong class="userinput"><code>lldb -c <em class="replaceable"><code>progname</code></em>.core
	    -- <em class="replaceable"><code>progname</code></em></code></strong></p><p>The debugger will display something like this:</p><pre class="screen"><code class="prompt">%</code> <strong class="userinput"><code>lldb -c <code class="filename"><em class="replaceable"><code>progname</code></em>.core</code> -- <code class="filename"><em class="replaceable"><code>progname</code></em></code></code></strong>
(lldb) target create "<code class="filename"><em class="replaceable"><code>progname</code></em></code>" --core "<code class="filename"><em class="replaceable"><code>progname</code></em></code>.core"
Core file '/home/pauamma/tmp/<code class="filename"><em class="replaceable"><code>progname</code></em>.core</code>' (x86_64) was loaded.
(lldb)</pre><p>In this case, the program was called
	  <code class="filename"><em class="replaceable"><code>progname</code></em></code>, so
	  the core file is called
	  <code class="filename"><em class="replaceable"><code>progname</code></em>.core</code>.
	  The debugger does not display why the program crashed or
	  where.  For this, use
	  <strong class="userinput"><code>thread backtrace all</code></strong>.  This will also
	  show how the function where the program dumped core was
	  called.</p><pre class="screen">(lldb) <strong class="userinput"><code>thread backtrace all</code></strong>
* thread #1, name = '<code class="filename"><em class="replaceable"><code>progname</code></em></code>', stop reason = signal SIGSEGV
  * frame #0: 0x0000000000201347 <code class="filename"><em class="replaceable"><code>progname</code></em></code>`bazz(anint=5) at temp2.c:17:10
    frame #1: 0x0000000000201312 <code class="filename"><em class="replaceable"><code>progname</code></em></code>`main at temp2.c:10:2
    frame #2: 0x000000000020110f <code class="filename"><em class="replaceable"><code>progname</code></em></code>`_start(ap=&lt;unavailable&gt;, cleanup=&lt;unavailable&gt;) at crt1.c:76:7
(lldb)</pre><p><code class="literal">SIGSEGV</code> indicates that the program
	  tried to access memory (run code or read/write data usually)
	  at a location that does not belong to it, but does not give
	  any specifics.  For that, look at the source code at line 10
	  of file temp2.c, in <code class="function">bazz()</code>.  The
	  backtrace also says that in this case,
	  <code class="function">bazz()</code> was called from
	  <code class="function">main()</code>.</p></div><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp46333048"></a>2.6.2.4. Attaching to a Running Program with lldb</h4></div></div></div><p>One of the neatest features about
	  <code class="command">lldb</code> is that it can attach to a program
	  that is already running.  Of course, that requires
	  sufficient permissions to do so.  A common problem is
	  stepping through a program that forks and wanting to trace
	  the child, but the debugger will only trace the
	  parent.</p><p>To do that, start up another <code class="command">lldb</code>,
	  use <code class="command">ps</code> to find the process ID for the
	  child, and do</p><pre class="screen">(lldb) <strong class="userinput"><code>process attach -p <em class="replaceable"><code>pid</code></em></code></strong></pre><p>in <code class="command">lldb</code>, and then debug as
	  usual.</p><p>For that to work well, the code that calls
	  <code class="function">fork</code> to create the child needs to do
	  something like the following (courtesy of the
	  <code class="command">gdb</code> info pages):</p><pre class="programlisting"><em class="lineannotation"><span class="lineannotation">&#8230;</span></em>
if ((pid = fork()) &lt; 0)		/* _Always_ check this */
	error();
else if (pid == 0) {		/* child */
	int PauseMode = 1;

	while (PauseMode)
		sleep(10);	/* Wait until someone attaches to us */
	<em class="lineannotation"><span class="lineannotation">&#8230;</span></em>
} else {			/* parent */
	<em class="lineannotation"><span class="lineannotation">&#8230;</span></em></pre><p>Now all that is needed is to attach to the child, set
	  <span class="symbol">PauseMode</span> to <code class="literal">0</code> with
	  <strong class="userinput"><code>expr PauseMode = 0</code></strong> and wait
	  for the <code class="function">sleep()</code> call to return.</p></div></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp46377976"></a>2.6.3. Using gdb</h3></div></div></div><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp46379512"></a>2.6.3.1. Starting gdb</h4></div></div></div><p>Start up gdb by typing</p><pre class="screen"><code class="prompt">%</code> <strong class="userinput"><code>gdb <em class="replaceable"><code>progname</code></em></code></strong></pre><p>although many people prefer to run it inside
	<span class="application">Emacs</span>.  To do this, type:</p><pre class="screen"><strong class="userinput"><code>M-x gdb RET <em class="replaceable"><code>progname</code></em> RET</code></strong></pre><p>Finally, for those finding its text-based command-prompt
	style off-putting, there is a graphical front-end for it
	(<a xmlns="" class="package" href="https://www.freebsd.org/cgi/url.cgi?ports/devel/xxgdb/pkg-descr">devel/xxgdb</a>) in the Ports
	Collection.</p></div><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp46394872"></a>2.6.3.2. Running a Program with gdb</h4></div></div></div><p>Compile the program with
	<code class="option">-g</code> to get the most out of using
	<code class="command">gdb</code>.  It will work without, but will
	only display the name of the function currently running,
	instead of the source code.  A line like:</p><pre class="screen">&#8230; (no debugging symbols found) &#8230;</pre><p>when <code class="command">gdb</code> starts up means that the
	program was not compiled with <code class="option">-g</code>.</p><p>At the <code class="command">gdb</code> prompt, type
	<strong class="userinput"><code>break main</code></strong>.  This will tell the
	debugger to skip the preliminary set-up code in the program
	being run and to stop execution at the beginning of the
	program's code.  Now type <strong class="userinput"><code>run</code></strong> to start
	the program&#8212; it will start at the beginning of the
	set-up code and then get stopped by the debugger when it calls
	<code class="function">main()</code>.</p><p>To step through the program a line at a time, press
	<code class="command">n</code>.  When at a function call, step into it
	by pressing <code class="command">s</code>.  Once in a function call,
	return from it by pressing <code class="command">f</code>, or use
	<code class="command">up</code> and <code class="command">down</code> to take
	a quick look at the caller.</p><p>Here is a simple example of how to spot a mistake in a
	program with <code class="command">gdb</code>.  This is our program
	(with a deliberate mistake):</p><pre class="programlisting">#include &lt;stdio.h&gt;

int bazz(int anint);

main() {
	int i;

	printf("This is my program\n");
	bazz(i);
	return 0;
}

int bazz(int anint) {
	printf("You gave me %d\n", anint);
	return anint;
}</pre><p>This program sets <span class="symbol">i</span> to be
	<code class="literal">5</code> and passes it to a function
	<code class="function">bazz()</code> which prints out the number we
	gave it.</p><p>Compiling and running the program displays</p><pre class="screen"><code class="prompt">%</code> <strong class="userinput"><code>cc -g -o temp temp.c</code></strong>
<code class="prompt">%</code> <strong class="userinput"><code>./temp</code></strong>
This is my program
anint = 4231</pre><p>That was not what we expected! Time to see what is going
	on!</p><pre class="screen"><code class="prompt">%</code> <strong class="userinput"><code>gdb temp</code></strong>
GDB is free software and you are welcome to distribute copies of it
 under certain conditions; type "show copying" to see the conditions.
There is absolutely no warranty for GDB; type "show warranty" for details.
GDB 4.13 (i386-unknown-freebsd), Copyright 1994 Free Software Foundation, Inc.
(gdb) <strong class="userinput"><code>break main</code></strong>				<em class="lineannotation"><span class="lineannotation">Skip the set-up code</span></em>
Breakpoint 1 at 0x160f: file temp.c, line 9.	<em class="lineannotation"><span class="lineannotation">gdb puts breakpoint at main()</span></em>
(gdb) <strong class="userinput"><code>run</code></strong>					<em class="lineannotation"><span class="lineannotation">Run as far as main()</span></em>
Starting program: /home/james/tmp/temp		<em class="lineannotation"><span class="lineannotation">Program starts running</span></em>

Breakpoint 1, main () at temp.c:9		<em class="lineannotation"><span class="lineannotation">gdb stops at main()</span></em>
(gdb) <strong class="userinput"><code>n</code></strong>						<em class="lineannotation"><span class="lineannotation">Go to next line</span></em>
This is my program				<em class="lineannotation"><span class="lineannotation">Program prints out</span></em>
(gdb) <strong class="userinput"><code>s</code></strong>						<em class="lineannotation"><span class="lineannotation">step into bazz()</span></em>
bazz (anint=4231) at temp.c:17			<em class="lineannotation"><span class="lineannotation">gdb displays stack frame</span></em>
(gdb)</pre><p>Hang on a minute! How did <span class="symbol">anint</span> get to be
	<code class="literal">4231</code>? Was it not set to
	<code class="literal">5</code> in <code class="function">main()</code>? Let us
	move up to <code class="function">main()</code> and have a look.</p><pre class="screen">(gdb) <strong class="userinput"><code>up</code></strong>					<em class="lineannotation"><span class="lineannotation">Move up call stack</span></em>
#1  0x1625 in main () at temp.c:11		<em class="lineannotation"><span class="lineannotation">gdb displays stack frame</span></em>
(gdb) <strong class="userinput"><code>p i</code></strong>					<em class="lineannotation"><span class="lineannotation">Show us the value of i</span></em>
$1 = 4231					<em class="lineannotation"><span class="lineannotation">gdb displays 4231</span></em></pre><p>Oh dear! Looking at the code, we forgot to initialize
	<span class="symbol">i</span>.  We meant to put</p><pre class="programlisting"><em class="lineannotation"><span class="lineannotation">&#8230;</span></em>
main() {
	int i;

	i = 5;
	printf("This is my program\n");
<em class="lineannotation"><span class="lineannotation">&#8230;</span></em></pre><p>but we left the <code class="literal">i=5;</code> line out.  As we
	did not initialize <span class="symbol">i</span>, it had whatever number
	happened to be in that area of memory when the program ran,
	which in this case happened to be
	<code class="literal">4231</code>.</p><div xmlns="" class="note"><h3 class="admontitle">Note: </h3><p xmlns="http://www.w3.org/1999/xhtml">The <code class="command">gdb</code> command displays the stack
	  frame every time we go into or out of a function, even if we
	  are using <code class="command">up</code> and <code class="command">down</code>
	  to move around the call stack.  This shows the name of the
	  function and the values of its arguments, which helps us
	  keep track of where we are and what is going on.  (The stack
	  is a storage area where the program stores information about
	  the arguments passed to functions and where to go when it
	  returns from a function call.)</p></div></div><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp46490744"></a>2.6.3.3. Examining a Core File with gdb</h4></div></div></div><p>A core file is basically a file which contains the
	complete state of the process when it crashed.  In <span class="quote">&#8220;<span class="quote">the
	  good old days</span>&#8221;</span>, programmers had to print out hex
	listings of core files and sweat over machine code manuals,
	but now life is a bit easier.  Incidentally, under FreeBSD and
	other 4.4BSD systems, a core file is called
	<code class="filename"><em class="replaceable"><code>progname</code></em>.core</code>
	instead of just <code class="filename">core</code>, to make it clearer
	which program a core file belongs to.</p><p>To examine a core file, start up <code class="command">gdb</code> in
	the usual way.  Instead of typing <code class="command">break</code> or
	<code class="command">run</code>, type</p><pre class="screen">(gdb) <strong class="userinput"><code>core <em class="replaceable"><code>progname</code></em>.core</code></strong></pre><p>If the core file is not in the current directory, type
	<strong class="userinput"><code>dir /path/to/core/file</code></strong> first.</p><p>The debugger should display something like this:</p><pre class="screen"><code class="prompt">%</code> <strong class="userinput"><code>gdb <code class="filename"><em class="replaceable"><code>progname</code></em></code></code></strong>
GDB is free software and you are welcome to distribute copies of it
 under certain conditions; type "show copying" to see the conditions.
There is absolutely no warranty for GDB; type "show warranty" for details.
GDB 4.13 (i386-unknown-freebsd), Copyright 1994 Free Software Foundation, Inc.
(gdb) <strong class="userinput"><code>core <code class="filename"><em class="replaceable"><code>progname</code></em>.core</code></code></strong>
Core was generated by `<code class="filename"><em class="replaceable"><code>progname</code></em></code>'.
Program terminated with signal 11, Segmentation fault.
Cannot access memory at address 0x7020796d.
#0  0x164a in bazz (anint=0x5) at temp.c:17
(gdb)</pre><p>In this case, the program was called
	<code class="filename"><em class="replaceable"><code>progname</code></em></code>, so
	the core file is called
	<code class="filename"><em class="replaceable"><code>progname</code></em>.core</code>.
	We can see that the program crashed due to trying to access an
	area in memory that was not available to it in a function
	called <code class="function">bazz</code>.</p><p>Sometimes it is useful to be able to see how a function
	was called, as the problem could have occurred a long way up
	the call stack in a complex program.  <code class="command">bt</code>
	causes <code class="command">gdb</code> to print out a back-trace of the
	call stack:</p><pre class="screen">(gdb) <strong class="userinput"><code>bt</code></strong>
#0  0x164a in bazz (anint=0x5) at temp.c:17
#1  0xefbfd888 in end ()
#2  0x162c in main () at temp.c:11
(gdb)</pre><p>The <code class="function">end()</code> function is called when a
	program crashes; in this case, the <code class="function">bazz()</code>
	function was called from <code class="function">main()</code>.</p></div><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp49040632"></a>2.6.3.4. Attaching to a Running Program with gdb</h4></div></div></div><p>One of the neatest features about <code class="command">gdb</code>
	is that it can attach to a program that is already running.
	Of course, that requires sufficient permissions to do
	so.  A common problem is stepping through a program that forks
	and wanting to trace the child, but the debugger will only
	trace the parent.</p><p>To do that, start up another <code class="command">gdb</code>,
	use <code class="command">ps</code> to find the process ID for the
	child, and do</p><pre class="screen">(gdb) <strong class="userinput"><code>attach <em class="replaceable"><code>pid</code></em></code></strong></pre><p>in <code class="command">gdb</code>, and then debug as usual.</p><p>For that to work well, the code that calls
	<code class="function">fork</code> to create the child needs to do
	something like the following (courtesy of the
	<code class="command">gdb</code> info pages):</p><pre class="programlisting"><em class="lineannotation"><span class="lineannotation">&#8230;</span></em>
if ((pid = fork()) &lt; 0)		/* _Always_ check this */
	error();
else if (pid == 0) {		/* child */
	int PauseMode = 1;

	while (PauseMode)
		sleep(10);	/* Wait until someone attaches to us */
	<em class="lineannotation"><span class="lineannotation">&#8230;</span></em>
} else {			/* parent */
	<em class="lineannotation"><span class="lineannotation">&#8230;</span></em></pre><p>Now all that is needed is to attach to the child, set
	<span class="symbol">PauseMode</span> to <code class="literal">0</code>, and wait
	for the <code class="function">sleep()</code> call to return!</p></div></div></div><div class="sect1"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="emacs"></a>2.7. Using Emacs as a Development Environment</h2></div></div></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp49054072"></a>2.7.1. Emacs</h3></div></div></div><p>Emacs is a highly customizable
	editor&#8212;indeed, it has been customized to the point where
	it is more like an operating system than an editor! Many
	developers and sysadmins do in fact spend practically all
	their time working inside Emacs, leaving it only to log
	out.</p><p>It is impossible even to summarize everything Emacs can do
	here, but here are some of the features of interest to
	developers:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Very powerful editor, allowing search-and-replace on
	    both strings and regular expressions (patterns), jumping
	    to start/end of block expression, etc, etc.</p></li><li class="listitem"><p>Pull-down menus and online help.</p></li><li class="listitem"><p>Language-dependent syntax highlighting and
	    indentation.</p></li><li class="listitem"><p>Completely customizable.</p></li><li class="listitem"><p>You can compile and debug programs within
	    Emacs.</p></li><li class="listitem"><p>On a compilation error, you can jump to the offending
	    line of source code.</p></li><li class="listitem"><p>Friendly-ish front-end to the <code class="command">info</code>
	    program used for reading GNU hypertext documentation,
	    including the documentation on Emacs itself.</p></li><li class="listitem"><p>Friendly front-end to <code class="command">gdb</code>, allowing
	    you to look at the source code as you step through your
	    program.</p></li></ul></div><p>And doubtless many more that have been overlooked.</p><p>Emacs can be installed on FreeBSD using
	the <a xmlns="" class="package" href="https://www.freebsd.org/cgi/url.cgi?ports/editors/emacs/pkg-descr">editors/emacs</a>
	port.</p><p>Once it is installed, start it up and do <code class="literal">C-h
	  t</code> to read an Emacs tutorial&#8212;that means hold
	down <span class="keycap"><strong>control</strong></span>, press <span class="keycap"><strong>h</strong></span>, let
	go of <span class="keycap"><strong>control</strong></span>, and then press
	<span class="keycap"><strong>t</strong></span>.  (Alternatively, you can use the mouse to
	select <span class="guimenuitem">Emacs Tutorial</span> from the
	<span class="guimenu">Help</span> menu.)</p><p>Although Emacs does have menus, it is well worth learning
	the key bindings, as it is much quicker when you are editing
	something to press a couple of keys than to try to find the
	mouse and then click on the right place.  And, when you are
	talking to seasoned Emacs users, you will find they often
	casually throw around expressions like <span class="quote">&#8220;<span class="quote"><code class="literal">M-x
	    replace-s RET foo RET bar RET</code></span>&#8221;</span> so it is
	useful to know what they mean.  And in any case, Emacs has far
	too many useful functions for them to all fit on the menu
	bars.</p><p>Fortunately, it is quite easy to pick up the key-bindings,
	as they are displayed next to the menu item.  My advice is to
	use the menu item for, say, opening a file until you
	understand how it works and feel confident with it, then try
	doing C-x C-f.  When you are happy with that, move on to
	another menu command.</p><p>If you cannot remember what a particular combination of
	keys does, select <span class="guimenuitem">Describe Key</span> from
	the <span class="guimenu">Help</span> menu and type it in&#8212;Emacs
	will tell you what it does.  You can also use the
	<span class="guimenuitem">Command Apropos</span> menu item to find
	out all the commands which contain a particular word in them,
	with the key binding next to it.</p><p>By the way, the expression above means hold down the
	<span class="keysym">Meta</span> key, press <span class="keysym">x</span>, release
	the <span class="keysym">Meta</span> key, type
	<strong class="userinput"><code>replace-s</code></strong> (short for
	<code class="literal">replace-string</code>&#8212;another feature of
	Emacs is that you can abbreviate commands), press the
	<span class="keysym">return</span> key, type <strong class="userinput"><code>foo</code></strong>
	(the string you want replaced), press the
	<span class="keysym">return</span> key, type bar (the string you want to
	replace <code class="literal">foo</code> with) and press
	<span class="keysym">return</span> again.  Emacs will then do the
	search-and-replace operation you have just requested.</p><p>If you are wondering what on earth <span class="keysym">Meta</span>
	is, it is a special key that many <span class="trademark">UNIX</span>® workstations have.
	Unfortunately, PC's do not have one, so it is usually
	<span class="keycap"><strong>alt</strong></span> (or if you are unlucky, the
	<span class="keysym">escape</span> key).</p><p>Oh, and to get out of Emacs, do <code class="command">C-x C-c</code>
	(that means hold down the <span class="keysym">control</span> key, press
	<span class="keysym">x</span>, press <span class="keysym">c</span> and release the
	<span class="keysym">control</span> key).  If you have any unsaved files
	open, Emacs will ask you if you want to save them.  (Ignore
	the bit in the documentation where it says
	<code class="command">C-z</code> is the usual way to leave
	Emacs&#8212;that leaves Emacs hanging around in the
	background, and is only really useful if you are on a system
	which does not have virtual terminals).</p></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp49095544"></a>2.7.2. Configuring Emacs</h3></div></div></div><p>Emacs does many wonderful things; some of them are built
	in, some of them need to be configured.</p><p>Instead of using a proprietary macro language for
	configuration, Emacs uses a version of Lisp specially adapted
	for editors, known as Emacs Lisp.  Working with Emacs Lisp can
	be quite helpful if you want to go on and learn something like
	Common Lisp.  Emacs Lisp has many features of Common Lisp,
	although it is considerably smaller (and thus easier to
	master).</p><p>The best way to learn Emacs Lisp is to download the <a class="link" href="ftp://ftp.gnu.org/old-gnu/emacs/elisp-manual-19-2.4.tar.gz" target="_top">Emacs
	  Tutorial</a></p><p>However, there is no need to actually know any Lisp to get
	started with configuring Emacs, as I have included a sample
	<code class="filename">.emacs</code>, which should be enough to get you
	started.  Just copy it into your home directory and restart
	Emacs if it is already running; it will read the commands from
	the file and (hopefully) give you a useful basic setup.</p></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp49098744"></a>2.7.3. A Sample <code class="filename">.emacs</code></h3></div></div></div><p>Unfortunately, there is far too much here to explain it in
	detail; however there are one or two points worth
	mentioning.</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Everything beginning with a <code class="literal">;</code> is a
	    comment and is ignored by Emacs.</p></li><li class="listitem"><p>In the first line, the
	    <code class="literal">-*- Emacs-Lisp -*-</code> is so that
	    we can edit <code class="filename">.emacs</code> itself within
	    Emacs and get all the fancy features for editing Emacs
	    Lisp.  Emacs usually tries to guess this based on the
	    filename, and may not get it right for
	    <code class="filename">.emacs</code>.</p></li><li class="listitem"><p>The <span class="keysym">tab</span> key is bound to an
	    indentation function in some modes, so when you press the
	    tab key, it will indent the current line of code.  If you
	    want to put a <span class="token">tab</span> character in whatever you
	    are writing, hold the <span class="keysym">control</span> key down
	    while you are pressing the <span class="keysym">tab</span>
	    key.</p></li><li class="listitem"><p>This file supports syntax highlighting for C, C++,
	    Perl, Lisp and Scheme, by guessing the language from the
	    filename.</p></li><li class="listitem"><p>Emacs already has a pre-defined function called
	    <code class="function">next-error</code>.  In a compilation output
	    window, this allows you to move from one compilation error
	    to the next by doing <code class="command">M-n</code>; we define a
	    complementary function,
	    <code class="function">previous-error</code>, that allows you to go
	    to a previous error by doing <code class="command">M-p</code>.  The
	    nicest feature of all is that <code class="command">C-c C-c</code>
	    will open up the source file in which the error occurred
	    and jump to the appropriate line.</p></li><li class="listitem"><p>We enable Emacs's ability to act as a server, so that
	    if you are doing something outside Emacs and you want to
	    edit a file, you can just type in</p><pre class="screen"><code class="prompt">%</code> <strong class="userinput"><code>emacsclient <em class="replaceable"><code>filename</code></em></code></strong></pre><p>and then you can edit the file in your
	    Emacs!<a href="#ftn.idp49107448" class="footnote" id="idp49107448"><sup class="footnote">[6]</sup></a></p></li></ul></div><div class="example"><a id="idp49109112"></a><div class="example-title">Example 2.1. A Sample <code class="filename">.emacs</code></div><div class="example-contents"><pre class="programlisting">;; -*-Emacs-Lisp-*-

;; This file is designed to be re-evaled; use the variable first-time
;; to avoid any problems with this.
(defvar first-time t
  "Flag signifying this is the first time that .emacs has been evaled")

;; Meta
(global-set-key "\M- " 'set-mark-command)
(global-set-key "\M-\C-h" 'backward-kill-word)
(global-set-key "\M-\C-r" 'query-replace)
(global-set-key "\M-r" 'replace-string)
(global-set-key "\M-g" 'goto-line)
(global-set-key "\M-h" 'help-command)

;; Function keys
(global-set-key [f1] 'manual-entry)
(global-set-key [f2] 'info)
(global-set-key [f3] 'repeat-complex-command)
(global-set-key [f4] 'advertised-undo)
(global-set-key [f5] 'eval-current-buffer)
(global-set-key [f6] 'buffer-menu)
(global-set-key [f7] 'other-window)
(global-set-key [f8] 'find-file)
(global-set-key [f9] 'save-buffer)
(global-set-key [f10] 'next-error)
(global-set-key [f11] 'compile)
(global-set-key [f12] 'grep)
(global-set-key [C-f1] 'compile)
(global-set-key [C-f2] 'grep)
(global-set-key [C-f3] 'next-error)
(global-set-key [C-f4] 'previous-error)
(global-set-key [C-f5] 'display-faces)
(global-set-key [C-f8] 'dired)
(global-set-key [C-f10] 'kill-compilation)

;; Keypad bindings
(global-set-key [up] "\C-p")
(global-set-key [down] "\C-n")
(global-set-key [left] "\C-b")
(global-set-key [right] "\C-f")
(global-set-key [home] "\C-a")
(global-set-key [end] "\C-e")
(global-set-key [prior] "\M-v")
(global-set-key [next] "\C-v")
(global-set-key [C-up] "\M-\C-b")
(global-set-key [C-down] "\M-\C-f")
(global-set-key [C-left] "\M-b")
(global-set-key [C-right] "\M-f")
(global-set-key [C-home] "\M-&lt;")
(global-set-key [C-end] "\M-&gt;")
(global-set-key [C-prior] "\M-&lt;")
(global-set-key [C-next] "\M-&gt;")

;; Mouse
(global-set-key [mouse-3] 'imenu)

;; Misc
(global-set-key [C-tab] "\C-q\t")	; Control tab quotes a tab.
(setq backup-by-copying-when-mismatch t)

;; Treat 'y' or &lt;CR&gt; as yes, 'n' as no.
(fset 'yes-or-no-p 'y-or-n-p)
(define-key query-replace-map [return] 'act)
(define-key query-replace-map [?\C-m] 'act)

;; Load packages
(require 'desktop)
(require 'tar-mode)

;; Pretty diff mode
(autoload 'ediff-buffers "ediff" "Intelligent Emacs interface to diff" t)
(autoload 'ediff-files "ediff" "Intelligent Emacs interface to diff" t)
(autoload 'ediff-files-remote "ediff"
  "Intelligent Emacs interface to diff")

(if first-time
    (setq auto-mode-alist
	  (append '(("\\.cpp$" . c++-mode)
		    ("\\.hpp$" . c++-mode)
		    ("\\.lsp$" . lisp-mode)
		    ("\\.scm$" . scheme-mode)
		    ("\\.pl$" . perl-mode)
		    ) auto-mode-alist)))

;; Auto font lock mode
(defvar font-lock-auto-mode-list
  (list 'c-mode 'c++-mode 'c++-c-mode 'emacs-lisp-mode 'lisp-mode 'perl-mode 'scheme-mode)
  "List of modes to always start in font-lock-mode")

(defvar font-lock-mode-keyword-alist
  '((c++-c-mode . c-font-lock-keywords)
    (perl-mode . perl-font-lock-keywords))
  "Associations between modes and keywords")

(defun font-lock-auto-mode-select ()
  "Automatically select font-lock-mode if the current major mode is in font-lock-auto-mode-list"
  (if (memq major-mode font-lock-auto-mode-list)
      (progn
	(font-lock-mode t))
    )
  )

(global-set-key [M-f1] 'font-lock-fontify-buffer)

;; New dabbrev stuff
;(require 'new-dabbrev)
(setq dabbrev-always-check-other-buffers t)
(setq dabbrev-abbrev-char-regexp "\\sw\\|\\s_")
(add-hook 'emacs-lisp-mode-hook
	  '(lambda ()
	     (set (make-local-variable 'dabbrev-case-fold-search) nil)
	     (set (make-local-variable 'dabbrev-case-replace) nil)))
(add-hook 'c-mode-hook
	  '(lambda ()
	     (set (make-local-variable 'dabbrev-case-fold-search) nil)
	     (set (make-local-variable 'dabbrev-case-replace) nil)))
(add-hook 'text-mode-hook
	  '(lambda ()
	     (set (make-local-variable 'dabbrev-case-fold-search) t)
	     (set (make-local-variable 'dabbrev-case-replace) t)))

;; C++ and C mode...
(defun my-c++-mode-hook ()
  (setq tab-width 4)
  (define-key c++-mode-map "\C-m" 'reindent-then-newline-and-indent)
  (define-key c++-mode-map "\C-ce" 'c-comment-edit)
  (setq c++-auto-hungry-initial-state 'none)
  (setq c++-delete-function 'backward-delete-char)
  (setq c++-tab-always-indent t)
  (setq c-indent-level 4)
  (setq c-continued-statement-offset 4)
  (setq c++-empty-arglist-indent 4))

(defun my-c-mode-hook ()
  (setq tab-width 4)
  (define-key c-mode-map "\C-m" 'reindent-then-newline-and-indent)
  (define-key c-mode-map "\C-ce" 'c-comment-edit)
  (setq c-auto-hungry-initial-state 'none)
  (setq c-delete-function 'backward-delete-char)
  (setq c-tab-always-indent t)
;; BSD-ish indentation style
  (setq c-indent-level 4)
  (setq c-continued-statement-offset 4)
  (setq c-brace-offset -4)
  (setq c-argdecl-indent 0)
  (setq c-label-offset -4))

;; Perl mode
(defun my-perl-mode-hook ()
  (setq tab-width 4)
  (define-key c++-mode-map "\C-m" 'reindent-then-newline-and-indent)
  (setq perl-indent-level 4)
  (setq perl-continued-statement-offset 4))

;; Scheme mode...
(defun my-scheme-mode-hook ()
  (define-key scheme-mode-map "\C-m" 'reindent-then-newline-and-indent))

;; Emacs-Lisp mode...
(defun my-lisp-mode-hook ()
  (define-key lisp-mode-map "\C-m" 'reindent-then-newline-and-indent)
  (define-key lisp-mode-map "\C-i" 'lisp-indent-line)
  (define-key lisp-mode-map "\C-j" 'eval-print-last-sexp))

;; Add all of the hooks...
(add-hook 'c++-mode-hook 'my-c++-mode-hook)
(add-hook 'c-mode-hook 'my-c-mode-hook)
(add-hook 'scheme-mode-hook 'my-scheme-mode-hook)
(add-hook 'emacs-lisp-mode-hook 'my-lisp-mode-hook)
(add-hook 'lisp-mode-hook 'my-lisp-mode-hook)
(add-hook 'perl-mode-hook 'my-perl-mode-hook)

;; Complement to next-error
(defun previous-error (n)
  "Visit previous compilation error message and corresponding source code."
  (interactive "p")
  (next-error (- n)))

;; Misc...
(transient-mark-mode 1)
(setq mark-even-if-inactive t)
(setq visible-bell nil)
(setq next-line-add-newlines nil)
(setq compile-command "make")
(setq suggest-key-bindings nil)
(put 'eval-expression 'disabled nil)
(put 'narrow-to-region 'disabled nil)
(put 'set-goal-column 'disabled nil)
(if (&gt;= emacs-major-version 21)
	(setq show-trailing-whitespace t))

;; Elisp archive searching
(autoload 'format-lisp-code-directory "lispdir" nil t)
(autoload 'lisp-dir-apropos "lispdir" nil t)
(autoload 'lisp-dir-retrieve "lispdir" nil t)
(autoload 'lisp-dir-verify "lispdir" nil t)

;; Font lock mode
(defun my-make-face (face color &amp;optional bold)
  "Create a face from a color and optionally make it bold"
  (make-face face)
  (copy-face 'default face)
  (set-face-foreground face color)
  (if bold (make-face-bold face))
  )

(if (eq window-system 'x)
    (progn
      (my-make-face 'blue "blue")
      (my-make-face 'red "red")
      (my-make-face 'green "dark green")
      (setq font-lock-comment-face 'blue)
      (setq font-lock-string-face 'bold)
      (setq font-lock-type-face 'bold)
      (setq font-lock-keyword-face 'bold)
      (setq font-lock-function-name-face 'red)
      (setq font-lock-doc-string-face 'green)
      (add-hook 'find-file-hooks 'font-lock-auto-mode-select)

      (setq baud-rate 1000000)
      (global-set-key "\C-cmm" 'menu-bar-mode)
      (global-set-key "\C-cms" 'scroll-bar-mode)
      (global-set-key [backspace] 'backward-delete-char)
					;      (global-set-key [delete] 'delete-char)
      (standard-display-european t)
      (load-library "iso-transl")))

;; X11 or PC using direct screen writes
(if window-system
    (progn
      ;;      (global-set-key [M-f1] 'hilit-repaint-command)
      ;;      (global-set-key [M-f2] [?\C-u M-f1])
      (setq hilit-mode-enable-list
	    '(not text-mode c-mode c++-mode emacs-lisp-mode lisp-mode
		  scheme-mode)
	    hilit-auto-highlight nil
	    hilit-auto-rehighlight 'visible
	    hilit-inhibit-hooks nil
	    hilit-inhibit-rebinding t)
      (require 'hilit19)
      (require 'paren))
  (setq baud-rate 2400)			; For slow serial connections
  )

;; TTY type terminal
(if (and (not window-system)
	 (not (equal system-type 'ms-dos)))
    (progn
      (if first-time
	  (progn
	    (keyboard-translate ?\C-h ?\C-?)
	    (keyboard-translate ?\C-? ?\C-h)))))

;; Under UNIX
(if (not (equal system-type 'ms-dos))
    (progn
      (if first-time
	  (server-start))))

;; Add any face changes here
(add-hook 'term-setup-hook 'my-term-setup-hook)
(defun my-term-setup-hook ()
  (if (eq window-system 'pc)
      (progn
;;	(set-face-background 'default "red")
	)))

;; Restore the "desktop" - do this as late as possible
(if first-time
    (progn
      (desktop-load-default)
      (desktop-read)))

;; Indicate that this file has been read at least once
(setq first-time nil)

;; No need to debug anything now

(setq debug-on-error nil)

;; All done
(message "All done, %s%s" (user-login-name) ".")</pre></div></div><br class="example-break" /></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp49110648"></a>2.7.4. Extending the Range of Languages Emacs
	Understands</h3></div></div></div><p>Now, this is all very well if you only want to program in
	the languages already catered for in
	<code class="filename">.emacs</code> (C, C++, Perl, Lisp and Scheme),
	but what happens if a new language called
	<span class="quote">&#8220;<span class="quote">whizbang</span>&#8221;</span> comes out, full of exciting
	features?</p><p>The first thing to do is find out if whizbang comes with
	any files that tell Emacs about the language.  These usually
	end in <code class="filename">.el</code>, short for <span class="quote">&#8220;<span class="quote">Emacs
	  Lisp</span>&#8221;</span>.  For example, if whizbang is a FreeBSD port,
	we can locate these files by doing</p><pre class="screen"><code class="prompt">%</code> <strong class="userinput"><code>find /usr/ports/lang/whizbang -name "*.el" -print</code></strong></pre><p>and install them by copying them into the Emacs site Lisp
	directory.  On FreeBSD, this is
	<code class="filename">/usr/local/share/emacs/site-lisp</code>.</p><p>So for example, if the output from the find command
	was</p><pre class="screen">/usr/ports/lang/whizbang/work/misc/whizbang.el</pre><p>we would do</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>cp /usr/ports/lang/whizbang/work/misc/whizbang.el /usr/local/share/emacs/site-lisp</code></strong></pre><p>Next, we need to decide what extension whizbang source
	files have.  Let us say for the sake of argument that they all
	end in <code class="filename">.wiz</code>.  We need to add an entry to
	our <code class="filename">.emacs</code> to make sure Emacs will be
	able to use the information in
	<code class="filename">whizbang.el</code>.</p><p>Find the <span class="symbol">auto-mode-alist entry</span> in
	<code class="filename">.emacs</code> and add a line for whizbang, such
	as:</p><pre class="programlisting"><em class="lineannotation"><span class="lineannotation">&#8230;</span></em>
("\\.lsp$" . lisp-mode)
("\\.wiz$" . whizbang-mode)
("\\.scm$" . scheme-mode)
<em class="lineannotation"><span class="lineannotation">&#8230;</span></em></pre><p>This means that Emacs will automatically go into
	<code class="function">whizbang-mode</code> when you edit a file ending
	in <code class="filename">.wiz</code>.</p><p>Just below this, you will find the
	<span class="symbol">font-lock-auto-mode-list</span> entry.  Add
	<code class="function">whizbang-mode</code> to it like so:</p><pre class="programlisting">;; Auto font lock mode
(defvar font-lock-auto-mode-list
  (list 'c-mode 'c++-mode 'c++-c-mode 'emacs-lisp-mode 'whizbang-mode 'lisp-mode 'perl-mode 'scheme-mode)
  "List of modes to always start in font-lock-mode")</pre><p>This means that Emacs will always enable
	<code class="function">font-lock-mode</code> (ie syntax highlighting)
	when editing a <code class="filename">.wiz</code> file.</p><p>And that is all that is needed.  If there is anything else
	you want done automatically when you open up
	<code class="filename">.wiz</code>, you can add a
	<code class="function">whizbang-mode hook</code> (see
	<code class="function">my-scheme-mode-hook</code> for a simple example
	that adds <code class="function">auto-indent</code>).</p></div></div><div class="sect1"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="tools-reading"></a>2.8. Further Reading</h2></div></div></div><p>For information about setting up a development environment
      for contributing fixes to FreeBSD itself, please see
      <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=development&amp;sektion=7&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">development</span>(7)</span></a>.</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Brian Harvey and Matthew Wright
	  <span class="emphasis"><em>Simply Scheme</em></span>
	  MIT 1994.
	  ISBN 0-262-08226-8</p></li><li class="listitem"><p>Randall Schwartz
	  <span class="emphasis"><em>Learning Perl</em></span>
	  O'Reilly 1993
	  ISBN 1-56592-042-2</p></li><li class="listitem"><p>Patrick Henry Winston and Berthold Klaus Paul Horn
	  <span class="emphasis"><em>Lisp (3rd Edition)</em></span>
	  Addison-Wesley 1989
	  ISBN 0-201-08319-1</p></li><li class="listitem"><p>Brian W. Kernighan and Rob Pike
	  <span class="emphasis"><em>The Unix Programming Environment</em></span>
	  Prentice-Hall 1984
	  ISBN 0-13-937681-X</p></li><li class="listitem"><p>Brian W. Kernighan and Dennis M. Ritchie <span class="emphasis"><em>The C
	    Programming Language (2nd Edition)</em></span>
	  Prentice-Hall 1988
	  ISBN 0-13-110362-8</p></li><li class="listitem"><p>Bjarne Stroustrup
	<span class="emphasis"><em>The C++ Programming Language</em></span>
	Addison-Wesley 1991
	ISBN 0-201-53992-6</p></li><li class="listitem"><p>W. Richard Stevens <span class="emphasis"><em>Advanced Programming in the
	    Unix Environment</em></span>
	  Addison-Wesley 1992
	  ISBN 0-201-56317-7</p></li><li class="listitem"><p>W. Richard Stevens
	  <span class="emphasis"><em>Unix Network Programming</em></span>
	  Prentice-Hall 1990
	  ISBN 0-13-949876-1</p></li></ul></div></div><div class="footnotes"><br /><hr class="footnote-hr" /><div id="ftn.idp45404920" class="footnote"><p><a href="#idp45404920" class="para"><sup class="para">[1] </sup></a>If you run it in the shell, you may
	    get a core dump.</p></div><div id="ftn.idp45463288" class="footnote"><p><a href="#idp45463288" class="para"><sup class="para">[2] </sup></a>In case you did not know, a binary sort is
	  an efficient way of sorting things into order and a bubble
	  sort is not.</p></div><div id="ftn.idp45485304" class="footnote"><p><a href="#idp45485304" class="para"><sup class="para">[3] </sup></a>The
		reasons for this are buried in the mists of
		history.</p></div><div id="ftn.idp45515128" class="footnote"><p><a href="#idp45515128" class="para"><sup class="para">[4] </sup></a>Note, we did not use the <code class="option">-o</code> flag
		to specify the executable name, so we will get an
		executable called <code class="filename">a.out</code>.
		Producing a debug version called
		<code class="filename">foobar</code> is left as an exercise for
		the reader!</p></div><div id="ftn.idp45926008" class="footnote"><p><a href="#idp45926008" class="para"><sup class="para">[5] </sup></a>They do not use the
	    <code class="filename">MAKEFILE</code> form as block capitals are
	    often used for documentation files like
	    <code class="filename">README</code>.</p></div><div id="ftn.idp49107448" class="footnote"><p><a href="#idp49107448" class="para"><sup class="para">[6] </sup></a>Many Emacs users set their
		<code class="envar">EDITOR</code> environment to
		<code class="literal">emacsclient</code> so this happens every
		time they need to edit a
		file.</p></div></div></div><div class="chapter"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="secure"></a>Chapter 3. Secure Programming</h2></div><div><span class="authorgroup">Contributed by <span xmlns="http://www.w3.org/1999/xhtml" class="author"><span class="firstname">Murray</span> <span class="surname">Stokely</span></span>. </span></div></div></div><div class="toc"><div class="toc-title">Table of Contents</div><dl class="toc"><dt><span class="sect1"><a href="#secure-synopsis">3.1. Synopsis</a></span></dt><dt><span class="sect1"><a href="#secure-philosophy">3.2. Secure Design
      Methodology</a></span></dt><dt><span class="sect1"><a href="#secure-bufferov">3.3. Buffer Overflows</a></span></dt><dt><span class="sect1"><a href="#secure-setuid">3.4. SetUID issues</a></span></dt><dt><span class="sect1"><a href="#secure-chroot">3.5. Limiting your program's environment</a></span></dt><dt><span class="sect1"><a href="#secure-trust">3.6. Trust</a></span></dt><dt><span class="sect1"><a href="#secure-race-conditions">3.7. Race Conditions</a></span></dt></dl></div><div class="sect1"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="secure-synopsis"></a>3.1. Synopsis</h2></div></div></div><p>This chapter describes some of the security issues that
      have plagued <span class="trademark">UNIX</span>® programmers for decades and some of the new
      tools available to help programmers avoid writing exploitable
      code.</p></div><div class="sect1"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="secure-philosophy"></a>3.2. Secure Design
      Methodology</h2></div></div></div><p>Writing secure applications takes a very scrutinous and
      pessimistic outlook on life.  Applications should be run with
      the principle of <span class="quote">&#8220;<span class="quote">least privilege</span>&#8221;</span> so that no
      process is ever running with more than the bare minimum access
      that it needs to accomplish its function.  Previously tested
      code should be reused whenever possible to avoid common
      mistakes that others may have already fixed.</p><p>One of the pitfalls of the <span class="trademark">UNIX</span>® environment is how easy it
      is to make assumptions about the sanity of the environment.
      Applications should never trust user input (in all its forms),
      system resources, inter-process communication, or the timing of
      events.  <span class="trademark">UNIX</span>® processes do not execute synchronously so logical
      operations are rarely atomic.</p></div><div class="sect1"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="secure-bufferov"></a>3.3. Buffer Overflows</h2></div></div></div><p>Buffer Overflows have been around since the very
      beginnings of the von Neumann <a class="xref" href="#COD">1</a> architecture.

      <a id="idp49309816" class="indexterm"></a>
      <a id="idp49310328" class="indexterm"></a>

      They first gained widespread notoriety in 1988 with the Morris
      Internet worm.  Unfortunately, the same basic attack remains

      <a id="idp49310840" class="indexterm"></a>

      effective today.
      By far the most common type of buffer overflow attack is based
      on corrupting the stack.</p><a id="idp49311608" class="indexterm"></a><a id="idp49312120" class="indexterm"></a><p>Most modern computer systems use a stack to pass arguments
      to procedures and to store local variables.  A stack is a last
      in first out (LIFO) buffer in the high memory area of a process
      image.  When a program invokes a function a new "stack frame" is

      <a id="idp49312888" class="indexterm"></a>
      <a id="idp49313400" class="indexterm"></a>

      created.  This stack frame consists of the arguments passed to
      the function as well as a dynamic amount of local variable
      space.  The "stack pointer" is a register that holds the current

      <a id="idp49314552" class="indexterm"></a>
      <a id="idp49315064" class="indexterm"></a>

      location of the top of the stack.  Since this value is
      constantly changing as new values are pushed onto the top of the
      stack, many implementations also provide a "frame pointer" that
      is located near the beginning of a stack frame so that local
      variables can more easily be addressed relative to this
      value. <a class="xref" href="#COD">1</a> The return address for function

      <a id="idp49315960" class="indexterm"></a>
      <a id="idp49316472" class="indexterm"></a>
      <a id="idp49317624" class="indexterm"></a>
      <a id="idp49318136" class="indexterm"></a>

      calls is also stored on the stack, and this is the cause of
      stack-overflow exploits since overflowing a local variable in a
      function can overwrite the return address of that function,
      potentially allowing a malicious user to execute any code he or
      she wants.</p><p>Although stack-based attacks are by far the most common,
      it would also be possible to overrun the stack with a heap-based
      (malloc/free) attack.</p><p>The C programming language does not perform automatic
      bounds checking on arrays or pointers as many other languages
      do.  In addition, the standard C library is filled with a
      handful of very dangerous functions.</p><div class="informaltable"><table class="informaltable" width="100%" border="0"><colgroup><col /><col /></colgroup><tbody><tr><td><code class="function">strcpy</code>(char *dest, const char
          *src)</td><td><p>May overflow the dest buffer</p></td></tr><tr><td><code class="function">strcat</code>(char *dest, const char
          *src)</td><td><p>May overflow the dest buffer</p></td></tr><tr><td><code class="function">getwd</code>(char *buf)</td><td><p>May overflow the buf buffer</p></td></tr><tr><td><code class="function">gets</code>(char *s)</td><td><p>May overflow the s buffer</p></td></tr><tr><td><code class="function">[vf]scanf</code>(const char *format,
          ...)</td><td><p>May overflow its arguments.</p></td></tr><tr><td><code class="function">realpath</code>(char *path, char
          resolved_path[])</td><td><p>May overflow the path buffer</p></td></tr><tr><td><code class="function">[v]sprintf</code>(char *str, const char
          *format, ...)</td><td><p>May overflow the str buffer.</p></td></tr></tbody></table></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp49347320"></a>3.3.1. Example Buffer Overflow</h3></div></div></div><p>The following example code contains a buffer overflow
      designed to overwrite the return address and skip the
      instruction immediately following the function call.  (Inspired
      by <a class="xref" href="#Phrack">4</a>)</p><pre class="programlisting">#include &lt;stdio.h&gt;

void manipulate(char *buffer) {
  char newbuffer[80];
  strcpy(newbuffer,buffer);
}

int main() {
  char ch,buffer[4096];
  int i=0;

  while ((buffer[i++] = getchar()) != '\n') {};

  i=1;
  manipulate(buffer);
  i=2;
  printf("The value of i is : %d\n",i);
  return 0;
}</pre><p>Let us examine what the memory image of this process would
      look like if we were to input 160 spaces into our little program
      before hitting return.</p><p>[XXX figure here!]</p><p>Obviously more malicious input can be devised to execute
      actual compiled instructions (such as exec(/bin/sh)).</p></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp49350392"></a>3.3.2. Avoiding Buffer Overflows</h3></div></div></div><p>The most straightforward solution to the problem of
      stack-overflows is to always use length restricted memory and
      string copy functions.  <code class="function">strncpy</code> and
      <code class="function">strncat</code> are part of the standard C library.

      <a id="idp49356024" class="indexterm"></a>
      <a id="idp49357176" class="indexterm"></a>

      These functions accept a length value as a parameter which
      should be no larger than the size of the destination buffer.
      These functions will then copy up to `length' bytes from the
      source to the destination.  However there are a number of
      problems with these functions.  Neither function guarantees NUL
      termination if the size of the input buffer is as large as the

      <a id="idp49358328" class="indexterm"></a>

      destination.  The length parameter is also used inconsistently
      between strncpy and strncat so it is easy for programmers to get
      confused as to their proper usage.  There is also a significant
      performance loss compared to <code class="function">strcpy</code> when
      copying a short string into a large buffer since
      <code class="function">strncpy</code> NUL fills up the size
      specified.</p><p>Another memory copy implementation exists
      to get around these problems.  The
      <code class="function">strlcpy</code> and <code class="function">strlcat</code>
      functions guarantee that they will always null terminate the
      destination string when given a non-zero length argument.</p><a id="idp49360888" class="indexterm"></a><a id="idp49362040" class="indexterm"></a><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp49363192"></a>3.3.2.1. Compiler based run-time bounds checking</h4></div></div></div><a id="idp49363704" class="indexterm"></a><p>Unfortunately there is still a very large assortment of
        code in public use which blindly copies memory around without
        using any of the bounded copy routines we just discussed.
        Fortunately, there is a way to help prevent such attacks &#8212;
        run-time bounds checking, which is implemented by several
        C/C++ compilers.</p><a id="idp49364984" class="indexterm"></a><a id="idp49365496" class="indexterm"></a><a id="idp49366008" class="indexterm"></a><p>ProPolice is one such compiler feature, and is integrated
	  into <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=gcc&amp;sektion=1&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">gcc</span>(1)</span></a> versions 4.1 and later.  It replaces and
	  extends the earlier StackGuard <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=gcc&amp;sektion=1&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">gcc</span>(1)</span></a> extension.</p><p>ProPolice helps to protect against stack-based buffer
	  overflows and other attacks by laying pseudo-random numbers in
	  key areas of the stack before calling any function.  When a
	  function returns, these <span class="quote">&#8220;<span class="quote">canaries</span>&#8221;</span> are checked
	  and if they are found to have been changed the executable is
	  immediately aborted.  Thus any attempt to modify the return
	  address or other variable stored on the stack in an attempt to
	  get malicious code to run is unlikely to succeed, as the
	  attacker would have to also manage to leave the pseudo-random
	  canaries untouched.</p><a id="idp49369208" class="indexterm"></a><p>Recompiling your application with ProPolice is an
        effective means of stopping most buffer-overflow attacks, but
        it can still be compromised.</p></div><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp49370232"></a>3.3.2.2. Library based run-time bounds checking</h4></div></div></div><a id="idp49370744" class="indexterm"></a><p>Compiler-based mechanisms are completely useless for
        binary-only software for which you cannot recompile.  For
        these situations there are a number of libraries which
        re-implement the unsafe functions of the C-library
        (<code class="function">strcpy</code>, <code class="function">fscanf</code>,
        <code class="function">getwd</code>, etc..) and ensure that these
        functions can never write past the stack pointer.</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">libsafe</li><li class="listitem">libverify</li><li class="listitem">libparanoia</li></ul></div><p>Unfortunately these library-based defenses have a number
        of shortcomings.  These libraries only protect against a very
        small set of security related issues and they neglect to fix
        the actual problem.  These defenses may fail if the
        application was compiled with -fomit-frame-pointer.  Also, the
        LD_PRELOAD and LD_LIBRARY_PATH environment variables can be
        overwritten/unset by the user.</p></div></div></div><div class="sect1"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="secure-setuid"></a>3.4. SetUID issues</h2></div></div></div><a id="idp49376760" class="indexterm"></a><p>There are at least 6 different IDs associated with any
      given process.  Because of this you have to be very careful with
      the access that your process has at any given time.  In
      particular, all seteuid applications should give up their
      privileges as soon as it is no longer required.</p><a id="idp49377656" class="indexterm"></a><a id="idp49378808" class="indexterm"></a><p>The real user ID can only be changed by a superuser
      process.  The <span class="application">login</span> program sets this
      when a user initially logs in and it is seldom changed.</p><p>The effective user ID is set by the
      <code class="function">exec()</code> functions if a program has its
      seteuid bit set.  An application can call
      <code class="function">seteuid()</code> at any time to set the effective
      user ID to either the real user ID or the saved set-user-ID.
      When the effective user ID is set by <code class="function">exec()</code>
      functions, the previous value is saved in the saved set-user-ID.</p></div><div class="sect1"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="secure-chroot"></a>3.5. Limiting your program's environment</h2></div></div></div><a id="idp49383032" class="indexterm"></a><p>The traditional method of restricting a process
      is with the <code class="function">chroot()</code> system call.  This
      system call changes the root directory from which all other
      paths are referenced for a process and any child processes.  For
      this call to succeed the process must have execute (search)
      permission on the directory being referenced.  The new
      environment does not actually take effect until you
      <code class="function">chdir()</code> into your new environment.  It
      should also be noted that a process can easily break out of a
      chroot environment if it has root privilege.  This could be
      accomplished by creating device nodes to read kernel memory,
      attaching a debugger to a process outside of the <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=chroot&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">chroot</span>(8)</span></a>
      environment, or in
      many other creative ways.</p><p>The behavior of the <code class="function">chroot()</code> system
      call can be controlled somewhat with the
      kern.chroot_allow_open_directories <code class="command">sysctl</code>
      variable.  When this value is set to 0,
      <code class="function">chroot()</code> will fail with EPERM if there are
      any directories open.  If set to the default value of 1, then
      <code class="function">chroot()</code> will fail with EPERM if there are
      any directories open and the process is already subject to a
      <code class="function">chroot()</code> call.  For any other value, the
      check for open directories will be bypassed completely.</p><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp49400056"></a>3.5.1. FreeBSD's jail functionality</h3></div></div></div><a id="idp49400568" class="indexterm"></a><p>The concept of a Jail extends upon the
      <code class="function">chroot()</code> by limiting the powers of the
      superuser to create a true `virtual server'.  Once a prison is
      set up all network communication must take place through the
      specified IP address, and the power of "root privilege" in this
      jail is severely constrained.</p><p>While in a prison, any tests of superuser power within the
      kernel using the <code class="function">suser()</code> call will fail.
      However, some calls to <code class="function">suser()</code> have been
      changed to a new interface <code class="function">suser_xxx()</code>.
      This function is responsible for recognizing or denying access
      to superuser power for imprisoned processes.</p><p>A superuser process within a jailed environment has the
      power to:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">Manipulate credential with
        <code class="function">setuid</code>, <code class="function">seteuid</code>,
        <code class="function">setgid</code>, <code class="function">setegid</code>,
        <code class="function">setgroups</code>, <code class="function">setreuid</code>,
        <code class="function">setregid</code>, <code class="function">setlogin</code></li><li class="listitem">Set resource limits with <code class="function">setrlimit</code></li><li class="listitem">Modify some sysctl nodes
        (kern.hostname)</li><li class="listitem"><code class="function">chroot()</code></li><li class="listitem">Set flags on a vnode:
        <code class="function">chflags</code>,
        <code class="function">fchflags</code></li><li class="listitem">Set attributes of a vnode such as file
        permission, owner, group, size, access time, and modification
        time.</li><li class="listitem">Bind to privileged ports in the Internet
        domain (ports &lt; 1024)</li></ul></div><p><code class="function">Jail</code> is a very useful tool for
      running applications in a secure environment but it does have
      some shortcomings.  Currently, the IPC mechanisms have not been
      converted to the <code class="function">suser_xxx</code> so applications
      such as MySQL cannot be run within a jail.  Superuser access
      may have a very limited meaning within a jail, but there is
      no way to specify exactly what "very limited" means.</p></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp49441784"></a>3.5.2. <span class="trademark">POSIX</span>®.1e Process Capabilities</h3></div></div></div><a id="idp49442680" class="indexterm"></a><a id="idp49443192" class="indexterm"></a><p><span class="trademark">POSIX</span>® has released a working draft that adds event
      auditing, access control lists, fine grained privileges,
      information labeling, and mandatory access control.</p><p>This is a work in progress and is the focus of the <a class="link" href="http://www.trustedbsd.org/" target="_top">TrustedBSD</a> project.  Some
      of the initial work has been committed to FreeBSD-CURRENT
      (cap_set_proc(3)).</p></div></div><div class="sect1"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="secure-trust"></a>3.6. Trust</h2></div></div></div><p>An application should never assume that anything about the
      users environment is sane.  This includes (but is certainly not
      limited to): user input, signals, environment variables,
      resources, IPC, mmaps, the filesystem working directory, file
      descriptors, the # of open files, etc.</p><a id="idp49450744" class="indexterm"></a><a id="idp49451256" class="indexterm"></a><p>You should never assume that you can catch all forms of
      invalid input that a user might supply.  Instead, your
      application should use positive filtering to only allow a
      specific subset of inputs that you deem safe.  Improper data
      validation has been the cause of many exploits, especially with
      CGI scripts on the world wide web.  For filenames you need to be
      extra careful about paths ("../", "/"), symbolic links, and
      shell escape characters.</p><a id="idp49452152" class="indexterm"></a><p>Perl has a really cool feature called "Taint" mode which
      can be used to prevent scripts from using data derived outside
      the program in an unsafe way.  This mode will check command line
      arguments, environment variables, locale information, the
      results of certain syscalls (<code class="function">readdir()</code>,
      <code class="function">readlink()</code>,
      <code class="function">getpwxxx()</code>), and all file input.</p></div><div class="sect1"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="secure-race-conditions"></a>3.7. Race Conditions</h2></div></div></div><p>A race condition is anomalous behavior caused by the
      unexpected dependence on the relative timing of events.  In
      other words, a programmer incorrectly assumed that a particular
      event would always happen before another.</p><a id="idp49455480" class="indexterm"></a><a id="idp49456376" class="indexterm"></a><a id="idp49457272" class="indexterm"></a><p>Some of the common causes of race conditions are signals,
      access checks, and file opens.  Signals are asynchronous events
      by nature so special care must be taken in dealing with them.
      Checking access with <code class="function">access(2)</code> then
      <code class="function">open(2)</code> is clearly non-atomic.  Users can
      move files in between the two calls.  Instead, privileged
      applications should <code class="function">seteuid()</code> and then call
      <code class="function">open()</code> directly.  Along the same lines, an
      application should always set a proper umask before
      <code class="function">open()</code> to obviate the need for spurious
      <code class="function">chmod()</code> calls.</p></div></div><div class="chapter"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="l10n"></a>Chapter 4. Localization and Internationalization - L10N and I18N</h2></div></div></div><div class="toc"><div class="toc-title">Table of Contents</div><dl class="toc"><dt><span class="sect1"><a href="#l10n-programming">4.1. Programming I18N Compliant Applications</a></span></dt><dt><span class="sect1"><a href="#posix-nls">4.2. Localized Messages with POSIX.1 Native Language Support (NLS)</a></span></dt></dl></div><div class="sect1"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="l10n-programming"></a>4.1. Programming I18N Compliant Applications</h2></div></div></div><a id="idp49483640" class="indexterm"></a><a id="idp49484152" class="indexterm"></a><p>To make your application more useful for speakers of other
	languages, we hope that you will program I18N compliant.  The GNU
	gcc compiler and GUI libraries like QT and GTK support I18N through
	special handling of strings.  Making a program I18N compliant is
	very easy.  It allows contributors to port your application to
	other languages quickly.  Refer to the library specific I18N
	documentation for more details.</p><p>In contrast with common perception, I18N compliant code is
	easy to write.  Usually, it only involves wrapping your strings
	with library specific functions.  In addition, please be sure to
	allow for wide or multibyte character support.</p><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp49485432"></a>4.1.1. A Call to Unify the I18N Effort</h3></div></div></div><p>It has come to our attention that the individual I18N/L10N
	  efforts for each country has been repeating each others'
	  efforts.  Many of us have been reinventing the wheel repeatedly
	  and inefficiently.  We hope that the various major groups in
	  I18N could congregate into a group effort similar to the Core
	  Team's responsibility.</p><p>Currently, we hope that, when you write or port I18N
	  programs, you would send it out to each country's related
	  FreeBSD mailing list for testing.  In the future, we hope to
	  create applications that work in all the languages
	  out-of-the-box without dirty hacks.</p><p>The <a class="link" href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-i18n" target="_top">FreeBSD internationalization mailing list</a> has been established.  If you are an I18N/L10N
	  developer, please send your comments, ideas, questions, and
	  anything you deem related to it.</p></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp49487864"></a>4.1.2. Perl and Python</h3></div></div></div><a id="idp49488504" class="indexterm"></a><a id="idp49489272" class="indexterm"></a><p>Perl and Python have I18N and wide character handling
	  libraries.  Please use them for I18N compliance.</p></div></div><div class="sect1"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="posix-nls"></a>4.2. Localized Messages with POSIX.1 Native Language Support (NLS)</h2></div><div><span class="authorgroup">Contributed by <span xmlns="http://www.w3.org/1999/xhtml" class="author"><span class="firstname">Gábor</span> <span class="surname">Kövesdán</span></span>. </span></div></div></div><p>Beyond the basic I18N functions, like supporting various input
	encodings or supporting national conventions, such as the different
	decimal	separators, at a higher level of I18N, it is possible to localize the
	messages written to the output by the various programs.  A common way of doing
	this is using the POSIX.1 NLS functions, which are provided as a part
	of the FreeBSD base system.</p><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="nls-catalogs"></a>4.2.1. Organizing Localized Messages into Catalog Files</h3></div></div></div><p>POSIX.1 NLS is based on catalog files, which contain the
	  localized messages in the desired encoding.  The messages are
	  organized into sets and each message is identified by an integer
	  number in the containing set.  The catalog files are conventionally
	  named after the locale they contain localized messages for, followed
	  by the <code class="literal">.msg</code> extension.  For instance, the
	  Hungarian messages for ISO8859-2 encoding should be stored in a file
	  called <code class="filename">hu_HU.ISO8859-2</code>.</p><p>These catalog files are common text files that contain the
	  numbered messages.  It is possible to write comments by starting
	  the line with a <code class="literal">$</code> sign.  Set boundaries are also separated by
	  special comments, where the keyword <code class="literal">set</code> must
	  directly follow the <code class="literal">$</code> sign.  The <code class="literal">set</code> keyword
	  is then followed by the set number.  For example:</p><pre class="programlisting">$set 1</pre><p>The actual message entries start with the message number and
	  followed by the localized message.  The well-known
	  modifiers from <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=printf&amp;sektion=3&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">printf</span>(3)</span></a> are accepted:</p><pre class="programlisting">15 "File not found: %s\n"</pre><p>The language catalog files have to be compiled into a binary
	  form before they can be opened from the program.  This conversion
	  is done with the <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=gencat&amp;sektion=1&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">gencat</span>(1)</span></a> utility.  Its first argument is the
	  filename of the compiled catalog and its further arguments are the
	  input catalogs.  The localized messages can also be organized into
	  more catalog files and then all of them can be processed with
	  <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=gencat&amp;sektion=1&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">gencat</span>(1)</span></a>.</p></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="nls-using"></a>4.2.2. Using the Catalog Files from the Source Code</h3></div></div></div><p>Using the catalog files is simple.  To use
	  the related functions, <code class="filename">nl_types.h</code> must be included.  Before
	  using a catalog, it has to be opened with <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=catopen&amp;sektion=3&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">catopen</span>(3)</span></a>.
	  The function takes two arguments.  The first parameter is the name of the
	  installed and compiled catalog.  Usually, the name of the
	  program is used, such as <span class="application">grep</span>.
	  This name will be used when looking for the compiled
	  catalog file.  The <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=catopen&amp;sektion=3&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">catopen</span>(3)</span></a> call looks for this file
	  in <code class="filename">/usr/share/nls/<em class="replaceable"><code>locale</code></em>/<em class="replaceable"><code>catname</code></em></code>
	  and in <code class="filename">/usr/local/share/nls/<em class="replaceable"><code>locale</code></em>/<em class="replaceable"><code>catname</code></em></code>,
	  where <code class="literal">locale</code> is the locale set and
	  <code class="literal">catname</code> is the catalog name being
	  discussed.  The second parameter is a constant, which can have
	  two values:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p><code class="literal">NL_CAT_LOCALE</code>, which means that
	      the used catalog file will be based on
	      <code class="envar">LC_MESSAGES</code>.</p></li><li class="listitem"><p><code class="literal">0</code>, which means that
	      <code class="envar">LANG</code> has to be used to open
	      the proper catalog.</p></li></ul></div><p>The <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=catopen&amp;sektion=3&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">catopen</span>(3)</span></a> call returns a catalog identifier of
	  type <code class="literal">nl_catd</code>.  Please refer to the manual page for a list of possible returned error
	  codes.</p><p>After opening a catalog <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=catgets&amp;sektion=3&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">catgets</span>(3)</span></a> can be used to retrieve
	  a message.  The first parameter is the catalog identifier returned
	  by <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=catopen&amp;sektion=3&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">catopen</span>(3)</span></a>, the second one is the number of the set, the
	  third one is the number of the messages, and the fourth one is a
	  fallback message, which will be returned if the requested message
	  cannot be retrieved from the catalog file.</p><p>After using the catalog file, it must be closed by calling
	  <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=catclose&amp;sektion=3&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">catclose</span>(3)</span></a>, which has one argument, the catalog id.</p></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="nls-example"></a>4.2.3. A Practical Example</h3></div></div></div><p>The following example will demonstrate an easy solution on how to
	  use NLS catalogs in a flexible way.</p><p>The below lines need to be put into a common header file of
	  the program, which is included into all source files where
	  localized messages are necessary:</p><pre class="programlisting">
#ifdef WITHOUT_NLS
#define getstr(n)	 nlsstr[n]
#else
#include &lt;nl_types.h&gt;

extern nl_catd		 catalog;
#define getstr(n)	 catgets(catalog, 1, n, nlsstr[n])
#endif

extern char		*nlsstr[];</pre><p>Next, put these lines into the global declaration part of the
	  main source file:</p><pre class="programlisting">
#ifndef WITHOUT_NLS
#include &lt;nl_types.h&gt;
nl_catd	 catalog;
#endif

/*
 * Default messages to use when NLS is disabled or no catalog
 * is found.
 */
char    *nlsstr[] = {
        "",
/* 1*/  "some random message",
/* 2*/  "some other message"
};</pre><p>Next come the real code snippets, which open, read, and
	  close the catalog:</p><pre class="programlisting">
#ifndef WITHOUT_NLS
	catalog = catopen("myapp", NL_CAT_LOCALE);
#endif

...

printf(getstr(1));

...

#ifndef WITHOUT_NLS
	catclose(catalog);
#endif</pre><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp49523320"></a>4.2.3.1. Reducing Strings to Localize</h4></div></div></div><p>There is a good way of reducing the strings that
	    need to be localized by using <span class="application">libc</span>
	    error messages.  This is also useful to just avoid duplication
	    and provide consistent error messages for the common errors
	    that can be encountered by a great many of programs.</p><p>First, here is an example that does not use
	    <span class="application">libc</span> error messages:</p><pre class="programlisting">
#include &lt;err.h&gt;
...
if (!S_ISDIR(st.st_mode))
	errx(1, "argument is not a directory");
	  </pre><p>This can be transformed to print an error message by
	    reading <code class="varname">errno</code> and printing an error message
	    accordingly:</p><pre class="programlisting">
#include &lt;err.h&gt;
#include &lt;errno.h&gt;
...
if (!S_ISDIR(st.st_mode)) {
	errno = ENOTDIR;
	err(1, NULL);
}
	  </pre><p>In this example, the custom string is eliminated, thus
	    translators will have less work when localizing the program
	    and users will see the usual <span class="quote">&#8220;<span class="quote">Not a directory</span>&#8221;</span>
	    error message when they encounter this error.  This message
	    will probably seem more familiar to them.  Please note that
	    it was necessary to include <code class="filename">errno.h</code> in order to directly
	    access <code class="varname">errno</code>.</p><p>It is worth to note that there are cases when
	    <code class="varname">errno</code> is set automatically by a preceding
	    call, so it is not necessary to set it explicitly:</p><pre class="programlisting">
#include &lt;err.h&gt;
...
if ((p = malloc(size)) == NULL)
	err(1, NULL);
	  </pre></div></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="nls-mk"></a>4.2.4. Making use of <code class="filename">bsd.nls.mk</code></h3></div></div></div><p>Using the catalog files requires few repeatable steps,
	  such as compiling the catalogs and installing them to the
	  proper location.  In order to simplify this process even
	  more, <code class="filename">bsd.nls.mk</code> introduces some macros.
	  It is not necessary to include <code class="filename">bsd.nls.mk</code>
	  explicitly, it is pulled in from the common Makefiles,
	  such as <code class="filename">bsd.prog.mk</code> or
	  <code class="filename">bsd.lib.mk</code>.</p><p>Usually it is enough to define <code class="varname">NLSNAME</code>,
	  which should have the catalog name mentioned as the first
	  argument of <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=catopen&amp;sektion=3&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">catopen</span>(3)</span></a> and list the catalog files in
	  <code class="varname">NLS</code> without their <code class="literal">.msg</code>
	  extension.  Here is an example, which makes it possible to
	  to disable NLS when used with the code examples before.
	  The <code class="varname">WITHOUT_NLS</code> <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=make&amp;sektion=1&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">make</span>(1)</span></a> variable has
	  to be defined in order to build the program without NLS
	  support.</p><pre class="programlisting">
.if !defined(WITHOUT_NLS)
NLS=	es_ES.ISO8859-1
NLS+=	hu_HU.ISO8859-2
NLS+=	pt_BR.ISO8859-1
.else
CFLAGS+=	-DWITHOUT_NLS
.endif</pre><p>Conventionally, the catalog files are placed under the
	  <code class="filename">nls</code> subdirectory and
	  this is the default behavior of <code class="filename">bsd.nls.mk</code>.
	  It is possible, though to override the location of the
	  catalogs with the <code class="varname">NLSSRCDIR</code> <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=make&amp;sektion=1&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">make</span>(1)</span></a>
	  variable.  The default name of the precompiled catalog files
	  also follow the naming convention mentioned before.  It can be
	  overridden by setting the <code class="varname">NLSNAME</code> variable.
	  There are other options to fine tune the processing of the catalog
	  files but usually it is not needed, thus they are not described
	  here.  For further information on <code class="filename">bsd.nls.mk</code>,
	  please refer to the file itself, it is short and easy to
	  understand.</p></div></div></div><div class="chapter"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="policies"></a>Chapter 5. Source Tree Guidelines and Policies</h2></div><div><span class="authorgroup">Contributed by <span xmlns="http://www.w3.org/1999/xhtml" class="author"><span class="firstname">Poul-Henning</span> <span class="surname">Kamp</span></span> and <span xmlns="http://www.w3.org/1999/xhtml" class="author"><span class="firstname">Giorgos</span> <span class="surname">Keramidas</span></span>. </span></div></div></div><div class="toc"><div class="toc-title">Table of Contents</div><dl class="toc"><dt><span class="sect1"><a href="#policies-style">5.1. Style Guidelines</a></span></dt><dt><span class="sect1"><a href="#policies-maintainer">5.2. <code class="varname">MAINTAINER</code> on Makefiles</a></span></dt><dt><span class="sect1"><a href="#policies-contributed">5.3. Contributed Software</a></span></dt><dt><span class="sect1"><a href="#policies-encumbered">5.4. Encumbered Files</a></span></dt><dt><span class="sect1"><a href="#policies-shlib">5.5. Shared Libraries</a></span></dt></dl></div><p>This chapter documents various guidelines and policies in
    force for the FreeBSD source tree.</p><div class="sect1"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="policies-style"></a>5.1. Style Guidelines</h2></div></div></div><a id="idp49567352" class="indexterm"></a><p>Consistent coding style is extremely important, particularly
      with large projects like FreeBSD.  Code should follow the FreeBSD
      coding styles described in <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=style&amp;sektion=9&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">style</span>(9)</span></a> and
      <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=style.Makefile&amp;sektion=5&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">style.Makefile</span>(5)</span></a>.</p></div><div class="sect1"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="policies-maintainer"></a>5.2. <code class="varname">MAINTAINER</code> on Makefiles</h2></div></div></div><a id="idp49575032" class="indexterm"></a><p>If a particular portion of the FreeBSD
      <code class="filename">src/</code> distribution is being maintained by a
      person or group of persons, this is communicated through an
      entry in <code class="filename">src/MAINTAINERS</code>.  Maintainers of
      ports within the Ports Collection express their maintainership
      to the world by adding a <code class="varname">MAINTAINER</code> line to
      the <code class="filename">Makefile</code> of the port in
      question:</p><pre class="programlisting"><code class="varname">MAINTAINER</code>= <em class="replaceable"><code>email-addresses</code></em></pre><div xmlns="" class="tip"><h3 class="admontitle">Tip: </h3><p xmlns="http://www.w3.org/1999/xhtml">For other parts of the repository, or for sections not
	listed as having a maintainer, or when you are unsure who the
	active maintainer is, try looking at the recent commit history
	of the relevant parts of the source tree.  It is quite often
	the case that a maintainer is not explicitly named, but the
	people who are actively working in a part of the source tree
	for, say, the last couple of years are interested in reviewing
	changes.  Even if this is not specifically mentioned in the
	documentation or the source itself, asking for a review as a
	form of courtesy is a very reasonable thing to do.</p></div><p>The role of the maintainer is as follows:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>The maintainer owns and is responsible for that code.
	  This means that he or she is responsible for fixing bugs and
	  answering problem reports pertaining to that piece of the
	  code, and in the case of contributed software, for tracking
	  new versions, as appropriate.</p></li><li class="listitem"><p>Changes to directories which have a maintainer defined
	  shall be sent to the maintainer for review before being
	  committed.  Only if the maintainer does not respond for an
	  unacceptable period of time, to several emails, will it be
	  acceptable to commit changes without review by the
	  maintainer.  However, it is suggested that you try to have
	  the changes reviewed by someone else if at all
	  possible.</p></li><li class="listitem"><p>It is of course not acceptable to add a person or group
	  as maintainer unless they agree to assume this duty.  On the
	  other hand it does not have to be a committer and it can
	  easily be a group of people.</p></li></ul></div></div><div class="sect1"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="policies-contributed"></a>5.3. Contributed Software</h2></div><div><span class="authorgroup">Contributed by <span xmlns="http://www.w3.org/1999/xhtml" class="author"><span class="firstname">Poul-Henning</span> <span class="surname">Kamp</span></span>, <span xmlns="http://www.w3.org/1999/xhtml" class="author"><span class="firstname">David</span> <span class="surname">O'Brien</span></span> and <span xmlns="http://www.w3.org/1999/xhtml" class="author"><span class="firstname">Gavin</span> <span class="surname">Atkinson</span></span>. </span></div></div></div><a id="idp49175416" class="indexterm"></a><p>Some parts of the FreeBSD distribution consist of software
      that is actively being maintained outside the FreeBSD project.
      For historical reasons, we call this
      <span class="emphasis"><em>contributed</em></span> software.  Some examples are
      <span class="application">sendmail</span>,
      <span class="application">gcc</span> and
      <span class="application">patch</span>.</p><p>Over the last couple of years, various methods have been
      used in dealing with this type of software and all have some
      number of advantages and drawbacks.  No clear winner has
      emerged.</p><p>Since this is the case, after some debate one of these
      methods has been selected as the <span class="quote">&#8220;<span class="quote">official</span>&#8221;</span> method
      and will be required for future imports of software of this
      kind.  Furthermore, it is strongly suggested that existing
      contributed software converge on this model over time, as it has
      significant advantages over the old method, including the
      ability to easily obtain diffs relative to the
      <span class="quote">&#8220;<span class="quote">official</span>&#8221;</span> versions of the source by everyone (even
      without direct repository access).  This will make it
      significantly easier to return changes to the primary developers
      of the contributed software.</p><p>Ultimately, however, it comes down to the people actually
      doing the work.  If using this model is particularly unsuited to
      the package being dealt with, exceptions to these rules may be
      granted only with the approval of the core team and with the
      general consensus of the other developers.  The ability to
      maintain the package in the future will be a key issue in the
      decisions.</p><div xmlns="" class="note"><h3 class="admontitle">Note: </h3><p xmlns="http://www.w3.org/1999/xhtml">Because it makes it harder to import future versions
	minor, trivial and/or cosmetic changes are
	<span class="emphasis"><em>strongly discouraged</em></span> on files that are
	still tracking the vendor branch.</p></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="vendor-import-svn"></a>5.3.1. Vendor Imports with SVN</h3></div><div><span class="authorgroup">Contributed by <span xmlns="http://www.w3.org/1999/xhtml" class="author"><span class="firstname">Dag-Erling</span> <span class="surname">Smørgrav</span></span>. </span></div></div></div><p>This section describes the vendor import procedure with
	<span class="application">Subversion</span> in details.</p><div class="procedure"><ol class="procedure" type="1"><li class="step"><p class="title"><strong>Preparing the Tree</strong></p><p>If this is your first import after the switch to
	    <acronym class="acronym">SVN</acronym>, you will have to flatten and clean
	    up the vendor tree, and bootstrap merge history in the
	    main tree.  If not, you can safely omit this step.</p><p>During the conversion from <acronym class="acronym">CVS</acronym> to
	    <acronym class="acronym">SVN</acronym>, vendor branches were imported with
	    the same layout as the main tree.  For example, the
	    <span class="application">foo</span> vendor sources ended up in
	    <code class="filename">vendor/<em class="replaceable"><code>foo</code></em>/dist/contrib/<em class="replaceable"><code>foo</code></em></code>,
	    but it is pointless and rather inconvenient.  What we
	    really want is to have the vendor source directly in
	    <code class="filename">vendor/<em class="replaceable"><code>foo</code></em>/dist</code>,
	    like this:</p><pre class="screen"><code class="prompt">%</code> <strong class="userinput"><code>cd vendor/<em class="replaceable"><code>foo</code></em>/dist/contrib/<em class="replaceable"><code>foo</code></em></code></strong>
<code class="prompt">%</code> <strong class="userinput"><code>svn move $(svn list) ../..</code></strong>
<code class="prompt">%</code> <strong class="userinput"><code>cd ../..</code></strong>
<code class="prompt">%</code> <strong class="userinput"><code>svn remove contrib</code></strong>
<code class="prompt">%</code> <strong class="userinput"><code>svn propdel -R svn:mergeinfo</code></strong>
<code class="prompt">%</code> <strong class="userinput"><code>svn commit</code></strong></pre><p>Note that, the <code class="literal">propdel</code> bit is
	    necessary because starting with 1.5, Subversion will
	    automatically add <code class="literal">svn:mergeinfo</code> to any
	    directory you copy or move.  In this case, you will not
	    need this information, since you are not going to merge
	    anything from the tree you deleted.</p><div xmlns="" class="note"><h3 class="admontitle">Note: </h3><p xmlns="http://www.w3.org/1999/xhtml">You may want to flatten the tags as well.  The
	      procedure is exactly the same.  If you do this, put off
	      the commit until the end.</p></div><p>Check the <code class="filename">dist</code> tree and perform
	    any cleanup that is deemed to be necessary.  You may want
	    to disable keyword expansion, as it makes no sense on
	    unmodified vendor code.  In some cases, it can be even be
	    harmful.</p><pre class="screen"><code class="prompt">%</code> <strong class="userinput"><code>svn propdel svn:keywords -R .</code></strong>
<code class="prompt">%</code> <strong class="userinput"><code>svn commit</code></strong></pre><p>Bootstrapping of <code class="literal">svn:mergeinfo</code> on
	    the target directory (in the main tree) to the revision
	    that corresponds to the last change was made to the vendor
	    tree prior to importing new sources is also needed:</p><pre class="screen"><code class="prompt">%</code> <strong class="userinput"><code>cd head/contrib/<em class="replaceable"><code>foo</code></em></code></strong>
<code class="prompt">%</code> <strong class="userinput"><code>svn merge --record-only ^/vendor/<em class="replaceable"><code>foo</code></em>/dist@<em class="replaceable"><code>12345678</code></em> .</code></strong>
<code class="prompt">%</code> <strong class="userinput"><code>svn commit</code></strong></pre><p>With some shells, the <code class="literal">^</code> in the
	    above command may need to be escaped with a
	    backslash.</p></li><li class="step"><p class="title"><strong>Importing New Sources</strong></p><p>Prepare a full, clean tree of the vendor sources.
	    With <acronym class="acronym">SVN</acronym>, we can keep a full
	    distribution in the vendor tree without bloating the main
	    tree.  Import everything but merge only what is
	    needed.</p><p>Note that you will need to add any files that were
	    added since the last vendor import, and remove any that
	    were removed.  To facilitate this, you should prepare
	    sorted lists of the contents of the vendor tree and of the
	    sources you are about to import:</p><pre class="screen"><code class="prompt">%</code> <strong class="userinput"><code>cd vendor/<em class="replaceable"><code>foo</code></em>/dist</code></strong>
<code class="prompt">%</code> <strong class="userinput"><code>svn list -R | grep -v '/$' | sort &gt; ../<em class="replaceable"><code>old</code></em></code></strong>
<code class="prompt">%</code> <strong class="userinput"><code>cd ../<em class="replaceable"><code>foo-9.9</code></em></code></strong>
<code class="prompt">%</code> <strong class="userinput"><code>find . -type f | cut -c 3- | sort &gt; ../<em class="replaceable"><code>new</code></em></code></strong></pre><p>With these two files, the following command will list
	    removed files (files only in
	    <code class="filename"><em class="replaceable"><code>old</code></em></code>):</p><pre class="screen"><code class="prompt">%</code> <strong class="userinput"><code>comm -23 ../<em class="replaceable"><code>old</code></em> ../<em class="replaceable"><code>new</code></em></code></strong></pre><p>While the command below will list added files (files
	    only in
	    <code class="filename"><em class="replaceable"><code>new</code></em></code>):</p><pre class="screen"><code class="prompt">%</code> <strong class="userinput"><code>comm -13 ../<em class="replaceable"><code>old</code></em> ../<em class="replaceable"><code>new</code></em></code></strong></pre><p>Let us put this together:</p><pre class="screen"><code class="prompt">%</code> <strong class="userinput"><code>cd vendor/<em class="replaceable"><code>foo</code></em>/<em class="replaceable"><code>foo-9.9</code></em></code></strong>
<code class="prompt">%</code> <strong class="userinput"><code>tar cf - . | tar xf - -C ../dist</code></strong>
<code class="prompt">%</code> <strong class="userinput"><code>cd ../dist</code></strong>
<code class="prompt">%</code> <strong class="userinput"><code>comm -23 ../<em class="replaceable"><code>old</code></em> ../<em class="replaceable"><code>new</code></em> | xargs svn remove</code></strong>
<code class="prompt">%</code> <strong class="userinput"><code>comm -13 ../<em class="replaceable"><code>old</code></em> ../<em class="replaceable"><code>new</code></em> | xargs svn add</code></strong></pre><div xmlns="" class="warning"><h3 class="admontitle">Warning: </h3><p xmlns="http://www.w3.org/1999/xhtml">If there are new directories in the new
	      distribution, the last command will fail.  You will have
	      to add the directories, and run it again.  Conversely,
	      if any directories were removed, you will have to remove
	      them manually.</p></div><p>Check properties on any new files:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>All text files
		should have <code class="literal">svn:eol-style</code> set to
		<code class="literal">native</code>.</p></li><li class="listitem"><p>All binary files should have
		<code class="literal">svn:mime-type</code> set to
		<code class="literal">application/octet-stream</code>, unless
		there is a more appropriate media type.</p></li><li class="listitem"><p>Executable files should have
		<code class="literal">svn:executable</code> set to
		<code class="literal">*</code>.</p></li><li class="listitem"><p>There should be no other properties on any file in
		the tree.</p></li></ul></div><div xmlns="" class="note"><h3 class="admontitle">Note: </h3><p xmlns="http://www.w3.org/1999/xhtml">You are ready to commit, but you should first check
	      the output of <code class="command">svn stat</code> and
	      <code class="command">svn diff</code> to make sure everything is
	      in order.</p></div><p>Once you have committed the new vendor release, you
	    should tag it for future reference.  The best and quickest
	    way is to do it directly in the repository:</p><pre class="screen"><code class="prompt">%</code> <strong class="userinput"><code>svn copy ^/vendor/<em class="replaceable"><code>foo</code></em>/dist <em class="replaceable"><code>svn_base</code></em>/vendor/<em class="replaceable"><code>foo</code></em>/<em class="replaceable"><code>9.9</code></em></code></strong></pre><p>To get the new tag, you can update your working copy
	    of
	    <code class="filename">vendor/<em class="replaceable"><code>foo</code></em></code>.</p><div xmlns="" class="note"><h3 class="admontitle">Note: </h3><p xmlns="http://www.w3.org/1999/xhtml">If you choose to do the copy in the checkout
	      instead, do not forget to remove the generated
	      <code class="literal">svn:mergeinfo</code> as described
	      above.</p></div></li><li class="step"><p class="title"><strong>Merging to <span class="emphasis"><em>-HEAD</em></span></strong></p><p>After you have prepared your import, it is time to
	    merge.  Option <code class="option">--accept=postpone</code> tells
	    <acronym class="acronym">SVN</acronym> not to handle merge conflicts yet,
	    because they will be taken care of manually:</p><pre class="screen"><code class="prompt">%</code> <strong class="userinput"><code>cd head/contrib/<em class="replaceable"><code>foo</code></em></code></strong>
<code class="prompt">%</code> <strong class="userinput"><code>svn update</code></strong>
<code class="prompt">%</code> <strong class="userinput"><code>svn merge --accept=postpone ^/vendor/<em class="replaceable"><code>foo</code></em>/dist</code></strong></pre><p>Resolve any conflicts, and make sure that any files
	    that were added or removed in the vendor tree have been
	    properly added or removed in the main tree.  It is always
	    a good idea to check differences against the vendor
	    branch:</p><pre class="screen"><code class="prompt">%</code> <strong class="userinput"><code>svn diff --no-diff-deleted --old=^/vendor/<em class="replaceable"><code>foo</code></em>/dist --new=.</code></strong></pre><p><code class="option">--no-diff-deleted</code> tells
	    <acronym class="acronym">SVN</acronym> not to check files that are in the
	    vendor tree but not in the main tree.</p><div xmlns="" class="note"><h3 class="admontitle">Note: </h3><p xmlns="http://www.w3.org/1999/xhtml">With <acronym class="acronym">SVN</acronym>, there is no concept of
	      on or off the vendor branch.  If a file that previously
	      had local modifications no longer does, just remove any
	      left-over cruft, such as FreeBSD version tags, so it no
	      longer shows up in diffs against the vendor tree.</p></div><p>If any changes are required for the world to build
	    with the new sources, make them now &#8212; and test until
	    you are satisfied that everything build and runs
	    correctly.</p></li><li class="step"><p class="title"><strong>Commit</strong></p><p>Now, you are ready to commit.  Make sure you get
	    everything in one go.  Ideally, you would have done all
	    steps in a clean tree, in which case you can just commit
	    from the top of that tree.  That is the best way to avoid
	    surprises.  If you do it properly, the tree will move
	    atomically from a consistent state with the old code to a
	    consistent state with the new code.</p></li></ol></div></div></div><div class="sect1"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="policies-encumbered"></a>5.4. Encumbered Files</h2></div></div></div><p>It might occasionally be necessary to include an encumbered
      file in the FreeBSD source tree.  For example, if a device
      requires a small piece of binary code to be loaded to it before
      the device will operate, and we do not have the source to that
      code, then the binary file is said to be encumbered.  The
      following policies apply to including encumbered files in the
      FreeBSD source tree.</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>Any file which is interpreted or executed by the system
	  CPU(s) and not in source format is encumbered.</p></li><li class="listitem"><p>Any file with a license more restrictive than BSD or GNU
	  is encumbered.</p></li><li class="listitem"><p>A file which contains downloadable binary data for use
	  by the hardware is not encumbered, unless (1) or (2) apply
	  to it.  It must be stored in an architecture neutral ASCII
	  format (file2c or uuencoding is recommended).</p></li><li class="listitem"><p>Any encumbered file requires specific approval from the
	  <a class="link" href="../../../../administration.html#t-core" target="_top">Core
	    Team</a> before it is added to the repository.</p></li><li class="listitem"><p>Encumbered files go in <code class="filename">src/contrib</code>
	  or <code class="filename">src/sys/contrib</code>.</p></li><li class="listitem"><p>The entire module should be kept together.  There is no
	  point in splitting it, unless there is code-sharing with
	  non-encumbered code.</p></li><li class="listitem"><p>Object files are named
	  <code class="filename"><em class="replaceable"><code>arch</code></em>/<em class="replaceable"><code>filename</code></em>.o.uu&gt;</code>.</p></li><li class="listitem"><p>Kernel files:</p><div class="orderedlist"><ol class="orderedlist" type="a"><li class="listitem"><p>Should always be referenced in
	      <code class="filename">conf/files.*</code> (for build
	      simplicity).</p></li><li class="listitem"><p>Should always be in <code class="filename">LINT</code>, but
	      the <a class="link" href="../../../../administration.html#t-core" target="_top">Core
		Team</a> decides per case if it should be commented
	      out or not.  The <a class="link" href="../../../../administration.html#t-core" target="_top">Core
		Team</a> can, of course, change their minds later
	      on.</p></li><li class="listitem"><p>The <em class="firstterm">Release Engineer</em>
	      decides whether or not it goes into the release.</p></li></ol></div></li><li class="listitem"><p>User-land files:</p><div class="orderedlist"><ol class="orderedlist" type="a"><li class="listitem"><p>The <a class="link" href="../../../../administration.html#t-core" target="_top">Core
		team</a><a id="idp49697784" class="indexterm"></a> decides if the code
	      should be part of <code class="command">make world</code>.</p></li><li class="listitem"><p>The <a class="link" href="../../../../administration.html#t-re" target="_top">Release
		Engineering</a><a id="idp49699832" class="indexterm"></a> decides if it goes
	      into the release.</p></li></ol></div></li></ol></div></div><div class="sect1"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="policies-shlib"></a>5.5. Shared Libraries</h2></div><div><span class="authorgroup">Contributed by <span xmlns="http://www.w3.org/1999/xhtml" class="author"><span class="firstname">Satoshi</span> <span class="surname">Asami</span></span>, <span xmlns="http://www.w3.org/1999/xhtml" class="author"><span class="firstname">Peter</span> <span class="surname">Wemm</span></span> and <span xmlns="http://www.w3.org/1999/xhtml" class="author"><span class="firstname">David</span> <span class="surname">O'Brien</span></span>. </span></div></div></div><p>If you are adding shared library support to a port or other
      piece of software that does not have one, the version numbers
      should follow these rules.  Generally, the resulting numbers
      will have nothing to do with the release version of the
      software.</p><p>The three principles of shared library building are:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Start from <code class="literal">1.0</code></p></li><li class="listitem"><p>If there is a change that is backwards compatible, bump
	  minor number (note that ELF systems ignore the minor
	  number)</p></li><li class="listitem"><p>If there is an incompatible change, bump major
	  number</p></li></ul></div><p>For instance, added functions and bugfixes result in the
      minor version number being bumped, while deleted functions,
      changed function call syntax, etc. will force the major version
      number to change.</p><p>Stick to version numbers of the form major.minor
      (<em class="replaceable"><code>x</code></em>.<em class="replaceable"><code>y</code></em>).
      Our a.out dynamic linker does not handle version numbers of the
      form
      <em class="replaceable"><code>x</code></em>.<em class="replaceable"><code>y</code></em>.<em class="replaceable"><code>z</code></em>
      well.  Any version number after the <em class="replaceable"><code>y</code></em>
      (i.e., the third digit) is totally ignored when comparing shared
      lib version numbers to decide which library to link with.  Given
      two shared libraries that differ only in the
      <span class="quote">&#8220;<span class="quote">micro</span>&#8221;</span> revision, <code class="command">ld.so</code> will
      link with the higher one.  That is, if you link with
      <code class="filename">libfoo.so.3.3.3</code>, the linker only records
      <code class="literal">3.3</code> in the headers, and will link with
      anything starting with
      <em class="replaceable"><code>libfoo.so.3</code></em>.<em class="replaceable"><code>(anything
	&gt;= 3)</code></em>.<em class="replaceable"><code>(highest
	available)</code></em>.</p><div xmlns="" class="note"><h3 class="admontitle">Note: </h3><p xmlns="http://www.w3.org/1999/xhtml"><code class="command">ld.so</code> will always use the highest
	<span class="quote">&#8220;<span class="quote">minor</span>&#8221;</span> revision.  For instance, it will use
	<code class="filename">libc.so.2.2</code> in preference to
	<code class="filename">libc.so.2.0</code>, even if the program was
	initially linked with <code class="filename">libc.so.2.0</code>.</p></div><p>In addition, our ELF dynamic linker does not handle minor
      version numbers at all.  However, one should still specify a
      major and minor version number as our
      <code class="filename">Makefile</code>s <span class="quote">&#8220;<span class="quote">do the right thing</span>&#8221;</span>
      based on the type of system.</p><p>For non-port libraries, it is also our policy to change the
      shared library version number only once between releases.  In
      addition, it is our policy to change the major shared library
      version number only once between major OS releases (i.e., from
      6.0 to 7.0).  When you make a change to a system library that
      requires the version number to be bumped, check the
      <code class="filename">Makefile</code>'s commit logs.  It is the
      responsibility of the committer to ensure that the first such
      change since the release will result in the shared library
      version number in the <code class="filename">Makefile</code> to be
      updated, and any subsequent changes will not.</p></div></div><div class="chapter"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="testing"></a>Chapter 6. Regression and Performance Testing</h2></div></div></div><div class="toc"><div class="toc-title">Table of Contents</div><dl class="toc"><dt><span class="section"><a href="#testing-micro-benchmark">6.1. Micro Benchmark Checklist</a></span></dt><dt><span class="section"><a href="#testing-tinderbox">6.2. The FreeBSD Source Tinderbox</a></span></dt></dl></div><p>Regression tests are used to exercise a particular bit of the
    system to check that it works as expected, and to make sure that
    old bugs are not reintroduced.</p><p>The FreeBSD regression testing tools can be found in the FreeBSD
    source tree in the directory
    <code class="filename">src/tools/regression</code>.</p><div class="section"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="testing-micro-benchmark"></a>6.1. Micro Benchmark Checklist</h2></div></div></div><p>This section contains hints for doing proper
      micro-benchmarking on FreeBSD or of FreeBSD itself.</p><p>It is not possible to use all of the suggestions below every
      single time, but the more used, the better the benchmark's
      ability to test small differences will be.</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Disable <acronym class="acronym">APM</acronym> and any other kind of
	  clock fiddling (<acronym class="acronym">ACPI</acronym> ?).</p></li><li class="listitem"><p>Run in single user mode.  E.g., <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=cron&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">cron</span>(8)</span></a>, and other
	  daemons only add noise.  The <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=sshd&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">sshd</span>(8)</span></a> daemon can also
	  cause problems.  If ssh access is required during testing
	  either disable the SSHv1 key regeneration, or kill the
	  parent <code class="command">sshd</code> daemon during the
	  tests.</p></li><li class="listitem"><p>Do not run <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=ntpd&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">ntpd</span>(8)</span></a>.</p></li><li class="listitem"><p>If <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=syslog&amp;sektion=3&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">syslog</span>(3)</span></a> events are generated, run
	  <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=syslogd&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">syslogd</span>(8)</span></a> with an empty
	  <code class="filename">/etc/syslogd.conf</code>, otherwise, do not
	  run it.</p></li><li class="listitem"><p>Minimize disk-I/O, avoid it entirely if possible.</p></li><li class="listitem"><p>Do not mount file systems that are not needed.</p></li><li class="listitem"><p>Mount <code class="filename">/</code>,
	  <code class="filename">/usr</code>, and any other
	  file system as read-only if possible.  This removes atime
	  updates to disk (etc.) from the I/O picture.</p></li><li class="listitem"><p>Reinitialize the read/write test file system with
	  <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=newfs&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">newfs</span>(8)</span></a> and populate it from a <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=tar&amp;sektion=1&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">tar</span>(1)</span></a> or
	  <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=dump&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">dump</span>(8)</span></a> file before every run.  Unmount and mount it
	  before starting the test.  This results in a consistent file
	  system layout.  For a worldstone test this would apply to
	  <code class="filename">/usr/obj</code> (just
	  reinitialize with <code class="command">newfs</code> and mount).  To
	  get 100% reproducibility, populate the file system from a
	  <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=dd&amp;sektion=1&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">dd</span>(1)</span></a> file (i.e.: <code class="command">dd
	    if=myimage of=/dev/ad0s1h
	    bs=1m</code>)</p></li><li class="listitem"><p>Use malloc backed or preloaded <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=md&amp;sektion=4&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">md</span>(4)</span></a>
	  partitions.</p></li><li class="listitem"><p>Reboot between individual iterations of the test, this
	  gives a more consistent state.</p></li><li class="listitem"><p>Remove all non-essential device drivers from the kernel.
	  For instance if USB is not needed for the test, do not put
	  USB in the kernel.  Drivers which attach often have timeouts
	  ticking away.</p></li><li class="listitem"><p>Unconfigure hardware that are not in use.  Detach disks
	  with <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=atacontrol&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">atacontrol</span>(8)</span></a> and <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=camcontrol&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">camcontrol</span>(8)</span></a> if the disks
	  are not used for the test.</p></li><li class="listitem"><p>Do not configure the network unless it is being tested,
	  or wait until after the test has been performed to ship the
	  results off to another computer.</p><p>If the system must be connected to a public network,
	  watch out for spikes of broadcast traffic.  Even though it
	  is hardly noticeable, it will take up CPU cycles.  Multicast
	  has similar caveats.</p></li><li class="listitem"><p>Put each file system on its own disk.  This minimizes
	  jitter from head-seek optimizations.</p></li><li class="listitem"><p>Minimize output to serial or VGA consoles.  Running
	  output into files gives less jitter.  (Serial consoles
	  easily become a bottleneck.)  Do not touch keyboard while
	  the test is running, even <span class="keycap"><strong>space</strong></span> or
	  <span class="keycap"><strong>back-space</strong></span> shows up in the numbers.</p></li><li class="listitem"><p>Make sure the test is long enough, but not too long.  If
	  the test is too short, timestamping is a problem.  If it is
	  too long temperature changes and drift will affect the
	  frequency of the quartz crystals in the computer.  Rule of
	  thumb: more than a minute, less than an hour.</p></li><li class="listitem"><p>Try to keep the temperature as stable as possible around
	  the machine.  This affects both quartz crystals and disk
	  drive algorithms.  To get real stable clock, consider
	  stabilized clock injection.  E.g., get a OCXO + PLL, inject
	  output into clock circuits instead of motherboard xtal.
	  Contact Poul-Henning Kamp <code class="email">&lt;<a xmlns="" class="email" href="mailto:phk@FreeBSD.org">phk@FreeBSD.org</a>&gt;</code> for more information about
	  this.</p></li><li class="listitem"><p>Run the test at least 3 times but it is better to run
	  more than 20 times both for <span class="quote">&#8220;<span class="quote">before</span>&#8221;</span> and
	  <span class="quote">&#8220;<span class="quote">after</span>&#8221;</span> code.  Try to interleave if possible
	  (i.e.: do not run 20 times before then 20 times after), this
	  makes it possible to spot environmental effects.  Do not
	  interleave 1:1, but 3:3, this makes it possible to spot
	  interaction effects.</p><p>A good pattern is: <code class="literal">bababa{bbbaaa}*</code>.
	  This gives hint after the first 1+1 runs (so it is possible
	  to stop the test if it goes entirely the wrong way), a
	  standard deviation after the first 3+3 (gives a good
	  indication if it is going to be worth a long run) and
	  trending and interaction numbers later on.</p></li><li class="listitem"><p>Use <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=ministat&amp;sektion=1&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">ministat</span>(1)</span></a>
	  to see if the numbers are significant.  Consider buying
	  <span class="quote">&#8220;<span class="quote">Cartoon guide to statistics</span>&#8221;</span> ISBN:
	  0062731025, highly recommended, if you have forgotten or
	  never learned about standard deviation and Student's
	  T.</p></li><li class="listitem"><p>Do not use background <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=fsck&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">fsck</span>(8)</span></a> unless the test is a
	  benchmark of background <code class="command">fsck</code>.  Also,
	  disable <code class="varname">background_fsck</code> in
	  <code class="filename">/etc/rc.conf</code> unless the benchmark is
	  not started at least 60+<span class="quote">&#8220;<span class="quote"><code class="command">fsck</code>
	    runtime</span>&#8221;</span> seconds after the boot, as <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=rc&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">rc</span>(8)</span></a>
	  wakes up and checks if <code class="command">fsck</code> needs to run
	  on any file systems when background <code class="command">fsck</code>
	  is enabled.  Likewise, make sure there are no snapshots
	  lying around unless the benchmark is a test with
	  snapshots.</p></li><li class="listitem"><p>If the benchmark show unexpected bad performance, check
	  for things like high interrupt volume from an unexpected
	  source.  Some versions of <acronym class="acronym">ACPI</acronym> have been
	  reported to <span class="quote">&#8220;<span class="quote">misbehave</span>&#8221;</span> and generate excess
	  interrupts.  To help diagnose odd test results, take a few
	  snapshots of <code class="command">vmstat -i</code> and look for
	  anything unusual.</p></li><li class="listitem"><p>Make sure to be careful about optimization parameters
	  for kernel and userspace, likewise debugging.  It is easy to
	  let something slip through and realize later the test was
	  not comparing the same thing.</p></li><li class="listitem"><p>Do not ever benchmark with the
	  <code class="literal">WITNESS</code> and <code class="literal">INVARIANTS</code>
	  kernel options enabled unless the test is interested to
	  benchmarking those features.  <code class="literal">WITNESS</code> can
	  cause 400%+ drops in performance.  Likewise, userspace
	  <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=malloc&amp;sektion=3&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">malloc</span>(3)</span></a> parameters default differently in -CURRENT
	  from the way they ship in production releases.</p></li></ul></div></div><div class="section"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="testing-tinderbox"></a>6.2. The FreeBSD Source Tinderbox</h2></div></div></div><p>The source Tinderbox consists of:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>A build script, <code class="filename">tinderbox</code>, that
	  automates checking out a specific version of the FreeBSD source
	  tree and building it.</p></li><li class="listitem"><p>A supervisor script, <code class="filename">tbmaster</code>, that
	  monitors individual Tinderbox instances, logs their output,
	  and emails failure notices.</p></li><li class="listitem"><p>A <acronym class="acronym">CGI</acronym> script named
	  <code class="filename">index.cgi</code> that reads a set of tbmaster
	  logs and presents an easy-to-read <acronym class="acronym">HTML</acronym>
	  summary of them.</p></li><li class="listitem"><p>A set of build servers that continually test the tip of
	  the most important FreeBSD code branches.</p></li><li class="listitem"><p>A webserver that keeps a complete set of Tinderbox logs
	  and displays an up-to-date summary.</p></li></ul></div><p>The scripts are maintained and were developed by
      Dag-Erling Smørgrav <code class="email">&lt;<a xmlns="" class="email" href="mailto:des@FreeBSD.org">des@FreeBSD.org</a>&gt;</code>, and are now written in Perl, a move on from their
      original incarnation as shell scripts.  All scripts and
      configuration files are kept in <a class="link" href="https://www.freebsd.org/cgi/cvsweb.cgi/projects/tinderbox/" target="_top">/projects/tinderbox/</a>.</p><p>For more information about the tinderbox and tbmaster
      scripts at this stage, see their respective man pages:
      tinderbox(1) and tbmaster(1).</p><div class="section"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp49777656"></a>6.2.1. The <code class="filename">index.cgi</code> Script</h3></div></div></div><p>The <code class="filename">index.cgi</code> script generates the
	<acronym class="acronym">HTML</acronym> summary of tinderbox and tbmaster
	logs.  Although originally intended to be used as a
	<acronym class="acronym">CGI</acronym> script, as indicated by its name, this
	script can also be run from the command line or from a
	<a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=cron&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">cron</span>(8)</span></a> job, in which case it will look for logs in the
	directory where the script is located.  It will automatically
	detect context, generating <acronym class="acronym">HTTP</acronym> headers
	when it is run as a <acronym class="acronym">CGI</acronym> script.  It
	conforms to <acronym class="acronym">XHTML</acronym> standards and is styled
	using <acronym class="acronym">CSS</acronym>.</p><p>The script starts in the <code class="function">main()</code> block
	by attempting to verify that it is running on the official
	Tinderbox website.  If it is not, a page indicating it is not
	an official website is produced, and a <acronym class="acronym">URL</acronym>
	to the official site is provided.</p><p>Next, it scans the log directory to get an inventory of
	configurations, branches and architectures for which log files
	exist, to avoid hard-coding a list into the script and
	potentially ending up with blank rows or columns.  This
	information is derived from the names of the log files
	matching the following pattern:</p><pre class="programlisting">tinderbox-$config-$branch-$arch-$machine.{brief,full}</pre><p>The configurations used on the official Tinderbox build
	servers are named for the branches they build.  For example,
	the <code class="literal">releng_8</code> configuration is used to build
	<code class="literal">RELENG_8</code> as well as all still-supported
	release branches.</p><p>Once all of this startup procedure has been successfully
	completed, <code class="function">do_config()</code> is called for each
	configuration.</p><p>The <code class="function">do_config()</code> function generates
	<acronym class="acronym">HTML</acronym> for a single Tinderbox
	configuration.</p><p>It works by first generating a header row, then iterating
	over each branch build with the specified configuration,
	producing a single row of results for each in the following
	manner:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>For each item:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><p>For each machine within that architecture:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: square; "><li class="listitem"><p>If a brief log file exists, then:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Call <code class="function">success()</code> to
			determine the outcome of the build.</p></li><li class="listitem"><p>Output the modification size.</p></li><li class="listitem"><p>Output the size of the brief log file with
			a link to the log file itself.</p></li><li class="listitem"><p>If a full log file also exists,
			then:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><p>Output the size of the full log file
			    with a link to the log file itself.</p></li></ul></div></li></ul></div></li><li class="listitem"><p>Otherwise:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>No output.</p></li></ul></div></li></ul></div></li></ul></div></li></ul></div><p>The <code class="function">success()</code> function mentioned
	above scans a brief log file for the string <span class="quote">&#8220;<span class="quote">tinderbox
	  run completed</span>&#8221;</span> in order to determine whether the
	build was successful.</p><p>Configurations and branches are sorted according to their
	branch rank.  This is computed as follows:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p><code class="literal">HEAD</code> and <code class="literal">CURRENT</code>
	    have rank 9999.</p></li><li class="listitem"><p><code class="literal">RELENG_<em class="replaceable"><code>x</code></em></code>
	    has rank <em class="replaceable"><code>xx</code></em>99.</p></li><li class="listitem"><p><code class="literal">RELENG_<em class="replaceable"><code>x</code></em>_<em class="replaceable"><code>y</code></em></code>
	    has rank <em class="replaceable"><code>xxyy</code></em>.</p></li></ul></div><p>This means that <code class="literal">HEAD</code> always ranks
	highest, and <code class="literal">RELENG</code> branches are ranked in
	numerical order, with each <code class="literal">STABLE</code> branch
	ranking higher than the release branches forked off of it.
	For instance, for FreeBSD 8, the order from highest to
	lowest would be:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p><code class="literal">RELENG_8</code> (branch rank 899).</p></li><li class="listitem"><p><code class="literal">RELENG_8_3</code> (branch rank
	    803).</p></li><li class="listitem"><p><code class="literal">RELENG_8_2</code> (branch rank
	    802).</p></li><li class="listitem"><p><code class="literal">RELENG_8_1</code> (branch rank
	    801).</p></li><li class="listitem"><p><code class="literal">RELENG_8_0</code> (branch rank
	    800).</p></li></ul></div><p>The colors that Tinderbox uses for each cell in the table
	are defined by <acronym class="acronym">CSS</acronym>.  Successful builds are
	displayed with green text; unsuccessful builds are displayed
	with red text.  The color fades as time passes since the
	corresponding build, with every half an hour bringing the
	color closer to grey.</p></div><div class="section"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp49608568"></a>6.2.2. Official Build Servers</h3></div></div></div><p>The official Tinderbox build servers are hosted by <a class="link" href="http://www.sentex.ca" target="_top">Sentex Data
	  Communications</a>, who also host the FreeBSD
	  Netperf Cluster.</p><p>Three build servers currently exist:</p><p><span class="emphasis"><em>freebsd-current.sentex.ca</em></span>
	builds:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p><code class="literal">HEAD</code> for amd64, arm, i386,
	    i386/pc98, ia64, mips, powerpc, powerpc64, and
	    sparc64.</p></li><li class="listitem"><p><code class="literal">RELENG_9</code> and supported
	    9.<em class="replaceable"><code>X</code></em> branches for amd64, arm,
	    i386, i386/pc98, ia64, mips, powerpc, powerpc64, and
	    sparc64.</p></li></ul></div><p><span class="emphasis"><em>freebsd-stable.sentex.ca</em></span>
	builds:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p><code class="literal">RELENG_8</code> and supported
	    8.<em class="replaceable"><code>X</code></em> branches for amd64, i386,
	    i386/pc98, ia64, mips, powerpc and sparc64.</p></li></ul></div><p><span class="emphasis"><em>freebsd-legacy.sentex.ca</em></span>
	builds:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p><code class="literal">RELENG_7</code> and supported
	    7.<em class="replaceable"><code>X</code></em> branches for amd64, i386,
	    i386/pc98, ia64, powerpc, and sparc64.</p></li></ul></div></div><div class="section"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp49840120"></a>6.2.3. Official Summary Site</h3></div></div></div><p>Summaries and logs from the official build servers are
	available online at <a class="link" href="http://tinderbox.FreeBSD.org" target="_top">http://tinderbox.FreeBSD.org</a>,
	hosted by Dag-Erling Smørgrav <code class="email">&lt;<a xmlns="" class="email" href="mailto:des@FreeBSD.org">des@FreeBSD.org</a>&gt;</code> and set up as follows:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>A <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=cron&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">cron</span>(8)</span></a> job checks the build servers at regular
	    intervals and downloads any new log files using
	    <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=rsync&amp;sektion=1&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">rsync</span>(1)</span></a>.</p></li><li class="listitem"><p>Apache is set up to use <code class="filename">index.cgi</code>
	    as <code class="literal">DirectoryIndex</code>.</p></li></ul></div></div></div></div></div><div class="part"><div xmlns="" class="titlepage"><div><div><h1 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="ipc"></a>Part II. Interprocess Communication</h1></div></div></div><div class="toc"><div class="toc-title">Table of Contents</div><dl class="toc"><dt><span class="chapter"><a href="#sockets">7. Sockets</a></span></dt><dd><dl><dt><span class="sect1"><a href="#sockets-synopsis">7.1. Synopsis</a></span></dt><dt><span class="sect1"><a href="#sockets-diversity">7.2. Networking and Diversity</a></span></dt><dt><span class="sect1"><a href="#sockets-protocols">7.3. Protocols</a></span></dt><dt><span class="sect1"><a href="#sockets-model">7.4. The Sockets Model</a></span></dt><dt><span class="sect1"><a href="#sockets-essential-functions">7.5. Essential Socket Functions</a></span></dt><dt><span class="sect1"><a href="#sockets-helper-functions">7.6. Helper Functions</a></span></dt><dt><span class="sect1"><a href="#sockets-concurrent-servers">7.7. Concurrent Servers</a></span></dt></dl></dd><dt><span class="chapter"><a href="#ipv6">8. IPv6 Internals</a></span></dt><dd><dl><dt><span class="sect1"><a href="#ipv6-implementation">8.1. IPv6/IPsec Implementation</a></span></dt></dl></dd></dl></div><div class="chapter"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="sockets"></a>Chapter 7. Sockets</h2></div><div><span class="authorgroup">Contributed by <span xmlns="http://www.w3.org/1999/xhtml" class="author"><span class="firstname">G. Adam</span> <span class="surname">Stanislav</span></span>. </span></div></div></div><div class="toc"><div class="toc-title">Table of Contents</div><dl class="toc"><dt><span class="sect1"><a href="#sockets-synopsis">7.1. Synopsis</a></span></dt><dt><span class="sect1"><a href="#sockets-diversity">7.2. Networking and Diversity</a></span></dt><dt><span class="sect1"><a href="#sockets-protocols">7.3. Protocols</a></span></dt><dt><span class="sect1"><a href="#sockets-model">7.4. The Sockets Model</a></span></dt><dt><span class="sect1"><a href="#sockets-essential-functions">7.5. Essential Socket Functions</a></span></dt><dt><span class="sect1"><a href="#sockets-helper-functions">7.6. Helper Functions</a></span></dt><dt><span class="sect1"><a href="#sockets-concurrent-servers">7.7. Concurrent Servers</a></span></dt></dl></div><div class="sect1"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="sockets-synopsis"></a>7.1. Synopsis</h2></div></div></div><p><acronym class="acronym">BSD</acronym> sockets take interprocess
      communications to a new level.  It is no longer necessary for
      the communicating processes to run on the same machine.  They
      still <span class="emphasis"><em>can</em></span>, but they do not have to.</p><p>Not only do these processes not have to run on the same
      machine, they do not have to run under the same operating
      system.  Thanks to <acronym class="acronym">BSD</acronym> sockets, your FreeBSD
      software can smoothly cooperate with a program running on a
      <span class="trademark">Macintosh</span>®, another one running on a <span class="trademark">Sun</span>&#8482; workstation, yet
      another one running under <span class="trademark">Windows</span>® 2000, all connected with an
      Ethernet-based local area network.</p><p>But your software can equally well cooperate with processes
      running in another building, or on another continent, inside a
      submarine, or a space shuttle.</p><p>It can also cooperate with processes that are not part of a
      computer (at least not in the strict sense of the word), but of
      such devices as printers, digital cameras, medical equipment.
      Just about anything capable of digital communications.</p></div><div class="sect1"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="sockets-diversity"></a>7.2. Networking and Diversity</h2></div></div></div><p>We have already hinted on the <span class="emphasis"><em>diversity</em></span>
      of networking.  Many different systems have to talk to each
      other.  And they have to speak the same language.  They also
      have to <span class="emphasis"><em>understand</em></span> the same language the
      same way.</p><p>People often think that <span class="emphasis"><em>body language</em></span>
      is universal.  But it is not.  Back in my early teens, my father
      took me to Bulgaria.  We were sitting at a table in a park in
      Sofia, when a vendor approached us trying to sell us some
      roasted almonds.</p><p>I had not learned much Bulgarian by then, so, instead of
      saying no, I shook my head from side to side, the
      <span class="quote">&#8220;<span class="quote">universal</span>&#8221;</span> body language for
      <span class="emphasis"><em>no</em></span>.  The vendor quickly started serving us
      some almonds.</p><p>I then remembered I had been told that in Bulgaria shaking
      your head sideways meant <span class="emphasis"><em>yes</em></span>.  Quickly, I
      started nodding my head up and down.  The vendor noticed, took
      his almonds, and walked away.  To an uninformed observer, I did
      not change the body language: I continued using the language of
      shaking and nodding my head.  What changed was the
      <span class="emphasis"><em>meaning</em></span> of the body language.  At first,
      the vendor and I interpreted the same language as having
      completely different meaning.  I had to adjust my own
      interpretation of that language so the vendor would
      understand.</p><p>It is the same with computers: The same symbols may have
      different, even outright opposite meaning.  Therefore, for two
      computers to understand each other, they must not only agree on
      the same <span class="emphasis"><em>language</em></span>, but on the same
      <span class="emphasis"><em>interpretation</em></span> of the language.</p></div><div class="sect1"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="sockets-protocols"></a>7.3. Protocols</h2></div></div></div><p>While various programming languages tend to have complex
      syntax and use a number of multi-letter reserved words (which
      makes them easy for the human programmer to understand), the
      languages of data communications tend to be very terse.  Instead
      of multi-byte words, they often use individual
      <span class="emphasis"><em>bits</em></span>.  There is a very convincing reason
      for it: While data travels <span class="emphasis"><em>inside</em></span> your
      computer at speeds approaching the speed of light, it often
      travels considerably slower between two computers.</p><p>Because the languages used in data communications are so
      terse, we usually refer to them as
      <span class="emphasis"><em>protocols</em></span> rather than languages.</p><p>As data travels from one computer to another, it always uses
      more than one protocol.  These protocols are
      <span class="emphasis"><em>layered</em></span>.  The data can be compared to the
      inside of an onion: You have to peel off several layers of
      <span class="quote">&#8220;<span class="quote">skin</span>&#8221;</span> to get to the data.  This is best
      illustrated with a picture:</p><div class="mediaobject"><img src="sockets/layers.png" alt="Protocol Layers" /></div><p>In this example, we are trying to get an image from a web
      page we are connected to via an Ethernet.</p><p>The image consists of raw data, which is simply a sequence
      of <acronym class="acronym">RGB</acronym> values that our software can process,
      i.e., convert into an image and display on our monitor.</p><p>Alas, our software has no way of knowing how the raw data is
      organized: Is it a sequence of <acronym class="acronym">RGB</acronym> values, or
      a sequence of grayscale intensities, or perhaps of
      <acronym class="acronym">CMYK</acronym> encoded colors? Is the data represented
      by 8-bit quanta, or are they 16 bits in size, or perhaps 4 bits?
      How many rows and columns does the image consist of? Should
      certain pixels be transparent?</p><p>I think you get the picture...</p><p>To inform our software how to handle the raw data, it is
      encoded as a <acronym class="acronym">PNG</acronym> file.  It could be a
      <acronym class="acronym">GIF</acronym>, or a <acronym class="acronym">JPEG</acronym>, but it is
      a <acronym class="acronym">PNG</acronym>.</p><p>And <acronym class="acronym">PNG</acronym> is a protocol.</p><p>At this point, I can hear some of you yelling,
      <span class="emphasis"><em><span class="quote">&#8220;<span class="quote">No, it is not! It is a file
	  format!</span>&#8221;</span></em></span></p><p>Well, of course it is a file format.  But from the
      perspective of data communications, a file format is a protocol:
      The file structure is a <span class="emphasis"><em>language</em></span>, a terse
      one at that, communicating to our <span class="emphasis"><em>process</em></span>
      how the data is organized.  Ergo, it is a
      <span class="emphasis"><em>protocol</em></span>.</p><p>Alas, if all we received was the <acronym class="acronym">PNG</acronym>
      file, our software would be facing a serious problem: How is it
      supposed to know the data is representing an image, as opposed
      to some text, or perhaps a sound, or what not? Secondly, how is
      it supposed to know the image is in the <acronym class="acronym">PNG</acronym>
      format as opposed to <acronym class="acronym">GIF</acronym>, or
      <acronym class="acronym">JPEG</acronym>, or some other image format?</p><p>To obtain that information, we are using another protocol:
      <acronym class="acronym">HTTP</acronym>.  This protocol can tell us exactly that
      the data represents an image, and that it uses the
      <acronym class="acronym">PNG</acronym> protocol.  It can also tell us some other
      things, but let us stay focused on protocol layers here.</p><p>So, now we have some data wrapped in the
      <acronym class="acronym">PNG</acronym> protocol, wrapped in the
      <acronym class="acronym">HTTP</acronym> protocol.  How did we get it from the
      server?</p><p>By using <acronym class="acronym">TCP/IP</acronym> over Ethernet, that is
      how.  Indeed, that is three more protocols.  Instead of
      continuing inside out, I am now going to talk about Ethernet,
      simply because it is easier to explain the rest that way.</p><p>Ethernet is an interesting system of connecting computers in
      a <span class="emphasis"><em>local area network</em></span>
      (<acronym class="acronym">LAN</acronym>).  Each computer has a <span class="emphasis"><em>network
	interface card</em></span> (<acronym class="acronym">NIC</acronym>), which has
      a unique 48-bit <acronym class="acronym">ID</acronym> called its
      <span class="emphasis"><em>address</em></span>.  No two Ethernet
      <acronym class="acronym">NIC</acronym>s in the world have the same
      address.</p><p>These <acronym class="acronym">NIC</acronym>s are all connected with each
      other.  Whenever one computer wants to communicate with another
      in the same Ethernet <acronym class="acronym">LAN</acronym>, it sends a message
      over the network.  Every <acronym class="acronym">NIC</acronym> sees the
      message.  But as part of the Ethernet
      <span class="emphasis"><em>protocol</em></span>, the data contains the address of
      the destination <acronym class="acronym">NIC</acronym> (among other things).
      So, only one of all the network interface cards will pay
      attention to it, the rest will ignore it.</p><p>But not all computers are connected to the same network.
      Just because we have received the data over our Ethernet does
      not mean it originated in our own local area network.  It could
      have come to us from some other network (which may not even be
      Ethernet based) connected with our own network via the
      Internet.</p><p>All data is transferred over the Internet using
      <acronym class="acronym">IP</acronym>, which stands for <span class="emphasis"><em>Internet
	Protocol</em></span>.  Its basic role is to let us know where
      in the world the data has arrived from, and where it is supposed
      to go to.  It does not <span class="emphasis"><em>guarantee</em></span> we will
      receive the data, only that we will know where it came from
      <span class="emphasis"><em>if</em></span> we do receive it.</p><p>Even if we do receive the data, <acronym class="acronym">IP</acronym> does
      not guarantee we will receive various chunks of data in the same
      order the other computer has sent it to us.  So, we can receive
      the center of our image before we receive the upper left corner
      and after the lower right, for example.</p><p>It is <acronym class="acronym">TCP</acronym> (<span class="emphasis"><em>Transmission Control
	Protocol</em></span>) that asks the sender to resend any lost
      data and that places it all into the proper order.</p><p>All in all, it took <span class="emphasis"><em>five</em></span> different
      protocols for one computer to communicate to another what an
      image looks like.  We received the data wrapped into the
      <acronym class="acronym">PNG</acronym> protocol, which was wrapped into the
      <acronym class="acronym">HTTP</acronym> protocol, which was wrapped into the
      <acronym class="acronym">TCP</acronym> protocol, which was wrapped into the
      <acronym class="acronym">IP</acronym> protocol, which was wrapped into the
      <acronym class="acronym">Ethernet</acronym> protocol.</p><p>Oh, and by the way, there probably were several other
      protocols involved somewhere on the way.  For example, if our
      <acronym class="acronym">LAN</acronym> was connected to the Internet through a
      dial-up call, it used the <acronym class="acronym">PPP</acronym> protocol over
      the modem which used one (or several) of the various modem
      protocols, et cetera, et cetera, et cetera...</p><p>As a developer you should be asking by now,
      <span class="emphasis"><em><span class="quote">&#8220;<span class="quote">How am I supposed to handle it
	  all?</span>&#8221;</span></em></span></p><p>Luckily for you, you are <span class="emphasis"><em>not</em></span> supposed
      to handle it all.  You <span class="emphasis"><em>are</em></span> supposed to
      handle some of it, but not all of it.  Specifically, you need
      not worry about the physical connection (in our case Ethernet
      and possibly <acronym class="acronym">PPP</acronym>, etc).  Nor do you need to
      handle the Internet Protocol, or the Transmission Control
      Protocol.</p><p>In other words, you do not have to do anything to receive
      the data from the other computer.  Well, you do have to
      <span class="emphasis"><em>ask</em></span> for it, but that is almost as simple as
      opening a file.</p><p>Once you have received the data, it is up to you to figure
      out what to do with it.  In our case, you would need to
      understand the <acronym class="acronym">HTTP</acronym> protocol and the
      <acronym class="acronym">PNG</acronym> file structure.</p><p>To use an analogy, all the internetworking protocols become
      a gray area: Not so much because we do not understand how it
      works, but because we are no longer concerned about it.  The
      sockets interface takes care of this gray area for us:</p><div class="mediaobject"><img src="sockets/slayers.png" alt="Sockets Covered Protocol Layers" /></div><p>We only need to understand any protocols that tell us how to
      <span class="emphasis"><em>interpret the data</em></span>, not how to
      <span class="emphasis"><em>receive</em></span> it from another process, nor how to
      <span class="emphasis"><em>send</em></span> it to another process.</p></div><div class="sect1"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="sockets-model"></a>7.4. The Sockets Model</h2></div></div></div><p><acronym class="acronym">BSD</acronym> sockets are built on the basic <span class="trademark">UNIX</span>®
      model: <span class="emphasis"><em>Everything is a file.</em></span> In our
      example, then, sockets would let us receive an <span class="emphasis"><em>HTTP
	file</em></span>, so to speak.  It would then be up to us to
      extract the <span class="emphasis"><em><acronym class="acronym">PNG</acronym> file</em></span>
      from it.</p><p>Because of the complexity of internetworking, we cannot just
      use the <code class="function">open</code> system call, or
      the <code class="function">open()</code> C function.  Instead, we need to
      take several steps to <span class="quote">&#8220;<span class="quote">opening</span>&#8221;</span> a socket.</p><p>Once we do, however, we can start treating the
      <span class="emphasis"><em>socket</em></span> the same way we treat any
      <span class="emphasis"><em>file descriptor</em></span>: We can
      <code class="function">read</code> from it, <code class="function">write</code> to
      it, <code class="function">pipe</code> it, and, eventually,
      <code class="function">close</code> it.</p></div><div class="sect1"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="sockets-essential-functions"></a>7.5. Essential Socket Functions</h2></div></div></div><p>While FreeBSD offers different functions to work with
      sockets, we only <span class="emphasis"><em>need</em></span> four to
      <span class="quote">&#8220;<span class="quote">open</span>&#8221;</span> a socket.  And in some cases we only need
      two.</p><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="sockets-client-server"></a>7.5.1. The Client-Server Difference</h3></div></div></div><p>Typically, one of the ends of a socket-based data
	communication is a <span class="emphasis"><em>server</em></span>, the other is a
	<span class="emphasis"><em>client</em></span>.</p><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="sockets-common-elements"></a>7.5.1.1. The Common Elements</h4></div></div></div><div class="sect4"><div xmlns="" class="titlepage"><div><div><h5 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="sockets-socket"></a>7.5.1.1.1. <code class="function">socket</code></h5></div></div></div><p>The one function used by both, clients and servers, is
	    <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=socket&amp;sektion=2&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">socket</span>(2)</span></a>.  It is declared this way:</p><pre class="programlisting">int socket(int domain, int type, int protocol);</pre><p>The return value is of the same type as that of
	    <code class="function">open</code>, an integer.  FreeBSD allocates
	    its value from the same pool as that of file handles.
	    That is what allows sockets to be treated the same way as
	    files.</p><p>The <code class="varname">domain</code> argument tells the
	    system what <span class="emphasis"><em>protocol family</em></span> you want
	    it to use.  Many of them exist, some are vendor specific,
	    others are very common.  They are declared in
	    <code class="filename">sys/socket.h</code>.</p><p>Use <code class="constant">PF_INET</code> for
	    <acronym class="acronym">UDP</acronym>, <acronym class="acronym">TCP</acronym> and other
	    Internet protocols (<acronym class="acronym">IP</acronym>v4).</p><p>Five values are defined for the
	    <code class="varname">type</code> argument, again, in
	    <code class="filename">sys/socket.h</code>.  All of them start with
	    <span class="quote">&#8220;<span class="quote"><code class="constant">SOCK_</code></span>&#8221;</span>.  The most
	    common one is <code class="constant">SOCK_STREAM</code>, which
	    tells the system you are asking for a <span class="emphasis"><em>reliable
	    stream delivery service</em></span> (which is
	    <acronym class="acronym">TCP</acronym> when used with
	    <code class="constant">PF_INET</code>).</p><p>If you asked for <code class="constant">SOCK_DGRAM</code>, you
	    would be requesting a <span class="emphasis"><em>connectionless datagram
	    delivery service</em></span> (in our case,
	    <acronym class="acronym">UDP</acronym>).</p><p>If you wanted to be in charge of the low-level
	    protocols (such as <acronym class="acronym">IP</acronym>), or even network
	    interfaces (e.g., the Ethernet), you would need to specify
	    <code class="constant">SOCK_RAW</code>.</p><p>Finally, the <code class="varname">protocol</code> argument
	    depends on the previous two arguments, and is not always
	    meaningful.  In that case, use <code class="constant">0</code> for
	    its value.</p><div xmlns="" class="note"><h3 class="admontitle"><a xmlns="http://www.w3.org/1999/xhtml" id="sockets-unconnected"></a>The Unconnected Socket: </h3><p xmlns="http://www.w3.org/1999/xhtml">Nowhere, in the <code class="function">socket</code> function
	      have we specified to what other system we should be
	      connected.  Our newly created socket remains
	      <span class="emphasis"><em>unconnected</em></span>.</p><p xmlns="http://www.w3.org/1999/xhtml">This is on purpose: To use a telephone analogy, we
	      have just attached a modem to the phone line.  We have
	      neither told the modem to make a call, nor to answer if
	      the phone rings.</p></div></div><div class="sect4"><div xmlns="" class="titlepage"><div><div><h5 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="sockets-sockaddr"></a>7.5.1.1.2. <code class="varname">sockaddr</code></h5></div></div></div><p>Various functions of the sockets family expect the
	    address of (or pointer to, to use C terminology) a small
	    area of the memory.  The various C declarations in the
	    <code class="filename">sys/socket.h</code> refer to it as
	    <code class="varname">struct sockaddr</code>.  This structure is
	    declared in the same file:</p><pre class="programlisting">/*
 * Structure used by kernel to store most
 * addresses.
 */
struct sockaddr {
	unsigned char	sa_len;		/* total length */
	sa_family_t	sa_family;	/* address family */
	char		sa_data[14];	/* actually longer; address value */
};
#define	SOCK_MAXADDRLEN	255		/* longest possible addresses */</pre><p>Please note the <span class="emphasis"><em>vagueness</em></span> with
	    which the <code class="varname">sa_data</code> field is declared,
	    just as an array of <code class="constant">14</code> bytes, with
	    the comment hinting there can be more than
	    <code class="constant">14</code> of them.</p><p>This vagueness is quite deliberate.  Sockets is a very
	    powerful interface.  While most people perhaps think of it
	    as nothing more than the Internet interface&#8212;and most
	    applications probably use it for that
	    nowadays&#8212;sockets can be used for just about
	    <span class="emphasis"><em>any</em></span> kind of interprocess
	    communications, of which the Internet (or, more precisely,
	    <acronym class="acronym">IP</acronym>) is only one.</p><p>The <code class="filename">sys/socket.h</code> refers to the
	    various types of protocols sockets will handle as
	    <span class="emphasis"><em>address families</em></span>, and lists them
	    right before the definition of
	    <code class="varname">sockaddr</code>:</p><pre class="programlisting">/*
 * Address families.
 */
#define	AF_UNSPEC	0		/* unspecified */
#define	AF_LOCAL	1		/* local to host (pipes, portals) */
#define	AF_UNIX		AF_LOCAL	/* backward compatibility */
#define	AF_INET		2		/* internetwork: UDP, TCP, etc. */
#define	AF_IMPLINK	3		/* arpanet imp addresses */
#define	AF_PUP		4		/* pup protocols: e.g. BSP */
#define	AF_CHAOS	5		/* mit CHAOS protocols */
#define	AF_NS		6		/* XEROX NS protocols */
#define	AF_ISO		7		/* ISO protocols */
#define	AF_OSI		AF_ISO
#define	AF_ECMA		8		/* European computer manufacturers */
#define	AF_DATAKIT	9		/* datakit protocols */
#define	AF_CCITT	10		/* CCITT protocols, X.25 etc */
#define	AF_SNA		11		/* IBM SNA */
#define AF_DECnet	12		/* DECnet */
#define AF_DLI		13		/* DEC Direct data link interface */
#define AF_LAT		14		/* LAT */
#define	AF_HYLINK	15		/* NSC Hyperchannel */
#define	AF_APPLETALK	16		/* Apple Talk */
#define	AF_ROUTE	17		/* Internal Routing Protocol */
#define	AF_LINK		18		/* Link layer interface */
#define	pseudo_AF_XTP	19		/* eXpress Transfer Protocol (no AF) */
#define	AF_COIP		20		/* connection-oriented IP, aka ST II */
#define	AF_CNT		21		/* Computer Network Technology */
#define pseudo_AF_RTIP	22		/* Help Identify RTIP packets */
#define	AF_IPX		23		/* Novell Internet Protocol */
#define	AF_SIP		24		/* Simple Internet Protocol */
#define	pseudo_AF_PIP	25		/* Help Identify PIP packets */
#define	AF_ISDN		26		/* Integrated Services Digital Network*/
#define	AF_E164		AF_ISDN		/* CCITT E.164 recommendation */
#define	pseudo_AF_KEY	27		/* Internal key-management function */
#define	AF_INET6	28		/* IPv6 */
#define	AF_NATM		29		/* native ATM access */
#define	AF_ATM		30		/* ATM */
#define pseudo_AF_HDRCMPLT 31		/* Used by BPF to not rewrite headers
					 * in interface output routine
					 */
#define	AF_NETGRAPH	32		/* Netgraph sockets */
#define	AF_SLOW		33		/* 802.3ad slow protocol */
#define	AF_SCLUSTER	34		/* Sitara cluster protocol */
#define	AF_ARP		35
#define	AF_BLUETOOTH	36		/* Bluetooth sockets */
#define	AF_MAX		37</pre><p>The one used for <acronym class="acronym">IP</acronym> is
	    <span class="symbol">AF_INET</span>.  It is a symbol for the constant
	    <code class="constant">2</code>.</p><p>It is the <span class="emphasis"><em>address family</em></span> listed
	    in the <code class="varname">sa_family</code> field of
	    <code class="varname">sockaddr</code> that decides how exactly the
	    vaguely named bytes of <code class="varname">sa_data</code> will be
	    used.</p><p>Specifically, whenever the <span class="emphasis"><em>address
	      family</em></span> is <span class="symbol">AF_INET</span>, we can
	    use <code class="varname">struct sockaddr_in</code> found in
	    <code class="filename">netinet/in.h</code>, wherever
	    <code class="varname">sockaddr</code> is expected:</p><pre class="programlisting">/*
 * Socket address, internet style.
 */
struct sockaddr_in {
	uint8_t		sin_len;
	sa_family_t	sin_family;
	in_port_t	sin_port;
	struct	in_addr sin_addr;
	char	sin_zero[8];
};</pre><p>We can visualize its organization this way:</p><div class="mediaobject"><img src="sockets/sain.png" alt="sockaddr_in" /></div><p>The three important fields are
	    <code class="varname">sin_family</code>, which is byte 1 of the
	    structure, <code class="varname">sin_port</code>, a 16-bit value
	    found in bytes 2 and 3, and <code class="varname">sin_addr</code>, a
	    32-bit integer representation of the <acronym class="acronym">IP</acronym>
	    address, stored in bytes 4-7.</p><p>Now, let us try to fill it out.  Let us assume we are
	    trying to write a client for the
	    <span class="emphasis"><em>daytime</em></span> protocol, which simply states
	    that its server will write a text string representing the
	    current date and time to port 13.  We want to use
	    <acronym class="acronym">TCP/IP</acronym>, so we need to specify
	    <code class="constant">AF_INET</code> in the address family field.
	    <code class="constant">AF_INET</code> is defined as
	    <code class="constant">2</code>.  Let us use the
	    <acronym class="acronym">IP</acronym> address of <code class="systemitem">192.43.244.18</code>, which is
	    the time server of US federal government (<code class="systemitem">time.nist.gov</code>).</p><div class="mediaobject"><img src="sockets/sainfill.png" alt="Specific example of sockaddr_in" /></div><p>By the way the <code class="varname">sin_addr</code> field is
	    declared as being of the <code class="varname">struct in_addr</code>
	    type, which is defined in
	    <code class="filename">netinet/in.h</code>:</p><pre class="programlisting">/*
 * Internet address (a structure for historical reasons)
 */
struct in_addr {
	in_addr_t s_addr;
};</pre><p>In addition, <code class="varname">in_addr_t</code> is a 32-bit
	    integer.</p><p>The <code class="systemitem">192.43.244.18</code> is just a
	    convenient notation of expressing a 32-bit integer by
	    listing all of its 8-bit bytes, starting with the
	    <span class="emphasis"><em>most significant</em></span> one.</p><p>So far, we have viewed <code class="varname">sockaddr</code> as
	    an abstraction.  Our computer does not store
	    <code class="varname">short</code> integers as a single 16-bit
	    entity, but as a sequence of 2 bytes.  Similarly, it
	    stores 32-bit integers as a sequence of 4 bytes.</p><p>Suppose we coded something like this:</p><pre class="programlisting">sa.sin_family      = AF_INET;
sa.sin_port        = 13;
sa.sin_addr.s_addr = (((((192 &lt;&lt; 8) | 43) &lt;&lt; 8) | 244) &lt;&lt; 8) | 18;</pre><p>What would the result look like?</p><p>Well, that depends, of course.  On a <span class="trademark">Pentium</span>®, or
	    other x86, based computer, it would look like this:</p><div class="mediaobject"><img src="sockets/sainlsb.png" alt="sockaddr_in on an Intel system" /></div><p>On a different system, it might look like this:</p><div class="mediaobject"><img src="sockets/sainmsb.png" alt="sockaddr_in on an MSB system" /></div><p>And on a PDP it might look different yet.  But the
	    above two are the most common ways in use today.</p><p>Ordinarily, wanting to write portable code,
	    programmers pretend that these differences do not exist.
	    And they get away with it (except when they code in
	    assembly language).  Alas, you cannot get away with it
	    that easily when coding for sockets.</p><p>Why?</p><p>Because when communicating with another computer, you
	    usually do not know whether it stores data <span class="emphasis"><em>most
	    significant byte</em></span> (<acronym class="acronym">MSB</acronym>) or
	    <span class="emphasis"><em>least significant byte</em></span>
	    (<acronym class="acronym">LSB</acronym>) first.</p><p>You might be wondering, <span class="emphasis"><em><span class="quote">&#8220;<span class="quote">So, will
		sockets not handle it for
		me?</span>&#8221;</span></em></span></p><p>It will not.</p><p>While that answer may surprise you at first, remember
	    that the general sockets interface only understands the
	    <code class="varname">sa_len</code> and <code class="varname">sa_family</code>
	    fields of the <code class="varname">sockaddr</code> structure.  You
	    do not have to worry about the byte order there (of
	    course, on FreeBSD <code class="varname">sa_family</code> is only 1
	    byte anyway, but many other <span class="trademark">UNIX</span>® systems do not have
	    <code class="varname">sa_len</code> and use 2 bytes for
	    <code class="varname">sa_family</code>, and expect the data in
	    whatever order is native to the computer).</p><p>But the rest of the data is just
	    <code class="varname">sa_data[14]</code> as far as sockets goes.
	    Depending on the <span class="emphasis"><em>address family</em></span>,
	    sockets just forwards that data to its destination.</p><p>Indeed, when we enter a port number, it is because we
	    want the other computer to know what service we are asking
	    for.  And, when we are the server, we read the port number
	    so we know what service the other computer is expecting
	    from us.  Either way, sockets only has to forward the port
	    number as data.  It does not interpret it in any
	    way.</p><p>Similarly, we enter the <acronym class="acronym">IP</acronym> address
	    to tell everyone on the way where to send our data to.
	    Sockets, again, only forwards it as data.</p><p>That is why, we (the <span class="emphasis"><em>programmers</em></span>,
	    not the <span class="emphasis"><em>sockets</em></span>) have to distinguish
	    between the byte order used by our computer and a
	    conventional byte order to send the data in to the other
	    computer.</p><p>We will call the byte order our computer uses the
	    <span class="emphasis"><em>host byte order</em></span>, or just the
	    <span class="emphasis"><em>host order</em></span>.</p><p>There is a convention of sending the multi-byte data
	    over <acronym class="acronym">IP</acronym>
	    <span class="emphasis"><em><acronym class="acronym">MSB</acronym> first</em></span>.  This,
	    we will refer to as the <span class="emphasis"><em>network byte
	      order</em></span>, or simply the <span class="emphasis"><em>network
	      order</em></span>.</p><p>Now, if we compiled the above code for an Intel based
	    computer, our <span class="emphasis"><em>host byte order</em></span> would
	    produce:</p><div class="mediaobject"><img src="sockets/sainlsb.png" alt="Host byte order on an Intel system" /></div><p>But the <span class="emphasis"><em>network byte order</em></span>
	    requires that we store the data <acronym class="acronym">MSB</acronym>
	    first:</p><div class="mediaobject"><img src="sockets/sainmsb.png" alt="Network byte order" /></div><p>Unfortunately, our <span class="emphasis"><em>host order</em></span> is
	    the exact opposite of the <span class="emphasis"><em>network
	      order</em></span>.</p><p>We have several ways of dealing with it.  One would be
	    to <span class="emphasis"><em>reverse</em></span> the values in our
	    code:</p><pre class="programlisting">sa.sin_family      = AF_INET;
sa.sin_port        = 13 &lt;&lt; 8;
sa.sin_addr.s_addr = (((((18 &lt;&lt; 8) | 244) &lt;&lt; 8) | 43) &lt;&lt; 8) | 192;</pre><p>This will <span class="emphasis"><em>trick</em></span> our compiler into
	    storing the data in the <span class="emphasis"><em>network byte
	      order</em></span>.  In some cases, this is exactly the
	    way to do it (e.g., when programming in assembly
	    language).  In most cases, however, it can cause a
	    problem.</p><p>Suppose, you wrote a sockets-based program in C.  You
	    know it is going to run on a <span class="trademark">Pentium</span>®, so you enter all
	    your constants in reverse and force them to the
	    <span class="emphasis"><em>network byte order</em></span>.  It works
	    well.</p><p>Then, some day, your trusted old <span class="trademark">Pentium</span>® becomes a
	    rusty old <span class="trademark">Pentium</span>®.  You replace it with a system whose
	    <span class="emphasis"><em>host order</em></span> is the same as the
	    <span class="emphasis"><em>network order</em></span>.  You need to recompile
	    all your software.  All of your software continues to
	    perform well, except the one program you wrote.</p><p>You have since forgotten that you had forced all of
	    your constants to the opposite of the <span class="emphasis"><em>host
	      order</em></span>.  You spend some quality time tearing
	    out your hair, calling the names of all gods you ever
	    heard of (and some you made up), hitting your monitor with
	    a nerf bat, and performing all the other traditional
	    ceremonies of trying to figure out why something that has
	    worked so well is suddenly not working at all.</p><p>Eventually, you figure it out, say a couple of swear
	    words, and start rewriting your code.</p><p>Luckily, you are not the first one to face the
	    problem.  Someone else has created the <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=htons&amp;sektion=3&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">htons</span>(3)</span></a> and
	    <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=htonl&amp;sektion=3&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">htonl</span>(3)</span></a> C functions to convert a
	    <code class="varname">short</code> and <code class="varname">long</code>
	    respectively from the <span class="emphasis"><em>host byte order</em></span>
	    to the <span class="emphasis"><em>network byte order</em></span>, and the
	    <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=ntohs&amp;sektion=3&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">ntohs</span>(3)</span></a> and <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=ntohl&amp;sektion=3&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">ntohl</span>(3)</span></a> C functions to go the
	    other way.</p><p>On <span class="emphasis"><em><acronym class="acronym">MSB</acronym>-first</em></span>
	    systems these functions do nothing.  On
	    <span class="emphasis"><em><acronym class="acronym">LSB</acronym>-first</em></span> systems
	    they convert values to the proper order.</p><p>So, regardless of what system your software is
	    compiled on, your data will end up in the correct order if
	    you use these functions.</p></div></div><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="sockets-client-functions"></a>7.5.1.2. Client Functions</h4></div></div></div><p>Typically, the client initiates the connection to the
	  server.  The client knows which server it is about to call:
	  It knows its <acronym class="acronym">IP</acronym> address, and it knows the
	  <span class="emphasis"><em>port</em></span> the server resides at.  It is akin
	  to you picking up the phone and dialing the number (the
	  <span class="emphasis"><em>address</em></span>), then, after someone answers,
	  asking for the person in charge of wingdings (the
	  <span class="emphasis"><em>port</em></span>).</p><div class="sect4"><div xmlns="" class="titlepage"><div><div><h5 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="sockets-connect"></a>7.5.1.2.1. <code class="function">connect</code></h5></div></div></div><p>Once a client has created a socket, it needs to
	    connect it to a specific port on a remote system.  It uses
	    <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=connect&amp;sektion=2&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">connect</span>(2)</span></a>:</p><pre class="programlisting">int connect(int s, const struct sockaddr *name, socklen_t namelen);</pre><p>The <code class="varname">s</code> argument is the socket, i.e.,
	    the value returned by the <code class="function">socket</code>
	    function.  The <code class="varname">name</code> is a pointer to
	    <code class="varname">sockaddr</code>, the structure we have talked
	    about extensively.  Finally, <code class="varname">namelen</code>
	    informs the system how many bytes are in our
	    <code class="varname">sockaddr</code> structure.</p><p>If <code class="function">connect</code> is successful, it
	    returns <code class="constant">0</code>.  Otherwise it returns
	    <code class="constant">-1</code> and stores the error code in
	    <code class="varname">errno</code>.</p><p>There are many reasons why
	    <code class="function">connect</code> may fail.  For example, with
	    an attempt to an Internet connection, the
	    <acronym class="acronym">IP</acronym> address may not exist, or it may be
	    down, or just too busy, or it may not have a server
	    listening at the specified port.  Or it may outright
	    <span class="emphasis"><em>refuse</em></span> any request for specific
	    code.</p></div><div class="sect4"><div xmlns="" class="titlepage"><div><div><h5 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="sockets-first-client"></a>7.5.1.2.2. Our First Client</h5></div></div></div><p>We now know enough to write a very simple client, one
	    that will get current time from <code class="systemitem">192.43.244.18</code> and print
	    it to <code class="filename">stdout</code>.</p><pre class="programlisting">/*
 * daytime.c
 *
 * Programmed by G. Adam Stanislav
 */
#include &lt;stdio.h&gt;
#include &lt;string.h&gt;
#include &lt;sys/types.h&gt;
#include &lt;sys/socket.h&gt;
#include &lt;netinet/in.h&gt;

int main() {
  register int s;
  register int bytes;
  struct sockaddr_in sa;
  char buffer[BUFSIZ+1];

  if ((s = socket(PF_INET, SOCK_STREAM, 0)) &lt; 0) {
    perror("socket");
    return 1;
  }

  bzero(&amp;sa, sizeof sa);

  sa.sin_family = AF_INET;
  sa.sin_port = htons(13);
  sa.sin_addr.s_addr = htonl((((((192 &lt;&lt; 8) | 43) &lt;&lt; 8) | 244) &lt;&lt; 8) | 18);
  if (connect(s, (struct sockaddr *)&amp;sa, sizeof sa) &lt; 0) {
    perror("connect");
    close(s);
    return 2;
  }

  while ((bytes = read(s, buffer, BUFSIZ)) &gt; 0)
    write(1, buffer, bytes);

  close(s);
  return 0;
}</pre><p>Go ahead, enter it in your editor, save it as
	    <code class="filename">daytime.c</code>, then compile and run
	    it:</p><pre class="screen"><code class="prompt">%</code> <strong class="userinput"><code>cc -O3 -o daytime daytime.c</code></strong>
<code class="prompt">%</code> <strong class="userinput"><code>./daytime</code></strong>

52079 01-06-19 02:29:25 50 0 1 543.9 UTC(NIST) *
<code class="prompt">%</code></pre><p>In this case, the date was June 19, 2001, the time was
	    02:29:25 <acronym class="acronym">UTC</acronym>.  Naturally, your results
	    will vary.</p></div></div><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="sockets-server-functions"></a>7.5.1.3. Server Functions</h4></div></div></div><p>The typical server does not initiate the connection.
	  Instead, it waits for a client to call it and request
	  services.  It does not know when the client will call, nor
	  how many clients will call.  It may be just sitting there,
	  waiting patiently, one moment, The next moment, it can find
	  itself swamped with requests from a number of clients, all
	  calling in at the same time.</p><p>The sockets interface offers three basic functions to
	  handle this.</p><div class="sect4"><div xmlns="" class="titlepage"><div><div><h5 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="sockets-bind"></a>7.5.1.3.1. <code class="function">bind</code></h5></div></div></div><p>Ports are like extensions to a phone line: After you
	    dial a number, you dial the extension to get to a specific
	    person or department.</p><p>There are 65535 <acronym class="acronym">IP</acronym> ports, but a
	    server usually processes requests that come in on only one
	    of them.  It is like telling the phone room operator that
	    we are now at work and available to answer the phone at a
	    specific extension.  We use <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=bind&amp;sektion=2&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">bind</span>(2)</span></a> to tell sockets
	    which port we want to serve.</p><pre class="programlisting">int bind(int s, const struct sockaddr *addr, socklen_t addrlen);</pre><p>Beside specifying the port in <code class="varname">addr</code>,
	    the server may include its <acronym class="acronym">IP</acronym> address.
	    However, it can just use the symbolic constant
	    <span class="symbol">INADDR_ANY</span> to indicate it will serve all
	    requests to the specified port regardless of what its
	    <acronym class="acronym">IP</acronym> address is.  This symbol, along with
	    several similar ones, is declared in
	    <code class="filename">netinet/in.h</code></p><pre class="programlisting">#define	INADDR_ANY		(u_int32_t)0x00000000</pre><p>Suppose we were writing a server for the
	    <span class="emphasis"><em>daytime</em></span> protocol over
	    <acronym class="acronym">TCP</acronym>/<acronym class="acronym">IP</acronym>.  Recall that
	    it uses port 13.  Our <code class="varname">sockaddr_in</code>
	    structure would look like this:</p><div class="mediaobject"><img src="sockets/sainserv.png" alt="Example Server sockaddr_in" /></div></div><div class="sect4"><div xmlns="" class="titlepage"><div><div><h5 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="sockets-listen"></a>7.5.1.3.2. <code class="function">listen</code></h5></div></div></div><p>To continue our office phone analogy, after you have
	    told the phone central operator what extension you will be
	    at, you now walk into your office, and make sure your own
	    phone is plugged in and the ringer is turned on.  Plus,
	    you make sure your call waiting is activated, so you can
	    hear the phone ring even while you are talking to
	    someone.</p><p>The server ensures all of that with the <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=listen&amp;sektion=2&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">listen</span>(2)</span></a>
	    function.</p><pre class="programlisting">int listen(int s, int backlog);</pre><p>In here, the <code class="varname">backlog</code> variable tells
	    sockets how many incoming requests to accept while you are
	    busy processing the last request.  In other words, it
	    determines the maximum size of the queue of pending
	    connections.</p></div><div class="sect4"><div xmlns="" class="titlepage"><div><div><h5 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="sockets-accept"></a>7.5.1.3.3. <code class="function">accept</code></h5></div></div></div><p>After you hear the phone ringing, you accept the call
	    by answering the call.  You have now established a
	    connection with your client.  This connection remains
	    active until either you or your client hang up.</p><p>The server accepts the connection by using the
	    <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=accept&amp;sektion=2&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">accept</span>(2)</span></a> function.</p><pre class="programlisting">int accept(int s, struct sockaddr *addr, socklen_t *addrlen);</pre><p>Note that this time <code class="varname">addrlen</code> is a
	    pointer.  This is necessary because in this case it is the
	    socket that fills out <code class="varname">addr</code>, the
	    <code class="varname">sockaddr_in</code> structure.</p><p>The return value is an integer.  Indeed, the
	    <code class="function">accept</code> returns a <span class="emphasis"><em>new
	      socket</em></span>.  You will use this new socket to
	    communicate with the client.</p><p>What happens to the old socket? It continues to listen
	    for more requests (remember the <code class="varname">backlog</code>
	    variable we passed to <code class="function">listen</code>?) until
	    we <code class="function">close</code> it.</p><p>Now, the new socket is meant only for communications.
	    It is fully connected.  We cannot pass it to
	    <code class="function">listen</code> again, trying to accept
	    additional connections.</p></div><div class="sect4"><div xmlns="" class="titlepage"><div><div><h5 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="sockets-first-server"></a>7.5.1.3.4. Our First Server</h5></div></div></div><p>Our first server will be somewhat more complex than
	    our first client was: Not only do we have more sockets
	    functions to use, but we need to write it as a
	    daemon.</p><p>This is best achieved by creating a <span class="emphasis"><em>child
	      process</em></span> after binding the port.  The main
	    process then exits and returns control to the
	    <span class="application">shell</span> (or whatever program
	    invoked it).</p><p>The child calls <code class="function">listen</code>, then
	    starts an endless loop, which accepts a connection, serves
	    it, and eventually closes its socket.</p><pre class="programlisting">/*
 * daytimed - a port 13 server
 *
 * Programmed by G. Adam Stanislav
 * June 19, 2001
 */
#include &lt;stdio.h&gt;
#include &lt;string.h&gt;
#include &lt;time.h&gt;
#include &lt;unistd.h&gt;
#include &lt;sys/types.h&gt;
#include &lt;sys/socket.h&gt;
#include &lt;netinet/in.h&gt;

#define BACKLOG 4

int main() {
    register int s, c;
    int b;
    struct sockaddr_in sa;
    time_t t;
    struct tm *tm;
    FILE *client;

    if ((s = socket(PF_INET, SOCK_STREAM, 0)) &lt; 0) {
        perror("socket");
        return 1;
    }

    bzero(&amp;sa, sizeof sa);

    sa.sin_family = AF_INET;
    sa.sin_port   = htons(13);

    if (INADDR_ANY)
        sa.sin_addr.s_addr = htonl(INADDR_ANY);

    if (bind(s, (struct sockaddr *)&amp;sa, sizeof sa) &lt; 0) {
        perror("bind");
        return 2;
    }

    switch (fork()) {
        case -1:
            perror("fork");
            return 3;
            break;
        default:
            close(s);
            return 0;
            break;
        case 0:
            break;
    }

    listen(s, BACKLOG);

    for (;;) {
        b = sizeof sa;

        if ((c = accept(s, (struct sockaddr *)&amp;sa, &amp;b)) &lt; 0) {
            perror("daytimed accept");
            return 4;
        }

        if ((client = fdopen(c, "w")) == NULL) {
            perror("daytimed fdopen");
            return 5;
        }

        if ((t = time(NULL)) &lt; 0) {
            perror("daytimed time");

            return 6;
        }

        tm = gmtime(&amp;t);
        fprintf(client, "%.4i-%.2i-%.2iT%.2i:%.2i:%.2iZ\n",
            tm-&gt;tm_year + 1900,
            tm-&gt;tm_mon + 1,
            tm-&gt;tm_mday,
            tm-&gt;tm_hour,
            tm-&gt;tm_min,
            tm-&gt;tm_sec);

        fclose(client);
    }
}</pre><p>We start by creating a socket.  Then we fill out the
	    <code class="varname">sockaddr_in</code> structure in
	    <code class="varname">sa</code>.  Note the conditional use of
	    <span class="symbol">INADDR_ANY</span>:</p><pre class="programlisting">if (INADDR_ANY)
        sa.sin_addr.s_addr = htonl(INADDR_ANY);</pre><p>Its value is <code class="constant">0</code>.  Since we have
	    just used <code class="function">bzero</code> on the entire
	    structure, it would be redundant to set it to
	    <code class="constant">0</code> again.  But if we port our code to
	    some other system where <span class="symbol">INADDR_ANY</span> is
	    perhaps not a zero, we need to assign it to
	    <code class="varname">sa.sin_addr.s_addr</code>.  Most modern C
	    compilers are clever enough to notice that
	    <span class="symbol">INADDR_ANY</span> is a constant.  As long as it
	    is a zero, they will optimize the entire conditional
	    statement out of the code.</p><p>After we have called <code class="function">bind</code>
	    successfully, we are ready to become a
	    <span class="emphasis"><em>daemon</em></span>: We use
	    <code class="function">fork</code> to create a child process.  In
	    both, the parent and the child, the <code class="varname">s</code>
	    variable is our socket.  The parent process will not need
	    it, so it calls <code class="function">close</code>, then it
	    returns <code class="constant">0</code> to inform its own parent it
	    had terminated successfully.</p><p>Meanwhile, the child process continues working in the
	    background.  It calls <code class="function">listen</code> and sets
	    its backlog to <code class="constant">4</code>.  It does not need a
	    large value here because <span class="emphasis"><em>daytime</em></span> is
	    not a protocol many clients request all the time, and
	    because it can process each request instantly
	    anyway.</p><p>Finally, the daemon starts an endless loop, which
	    performs the following steps:</p><div class="procedure"><ol class="procedure" type="1"><li class="step"><p>Call <code class="function">accept</code>.  It waits here
		until a client contacts it.  At that point, it
		receives a new socket, <code class="varname">c</code>, which it
		can use to communicate with this particular
		client.</p></li><li class="step"><p>It uses the C function <code class="function">fdopen</code>
		to turn the socket from a low-level <span class="emphasis"><em>file
		  descriptor</em></span> to a C-style
		<code class="varname">FILE</code> pointer.  This will allow the
		use of <code class="function">fprintf</code> later
		on.</p></li><li class="step"><p>It checks the time, and prints it in the
		<span class="emphasis"><em><acronym class="acronym">ISO</acronym> 8601</em></span>
		format to the <code class="varname">client</code>
		<span class="quote">&#8220;<span class="quote">file</span>&#8221;</span>.  It then uses
		<code class="function">fclose</code> to close the file.  That
		will automatically close the socket as
		well.</p></li></ol></div><p>We can <span class="emphasis"><em>generalize</em></span> this, and use
	    it as a model for many other servers:</p><div class="mediaobject"><img src="sockets/serv.png" alt="Sequential Server" /></div><p>This flowchart is good for <span class="emphasis"><em>sequential
	      servers</em></span>, i.e., servers that can serve one
	    client at a time, just as we were able to with our
	    <span class="emphasis"><em>daytime</em></span> server.  This is only
	    possible whenever there is no real
	    <span class="quote">&#8220;<span class="quote">conversation</span>&#8221;</span> going on between the client
	    and the server: As soon as the server detects a connection
	    to the client, it sends out some data and closes the
	    connection.  The entire operation may take nanoseconds,
	    and it is finished.</p><p>The advantage of this flowchart is that, except for
	    the brief moment after the parent
	    <code class="function">fork</code>s and before it exits, there is
	    always only one <span class="emphasis"><em>process</em></span> active: Our
	    server does not take up much memory and other system
	    resources.</p><p>Note that we have added <span class="emphasis"><em>initialize
	      daemon</em></span> in our flowchart.  We did not need to
	    initialize our own daemon, but this is a good place in the
	    flow of the program to set up any
	    <code class="function">signal</code> handlers, open any files we
	    may need, etc.</p><p>Just about everything in the flow chart can be used
	    literally on many different servers.  The
	    <span class="emphasis"><em>serve</em></span> entry is the exception.  We
	    think of it as a <span class="emphasis"><em><span class="quote">&#8220;<span class="quote">black
		box</span>&#8221;</span></em></span>, i.e., something you design
	    specifically for your own server, and just <span class="quote">&#8220;<span class="quote">plug it
	      into the rest.</span>&#8221;</span></p><p>Not all protocols are that simple.  Many receive a
	    request from the client, reply to it, then receive another
	    request from the same client.  Because of that, they do
	    not know in advance how long they will be serving the
	    client.  Such servers usually start a new process for each
	    client.  While the new process is serving its client, the
	    daemon can continue listening for more connections.</p><p>Now, go ahead, save the above source code as
	    <code class="filename">daytimed.c</code> (it is customary to end
	    the names of daemons with the letter
	    <code class="constant">d</code>).  After you have compiled it, try
	    running it:</p><pre class="screen"><code class="prompt">%</code> <strong class="userinput"><code>./daytimed</code></strong>
bind: Permission denied
<code class="prompt">%</code></pre><p>What happened here? As you will recall, the
	    <span class="emphasis"><em>daytime</em></span> protocol uses port 13.  But
	    all ports below 1024 are reserved to the superuser
	    (otherwise, anyone could start a daemon pretending to
	    serve a commonly used port, while causing a security
	    breach).</p><p>Try again, this time as the superuser:</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>./daytimed</code></strong>
<code class="prompt">#</code></pre><p>What... Nothing? Let us try again:</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>./daytimed</code></strong>

bind: Address already in use
<code class="prompt">#</code></pre><p>Every port can only be bound by one program at a time.
	    Our first attempt was indeed successful: It started the
	    child daemon and returned quietly.  It is still running
	    and will continue to run until you either kill it, or any
	    of its system calls fail, or you reboot the system.</p><p>Fine, we know it is running in the background.  But is
	    it working?  How do we know it is a proper
	    <span class="emphasis"><em>daytime</em></span> server?  Simple:</p><pre class="screen"><code class="prompt">%</code> <strong class="userinput"><code>telnet localhost 13</code></strong>

Trying ::1...
telnet: connect to address ::1: Connection refused
Trying 127.0.0.1...
Connected to localhost.
Escape character is '^]'.
2001-06-19T21:04:42Z
Connection closed by foreign host.
<code class="prompt">%</code></pre><p><span class="application">telnet</span> tried the new
	    <acronym class="acronym">IP</acronym>v6, and failed.  It retried with
	    <acronym class="acronym">IP</acronym>v4 and succeeded.  The daemon
	    works.</p><p>If you have access to another <span class="trademark">UNIX</span>® system via
	    <span class="application">telnet</span>, you can use it to test
	    accessing the server remotely.  My computer does not have
	    a static <acronym class="acronym">IP</acronym> address, so this is what I
	    did:</p><pre class="screen"><code class="prompt">%</code> <strong class="userinput"><code>who</code></strong>

whizkid          ttyp0   Jun 19 16:59   (216.127.220.143)
xxx              ttyp1   Jun 19 16:06   (xx.xx.xx.xx)
<code class="prompt">%</code> <strong class="userinput"><code>telnet 216.127.220.143 13</code></strong>

Trying 216.127.220.143...
Connected to r47.bfm.org.
Escape character is '^]'.
2001-06-19T21:31:11Z
Connection closed by foreign host.
<code class="prompt">%</code></pre><p>Again, it worked.  Will it work using the domain
	    name?</p><pre class="screen"><code class="prompt">%</code> <strong class="userinput"><code>telnet r47.bfm.org 13</code></strong>

Trying 216.127.220.143...
Connected to r47.bfm.org.
Escape character is '^]'.
2001-06-19T21:31:40Z
Connection closed by foreign host.
<code class="prompt">%</code></pre><p>By the way, <span class="application">telnet</span> prints
	    the <span class="emphasis"><em>Connection closed by foreign host</em></span>
	    message after our daemon has closed the socket.  This
	    shows us that, indeed, using
	    <code class="function">fclose(client);</code> in our code works as
	    advertised.</p></div></div></div></div><div class="sect1"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="sockets-helper-functions"></a>7.6. Helper Functions</h2></div></div></div><p>FreeBSD C library contains many helper functions for sockets
      programming.  For example, in our sample client we hard coded
      the <code class="systemitem">time.nist.gov</code>
      <acronym class="acronym">IP</acronym> address.  But we do not always know the
      <acronym class="acronym">IP</acronym> address.  Even if we do, our software is
      more flexible if it allows the user to enter the
      <acronym class="acronym">IP</acronym> address, or even the domain name.</p><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="sockets-gethostbyname"></a>7.6.1. <code class="function">gethostbyname</code></h3></div></div></div><p>While there is no way to pass the domain name directly to
	any of the sockets functions, the FreeBSD C library comes with
	the <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=gethostbyname&amp;sektion=3&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">gethostbyname</span>(3)</span></a> and <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=gethostbyname2&amp;sektion=3&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">gethostbyname2</span>(3)</span></a>
	functions, declared in <code class="filename">netdb.h</code>.</p><pre class="programlisting">struct hostent * gethostbyname(const char *name);
struct hostent * gethostbyname2(const char *name, int af);</pre><p>Both return a pointer to the <code class="varname">hostent</code>
	structure, with much information about the domain.  For our
	purposes, the <code class="varname">h_addr_list[0]</code> field of the
	structure points at <code class="varname">h_length</code> bytes of the
	correct address, already stored in the <span class="emphasis"><em>network byte
	  order</em></span>.</p><p>This allows us to create a much more flexible&#8212;and
	much more useful&#8212;version of our
	<span class="application">daytime</span> program:</p><pre class="programlisting">/*
 * daytime.c
 *
 * Programmed by G. Adam Stanislav
 * 19 June 2001
 */
#include &lt;stdio.h&gt;
#include &lt;string.h&gt;
#include &lt;sys/types.h&gt;
#include &lt;sys/socket.h&gt;
#include &lt;netinet/in.h&gt;
#include &lt;netdb.h&gt;

int main(int argc, char *argv[]) {
  register int s;
  register int bytes;
  struct sockaddr_in sa;
  struct hostent *he;
  char buf[BUFSIZ+1];
  char *host;

  if ((s = socket(PF_INET, SOCK_STREAM, 0)) &lt; 0) {
    perror("socket");
    return 1;
  }

  bzero(&amp;sa, sizeof sa);

  sa.sin_family = AF_INET;
  sa.sin_port = htons(13);

  host = (argc &gt; 1) ? (char *)argv[1] : "time.nist.gov";

  if ((he = gethostbyname(host)) == NULL) {
    herror(host);
    return 2;
  }

  bcopy(he-&gt;h_addr_list[0],&amp;sa.sin_addr, he-&gt;h_length);

  if (connect(s, (struct sockaddr *)&amp;sa, sizeof sa) &lt; 0) {
    perror("connect");
    return 3;
  }

  while ((bytes = read(s, buf, BUFSIZ)) &gt; 0)
    write(1, buf, bytes);

  close(s);
  return 0;
}</pre><p>We now can type a domain name (or an <acronym class="acronym">IP</acronym>
	address, it works both ways) on the command line, and the
	program will try to connect to its
	<span class="emphasis"><em>daytime</em></span> server.  Otherwise, it will still
	default to <code class="systemitem">time.nist.gov</code>.  However,
	even in this case we will use
	<code class="function">gethostbyname</code> rather than hard coding
	<code class="systemitem">192.43.244.18</code>.
	That way, even if its <acronym class="acronym">IP</acronym> address changes in
	the future, we will still find it.</p><p>Since it takes virtually no time to get the time from your
	local server, you could run <span class="application">daytime</span>
	twice in a row: First to get the time from <code class="systemitem">time.nist.gov</code>, the second
	time from your own system.  You can then compare the results
	and see how exact your system clock is:</p><pre class="screen"><code class="prompt">%</code> <strong class="userinput"><code>daytime ; daytime localhost</code></strong>


52080 01-06-20 04:02:33 50 0 0 390.2 UTC(NIST) *
2001-06-20T04:02:35Z
<code class="prompt">%</code></pre><p>As you can see, my system was two seconds ahead of the
	<acronym class="acronym">NIST</acronym> time.</p></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="sockets-getservbyname"></a>7.6.2. <code class="function">getservbyname</code></h3></div></div></div><p>Sometimes you may not be sure what port a certain service
	uses.  The <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=getservbyname&amp;sektion=3&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">getservbyname</span>(3)</span></a> function, also declared in
	<code class="filename">netdb.h</code> comes in very handy in those
	cases:</p><pre class="programlisting">struct servent * getservbyname(const char *name, const char *proto);</pre><p>The <code class="varname">servent</code> structure contains the
	<code class="varname">s_port</code>, which contains the proper port,
	already in <span class="emphasis"><em>network byte order</em></span>.</p><p>Had we not known the correct port for the
	<span class="emphasis"><em>daytime</em></span> service, we could have found it
	this way:</p><pre class="programlisting">struct servent *se;
  ...
  if ((se = getservbyname("daytime", "tcp")) == NULL {
    fprintf(stderr, "Cannot determine which port to use.\n");
    return 7;
  }
  sa.sin_port = se-&gt;s_port;</pre><p>You usually do know the port.  But if you are developing a
	new protocol, you may be testing it on an unofficial port.
	Some day, you will register the protocol and its port (if
	nowhere else, at least in your
	<code class="filename">/etc/services</code>, which is where
	<code class="function">getservbyname</code> looks).  Instead of
	returning an error in the above code, you just use the
	temporary port number.  Once you have listed the protocol in
	<code class="filename">/etc/services</code>, your software will find
	its port without you having to rewrite the code.</p></div></div><div class="sect1"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="sockets-concurrent-servers"></a>7.7. Concurrent Servers</h2></div></div></div><p>Unlike a sequential server, a <span class="emphasis"><em>concurrent
	server</em></span> has to be able to serve more than one client
      at a time.  For example, a <span class="emphasis"><em>chat server</em></span> may
      be serving a specific client for hours&#8212;it cannot wait till
      it stops serving a client before it serves the next one.</p><p>This requires a significant change in our flowchart:</p><div class="mediaobject"><img src="sockets/serv2.png" alt="Concurrent Server" /></div><p>We moved the <span class="emphasis"><em>serve</em></span> from the
      <span class="emphasis"><em>daemon process</em></span> to its own <span class="emphasis"><em>server
	process</em></span>.  However, because each child process
      inherits all open files (and a socket is treated just like a
      file), the new process inherits not only the
      <span class="emphasis"><em><span class="quote">&#8220;<span class="quote">accepted handle,</span>&#8221;</span></em></span> i.e., the
      socket returned by the <code class="function">accept</code> call, but
      also the <span class="emphasis"><em>top socket</em></span>, i.e., the one opened
      by the top process right at the beginning.</p><p>However, the <span class="emphasis"><em>server process</em></span> does not
      need this socket and should <code class="function">close</code> it
      immediately.  Similarly, the <span class="emphasis"><em>daemon process</em></span>
      no longer needs the <span class="emphasis"><em>accepted socket</em></span>, and
      not only should, but <span class="emphasis"><em>must</em></span>
      <code class="function">close</code> it&#8212;otherwise, it will run out
      of available <span class="emphasis"><em>file descriptors</em></span> sooner or
      later.</p><p>After the <span class="emphasis"><em>server process</em></span> is done
      serving, it should close the <span class="emphasis"><em>accepted
	socket</em></span>.  Instead of returning to
      <code class="function">accept</code>, it now exits.</p><p>Under <span class="trademark">UNIX</span>®, a process does not really
      <span class="emphasis"><em>exit</em></span>.  Instead, it
      <span class="emphasis"><em>returns</em></span> to its parent.  Typically, a parent
      process <code class="function">wait</code>s for its child process, and
      obtains a return value.  However, our <span class="emphasis"><em>daemon
	process</em></span> cannot simply stop and wait.  That would
      defeat the whole purpose of creating additional processes.  But
      if it never does <code class="function">wait</code>, its children will
      become <span class="emphasis"><em>zombies</em></span>&#8212;no longer functional
      but still roaming around.</p><p>For that reason, the <span class="emphasis"><em>daemon process</em></span>
      needs to set <span class="emphasis"><em>signal handlers</em></span> in its
      <span class="emphasis"><em>initialize daemon</em></span> phase.  At least a
      <span class="symbol">SIGCHLD</span> signal has to be processed, so the
      daemon can remove the zombie return values from the system and
      release the system resources they are taking up.</p><p>That is why our flowchart now contains a <span class="emphasis"><em>process
	signals</em></span> box, which is not connected to any other
      box.  By the way, many servers also process
      <span class="symbol">SIGHUP</span>, and typically interpret as the signal
      from the superuser that they should reread their configuration
      files.  This allows us to change settings without having to kill
      and restart these servers.</p></div></div><div class="chapter"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="ipv6"></a>Chapter 8. IPv6 Internals</h2></div></div></div><div class="toc"><div class="toc-title">Table of Contents</div><dl class="toc"><dt><span class="sect1"><a href="#ipv6-implementation">8.1. IPv6/IPsec Implementation</a></span></dt></dl></div><div class="sect1"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="ipv6-implementation"></a>8.1. IPv6/IPsec Implementation</h2></div><div><span class="authorgroup">Contributed by <span xmlns="http://www.w3.org/1999/xhtml" class="author"><span class="firstname">Yoshinobu</span> <span class="surname">Inoue</span></span>. </span></div></div></div><p>This section should explain IPv6 and IPsec related
      implementation internals.  These functionalities are derived
      from <a class="link" href="http://www.kame.net/" target="_top">KAME
	project</a></p><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="ipv6details"></a>8.1.1. IPv6</h3></div></div></div><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp50437752"></a>8.1.1.1. Conformance</h4></div></div></div><p>The IPv6 related functions conforms, or tries to conform
	  to the latest set of IPv6 specifications.  For future
	  reference we list some of the relevant documents below
	  (<span class="emphasis"><em>NOTE</em></span>: this is not a complete list -
	  this is too hard to maintain...).</p><p>For details please refer to specific chapter in the
	  document, RFCs, manual pages, or comments in the source
	  code.</p><p>Conformance tests have been performed on the KAME STABLE
	  kit at TAHI project.  Results can be viewed at <code class="uri"><a class="uri" href="http://www.tahi.org/report/KAME/" target="_top">http://www.tahi.org/report/KAME/</a></code>.
	  We also attended University of New Hampshire IOL tests (<code class="uri"><a class="uri" href="http://www.iol.unh.edu/" target="_top">http://www.iol.unh.edu/</a></code>)
	  in the past, with our past snapshots.</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>RFC1639: FTP Operation Over Big Address Records
	      (FOOBAR)</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><p>RFC2428 is preferred over RFC1639.  FTP clients
		  will first try RFC2428, then RFC1639 if
		  failed.</p></li></ul></div></li><li class="listitem"><p>RFC1886: DNS Extensions to support IPv6</p></li><li class="listitem"><p>RFC1933: Transition Mechanisms for IPv6 Hosts and
	      Routers</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><p>IPv4 compatible address is not supported.</p></li><li class="listitem"><p>automatic tunneling (described in 4.3 of this
		  RFC) is not supported.</p></li><li class="listitem"><p><a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=gif&amp;sektion=4&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">gif</span>(4)</span></a> interface implements
		  IPv[46]-over-IPv[46] tunnel in a generic way, and it
		  covers "configured tunnel" described in the spec.
		  See <a class="link" href="#gif" title="8.1.1.5. Generic Tunnel Interface">23.5.1.5</a> in this
		  document for details.</p></li></ul></div></li><li class="listitem"><p>RFC1981: Path MTU Discovery for IPv6</p></li><li class="listitem"><p>RFC2080: RIPng for IPv6</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><p>usr.sbin/route6d support this.</p></li></ul></div></li><li class="listitem"><p>RFC2292: Advanced Sockets API for IPv6</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><p>For supported library functions/kernel APIs, see
		  <code class="filename">sys/netinet6/ADVAPI</code>.</p></li></ul></div></li><li class="listitem"><p>RFC2362: Protocol Independent Multicast-Sparse Mode
	      (PIM-SM)</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><p>RFC2362 defines packet formats for PIM-SM.
		  <code class="filename">draft-ietf-pim-ipv6-01.txt</code> is
		  written based on this.</p></li></ul></div></li><li class="listitem"><p>RFC2373: IPv6 Addressing Architecture</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><p>supports node required addresses, and conforms
		  to the scope requirement.</p></li></ul></div></li><li class="listitem"><p>RFC2374: An IPv6 Aggregatable Global Unicast Address
	      Format</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><p>supports 64-bit length of Interface ID.</p></li></ul></div></li><li class="listitem"><p>RFC2375: IPv6 Multicast Address Assignments</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><p>Userland applications use the well-known
		  addresses assigned in the RFC.</p></li></ul></div></li><li class="listitem"><p>RFC2428: FTP Extensions for IPv6 and NATs</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><p>RFC2428 is preferred over RFC1639.  FTP clients
		  will first try RFC2428, then RFC1639 if
		  failed.</p></li></ul></div></li><li class="listitem"><p>RFC2460: IPv6 specification</p></li><li class="listitem"><p>RFC2461: Neighbor discovery for IPv6</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><p>See <a class="link" href="#neighbor-discovery" title="8.1.1.2. Neighbor Discovery">23.5.1.2</a> in
		  this document for details.</p></li></ul></div></li><li class="listitem"><p>RFC2462: IPv6 Stateless Address
	      Autoconfiguration</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><p>See <a class="link" href="#ipv6-pnp" title="8.1.1.4. Plug and Play">23.5.1.4</a> in
		  this document for details.</p></li></ul></div></li><li class="listitem"><p>RFC2463: ICMPv6 for IPv6 specification</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><p>See <a class="link" href="#icmpv6" title="8.1.1.9. ICMPv6">23.5.1.9</a> in
		  this document for details.</p></li></ul></div></li><li class="listitem"><p>RFC2464: Transmission of IPv6 Packets over Ethernet
	      Networks</p></li><li class="listitem"><p>RFC2465: MIB for IPv6: Textual Conventions and
	      General Group</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><p>Necessary statistics are gathered by the kernel.
		  Actual IPv6 MIB support is provided as a patchkit
		  for ucd-snmp.</p></li></ul></div></li><li class="listitem"><p>RFC2466: MIB for IPv6: ICMPv6 group</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><p>Necessary statistics are gathered by the kernel.
		  Actual IPv6 MIB support is provided as patchkit for
		  ucd-snmp.</p></li></ul></div></li><li class="listitem"><p>RFC2467: Transmission of IPv6 Packets over FDDI
	      Networks</p></li><li class="listitem"><p>RFC2497: Transmission of IPv6 packet over ARCnet
	      Networks</p></li><li class="listitem"><p>RFC2553: Basic Socket Interface Extensions for
	      IPv6</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><p>IPv4 mapped address (3.7) and special behavior
		  of IPv6 wildcard bind socket (3.8) are supported.
		  See <a class="link" href="#ipv6-wildcard-socket" title="8.1.1.12. IPv4 Mapped Address and IPv6 Wildcard Socket">23.5.1.12</a> in
		  this document for details.</p></li></ul></div></li><li class="listitem"><p>RFC2675: IPv6 Jumbograms</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><p>See <a class="link" href="#ipv6-jumbo" title="8.1.1.7. Jumbo Payload">23.5.1.7</a>
		  in this document for details.</p></li></ul></div></li><li class="listitem"><p>RFC2710: Multicast Listener Discovery for
	      IPv6</p></li><li class="listitem"><p>RFC2711: IPv6 router alert option</p></li><li class="listitem"><p><code class="filename">draft-ietf-ipngwg-router-renum-08</code>:
	      Router renumbering for IPv6</p></li><li class="listitem"><p><code class="filename">draft-ietf-ipngwg-icmp-namelookups-02</code>:
	      IPv6 Name Lookups Through ICMP</p></li><li class="listitem"><p><code class="filename">draft-ietf-ipngwg-icmp-name-lookups-03</code>:
	      IPv6 Name Lookups Through ICMP</p></li><li class="listitem"><p><code class="filename">draft-ietf-pim-ipv6-01.txt</code>: PIM
	      for IPv6</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><p><a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=pim6dd&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">pim6dd</span>(8)</span></a> implements dense mode.
		  <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=pim6sd&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">pim6sd</span>(8)</span></a> implements sparse mode.</p></li></ul></div></li><li class="listitem"><p><code class="filename">draft-itojun-ipv6-tcp-to-anycast-00</code>:
	      Disconnecting TCP connection toward IPv6 anycast
	      address</p></li><li class="listitem"><p><code class="filename">draft-yamamoto-wideipv6-comm-model-00</code></p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><p>See <a class="link" href="#ipv6-sas" title="8.1.1.6. Source Address Selection">23.5.1.6</a> in
		  this document for details.</p></li></ul></div></li><li class="listitem"><p><code class="filename">draft-ietf-ipngwg-scopedaddr-format-00.txt</code>:
	      An Extension of Format for IPv6 Scoped Addresses</p></li></ul></div></div><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="neighbor-discovery"></a>8.1.1.2. Neighbor Discovery</h4></div></div></div><p>Neighbor Discovery is fairly stable.  Currently Address
	  Resolution, Duplicated Address Detection, and Neighbor
	  Unreachability Detection are supported.  In the near future
	  we will be adding Proxy Neighbor Advertisement support in
	  the kernel and Unsolicited Neighbor Advertisement
	  transmission command as admin tool.</p><p>If DAD fails, the address will be marked "duplicated"
	  and message will be generated to syslog (and usually to
	  console).  The "duplicated" mark can be checked with
	  <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=ifconfig&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">ifconfig</span>(8)</span></a>.  It is administrators' responsibility to
	  check for and recover from DAD failures.  The behavior
	  should be improved in the near future.</p><p>Some of the network driver loops multicast packets back
	  to itself, even if instructed not to do so (especially in
	  promiscuous mode).  In such cases DAD may fail, because DAD
	  engine sees inbound NS packet (actually from the node
	  itself) and considers it as a sign of duplicate.  You may
	  want to look at #if condition marked "heuristics" in
	  sys/netinet6/nd6_nbr.c:nd6_dad_timer() as workaround (note
	  that the code fragment in "heuristics" section is not spec
	  conformant).</p><p>Neighbor Discovery specification (RFC2461) does not talk
	  about neighbor cache handling in the following cases:</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>when there was no neighbor cache entry, node
	      received unsolicited RS/NS/NA/redirect packet without
	      link-layer address</p></li><li class="listitem"><p>neighbor cache handling on medium without link-layer
	      address (we need a neighbor cache entry for IsRouter
	      bit)</p></li></ol></div><p>For first case, we implemented workaround based on
	  discussions on IETF ipngwg mailing list.  For more details,
	  see the comments in the source code and email thread started
	  from (IPng 7155), dated Feb 6 1999.</p><p>IPv6 on-link determination rule (RFC2461) is quite
	  different from assumptions in BSD network code.  At this
	  moment, no on-link determination rule is supported where
	  default router list is empty (RFC2461, section 5.2, last
	  sentence in 2nd paragraph - note that the spec misuse the
	  word "host" and "node" in several places in the
	  section).</p><p>To avoid possible DoS attacks and infinite loops, only
	  10 options on ND packet is accepted now.  Therefore, if you
	  have 20 prefix options attached to RA, only the first 10
	  prefixes will be recognized.  If this troubles you, please
	  ask it on FREEBSD-CURRENT mailing list and/or modify
	  nd6_maxndopt in <code class="filename">sys/netinet6/nd6.c</code>.  If
	  there are high demands we may provide sysctl knob for the
	  variable.</p></div><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="ipv6-scope-index"></a>8.1.1.3. Scope Index</h4></div></div></div><p>IPv6 uses scoped addresses.  Therefore, it is very
	  important to specify scope index (interface index for
	  link-local address, or site index for site-local address)
	  with an IPv6 address.  Without scope index, scoped IPv6
	  address is ambiguous to the kernel, and kernel will not be
	  able to determine the outbound interface for a
	  packet.</p><p>Ordinary userland applications should use advanced API
	  (RFC2292) to specify scope index, or interface index.  For
	  similar purpose, sin6_scope_id member in sockaddr_in6
	  structure is defined in RFC2553.  However, the semantics for
	  sin6_scope_id is rather vague.  If you care about
	  portability of your application, we suggest you to use
	  advanced API rather than sin6_scope_id.</p><p>In the kernel, an interface index for link-local scoped
	  address is embedded into 2nd 16bit-word (3rd and 4th byte)
	  in IPv6 address.  For example, you may see something
	  like:</p><pre class="screen">	fe80:1::200:f8ff:fe01:6317</pre><p>in the routing table and interface address structure
	  (struct in6_ifaddr).  The address above is a link-local
	  unicast address which belongs to a network interface whose
	  interface identifier is 1.  The embedded index enables us to
	  identify IPv6 link local addresses over multiple interfaces
	  effectively and with only a little code change.</p><p>Routing daemons and configuration programs, like
	  <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=route6d&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">route6d</span>(8)</span></a> and <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=ifconfig&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">ifconfig</span>(8)</span></a>, will need to
	  manipulate the "embedded" scope index.  These programs use
	  routing sockets and ioctls (like SIOCGIFADDR_IN6) and the
	  kernel API will return IPv6 addresses with 2nd 16bit-word
	  filled in.  The APIs are for manipulating kernel internal
	  structure.  Programs that use these APIs have to be prepared
	  about differences in kernels anyway.</p><p>When you specify scoped address to the command line,
	  NEVER write the embedded form (such as ff02:1::1 or
	  fe80:2::fedc).  This is not supposed to work.  Always use
	  standard form, like ff02::1 or fe80::fedc, with command line
	  option for specifying interface (like <code class="command">ping6 -I ne0
	    ff02::1</code>).  In general, if a command does not
	  have command line option to specify outgoing interface, that
	  command is not ready to accept scoped address.  This may
	  seem to be opposite from IPv6's premise to support "dentist
	  office" situation.  We believe that specifications need some
	  improvements for this.</p><p>Some of the userland tools support extended numeric IPv6
	  syntax, as documented in
	  <code class="filename">draft-ietf-ipngwg-scopedaddr-format-00.txt</code>.
	  You can specify outgoing link, by using name of the outgoing
	  interface like "fe80::1%ne0".  This way you will be able to
	  specify link-local scoped address without much
	  trouble.</p><p>To use this extension in your program, you will need to
	  use <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=getaddrinfo&amp;sektion=3&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">getaddrinfo</span>(3)</span></a>, and <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=getnameinfo&amp;sektion=3&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">getnameinfo</span>(3)</span></a> with
	  NI_WITHSCOPEID.  The implementation currently assumes 1-to-1
	  relationship between a link and an interface, which is
	  stronger than what specs say.</p></div><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="ipv6-pnp"></a>8.1.1.4. Plug and Play</h4></div></div></div><p>Most of the IPv6 stateless address autoconfiguration is
	  implemented in the kernel.  Neighbor Discovery functions are
	  implemented in the kernel as a whole.  Router Advertisement
	  (RA) input for hosts is implemented in the kernel.  Router
	  Solicitation (RS) output for endhosts, RS input for routers,
	  and RA output for routers are implemented in the
	  userland.</p><div class="sect4"><div xmlns="" class="titlepage"><div><div><h5 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp50213240"></a>8.1.1.4.1. Assignment of link-local, and special
	    addresses</h5></div></div></div><p>IPv6 link-local address is generated from IEEE802
	    address (Ethernet MAC address).  Each of interface is
	    assigned an IPv6 link-local address automatically, when
	    the interface becomes up (IFF_UP).  Also, direct route for
	    the link-local address is added to routing table.</p><p>Here is an output of netstat command:</p><pre class="screen">Internet6:
Destination                   Gateway                   Flags      Netif Expire
fe80:1::%ed0/64               link#1                    UC          ed0
fe80:2::%ep0/64               link#2                    UC          ep0</pre><p>Interfaces that has no IEEE802 address (pseudo
	    interfaces like tunnel interfaces, or ppp interfaces) will
	    borrow IEEE802 address from other interfaces, such as
	    Ethernet interfaces, whenever possible.  If there is no
	    IEEE802 hardware attached, a last resort pseudo-random
	    value, MD5(hostname), will be used as source of link-local
	    address.  If it is not suitable for your usage, you will
	    need to configure the link-local address manually.</p><p>If an interface is not capable of handling IPv6 (such
	    as lack of multicast support), link-local address will not
	    be assigned to that interface.  See section 2 for
	    details.</p><p>Each interface joins the solicited multicast address
	    and the link-local all-nodes multicast addresses (e.g.,
	    fe80::1:ff01:6317 and ff02::1, respectively, on the link
	    the interface is attached).  In addition to a link-local
	    address, the loopback address (::1) will be assigned to
	    the loopback interface.  Also, ::1/128 and ff01::/32 are
	    automatically added to routing table, and loopback
	    interface joins node-local multicast group ff01::1.</p></div><div class="sect4"><div xmlns="" class="titlepage"><div><div><h5 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp50216312"></a>8.1.1.4.2. Stateless address autoconfiguration on Hosts</h5></div></div></div><p>In IPv6 specification, nodes are separated into two
	    categories: <span class="emphasis"><em>routers</em></span> and
	    <span class="emphasis"><em>hosts</em></span>.  Routers forward packets
	    addressed to others, hosts does not forward the packets.
	    net.inet6.ip6.forwarding defines whether this node is
	    router or host (router if it is 1, host if it is
	    0).</p><p>When a host hears Router Advertisement from the
	    router, a host may autoconfigure itself by stateless
	    address autoconfiguration.  This behavior can be
	    controlled by net.inet6.ip6.accept_rtadv (host
	    autoconfigures itself if it is set to 1).  By
	    autoconfiguration, network address prefix for the
	    receiving interface (usually global address prefix) is
	    added.  Default route is also configured.  Routers
	    periodically generate Router Advertisement packets.  To
	    request an adjacent router to generate RA packet, a host
	    can transmit Router Solicitation.  To generate a RS packet
	    at any time, use the <span class="emphasis"><em>rtsol</em></span> command.
	    <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=rtsold&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">rtsold</span>(8)</span></a> daemon is also available.  <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=rtsold&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">rtsold</span>(8)</span></a>
	    generates Router Solicitation whenever necessary, and it
	    works great for nomadic usage (notebooks/laptops).  If one
	    wishes to ignore Router Advertisements, use sysctl to set
	    net.inet6.ip6.accept_rtadv to 0.</p><p>To generate Router Advertisement from a router, use
	    the <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=rtadvd&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">rtadvd</span>(8)</span></a> daemon.</p><p>Note that, IPv6 specification assumes the following
	    items, and nonconforming cases are left
	    unspecified:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Only hosts will listen to router
		advertisements</p></li><li class="listitem"><p>Hosts have single network interface (except
		loopback)</p></li></ul></div><p>Therefore, this is unwise to enable
	    net.inet6.ip6.accept_rtadv on routers, or multi-interface
	    host.  A misconfigured node can behave strange
	    (nonconforming configuration allowed for those who would
	    like to do some experiments).</p><p>To summarize the sysctl knob:</p><pre class="screen">	accept_rtadv	forwarding	role of the node
	---		---		---
	0		0		host (to be manually configured)
	0		1		router
	1		0		autoconfigured host
					(spec assumes that host has single
					interface only, autoconfigured host
					with multiple interface is
					out-of-scope)
	1		1		invalid, or experimental
					(out-of-scope of spec)</pre><p>RFC2462 has validation rule against incoming RA prefix
	    information option, in 5.5.3 (e).  This is to protect
	    hosts from malicious (or misconfigured) routers that
	    advertise very short prefix lifetime.  There was an update
	    from Jim Bound to ipngwg mailing list (look for "(ipng
	    6712)" in the archive) and it is implemented Jim's
	    update.</p><p>See <a class="link" href="#neighbor-discovery" title="8.1.1.2. Neighbor Discovery">23.5.1.2</a>
	    in the document for relationship between DAD and
	    autoconfiguration.</p></div></div><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="gif"></a>8.1.1.5. Generic Tunnel Interface</h4></div></div></div><p>GIF (Generic InterFace) is a pseudo interface for
	  configured tunnel.  Details are described in <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=gif&amp;sektion=4&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">gif</span>(4)</span></a>.
	  Currently</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>v6 in v6</p></li><li class="listitem"><p>v6 in v4</p></li><li class="listitem"><p>v4 in v6</p></li><li class="listitem"><p>v4 in v4</p></li></ul></div><p>are available.  Use <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=gifconfig&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">gifconfig</span>(8)</span></a> to assign physical
	  (outer) source and destination address to gif interfaces.
	  Configuration that uses same address family for inner and
	  outer IP header (v4 in v4, or v6 in v6) is dangerous.  It is
	  very easy to configure interfaces and routing tables to
	  perform infinite level of tunneling.  <span class="emphasis"><em>Please be
	    warned</em></span>.</p><p>gif can be configured to be ECN-friendly.  See <a class="link" href="#ipsec-ecn" title="8.1.4.5. ECN Consideration on IPsec Tunnels">23.5.4.5</a> for ECN-friendliness
	  of tunnels, and <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=gif&amp;sektion=4&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">gif</span>(4)</span></a> for how to configure.</p><p>If you would like to configure an IPv4-in-IPv6 tunnel
	  with gif interface, read <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=gif&amp;sektion=4&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">gif</span>(4)</span></a> carefully.  You will
	  need to remove IPv6 link-local address automatically
	  assigned to the gif interface.</p></div><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="ipv6-sas"></a>8.1.1.6. Source Address Selection</h4></div></div></div><p>Current source selection rule is scope oriented (there
	  are some exceptions - see below).  For a given destination,
	  a source IPv6 address is selected by the following
	  rule:</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>If the source address is explicitly specified by the
	      user (e.g.,  via the advanced API), the specified
	      address is used.</p></li><li class="listitem"><p>If there is an address assigned to the outgoing
	      interface (which is usually determined by looking up the
	      routing table) that has the same scope as the
	      destination address, the address is used.</p><p>This is the most typical case.</p></li><li class="listitem"><p>If there is no address that satisfies the above
	      condition, choose a global address assigned to one of
	      the interfaces on the sending node.</p></li><li class="listitem"><p>If there is no address that satisfies the above
	      condition, and destination address is site local scope,
	      choose a site local address assigned to one of the
	      interfaces on the sending node.</p></li><li class="listitem"><p>If there is no address that satisfies the above
	      condition, choose the address associated with the
	      routing table entry for the destination.  This is the
	      last resort, which may cause scope violation.</p></li></ol></div><p>For instance, ::1 is selected for ff01::1,
	  fe80:1::200:f8ff:fe01:6317 for fe80:1::2a0:24ff:feab:839b
	  (note that embedded interface index - described in <a class="link" href="#ipv6-scope-index" title="8.1.1.3. Scope Index">23.5.1.3</a> - helps us
	  choose the right source address.  Those embedded indices
	  will not be on the wire).  If the outgoing interface has
	  multiple address for the scope, a source is selected longest
	  match basis (rule 3).  Suppose
	  2001:0DB8:808:1:200:f8ff:fe01:6317 and
	  2001:0DB8:9:124:200:f8ff:fe01:6317 are given to the outgoing
	  interface.  2001:0DB8:808:1:200:f8ff:fe01:6317 is chosen as
	  the source for the destination 2001:0DB8:800::1.</p><p>Note that the above rule is not documented in the IPv6
	  spec.  It is considered "up to implementation" item.  There
	  are some cases where we do not use the above rule.  One
	  example is connected TCP session, and we use the address
	  kept in tcb as the source.  Another example is source
	  address for Neighbor Advertisement.  Under the spec (RFC2461
	  7.2.2) NA's source should be the target address of the
	  corresponding NS's target.  In this case we follow the spec
	  rather than the above longest-match rule.</p><p>For new connections (when rule 1 does not apply),
	  deprecated addresses (addresses with preferred lifetime = 0)
	  will not be chosen as source address if other choices are
	  available.  If no other choices are available, deprecated
	  address will be used as a last resort.  If there are
	  multiple choice of deprecated addresses, the above scope
	  rule will be used to choose from those deprecated addresses.
	  If you would like to prohibit the use of deprecated address
	  for some reason, configure net.inet6.ip6.use_deprecated to
	  0.  The issue related to deprecated address is described in
	  RFC2462 5.5.4 (NOTE: there is some debate underway in IETF
	  ipngwg on how to use "deprecated" address).</p></div><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="ipv6-jumbo"></a>8.1.1.7. Jumbo Payload</h4></div></div></div><p>The Jumbo Payload hop-by-hop option is implemented and
	  can be used to send IPv6 packets with payloads longer than
	  65,535 octets.  But currently no physical interface whose
	  MTU is more than 65,535 is supported, so such payloads can
	  be seen only on the loopback interface (i.e., lo0).</p><p>If you want to try jumbo payloads, you first have to
	  reconfigure the kernel so that the MTU of the loopback
	  interface is more than 65,535 bytes; add the following to
	  the kernel configuration file:</p><p><code class="literal">options		"LARGE_LOMTU"		#To
	    test jumbo payload</code></p><p>and recompile the new kernel.</p><p>Then you can test jumbo payloads by the <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=ping6&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">ping6</span>(8)</span></a>
	  command with -b and -s options.  The -b option must be
	  specified to enlarge the size of the socket buffer and the
	  -s option specifies the length of the packet, which should
	  be more than 65,535.  For example, type as follows:</p><pre class="screen"><code class="prompt">%</code> <strong class="userinput"><code>ping6 -b 70000 -s 68000 ::1</code></strong></pre><p>The IPv6 specification requires that the Jumbo Payload
	  option must not be used in a packet that carries a fragment
	  header.  If this condition is broken, an ICMPv6 Parameter
	  Problem message must be sent to the sender.  specification
	  is followed, but you cannot usually see an ICMPv6 error
	  caused by this requirement.</p><p>When an IPv6 packet is received, the frame length is
	  checked and compared to the length specified in the payload
	  length field of the IPv6 header or in the value of the Jumbo
	  Payload option, if any.  If the former is shorter than the
	  latter, the packet is discarded and statistics are
	  incremented.  You can see the statistics as output of
	  <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=netstat&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">netstat</span>(8)</span></a> command with `-s -p ip6' option:</p><pre class="screen"><code class="prompt">%</code> <strong class="userinput"><code>netstat -s -p ip6</code></strong>
	  ip6:
		(snip)
		1 with data size &lt; data length</pre><p>So, kernel does not send an ICMPv6 error unless the
	  erroneous packet is an actual Jumbo Payload, that is, its
	  packet size is more than 65,535 bytes.  As described above,
	  currently no physical interface with such a huge MTU is
	  supported, so it rarely returns an ICMPv6 error.</p><p>TCP/UDP over jumbogram is not supported at this moment.
	  This is because we have no medium (other than loopback) to
	  test this.  Contact us if you need this.</p><p>IPsec does not work on jumbograms.  This is due to some
	  specification twists in supporting AH with jumbograms (AH
	  header size influences payload length, and this makes it
	  real hard to authenticate inbound packet with jumbo payload
	  option as well as AH).</p><p>There are fundamental issues in *BSD support for
	  jumbograms.  We would like to address those, but we need
	  more time to finalize these.  To name a few:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>mbuf pkthdr.len field is typed as "int" in 4.4BSD,
	      so it will not hold jumbogram with len &gt; 2G on 32bit
	      architecture CPUs.  If we would like to support
	      jumbogram properly, the field must be expanded to hold
	      4G + IPv6 header + link-layer header.  Therefore, it
	      must be expanded to at least int64_t (u_int32_t is NOT
	      enough).</p></li><li class="listitem"><p>We mistakingly use "int" to hold packet length in
	      many places.  We need to convert them into larger
	      integral type.  It needs a great care, as we may
	      experience overflow during packet length
	      computation.</p></li><li class="listitem"><p>We mistakingly check for ip6_plen field of IPv6
	      header for packet payload length in various places.  We
	      should be checking mbuf pkthdr.len instead.  ip6_input()
	      will perform sanity check on jumbo payload option on
	      input, and we can safely use mbuf pkthdr.len
	      afterwards.</p></li><li class="listitem"><p>TCP code needs a careful update in bunch of places,
	      of course.</p></li></ul></div></div><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp50633080"></a>8.1.1.8. Loop Prevention in Header Processing</h4></div></div></div><p>IPv6 specification allows arbitrary number of extension
	  headers to be placed onto packets.  If we implement IPv6
	  packet processing code in the way BSD IPv4 code is
	  implemented, kernel stack may overflow due to long function
	  call chain.  sys/netinet6 code is carefully designed to
	  avoid kernel stack overflow.  Because of this, sys/netinet6
	  code defines its own protocol switch structure, as "struct
	  ip6protosw" (see
	  <code class="filename">netinet6/ip6protosw.h</code>).  There is no
	  such update to IPv4 part (sys/netinet) for compatibility,
	  but small change is added to its pr_input() prototype.  So
	  "struct ipprotosw" is also defined.  Because of this, if you
	  receive IPsec-over-IPv4 packet with massive number of IPsec
	  headers, kernel stack may blow up.  IPsec-over-IPv6 is okay.
	  (Off-course, for those all IPsec headers to be processed,
	  each such IPsec header must pass each IPsec check.  So an
	  anonymous attacker will not be able to do such an
	  attack.)</p></div><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="icmpv6"></a>8.1.1.9. ICMPv6</h4></div></div></div><p>After RFC2463 was published, IETF ipngwg has decided to
	  disallow ICMPv6 error packet against ICMPv6 redirect, to
	  prevent ICMPv6 storm on a network medium.  This is already
	  implemented into the kernel.</p></div><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp50639992"></a>8.1.1.10. Applications</h4></div></div></div><p>For userland programming, we support IPv6 socket API as
	  specified in RFC2553, RFC2292 and upcoming Internet
	  drafts.</p><p>TCP/UDP over IPv6 is available and quite stable.  You
	  can enjoy <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=telnet&amp;sektion=1&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">telnet</span>(1)</span></a>, <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=ftp&amp;sektion=1&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">ftp</span>(1)</span></a>, <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=rlogin&amp;sektion=1&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">rlogin</span>(1)</span></a>,
	  <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=rsh&amp;sektion=1&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">rsh</span>(1)</span></a>, <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=ssh&amp;sektion=1&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">ssh</span>(1)</span></a>, etc.  These applications are
	  protocol independent.  That is, they automatically chooses
	  IPv4 or IPv6 according to DNS.</p></div><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp50645624"></a>8.1.1.11. Kernel Internals</h4></div></div></div><p>While ip_forward() calls ip_output(), ip6_forward()
	  directly calls if_output() since routers must not divide
	  IPv6 packets into fragments.</p><p>ICMPv6 should contain the original packet as long as
	  possible up to 1280.  UDP6/IP6 port unreach, for instance,
	  should contain all extension headers and the *unchanged*
	  UDP6 and IP6 headers.  So, all IP6 functions except TCP
	  never convert network byte order into host byte order, to
	  save the original packet.</p><p>tcp_input(), udp6_input() and icmp6_input() can not
	  assume that IP6 header is preceding the transport headers
	  due to extension headers.  So, in6_cksum() was implemented
	  to handle packets whose IP6 header and transport header is
	  not continuous.  TCP/IP6 nor UDP6/IP6 header structures do
	  not exist for checksum calculation.</p><p>To process IP6 header, extension headers and transport
	  headers easily, network drivers are now required to store
	  packets in one internal mbuf or one or more external mbufs.
	  A typical old driver prepares two internal mbufs for 96 -
	  204 bytes data, however, now such packet data is stored in
	  one external mbuf.</p><p><code class="command">netstat -s -p ip6</code> tells you whether
	  or not your driver conforms such requirement.  In the
	  following example, "cce0" violates the requirement.  (For
	  more information, refer to Section 2.)</p><pre class="screen">Mbuf statistics:
                317 one mbuf
                two or more mbuf::
                        lo0 = 8
			cce0 = 10
                3282 one ext mbuf
                0 two or more ext mbuf</pre><p>Each input function calls IP6_EXTHDR_CHECK in the
	  beginning to check if the region between IP6 and its header
	  is continuous.  IP6_EXTHDR_CHECK calls m_pullup() only if
	  the mbuf has M_LOOP flag, that is, the packet comes from the
	  loopback interface.  m_pullup() is never called for packets
	  coming from physical network interfaces.</p><p>Both IP and IP6 reassemble functions never call
	  m_pullup().</p></div><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="ipv6-wildcard-socket"></a>8.1.1.12. IPv4 Mapped Address and IPv6 Wildcard Socket</h4></div></div></div><p>RFC2553 describes IPv4 mapped address (3.7) and special
	  behavior of IPv6 wildcard bind socket (3.8).  The spec
	  allows you to:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Accept IPv4 connections by AF_INET6 wildcard bind
	      socket.</p></li><li class="listitem"><p>Transmit IPv4 packet over AF_INET6 socket by using
	      special form of the address like ::ffff:10.1.1.1.</p></li></ul></div><p>but the spec itself is very complicated and does not
	  specify how the socket layer should behave.  Here we call
	  the former one "listening side" and the latter one
	  "initiating side", for reference purposes.</p><p>You can perform wildcard bind on both of the address
	  families, on the same port.</p><p>The following table show the behavior of FreeBSD
	  4.x.</p><pre class="screen">listening side          initiating side
                (AF_INET6 wildcard      (connection to ::ffff:10.1.1.1)
                socket gets IPv4 conn.)
                ---                     ---
FreeBSD 4.x     configurable            supported
                default: enabled</pre><p>The following sections will give you more details, and
	  how you can configure the behavior.</p><p>Comments on listening side:</p><p>It looks that RFC2553 talks too little on wildcard bind
	  issue, especially on the port space issue, failure mode and
	  relationship between AF_INET/INET6 wildcard bind.  There can
	  be several separate interpretation for this RFC which
	  conform to it but behaves differently.  So, to implement
	  portable application you should assume nothing about the
	  behavior in the kernel.  Using <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=getaddrinfo&amp;sektion=3&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">getaddrinfo</span>(3)</span></a> is the
	  safest way.  Port number space and wildcard bind issues were
	  discussed in detail on ipv6imp mailing list, in mid March
	  1999 and it looks that there is no concrete consensus
	  (means, up to implementers).  You may want to check the
	  mailing list archives.</p><p>If a server application would like to accept IPv4 and
	  IPv6 connections, there will be two alternatives.</p><p>One is using AF_INET and AF_INET6 socket (you will need
	  two sockets).  Use <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=getaddrinfo&amp;sektion=3&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">getaddrinfo</span>(3)</span></a> with AI_PASSIVE into
	  ai_flags, and <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=socket&amp;sektion=2&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">socket</span>(2)</span></a> and <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=bind&amp;sektion=2&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">bind</span>(2)</span></a> to all the
	  addresses returned.  By opening multiple sockets, you can
	  accept connections onto the socket with proper address
	  family.  IPv4 connections will be accepted by AF_INET
	  socket, and IPv6 connections will be accepted by AF_INET6
	  socket.</p><p>Another way is using one AF_INET6 wildcard bind socket.
	  Use <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=getaddrinfo&amp;sektion=3&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">getaddrinfo</span>(3)</span></a> with AI_PASSIVE into ai_flags and
	  with AF_INET6 into ai_family, and set the 1st argument
	  hostname to NULL. And <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=socket&amp;sektion=2&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">socket</span>(2)</span></a> and <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=bind&amp;sektion=2&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">bind</span>(2)</span></a> to the
	  address returned.  (should be IPv6 unspecified addr).  You
	  can accept either of IPv4 and IPv6 packet via this one
	  socket.</p><p>To support only IPv6 traffic on AF_INET6 wildcard binded
	  socket portably, always check the peer address when a
	  connection is made toward AF_INET6 listening socket.  If the
	  address is IPv4 mapped address, you may want to reject the
	  connection.  You can check the condition by using
	  IN6_IS_ADDR_V4MAPPED() macro.</p><p>To resolve this issue more easily, there is system
	  dependent <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=setsockopt&amp;sektion=2&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">setsockopt</span>(2)</span></a> option, IPV6_BINDV6ONLY, used
	  like below.</p><pre class="programlisting">	int on;

	setsockopt(s, IPPROTO_IPV6, IPV6_BINDV6ONLY,
		   (char *)&amp;on, sizeof (on)) &lt; 0));</pre><p>When this call succeed, then this socket only receive
	  IPv6 packets.</p><p>Comments on initiating side:</p><p>Advise to application implementers: to implement a
	  portable IPv6 application (which works on multiple IPv6
	  kernels), we believe that the following is the key to the
	  success:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>NEVER hardcode AF_INET nor AF_INET6.</p></li><li class="listitem"><p>Use <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=getaddrinfo&amp;sektion=3&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">getaddrinfo</span>(3)</span></a> and <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=getnameinfo&amp;sektion=3&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">getnameinfo</span>(3)</span></a>
	      throughout the system.  Never use gethostby*(),
	      getaddrby*(), inet_*() or getipnodeby*().  (To update
	      existing applications to be IPv6 aware easily, sometime
	      getipnodeby*() will be useful.  But if possible, try to
	      rewrite the code to use <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=getaddrinfo&amp;sektion=3&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">getaddrinfo</span>(3)</span></a> and
	      <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=getnameinfo&amp;sektion=3&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">getnameinfo</span>(3)</span></a>.)</p></li><li class="listitem"><p>If you would like to connect to destination, use
	      <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=getaddrinfo&amp;sektion=3&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">getaddrinfo</span>(3)</span></a> and try all the destination
	      returned, like <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=telnet&amp;sektion=1&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">telnet</span>(1)</span></a> does.</p></li><li class="listitem"><p>Some of the IPv6 stack is shipped with buggy
	      <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=getaddrinfo&amp;sektion=3&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">getaddrinfo</span>(3)</span></a>.  Ship a minimal working version
	      with your application and use that as last
	      resort.</p></li></ul></div><p>If you would like to use AF_INET6 socket for both IPv4
	  and IPv6 outgoing connection, you will need to use
	  <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=getipnodebyname&amp;sektion=3&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">getipnodebyname</span>(3)</span></a>.  When you would like to update your
	  existing application to be IPv6 aware with minimal effort,
	  this approach might be chosen.  But please note that it is a
	  temporal solution, because <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=getipnodebyname&amp;sektion=3&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">getipnodebyname</span>(3)</span></a> itself is
	  not recommended as it does not handle scoped IPv6 addresses
	  at all.  For IPv6 name resolution, <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=getaddrinfo&amp;sektion=3&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">getaddrinfo</span>(3)</span></a> is
	  the preferred API. So you should rewrite your application to
	  use <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=getaddrinfo&amp;sektion=3&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">getaddrinfo</span>(3)</span></a>, when you get the time to do
	  it.</p><p>When writing applications that make outgoing
	  connections, story goes much simpler if you treat AF_INET
	  and AF_INET6 as totally separate address family.
	  {set,get}sockopt issue goes simpler, DNS issue will be made
	  simpler.  We do not recommend you to rely upon IPv4 mapped
	  address.</p><div class="sect4"><div xmlns="" class="titlepage"><div><div><h5 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp50715000"></a>8.1.1.12.1. unified tcp and inpcb code</h5></div></div></div><p>FreeBSD 4.x uses shared tcp code between IPv4 and IPv6
	    (from sys/netinet/tcp*) and separate udp4/6 code.  It uses
	    unified inpcb structure.</p><p>The platform can be configured to support IPv4 mapped
	    address.  Kernel configuration is summarized as
	    follows:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>By default, AF_INET6 socket will grab IPv4
		connections in certain condition, and can initiate
		connection to IPv4 destination embedded in IPv4 mapped
		IPv6 address.</p></li><li class="listitem"><p>You can disable it on entire system with sysctl
		like below.</p><p><code class="command">sysctl
		  net.inet6.ip6.mapped_addr=0</code></p></li></ul></div><div class="sect5"><div xmlns="" class="titlepage"><div><div><h6 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp50718968"></a>8.1.1.12.1.1. Listening Side</h6></div></div></div><p>Each socket can be configured to support special
	      AF_INET6 wildcard bind (enabled by default).  You can
	      disable it on each socket basis with <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=setsockopt&amp;sektion=2&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">setsockopt</span>(2)</span></a>
	      like below.</p><pre class="programlisting">	int on;

	setsockopt(s, IPPROTO_IPV6, IPV6_BINDV6ONLY,
		   (char *)&amp;on, sizeof (on)) &lt; 0));</pre><p>Wildcard AF_INET6 socket grabs IPv4 connection if
	      and only if the following conditions are
	      satisfied:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>there is no AF_INET socket that matches the IPv4
		  connection</p></li><li class="listitem"><p>the AF_INET6 socket is configured to accept IPv4
		  traffic, i.e.,  getsockopt(IPV6_BINDV6ONLY) returns
		  0.</p></li></ul></div><p>There is no problem with open/close ordering.</p></div><div class="sect5"><div xmlns="" class="titlepage"><div><div><h6 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp50724088"></a>8.1.1.12.1.2. Initiating Side</h6></div></div></div><p>FreeBSD 4.x supports outgoing connection to IPv4
	      mapped address (::ffff:10.1.1.1), if the node is
	      configured to support IPv4 mapped address.</p></div></div></div><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp50725496"></a>8.1.1.13. sockaddr_storage</h4></div></div></div><p>When RFC2553 was about to be finalized, there was
	  discussion on how struct sockaddr_storage members are named.
	  One proposal is to prepend "__" to the members (like
	  "__ss_len") as they should not be touched.  The other
	  proposal was not to prepend it (like "ss_len") as we need to
	  touch those members directly.  There was no clear consensus
	  on it.</p><p>As a result, RFC2553 defines struct sockaddr_storage as
	  follows:</p><pre class="programlisting">	struct sockaddr_storage {
		u_char	__ss_len;	/* address length */
		u_char	__ss_family;	/* address family */
		/* and bunch of padding */
	};</pre><p>On the contrary, XNET draft defines as follows:</p><pre class="programlisting">	struct sockaddr_storage {
		u_char	ss_len;		/* address length */
		u_char	ss_family;	/* address family */
		/* and bunch of padding */
	};</pre><p>In December 1999, it was agreed that RFC2553bis should
	  pick the latter (XNET) definition.</p><p>Current implementation conforms to XNET definition,
	  based on RFC2553bis discussion.</p><p>If you look at multiple IPv6 implementations, you will
	  be able to see both definitions.  As an userland programmer,
	  the most portable way of dealing with it is to:</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>ensure ss_family and/or ss_len are available on the
	      platform, by using GNU autoconf,</p></li><li class="listitem"><p>have -Dss_family=__ss_family to unify all
	      occurrences (including header file) into __ss_family,
	      or</p></li><li class="listitem"><p>never touch __ss_family.  cast to sockaddr * and use
	      sa_family like:</p><pre class="programlisting">	struct sockaddr_storage ss;
	family = ((struct sockaddr *)&amp;ss)-&gt;sa_family</pre></li></ol></div></div></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp50745080"></a>8.1.2. Network Drivers</h3></div></div></div><p>Now following two items are required to be supported by
	standard drivers:</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>mbuf clustering requirement.  In this stable release,
	    we changed MINCLSIZE into MHLEN+1 for all the operating
	    systems in order to make all the drivers behave as we
	    expect.</p></li><li class="listitem"><p>multicast.  If <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=ifmcstat&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">ifmcstat</span>(8)</span></a> yields no multicast
	    group for a interface, that interface has to be
	    patched.</p></li></ol></div><p>If any of the drivers do not support the requirements,
	then the drivers cannot be used for IPv6 and/or IPsec
	communication.  If you find any problem with your card using
	IPv6/IPsec, then, please report it to the <a class="link" href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-bugs" target="_top">FreeBSD problem reports mailing list</a>.</p><p>(NOTE: In the past we required all PCMCIA drivers to have
	a call to in6_ifattach().  We have no such requirement any
	more)</p></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp50754424"></a>8.1.3. Translator</h3></div></div></div><p>We categorize IPv4/IPv6 translator into 4 types:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p><span class="emphasis"><em>Translator A</em></span> --- It is used in
	    the early stage of transition to make it possible to
	    establish a connection from an IPv6 host in an IPv6 island
	    to an IPv4 host in the IPv4 ocean.</p></li><li class="listitem"><p><span class="emphasis"><em>Translator B</em></span> --- It is used in
	    the early stage of transition to make it possible to
	    establish a connection from an IPv4 host in the IPv4 ocean
	    to an IPv6 host in an IPv6 island.</p></li><li class="listitem"><p><span class="emphasis"><em>Translator C</em></span> --- It is used in
	    the late stage of transition to make it possible to
	    establish a connection from an IPv4 host in an IPv4 island
	    to an IPv6 host in the IPv6 ocean.</p></li><li class="listitem"><p><span class="emphasis"><em>Translator D</em></span> --- It is used in
	    the late stage of transition to make it possible to
	    establish a connection from an IPv6 host in the IPv6 ocean
	    to an IPv4 host in an IPv4 island.</p></li></ul></div></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="ipsec-implementation"></a>8.1.4. IPsec</h3></div></div></div><p>IPsec is mainly organized by three components.</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>Policy Management</p></li><li class="listitem"><p>Key Management</p></li><li class="listitem"><p>AH and ESP handling</p></li></ol></div><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp50763896"></a>8.1.4.1. Policy Management</h4></div></div></div><p>The kernel implements experimental policy management
	  code.  There are two way to manage security policy.  One is
	  to configure per-socket policy using <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=setsockopt&amp;sektion=2&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">setsockopt</span>(2)</span></a>.  In
	  this cases, policy configuration is described in
	  <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=ipsec_set_policy&amp;sektion=3&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">ipsec_set_policy</span>(3)</span></a>.  The other is to configure kernel
	  packet filter-based policy using PF_KEY interface, via
	  <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=setkey&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">setkey</span>(8)</span></a>.</p><p>The policy entry is not re-ordered with its indexes, so
	  the order of entry when you add is very significant.</p></div><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp50767736"></a>8.1.4.2. Key Management</h4></div></div></div><p>The key management code implemented in this kit
	  (sys/netkey) is a home-brew PFKEY v2 implementation.  This
	  conforms to RFC2367.</p><p>The home-brew IKE daemon, "racoon" is included in the
	  kit (kame/kame/racoon).  Basically you will need to run
	  racoon as daemon, then set up a policy to require keys (like
	  <code class="command">ping -P 'out ipsec esp/transport//use'</code>).
	  The kernel will contact racoon daemon as necessary to
	  exchange keys.</p></div><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp50773752"></a>8.1.4.3. AH and ESP Handling</h4></div></div></div><p>IPsec module is implemented as "hooks" to the standard
	  IPv4/IPv6 processing.  When sending a packet,
	  ip{,6}_output() checks if ESP/AH processing is required by
	  checking if a matching SPD (Security Policy Database) is
	  found.  If ESP/AH is needed, {esp,ah}{4,6}_output() will be
	  called and mbuf will be updated accordingly.  When a packet
	  is received, {esp,ah}4_input() will be called based on
	  protocol number, i.e., (*inetsw[proto])().
	  {esp,ah}4_input() will decrypt/check authenticity of the
	  packet, and strips off daisy-chained header and padding for
	  ESP/AH.  It is safe to strip off the ESP/AH header on packet
	  reception, since we will never use the received packet in
	  "as is" form.</p><p>By using ESP/AH, TCP4/6 effective data segment size will
	  be affected by extra daisy-chained headers inserted by
	  ESP/AH.  Our code takes care of the case.</p><p>Basic crypto functions can be found in directory
	  "sys/crypto".  ESP/AH transform are listed in
	  {esp,ah}_core.c with wrapper functions.  If you wish to add
	  some algorithm, add wrapper function in {esp,ah}_core.c, and
	  add your crypto algorithm code into sys/crypto.</p><p>Tunnel mode is partially supported in this release, with
	  the following restrictions:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>IPsec tunnel is not combined with GIF generic
	      tunneling interface.  It needs a great care because we
	      may create an infinite loop between ip_output() and
	      tunnelifp-&gt;if_output().  Opinion varies if it is
	      better to unify them, or not.</p></li><li class="listitem"><p>MTU and Don't Fragment bit (IPv4) considerations
	      need more checking, but basically works fine.</p></li><li class="listitem"><p>Authentication model for AH tunnel must be
	      revisited.  We will need to improve the policy
	      management engine, eventually.</p></li></ul></div></div><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp50778744"></a>8.1.4.4. Conformance to RFCs and IDs</h4></div></div></div><p>The IPsec code in the kernel conforms (or, tries to
	  conform) to the following standards:</p><p>"old IPsec" specification documented in
	  <code class="filename">rfc182[5-9].txt</code></p><p>"new IPsec" specification documented in
	  <code class="filename">rfc240[1-6].txt</code>,
	  <code class="filename">rfc241[01].txt</code>,
	  <code class="filename">rfc2451.txt</code> and
	  <code class="filename">draft-mcdonald-simple-ipsec-api-01.txt</code>
	  (draft expired, but you can take from <a class="link" href="ftp://ftp.kame.net/pub/internet-drafts/" target="_top">
	    ftp://ftp.kame.net/pub/internet-drafts/</a>).  (NOTE:
	  IKE specifications, <code class="filename">rfc241[7-9].txt</code> are
	  implemented in userland, as "racoon" IKE daemon)</p><p>Currently supported algorithms are:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>old IPsec AH</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><p>null crypto checksum (no document, just for
		  debugging)</p></li><li class="listitem"><p>keyed MD5 with 128bit crypto checksum
		  (<code class="filename">rfc1828.txt</code>)</p></li><li class="listitem"><p>keyed SHA1 with 128bit crypto checksum (no
		  document)</p></li><li class="listitem"><p>HMAC MD5 with 128bit crypto checksum
		  (<code class="filename">rfc2085.txt</code>)</p></li><li class="listitem"><p>HMAC SHA1 with 128bit crypto checksum (no
		  document)</p></li></ul></div></li><li class="listitem"><p>old IPsec ESP</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><p>null encryption (no document, similar to
		  <code class="filename">rfc2410.txt</code>)</p></li><li class="listitem"><p>DES-CBC mode
		  (<code class="filename">rfc1829.txt</code>)</p></li></ul></div></li><li class="listitem"><p>new IPsec AH</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><p>null crypto checksum (no document, just for
		  debugging)</p></li><li class="listitem"><p>keyed MD5 with 96bit crypto checksum (no
		  document)</p></li><li class="listitem"><p>keyed SHA1 with 96bit crypto checksum (no
		  document)</p></li><li class="listitem"><p>HMAC MD5 with 96bit crypto checksum
		  (<code class="filename">rfc2403.txt</code>)</p></li><li class="listitem"><p>HMAC SHA1 with 96bit crypto checksum
		  (<code class="filename">rfc2404.txt</code>)</p></li></ul></div></li><li class="listitem"><p>new IPsec ESP</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><p>null encryption
		  (<code class="filename">rfc2410.txt</code>)</p></li><li class="listitem"><p>DES-CBC with derived IV
		  (<code class="filename">draft-ietf-ipsec-ciph-des-derived-01.txt</code>,
		  draft expired)</p></li><li class="listitem"><p>DES-CBC with explicit IV
		  (<code class="filename">rfc2405.txt</code>)</p></li><li class="listitem"><p>3DES-CBC with explicit IV
		  (<code class="filename">rfc2451.txt</code>)</p></li><li class="listitem"><p>BLOWFISH CBC
		  (<code class="filename">rfc2451.txt</code>)</p></li><li class="listitem"><p>CAST128 CBC
		  (<code class="filename">rfc2451.txt</code>)</p></li><li class="listitem"><p>RC5 CBC
		  (<code class="filename">rfc2451.txt</code>)</p></li><li class="listitem"><p>each of the above can be combined with:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: square; "><li class="listitem"><p>ESP authentication with
		      HMAC-MD5(96bit)</p></li><li class="listitem"><p>ESP authentication with
		      HMAC-SHA1(96bit)</p></li></ul></div></li></ul></div></li></ul></div><p>The following algorithms are NOT supported:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>old IPsec AH</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><p>HMAC MD5 with 128bit crypto checksum + 64bit
		  replay prevention
		  (<code class="filename">rfc2085.txt</code>)</p></li><li class="listitem"><p>keyed SHA1 with 160bit crypto checksum + 32bit
		  padding (<code class="filename">rfc1852.txt</code>)</p></li></ul></div></li></ul></div><p>IPsec (in kernel) and IKE (in userland as "racoon") has
	  been tested at several interoperability test events, and it
	  is known to interoperate with many other implementations
	  well.  Also, current IPsec implementation as quite wide
	  coverage for IPsec crypto algorithms documented in RFC (we
	  cover algorithms without intellectual property issues
	  only).</p></div><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="ipsec-ecn"></a>8.1.4.5. ECN Consideration on IPsec Tunnels</h4></div></div></div><p>ECN-friendly IPsec tunnel is supported as described in
	  <code class="filename">draft-ipsec-ecn-00.txt</code>.</p><p>Normal IPsec tunnel is described in RFC2401.  On
	  encapsulation, IPv4 TOS field (or, IPv6 traffic class field)
	  will be copied from inner IP header to outer IP header.  On
	  decapsulation outer IP header will be simply dropped.  The
	  decapsulation rule is not compatible with ECN, since ECN bit
	  on the outer IP TOS/traffic class field will be lost.</p><p>To make IPsec tunnel ECN-friendly, we should modify
	  encapsulation and decapsulation procedure.  This is
	  described in <a class="link" href="http://www.aciri.org/floyd/papers/draft-ipsec-ecn-00.txt" target="_top">
	    http://www.aciri.org/floyd/papers/draft-ipsec-ecn-00.txt</a>,
	  chapter 3.</p><p>IPsec tunnel implementation can give you three
	  behaviors, by setting net.inet.ipsec.ecn (or
	  net.inet6.ipsec6.ecn) to some value:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>RFC2401: no consideration for ECN (sysctl value
	      -1)</p></li><li class="listitem"><p>ECN forbidden (sysctl value 0)</p></li><li class="listitem"><p>ECN allowed (sysctl value 1)</p></li></ul></div><p>Note that the behavior is configurable in per-node
	  manner, not per-SA manner (draft-ipsec-ecn-00 wants per-SA
	  configuration, but it looks too much for me).</p><p>The behavior is summarized as follows (see source code
	  for more detail):</p><pre class="screen">encapsulate                     decapsulate
                ---                             ---
RFC2401         copy all TOS bits               drop TOS bits on outer
                from inner to outer.            (use inner TOS bits as is)

ECN forbidden   copy TOS bits except for ECN    drop TOS bits on outer
                (masked with 0xfc) from inner   (use inner TOS bits as is)
                to outer.  set ECN bits to 0.

ECN allowed     copy TOS bits except for ECN    use inner TOS bits with some
                CE (masked with 0xfe) from      change.  if outer ECN CE bit
                inner to outer.                 is 1, enable ECN CE bit on
                set ECN CE bit to 0.            the inner.</pre><p>General strategy for configuration is as follows:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>if both IPsec tunnel endpoint are capable of
	      ECN-friendly behavior, you should better configure both
	      end to <span class="quote">&#8220;<span class="quote">ECN allowed</span>&#8221;</span> (sysctl value
	      1).</p></li><li class="listitem"><p>if the other end is very strict about TOS bit, use
	      "RFC2401" (sysctl value -1).</p></li><li class="listitem"><p>in other cases, use "ECN forbidden" (sysctl value
	      0).</p></li></ul></div><p>The default behavior is "ECN forbidden" (sysctl value
	  0).</p><p>For more information, please refer to:</p><p><a class="link" href="http://www.aciri.org/floyd/papers/draft-ipsec-ecn-00.txt" target="_top">
	    http://www.aciri.org/floyd/papers/draft-ipsec-ecn-00.txt</a>,
	  RFC2481 (Explicit Congestion Notification),
	  src/sys/netinet6/{ah,esp}_input.c</p><p>(Thanks goes to Kenjiro Cho
	  <code class="email">&lt;<a xmlns="" class="email" href="mailto:kjc@csl.sony.co.jp">kjc@csl.sony.co.jp</a>&gt;</code> for detailed
	  analysis)</p></div><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp50849272"></a>8.1.4.6. Interoperability</h4></div></div></div><p>Here are (some of) platforms that KAME code have tested
	  IPsec/IKE interoperability in the past.  Note that both ends
	  may have modified their implementation, so use the following
	  list just for reference purposes.</p><p>Altiga, Ashley-laurent (vpcom.com), Data Fellows
	  (F-Secure), Ericsson ACC, FreeS/WAN, HITACHI, IBM <span class="trademark">AIX</span>®,
	  IIJ, Intel, <span class="trademark">Microsoft</span>® <span class="trademark">Windows NT</span>®, NIST (linux IPsec +
	  plutoplus), Netscreen, OpenBSD, RedCreek, Routerware, SSH,
	  Secure Computing, Soliton, Toshiba, VPNet, Yamaha
	  RT100i</p></div></div></div></div></div><div class="part"><div xmlns="" class="titlepage"><div><div><h1 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="kernel"></a>Part III. Kernel</h1></div></div></div><div class="toc"><div class="toc-title">Table of Contents</div><dl class="toc"><dt><span class="chapter"><a href="#kernelbuild">9. Building and Installing a FreeBSD Kernel</a></span></dt><dd><dl><dt><span class="sect1"><a href="#kernelbuild-traditional">9.1. Building the Faster but Brittle Way</a></span></dt></dl></dd><dt><span class="chapter"><a href="#kerneldebug">10. Kernel Debugging</a></span></dt><dd><dl><dt><span class="sect1"><a href="#kerneldebug-obtain">10.1. Obtaining a Kernel Crash Dump</a></span></dt><dt><span class="sect1"><a href="#kerneldebug-gdb">10.2. Debugging a Kernel Crash Dump with <code class="command">kgdb</code></a></span></dt><dt><span class="sect1"><a href="#kerneldebug-online-ddb">10.3. On-Line Kernel Debugging Using DDB</a></span></dt><dt><span class="sect1"><a href="#kerneldebug-online-gdb">10.4. On-Line Kernel Debugging Using Remote GDB</a></span></dt><dt><span class="sect1"><a href="#kerneldebug-console">10.5. Debugging a Console Driver</a></span></dt><dt><span class="sect1"><a href="#kerneldebug-deadlocks">10.6. Debugging Deadlocks</a></span></dt><dt><span class="sect1"><a href="#kerneldebug-dcons">10.7. Kernel debugging with Dcons</a></span></dt><dt><span class="sect1"><a href="#kerneldebug-options">10.8. Glossary of Kernel Options for Debugging</a></span></dt></dl></dd></dl></div><div class="chapter"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="kernelbuild"></a>Chapter 9. Building and Installing a FreeBSD Kernel</h2></div></div></div><div class="toc"><div class="toc-title">Table of Contents</div><dl class="toc"><dt><span class="sect1"><a href="#kernelbuild-traditional">9.1. Building the Faster but Brittle Way</a></span></dt></dl></div><p>Being a kernel developer requires understanding of the kernel
    build process.  To debug the FreeBSD kernel it is required to be able
    to build one.  There are two known ways to do so:</p><p>The supported procedure to build and install a kernel is
    documented in the <a class="link" href="../handbook/kernelconfig-building.html" target="_top">Building and
      Installing a Custom Kernel</a> chapter of the FreeBSD
    Handbook.</p><div xmlns="" class="note"><h3 class="admontitle">Note: </h3><p xmlns="http://www.w3.org/1999/xhtml">It is supposed that the reader of this chapter is familiar
      with the information described in the <a class="link" href="../handbook/kernelconfig-building.html" target="_top">Building
	and Installing a Custom Kernel</a> chapter of the FreeBSD
      Handbook.  If this is not the case, please read through the
      above mentioned chapter to understand how the build process
      works.</p></div><div class="sect1"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="kernelbuild-traditional"></a>9.1. Building the Faster but Brittle Way</h2></div></div></div><p>Building the kernel this way may be useful when working on
      the
      kernel code and it may actually be faster than the
      documented procedure when only a single option or two were
      tweaked in the kernel configuration file.  On the other hand,
      it might lead to unexpected kernel build breakage.</p><div class="procedure"><ol class="procedure" type="1"><li class="step"><p>Run <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=config&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">config</span>(8)</span></a> to generate the kernel source
	  code:</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>/usr/sbin/config <em class="replaceable"><code>MYKERNEL</code></em></code></strong></pre></li><li class="step"><p>Change into the build directory.  <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=config&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">config</span>(8)</span></a> will
	  print the name of this directory after being run as
	  above.</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>cd ../compile/<em class="replaceable"><code>MYKERNEL</code></em></code></strong></pre></li><li class="step"><p>Compile the kernel:</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>make depend</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>make</code></strong></pre></li><li class="step"><p>Install the new kernel:</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>make install</code></strong></pre></li></ol></div></div></div><div class="chapter"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="kerneldebug"></a>Chapter 10. Kernel Debugging</h2></div><div><span class="authorgroup">Contributed by <span xmlns="http://www.w3.org/1999/xhtml" class="author"><span class="firstname">Paul</span> <span class="surname">Richards</span></span>, <span xmlns="http://www.w3.org/1999/xhtml" class="author"><span class="firstname">Jörg</span> <span class="surname">Wunsch</span></span> and <span xmlns="http://www.w3.org/1999/xhtml" class="author"><span class="firstname">Robert</span> <span class="surname">Watson</span></span>. </span></div></div></div><div class="toc"><div class="toc-title">Table of Contents</div><dl class="toc"><dt><span class="sect1"><a href="#kerneldebug-obtain">10.1. Obtaining a Kernel Crash Dump</a></span></dt><dt><span class="sect1"><a href="#kerneldebug-gdb">10.2. Debugging a Kernel Crash Dump with <code class="command">kgdb</code></a></span></dt><dt><span class="sect1"><a href="#kerneldebug-online-ddb">10.3. On-Line Kernel Debugging Using DDB</a></span></dt><dt><span class="sect1"><a href="#kerneldebug-online-gdb">10.4. On-Line Kernel Debugging Using Remote GDB</a></span></dt><dt><span class="sect1"><a href="#kerneldebug-console">10.5. Debugging a Console Driver</a></span></dt><dt><span class="sect1"><a href="#kerneldebug-deadlocks">10.6. Debugging Deadlocks</a></span></dt><dt><span class="sect1"><a href="#kerneldebug-dcons">10.7. Kernel debugging with Dcons</a></span></dt><dt><span class="sect1"><a href="#kerneldebug-options">10.8. Glossary of Kernel Options for Debugging</a></span></dt></dl></div><div class="sect1"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="kerneldebug-obtain"></a>10.1. Obtaining a Kernel Crash Dump</h2></div></div></div><p>When running a development kernel (e.g., FreeBSD-CURRENT), such as a
      kernel under extreme conditions (e.g., very high load averages,
      tens of thousands of connections, exceedingly high number of
      concurrent users, hundreds of <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=jail&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">jail</span>(8)</span></a>s, etc.), or using a
      new feature or device driver on FreeBSD-STABLE (e.g.,
      <acronym class="acronym">PAE</acronym>), sometimes a kernel will panic.  In the
      event that it does, this chapter will demonstrate how to extract
      useful information out of a crash.</p><p>A system reboot is inevitable once a kernel panics.  Once a
      system is rebooted, the contents of a system's physical memory
      (<acronym class="acronym">RAM</acronym>) is lost, as well as any bits that are
      on the swap device before the panic.  To preserve the bits in
      physical memory, the kernel makes use of the swap device as a
      temporary place to store the bits that are in RAM across a
      reboot after a crash.  In doing this, when FreeBSD boots after a
      crash, a kernel image can now be extracted and debugging can
      take place.</p><div xmlns="" class="note"><h3 class="admontitle">Note: </h3><p xmlns="http://www.w3.org/1999/xhtml">A swap device that has been configured as a dump
      device still acts as a swap device.  Dumps to non-swap devices
      (such as tapes or CDRWs, for example) are not supported at this time.  A
      <span class="quote">&#8220;<span class="quote">swap device</span>&#8221;</span> is synonymous with a <span class="quote">&#8220;<span class="quote">swap
      partition.</span>&#8221;</span></p></div><p>Several types of kernel crash dumps are available:</p><div class="variablelist"><dl class="variablelist"><dt><span class="term">Full memory dumps</span></dt><dd><p>Hold the complete contents of physical
	      memory.</p></dd><dt><span class="term">Minidumps</span></dt><dd><p>Hold only memory pages in use by the kernel
	      (FreeBSD 6.2 and higher).</p></dd><dt><span class="term">Textdumps</span></dt><dd><p>Hold captured, scripted, or interactive debugger
	      output (FreeBSD 7.1 and higher).</p></dd></dl></div><p>Minidumps are the default dump type as of FreeBSD 7.0,
	and in most cases will capture all necessary information
	present in a full memory dump, as most problems can be
	isolated only using kernel state.</p><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="config-dumpdev"></a>10.1.1. Configuring the Dump Device</h3></div></div></div><p>Before the kernel will dump the contents of its physical
	memory to a dump device, a dump device must be configured.  A
	dump device is specified by using the <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=dumpon&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">dumpon</span>(8)</span></a> command
	to tell the kernel where to save kernel crash dumps.  The
	<a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=dumpon&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">dumpon</span>(8)</span></a> program must be called after the swap partition
	has been configured with <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=swapon&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">swapon</span>(8)</span></a>.  This is normally
	handled by setting the <code class="varname">dumpdev</code> variable in
	<a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=rc.conf&amp;sektion=5&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">rc.conf</span>(5)</span></a> to the path of the swap device (the
	recommended way to extract a kernel dump) or
	<code class="literal">AUTO</code> to use the first configured swap
	device.  The default for <code class="varname">dumpdev</code> is
	<code class="literal">AUTO</code> in HEAD, and changed to
	<code class="literal">NO</code> on RELENG_* branches (except for RELENG_7,
	which was left set to <code class="literal">AUTO</code>).
	On FreeBSD 9.0-RELEASE and later versions,
	<span class="application">bsdinstall</span> will ask whether crash dumps
	should be enabled on the target system during the install process.</p><div xmlns="" class="tip"><h3 class="admontitle">Tip: </h3><p xmlns="http://www.w3.org/1999/xhtml">Check <code class="filename">/etc/fstab</code> or
	<a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=swapinfo&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">swapinfo</span>(8)</span></a> for a list of swap devices.</p></div><div xmlns="" class="important"><h3 class="admontitle">Important: </h3><p xmlns="http://www.w3.org/1999/xhtml">Make sure the <code class="varname">dumpdir</code>
        specified in <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=rc.conf&amp;sektion=5&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">rc.conf</span>(5)</span></a> exists before a kernel
        crash!</p><pre xmlns="http://www.w3.org/1999/xhtml" class="screen"><code class="prompt">#</code> <strong class="userinput"><code>mkdir /var/crash</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>chmod 700 /var/crash</code></strong></pre><p xmlns="http://www.w3.org/1999/xhtml">Also, remember that the contents of
	  <code class="filename">/var/crash</code> is sensitive and very likely
	  contains confidential information such as passwords.</p></div></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="extract-dump"></a>10.1.2. Extracting a Kernel Dump</h3></div></div></div><p>Once a dump has been written to a dump device, the dump
	  must be extracted before the swap device is mounted.
	  To extract a dump
	  from a dump device, use the <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=savecore&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">savecore</span>(8)</span></a> program.  If
	  <code class="varname">dumpdev</code> has been set in <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=rc.conf&amp;sektion=5&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">rc.conf</span>(5)</span></a>,
	  <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=savecore&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">savecore</span>(8)</span></a> will be called automatically on the first
	  multi-user boot after the crash and before the swap device
	  is mounted.  The location of the extracted core is placed in
	  the <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=rc.conf&amp;sektion=5&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">rc.conf</span>(5)</span></a> value <code class="varname">dumpdir</code>, by
	  default <code class="filename">/var/crash</code> and will be named
	  <code class="filename">vmcore.0</code>.</p><p>In the event that there is already a file called
          <code class="filename">vmcore.0</code> in
          <code class="filename">/var/crash</code> (or whatever
          <code class="varname">dumpdir</code> is set to), the kernel will
          increment the trailing number for every crash to avoid
          overwriting an existing <code class="filename">vmcore</code> (e.g.,
          <code class="filename">vmcore.1</code>).  <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=savecore&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">savecore</span>(8)</span></a> will always
	  create a symbolic link to named <code class="filename">vmcore.last</code>
	  in <code class="filename">/var/crash</code> after a dump is saved.
	  This symbolic link can be used to locate the name of the most
	  recent dump.</p><p>The <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=crashinfo&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">crashinfo</span>(8)</span></a> utility generates a text file
	  containing a summary of information from a full memory dump
	  or minidump.  If <code class="varname">dumpdev</code> has been set in
	  <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=rc.conf&amp;sektion=5&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">rc.conf</span>(5)</span></a>, <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=crashinfo&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">crashinfo</span>(8)</span></a> will be invoked
	  automatically after <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=savecore&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">savecore</span>(8)</span></a>.  The output is saved
	  to a file in <code class="varname">dumpdir</code> named
	  <code class="filename">core.txt.<em class="replaceable"><code>N</code></em></code>.</p><div xmlns="" class="tip"><h3 class="admontitle">Tip: </h3><p xmlns="http://www.w3.org/1999/xhtml">If you are testing a new kernel but need to boot a different one in
      order to get your system up and running again, boot it only into single
      user mode using the <code class="option">-s</code> flag at the boot prompt, and
      then perform the following steps:</p><pre xmlns="http://www.w3.org/1999/xhtml" class="screen"><code class="prompt">#</code> <strong class="userinput"><code>fsck -p</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>mount -a -t ufs</code></strong>       # make sure /var/crash is writable
<code class="prompt">#</code> <strong class="userinput"><code>savecore /var/crash /dev/ad0s1b</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>exit</code></strong>                  # exit to multi-user</pre><p xmlns="http://www.w3.org/1999/xhtml">This instructs <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=savecore&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">savecore</span>(8)</span></a> to extract a kernel dump
      from <code class="filename">/dev/ad0s1b</code> and place the contents in
      <code class="filename">/var/crash</code>.  Do not forget to make sure the
      destination directory <code class="filename">/var/crash</code> has enough
      space for the dump.  Also, do not forget to specify the correct path to your swap
      device as it is likely different than
      <code class="filename">/dev/ad0s1b</code>!</p></div></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp50958968"></a>10.1.3. Testing Kernel Dump Configuration</h3></div></div></div><p>The kernel includes a <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=sysctl&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">sysctl</span>(8)</span></a> node that requests a
       kernel panic.  This can be used to verify that your system is
       properly configured to save kernel crash dumps.  You may wish
       to remount existing file systems as read-only in single user
       mode before triggering the crash to avoid data loss.</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>shutdown now</code></strong>
...
Enter full pathname of shell or RETURN for /bin/sh:
<code class="prompt">#</code> <strong class="userinput"><code>mount -a -u -r</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>sysctl debug.kdb.panic=1</code></strong>
debug.kdb.panic:panic: kdb_sysctl_panic
...</pre><p>After rebooting, your system should save a dump in
        <code class="filename">/var/crash</code> along with a matching summary
        from <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=crashinfo&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">crashinfo</span>(8)</span></a>.</p></div></div><div class="sect1"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="kerneldebug-gdb"></a>10.2. Debugging a Kernel Crash Dump with <code class="command">kgdb</code></h2></div></div></div><div xmlns="" class="note"><h3 class="admontitle">Note: </h3><p xmlns="http://www.w3.org/1999/xhtml">This section covers <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=kgdb&amp;sektion=1&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">kgdb</span>(1)</span></a>.  The latest version is
        included in the <a xmlns="" class="package" href="https://www.freebsd.org/cgi/url.cgi?ports/devel/gdb/pkg-descr">devel/gdb</a>.  An older version
        is also present in FreeBSD 11 and earlier.</p></div><p>To enter into the debugger and begin getting information
      from the dump, start kgdb:</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>kgdb -n <em class="replaceable"><code>N</code></em></code></strong></pre><p>Where <em class="replaceable"><code>N</code></em> is the suffix of the
     <code class="filename">vmcore.<em class="replaceable"><code>N</code></em></code> to
     examine.  To open the most recent dump use:</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>kgdb -n last</code></strong></pre><p>Normally, <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=kgdb&amp;sektion=1&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">kgdb</span>(1)</span></a> should be able to locate the kernel
     running at the time the dump was generated.  If it is not able to
     locate the correct kernel, pass the pathname of the kernel and
     dump as two arguments to kgdb:</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>kgdb /boot/kernel/kernel /var/crash/vmcore.0</code></strong></pre><p>You can debug the crash dump using the kernel sources just like
      you can for any other program.</p><p>This dump is from a 5.2-BETA kernel and the crash
      comes from deep within the kernel.  The output below has been
      modified to include line numbers on the left.  This first trace
      inspects the instruction pointer and obtains a back trace.  The
      address that is used on line 41 for the <code class="command">list</code>
      command is the instruction pointer and can be found on line
      17.  Most developers will request having at least this
      information sent to them if you are unable to debug the problem
      yourself.  If, however, you do solve the problem, make sure that
      your patch winds its way into the source tree via a problem
      report, mailing lists, or by being able to commit it!</p><pre class="screen"> 1:<code class="prompt">#</code> <strong class="userinput"><code>cd /usr/obj/usr/src/sys/<em class="replaceable"><code>KERNCONF</code></em></code></strong>
 2:<code class="prompt">#</code> <strong class="userinput"><code>kgdb kernel.debug /var/crash/vmcore.0</code></strong>
 3:GNU gdb 5.2.1 (FreeBSD)
 4:Copyright 2002 Free Software Foundation, Inc.
 5:GDB is free software, covered by the GNU General Public License, and you are
 6:welcome to change it and/or distribute copies of it under certain conditions.
 7:Type "show copying" to see the conditions.
 8:There is absolutely no warranty for GDB.  Type "show warranty" for details.
 9:This GDB was configured as "i386-undermydesk-freebsd"...
10:panic: page fault
11:panic messages:
12:---
13:Fatal trap 12: page fault while in kernel mode
14:cpuid = 0; apic id = 00
15:fault virtual address   = 0x300
16:fault code:             = supervisor read, page not present
17:instruction pointer     = 0x8:0xc0713860
18:stack pointer           = 0x10:0xdc1d0b70
19:frame pointer           = 0x10:0xdc1d0b7c
20:code segment            = base 0x0, limit 0xfffff, type 0x1b
21:                        = DPL 0, pres 1, def32 1, gran 1
22:processor eflags        = resume, IOPL = 0
23:current process         = 14394 (uname)
24:trap number             = 12
25:panic: page fault
26      cpuid = 0;
27:Stack backtrace:
28
29:syncing disks, buffers remaining... 2199 2199 panic: mi_switch: switch in a critical section
30:cpuid = 0;
31:Uptime: 2h43m19s
32:Dumping 255 MB
33: 16 32 48 64 80 96 112 128 144 160 176 192 208 224 240
34:---
35:Reading symbols from /boot/kernel/snd_maestro3.ko...done.
36:Loaded symbols for /boot/kernel/snd_maestro3.ko
37:Reading symbols from /boot/kernel/snd_pcm.ko...done.
38:Loaded symbols for /boot/kernel/snd_pcm.ko
39:#0  doadump () at /usr/src/sys/kern/kern_shutdown.c:240
40:240             dumping++;
41:<code class="prompt">(kgdb)</code> <strong class="userinput"><code>list *0xc0713860</code></strong>
42:0xc0713860 is in lapic_ipi_wait (/usr/src/sys/i386/i386/local_apic.c:663).
43:658                     incr = 0;
44:659                     delay = 1;
45:660             } else
46:661                     incr = 1;
47:662             for (x = 0; x &lt; delay; x += incr) {
48:663                     if ((lapic-&gt;icr_lo &amp; APIC_DELSTAT_MASK) == APIC_DELSTAT_IDLE)
49:664                             return (1);
50:665                     ia32_pause();
51:666             }
52:667             return (0);
53:<code class="prompt">(kgdb)</code> <strong class="userinput"><code>backtrace</code></strong>
54:#0  doadump () at /usr/src/sys/kern/kern_shutdown.c:240
55:#1  0xc055fd9b in boot (howto=260) at /usr/src/sys/kern/kern_shutdown.c:372
56:#2  0xc056019d in panic () at /usr/src/sys/kern/kern_shutdown.c:550
57:#3  0xc0567ef5 in mi_switch () at /usr/src/sys/kern/kern_synch.c:470
58:#4  0xc055fa87 in boot (howto=256) at /usr/src/sys/kern/kern_shutdown.c:312
59:#5  0xc056019d in panic () at /usr/src/sys/kern/kern_shutdown.c:550
60:#6  0xc0720c66 in trap_fatal (frame=0xdc1d0b30, eva=0)
61:    at /usr/src/sys/i386/i386/trap.c:821
62:#7  0xc07202b3 in trap (frame=
63:      {tf_fs = -1065484264, tf_es = -1065484272, tf_ds = -1065484272, tf_edi = 1, tf_esi = 0, tf_ebp = -602076292, tf_isp = -602076324, tf_ebx = 0, tf_edx = 0, tf_ecx = 1000000, tf_eax = 243, tf_trapno = 12, tf_err = 0, tf_eip = -1066321824, tf_cs = 8, tf_eflags = 65671, tf_esp = 243, tf_ss = 0})
64:    at /usr/src/sys/i386/i386/trap.c:250
65:#8  0xc070c9f8 in calltrap () at {standard input}:94
66:#9  0xc07139f3 in lapic_ipi_vectored (vector=0, dest=0)
67:    at /usr/src/sys/i386/i386/local_apic.c:733
68:#10 0xc0718b23 in ipi_selected (cpus=1, ipi=1)
69:    at /usr/src/sys/i386/i386/mp_machdep.c:1115
70:#11 0xc057473e in kseq_notify (ke=0xcc05e360, cpu=0)
71:    at /usr/src/sys/kern/sched_ule.c:520
72:#12 0xc0575cad in sched_add (td=0xcbcf5c80)
73:    at /usr/src/sys/kern/sched_ule.c:1366
74:#13 0xc05666c6 in setrunqueue (td=0xcc05e360)
75:    at /usr/src/sys/kern/kern_switch.c:422
76:#14 0xc05752f4 in sched_wakeup (td=0xcbcf5c80)
77:    at /usr/src/sys/kern/sched_ule.c:999
78:#15 0xc056816c in setrunnable (td=0xcbcf5c80)
79:    at /usr/src/sys/kern/kern_synch.c:570
80:#16 0xc0567d53 in wakeup (ident=0xcbcf5c80)
81:    at /usr/src/sys/kern/kern_synch.c:411
82:#17 0xc05490a8 in exit1 (td=0xcbcf5b40, rv=0)
83:    at /usr/src/sys/kern/kern_exit.c:509
84:#18 0xc0548011 in sys_exit () at /usr/src/sys/kern/kern_exit.c:102
85:#19 0xc0720fd0 in syscall (frame=
86:      {tf_fs = 47, tf_es = 47, tf_ds = 47, tf_edi = 0, tf_esi = -1, tf_ebp = -1077940712, tf_isp = -602075788, tf_ebx = 672411944, tf_edx = 10, tf_ecx = 672411600, tf_eax = 1, tf_trapno = 12, tf_err = 2, tf_eip = 671899563, tf_cs = 31, tf_eflags = 642, tf_esp = -1077940740, tf_ss = 47})
87:    at /usr/src/sys/i386/i386/trap.c:1010
88:#20 0xc070ca4d in Xint0x80_syscall () at {standard input}:136
89:---Can't read userspace from dump, or kernel process---
90:<code class="prompt">(kgdb)</code> <strong class="userinput"><code>quit</code></strong></pre><div xmlns="" class="tip"><h3 class="admontitle">Tip: </h3><p xmlns="http://www.w3.org/1999/xhtml">If your system is crashing regularly and you are running
      out of disk space, deleting old <code class="filename">vmcore</code>
      files in <code class="filename">/var/crash</code> could save a
      considerable amount of disk space!</p></div></div><div class="sect1"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="kerneldebug-online-ddb"></a>10.3. On-Line Kernel Debugging Using DDB</h2></div></div></div><p>While <code class="command">kgdb</code> as an off-line debugger provides a very
      high level of user interface, there are some things it cannot do.  The
      most important ones being breakpointing and single-stepping kernel
      code.</p><p>If you need to do low-level debugging on your kernel, there is an
      on-line debugger available called DDB.  It allows setting of
      breakpoints, single-stepping kernel functions, examining and changing
      kernel variables, etc.  However, it cannot access kernel source files,
      and only has access to the global and static symbols, not to the full
      debug information like <code class="command">kgdb</code> does.</p><p>To configure your kernel to include DDB, add the options

      </p><pre class="programlisting">options KDB</pre><p>
      </p><pre class="programlisting">options DDB</pre><p>

      to your config file, and rebuild.  (See <a class="link" href="../../../../doc/en_US.ISO8859-1/books/handbook/index.html" target="_top">The FreeBSD Handbook</a> for details on
      configuring the FreeBSD kernel).</p><p>Once your DDB kernel is running, there are several ways to enter
      DDB.  The first, and earliest way is to use the boot flag
      <code class="option">-d</code>.  The kernel will start up
      in debug mode and enter DDB prior to any device probing.  Hence you can
      even debug the device probe/attach functions.  To use this, exit
      the loader's boot menu and enter <code class="command">boot -d</code> at
      the loader prompt.</p><p>The second scenario is to drop to the debugger once the
      system has booted.  There are two simple ways to accomplish
      this.  If you would like to break to the debugger from the
      command prompt, simply type the command:</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>sysctl debug.kdb.enter=1</code></strong></pre><p>Alternatively, if you are at the system console, you may use
      a hot-key on the keyboard.  The default break-to-debugger
      sequence is <span class="keycap"><strong>Ctrl</strong></span>+<span class="keycap"><strong>Alt</strong></span>+<span class="keycap"><strong>ESC</strong></span>.  For
      syscons, this sequence can be remapped and some of the
      distributed maps out there do this, so check to make sure you
      know the right sequence to use.  There is an option available
      for serial consoles that allows the use of a serial line BREAK on the
      console line to enter DDB (<code class="literal">options BREAK_TO_DEBUGGER</code>
      in the kernel config file).  It is not the default since there are a lot
      of serial adapters around that gratuitously generate a BREAK
      condition, for example when pulling the cable.</p><p>The third way is that any panic condition will branch to DDB if the
      kernel is configured to use it.  For this reason, it is not wise to
      configure a kernel with DDB for a machine running unattended.</p><p>To obtain the unattended functionality, add:</p><pre class="programlisting">options	KDB_UNATTENDED</pre><p>to the kernel configuration file and rebuild/reinstall.</p><p>The DDB commands roughly resemble some <code class="command">gdb</code>
      commands.  The first thing you probably need to do is to set a
      breakpoint:</p><pre class="screen"><strong class="userinput"><code>break function-name address</code></strong></pre><p>Numbers are taken hexadecimal by default, but to make them distinct
      from symbol names; hexadecimal numbers starting with the letters
      <code class="literal">a-f</code> need to be preceded with <code class="literal">0x</code>
      (this is optional for other numbers).  Simple expressions are allowed,
      for example: <code class="literal">function-name + 0x103</code>.</p><p>To exit the debugger and continue execution,
      type:</p><pre class="screen"><strong class="userinput"><code>continue</code></strong></pre><p>To get a stack trace of the current thread, use:</p><pre class="screen"><strong class="userinput"><code>trace</code></strong></pre><p>To get a stack trace of an arbitrary thread, specify a
      process ID or thread ID as a second argument to
      <code class="command">trace</code>.</p><p>If you want to remove a breakpoint, use</p><pre class="screen"><strong class="userinput"><code>del</code></strong>
<strong class="userinput"><code>del address-expression</code></strong></pre><p>The first form will be accepted immediately after a breakpoint hit,
      and deletes the current breakpoint.  The second form can remove any
      breakpoint, but you need to specify the exact address; this can be
      obtained from:</p><pre class="screen"><strong class="userinput"><code>show b</code></strong></pre><p>or:</p><pre class="screen"><strong class="userinput"><code>show break</code></strong></pre><p>To single-step the kernel, try:</p><pre class="screen"><strong class="userinput"><code>s</code></strong></pre><p>This will step into functions, but you can make DDB trace them until
      the matching return statement is reached by:</p><pre class="screen"><strong class="userinput"><code>n</code></strong></pre><div xmlns="" class="note"><h3 class="admontitle">Note: </h3><p xmlns="http://www.w3.org/1999/xhtml">This is different from <code class="command">gdb</code>'s
	<code class="command">next</code> statement; it is like <code class="command">gdb</code>'s
	<code class="command">finish</code>.  Pressing <span class="keycap"><strong>n</strong></span> more than once
        will cause a continue.</p></div><p>To examine data from memory, use (for example):

      </p><pre class="screen"><strong class="userinput"><code>x/wx 0xf0133fe0,40</code></strong>
<strong class="userinput"><code>x/hd db_symtab_space</code></strong>
<strong class="userinput"><code>x/bc termbuf,10</code></strong>
<strong class="userinput"><code>x/s stringbuf</code></strong></pre><p>

      for word/halfword/byte access, and hexadecimal/decimal/character/ string
      display.  The number after the comma is the object count.  To display
      the next 0x10 items, simply use:</p><pre class="screen"><strong class="userinput"><code>x ,10</code></strong></pre><p>Similarly, use

      </p><pre class="screen"><strong class="userinput"><code>x/ia foofunc,10</code></strong></pre><p>

      to disassemble the first 0x10 instructions of
      <code class="function">foofunc</code>, and display them along with their offset
      from the beginning of <code class="function">foofunc</code>.</p><p>To modify memory, use the write command:</p><pre class="screen"><strong class="userinput"><code>w/b termbuf 0xa 0xb 0</code></strong>
<strong class="userinput"><code>w/w 0xf0010030 0 0</code></strong></pre><p>The command modifier
      (<code class="literal">b</code>/<code class="literal">h</code>/<code class="literal">w</code>)
      specifies the size of the data to be written, the first following
      expression is the address to write to and the remainder is interpreted
      as data to write to successive memory locations.</p><p>If you need to know the current registers, use:</p><pre class="screen"><strong class="userinput"><code>show reg</code></strong></pre><p>Alternatively, you can display a single register value by e.g.

      </p><pre class="screen"><strong class="userinput"><code>p $eax</code></strong></pre><p>

      and modify it by:</p><pre class="screen"><strong class="userinput"><code>set $eax new-value</code></strong></pre><p>Should you need to call some kernel functions from DDB, simply
      say:</p><pre class="screen"><strong class="userinput"><code>call func(arg1, arg2, ...)</code></strong></pre><p>The return value will be printed.</p><p>For a <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=ps&amp;sektion=1&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">ps</span>(1)</span></a> style summary of all running processes, use:</p><pre class="screen"><strong class="userinput"><code>ps</code></strong></pre><p>Now you have examined why your kernel failed, and you wish to
      reboot.  Remember that, depending on the severity of previous
      malfunctioning, not all parts of the kernel might still be working as
      expected.  Perform one of the following actions to shut down and reboot
      your system:</p><pre class="screen"><strong class="userinput"><code>panic</code></strong></pre><p>This will cause your kernel to dump core and reboot, so you can
      later analyze the core on a higher level with <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=kgdb&amp;sektion=1&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">kgdb</span>(1)</span></a>.</p><pre class="screen"><strong class="userinput"><code>call boot(0)</code></strong></pre><p>Might be a good way to cleanly shut down the running system,
      <code class="function">sync()</code> all disks, and finally, in some cases,
      reboot.  As long as
      the disk and filesystem interfaces of the kernel are not damaged, this
      could be a good way for an almost clean shutdown.</p><pre class="screen"><strong class="userinput"><code>reset</code></strong></pre><p>This is the final way out of disaster and almost the same as hitting the
      Big Red Button.</p><p>If you need a short command summary, simply type:</p><pre class="screen"><strong class="userinput"><code>help</code></strong></pre><p>It is highly recommended to have a printed copy of the
	<a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=ddb&amp;sektion=4&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">ddb</span>(4)</span></a> manual page ready for a debugging
      session.  Remember that it is hard to read the on-line manual while
      single-stepping the kernel.</p></div><div class="sect1"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="kerneldebug-online-gdb"></a>10.4. On-Line Kernel Debugging Using Remote GDB</h2></div></div></div><p>This feature has been supported since FreeBSD 2.2, and it is
      actually a very neat one.</p><p>GDB has already supported <span class="emphasis"><em>remote debugging</em></span> for
      a long time.  This is done using a very simple protocol along a serial
      line.  Unlike the other methods described above, you will need two
      machines for doing this.  One is the host providing the debugging
      environment, including all the sources, and a copy of the kernel binary
      with all the symbols in it, and the other one is the target machine that
      simply runs a similar copy of the very same kernel (but stripped of the
      debugging information).</p><p>You should configure the kernel in question with <code class="command">config
	-g</code> if building the <span class="quote">&#8220;<span class="quote">traditional</span>&#8221;</span> way.  If
      building the <span class="quote">&#8220;<span class="quote">new</span>&#8221;</span> way, make sure that
      <code class="literal">makeoptions DEBUG=-g</code> is in the configuration.
      In both cases, include <code class="option">DDB</code> in the configuration, and
      compile it as usual.  This gives a large binary, due to the
      debugging information.  Copy this kernel to the target machine, strip
      the debugging symbols off with <code class="command">strip -x</code>, and boot it
      using the <code class="option">-d</code> boot option.  Connect the serial line
      of the target machine that has "flags 080" set on its uart device
      to any serial line of the debugging host.  See <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=uart&amp;sektion=4&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">uart</span>(4)</span></a> for
      information on how to set the flags on an uart device.
      Now, on the debugging machine, go to the compile directory of the target
      kernel, and start <code class="command">gdb</code>:</p><pre class="screen"><code class="prompt">%</code> <strong class="userinput"><code>kgdb kernel</code></strong>
GDB is free software and you are welcome to distribute copies of it
 under certain conditions; type "show copying" to see the conditions.
There is absolutely no warranty for GDB; type "show warranty" for details.
GDB 4.16 (i386-unknown-freebsd),
Copyright 1996 Free Software Foundation, Inc...
<code class="prompt">(kgdb)</code> </pre><p>Initialize the remote debugging session (assuming the first serial
      port is being used) by:</p><pre class="screen"><code class="prompt">(kgdb)</code> <strong class="userinput"><code>target remote /dev/cuau0</code></strong></pre><p>Now, on the target host (the one that entered DDB right before even
      starting the device probe), type:</p><pre class="screen">Debugger("Boot flags requested debugger")
Stopped at Debugger+0x35: movb	$0, edata+0x51bc
<code class="prompt">db&gt;</code> <strong class="userinput"><code>gdb</code></strong></pre><p>DDB will respond with:</p><pre class="screen">Next trap will enter GDB remote protocol mode</pre><p>Every time you type <code class="command">gdb</code>, the mode will be toggled
      between remote GDB and local DDB.  In order to force a next trap
      immediately, simply type <code class="command">s</code> (step).  Your hosting GDB
      will now gain control over the target kernel:</p><pre class="screen">Remote debugging using /dev/cuau0
Debugger (msg=0xf01b0383 "Boot flags requested debugger")
    at ../../i386/i386/db_interface.c:257
<code class="prompt">(kgdb)</code></pre><p>You can use this session almost as any other GDB session, including
      full access to the source, running it in gud-mode inside an Emacs window
      (which gives you an automatic source code display in another Emacs
      window), etc.</p></div><div class="sect1"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="kerneldebug-console"></a>10.5. Debugging a Console Driver</h2></div></div></div><p>Since you need a console driver to run DDB on, things are more
      complicated if the console driver itself is failing.  You might remember
      the use of a serial console (either with modified boot blocks, or by
      specifying <code class="option">-h</code> at the <code class="prompt">Boot:</code> prompt),
      and hook up a standard terminal onto your first serial port.  DDB works
      on any configured console driver, including a serial
      console.</p></div><div class="sect1"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="kerneldebug-deadlocks"></a>10.6. Debugging Deadlocks</h2></div></div></div><p>You may experience so called deadlocks, a situation where
      a system stops doing useful work.  To provide a helpful bug
      report in this situation, use <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=ddb&amp;sektion=4&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">ddb</span>(4)</span></a> as described in the
      previous section.  Include the output of <code class="command">ps</code>
      and <code class="command">trace</code> for suspected processes in the
      report.</p><p>If possible, consider doing further investigation.  The
      recipe below is especially useful if you suspect that a deadlock
      occurs in the VFS layer.  Add these options to the kernel
      configuration file.</p><pre class="programlisting">makeoptions 	DEBUG=-g
options 	INVARIANTS
options 	INVARIANT_SUPPORT
options 	WITNESS
options 	WITNESS_SKIPSPIN
options 	DEBUG_LOCKS
options 	DEBUG_VFS_LOCKS
options 	DIAGNOSTIC</pre><p>When a deadlock occurs, in addition to the output of the
      <code class="command">ps</code> command, provide information from the
      <code class="command">show pcpu</code>, <code class="command">show allpcpu</code>,
      <code class="command">show locks</code>, <code class="command">show alllocks</code>,
      <code class="command">show lockedvnods</code> and
      <code class="command">alltrace</code>.</p><p>To obtain meaningful backtraces for threaded processes, use
      <code class="command">thread thread-id</code> to switch to the thread
      stack, and do a backtrace with <code class="command">where</code>.</p></div><div class="sect1"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="kerneldebug-dcons"></a>10.7. Kernel debugging with Dcons</h2></div></div></div><p><a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=dcons&amp;sektion=4&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">dcons</span>(4)</span></a> is a very simple console driver that is
      not directly connected with any physical devices.  It just reads
      and writes characters from and to a buffer in a kernel or
      loader.  Due to its simple nature, it is very useful for kernel
      debugging, especially with a <span class="trademark">FireWire</span>® device.  Currently, FreeBSD
      provides two ways to interact with the buffer from outside of
      the kernel using <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=dconschat&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">dconschat</span>(8)</span></a>.</p><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp50873080"></a>10.7.1. Dcons over <span class="trademark">FireWire</span>®</h3></div></div></div><p>Most <span class="trademark">FireWire</span>® (IEEE1394) host controllers are
	based on the <acronym class="acronym">OHCI</acronym> specification that
	supports physical access to the host memory.  This means that
	once the host controller is initialized, we can access the
	host memory without the help of software (kernel).   We can
	exploit this facility for interaction with <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=dcons&amp;sektion=4&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">dcons</span>(4)</span></a>.
	<a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=dcons&amp;sektion=4&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">dcons</span>(4)</span></a> provides similar functionality as a serial
	console.  It emulates two serial ports, one for the console
	and <acronym class="acronym">DDB</acronym>, the other for
	<acronym class="acronym">GDB</acronym>.  Because remote memory access is fully
	handled by the hardware, the <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=dcons&amp;sektion=4&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">dcons</span>(4)</span></a> buffer is
	accessible even when the system crashes.</p><p><span class="trademark">FireWire</span>® devices are not limited to those
	integrated into motherboards.  <acronym class="acronym">PCI</acronym> cards
	exist for desktops, and a cardbus interface can be purchased
	for laptops.</p><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp51182712"></a>10.7.1.1. Enabling <span class="trademark">FireWire</span>® and Dcons support on the target
	  machine</h4></div></div></div><p>To enable <span class="trademark">FireWire</span>® and Dcons support in the kernel of
	  the <span class="emphasis"><em>target machine</em></span>:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Make sure your kernel supports
	      <code class="literal">dcons</code>, <code class="literal">dcons_crom</code>
	      and <code class="literal">firewire</code>.
	      <code class="literal">Dcons</code> should be statically linked
	      with the kernel.  For <code class="literal">dcons_crom</code> and
	      <code class="literal">firewire</code>, modules should be
	      OK.</p></li><li class="listitem"><p>Make sure physical <acronym class="acronym">DMA</acronym> is enabled.
	      You may need to add
	      <code class="literal">hw.firewire.phydma_enable=1</code> to
	      <code class="filename">/boot/loader.conf</code>.</p></li><li class="listitem"><p>Add options for debugging.</p></li><li class="listitem"><p>Add <code class="literal">dcons_gdb=1</code> in
	      <code class="filename">/boot/loader.conf</code> if you use GDB
	      over <span class="trademark">FireWire</span>®.</p></li><li class="listitem"><p>Enable <code class="literal">dcons</code> in
	      <code class="filename">/etc/ttys</code>.</p></li><li class="listitem"><p>Optionally, to force <code class="literal">dcons</code> to
	      be the high-level console, add 
	      <code class="literal">hw.firewire.dcons_crom.force_console=1</code> 
	      to <code class="filename">loader.conf</code>.</p></li></ul></div><p>To enable <span class="trademark">FireWire</span>® and Dcons support in <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=loader&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">loader</span>(8)</span></a>
	  on i386 or amd64:</p><p>Add
	  <code class="literal">LOADER_FIREWIRE_SUPPORT=YES</code> in
	  <code class="filename">/etc/make.conf</code> and rebuild
	  <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=loader&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">loader</span>(8)</span></a>:</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>cd /sys/boot/i386 &amp;&amp; make clean &amp;&amp; make &amp;&amp; make install</code></strong></pre><p>To enable <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=dcons&amp;sektion=4&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">dcons</span>(4)</span></a> as an active low-level
	  console, add <code class="literal">boot_multicons="YES"</code> to 
	  <code class="filename">/boot/loader.conf</code>.</p><p>Here are a few configuration examples.  A sample kernel
	  configuration file would contain:</p><pre class="screen">device dcons
device dcons_crom
options KDB
options DDB
options GDB
options ALT_BREAK_TO_DEBUGGER</pre><p>And a sample <code class="filename">/boot/loader.conf</code>
	  would contain:</p><pre class="screen">dcons_crom_load="YES"
dcons_gdb=1
boot_multicons="YES"
hw.firewire.phydma_enable=1
hw.firewire.dcons_crom.force_console=1</pre></div><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp51221752"></a>10.7.1.2. Enabling <span class="trademark">FireWire</span>® and Dcons support on the host
	  machine</h4></div></div></div><p>To enable <span class="trademark">FireWire</span>® support in the kernel on the
	  <span class="emphasis"><em>host machine</em></span>:</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>kldload firewire</code></strong></pre><p>Find out the <acronym class="acronym">EUI64</acronym> (the unique 64
	  bit identifier) of the <span class="trademark">FireWire</span>® host controller, and
	  use <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=fwcontrol&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">fwcontrol</span>(8)</span></a> or <code class="command">dmesg</code> to
	  find the <acronym class="acronym">EUI64</acronym> of the target machine.</p><p>Run <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=dconschat&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">dconschat</span>(8)</span></a>, with:</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>dconschat -e \# -br -G 12345 -t <em class="replaceable"><code>00-11-22-33-44-55-66-77</code></em></code></strong></pre><p>The following key combinations can be used once
	  <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=dconschat&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">dconschat</span>(8)</span></a> is running:</p><div class="informaltable"><table class="informaltable" width="100%" border="1"><colgroup><col /><col /></colgroup><tbody><tr><td>
		  <span class="keycap"><strong>~</strong></span> <span class="keycap"><strong>.</strong></span>
		</td><td>Disconnect</td></tr><tr><td>
		  <span class="keycap"><strong>~</strong></span> <span class="keycap"><strong>Ctrl</strong></span>+<span class="keycap"><strong>B</strong></span>
		</td><td>ALT BREAK</td></tr><tr><td>
		  <span class="keycap"><strong>~</strong></span> <span class="keycap"><strong>Ctrl</strong></span>+<span class="keycap"><strong>R</strong></span>
		</td><td>RESET target</td></tr><tr><td>
		  <span class="keycap"><strong>~</strong></span> <span class="keycap"><strong>Ctrl</strong></span>+<span class="keycap"><strong>Z</strong></span>
		</td><td>Suspend dconschat</td></tr></tbody></table></div><p>Attach remote <acronym class="acronym">GDB</acronym> by starting
	  <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=kgdb&amp;sektion=1&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">kgdb</span>(1)</span></a> with a remote debugging session:</p><pre class="screen"><strong class="userinput"><code>kgdb -r :12345 kernel</code></strong></pre></div><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp51263736"></a>10.7.1.3. Some general tips</h4></div></div></div><p>Here are some general tips:</p><p>To take full advantage of the speed of <span class="trademark">FireWire</span>®,
	  disable other slow console drivers:</p><pre class="screen"><code class="prompt">#</code> conscontrol delete ttyd0	     # serial console
<code class="prompt">#</code> conscontrol delete consolectl	# video/keyboard</pre><p>There exists a <acronym class="acronym">GDB</acronym> mode for
	  <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=emacs&amp;sektion=1&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">emacs</span>(1)</span></a>; this is what you will need to add to your
	  <code class="filename">.emacs</code>:</p><pre class="screen"><strong class="userinput"><code>(setq gud-gdba-command-name "kgdb -a -a -a -r :12345")
(setq gdb-many-windows t)
(xterm-mouse-mode 1)
M-x gdba</code></strong></pre><p>And for <acronym class="acronym">DDD</acronym> (<code class="filename">devel/ddd</code>):</p><pre class="screen"># remote serial protocol
LANG=C ddd --debugger kgdb -r :12345 kernel
# live core debug
LANG=C ddd --debugger kgdb kernel /dev/fwmem0.2</pre></div></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp51271032"></a>10.7.2. Dcons with KVM</h3></div></div></div><p>We can directly read the <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=dcons&amp;sektion=4&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">dcons</span>(4)</span></a> buffer via
	<code class="filename">/dev/mem</code> for live systems, and in the
	core dump for crashed systems.  These give you similar output
	to <code class="command">dmesg -a</code>, but the <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=dcons&amp;sektion=4&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">dcons</span>(4)</span></a> buffer
	includes more information.</p><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp51278456"></a>10.7.2.1. Using Dcons with KVM</h4></div></div></div><p>To use <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=dcons&amp;sektion=4&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">dcons</span>(4)</span></a> with <acronym class="acronym">KVM</acronym>:</p><p>Dump a <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=dcons&amp;sektion=4&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">dcons</span>(4)</span></a> buffer of a live system:</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>dconschat -1</code></strong></pre><p>Dump a <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=dcons&amp;sektion=4&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">dcons</span>(4)</span></a> buffer of a crash dump:</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>dconschat -1 -M vmcore.XX</code></strong></pre><p>Live core debugging can be done via:</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>fwcontrol -m target_eui64</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>kgdb kernel /dev/fwmem0.2</code></strong></pre></div></div></div><div class="sect1"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="kerneldebug-options"></a>10.8. Glossary of Kernel Options for Debugging</h2></div></div></div><p>This section provides a brief glossary of compile-time kernel
      options used for debugging:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p><code class="literal">options KDB</code>: compiles in the kernel
	  debugger framework.  Required for <code class="literal">options DDB</code>
	  and <code class="literal">options GDB</code>.  Little or no performance
	  overhead.  By default, the debugger will be entered on panic
	  instead of an automatic reboot.</p></li><li class="listitem"><p><code class="literal">options KDB_UNATTENDED</code>: change the default
	  value of the <code class="literal">debug.debugger_on_panic</code> sysctl to
	  0, which controls whether the debugger is entered on panic.  When
	  <code class="literal">options KDB</code> is not compiled into the kernel, the
	  behavior is to automatically reboot on panic; when it is compiled
	  into the kernel, the default behavior is to drop into the debugger
	  unless <code class="literal">options KDB_UNATTENDED</code> is compiled in.
	  If you want to leave the kernel debugger compiled into the kernel
	  but want the system to come back up unless you're on-hand to use
	  the debugger for diagnostics, use this option.</p></li><li class="listitem"><p><code class="literal">options KDB_TRACE</code>: change the default value
	  of the <code class="literal">debug.trace_on_panic</code> sysctl to 1, which
	  controls whether the debugger automatically prints a stack trace
	  on panic.  Especially if running with <code class="literal">options
	  KDB_UNATTENDED</code>, this can be helpful to gather basic
	  debugging information on the serial or firewire console while
	  still rebooting to recover.</p></li><li class="listitem"><p><code class="literal">options DDB</code>: compile in support for the
	  console debugger, DDB.  This interactive debugger runs on whatever
	  the active low-level console of the system is, which includes the
	  video console, serial console, or firewire console.  It provides
	  basic integrated debugging facilities, such as stack tracing,
	  process and thread listing, dumping of lock state, VM state, file
	  system state, and kernel memory management.  DDB does not require
	  software running on a second machine or being able to generate a
	  core dump or full debugging kernel symbols, and provides detailed
	  diagnostics of the kernel at run-time.  Many bugs can be fully
	  diagnosed using only DDB output.  This option depends on
	  <code class="literal">options KDB</code>.</p></li><li class="listitem"><p><code class="literal">options GDB</code>: compile in support for the
	  remote debugger, GDB, which can operate over serial cable or
	  firewire.  When the debugger is entered, GDB may be attached to
	  inspect structure contents, generate stack traces, etc.  Some
	  kernel state is more awkward to access than in DDB, which is able
	  to generate useful summaries of kernel state automatically, such
	  as automatically walking lock debugging or kernel memory
	  management structures, and a second machine running the debugger
	  is required.  On the other hand, GDB combines information from
	  the kernel source and full debugging symbols, and is aware of full
	  data structure definitions, local variables, and is scriptable.
	  This option is not required to run GDB on a kernel core dump.
	  This option depends on <code class="literal">options KDB</code>.
	  </p></li><li class="listitem"><p><code class="literal">options BREAK_TO_DEBUGGER</code>, <code class="literal">options
	  ALT_BREAK_TO_DEBUGGER</code>: allow a break signal or
	  alternative signal on the console to enter the debugger.  If the
	  system hangs without a panic, this is a useful way to reach the
	  debugger.  Due to the current kernel locking, a break signal
	  generated on a serial console is significantly more reliable at
	  getting into the debugger, and is generally recommended.  This
	  option has little or no performance impact.</p></li><li class="listitem"><p><code class="literal">options INVARIANTS</code>: compile into the kernel
	  a large number of run-time assertion checks and tests, which
	  constantly test the integrity of kernel data structures and the
	  invariants of kernel algorithms.  These tests can be expensive, so
	  are not compiled in by default, but help provide useful "fail stop"
	  behavior, in which certain classes of undesired behavior enter the
	  debugger before kernel data corruption occurs, making them easier
	  to debug.  Tests include memory scrubbing and use-after-free
	  testing, which is one of the more significant sources of overhead.
	  This option depends on <code class="literal">options INVARIANT_SUPPORT</code>.
	  </p></li><li class="listitem"><p><code class="literal">options INVARIANT_SUPPORT</code>: many of the tests
	  present in <code class="literal">options INVARIANTS</code> require modified
	  data structures or additional kernel symbols to be defined.</p></li><li class="listitem"><p><code class="literal">options WITNESS</code>: this option enables run-time
	  lock order tracking and verification, and is an invaluable tool for
	  deadlock diagnosis.  WITNESS maintains a graph of acquired lock
	  orders by lock type, and checks the graph at each acquire for
	  cycles (implicit or explicit).  If a cycle is detected, a warning
	  and stack trace are generated to the console, indicating that a
	  potential deadlock might have occurred.  WITNESS is required in
	  order to use the <code class="command">show locks</code>, <code class="command">show
	  witness</code> and <code class="command">show alllocks</code> DDB
	  commands.  This debug option has significant performance overhead,
	  which may be somewhat mitigated through the use of <code class="literal">options
	  WITNESS_SKIPSPIN</code>.  Detailed documentation may be found in
	  <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=witness&amp;sektion=4&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">witness</span>(4)</span></a>.</p></li><li class="listitem"><p><code class="literal">options WITNESS_SKIPSPIN</code>: disable run-time
	  checking of spinlock lock order with WITNESS.  As spin locks are
	  acquired most frequently in the scheduler, and scheduler events
	  occur often, this option can significantly speed up systems
	  running with WITNESS.  This option depends on <code class="literal">options
	  WITNESS</code>.</p></li><li class="listitem"><p><code class="literal">options WITNESS_KDB</code>: change the default
	  value of the <code class="literal">debug.witness.kdb</code> sysctl to 1,
	  which causes WITNESS to enter the debugger when a lock order
	  violation is detected, rather than simply printing a warning.  This
	  option depends on <code class="literal">options WITNESS</code>.</p></li><li class="listitem"><p><code class="literal">options SOCKBUF_DEBUG</code>: perform extensive
	  run-time consistency checking on socket buffers, which can be
	  useful for debugging both socket bugs and race conditions in
	  protocols and device drivers that interact with sockets.  This
	  option significantly impacts network performance, and may change
	  the timing in device driver races.</p></li><li class="listitem"><p><code class="literal">options DEBUG_VFS_LOCKS</code>: track lock
	  acquisition points for lockmgr/vnode locks, expanding the amount
	  of information displayed by <code class="command">show lockedvnods</code>
	  in DDB.  This option has a measurable performance impact.</p></li><li class="listitem"><p><code class="literal">options DEBUG_MEMGUARD</code>: a replacement for
	  the <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=malloc&amp;sektion=9&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">malloc</span>(9)</span></a> kernel memory allocator that uses the VM system
	  to detect reads or writes from allocated memory after free.
	  Details may be found in <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=memguard&amp;sektion=9&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">memguard</span>(9)</span></a>.  This option has a
	  significant performance impact, but can be very helpful in
	  debugging kernel memory corruption bugs.</p></li><li class="listitem"><p><code class="literal">options DIAGNOSTIC</code>: enable additional, more
	  expensive diagnostic tests along the lines of <code class="literal">options
	  INVARIANTS</code>.</p></li></ul></div></div></div></div><div class="part"><div xmlns="" class="titlepage"><div><div><h1 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="architectures"></a>Part IV. Architectures</h1></div></div></div><div class="toc"><div class="toc-title">Table of Contents</div><dl class="toc"><dt><span class="chapter"><a href="#x86">11. x86 Assembly Language Programming</a></span></dt><dd><dl><dt><span class="sect1"><a href="#x86-intro">11.1. Synopsis</a></span></dt><dt><span class="sect1"><a href="#x86-the-tools">11.2. The Tools</a></span></dt><dt><span class="sect1"><a href="#x86-system-calls">11.3. System Calls</a></span></dt><dt><span class="sect1"><a href="#x86-return-values">11.4. Return Values</a></span></dt><dt><span class="sect1"><a href="#x86-portable-code">11.5. Creating Portable Code</a></span></dt><dt><span class="sect1"><a href="#x86-first-program">11.6. Our First Program</a></span></dt><dt><span class="sect1"><a href="#x86-unix-filters">11.7. Writing <span class="trademark">UNIX</span>® Filters</a></span></dt><dt><span class="sect1"><a href="#x86-buffered-io">11.8. Buffered Input and Output</a></span></dt><dt><span class="sect1"><a href="#x86-command-line">11.9. Command Line Arguments</a></span></dt><dt><span class="sect1"><a href="#x86-environment">11.10. <span class="trademark">UNIX</span>® Environment</a></span></dt><dt><span class="sect1"><a href="#x86-files">11.11. Working with Files</a></span></dt><dt><span class="sect1"><a href="#x86-one-pointed-mind">11.12. One-Pointed Mind</a></span></dt><dt><span class="sect1"><a href="#x86-fpu">11.13. Using the <acronym class="acronym">FPU</acronym></a></span></dt><dt><span class="sect1"><a href="#x86-caveats">11.14. Caveats</a></span></dt><dt><span class="sect1"><a href="#x86-acknowledgements">11.15. Acknowledgements</a></span></dt></dl></dd></dl></div><div class="chapter"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="x86"></a>Chapter 11. x86 Assembly Language Programming</h2></div></div></div><div class="toc"><div class="toc-title">Table of Contents</div><dl class="toc"><dt><span class="sect1"><a href="#x86-intro">11.1. Synopsis</a></span></dt><dt><span class="sect1"><a href="#x86-the-tools">11.2. The Tools</a></span></dt><dt><span class="sect1"><a href="#x86-system-calls">11.3. System Calls</a></span></dt><dt><span class="sect1"><a href="#x86-return-values">11.4. Return Values</a></span></dt><dt><span class="sect1"><a href="#x86-portable-code">11.5. Creating Portable Code</a></span></dt><dt><span class="sect1"><a href="#x86-first-program">11.6. Our First Program</a></span></dt><dt><span class="sect1"><a href="#x86-unix-filters">11.7. Writing <span class="trademark">UNIX</span>® Filters</a></span></dt><dt><span class="sect1"><a href="#x86-buffered-io">11.8. Buffered Input and Output</a></span></dt><dt><span class="sect1"><a href="#x86-command-line">11.9. Command Line Arguments</a></span></dt><dt><span class="sect1"><a href="#x86-environment">11.10. <span class="trademark">UNIX</span>® Environment</a></span></dt><dt><span class="sect1"><a href="#x86-files">11.11. Working with Files</a></span></dt><dt><span class="sect1"><a href="#x86-one-pointed-mind">11.12. One-Pointed Mind</a></span></dt><dt><span class="sect1"><a href="#x86-fpu">11.13. Using the <acronym class="acronym">FPU</acronym></a></span></dt><dt><span class="sect1"><a href="#x86-caveats">11.14. Caveats</a></span></dt><dt><span class="sect1"><a href="#x86-acknowledgements">11.15. Acknowledgements</a></span></dt></dl></div><p><span class="emphasis"><em>This chapter was written by
      G. Adam Stanislav <code class="email">&lt;<a xmlns="" class="email" href="mailto:adam@redprince.net">adam@redprince.net</a>&gt;</code>.</em></span></p><div class="sect1"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="x86-intro"></a>11.1. Synopsis</h2></div></div></div><p>Assembly language programming under <span class="trademark">UNIX</span>® is highly
      undocumented.  It is generally assumed that no one would ever
      want to use it because various <span class="trademark">UNIX</span>® systems run on different
      microprocessors, so everything should be written in C for
      portability.</p><p>In reality, C portability is quite a myth.  Even C programs
      need to be modified when ported from one <span class="trademark">UNIX</span>® to another,
      regardless of what processor each runs on.  Typically, such a
      program is full of conditional statements depending on the
      system it is compiled for.</p><p>Even if we believe that all of <span class="trademark">UNIX</span>® software should be
      written in C, or some other high-level language, we still need
      assembly language programmers: Who else would write the section
      of C library that accesses the kernel?</p><p>In this chapter I will attempt to show you how you can use
      assembly language writing <span class="trademark">UNIX</span>® programs, specifically under
      FreeBSD.</p><p>This chapter does not explain the basics of assembly
      language.  There are enough resources about that (for a complete
      online course in assembly language, see Randall Hyde's <a class="link" href="http://webster.cs.ucr.edu/" target="_top">Art of Assembly
	Language</a>; or if you prefer a printed book, take a look
      at Jeff Duntemann's Assembly Language Step-by-Step (ISBN:
      0471375233).  However, once the chapter is finished, any
      assembly language programmer will be able to write programs for
      FreeBSD quickly and efficiently.</p><p>Copyright © 2000-2001 G. Adam Stanislav.  All rights
      reserved.</p></div><div class="sect1"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="x86-the-tools"></a>11.2. The Tools</h2></div></div></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="x86-the-assembler"></a>11.2.1. The Assembler</h3></div></div></div><p>The most important tool for assembly language programming
	is the assembler, the software that converts assembly language
	code into machine language.</p><p>Two very different assemblers are available for FreeBSD.
	One is
	<a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=as&amp;sektion=1&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">as</span>(1)</span></a>,
	which uses the traditional <span class="trademark">UNIX</span>® assembly language syntax.
	It comes with the system.</p><p>The other is
	<span class="application">/usr/ports/devel/nasm</span>.  It uses the
	Intel syntax.  Its main advantage is that it can assemble code
	for many operating systems.  It needs to be installed
	separately, but is completely free.</p><p>This chapter uses <span class="application">nasm</span> syntax
	because most assembly language programmers coming to FreeBSD
	from other operating systems will find it easier to
	understand.  And, because, quite frankly, that is what I am
	used to.</p></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="x86-the-linker"></a>11.2.2. The Linker</h3></div></div></div><p>The output of the assembler, like that of any compiler,
	needs to be linked to form an executable file.</p><p>The standard
	<a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=ld&amp;sektion=1&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">ld</span>(1)</span></a>
	linker comes with FreeBSD.  It works with the code assembled
	with either assembler.</p></div></div><div class="sect1"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="x86-system-calls"></a>11.3. System Calls</h2></div></div></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="x86-default-calling-convention"></a>11.3.1. Default Calling Convention</h3></div></div></div><p>By default, the FreeBSD kernel uses the C calling
	convention.  Further, although the kernel is accessed using
	<code class="function">int 80h</code>, it is assumed the
	program will call a function that issues <code class="function">int 80h</code>, rather than issuing
	<code class="function">int 80h</code> directly.</p><p>This convention is very convenient, and quite superior to
	the <span class="trademark">Microsoft</span>® convention used by
	<acronym class="acronym"><span class="trademark">MS-DOS</span>®</acronym>.  Why? Because the <span class="trademark">UNIX</span>®
	convention allows any program written in any language to
	access the kernel.</p><p>An assembly language program can do that as well.  For
	example, we could open a file:</p><pre class="programlisting">kernel:
	int	80h	; Call kernel
	ret

open:
	push	dword mode
	push	dword flags
	push	dword path
	mov	eax, 5
	call	kernel
	add	esp, byte 12
	ret</pre><p>This is a very clean and portable way of coding.  If you
	need to port the code to a <span class="trademark">UNIX</span>® system which uses a
	different interrupt, or a different way of passing parameters,
	all you need to change is the kernel procedure.</p><p>But assembly language programmers like to shave off
	cycles.  The above example requires a <code class="function">call/ret</code> combination.  We can
	eliminate it by <code class="function">push</code>ing an
	extra dword:</p><pre class="programlisting">open:
	push	dword mode
	push	dword flags
	push	dword path
	mov	eax, 5
	push	eax		; Or any other dword
	int	80h
	add	esp, byte 16</pre><p>The <code class="constant">5</code> that we have placed in <code class="varname">EAX</code> identifies the kernel
	function, in this case <code class="function">open</code>.</p></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="x86-alternate-calling-convention"></a>11.3.2. Alternate Calling Convention</h3></div></div></div><p>FreeBSD is an extremely flexible system.  It offers other
	ways of calling the kernel.  For it to work, however, the
	system must have Linux emulation installed.</p><p>Linux is a <span class="trademark">UNIX</span>® like system.  However, its kernel uses
	the same system-call convention of passing parameters in
	registers <acronym class="acronym"><span class="trademark">MS-DOS</span>®</acronym> does.  As with the
	<span class="trademark">UNIX</span>® convention, the function number is placed in <code class="varname">EAX</code>.  The parameters, however, are
	not passed on the stack but in <code class="varname">EBX,
	  ECX, EDX, ESI, EDI, EBP</code>:</p><pre class="programlisting">open:
	mov	eax, 5
	mov	ebx, path
	mov	ecx, flags
	mov	edx, mode
	int	80h</pre><p>This convention has a great disadvantage over the <span class="trademark">UNIX</span>®
	way, at least as far as assembly language programming is
	concerned: Every time you make a kernel call you must
	<code class="function">push</code> the registers, then
	<code class="function">pop</code> them later.  This makes
	your code bulkier and slower.  Nevertheless, FreeBSD gives you
	a choice.</p><p>If you do choose the Linux convention, you must let the
	system know about it.  After your program is assembled and
	linked, you need to brand the executable:</p><pre class="screen"><code class="prompt">%</code> <strong class="userinput"><code>brandelf -t Linux <em class="replaceable"><code>filename</code></em></code></strong></pre></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="x86-use-geneva"></a>11.3.3. Which Convention Should You Use?</h3></div></div></div><p>If you are coding specifically for FreeBSD, you should
	always use the <span class="trademark">UNIX</span>® convention: It is faster, you can store
	global variables in registers, you do not have to brand the
	executable, and you do not impose the installation of the
	Linux emulation package on the target system.</p><p>If you want to create portable code that can also run on
	Linux, you will probably still want to give the FreeBSD users
	as efficient a code as possible.  I will show you how you can
	accomplish that after I have explained the basics.</p></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="x86-call-numbers"></a>11.3.4. Call Numbers</h3></div></div></div><p>To tell the kernel which system service you are calling,
	place its number in <code class="varname">EAX</code>.
	Of course, you need to know what the number is.</p><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="x86-the-syscalls-file"></a>11.3.4.1. The <code class="filename">syscalls</code> File</h4></div></div></div><p>The numbers are listed in <code class="filename">syscalls</code>.
	  <code class="command">locate syscalls</code> finds this file in
	  several different formats, all produced automatically from
	  <code class="filename">syscalls.master</code>.</p><p>You can find the master file for the default <span class="trademark">UNIX</span>®
	  calling convention in
	  <code class="filename">/usr/src/sys/kern/syscalls.master</code>.  If
	  you need to use the other convention implemented in the
	  Linux emulation mode, read
	  <code class="filename">/usr/src/sys/i386/linux/syscalls.master</code>.</p><div xmlns="" class="note"><h3 class="admontitle">Note: </h3><p xmlns="http://www.w3.org/1999/xhtml">Not only do FreeBSD and Linux use different calling
	    conventions, they sometimes use different numbers for the
	    same functions.</p></div><p><code class="filename">syscalls.master</code> describes how the
	  call is to be made:</p><pre class="programlisting">0	STD	NOHIDE	{ int nosys(void); } syscall nosys_args int
1	STD	NOHIDE	{ void exit(int rval); } exit rexit_args void
2	STD	POSIX	{ int fork(void); }
3	STD	POSIX	{ ssize_t read(int fd, void *buf, size_t nbyte); }
4	STD	POSIX	{ ssize_t write(int fd, const void *buf, size_t nbyte); }
5	STD	POSIX	{ int open(char *path, int flags, int mode); }
6	STD	POSIX	{ int close(int fd); }
etc...</pre><p>It is the leftmost column that tells us the number to
	place in <code class="varname">EAX</code>.</p><p>The rightmost column tells us what parameters to <code class="function">push</code>.  They are <code class="function">push</code>ed <span class="emphasis"><em>from right to
	  left</em></span>.</p><div class="informalexample"><p>For example, to <code class="function">open</code> a file, we
	  need to <code class="function">push</code> the
	  <code class="varname">mode</code> first, then
	  <code class="varname">flags</code>, then the address at which the
	  <code class="varname">path</code> is stored.</p></div></div></div></div><div class="sect1"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="x86-return-values"></a>11.4. Return Values</h2></div></div></div><p>A system call would not be useful most of the time if it did
    not return some kind of a value: The file descriptor of an open
    file, the number of bytes read to a buffer, the system time,
    etc.</p><p>Additionally, the system needs to inform us if an error
    occurs: A file does not exist, system resources are exhausted, we
    passed an invalid parameter, etc.</p><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="x86-man-pages"></a>11.4.1. Man Pages</h3></div></div></div><p>The traditional place to look for information about various
      system calls under <span class="trademark">UNIX</span>® systems are the manual pages.  FreeBSD
      describes its system calls in section 2, sometimes in section
      3.</p><p>For example,
      <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=open&amp;sektion=2&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">open</span>(2)</span></a>
      says:</p><div class="blockquote"><blockquote class="blockquote"><p>If successful, <code class="function">open()</code> returns a
	non-negative integer, termed a file descriptor.  It returns
	<code class="varname">-1</code> on failure, and sets
	<code class="varname">errno</code> to indicate the error.</p></blockquote></div><p>The assembly language programmer new to <span class="trademark">UNIX</span>® and FreeBSD
      will immediately ask the puzzling question: Where is
      <code class="varname">errno</code> and how do I get to it?</p><div xmlns="" class="note"><h3 class="admontitle">Note: </h3><p xmlns="http://www.w3.org/1999/xhtml">The information presented in the manual pages applies to C
	programs.  The assembly language programmer needs additional
	information.</p></div></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="x86-where-return-values"></a>11.4.2. Where Are the Return Values?</h3></div></div></div><p>Unfortunately, it depends... For most system calls it is in
      <code class="varname">EAX</code>, but not for all.  A good
      rule of thumb, when working with a system call for the first
      time, is to look for the return value in <code class="varname">EAX</code>.  If it is not there, you need
      further research.</p><div xmlns="" class="note"><h3 class="admontitle">Note: </h3><p xmlns="http://www.w3.org/1999/xhtml">I am aware of one system call that returns the value in
	<code class="varname">EDX</code>: <code class="function">SYS_fork</code>.  All others I have
	worked with use <code class="varname">EAX</code>.  But I
	have not worked with them all yet.</p></div><div xmlns="" class="tip"><h3 class="admontitle">Tip: </h3><p xmlns="http://www.w3.org/1999/xhtml">If you cannot find the answer here or anywhere else, study
	<span class="application">libc</span> source code and see how it
	interfaces with the kernel.</p></div></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="x86-where-errno"></a>11.4.3. Where Is <code class="varname">errno</code>?</h3></div></div></div><p>Actually, nowhere...</p><p><code class="varname">errno</code> is part of the C language, not the
      <span class="trademark">UNIX</span>® kernel.  When accessing kernel services directly, the
      error code is returned in <code class="varname">EAX</code>, the same register the proper
      return value generally ends up in.</p><p>This makes perfect sense.  If there is no error, there is no
      error code.  If there is an error, there is no return value.
      One register can contain either.</p></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="x86-how-to-know-error"></a>11.4.4. Determining an Error Occurred</h3></div></div></div><p>When using the standard FreeBSD calling convention, the
      <code class="varname">carry flag</code> is cleared upon
      success, set upon failure.</p><p>When using the Linux emulation mode, the signed value in
      <code class="varname">EAX</code> is non-negative upon
      success, and contains the return value.  In case of an error,
      the value is negative, i.e., <code class="varname">-errno</code>.</p></div></div><div class="sect1"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="x86-portable-code"></a>11.5. Creating Portable Code</h2></div></div></div><p>Portability is generally not one of the strengths of assembly
    language.  Yet, writing assembly language programs for different
    platforms is possible, especially with
    <span class="application">nasm</span>.  I have written assembly language
    libraries that can be assembled for such different operating
    systems as <span class="trademark">Windows</span>® and FreeBSD.</p><p>It is all the more possible when you want your code to run on
    two platforms which, while different, are based on similar
    architectures.</p><p>For example, FreeBSD is <span class="trademark">UNIX</span>®, Linux is <span class="trademark">UNIX</span>® like.  I only
    mentioned three differences between them (from an assembly
    language programmer's perspective): The calling convention, the
    function numbers, and the way of returning values.</p><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="x86-deal-with-function-numbers"></a>11.5.1. Dealing with Function Numbers</h3></div></div></div><p>In many cases the function numbers are the same.  However,
      even when they are not, the problem is easy to deal with:
      Instead of using numbers in your code, use constants which you
      have declared differently depending on the target
      architecture:</p><pre class="programlisting">%ifdef	LINUX
%define	SYS_execve	11
%else
%define	SYS_execve	59
%endif</pre></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="x86-deal-with-geneva"></a>11.5.2. Dealing with Conventions</h3></div></div></div><p>Both, the calling convention, and the return value (the
	<code class="varname">errno</code> problem) can be resolved with
	macros:</p><pre class="programlisting">%ifdef	LINUX

%macro	system	0
	call	kernel
%endmacro

align 4
kernel:
	push	ebx
	push	ecx
	push	edx
	push	esi
	push	edi
	push	ebp

	mov	ebx, [esp+32]
	mov	ecx, [esp+36]
	mov	edx, [esp+40]
	mov	esi, [esp+44]
	mov	ebp, [esp+48]
	int	80h

	pop	ebp
	pop	edi
	pop	esi
	pop	edx
	pop	ecx
	pop	ebx

	or	eax, eax
	js	.errno
	clc
	ret

.errno:
	neg	eax
	stc
	ret

%else

%macro	system	0
	int	80h
%endmacro

%endif</pre></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="x86-deal-with-other-portability"></a>11.5.3. Dealing with Other Portability Issues</h3></div></div></div><p>The above solutions can handle most cases of writing code
      portable between FreeBSD and Linux.  Nevertheless, with some
      kernel services the differences are deeper.</p><p>In that case, you need to write two different handlers for
      those particular system calls, and use conditional assembly.
      Luckily, most of your code does something other than calling the
      kernel, so usually you will only need a few such conditional
      sections in your code.</p></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="x86-portable-library"></a>11.5.4. Using a Library</h3></div></div></div><p>You can avoid portability issues in your main code
      altogether by writing a library of system calls.  Create a
      separate library for FreeBSD, a different one for Linux, and yet
      other libraries for more operating systems.</p><p>In your library, write a separate function (or procedure, if
      you prefer the traditional assembly language terminology) for
      each system call.  Use the C calling convention of passing
      parameters.  But still use <code class="varname">EAX</code> to pass the call number in.  In
      that case, your FreeBSD library can be very simple, as many
      seemingly different functions can be just labels to the same
      code:</p><pre class="programlisting">sys.open:
sys.close:
[etc...]
	int	80h
	ret</pre><p>Your Linux library will require more different functions.
      But even here you can group system calls using the same number
      of parameters:</p><pre class="programlisting">sys.exit:
sys.close:
[etc... one-parameter functions]
	push	ebx
	mov	ebx, [esp+12]
	int	80h
	pop	ebx
	jmp	sys.return

...

sys.return:
	or	eax, eax
	js	sys.err
	clc
	ret

sys.err:
	neg	eax
	stc
	ret</pre><p>The library approach may seem inconvenient at first because
      it requires you to produce a separate file your code depends on.
      But it has many advantages: For one, you only need to write it
      once and can use it for all your programs.  You can even let
      other assembly language programmers use it, or perhaps use one
      written by someone else.  But perhaps the greatest advantage of
      the library is that your code can be ported to other systems,
      even by other programmers, by simply writing a new library
      without any changes to your code.</p><p>If you do not like the idea of having a library, you can at
      least place all your system calls in a separate assembly
      language file and link it with your main program.  Here, again,
      all porters have to do is create a new object file to link with
      your main program.</p></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="x86-portable-include"></a>11.5.5. Using an Include File</h3></div></div></div><p>If you are releasing your software as (or with) source code,
      you can use macros and place them in a separate file, which you
      include in your code.</p><p>Porters of your software will simply write a new include
      file.  No library or external object file is necessary, yet your
      code is portable without any need to edit the code.</p><div xmlns="" class="note"><h3 class="admontitle">Note: </h3><p xmlns="http://www.w3.org/1999/xhtml">This is the approach we will use throughout this chapter.
	We will name our include file <code class="filename">system.inc</code>,
	and add to it whenever we deal with a new system call.</p></div><p>We can start our <code class="filename">system.inc</code> by
      declaring the standard file descriptors:</p><pre class="programlisting">%define	stdin	0
%define	stdout	1
%define	stderr	2</pre><p>Next, we create a symbolic name for each system call:</p><pre class="programlisting">%define	SYS_nosys	0
%define	SYS_exit	1
%define	SYS_fork	2
%define	SYS_read	3
%define	SYS_write	4
; [etc...]</pre><p>We add a short, non-global procedure with a long name, so we
      do not accidentally reuse the name in our code:</p><pre class="programlisting">section	.text
align 4
access.the.bsd.kernel:
	int	80h
	ret</pre><p>We create a macro which takes one argument, the syscall
      number:</p><pre class="programlisting">%macro	system	1
	mov	eax, %1
	call	access.the.bsd.kernel
%endmacro</pre><p>Finally, we create macros for each syscall.  These macros
      take no arguments.</p><pre class="programlisting">%macro	sys.exit	0
	system	SYS_exit
%endmacro

%macro	sys.fork	0
	system	SYS_fork
%endmacro

%macro	sys.read	0
	system	SYS_read
%endmacro

%macro	sys.write	0
	system	SYS_write
%endmacro

; [etc...]</pre><p>Go ahead, enter it into your editor and save it as
      <code class="filename">system.inc</code>.  We will add more to it as we
      discuss more syscalls.</p></div></div><div class="sect1"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="x86-first-program"></a>11.6. Our First Program</h2></div></div></div><p>We are now ready for our first program, the mandatory
    <span class="application">Hello, World!</span></p><pre class="programlisting">1:	%include	'system.inc'
 2:
 3:	section	.data
 4:	hello	db	'Hello, World!', 0Ah
 5:	hbytes	equ	$-hello
 6:
 7:	section	.text
 8:	global	_start
 9:	_start:
10:	push	dword hbytes
11:	push	dword hello
12:	push	dword stdout
13:	sys.write
14:
15:	push	dword 0
16:	sys.exit</pre><p>Here is what it does: Line 1 includes the defines, the macros,
    and the code from <code class="filename">system.inc</code>.</p><p>Lines 3-5 are the data: Line 3 starts the data
    section/segment.  Line 4 contains the string "Hello, World!"
    followed by a new line (<code class="constant">0Ah</code>).  Line 5 creates
    a constant that contains the length of the string from line 4 in
    bytes.</p><p>Lines 7-16 contain the code.  Note that FreeBSD uses the
    <span class="emphasis"><em>elf</em></span> file format for its executables, which
    requires every program to start at the point labeled
    <code class="varname">_start</code> (or, more precisely, the linker expects
    that).  This label has to be global.</p><p>Lines 10-13 ask the system to write <code class="varname">hbytes</code>
    bytes of the <code class="varname">hello</code> string to
    <code class="varname">stdout</code>.</p><p>Lines 15-16 ask the system to end the program with the return
    value of <code class="constant">0</code>.  The <code class="function">SYS_exit</code> syscall never returns, so the
    code ends there.</p><div xmlns="" class="note"><h3 class="admontitle">Note: </h3><p xmlns="http://www.w3.org/1999/xhtml">If you have come to <span class="trademark">UNIX</span>® from <acronym class="acronym"><span class="trademark">MS-DOS</span>®</acronym>
      assembly language background, you may be used to writing
      directly to the video hardware.  You will never have to worry
      about this in FreeBSD, or any other flavor of <span class="trademark">UNIX</span>®.  As far as
      you are concerned, you are writing to a file known as
      <code class="filename">stdout</code>.  This can be the video screen, or a
      <span class="application">telnet</span> terminal, or an actual file,
      or even the input of another program.  Which one it is, is for
      the system to figure out.</p></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="x86-assemble-1"></a>11.6.1. Assembling the Code</h3></div></div></div><p>Type the code (except the line numbers) in an editor, and
      save it in a file named <code class="filename">hello.asm</code>.  You
      need <span class="application">nasm</span> to assemble it.</p><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="x86-get-nasm"></a>11.6.1.1. Installing <span class="application">nasm</span></h4></div></div></div><p>If you do not have <span class="application">nasm</span>,
	type:</p><pre class="screen"><code class="prompt">%</code> <strong class="userinput"><code>su</code></strong>
Password:<strong class="userinput"><code><em class="replaceable"><code>your root password</code></em></code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>cd /usr/ports/devel/nasm</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>make install</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>exit</code></strong>
<code class="prompt">%</code></pre><p>You may type <strong class="userinput"><code>make install clean</code></strong>
	instead of just <strong class="userinput"><code>make install</code></strong> if you do
	not want to keep <span class="application">nasm</span> source
	code.</p><p>Either way, FreeBSD will automatically download
	<span class="application">nasm</span> from the Internet, compile it,
	and install it on your system.</p><div xmlns="" class="note"><h3 class="admontitle">Note: </h3><p xmlns="http://www.w3.org/1999/xhtml">If your system is not FreeBSD, you need to get
	  <span class="application">nasm</span> from its <a class="link" href="https://sourceforge.net/projects/nasm" target="_top">home
	    page</a>.  You can still use it to assemble FreeBSD
	  code.</p></div><p>Now you can assemble, link, and run the code:</p><pre class="screen"><code class="prompt">%</code> <strong class="userinput"><code>nasm -f elf hello.asm</code></strong>
<code class="prompt">%</code> <strong class="userinput"><code>ld -s -o hello hello.o</code></strong>
<code class="prompt">%</code> <strong class="userinput"><code>./hello</code></strong>
Hello, World!
<code class="prompt">%</code></pre></div></div></div><div class="sect1"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="x86-unix-filters"></a>11.7. Writing <span class="trademark">UNIX</span>® Filters</h2></div></div></div><p>A common type of <span class="trademark">UNIX</span>® application is a filter&#8212;a
    program that reads data from the <code class="filename">stdin</code>,
    processes it somehow, then writes the result to
    <code class="filename">stdout</code>.</p><p>In this chapter, we shall develop a simple filter, and
    learn how to read from <code class="filename">stdin</code> and write to
    <code class="filename">stdout</code>.  This filter will convert each byte
    of its input into a hexadecimal number followed by a blank
    space.</p><pre class="programlisting">%include	'system.inc'

section	.data
hex	db	'0123456789ABCDEF'
buffer	db	0, 0, ' '

section	.text
global	_start
_start:
	; read a byte from stdin
	push	dword 1
	push	dword buffer
	push	dword stdin
	sys.read
	add	esp, byte 12
	or	eax, eax
	je	.done

	; convert it to hex
	movzx	eax, byte [buffer]
	mov	edx, eax
	shr	dl, 4
	mov	dl, [hex+edx]
	mov	[buffer], dl
	and	al, 0Fh
	mov	al, [hex+eax]
	mov	[buffer+1], al

	; print it
	push	dword 3
	push	dword buffer
	push	dword stdout
	sys.write
	add	esp, byte 12
	jmp	short _start

.done:
	push	dword 0
	sys.exit</pre><p>In the data section we create an array called
	<code class="varname">hex</code>.  It contains the 16 hexadecimal digits
	in ascending order.  The array is followed by a buffer which
	we will use for both input and output.  The first two bytes of
	the buffer are initially set to <code class="constant">0</code>.  This
	is where we will write the two hexadecimal digits (the first
	byte also is where we will read the input).  The third byte is
	a space.</p><p>The code section consists of four parts: Reading the byte,
	converting it to a hexadecimal number, writing the result, and
	eventually exiting the program.</p><p>To read the byte, we ask the system to read one byte from
	<code class="filename">stdin</code>, and store it in the first byte of
	the <code class="varname">buffer</code>.  The system returns the number
	of bytes read in <code class="varname">EAX</code>.  This
	will be <code class="constant">1</code> while data is coming, or
	<code class="constant">0</code>, when no more input data is available.
	Therefore, we check the value of <code class="varname">EAX</code>.  If it is
	<code class="constant">0</code>, we jump to <code class="varname">.done</code>,
	otherwise we continue.</p><div xmlns="" class="note"><h3 class="admontitle">Note: </h3><p xmlns="http://www.w3.org/1999/xhtml">For simplicity sake, we are ignoring the possibility of
	  an error condition at this time.</p></div><p>The hexadecimal conversion reads the byte from the
	<code class="varname">buffer</code> into <code class="varname">EAX</code>, or actually just <code class="varname">AL</code>, while clearing the remaining
	bits of <code class="varname">EAX</code> to zeros.  We
	also copy the byte to <code class="varname">EDX</code>
	because we need to convert the upper four bits (nibble)
	separately from the lower four bits.  We store the result in
	the first two bytes of the buffer.</p><p>Next, we ask the system to write the three bytes of the
	buffer, i.e., the two hexadecimal digits and the blank space,
	to <code class="filename">stdout</code>.  We then jump back to the
	beginning of the program and process the next byte.</p><p>Once there is no more input left, we ask the system to
	exit our program, returning a zero, which is the traditional
	value meaning the program was successful.</p><p>Go ahead, and save the code in a file named
	<code class="filename">hex.asm</code>, then type the following (the
	<strong class="userinput"><code>^D</code></strong> means press the control key and type
	<strong class="userinput"><code>D</code></strong> while holding the control key
	down):</p><pre class="screen"><code class="prompt">%</code> <strong class="userinput"><code>nasm -f elf hex.asm</code></strong>
<code class="prompt">%</code> <strong class="userinput"><code>ld -s -o hex hex.o</code></strong>
<code class="prompt">%</code> <strong class="userinput"><code>./hex</code></strong>
<strong class="userinput"><code>Hello, World!</code></strong>
48 65 6C 6C 6F 2C 20 57 6F 72 6C 64 21 0A <strong class="userinput"><code>Here I come!</code></strong>
48 65 72 65 20 49 20 63 6F 6D 65 21 0A <strong class="userinput"><code>^D</code></strong> <code class="prompt">%</code></pre><div xmlns="" class="note"><h3 class="admontitle">Note: </h3><p xmlns="http://www.w3.org/1999/xhtml">If you are migrating to <span class="trademark">UNIX</span>® from
	  <acronym class="acronym"><span class="trademark">MS-DOS</span>®</acronym>, you may be wondering why each
	  line ends with <code class="constant">0A</code> instead of
	  <code class="constant">0D 0A</code>.  This is because <span class="trademark">UNIX</span>® does not
	  use the cr/lf convention, but a "new line" convention, which
	  is <code class="constant">0A</code> in hexadecimal.</p></div><p>Can we improve this? Well, for one, it is a bit confusing
	because once we have converted a line of text, our input no
	longer starts at the beginning of the line.  We can modify it
	to print a new line instead of a space after each
	<code class="constant">0A</code>:</p><pre class="programlisting">%include	'system.inc'

section	.data
hex	db	'0123456789ABCDEF'
buffer	db	0, 0, ' '

section	.text
global	_start
_start:
	mov	cl, ' '

.loop:
	; read a byte from stdin
	push	dword 1
	push	dword buffer
	push	dword stdin
	sys.read
	add	esp, byte 12
	or	eax, eax
	je	.done

	; convert it to hex
	movzx	eax, byte [buffer]
	mov	[buffer+2], cl
	cmp	al, 0Ah
	jne	.hex
	mov	[buffer+2], al

.hex:
	mov	edx, eax
	shr	dl, 4
	mov	dl, [hex+edx]
	mov	[buffer], dl
	and	al, 0Fh
	mov	al, [hex+eax]
	mov	[buffer+1], al

	; print it
	push	dword 3
	push	dword buffer
	push	dword stdout
	sys.write
	add	esp, byte 12
	jmp	short .loop

.done:
	push	dword 0
	sys.exit</pre><p>We have stored the space in the <code class="varname">CL</code> register.  We can do this
	safely because, unlike <span class="trademark">Microsoft</span>® <span class="trademark">Windows</span>®, <span class="trademark">UNIX</span>® system
	calls do not modify the value of any register they do not use
	to return a value in.</p><p>That means we only need to set <code class="varname">CL</code> once.  We have, therefore,
	added a new label <code class="varname">.loop</code> and jump to it for
	the next byte instead of jumping at <code class="varname">_start</code>.
	We have also added the <code class="varname">.hex</code> label so we can
	either have a blank space or a new line as the third byte of
	the <code class="varname">buffer</code>.</p><p>Once you have changed <code class="filename">hex.asm</code> to
	reflect these changes, type:</p><pre class="screen"><code class="prompt">%</code> <strong class="userinput"><code>nasm -f elf hex.asm</code></strong>
<code class="prompt">%</code> <strong class="userinput"><code>ld -s -o hex hex.o</code></strong>
<code class="prompt">%</code> <strong class="userinput"><code>./hex</code></strong>
<strong class="userinput"><code>Hello, World!</code></strong>
48 65 6C 6C 6F 2C 20 57 6F 72 6C 64 21 0A
<strong class="userinput"><code>Here I come!</code></strong>
48 65 72 65 20 49 20 63 6F 6D 65 21 0A
<strong class="userinput"><code>^D</code></strong> <code class="prompt">%</code></pre><p>That looks better.  But this code is quite inefficient! We
	are making a system call for every single byte twice (once to
	read it, another time to write the output).</p></div><div class="sect1"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="x86-buffered-io"></a>11.8. Buffered Input and Output</h2></div></div></div><p>We can improve the efficiency of our code by buffering our
	input and output.  We create an input buffer and read a whole
	sequence of bytes at one time.  Then we fetch them one by one
	from the buffer.</p><p>We also create an output buffer.  We store our output in
	it until it is full.  At that time we ask the kernel to write
	the contents of the buffer to
	<code class="filename">stdout</code>.</p><p>The program ends when there is no more input.  But we
	still need to ask the kernel to write the contents of our
	output buffer to <code class="filename">stdout</code> one last time,
	otherwise some of our output would make it to the output
	buffer, but never be sent out.  Do not forget that, or you
	will be wondering why some of your output is missing.</p><pre class="programlisting">%include	'system.inc'

%define	BUFSIZE	2048

section	.data
hex	db	'0123456789ABCDEF'

section .bss
ibuffer	resb	BUFSIZE
obuffer	resb	BUFSIZE

section	.text
global	_start
_start:
	sub	eax, eax
	sub	ebx, ebx
	sub	ecx, ecx
	mov	edi, obuffer

.loop:
	; read a byte from stdin
	call	getchar

	; convert it to hex
	mov	dl, al
	shr	al, 4
	mov	al, [hex+eax]
	call	putchar

	mov	al, dl
	and	al, 0Fh
	mov	al, [hex+eax]
	call	putchar

	mov	al, ' '
	cmp	dl, 0Ah
	jne	.put
	mov	al, dl

.put:
	call	putchar
	jmp	short .loop

align 4
getchar:
	or	ebx, ebx
	jne	.fetch

	call	read

.fetch:
	lodsb
	dec	ebx
	ret

read:
	push	dword BUFSIZE
	mov	esi, ibuffer
	push	esi
	push	dword stdin
	sys.read
	add	esp, byte 12
	mov	ebx, eax
	or	eax, eax
	je	.done
	sub	eax, eax
	ret

align 4
.done:
	call	write		; flush output buffer
	push	dword 0
	sys.exit

align 4
putchar:
	stosb
	inc	ecx
	cmp	ecx, BUFSIZE
	je	write
	ret

align 4
write:
	sub	edi, ecx	; start of buffer
	push	ecx
	push	edi
	push	dword stdout
	sys.write
	add	esp, byte 12
	sub	eax, eax
	sub	ecx, ecx	; buffer is empty now
	ret</pre><p>We now have a third section in the source code, named
	<code class="varname">.bss</code>.  This section is not included in our
	executable file, and, therefore, cannot be initialized.  We
	use <code class="function">resb</code> instead of
	<code class="function">db</code>.  It simply reserves
	the requested size of uninitialized memory for our use.</p><p>We take advantage of the fact that the system does not
	modify the registers: We use registers for what, otherwise,
	would have to be global variables stored in the
	<code class="varname">.data</code> section.  This is also why the
	<span class="trademark">UNIX</span>® convention of passing parameters to system calls on the
	stack is superior to the Microsoft convention of passing them
	in the registers: We can keep the registers for our own
	use.</p><p>We use <code class="varname">EDI</code> and
	<code class="varname">ESI</code> as pointers to the next
	byte to be read from or written to.  We use <code class="varname">EBX</code> and <code class="varname">ECX</code> to keep count of the number of
	bytes in the two buffers, so we know when to dump the output
	to, or read more input from, the system.</p><p>Let us see how it works now:</p><pre class="screen"><code class="prompt">%</code> <strong class="userinput"><code>nasm -f elf hex.asm</code></strong>
<code class="prompt">%</code> <strong class="userinput"><code>ld -s -o hex hex.o</code></strong>
<code class="prompt">%</code> <strong class="userinput"><code>./hex</code></strong>
<strong class="userinput"><code>Hello, World!</code></strong>
<strong class="userinput"><code>Here I come!</code></strong>
48 65 6C 6C 6F 2C 20 57 6F 72 6C 64 21 0A
48 65 72 65 20 49 20 63 6F 6D 65 21 0A
<strong class="userinput"><code>^D</code></strong> <code class="prompt">%</code></pre><p>Not what you expected? The program did not print the
	output until we pressed <strong class="userinput"><code>^D</code></strong>.  That is
	easy to fix by inserting three lines of code to write the
	output every time we have converted a new line to
	<code class="constant">0A</code>.  I have marked the three lines with
	&gt; (do not copy the &gt; in your
	<code class="filename">hex.asm</code>).</p><pre class="programlisting">%include	'system.inc'

%define	BUFSIZE	2048

section	.data
hex	db	'0123456789ABCDEF'

section .bss
ibuffer	resb	BUFSIZE
obuffer	resb	BUFSIZE

section	.text
global	_start
_start:
	sub	eax, eax
	sub	ebx, ebx
	sub	ecx, ecx
	mov	edi, obuffer

.loop:
	; read a byte from stdin
	call	getchar

	; convert it to hex
	mov	dl, al
	shr	al, 4
	mov	al, [hex+eax]
	call	putchar

	mov	al, dl
	and	al, 0Fh
	mov	al, [hex+eax]
	call	putchar

	mov	al, ' '
	cmp	dl, 0Ah
	jne	.put
	mov	al, dl

.put:
	call	putchar
&gt;	cmp	al, 0Ah
&gt;	jne	.loop
&gt;	call	write
	jmp	short .loop

align 4
getchar:
	or	ebx, ebx
	jne	.fetch

	call	read

.fetch:
	lodsb
	dec	ebx
	ret

read:
	push	dword BUFSIZE
	mov	esi, ibuffer
	push	esi
	push	dword stdin
	sys.read
	add	esp, byte 12
	mov	ebx, eax
	or	eax, eax
	je	.done
	sub	eax, eax
	ret

align 4
.done:
	call	write		; flush output buffer
	push	dword 0
	sys.exit

align 4
putchar:
	stosb
	inc	ecx
	cmp	ecx, BUFSIZE
	je	write
	ret

align 4
write:
	sub	edi, ecx	; start of buffer
	push	ecx
	push	edi
	push	dword stdout
	sys.write
	add	esp, byte 12
	sub	eax, eax
	sub	ecx, ecx	; buffer is empty now
	ret</pre><p>Now, let us see how it works:</p><pre class="screen"><code class="prompt">%</code> <strong class="userinput"><code>nasm -f elf hex.asm</code></strong>
<code class="prompt">%</code> <strong class="userinput"><code>ld -s -o hex hex.o</code></strong>
<code class="prompt">%</code> <strong class="userinput"><code>./hex</code></strong>
<strong class="userinput"><code>Hello, World!</code></strong>
48 65 6C 6C 6F 2C 20 57 6F 72 6C 64 21 0A
<strong class="userinput"><code>Here I come!</code></strong>
48 65 72 65 20 49 20 63 6F 6D 65 21 0A
<strong class="userinput"><code>^D</code></strong> <code class="prompt">%</code></pre><p>Not bad for a 644-byte executable, is it!</p><div xmlns="" class="note"><h3 class="admontitle">Note: </h3><p xmlns="http://www.w3.org/1999/xhtml">This approach to buffered input/output still
	  contains a hidden danger.  I will discuss&#8212;and
	  fix&#8212;it later, when I talk about the <a class="link" href="#x86-buffered-dark-side" title="11.12.1.1. The Dark Side of Buffering">dark side of
	    buffering</a>.</p></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="x86-ungetc"></a>11.8.1. How to Unread a Character</h3></div></div></div><div xmlns="" class="warning"><h3 class="admontitle">Warning: </h3><p xmlns="http://www.w3.org/1999/xhtml">This may be a somewhat advanced topic, mostly of
	    interest to programmers familiar with the theory of
	    compilers.  If you wish, you may <a class="link" href="#x86-command-line" title="11.9. Command Line Arguments">skip to the next
	      section</a>, and perhaps read this later.</p></div><p>While our sample program does not require it, more
	  sophisticated filters often need to look ahead.  In other
	  words, they may need to see what the next character is (or
	  even several characters).  If the next character is of a
	  certain value, it is part of the token currently being
	  processed.  Otherwise, it is not.</p><p>For example, you may be parsing the input stream for a
	  textual string (e.g., when implementing a language
	  compiler): If a character is followed by another character,
	  or perhaps a digit, it is part of the token you are
	  processing.  If it is followed by white space, or some other
	  value, then it is not part of the current token.</p><p>This presents an interesting problem: How to return the
	  next character back to the input stream, so it can be read
	  again later?</p><p>One possible solution is to store it in a character
	  variable, then set a flag.  We can modify
	  <code class="function">getchar</code> to check the flag, and if it is
	  set, fetch the byte from that variable instead of the input
	  buffer, and reset the flag.  But, of course, that slows us
	  down.</p><p>The C language has an <code class="function">ungetc()</code>
	  function, just for that purpose.  Is there a quick way to
	  implement it in our code?  I would like you to scroll back
	  up and take a look at the <code class="function">getchar</code>
	  procedure and see if you can find a nice and fast solution
	  before reading the next paragraph.  Then come back here and
	  see my own solution.</p><p>The key to returning a character back to the stream is
	  in how we are getting the characters to start with:</p><p>First we check if the buffer is empty by testing the
	  value of <code class="varname">EBX</code>.  If it is
	  zero, we call the <code class="function">read</code>
	  procedure.</p><p>If we do have a character available, we use <code class="function">lodsb</code>, then decrease the value of
	  <code class="varname">EBX</code>.  The <code class="function">lodsb</code> instruction is effectively
	  identical to:</p><pre class="programlisting">mov	al, [esi]
	inc	esi</pre><p>The byte we have fetched remains in the buffer until the
	next time <code class="function">read</code> is called.  We do not know
	when that happens, but we do know it will not happen until the
	next call to <code class="function">getchar</code>.  Hence, to "return"
	the last-read byte back to the stream, all we have to do is
	decrease the value of <code class="varname">ESI</code>
	and increase the value of <code class="varname">EBX</code>:</p><pre class="programlisting">ungetc:
	dec	esi
	inc	ebx
	ret</pre><p>But, be careful! We are perfectly safe doing this if our
	look-ahead is at most one character at a time.  If we are
	examining more than one upcoming character and call
	<code class="function">ungetc</code> several times in a row, it will
	work most of the time, but not all the time (and will be tough
	to debug).  Why?</p><p>Because as long as <code class="function">getchar</code> does not
	have to call <code class="function">read</code>, all of the pre-read
	bytes are still in the buffer, and our
	<code class="function">ungetc</code> works without a glitch.  But the
	moment <code class="function">getchar</code> calls
	<code class="function">read</code>, the contents of the buffer
	change.</p><p>We can always rely on <code class="function">ungetc</code> working
	properly on the last character we have read with
	<code class="function">getchar</code>, but not on anything we have read
	before that.</p><p>If your program reads more than one byte ahead, you have
	at least two choices:</p><p>If possible, modify the program so it only reads one byte
	ahead.  This is the simplest solution.</p><p>If that option is not available, first of all determine
	the maximum number of characters your program needs to return
	to the input stream at one time.  Increase that number
	slightly, just to be sure, preferably to a multiple of
	16&#8212;so it aligns nicely.  Then modify the
	<code class="varname">.bss</code> section of your code, and create a
	small "spare" buffer right before your input buffer, something
	like this:</p><pre class="programlisting">section	.bss
	resb	16	; or whatever the value you came up with
ibuffer	resb	BUFSIZE
obuffer	resb	BUFSIZE</pre><p>You also need to modify your <code class="function">ungetc</code>
	to pass the value of the byte to unget in <code class="varname">AL</code>:</p><pre class="programlisting">ungetc:
	dec	esi
	inc	ebx
	mov	[esi], al
	ret</pre><p>With this modification, you can call
	<code class="function">ungetc</code> up to 17 times in a row safely
	(the first call will still be within the buffer, the remaining
	16 may be either within the buffer or within the
	"spare").</p></div></div><div class="sect1"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="x86-command-line"></a>11.9. Command Line Arguments</h2></div></div></div><p>Our <span class="application">hex</span> program will be more
      useful if it can read the names of an input and output file from
      its command line, i.e., if it can process the command line
      arguments.  But... Where are they?</p><p>Before a <span class="trademark">UNIX</span>® system starts a program, it <code class="function">push</code>es some data on the stack, then
      jumps at the <code class="varname">_start</code> label of the program.
      Yes, I said jumps, not calls.  That means the data can be
      accessed by reading <code class="varname">[esp+offset]</code>, or by
      simply <code class="function">pop</code>ping it.</p><p>The value at the top of the stack contains the number of
      command line arguments.  It is traditionally called
      <code class="varname">argc</code>, for "argument count."</p><p>Command line arguments follow next, all
      <code class="varname">argc</code> of them.  These are typically referred
      to as <code class="varname">argv</code>, for "argument value(s)."  That
      is, we get <code class="varname">argv[0]</code>,
      <code class="varname">argv[1]</code>, <code class="varname">...</code>,
      <code class="varname">argv[argc-1]</code>.  These are not the actual
      arguments, but pointers to arguments, i.e., memory addresses of
      the actual arguments.  The arguments themselves are
      NUL-terminated character strings.</p><p>The <code class="varname">argv</code> list is followed by a NULL
      pointer, which is simply a <code class="constant">0</code>.  There is
      more, but this is enough for our purposes right now.</p><div xmlns="" class="note"><h3 class="admontitle">Note: </h3><p xmlns="http://www.w3.org/1999/xhtml">If you have come from the <acronym class="acronym"><span class="trademark">MS-DOS</span>®</acronym>
	programming environment, the main difference is that each
	argument is in a separate string.  The second difference is
	that there is no practical limit on how many arguments there
	can be.</p></div><p>Armed with this knowledge, we are almost ready for the next
      version of <code class="filename">hex.asm</code>.  First, however, we
      need to add a few lines to
      <code class="filename">system.inc</code>:</p><p>First, we need to add two new entries to our list of system
      call numbers:</p><pre class="programlisting">%define	SYS_open	5
%define	SYS_close	6</pre><p>Then we add two new macros at the end of the file:</p><pre class="programlisting">%macro	sys.open	0
	system	SYS_open
%endmacro

%macro	sys.close	0
	system	SYS_close
%endmacro</pre><p>Here, then, is our modified source code:</p><pre class="programlisting">%include	'system.inc'

%define	BUFSIZE	2048

section	.data
fd.in	dd	stdin
fd.out	dd	stdout
hex	db	'0123456789ABCDEF'

section .bss
ibuffer	resb	BUFSIZE
obuffer	resb	BUFSIZE

section	.text
align 4
err:
	push	dword 1		; return failure
	sys.exit

align 4
global	_start
_start:
	add	esp, byte 8	; discard argc and argv[0]

	pop	ecx
	jecxz	.init		; no more arguments

	; ECX contains the path to input file
	push	dword 0		; O_RDONLY
	push	ecx
	sys.open
	jc	err		; open failed

	add	esp, byte 8
	mov	[fd.in], eax

	pop	ecx
	jecxz	.init		; no more arguments

	; ECX contains the path to output file
	push	dword 420	; file mode (644 octal)
	push	dword 0200h | 0400h | 01h
	; O_CREAT | O_TRUNC | O_WRONLY
	push	ecx
	sys.open
	jc	err

	add	esp, byte 12
	mov	[fd.out], eax

.init:
	sub	eax, eax
	sub	ebx, ebx
	sub	ecx, ecx
	mov	edi, obuffer

.loop:
	; read a byte from input file or stdin
	call	getchar

	; convert it to hex
	mov	dl, al
	shr	al, 4
	mov	al, [hex+eax]
	call	putchar

	mov	al, dl
	and	al, 0Fh
	mov	al, [hex+eax]
	call	putchar

	mov	al, ' '
	cmp	dl, 0Ah
	jne	.put
	mov	al, dl

.put:
	call	putchar
	cmp	al, dl
	jne	.loop
	call	write
	jmp	short .loop

align 4
getchar:
	or	ebx, ebx
	jne	.fetch

	call	read

.fetch:
	lodsb
	dec	ebx
	ret

read:
	push	dword BUFSIZE
	mov	esi, ibuffer
	push	esi
	push	dword [fd.in]
	sys.read
	add	esp, byte 12
	mov	ebx, eax
	or	eax, eax
	je	.done
	sub	eax, eax
	ret

align 4
.done:
	call	write		; flush output buffer

	; close files
	push	dword [fd.in]
	sys.close

	push	dword [fd.out]
	sys.close

	; return success
	push	dword 0
	sys.exit

align 4
putchar:
	stosb
	inc	ecx
	cmp	ecx, BUFSIZE
	je	write
	ret

align 4
write:
	sub	edi, ecx	; start of buffer
	push	ecx
	push	edi
	push	dword [fd.out]
	sys.write
	add	esp, byte 12
	sub	eax, eax
	sub	ecx, ecx	; buffer is empty now
	ret</pre><p>In our <code class="varname">.data</code> section we now have two
	new variables, <code class="varname">fd.in</code> and
	<code class="varname">fd.out</code>.  We store the input and output file
	descriptors here.</p><p>In the <code class="varname">.text</code> section we have replaced
	the references to <code class="varname">stdin</code> and
	<code class="varname">stdout</code> with <code class="varname">[fd.in]</code> and
	<code class="varname">[fd.out]</code>.</p><p>The <code class="varname">.text</code> section now starts with a
	simple error handler, which does nothing but exit the program
	with a return value of <code class="constant">1</code>.  The error
	handler is before <code class="varname">_start</code> so we are within
	a short distance from where the errors occur.</p><p>Naturally, the program execution still begins at
	<code class="varname">_start</code>.  First, we remove
	<code class="varname">argc</code> and <code class="varname">argv[0]</code> from
	the stack: They are of no interest to us (in this program,
	that is).</p><p>We pop <code class="varname">argv[1]</code> to <code class="varname">ECX</code>.  This register is
	particularly suited for pointers, as we can handle NULL
	pointers with <code class="function">jecxz</code>.  If
	<code class="varname">argv[1]</code> is not NULL, we try to open the
	file named in the first argument.  Otherwise, we continue the
	program as before: Reading from <code class="varname">stdin</code>,
	writing to <code class="varname">stdout</code>.  If we fail to open the
	input file (e.g., it does not exist), we jump to the error
	handler and quit.</p><p>If all went well, we now check for the second argument.
	If it is there, we open the output file.  Otherwise, we send
	the output to <code class="varname">stdout</code>.  If we fail to open
	the output file (e.g., it exists and we do not have the write
	permission), we, again, jump to the error handler.</p><p>The rest of the code is the same as before, except we
	close the input and output files before exiting, and, as
	mentioned, we use <code class="varname">[fd.in]</code> and
	<code class="varname">[fd.out]</code>.</p><p>Our executable is now a whopping 768 bytes long.</p><p>Can we still improve it? Of course!  Every program can be
	improved.  Here are a few ideas of what we could do:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Have our error handler print a message to
	    <code class="varname">stderr</code>.</p></li><li class="listitem"><p>Add error handlers to the <code class="function">read</code>
	    and <code class="function">write</code> functions.</p></li><li class="listitem"><p>Close <code class="varname">stdin</code> when we open an input
	    file, <code class="varname">stdout</code> when we open an output
	    file.</p></li><li class="listitem"><p>Add command line switches, such as
	    <em class="parameter"><code>-i</code></em> and <em class="parameter"><code>-o</code></em>,
	    so we can list the input and output files in any order,
	    or perhaps read from <code class="varname">stdin</code> and write to
	    a file.</p></li><li class="listitem"><p>Print a usage message if command line arguments are
	    incorrect.</p></li></ul></div><p>I shall leave these enhancements as an exercise to the
	reader: You already know everything you need to know to
	implement them.</p></div><div class="sect1"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="x86-environment"></a>11.10. <span class="trademark">UNIX</span>® Environment</h2></div></div></div><p>An important <span class="trademark">UNIX</span>® concept is the environment, which is
	defined by <span class="emphasis"><em>environment variables</em></span>.  Some
	are set by the system, others by you, yet others by the
	<span class="application">shell</span>, or any program that loads
	another program.</p><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="x86-find-environment"></a>11.10.1. How to Find Environment Variables</h3></div></div></div><p>I said earlier that when a program starts executing, the
	  stack contains <code class="varname">argc</code> followed by the
	  NULL-terminated <code class="varname">argv</code> array, followed by
	  something else.  The "something else" is the
	  <span class="emphasis"><em>environment</em></span>, or, to be more precise, a
	  NULL-terminated array of pointers to <span class="emphasis"><em>environment
	    variables</em></span>.  This is often referred to as
	  <code class="varname">env</code>.</p><p>The structure of <code class="varname">env</code> is the same as
	  that of <code class="varname">argv</code>, a list of memory addresses
	  followed by a NULL (<code class="constant">0</code>).  In this case,
	  there is no <code class="varname">"envc"</code>&#8212;we figure out
	  where the array ends by searching for the final NULL.</p><p>The variables usually come in the
	  <code class="varname">name=value</code> format, but sometimes the
	  <code class="varname">=value</code> part may be missing.  We need to
	  account for that possibility.</p></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="x86-webvar"></a>11.10.2. webvars</h3></div></div></div><p>I could just show you some code that prints the
	  environment the same way the <span class="trademark">UNIX</span>®
	  <span class="application">env</span> command does.  But I thought
	  it would be more interesting to write a simple assembly
	  language CGI utility.</p><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="x86-cgi"></a>11.10.2.1. CGI: a Quick Overview</h4></div></div></div><p>I have a <a class="link" href="http://www.whizkidtech.redprince.net/cgi-bin/tutorial" target="_top">detailed
	      <acronym class="acronym">CGI</acronym> tutorial</a> on my web site,
	    but here is a very quick overview of
	    <acronym class="acronym">CGI</acronym>:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>The web server communicates with the
		<acronym class="acronym">CGI</acronym> program by setting
		<span class="emphasis"><em>environment variables</em></span>.</p></li><li class="listitem"><p>The <acronym class="acronym">CGI</acronym> program sends its
		output to <code class="filename">stdout</code>.  The web server
		reads it from there.</p></li><li class="listitem"><p>It must start with an <acronym class="acronym">HTTP</acronym>
		header followed by two blank lines.</p></li><li class="listitem"><p>It then prints the <acronym class="acronym">HTML</acronym> code,
		or whatever other type of data it is producing.</p></li></ul></div><div xmlns="" class="note"><h3 class="admontitle">Note: </h3><p xmlns="http://www.w3.org/1999/xhtml">While certain <span class="emphasis"><em>environment
		variables</em></span> use standard names, others vary,
	      depending on the web server.  That makes
	      <span class="application">webvars</span> quite a useful
	      diagnostic tool.</p></div></div><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="x86-webvars-the-code"></a>11.10.2.2. The Code</h4></div></div></div><p>Our <span class="application">webvars</span> program, then,
	    must send out the <acronym class="acronym">HTTP</acronym> header followed
	    by some <acronym class="acronym">HTML</acronym> mark-up.  It then must
	    read the <span class="emphasis"><em>environment variables</em></span> one by
	    one and send them out as part of the
	    <acronym class="acronym">HTML</acronym> page.</p><p>The code follows.  I placed comments and explanations
	    right inside the code:</p><pre class="programlisting">;;;;;;; webvars.asm ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;
; Copyright (c) 2000 G. Adam Stanislav
; All rights reserved.
;
; Redistribution and use in source and binary forms, with or without
; modification, are permitted provided that the following conditions
; are met:
; 1. Redistributions of source code must retain the above copyright
;    notice, this list of conditions and the following disclaimer.
; 2. Redistributions in binary form must reproduce the above copyright
;    notice, this list of conditions and the following disclaimer in the
;    documentation and/or other materials provided with the distribution.
;
; THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND
; ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
; IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
; ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE
; FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL
; DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS
; OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)
; HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT
; LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY
; OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
; SUCH DAMAGE.
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;
; Version 1.0
;
; Started:	 8-Dec-2000
; Updated:	 8-Dec-2000
;
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
%include	'system.inc'

section	.data
http	db	'Content-type: text/html', 0Ah, 0Ah
	db	'&lt;?xml version="1.0" encoding="utf-8"?&gt;', 0Ah
	db	'&lt;!DOCTYPE html PUBLIC "-//W3C/DTD XHTML Strict//EN" '
	db	'"DTD/xhtml1-strict.dtd"&gt;', 0Ah
	db	'&lt;html xmlns="http://www.w3.org/1999/xhtml" '
	db	'xml.lang="en" lang="en"&gt;', 0Ah
	db	'&lt;head&gt;', 0Ah
	db	'&lt;title&gt;Web Environment&lt;/title&gt;', 0Ah
	db	'&lt;meta name="author" content="G. Adam Stanislav" /&gt;', 0Ah
	db	'&lt;/head&gt;', 0Ah, 0Ah
	db	'&lt;body bgcolor="#ffffff" text="#000000" link="#0000ff" '
	db	'vlink="#840084" alink="#0000ff"&gt;', 0Ah
	db	'&lt;div class="webvars"&gt;', 0Ah
	db	'&lt;h1&gt;Web Environment&lt;/h1&gt;', 0Ah
	db	'&lt;p&gt;The following &lt;b&gt;environment variables&lt;/b&gt; are defined '
	db	'on this web server:&lt;/p&gt;', 0Ah, 0Ah
	db	'&lt;table align="center" width="80" border="0" cellpadding="10" '
	db	'cellspacing="0" class="webvars"&gt;', 0Ah
httplen	equ	$-http
left	db	'&lt;tr&gt;', 0Ah
	db	'&lt;td class="name"&gt;&lt;tt&gt;'
leftlen	equ	$-left
middle	db	'&lt;/tt&gt;&lt;/td&gt;', 0Ah
	db	'&lt;td class="value"&gt;&lt;tt&gt;&lt;b&gt;'
midlen	equ	$-middle
undef	db	'&lt;i&gt;(undefined)&lt;/i&gt;'
undeflen	equ	$-undef
right	db	'&lt;/b&gt;&lt;/tt&gt;&lt;/td&gt;', 0Ah
	db	'&lt;/tr&gt;', 0Ah
rightlen	equ	$-right
wrap	db	'&lt;/table&gt;', 0Ah
	db	'&lt;/div&gt;', 0Ah
	db	'&lt;/body&gt;', 0Ah
	db	'&lt;/html&gt;', 0Ah, 0Ah
wraplen	equ	$-wrap

section	.text
global	_start
_start:
	; First, send out all the http and xhtml stuff that is
	; needed before we start showing the environment
	push	dword httplen
	push	dword http
	push	dword stdout
	sys.write

	; Now find how far on the stack the environment pointers
	; are. We have 12 bytes we have pushed before "argc"
	mov	eax, [esp+12]

	; We need to remove the following from the stack:
	;
	;	The 12 bytes we pushed for sys.write
	;	The  4 bytes of argc
	;	The EAX*4 bytes of argv
	;	The  4 bytes of the NULL after argv
	;
	; Total:
	;	20 + eax * 4
	;
	; Because stack grows down, we need to ADD that many bytes
	; to ESP.
	lea	esp, [esp+20+eax*4]
	cld		; This should already be the case, but let's be sure.

	; Loop through the environment, printing it out
.loop:
	pop	edi
	or	edi, edi	; Done yet?
	je	near .wrap

	; Print the left part of HTML
	push	dword leftlen
	push	dword left
	push	dword stdout
	sys.write

	; It may be tempting to search for the '=' in the env string next.
	; But it is possible there is no '=', so we search for the
	; terminating NUL first.
	mov	esi, edi	; Save start of string
	sub	ecx, ecx
	not	ecx		; ECX = FFFFFFFF
	sub	eax, eax
repne	scasb
	not	ecx		; ECX = string length + 1
	mov	ebx, ecx	; Save it in EBX

	; Now is the time to find '='
	mov	edi, esi	; Start of string
	mov	al, '='
repne	scasb
	not	ecx
	add	ecx, ebx	; Length of name

	push	ecx
	push	esi
	push	dword stdout
	sys.write

	; Print the middle part of HTML table code
	push	dword midlen
	push	dword middle
	push	dword stdout
	sys.write

	; Find the length of the value
	not	ecx
	lea	ebx, [ebx+ecx-1]

	; Print "undefined" if 0
	or	ebx, ebx
	jne	.value

	mov	ebx, undeflen
	mov	edi, undef

.value:
	push	ebx
	push	edi
	push	dword stdout
	sys.write

	; Print the right part of the table row
	push	dword rightlen
	push	dword right
	push	dword stdout
	sys.write

	; Get rid of the 60 bytes we have pushed
	add	esp, byte 60

	; Get the next variable
	jmp	.loop

.wrap:
	; Print the rest of HTML
	push	dword wraplen
	push	dword wrap
	push	dword stdout
	sys.write

	; Return success
	push	dword 0
	sys.exit</pre><p>This code produces a 1,396-byte executable.  Most of it is
	data, i.e., the <acronym class="acronym">HTML</acronym> mark-up we need to
	send out.</p><p>Assemble and link it as usual:</p><pre class="screen"><code class="prompt">%</code> <strong class="userinput"><code>nasm -f elf webvars.asm</code></strong>
<code class="prompt">%</code> <strong class="userinput"><code>ld -s -o webvars webvars.o</code></strong></pre><p>To use it, you need to upload <code class="filename">webvars</code>
	to your web server.  Depending on how your web server is set
	up, you may have to store it in a special
	<code class="filename">cgi-bin</code> directory, or perhaps rename it
	with a <code class="filename">.cgi</code> extension.</p><p>Then you need to use your browser to view its output.  To
	see its output on my web server, please go to <a class="link" href="http://www.int80h.org/webvars/" target="_top"><code class="filename">http://www.int80h.org/webvars/</code></a>.
	If curious about the additional environment variables present
	in a password protected web directory, go to <a class="link" href="http://www.int80h.org/private/" target="_top"><code class="filename">http://www.int80h.org/private/</code></a>,
	using the name <strong class="userinput"><code>asm</code></strong> and password
	<strong class="userinput"><code>programmer</code></strong>.</p></div></div></div><div class="sect1"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="x86-files"></a>11.11. Working with Files</h2></div></div></div><p>We have already done some basic file work: We know how to
      open and close them, how to read and write them using buffers.
      But <span class="trademark">UNIX</span>® offers much more functionality when it comes to
      files.  We will examine some of it in this section, and end up
      with a nice file conversion utility.</p><p>Indeed, let us start at the end, that is, with the file
      conversion utility.  It always makes programming easier when we
      know from the start what the end product is supposed to
      do.</p><p>One of the first programs I wrote for <span class="trademark">UNIX</span>® was <a class="link" href="ftp://ftp.int80h.org/unix/tuc/" target="_top"><span class="application">tuc</span></a>,
      a text-to-<span class="trademark">UNIX</span>® file converter.  It converts a text file from
      other operating systems to a <span class="trademark">UNIX</span>® text file.  In other words,
      it changes from different kind of line endings to the newline
      convention of <span class="trademark">UNIX</span>®.  It saves the output in a different file.
      Optionally, it converts a <span class="trademark">UNIX</span>® text file to a
      <acronym class="acronym">DOS</acronym> text file.</p><p>I have used <span class="application">tuc</span> extensively, but
      always only to convert from some other <acronym class="acronym">OS</acronym> to
      <span class="trademark">UNIX</span>®, never the other way.  I have always wished it would just
      overwrite the file instead of me having to send the output to a
      different file.  Most of the time, I end up using it like
      this:</p><pre class="screen"><code class="prompt">%</code> <strong class="userinput"><code>tuc <em class="replaceable"><code>myfile tempfile</code></em></code></strong>
<code class="prompt">%</code> <strong class="userinput"><code>mv <em class="replaceable"><code>tempfile myfile</code></em></code></strong></pre><p>It would be nice to have a <span class="application">ftuc</span>,
      i.e., <span class="emphasis"><em>fast tuc</em></span>, and use it like
      this:</p><pre class="screen"><code class="prompt">%</code> <strong class="userinput"><code>ftuc <em class="replaceable"><code>myfile</code></em></code></strong></pre><p>In this chapter, then, we will write
      <span class="application">ftuc</span> in assembly language (the
      original <span class="application">tuc</span> is in C), and study
      various file-oriented kernel services in the process.</p><p>At first sight, such a file conversion is very simple: All
      you have to do is strip the carriage returns, right?</p><p>If you answered yes, think again: That approach will work
      most of the time (at least with <acronym class="acronym">MS DOS</acronym> text
      files), but will fail occasionally.</p><p>The problem is that not all non <span class="trademark">UNIX</span>® text files end their
      line with the carriage return / line feed sequence.  Some use
      carriage returns without line feeds.  Others combine several
      blank lines into a single carriage return followed by several
      line feeds.  And so on.</p><p>A text file converter, then, must be able to handle any
      possible line endings:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>carriage return / line feed</p></li><li class="listitem"><p>carriage return</p></li><li class="listitem"><p>line feed / carriage return</p></li><li class="listitem"><p>line feed</p></li></ul></div><p>It should also handle files that use some kind of a
      combination of the above (e.g., carriage return followed by
      several line feeds).</p><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="x86-finite-state-machine"></a>11.11.1. Finite State Machine</h3></div></div></div><p>The problem is easily solved by the use of a technique
	called <span class="emphasis"><em>finite state machine</em></span>, originally
	developed by the designers of digital electronic circuits.  A
	<span class="emphasis"><em>finite state machine</em></span> is a digital circuit
	whose output is dependent not only on its input but on its
	previous input, i.e., on its state.  The microprocessor is an
	example of a <span class="emphasis"><em>finite state machine</em></span>: Our
	assembly language code is assembled to machine language in
	which some assembly language code produces a single byte of
	machine language, while others produce several bytes.  As the
	microprocessor fetches the bytes from the memory one by one,
	some of them simply change its state rather than produce some
	output.  When all the bytes of the op code are fetched, the
	microprocessor produces some output, or changes the value of
	a register, etc.</p><p>Because of that, all software is essentially a sequence of
	state instructions for the microprocessor.  Nevertheless, the
	concept of <span class="emphasis"><em>finite state machine</em></span> is useful
	in software design as well.</p><p>Our text file converter can be designer as a
	<span class="emphasis"><em>finite state machine</em></span> with three possible
	states.  We could call them states 0-2, but it will make our
	life easier if we give them symbolic names:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p><span class="symbol">ordinary</span></p></li><li class="listitem"><p><span class="symbol">cr</span></p></li><li class="listitem"><p><span class="symbol">lf</span></p></li></ul></div><p>Our program will start in the <span class="symbol">ordinary</span>
	state.  During this state, the program action depends on its
	input as follows:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>If the input is anything other than a carriage return
	    or line feed, the input is simply passed on to the output.
	    The state remains unchanged.</p></li><li class="listitem"><p>If the input is a carriage return, the state is
	    changed to <span class="symbol">cr</span>.  The input is then
	    discarded, i.e., no output is made.</p></li><li class="listitem"><p>If the input is a line feed, the state is changed to
	    <span class="symbol">lf</span>.  The input is then discarded.</p></li></ul></div><p>Whenever we are in the <span class="symbol">cr</span> state, it is
	because the last input was a carriage return, which was
	unprocessed.  What our software does in this state again
	depends on the current input:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>If the input is anything other than a carriage return
	    or line feed, output a line feed, then output the input,
	    then change the state to <span class="symbol">ordinary</span>.</p></li><li class="listitem"><p>If the input is a carriage return, we have received
	    two (or more) carriage returns in a row.  We discard the
	    input, we output a line feed, and leave the state
	    unchanged.</p></li><li class="listitem"><p>If the input is a line feed, we output the line feed
	    and change the state to <span class="symbol">ordinary</span>.  Note
	    that this is not the same as the first case above &#8211;
	    if we tried to combine them, we would be outputting two
	    line feeds instead of one.</p></li></ul></div><p>Finally, we are in the <span class="symbol">lf</span> state after we
	have received a line feed that was not preceded by a
	carriage return.  This will happen when our file already is in
	<span class="trademark">UNIX</span>® format, or whenever several lines in a row are
	expressed by a single carriage return followed by several line
	feeds, or when line ends with a line feed / carriage return
	sequence.  Here is how we need to handle our input in this
	state:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>If the input is anything other than a carriage return
	    or line feed, we output a line feed, then output the
	    input, then change the state to <span class="symbol">ordinary</span>.
	    This is exactly the same action as in the
	    <span class="symbol">cr</span> state upon receiving the same kind of
	    input.</p></li><li class="listitem"><p>If the input is a carriage return, we discard the
	    input, we output a line feed, then change the state to
	    <span class="symbol">ordinary</span>.</p></li><li class="listitem"><p>If the input is a line feed, we output the line feed,
	    and leave the state unchanged.</p></li></ul></div><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="x86-final-state"></a>11.11.1.1. The Final State</h4></div></div></div><p>The above <span class="emphasis"><em>finite state machine</em></span>
	  works for the entire file, but leaves the possibility that
	  the final line end will be ignored.  That will happen
	  whenever the file ends with a single carriage return or a
	  single line feed.  I did not think of it when I wrote
	  <span class="application">tuc</span>, just to discover that
	  occasionally it strips the last line ending.</p><p>This problem is easily fixed by checking the state after
	  the entire file was processed.  If the state is not
	  <span class="symbol">ordinary</span>, we simply need to output one last
	  line feed.</p><div xmlns="" class="note"><h3 class="admontitle">Note: </h3><p xmlns="http://www.w3.org/1999/xhtml">Now that we have expressed our algorithm as a
	    <span class="emphasis"><em>finite state machine</em></span>, we could easily
	    design a dedicated digital electronic circuit (a "chip")
	    to do the conversion for us.  Of course, doing so would be
	    considerably more expensive than writing an assembly
	    language program.</p></div></div><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="x86-tuc-counter"></a>11.11.1.2. The Output Counter</h4></div></div></div><p>Because our file conversion program may be combining two
	  characters into one, we need to use an output counter.  We
	  initialize it to <code class="constant">0</code>, and increase it
	  every time we send a character to the output.  At the end of
	  the program, the counter will tell us what size we need to
	  set the file to.</p></div></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="x86-software-fsm"></a>11.11.2. Implementing FSM in Software</h3></div></div></div><p>The hardest part of working with a <span class="emphasis"><em>finite state
	  machine</em></span> is analyzing the problem and expressing
	it as a <span class="emphasis"><em>finite state machine</em></span>.  That
	accomplished, the software almost writes itself.</p><p>In a high-level language, such as C, there are several
	main approaches.  One is to use a <code class="function">switch</code> statement which chooses
	what function should be run.  For example,</p><pre class="programlisting">switch (state) {
	default:
	case REGULAR:
		regular(inputchar);
		break;
	case CR:
		cr(inputchar);
		break;
	case LF:
		lf(inputchar);
		break;
	}</pre><p>Another approach is by using an array of function
	pointers, something like this:</p><pre class="programlisting">(output[state])(inputchar);</pre><p>Yet another is to have <code class="varname">state</code> be a
	function pointer, set to point at the appropriate
	function:</p><pre class="programlisting">(*state)(inputchar);</pre><p>This is the approach we will use in our program because it
	is very easy to do in assembly language, and very fast, too.
	We will simply keep the address of the right procedure in
	<code class="varname">EBX</code>, and then just
	issue:</p><pre class="programlisting">call	ebx</pre><p>This is possibly faster than hardcoding the address in the
	code because the microprocessor does not have to fetch the
	address from the memory&#8212;it is already stored in one of
	its registers.  I said <span class="emphasis"><em>possibly</em></span> because
	with the caching modern microprocessors do, either way may be
	equally fast.</p></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="memory-mapped-files"></a>11.11.3. Memory Mapped Files</h3></div></div></div><p>Because our program works on a single file, we cannot use
	the approach that worked for us before, i.e., to read from an
	input file and to write to an output file.</p><p><span class="trademark">UNIX</span>® allows us to map a file, or a section of a file,
	into memory.  To do that, we first need to open the file with
	the appropriate read/write flags.  Then we use the <code class="function">mmap</code> system call to map it into
	the memory.  One nice thing about <code class="function">mmap</code> is that it automatically
	works with virtual memory: We can map more of the file into
	the memory than we have physical memory available, yet still
	access it through regular memory op codes, such as <code class="function">mov</code>, <code class="function">lods</code>, and <code class="function">stos</code>.  Whatever changes we make to
	the memory image of the file will be written to the file by
	the system.  We do not even have to keep the file open: As
	long as it stays mapped, we can read from it and write to
	it.</p><p>The 32-bit Intel microprocessors can access up to four
	gigabytes of memory &#8211; physical or virtual.  The FreeBSD
	system allows us to use up to a half of it for file
	mapping.</p><p>For simplicity sake, in this tutorial we will only convert
	files that can be mapped into the memory in their entirety.
	There are probably not too many text files that exceed two
	gigabytes in size.  If our program encounters one, it will
	simply display a message suggesting we use the original
	<span class="application">tuc</span> instead.</p><p>If you examine your copy of
	<code class="filename">syscalls.master</code>, you will find two
	separate syscalls named <code class="function">mmap</code>.  This is because of
	evolution of <span class="trademark">UNIX</span>®: There was the traditional
	<acronym class="acronym">BSD</acronym>
	<code class="function">mmap</code>, syscall 71.  That one was
	superseded by the <acronym class="acronym"><span class="trademark">POSIX</span>®</acronym> <code class="function">mmap</code>, syscall 197.  The FreeBSD
	system supports both because older programs were written by
	using the original <acronym class="acronym">BSD</acronym> version.  But new
	software uses the <acronym class="acronym"><span class="trademark">POSIX</span>®</acronym> version, which is
	what we will use.</p><p>The <code class="filename">syscalls.master</code> lists the
	<acronym class="acronym"><span class="trademark">POSIX</span>®</acronym> version like this:</p><pre class="programlisting">197	STD	BSD	{ caddr_t mmap(caddr_t addr, size_t len, int prot, \
			    int flags, int fd, long pad, off_t pos); }</pre><p>This differs slightly from what
	<a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=mmap&amp;sektion=2&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">mmap</span>(2)</span></a>
	says.  That is because
	<a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=mmap&amp;sektion=2&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">mmap</span>(2)</span></a>
	describes the C version.</p><p>The difference is in the <code class="varname">long pad</code>
	argument, which is not present in the C version.  However, the
	FreeBSD syscalls add a 32-bit pad after <code class="function">push</code>ing a 64-bit argument.  In this
	case, <code class="varname">off_t</code> is a 64-bit value.</p><p>When we are finished working with a memory-mapped file, we
	unmap it with the <code class="function">munmap</code> syscall:</p><div xmlns="" class="tip"><h3 class="admontitle">Tip: </h3><p xmlns="http://www.w3.org/1999/xhtml">For an in-depth treatment of <code class="function">mmap</code>, see W. Richard Stevens'
	  <a class="link" href="http://www.int80h.org/cgi-bin/isbn?isbn=0130810819" target="_top">Unix
	    Network Programming, Volume 2, Chapter 12</a>.</p></div></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="x86-file-size"></a>11.11.4. Determining File Size</h3></div></div></div><p>Because we need to tell <code class="function">mmap</code> how many bytes of the file to
	map into the memory, and because we want to map the entire
	file, we need to determine the size of the file.</p><p>We can use the <code class="function">fstat</code>
	syscall to get all the information about an open file that the
	system can give us.  That includes the file size.</p><p>Again, <code class="filename">syscalls.master</code> lists two
	versions of <code class="function">fstat</code>, a
	traditional one (syscall 62), and a <acronym class="acronym"><span class="trademark">POSIX</span>®</acronym>
	one (syscall 189).  Naturally, we will use the
	<acronym class="acronym"><span class="trademark">POSIX</span>®</acronym> version:</p><pre class="programlisting">189	STD	POSIX	{ int fstat(int fd, struct stat *sb); }</pre><p>This is a very straightforward call: We pass to it the
	address of a <code class="varname">stat</code>
	structure and the descriptor of an open file.  It will fill
	out the contents of the <code class="varname">stat</code> structure.</p><p>I do, however, have to say that I tried to declare the
	<code class="varname">stat</code> structure in the
	<code class="varname">.bss</code> section, and <code class="function">fstat</code> did not like it: It set the
	carry flag indicating an error.  After I changed the code to
	allocate the structure on the stack, everything was working
	fine.</p></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="x86-ftruncate"></a>11.11.5. Changing the File Size</h3></div></div></div><p>Because our program may combine carriage return / line
	feed sequences into straight line feeds, our output may be
	smaller than our input.  However, since we are placing our
	output into the same file we read the input from, we may have
	to change the size of the file.</p><p>The <code class="function">ftruncate</code> system
	call allows us to do just that.  Despite its somewhat
	misleading name, the <code class="function">ftruncate</code> system call can be used
	to both truncate the file (make it smaller) and to grow
	it.</p><p>And yes, we will find two versions of <code class="function">ftruncate</code> in
	<code class="filename">syscalls.master</code>, an older one (130), and
	a newer one (201).  We will use the newer one:</p><pre class="programlisting">201	STD	BSD	{ int ftruncate(int fd, int pad, off_t length); }</pre><p>Please note that this one contains a <code class="varname">int
	  pad</code> again.</p></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="x86-ftuc"></a>11.11.6. ftuc</h3></div></div></div><p>We now know everything we need to write
	<span class="application">ftuc</span>.  We start by adding some new
	lines in <code class="filename">system.inc</code>.  First, we define
	some constants and structures, somewhere at or near the
	beginning of the file:</p><pre class="programlisting">;;;;;;; open flags
%define	O_RDONLY	0
%define	O_WRONLY	1
%define	O_RDWR	2

;;;;;;; mmap flags
%define	PROT_NONE	0
%define	PROT_READ	1
%define	PROT_WRITE	2
%define	PROT_EXEC	4
;;
%define	MAP_SHARED	0001h
%define	MAP_PRIVATE	0002h

;;;;;;; stat structure
struc	stat
st_dev		resd	1	; = 0
st_ino		resd	1	; = 4
st_mode		resw	1	; = 8, size is 16 bits
st_nlink	resw	1	; = 10, ditto
st_uid		resd	1	; = 12
st_gid		resd	1	; = 16
st_rdev		resd	1	; = 20
st_atime	resd	1	; = 24
st_atimensec	resd	1	; = 28
st_mtime	resd	1	; = 32
st_mtimensec	resd	1	; = 36
st_ctime	resd	1	; = 40
st_ctimensec	resd	1	; = 44
st_size		resd	2	; = 48, size is 64 bits
st_blocks	resd	2	; = 56, ditto
st_blksize	resd	1	; = 64
st_flags	resd	1	; = 68
st_gen		resd	1	; = 72
st_lspare	resd	1	; = 76
st_qspare	resd	4	; = 80
endstruc</pre><p>We define the new syscalls:</p><pre class="programlisting">%define	SYS_mmap	197
%define	SYS_munmap	73
%define	SYS_fstat	189
%define	SYS_ftruncate	201</pre><p>We add the macros for their use:</p><pre class="programlisting">%macro	sys.mmap	0
	system	SYS_mmap
%endmacro

%macro	sys.munmap	0
	system	SYS_munmap
%endmacro

%macro	sys.ftruncate	0
	system	SYS_ftruncate
%endmacro

%macro	sys.fstat	0
	system	SYS_fstat
%endmacro</pre><p>And here is our code:</p><pre class="programlisting">;;;;;;; Fast Text-to-Unix Conversion (ftuc.asm) ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;;
;; Started:	21-Dec-2000
;; Updated:	22-Dec-2000
;;
;; Copyright 2000 G. Adam Stanislav.
;; All rights reserved.
;;
;;;;;;; v.1 ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
%include	'system.inc'

section	.data
	db	'Copyright 2000 G. Adam Stanislav.', 0Ah
	db	'All rights reserved.', 0Ah
usg	db	'Usage: ftuc filename', 0Ah
usglen	equ	$-usg
co	db	"ftuc: Can't open file.", 0Ah
colen	equ	$-co
fae	db	'ftuc: File access error.', 0Ah
faelen	equ	$-fae
ftl	db	'ftuc: File too long, use regular tuc instead.', 0Ah
ftllen	equ	$-ftl
mae	db	'ftuc: Memory allocation error.', 0Ah
maelen	equ	$-mae

section	.text

align 4
memerr:
	push	dword maelen
	push	dword mae
	jmp	short error

align 4
toolong:
	push	dword ftllen
	push	dword ftl
	jmp	short error

align 4
facerr:
	push	dword faelen
	push	dword fae
	jmp	short error

align 4
cantopen:
	push	dword colen
	push	dword co
	jmp	short error

align 4
usage:
	push	dword usglen
	push	dword usg

error:
	push	dword stderr
	sys.write

	push	dword 1
	sys.exit

align 4
global	_start
_start:
	pop	eax		; argc
	pop	eax		; program name
	pop	ecx		; file to convert
	jecxz	usage

	pop	eax
	or	eax, eax	; Too many arguments?
	jne	usage

	; Open the file
	push	dword O_RDWR
	push	ecx
	sys.open
	jc	cantopen

	mov	ebp, eax	; Save fd

	sub	esp, byte stat_size
	mov	ebx, esp

	; Find file size
	push	ebx
	push	ebp		; fd
	sys.fstat
	jc	facerr

	mov	edx, [ebx + st_size + 4]

	; File is too long if EDX != 0 ...
	or	edx, edx
	jne	near toolong
	mov	ecx, [ebx + st_size]
	; ... or if it is above 2 GB
	or	ecx, ecx
	js	near toolong

	; Do nothing if the file is 0 bytes in size
	jecxz	.quit

	; Map the entire file in memory
	push	edx
	push	edx		; starting at offset 0
	push	edx		; pad
	push	ebp		; fd
	push	dword MAP_SHARED
	push	dword PROT_READ | PROT_WRITE
	push	ecx		; entire file size
	push	edx		; let system decide on the address
	sys.mmap
	jc	near memerr

	mov	edi, eax
	mov	esi, eax
	push	ecx		; for SYS_munmap
	push	edi

	; Use EBX for state machine
	mov	ebx, ordinary
	mov	ah, 0Ah
	cld

.loop:
	lodsb
	call	ebx
	loop	.loop

	cmp	ebx, ordinary
	je	.filesize

	; Output final lf
	mov	al, ah
	stosb
	inc	edx

.filesize:
	; truncate file to new size
	push	dword 0		; high dword
	push	edx		; low dword
	push	eax		; pad
	push	ebp
	sys.ftruncate

	; close it (ebp still pushed)
	sys.close

	add	esp, byte 16
	sys.munmap

.quit:
	push	dword 0
	sys.exit

align 4
ordinary:
	cmp	al, 0Dh
	je	.cr

	cmp	al, ah
	je	.lf

	stosb
	inc	edx
	ret

align 4
.cr:
	mov	ebx, cr
	ret

align 4
.lf:
	mov	ebx, lf
	ret

align 4
cr:
	cmp	al, 0Dh
	je	.cr

	cmp	al, ah
	je	.lf

	xchg	al, ah
	stosb
	inc	edx

	xchg	al, ah
	; fall through

.lf:
	stosb
	inc	edx
	mov	ebx, ordinary
	ret

align 4
.cr:
	mov	al, ah
	stosb
	inc	edx
	ret

align 4
lf:
	cmp	al, ah
	je	.lf

	cmp	al, 0Dh
	je	.cr

	xchg	al, ah
	stosb
	inc	edx

	xchg	al, ah
	stosb
	inc	edx
	mov	ebx, ordinary
	ret

align 4
.cr:
	mov	ebx, ordinary
	mov	al, ah
	; fall through

.lf:
	stosb
	inc	edx
	ret</pre><div xmlns="" class="warning"><h3 class="admontitle">Warning: </h3><p xmlns="http://www.w3.org/1999/xhtml">Do not use this program on files stored on a disk
	  formatted by <acronym class="acronym"><span class="trademark">MS-DOS</span>®</acronym> or <span class="trademark">Windows</span>®.
	  There seems to be a subtle bug in the FreeBSD code when
	  using <code class="function">mmap</code> on these
	  drives mounted under FreeBSD: If the file is over a certain
	  size, <code class="function">mmap</code> will just
	  fill the memory with zeros, and then copy them to the file
	  overwriting its contents.</p></div></div></div><div class="sect1"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="x86-one-pointed-mind"></a>11.12. One-Pointed Mind</h2></div></div></div><p>As a student of Zen, I like the idea of a one-pointed mind:
      Do one thing at a time, and do it well.</p><p>This, indeed, is very much how <span class="trademark">UNIX</span>® works as well.  While
      a typical <span class="trademark">Windows</span>® application is attempting to do everything
      imaginable (and is, therefore, riddled with bugs), a typical
      <span class="trademark">UNIX</span>® program does only one thing, and it does it well.</p><p>The typical <span class="trademark">UNIX</span>® user then essentially assembles his own
      applications by writing a shell script which combines the
      various existing programs by piping the output of one program to
      the input of another.</p><p>When writing your own <span class="trademark">UNIX</span>® software, it is generally a
      good idea to see what parts of the problem you need to solve can
      be handled by existing programs, and only write your own
      programs for that part of the problem that you do not have an
      existing solution for.</p><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="x86-csv"></a>11.12.1. CSV</h3></div></div></div><p>I will illustrate this principle with a specific real-life
	example I was faced with recently:</p><p>I needed to extract the 11th field of each record from a
	database I downloaded from a web site.  The database was a
	<acronym class="acronym">CSV</acronym> file, i.e., a list of
	<span class="emphasis"><em>comma-separated values</em></span>.  That is quite
	a standard format for sharing data among people who may be
	using different database software.</p><p>The first line of the file contains the list of various
	fields separated by commas.  The rest of the file contains the
	data listed line by line, with values separated by
	commas.</p><p>I tried <span class="application">awk</span>, using the comma as
	a separator.  But because several lines contained a quoted
	comma, <span class="application">awk</span> was extracting the wrong
	field from those lines.</p><p>Therefore, I needed to write my own software to extract
	the 11th field from the <acronym class="acronym">CSV</acronym> file.  However,
	going with the <span class="trademark">UNIX</span>® spirit, I only needed to write a simple
	filter that would do the following:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Remove the first line from the file;</p></li><li class="listitem"><p>Change all unquoted commas to a different
	    character;</p></li><li class="listitem"><p>Remove all quotation marks.</p></li></ul></div><p>Strictly speaking, I could use
	<span class="application">sed</span> to remove the first line from
	the file, but doing so in my own program was very easy, so I
	decided to do it and reduce the size of the pipeline.</p><p>At any rate, writing a program like this took me about
	20 minutes.  Writing a program that extracts the 11th field
	from the <acronym class="acronym">CSV</acronym> file would take a lot longer,
	and I could not reuse it to extract some other field from some
	other database.</p><p>This time I decided to let it do a little more work than a
	typical tutorial program would:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>It parses its command line for options;</p></li><li class="listitem"><p>It displays proper usage if it finds wrong
	    arguments;</p></li><li class="listitem"><p>It produces meaningful error messages.</p></li></ul></div><p>Here is its usage message:</p><pre class="screen">Usage: csv [-t&lt;delim&gt;] [-c&lt;comma&gt;] [-p] [-o &lt;outfile&gt;] [-i &lt;infile&gt;]</pre><p>All parameters are optional, and can appear in any
	order.</p><p>The <em class="parameter"><code>-t</code></em> parameter declares what to
	replace the commas with.  The <code class="constant">tab</code> is the
	default here.  For example, <em class="parameter"><code>-t;</code></em> will
	replace all unquoted commas with semicolons.</p><p>I did not need the <em class="parameter"><code>-c</code></em> option, but
	it may come in handy in the future.  It lets me declare that I
	want a character other than a comma replaced with something
	else.  For example, <em class="parameter"><code>-c@</code></em> will replace
	all at signs (useful if you want to split a list of email
	addresses to their user names and domains).</p><p>The <em class="parameter"><code>-p</code></em> option preserves the first
	line, i.e., it does not delete it.  By default, we delete the
	first line because in a <acronym class="acronym">CSV</acronym> file it
	contains the field names rather than data.</p><p>The <em class="parameter"><code>-i</code></em> and
	<em class="parameter"><code>-o</code></em> options let me specify the input and
	the output files.  Defaults are <code class="filename">stdin</code> and
	<code class="filename">stdout</code>, so this is a regular <span class="trademark">UNIX</span>®
	filter.</p><p>I made sure that both <em class="parameter"><code>-i filename</code></em>
	and <em class="parameter"><code>-ifilename</code></em> are accepted.  I also
	made sure that only one input and one output files may be
	specified.</p><p>To get the 11th field of each record, I can now do:</p><pre class="screen"><code class="prompt">%</code> <strong class="userinput"><code>csv '-t;' <em class="replaceable"><code>data.csv</code></em> | awk '-F;' '{print $11}'</code></strong></pre><p>The code stores the options (except for the file
	descriptors) in <code class="varname">EDX</code>: The
	comma in <code class="varname">DH</code>, the new
	separator in <code class="varname">DL</code>, and the
	flag for the <em class="parameter"><code>-p</code></em> option in the highest
	bit of <code class="varname">EDX</code>, so a check for
	its sign will give us a quick decision what to do.</p><p>Here is the code:</p><pre class="programlisting">;;;;;;; csv.asm ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;
; Convert a comma-separated file to a something-else separated file.
;
; Started:	31-May-2001
; Updated:	 1-Jun-2001
;
; Copyright (c) 2001 G. Adam Stanislav
; All rights reserved.
;
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;

%include	'system.inc'

%define	BUFSIZE	2048

section	.data
fd.in	dd	stdin
fd.out	dd	stdout
usg	db	'Usage: csv [-t&lt;delim&gt;] [-c&lt;comma&gt;] [-p] [-o &lt;outfile&gt;] [-i &lt;infile&gt;]', 0Ah
usglen	equ	$-usg
iemsg	db	"csv: Can't open input file", 0Ah
iemlen	equ	$-iemsg
oemsg	db	"csv: Can't create output file", 0Ah
oemlen	equ	$-oemsg

section .bss
ibuffer	resb	BUFSIZE
obuffer	resb	BUFSIZE

section	.text
align 4
ierr:
	push	dword iemlen
	push	dword iemsg
	push	dword stderr
	sys.write
	push	dword 1		; return failure
	sys.exit

align 4
oerr:
	push	dword oemlen
	push	dword oemsg
	push	dword stderr
	sys.write
	push	dword 2
	sys.exit

align 4
usage:
	push	dword usglen
	push	dword usg
	push	dword stderr
	sys.write
	push	dword 3
	sys.exit

align 4
global	_start
_start:
	add	esp, byte 8	; discard argc and argv[0]
	mov	edx, (',' &lt;&lt; 8) | 9

.arg:
	pop	ecx
	or	ecx, ecx
	je	near .init		; no more arguments

	; ECX contains the pointer to an argument
	cmp	byte [ecx], '-'
	jne	usage

	inc	ecx
	mov	ax, [ecx]

.o:
	cmp	al, 'o'
	jne	.i

	; Make sure we are not asked for the output file twice
	cmp	dword [fd.out], stdout
	jne	usage

	; Find the path to output file - it is either at [ECX+1],
	; i.e., -ofile --
	; or in the next argument,
	; i.e., -o file

	inc	ecx
	or	ah, ah
	jne	.openoutput
	pop	ecx
	jecxz	usage

.openoutput:
	push	dword 420	; file mode (644 octal)
	push	dword 0200h | 0400h | 01h
	; O_CREAT | O_TRUNC | O_WRONLY
	push	ecx
	sys.open
	jc	near oerr

	add	esp, byte 12
	mov	[fd.out], eax
	jmp	short .arg

.i:
	cmp	al, 'i'
	jne	.p

	; Make sure we are not asked twice
	cmp	dword [fd.in], stdin
	jne	near usage

	; Find the path to the input file
	inc	ecx
	or	ah, ah
	jne	.openinput
	pop	ecx
	or	ecx, ecx
	je near usage

.openinput:
	push	dword 0		; O_RDONLY
	push	ecx
	sys.open
	jc	near ierr		; open failed

	add	esp, byte 8
	mov	[fd.in], eax
	jmp	.arg

.p:
	cmp	al, 'p'
	jne	.t
	or	ah, ah
	jne	near usage
	or	edx, 1 &lt;&lt; 31
	jmp	.arg

.t:
	cmp	al, 't'		; redefine output delimiter
	jne	.c
	or	ah, ah
	je	near usage
	mov	dl, ah
	jmp	.arg

.c:
	cmp	al, 'c'
	jne	near usage
	or	ah, ah
	je	near usage
	mov	dh, ah
	jmp	.arg

align 4
.init:
	sub	eax, eax
	sub	ebx, ebx
	sub	ecx, ecx
	mov	edi, obuffer

	; See if we are to preserve the first line
	or	edx, edx
	js	.loop

.firstline:
	; get rid of the first line
	call	getchar
	cmp	al, 0Ah
	jne	.firstline

.loop:
	; read a byte from stdin
	call	getchar

	; is it a comma (or whatever the user asked for)?
	cmp	al, dh
	jne	.quote

	; Replace the comma with a tab (or whatever the user wants)
	mov	al, dl

.put:
	call	putchar
	jmp	short .loop

.quote:
	cmp	al, '"'
	jne	.put

	; Print everything until you get another quote or EOL. If it
	; is a quote, skip it. If it is EOL, print it.
.qloop:
	call	getchar
	cmp	al, '"'
	je	.loop

	cmp	al, 0Ah
	je	.put

	call	putchar
	jmp	short .qloop

align 4
getchar:
	or	ebx, ebx
	jne	.fetch

	call	read

.fetch:
	lodsb
	dec	ebx
	ret

read:
	jecxz	.read
	call	write

.read:
	push	dword BUFSIZE
	mov	esi, ibuffer
	push	esi
	push	dword [fd.in]
	sys.read
	add	esp, byte 12
	mov	ebx, eax
	or	eax, eax
	je	.done
	sub	eax, eax
	ret

align 4
.done:
	call	write		; flush output buffer

	; close files
	push	dword [fd.in]
	sys.close

	push	dword [fd.out]
	sys.close

	; return success
	push	dword 0
	sys.exit

align 4
putchar:
	stosb
	inc	ecx
	cmp	ecx, BUFSIZE
	je	write
	ret

align 4
write:
	jecxz	.ret	; nothing to write
	sub	edi, ecx	; start of buffer
	push	ecx
	push	edi
	push	dword [fd.out]
	sys.write
	add	esp, byte 12
	sub	eax, eax
	sub	ecx, ecx	; buffer is empty now
.ret:
	ret</pre><p>Much of it is taken from <code class="filename">hex.asm</code>
	above.  But there is one important difference: I no longer
	call <code class="function">write</code> whenever I am outputting a
	line feed.  Yet, the code can be used interactively.</p><p>I have found a better solution for the interactive problem
	since I first started writing this chapter.  I wanted to
	make sure each line is printed out separately only when
	needed.  After all, there is no need to flush out every line
	when used non-interactively.</p><p>The new solution I use now is to call
	<code class="function">write</code> every time I find the input buffer
	  empty.  That way, when running in the interactive mode, the
	  program reads one line from the user's keyboard, processes
	  it, and sees its input buffer is empty.  It flushes its
	  output and reads the next line.</p><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="x86-buffered-dark-side"></a>11.12.1.1. The Dark Side of Buffering</h4></div></div></div><p>This change prevents a mysterious lockup in a very
	    specific case.  I refer to it as the <span class="emphasis"><em>dark side
	      of buffering</em></span>, mostly because it presents a
	    danger that is not quite obvious.</p><p>It is unlikely to happen with a program like the
	    <span class="application">csv</span> above, so let us consider
	    yet another filter: In this case we expect our input to be
	    raw data representing color values, such as the
	    <span class="emphasis"><em>red</em></span>, <span class="emphasis"><em>green</em></span>, and
	    <span class="emphasis"><em>blue</em></span> intensities of a pixel.  Our
	    output will be the negative of our input.</p><p>Such a filter would be very simple to write.  Most of
	    it would look just like all the other filters we have
	    written so far, so I am only going to show you its inner
	    loop:</p><pre class="programlisting">.loop:
	call	getchar
	not	al		; Create a negative
	call	putchar
	jmp	short .loop</pre><p>Because this filter works with raw data, it is
	    unlikely to be used interactively.</p><p>But it could be called by image manipulation software.
	    And, unless it calls <code class="function">write</code> before
	    each call to <code class="function">read</code>, chances are it
	    will lock up.</p><p>Here is what might happen:</p><div class="procedure"><ol class="procedure" type="1"><li class="step"><p>The image editor will load our filter using the C
		function <code class="function">popen()</code>.</p></li><li class="step"><p>It will read the first row of pixels from a bitmap
		or pixmap.</p></li><li class="step"><p>It will write the first row of pixels to the
		<span class="emphasis"><em>pipe</em></span> leading to the
		<code class="varname">fd.in</code> of our filter.</p></li><li class="step"><p>Our filter will read each pixel from its input,
		turn it to a negative, and write it to its output
		buffer.</p></li><li class="step"><p>Our filter will call <code class="function">getchar</code>
		to fetch the next pixel.</p></li><li class="step"><p><code class="function">getchar</code> will find an empty
		input buffer, so it will call
		<code class="function">read</code>.</p></li><li class="step"><p><code class="function">read</code> will call the <code class="function">SYS_read</code> system
		call.</p></li><li class="step"><p>The <span class="emphasis"><em>kernel</em></span> will suspend our
		filter until the image editor sends more data to the
		pipe.</p></li><li class="step"><p>The image editor will read from the other pipe,
		connected to the <code class="varname">fd.out</code> of our
		filter so it can set the first row of the output image
		<span class="emphasis"><em>before</em></span> it sends us the second row
		of the input.</p></li><li class="step"><p>The <span class="emphasis"><em>kernel</em></span> suspends the image
		editor until it receives some output from our filter,
		so it can pass it on to the image editor.</p></li></ol></div><p>At this point our filter waits for the image editor to
	    send it more data to process, while the image editor is
	    waiting for our filter to send it the result of the
	    processing of the first row.  But the result sits in our
	    output buffer.</p><p>The filter and the image editor will continue waiting
	    for each other forever (or, at least, until they are
	    killed).  Our software has just entered a <a class="link" href="#secure-race-conditions" title="3.7. Race Conditions">race
	      condition</a>.</p><p>This problem does not exist if our filter flushes its
	    output buffer <span class="emphasis"><em>before</em></span> asking the
	    <span class="emphasis"><em>kernel</em></span> for more input data.</p></div></div></div><div class="sect1"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="x86-fpu"></a>11.13. Using the <acronym class="acronym">FPU</acronym></h2></div></div></div><p>Strangely enough, most of assembly language literature
	does not even mention the existence of the
	<acronym class="acronym">FPU</acronym>, or <span class="emphasis"><em>floating point
	  unit</em></span>, let alone discuss programming it.</p><p>Yet, never does assembly language shine more than when we
	create highly optimized <acronym class="acronym">FPU</acronym> code by doing
	things that can be done <span class="emphasis"><em>only</em></span> in assembly
	language.</p><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="x86-fpu-organization"></a>11.13.1. Organization of the <acronym class="acronym">FPU</acronym></h3></div></div></div><p>The <acronym class="acronym">FPU</acronym> consists of 8 80&#8211;bit
	  floating&#8211;point registers.  These are organized in a
	  stack fashion&#8212;you can <code class="function">push</code> a
	  value on <acronym class="acronym">TOS</acronym> (<span class="emphasis"><em>top of
	    stack</em></span>) and you can <code class="function">pop</code>
	  it.</p><p>That said, the assembly language op codes are not
	  <code class="function">push</code> and <code class="function">pop</code> because those are already
	  taken.</p><p>You can <code class="function">push</code> a value on
	  <acronym class="acronym">TOS</acronym> by using <code class="function">fld</code>, <code class="function">fild</code>, and <code class="function">fbld</code>.  Several other op codes let
	  you <code class="function">push</code> many common
	  <span class="emphasis"><em>constants</em></span>&#8212;such as
	  <span class="emphasis"><em>pi</em></span>&#8212;on the
	  <acronym class="acronym">TOS</acronym>.</p><p>Similarly, you can <code class="function">pop</code> a value by
	  using <code class="function">fst</code>, <code class="function">fstp</code>, <code class="function">fist</code>, <code class="function">fistp</code>, and <code class="function">fbstp</code>.  Actually, only the op
	  codes that end with a <span class="emphasis"><em>p</em></span> will literally
	  <code class="function">pop</code> the value, the rest will
	  <code class="function">store</code> it somewhere else without
	  removing it from the <acronym class="acronym">TOS</acronym>.</p><p>We can transfer the data between the
	  <acronym class="acronym">TOS</acronym> and the computer memory either as a
	  32&#8211;bit, 64&#8211;bit, or 80&#8211;bit
	  <span class="emphasis"><em>real</em></span>, a 16&#8211;bit, 32&#8211;bit, or
	  64&#8211;bit <span class="emphasis"><em>integer</em></span>, or an
	  80&#8211;bit <span class="emphasis"><em>packed decimal</em></span>.</p><p>The 80&#8211;bit <span class="emphasis"><em>packed decimal</em></span> is
	  a special case of <span class="emphasis"><em>binary coded decimal</em></span>
	  which is very convenient when converting between the
	  <acronym class="acronym">ASCII</acronym> representation of data and the
	  internal data of the <acronym class="acronym">FPU</acronym>.  It allows us
	  to use 18 significant digits.</p><p>No matter how we represent data in the memory, the
	  <acronym class="acronym">FPU</acronym> always stores it in the 80&#8211;bit
	  <span class="emphasis"><em>real</em></span> format in its registers.</p><p>Its internal precision is at least 19 decimal digits, so
	  even if we choose to display results as
	  <acronym class="acronym">ASCII</acronym> in the full 18&#8211;digit
	  precision, we are still showing correct results.</p><p>We can perform mathematical operations on the
	  <acronym class="acronym">TOS</acronym>: We can calculate its
	  <span class="emphasis"><em>sine</em></span>, we can <span class="emphasis"><em>scale</em></span>
	  it (i.e., we can multiply or divide it by a power of 2), we
	  can calculate its base&#8211;2
	  <span class="emphasis"><em>logarithm</em></span>, and many other
	  things.</p><p>We can also <span class="emphasis"><em>multiply</em></span> or
	  <span class="emphasis"><em>divide</em></span> it by, <span class="emphasis"><em>add</em></span>
	  it to, or <span class="emphasis"><em>subtract</em></span> it from, any of the
	  <acronym class="acronym">FPU</acronym> registers (including itself).</p><p>The official Intel op code for the
	  <acronym class="acronym">TOS</acronym> is <code class="varname">st</code>, and for the
	  <span class="emphasis"><em>registers</em></span> <code class="varname">st(0)</code>&#8211;<code class="varname">st(7)</code>.  <code class="varname">st</code> and <code class="varname">st(0)</code>, then,
	  refer to the same register.</p><p>For whatever reasons, the original author of
	  <span class="application">nasm</span> has decided to use
	  different op codes, namely <code class="varname">st0</code>&#8211;<code class="varname">st7</code>.  In other words, there are
	  no parentheses, and the <acronym class="acronym">TOS</acronym> is always
	  <code class="varname">st0</code>, never just
	  <code class="function">st</code>.</p><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="x86-fpu-packed-decimal"></a>11.13.1.1. The Packed Decimal Format</h4></div></div></div><p>The <span class="emphasis"><em>packed decimal</em></span> format uses 10
	    bytes (80 bits) of memory to represent 18 digits.  The
	    number represented there is always an
	    <span class="emphasis"><em>integer</em></span>.</p><div xmlns="" class="tip"><h3 class="admontitle">Tip: </h3><p xmlns="http://www.w3.org/1999/xhtml">You can use it to get decimal places by multiplying
	      the <acronym class="acronym">TOS</acronym> by a power of 10
	      first.</p></div><p>The highest bit of the highest byte (byte 9) is the
	    <span class="emphasis"><em>sign bit</em></span>: If it is set, the number is
	    <span class="emphasis"><em>negative</em></span>, otherwise, it is
	    <span class="emphasis"><em>positive</em></span>.  The rest of the bits of
	    this byte are unused/ignored.</p><p>The remaining 9 bytes store the 18 digits of the
	    number: 2 digits per byte.</p><p>The <span class="emphasis"><em>more significant digit</em></span> is
	    stored in the high <span class="emphasis"><em>nibble</em></span> (4 bits),
	    the <span class="emphasis"><em>less significant digit</em></span> in the low
	    <span class="emphasis"><em>nibble</em></span>.</p><p>That said, you might think that
	    <code class="constant">-1234567</code> would be stored in the
	    memory like this (using hexadecimal notation):</p><pre class="programlisting">80 00 00 00 00 00 01 23 45 67</pre><p>Alas it is not! As with everything else of Intel make,
	    even the <span class="emphasis"><em>packed decimal</em></span> is
	    <span class="emphasis"><em>little&#8211;endian</em></span>.</p><p>That means our <code class="constant">-1234567</code> is stored
	    like this:</p><pre class="programlisting">67 45 23 01 00 00 00 00 00 80</pre><p>Remember that, or you will be pulling your hair out in
	    desperation!</p><div xmlns="" class="note"><h3 class="admontitle">Note: </h3><p xmlns="http://www.w3.org/1999/xhtml">The book to read&#8212;if you can find it&#8212;is
	      Richard Startz' <a class="link" href="http://www.amazon.com/exec/obidos/ASIN/013246604X/whizkidtechnomag" target="_top">8087/80287/80387
	      for the IBM PC &amp; Compatibles</a>.  Though it does
	      seem to take the fact about the little&#8211;endian
	      storage of the <span class="emphasis"><em>packed decimal</em></span> for
	      granted.  I kid you not about the desperation of trying
	      to figure out what was wrong with the filter I show
	      below <span class="emphasis"><em>before</em></span> it occurred to me I
	      should try the little&#8211;endian order even for this
	      type of data.</p></div></div></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="x86-pinhole-photography"></a>11.13.2. Excursion to Pinhole Photography</h3></div></div></div><p>To write meaningful software, we must not only
	  understand our programming tools, but also the
	  field we are creating software for.</p><p>Our next filter will help us whenever we want to build a
	  <span class="emphasis"><em>pinhole camera</em></span>, so, we need some
	  background in <span class="emphasis"><em>pinhole photography</em></span>
	  before we can continue.</p><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="x86-camera"></a>11.13.2.1. The Camera</h4></div></div></div><p>The easiest way to describe any camera ever built is
	    as some empty space enclosed in some lightproof material,
	    with a small hole in the enclosure.</p><p>The enclosure is usually sturdy (e.g., a box), though
	    sometimes it is flexible (the bellows).  It is quite dark
	    inside the camera.  However, the hole lets light rays in
	    through a single point (though in some cases there may be
	    several).  These light rays form an image, a
	    representation of whatever is outside the camera, in front
	    of the hole.</p><p>If some light sensitive material (such as film) is
	    placed inside the camera, it can capture the image.</p><p>The hole often contains a <span class="emphasis"><em>lens</em></span>,
	    or a lens assembly, often called the
	    <span class="emphasis"><em>objective</em></span>.</p></div><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="x86-the-pinhole"></a>11.13.2.2. The Pinhole</h4></div></div></div><p>But, strictly speaking, the lens is not necessary: The
	    original cameras did not use a lens but a
	    <span class="emphasis"><em>pinhole</em></span>.  Even today,
	    <span class="emphasis"><em>pinholes</em></span> are used, both as a tool to
	    study how cameras work, and to achieve a special kind of
	    image.</p><p>The image produced by the <span class="emphasis"><em>pinhole</em></span>
	    is all equally sharp.  Or <span class="emphasis"><em>blurred</em></span>.
	    There is an ideal size for a pinhole: If it is either
	    larger or smaller, the image loses its sharpness.</p></div><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="x86-focal-length"></a>11.13.2.3. Focal Length</h4></div></div></div><p>This ideal pinhole diameter is a function of the
	    square root of <span class="emphasis"><em>focal length</em></span>, which is
	    the distance of the pinhole from the film.</p><pre class="programlisting">D = PC * sqrt(FL)</pre><p>In here, <code class="varname">D</code> is the ideal diameter of
	    the pinhole, <code class="varname">FL</code> is the focal length,
	    and <code class="constant">PC</code> is a pinhole constant.
	    According to Jay Bender, its value is
	    <code class="constant">0.04</code>, while Kenneth Connors has
	    determined it to be <code class="constant">0.037</code>.  Others
	    have proposed other values.  Plus, this value is for the
	    daylight only: Other types of light will require a
	    different constant, whose value can only be determined by
	    experimentation.</p></div><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="x86-f-number"></a>11.13.2.4. The F&#8211;Number</h4></div></div></div><p>The f&#8211;number is a very useful measure of how
	    much light reaches the film.  A light meter can determine
	    that, for example, to expose a film of specific
	    sensitivity with f5.6 mkay require the exposure to last
	    1/1000 sec.</p><p>It does not matter whether it is a 35&#8211;mm
	    camera, or a 6x9cm camera, etc.  As long as we know the
	    f&#8211;number, we can determine the proper
	    exposure.</p><p>The f&#8211;number is easy to calculate:</p><pre class="programlisting">F = FL / D</pre><p>In other words, the f&#8211;number equals the focal
	    length divided by the diameter of the pinhole.  It also
	    means a higher f&#8211;number either implies a smaller
	    pinhole or a larger focal distance, or both.  That, in
	    turn, implies, the higher the f&#8211;number, the longer
	    the exposure has to be.</p><p>Furthermore, while pinhole diameter and focal distance
	    are one&#8211;dimensional measurements, both, the film and
	    the pinhole, are two&#8211;dimensional.  That means that
	    if you have measured the exposure at f&#8211;number
	    <code class="varname">A</code> as <code class="varname">t</code>, then the
	    exposure at f&#8211;number <code class="varname">B</code> is:</p><pre class="programlisting">t * (B / A)²</pre></div><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="x86-normalized-f-number"></a>11.13.2.5. Normalized F&#8211;Number</h4></div></div></div><p>While many modern cameras can change the diameter of
	    their pinhole, and thus their f&#8211;number, quite
	    smoothly and gradually, such was not always the
	    case.</p><p>To allow for different f&#8211;numbers, cameras
	    typically contained a metal plate with several holes of
	    different sizes drilled to them.</p><p>Their sizes were chosen according to the above formula
	    in such a way that the resultant f&#8211;number was one
	    of standard f&#8211;numbers used on all cameras
	    everywhere.  For example, a very old Kodak Duaflex IV
	    camera in my possession has three such holes for
	    f&#8211;numbers 8, 11, and 16.</p><p>A more recently made camera may offer f&#8211;numbers
	    of 2.8, 4, 5.6, 8, 11, 16, 22, and 32 (as well as others).
	    These numbers were not chosen arbitrarily: They all are
	    powers of the square root of 2, though they may be rounded
	    somewha.</p></div><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="x86-f-stop"></a>11.13.2.6. The F&#8211;Stop</h4></div></div></div><p>A typical camera is designed in such a way that
	    setting any of the normalized f&#8211;numbers changes the
	    feel of the dial.  It will naturally
	    <span class="emphasis"><em>stop</em></span> in that position.  Because of
	    that, these positions of the dial are called
	    f&#8211;stops.</p><p>Since the f&#8211;numbers at each stop are powers of
	    the square root of 2, moving the dial by 1 stop will
	    double the amount of light required for proper exposure.
	    Moving it by 2 stops will quadruple the required exposure.
	    Moving the dial by 3 stops will require the increase in
	    exposure 8 times, etc.</p></div></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="x86-pinhole-software"></a>11.13.3. Designing the Pinhole Software</h3></div></div></div><p>We are now ready to decide what exactly we want our
	  pinhole software to do.</p><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="xpinhole-processing-input"></a>11.13.3.1. Processing Program Input</h4></div></div></div><p>Since its main purpose is to help us design a working
	    pinhole camera, we will use the <span class="emphasis"><em>focal
	      length</em></span> as the input to the program.  This is
	    something we can determine without software: Proper focal
	    length is determined by the size of the film and by the
	    need to shoot "regular" pictures, wide angle pictures, or
	    telephoto pictures.</p><p>Most of the programs we have written so far worked
	    with individual characters, or bytes, as their input: The
	    <span class="application">hex</span> program converted
	    individual bytes into a hexadecimal number, the
	    <span class="application">csv</span> program either let a
	    character through, or deleted it, or changed it to a
	    different character, etc.</p><p>One program, <span class="application">ftuc</span> used the
	    state machine to consider at most two input bytes at a
	    time.</p><p>But our <span class="application">pinhole</span> program
	    cannot just work with individual characters, it has to
	    deal with larger syntactic units.</p><p>For example, if we want the program to calculate the
	    pinhole diameter (and other values we will discuss later)
	    at the focal lengths of <code class="constant">100 mm</code>,
	    <code class="constant">150 mm</code>, and <code class="constant">210
	      mm</code>, we may want to enter something like
	    this:</p><pre class="screen"><strong class="userinput"><code>100, 150, 210</code></strong></pre><p>Our program needs to consider more than a single byte
	    of input at a time.  When it sees the first
	    <code class="constant">1</code>, it must understand it is seeing
	    the first digit of a decimal number.  When it sees the
	    <code class="constant">0</code> and the other
	    <code class="constant">0</code>, it must know it is seeing more
	    digits of the same number.</p><p>When it encounters the first comma, it must know it is
	    no longer receiving the digits of the first number.  It
	    must be able to convert the digits of the first number
	    into the value of <code class="constant">100</code>.  And the
	    digits of the second number into the value of
	    <code class="constant">150</code>.  And, of course, the digits of
	    the third number into the numeric value of
	    <code class="constant">210</code>.</p><p>We need to decide what delimiters to accept: Do the
	    input numbers have to be separated by a comma? If so, how
	    do we treat two numbers separated by something
	    else?</p><p>Personally, I like to keep it simple.  Something
	    either is a number, so I process it.  Or it is not a
	    number, so I discard it.  I do not like the computer
	    complaining about me typing in an extra character when it
	    is <span class="emphasis"><em>obvious</em></span> that it is an extra
	    character.  Duh!</p><p>Plus, it allows me to break up the monotony of
	    computing and type in a query instead of just a
	    number:</p><pre class="screen"><strong class="userinput"><code>What is the best pinhole diameter for the
	    focal length of 150?</code></strong></pre><p>There is no reason for the computer to spit out a
	    number of complaints:</p><pre class="screen">Syntax error: What
Syntax error: is
Syntax error: the
Syntax error: best</pre><p>Et cetera, et cetera, et cetera.</p><p>Secondly, I like the <code class="constant">#</code> character
	    to denote the start of a comment which extends to the end
	    of the line.  This does not take too much effort to code,
	    and lets me treat input files for my software as
	    executable scripts.</p><p>In our case, we also need to decide what units the
	    input should come in: We choose
	    <span class="emphasis"><em>millimeters</em></span> because that is how most
	    photographers measure the focus length.</p><p>Finally, we need to decide whether to allow the use of
	    the decimal point (in which case we must also consider the
	    fact that much of the world uses a decimal
	    <span class="emphasis"><em>comma</em></span>).</p><p>In our case allowing for the decimal point/comma would
	    offer a false sense of precision: There is little if any
	    noticeable difference between the focus lengths of
	    <code class="constant">50</code> and <code class="constant">51</code>, so
	    allowing the user to input something like
	    <code class="constant">50.5</code> is not a good idea.  This is
	    my opinion, mind you, but I am the one writing this
	    program.  You can make other choices in yours, of
	    course.</p></div><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="x86-pinhole-options"></a>11.13.3.2. Offering Options</h4></div></div></div><p>The most important thing we need to know when building
	    a pinhole camera is the diameter of the pinhole.  Since we
	    want to shoot sharp images, we will use the above formula
	    to calculate the pinhole diameter from focal length.  As
	    experts are offering several different values for the
	    <code class="constant">PC</code> constant, we will need to have the
	    choice.</p><p>It is traditional in <span class="trademark">UNIX</span>® programming to have two
	    main ways of choosing program parameters, plus to have a
	    default for the time the user does not make a
	    choice.</p><p>Why have two ways of choosing?</p><p>One is to allow a (relatively)
	    <span class="emphasis"><em>permanent</em></span> choice that applies
	    automatically each time the software is run without us
	    having to tell it over and over what we want it to
	    do.</p><p>The permanent choices may be stored in a configuration
	    file, typically found in the user's home directory.  The
	    file usually has the same name as the application but is
	    started with a dot.  Often <span class="emphasis"><em>"rc"</em></span> is
	    added to the file name.  So, ours could be
	    <code class="filename">~/.pinhole</code> or
	    <code class="filename">~/.pinholerc</code>.  (The
	    <code class="filename">~/</code> means current user's home
	    directory.)</p><p>The configuration file is used mostly by programs that
	    have many configurable parameters.  Those that have only
	    one (or a few) often use a different method: They expect
	    to find the parameter in an <span class="emphasis"><em>environment
	      variable</em></span>.  In our case, we might look at an
	    environment variable named
	    <code class="varname">PINHOLE</code>.</p><p>Usually, a program uses one or the other of the above
	    methods.  Otherwise, if a configuration file said one
	    thing, but an environment variable another, the program
	    might get confused (or just too complicated).</p><p>Because we only need to choose
	    <span class="emphasis"><em>one</em></span> such parameter, we will go with
	    the second method and search the environment for a
	    variable named <code class="varname">PINHOLE</code>.</p><p>The other way allows us to make <span class="emphasis"><em>ad
	      hoc</em></span> decisions: <span class="emphasis"><em>"Though I usually
	      want you to use 0.039, this time I want
	      0.03872."</em></span>  In other words, it allows us to
	    <span class="emphasis"><em>override</em></span> the permanent choice.</p><p>This type of choice is usually done with command line
	    parameters.</p><p>Finally, a program <span class="emphasis"><em>always</em></span> needs a
	    <span class="emphasis"><em>default</em></span>.  The user may not make any
	    choices.  Perhaps he does not know what to choose.
	    Perhaps he is "just browsing." Preferably, the default
	    will be the value most users would choose anyway.  That
	    way they do not need to choose.  Or, rather, they can
	    choose the default without an additional effort.</p><p>Given this system, the program may find conflicting
	    options, and handle them this way:</p><div class="procedure"><ol class="procedure" type="1"><li class="step"><p>If it finds an <span class="emphasis"><em>ad hoc</em></span> choice
		(e.g., command line parameter), it should accept that
		choice.  It must ignore any permanent choice and any
		default.</p></li><li class="step"><p><span class="emphasis"><em>Otherwise</em></span>, if it finds a
		permanent option (e.g., an environment variable), it
		should accept it, and ignore the default.</p></li><li class="step"><p><span class="emphasis"><em>Otherwise</em></span>, it should use the
		default.</p></li></ol></div><p>We also need to decide what
	    <span class="emphasis"><em>format</em></span> our <code class="constant">PC</code>
	    option should have.</p><p>At first site, it seems obvious to use the
	    <code class="varname">PINHOLE=0.04</code> format for the
	    environment variable, and <em class="parameter"><code>-p0.04</code></em>
	    for the command line.</p><p>Allowing that is actually a security risk.  The
	    <code class="constant">PC</code> constant is a very small number.
	    Naturally, we will test our software using various small
	    values of <code class="constant">PC</code>.  But what will happen
	    if someone runs the program choosing a huge value?</p><p>It may crash the program because we have not designed
	    it to handle huge numbers.</p><p>Or, we may spend more time on the program so it can
	    handle huge numbers.  We might do that if we were writing
	    commercial software for computer illiterate
	    audience.</p><p>Or, we might say, <span class="emphasis"><em>"Tough! The user should
	      know better.""</em></span></p><p>Or, we just may make it impossible for the user to
	    enter a huge number.  This is the approach we will take:
	    We will use an <span class="emphasis"><em>implied 0.</em></span>
	    prefix.</p><p>In other words, if the user wants
	    <code class="constant">0.04</code>, we will expect him to type
	    <em class="parameter"><code>-p04</code></em>, or set
	    <code class="varname">PINHOLE=04</code> in his environment.  So, if
	    he says <em class="parameter"><code>-p9999999</code></em>, we will
	    interpret it as <code class="constant">0.9999999</code>&#8212;still
	    ridiculous but at least safer.</p><p>Secondly, many users will just want to go with either
	    Bender's constant or Connors' constant.  To make it easier
	    on them, we will interpret <em class="parameter"><code>-b</code></em> as
	    identical to <em class="parameter"><code>-p04</code></em>, and
	    <em class="parameter"><code>-c</code></em> as identical to
	    <em class="parameter"><code>-p037</code></em>.</p></div><div class="sect3"><div xmlns="" class="titlepage"><div><div><h4 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="x86-pinhole-output"></a>11.13.3.3. The Output</h4></div></div></div><p>We need to decide what we want our software to send to
	    the output, and in what format.</p><p>Since our input allows for an unspecified number of
	    focal length entries, it makes sense to use a traditional
	    database&#8211;style output of showing the result of the
	    calculation for each focal length on a separate line,
	    while separating all values on one line by a
	    <code class="constant">tab</code> character.</p><p>Optionally, we should also allow the user to specify
	    the use of the <acronym class="acronym">CSV</acronym> format we have
	    studied earlier.  In this case, we will print out a line
	    of comma&#8211;separated names describing each field of
	    every line, then show our results as before, but
	    substituting a <code class="constant">comma</code> for the
	    <code class="constant">tab</code>.</p><p>We need a command line option for the
	    <acronym class="acronym">CSV</acronym> format.  We cannot use
	    <em class="parameter"><code>-c</code></em> because that already means
	    <span class="emphasis"><em>use Connors' constant</em></span>.  For some
	    strange reason, many web sites refer to
	    <acronym class="acronym">CSV</acronym> files as <span class="emphasis"><em>"Excel
	      spreadsheet"</em></span> (though the
	    <acronym class="acronym">CSV</acronym> format predates Excel).
	    We will, therefore, use the <em class="parameter"><code>-e</code></em>
	    switch to inform our software we want the output in the
	    <acronym class="acronym">CSV</acronym> format.</p><p>We will start each line of the output with the focal
	    length.  This may sound repetitious at first, especially
	    in the interactive mode: The user types in the focal
	    length, and we are repeating it.</p><p>But the user can type several focal lengths on one
	    line.  The input can also come in from a file or from the
	    output of another program.  In that case the user does not
	    see the input at all.</p><p>By the same token, the output can go to a file which
	    we will want to examine later, or it could go to the
	    printer, or become the input of another program.</p><p>So, it makes perfect sense to start each line with
	    the focal length as entered by the user.</p><p>No, wait! Not as entered by the user.  What if the
	    user types in something like this:</p><pre class="screen"><strong class="userinput"><code>00000000150</code></strong></pre><p>Clearly, we need to strip those leading zeros.</p><p>So, we might consider reading the user input as is,
	    converting it to binary inside the <acronym class="acronym">FPU</acronym>,
	    and printing it out from there.</p><p>But...</p><p>What if the user types something like this:</p><pre class="screen"><strong class="userinput"><code>17459765723452353453534535353530530534563507309676764423</code></strong></pre><p>Ha! The packed decimal <acronym class="acronym">FPU</acronym> format
	    lets us input 18&#8211;digit numbers.  But the user has
	    entered more than 18 digits.  How do we handle
	    that?</p><p>Well, we <span class="emphasis"><em>could</em></span> modify our code to
	    read the first 18 digits, enter it to the
	    <acronym class="acronym">FPU</acronym>, then read more, multiply what we
	    already have on the <acronym class="acronym">TOS</acronym> by 10 raised to
	    the number of additional digits, then
	    <code class="function">add</code> to it.</p><p>Yes, we could do that.  But in
	    <span class="emphasis"><em>this</em></span> program it would be ridiculous
	    (in a different one it may be just the thing to do): Even
	    the circumference of the Earth expressed in millimeters
	    only takes 11 digits.  Clearly, we cannot build a camera
	    that large (not yet, anyway).</p><p>So, if the user enters such a huge number, he is
	    either bored, or testing us, or trying to break into the
	    system, or playing games&#8212;doing anything but
	    designing a pinhole camera.</p><p>What will we do?</p><p>We will slap him in the face, in a manner of
	    speaking:</p><pre class="screen">17459765723452353453534535353530530534563507309676764423	???	???	???	???	???</pre><p>To achieve that, we will simply ignore any leading
	    zeros.  Once we find a non&#8211;zero digit, we will
	    initialize a counter to <code class="constant">0</code> and start
	    taking three steps:</p><div class="procedure"><ol class="procedure" type="1"><li class="step"><p>Send the digit to the output.</p></li><li class="step"><p>Append the digit to a buffer we will use later to
		produce the packed decimal we can send to the
		<acronym class="acronym">FPU</acronym>.</p></li><li class="step"><p>Increase the counter.</p></li></ol></div><p>Now, while we are taking these three steps, we also
	    need to watch out for one of two conditions:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>If the counter grows above 18, we stop appending
		to the buffer.  We continue reading the digits and
		sending them to the output.</p></li><li class="listitem"><p>If, or rather <span class="emphasis"><em>when</em></span>, the next
		input character is not a digit, we are done inputting
		for now.</p><p>Incidentally, we can simply discard the
		non&#8211;digit, unless it is a
		<code class="constant">#</code>, which we must return to the
		input stream.  It starts a comment, so we must see it
		after we are done producing output and start looking
		for more input.</p></li></ul></div><p>That still leaves one possibility uncovered: If all
	    the user enters is a zero (or several zeros), we will
	    never find a non&#8211;zero to display.</p><p>We can determine this has happened whenever our
	    counter stays at <code class="constant">0</code>.  In that case we
	    need to send <code class="constant">0</code> to the output, and
	    perform another "slap in the face":</p><pre class="screen">0	???	???	???	???	???</pre><p>Once we have displayed the focal length and determined
	    it is valid (greater than <code class="constant">0</code> but not
	    exceeding 18 digits), we can calculate the pinhole
	    diameter.</p><p>It is not by coincidence that
	    <span class="emphasis"><em>pinhole</em></span> contains the word
	    <span class="emphasis"><em>pin</em></span>.  Indeed, many a pinhole
	    literally is a <span class="emphasis"><em>pin hole</em></span>, a hole
	    carefully punched with the tip of a pin.</p><p>That is because a typical pinhole is very small.  Our
	    formula gets the result in millimeters.  We will multiply
	    it by <code class="constant">1000</code>, so we can output the
	    result in <span class="emphasis"><em>microns</em></span>.</p><p>At this point we have yet another trap to face:
	    <span class="emphasis"><em>Too much precision.</em></span></p><p>Yes, the <acronym class="acronym">FPU</acronym> was designed for high
	    precision mathematics.  But we are not dealing with high
	    precision mathematics.  We are dealing with physics
	    (optics, specifically).</p><p>Suppose we want to convert a truck into a pinhole
	    camera (we would not be the first ones to do that!).
	    Suppose its box is <code class="constant">12</code> meters long,
	    so we have the focal length of <code class="constant">12000</code>.
	    Well, using Bender's constant, it gives us square root of
	    <code class="constant">12000</code> multiplied by
	    <code class="constant">0.04</code>, which is
	    <code class="constant">4.381780460</code> millimeters, or
	    <code class="constant">4381.780460</code> microns.</p><p>Put either way, the result is absurdly precise.  Our
	    truck is not <span class="emphasis"><em>exactly</em></span>
	    <code class="constant">12000</code> millimeters long.  We did not
	    measure its length with such a precision, so stating we
	    need a pinhole with the diameter of
	    <code class="constant">4.381780460</code> millimeters is, well,
	    deceiving.  <code class="constant">4.4</code> millimeters would do
	    just fine.</p><div xmlns="" class="note"><h3 class="admontitle">Note: </h3><p xmlns="http://www.w3.org/1999/xhtml">I "only" used ten digits in the above example.
	      Imagine the absurdity of going for all 18!</p></div><p>We need to limit the number of significant digits of
	    our result.  One way of doing it is by using an integer
	    representing microns.  So, our truck would need a pinhole
	    with the diameter of <code class="constant">4382</code> microns.
	    Looking at that number, we still decide that
	    <code class="constant">4400</code> microns, or
	    <code class="constant">4.4</code> millimeters is close
	    enough.</p><p>Additionally, we can decide that no matter how big a
	    result we get, we only want to display four significant
	    digits (or any other number of them, of course).  Alas,
	    the <acronym class="acronym">FPU</acronym> does not offer rounding to a
	    specific number of digits (after all, it does not view the
	    numbers as decimal but as binary).</p><p>We, therefore, must devise an algorithm to reduce
	    the number of significant digits.</p><p>Here is mine (I think it is awkward&#8212;if you know
	    a better one, <span class="emphasis"><em>please</em></span>, let me
	    know):</p><div class="procedure"><ol class="procedure" type="1"><li class="step"><p>Initialize a counter to
		<code class="constant">0</code>.</p></li><li class="step"><p>While the number is greater than or equal to
		<code class="constant">10000</code>, divide it by
		<code class="constant">10</code> and increase the
		counter.</p></li><li class="step"><p>Output the result.</p></li><li class="step"><p>While the counter is greater than
		<code class="constant">0</code>, output <code class="constant">0</code>
		and decrease the counter.</p></li></ol></div><div xmlns="" class="note"><h3 class="admontitle">Note: </h3><p xmlns="http://www.w3.org/1999/xhtml">The <code class="constant">10000</code> is only good if you
	      want <span class="emphasis"><em>four</em></span> significant digits.  For
	      any other number of significant digits, replace
	      <code class="constant">10000</code> with <code class="constant">10</code>
	      raised to the number of significant digits.</p></div><p>We will, then, output the pinhole diameter in microns,
	    rounded off to four significant digits.</p><p>At this point, we know the <span class="emphasis"><em>focal
	      length</em></span> and the <span class="emphasis"><em>pinhole
	      diameter</em></span>.  That means we have enough
	    information to also calculate the
	    <span class="emphasis"><em>f&#8211;number</em></span>.</p><p>We will display the f&#8211;number, rounded to four
	    significant digits.  Chances are the f&#8211;number will
	    tell us very little.  To make it more meaningful, we can
	    find the nearest <span class="emphasis"><em>normalized
	    f&#8211;number</em></span>, i.e., the nearest power of the
	    square root of 2.</p><p>We do that by multiplying the actual f&#8211;number by
	    itself, which, of course, will give us its
	    <code class="function">square</code>.  We will then calculate its
	    base&#8211;2 logarithm, which is much easier to do than
	    calculating the
	    base&#8211;square&#8211;root&#8211;of&#8211;2 logarithm!
	    We will round the result to the nearest integer.  Next, we
	    will raise 2 to the result.  Actually, the
	    <acronym class="acronym">FPU</acronym> gives us a good shortcut to do
	    that: We can use the <code class="function">fscale</code> op code to "scale" 1,
	    which is analogous to <code class="function">shift</code>ing an integer left.
	    Finally, we calculate the square root of it all, and we
	    have the nearest normalized f&#8211;number.</p><p>If all that sounds overwhelming&#8212;or too much
	    work, perhaps&#8212;it may become much clearer if you see
	    the code.  It takes 9 op codes altogether:</p><pre class="programlisting">fmul	st0, st0
	fld1
	fld	st1
	fyl2x
	frndint
	fld1
	fscale
	fsqrt
	fstp	st1</pre><p>The first line, <code class="function">fmul st0, st0</code>, squares the
	    contents of the <acronym class="acronym">TOS</acronym> (top of the stack,
	    same as <code class="varname">st</code>, called
	    <code class="varname">st0</code> by
	    <span class="application">nasm</span>).  The <code class="function">fld1</code> pushes
	    <code class="constant">1</code> on the
	    <acronym class="acronym">TOS</acronym>.</p><p>The next line, <code class="function">fld
	      st1</code>, pushes the square back to the
	    <acronym class="acronym">TOS</acronym>.  At this point the square is
	    both in <code class="varname">st</code> and <code class="varname">st(2)</code> (it will become clear
	    why we leave a second copy on the stack in a moment).
	    <code class="varname">st(1)</code> contains
	    <code class="constant">1</code>.</p><p>Next, <code class="function">fyl2x</code>
	    calculates base&#8211;2 logarithm of <code class="varname">st</code> multiplied by
	    <code class="varname">st(1)</code>.  That is why we
	    placed <code class="constant">1</code> on <code class="varname">st(1)</code> before.</p><p>At this point, <code class="varname">st</code>
	    contains the logarithm we have just calculated, <code class="varname">st(1)</code> contains the square of
	    the actual f&#8211;number we saved for later.</p><p><code class="function">frndint</code> rounds the
	    <acronym class="acronym">TOS</acronym> to the nearest integer.  <code class="function">fld1</code> pushes a
	    <code class="constant">1</code>.  <code class="function">fscale</code> shifts the
	    <code class="constant">1</code> we have on the
	    <acronym class="acronym">TOS</acronym> by the value in <code class="varname">st(1)</code>, effectively raising 2
	    to <code class="varname">st(1)</code>.</p><p>Finally, <code class="function">fsqrt</code>
	    calculates the square root of the result, i.e., the
	    nearest normalized f&#8211;number.</p><p>We now have the nearest normalized f&#8211;number on
	    the <acronym class="acronym">TOS</acronym>, the base&#8211;2 logarithm
	    rounded to the nearest integer in <code class="varname">st(1)</code>, and the square of the
	    actual f&#8211;number in <code class="varname">st(2)</code>.  We are saving the
	    value in <code class="varname">st(2)</code> for
	    later.</p><p>But we do not need the contents of <code class="varname">st(1)</code> anymore.  The last line,
	    <code class="function">fstp st1</code>, places the
	    contents of <code class="varname">st</code> to
	    <code class="varname">st(1)</code>, and pops.  As a
	    result, what was <code class="varname">st(1)</code>
	    is now <code class="varname">st</code>, what was
	    <code class="varname">st(2)</code> is now <code class="varname">st(1)</code>, etc.  The new <code class="varname">st</code> contains the normalized
	    f&#8211;number.  The new <code class="varname">st(1)</code> contains the square of
	    the actual f&#8211;number we have stored there for
	    posterity.</p><p>At this point, we are ready to output the normalized
	    f&#8211;number.  Because it is normalized, we will not
	    round it off to four significant digits, but will send it
	    out in its full precision.</p><p>The normalized f-number is useful as long as it is
	    reasonably small and can be found on our light meter.
	    Otherwise we need a different method of determining proper
	    exposure.</p><p>Earlier we have figured out the formula of calculating
	    proper exposure at an arbitrary f&#8211;number from that
	    measured at a different f&#8211;number.</p><p>Every light meter I have ever seen can determine
	    proper exposure at f5.6.  We will, therefore, calculate an
	    <span class="emphasis"><em>"f5.6 multiplier,"</em></span> i.e., by how much
	    we need to multiply the exposure measured at f5.6 to
	    determine the proper exposure for our pinhole
	    camera.</p><p>From the above formula we know this factor can be
	    calculated by dividing our f&#8211;number (the actual one,
	    not the normalized one) by <code class="constant">5.6</code>, and
	    squaring the result.</p><p>Mathematically, dividing the square of our
	    f&#8211;number by the square of <code class="constant">5.6</code>
	    will give us the same result.</p><p>Computationally, we do not want to square two numbers
	    when we can only square one.  So, the first solution seems
	    better at first.</p><p>But...</p><p><code class="constant">5.6</code> is a
	    <span class="emphasis"><em>constant</em></span>.  We do not have to have our
	    <acronym class="acronym">FPU</acronym> waste precious cycles.  We can just
	    tell it to divide the square of the f&#8211;number by
	    whatever <code class="constant">5.6²</code> equals to.  Or we
	    can divide the f&#8211;number by <code class="constant">5.6</code>,
	    and then square the result.  The two ways now seem
	    equal.</p><p>But, they are not!</p><p>Having studied the principles of photography above, we
	    remember that the <code class="constant">5.6</code> is actually
	    square root of 2 raised to the fifth power.  An
	    <span class="emphasis"><em>irrational</em></span> number.  The square of
	    this number is <span class="emphasis"><em>exactly</em></span>
	    <code class="constant">32</code>.</p><p>Not only is <code class="constant">32</code> an integer, it is
	    a power of 2.  We do not need to divide the square of the
	    f&#8211;number by <code class="constant">32</code>.  We only need
	    to use <code class="function">fscale</code> to shift
	    it right by five positions.  In the <acronym class="acronym">FPU</acronym>
	    lingo it means we will <code class="function">fscale</code> it with <code class="varname">st(1)</code> equal to
	    <code class="constant">-5</code>.  That is <span class="emphasis"><em>much
	      faster</em></span> than a division.</p><p>So, now it has become clear why we have saved the
	    square of the f&#8211;number on the top of the
	    <acronym class="acronym">FPU</acronym> stack.  The calculation of the
	    f5.6 multiplier is the easiest calculation of this entire
	    program! We will output it rounded to four significant
	    digits.</p><p>There is one more useful number we can calculate:  The
	    number of stops our f&#8211;number is from f5.6.  This may
	    help us if our f&#8211;number is just outside the range of
	    our light meter, but we have a shutter which lets us set
	    various speeds, and this shutter uses stops.</p><p>Say, our f&#8211;number is 5 stops from f5.6, and the
	    light meter says we should use 1/1000 sec.  Then we can
	    set our shutter speed to 1/1000 first, then move the dial
	    by 5 stops.</p><p>This calculation is quite easy as well.  All we have
	    to do is to calculate the base-2 logarithm of the f5.6
	    multiplier we had just calculated (though we need its
	    value from before we rounded it off).  We then output the
	    result rounded to the nearest integer.  We do not need to
	    worry about having more than four significant digits in
	    this one: The result is most likely to have only one or
	    two digits anyway.</p></div></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="x86-fpu-optimizations"></a>11.13.4. FPU Optimizations</h3></div></div></div><p>In assembly language we can optimize the
	  <acronym class="acronym">FPU</acronym> code in ways impossible in high
	  languages, including C.</p><p>Whenever a C function needs to calculate a
	  floating&#8211;point value, it loads all necessary variables
	  and constants into <acronym class="acronym">FPU</acronym> registers.  It
	  then does whatever calculation is required to get the
	  correct result.  Good C compilers can optimize that part of
	  the code really well.</p><p>It "returns" the value by leaving the result on the
	  <acronym class="acronym">TOS</acronym>.  However, before it returns, it
	  cleans up.  Any variables and constants it used in its
	  calculation are now gone from the
	  <acronym class="acronym">FPU</acronym>.</p><p>It cannot do what we just did above: We calculated the
	  square of the f&#8211;number and kept it on the stack for
	  later use by another function.</p><p>We <span class="emphasis"><em>knew</em></span> we would need that value
	  later on.  We also knew we had enough room on the
	  stack (which only has room for 8 numbers) to store it
	  there.</p><p>A C compiler has no way of knowing that a value it has
	  on the stack will be required again in the very near
	  future.</p><p>Of course, the C programmer may know it.  But the only
	  recourse he has is to store the value in a memory
	  variable.</p><p>That means, for one, the value will be changed from the
	  80-bit precision used internally by the
	  <acronym class="acronym">FPU</acronym> to a C <span class="emphasis"><em>double</em></span>
	  (64 bits) or even <span class="emphasis"><em>single</em></span> (32
	  bits).</p><p>That also means that the value must be moved from the
	  <acronym class="acronym">TOS</acronym> into the memory, and then back again.
	  Alas, of all <acronym class="acronym">FPU</acronym> operations, the ones
	  that access the computer memory are the slowest.</p><p>So, whenever programming the <acronym class="acronym">FPU</acronym> in
	  assembly language, look for the ways of keeping intermediate
	  results on the <acronym class="acronym">FPU</acronym> stack.</p><p>We can take that idea even further! In our program we
	  are using a <span class="emphasis"><em>constant</em></span> (the one we named
	  <code class="constant">PC</code>).</p><p>It does not matter how many pinhole diameters we are
	  calculating: 1, 10, 20, 1000, we are always using the same
	  constant.  Therefore, we can optimize our program by keeping
	  the constant on the stack all the time.</p><p>Early on in our program, we are calculating the value of
	  the above constant.  We need to divide our input by
	  <code class="constant">10</code> for every digit in the
	  constant.</p><p>It is much faster to multiply than to divide.  So, at
	  the start of our program, we divide <code class="constant">10</code>
	  into <code class="constant">1</code> to obtain
	  <code class="constant">0.1</code>, which we then keep on the stack:
	  Instead of dividing the input by <code class="constant">10</code> for
	  every digit, we multiply it by
	  <code class="constant">0.1</code>.</p><p>By the way, we do not input <code class="constant">0.1</code>
	  directly, even though we could.  We have a reason for that:
	  While <code class="constant">0.1</code> can be expressed with just
	  one decimal place, we do not know how many
	  <span class="emphasis"><em>binary</em></span> places it takes.  We, therefore,
	  let the <acronym class="acronym">FPU</acronym> calculate its binary value to
	  its own high precision.</p><p>We are using other constants: We multiply the pinhole
	  diameter by <code class="constant">1000</code> to convert it from
	  millimeters to microns.  We compare numbers to
	  <code class="constant">10000</code> when we are rounding them off to
	  four significant digits.  So, we keep both,
	  <code class="constant">1000</code> and <code class="constant">10000</code>, on
	  the stack.  And, of course, we reuse the
	  <code class="constant">0.1</code> when rounding off numbers to four
	  digits.</p><p>Last but not least, we keep <code class="constant">-5</code> on
	  the stack.  We need it to scale the square of the
	  f&#8211;number, instead of dividing it by
	  <code class="constant">32</code>.  It is not by coincidence we load
	  this constant last.  That makes it the top of the stack when
	  only the constants are on it.  So, when the square of the
	  f&#8211;number is being scaled, the <code class="constant">-5</code>
	  is at <code class="varname">st(1)</code>, precisely
	  where <code class="function">fscale</code> expects it
	  to be.</p><p>It is common to create certain constants from scratch
	  instead of loading them from the memory.  That is what we
	  are doing with <code class="constant">-5</code>:</p><pre class="programlisting">	fld1			; TOS =  1
	fadd	st0, st0	; TOS =  2
	fadd	st0, st0	; TOS =  4
	fld1			; TOS =  1
	faddp	st1, st0	; TOS =  5
	fchs			; TOS = -5</pre><p>We can generalize all these optimizations into one rule:
	<span class="emphasis"><em>Keep repeat values on the stack!</em></span></p><div xmlns="" class="tip"><h3 class="admontitle">Tip: </h3><p xmlns="http://www.w3.org/1999/xhtml"><span class="emphasis"><em><span class="trademark">PostScript</span>®</em></span> is a
	  stack&#8211;oriented programming language.  There are many
	  more books available about <span class="trademark">PostScript</span>® than about the
	  <acronym class="acronym">FPU</acronym> assembly language: Mastering
	  <span class="trademark">PostScript</span>® will help you master the
	  <acronym class="acronym">FPU</acronym>.</p></div></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="x86-pinhole-the-code"></a>11.13.5. <span class="application">pinhole</span>&#8212;The Code</h3></div></div></div><pre class="programlisting">;;;;;;; pinhole.asm ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;
; Find various parameters of a pinhole camera construction and use
;
; Started:	 9-Jun-2001
; Updated:	10-Jun-2001
;
; Copyright (c) 2001 G. Adam Stanislav
; All rights reserved.
;
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;

%include	'system.inc'

%define	BUFSIZE	2048

section	.data
align 4
ten	dd	10
thousand	dd	1000
tthou	dd	10000
fd.in	dd	stdin
fd.out	dd	stdout
envar	db	'PINHOLE='	; Exactly 8 bytes, or 2 dwords long
pinhole	db	'04,', 		; Bender's constant (0.04)
connors	db	'037', 0Ah	; Connors' constant
usg	db	'Usage: pinhole [-b] [-c] [-e] [-p &lt;value&gt;] [-o &lt;outfile&gt;] [-i &lt;infile&gt;]', 0Ah
usglen	equ	$-usg
iemsg	db	"pinhole: Can't open input file", 0Ah
iemlen	equ	$-iemsg
oemsg	db	"pinhole: Can't create output file", 0Ah
oemlen	equ	$-oemsg
pinmsg	db	"pinhole: The PINHOLE constant must not be 0", 0Ah
pinlen	equ	$-pinmsg
toobig	db	"pinhole: The PINHOLE constant may not exceed 18 decimal places", 0Ah
biglen	equ	$-toobig
huhmsg	db	9, '???'
separ	db	9, '???'
sep2	db	9, '???'
sep3	db	9, '???'
sep4	db	9, '???', 0Ah
huhlen	equ	$-huhmsg
header	db	'focal length in millimeters,pinhole diameter in microns,'
	db	'F-number,normalized F-number,F-5.6 multiplier,stops '
	db	'from F-5.6', 0Ah
headlen	equ	$-header

section .bss
ibuffer	resb	BUFSIZE
obuffer	resb	BUFSIZE
dbuffer	resb	20		; decimal input buffer
bbuffer	resb	10		; BCD buffer

section	.text
align 4
huh:
	call	write
	push	dword huhlen
	push	dword huhmsg
	push	dword [fd.out]
	sys.write
	add	esp, byte 12
	ret

align 4
perr:
	push	dword pinlen
	push	dword pinmsg
	push	dword stderr
	sys.write
	push	dword 4		; return failure
	sys.exit

align 4
consttoobig:
	push	dword biglen
	push	dword toobig
	push	dword stderr
	sys.write
	push	dword 5		; return failure
	sys.exit

align 4
ierr:
	push	dword iemlen
	push	dword iemsg
	push	dword stderr
	sys.write
	push	dword 1		; return failure
	sys.exit

align 4
oerr:
	push	dword oemlen
	push	dword oemsg
	push	dword stderr
	sys.write
	push	dword 2
	sys.exit

align 4
usage:
	push	dword usglen
	push	dword usg
	push	dword stderr
	sys.write
	push	dword 3
	sys.exit

align 4
global	_start
_start:
	add	esp, byte 8	; discard argc and argv[0]
	sub	esi, esi

.arg:
	pop	ecx
	or	ecx, ecx
	je	near .getenv		; no more arguments

	; ECX contains the pointer to an argument
	cmp	byte [ecx], '-'
	jne	usage

	inc	ecx
	mov	ax, [ecx]
	inc	ecx

.o:
	cmp	al, 'o'
	jne	.i

	; Make sure we are not asked for the output file twice
	cmp	dword [fd.out], stdout
	jne	usage

	; Find the path to output file - it is either at [ECX+1],
	; i.e., -ofile --
	; or in the next argument,
	; i.e., -o file

	or	ah, ah
	jne	.openoutput
	pop	ecx
	jecxz	usage

.openoutput:
	push	dword 420	; file mode (644 octal)
	push	dword 0200h | 0400h | 01h
	; O_CREAT | O_TRUNC | O_WRONLY
	push	ecx
	sys.open
	jc	near oerr

	add	esp, byte 12
	mov	[fd.out], eax
	jmp	short .arg

.i:
	cmp	al, 'i'
	jne	.p

	; Make sure we are not asked twice
	cmp	dword [fd.in], stdin
	jne	near usage

	; Find the path to the input file
	or	ah, ah
	jne	.openinput
	pop	ecx
	or	ecx, ecx
	je near usage

.openinput:
	push	dword 0		; O_RDONLY
	push	ecx
	sys.open
	jc	near ierr		; open failed

	add	esp, byte 8
	mov	[fd.in], eax
	jmp	.arg

.p:
	cmp	al, 'p'
	jne	.c
	or	ah, ah
	jne	.pcheck

	pop	ecx
	or	ecx, ecx
	je	near usage

	mov	ah, [ecx]

.pcheck:
	cmp	ah, '0'
	jl	near usage
	cmp	ah, '9'
	ja	near usage
	mov	esi, ecx
	jmp	.arg

.c:
	cmp	al, 'c'
	jne	.b
	or	ah, ah
	jne	near usage
	mov	esi, connors
	jmp	.arg

.b:
	cmp	al, 'b'
	jne	.e
	or	ah, ah
	jne	near usage
	mov	esi, pinhole
	jmp	.arg

.e:
	cmp	al, 'e'
	jne	near usage
	or	ah, ah
	jne	near usage
	mov	al, ','
	mov	[huhmsg], al
	mov	[separ], al
	mov	[sep2], al
	mov	[sep3], al
	mov	[sep4], al
	jmp	.arg

align 4
.getenv:
	; If ESI = 0, we did not have a -p argument,
	; and need to check the environment for "PINHOLE="
	or	esi, esi
	jne	.init

	sub	ecx, ecx

.nextenv:
	pop	esi
	or	esi, esi
	je	.default	; no PINHOLE envar found

	; check if this envar starts with 'PINHOLE='
	mov	edi, envar
	mov	cl, 2		; 'PINHOLE=' is 2 dwords long
rep	cmpsd
	jne	.nextenv

	; Check if it is followed by a digit
	mov	al, [esi]
	cmp	al, '0'
	jl	.default
	cmp	al, '9'
	jbe	.init
	; fall through

align 4
.default:
	; We got here because we had no -p argument,
	; and did not find the PINHOLE envar.
	mov	esi, pinhole
	; fall through

align 4
.init:
	sub	eax, eax
	sub	ebx, ebx
	sub	ecx, ecx
	sub	edx, edx
	mov	edi, dbuffer+1
	mov	byte [dbuffer], '0'

	; Convert the pinhole constant to real
.constloop:
	lodsb
	cmp	al, '9'
	ja	.setconst
	cmp	al, '0'
	je	.processconst
	jb	.setconst

	inc	dl

.processconst:
	inc	cl
	cmp	cl, 18
	ja	near consttoobig
	stosb
	jmp	short .constloop

align 4
.setconst:
	or	dl, dl
	je	near perr

	finit
	fild	dword [tthou]

	fld1
	fild	dword [ten]
	fdivp	st1, st0

	fild	dword [thousand]
	mov	edi, obuffer

	mov	ebp, ecx
	call	bcdload

.constdiv:
	fmul	st0, st2
	loop	.constdiv

	fld1
	fadd	st0, st0
	fadd	st0, st0
	fld1
	faddp	st1, st0
	fchs

	; If we are creating a CSV file,
	; print header
	cmp	byte [separ], ','
	jne	.bigloop

	push	dword headlen
	push	dword header
	push	dword [fd.out]
	sys.write

.bigloop:
	call	getchar
	jc	near done

	; Skip to the end of the line if you got '#'
	cmp	al, '#'
	jne	.num
	call	skiptoeol
	jmp	short .bigloop

.num:
	; See if you got a number
	cmp	al, '0'
	jl	.bigloop
	cmp	al, '9'
	ja	.bigloop

	; Yes, we have a number
	sub	ebp, ebp
	sub	edx, edx

.number:
	cmp	al, '0'
	je	.number0
	mov	dl, 1

.number0:
	or	dl, dl		; Skip leading 0's
	je	.nextnumber
	push	eax
	call	putchar
	pop	eax
	inc	ebp
	cmp	ebp, 19
	jae	.nextnumber
	mov	[dbuffer+ebp], al

.nextnumber:
	call	getchar
	jc	.work
	cmp	al, '#'
	je	.ungetc
	cmp	al, '0'
	jl	.work
	cmp	al, '9'
	ja	.work
	jmp	short .number

.ungetc:
	dec	esi
	inc	ebx

.work:
	; Now, do all the work
	or	dl, dl
	je	near .work0

	cmp	ebp, 19
	jae	near .toobig

	call	bcdload

	; Calculate pinhole diameter

	fld	st0	; save it
	fsqrt
	fmul	st0, st3
	fld	st0
	fmul	st5
	sub	ebp, ebp

	; Round off to 4 significant digits
.diameter:
	fcom	st0, st7
	fstsw	ax
	sahf
	jb	.printdiameter
	fmul	st0, st6
	inc	ebp
	jmp	short .diameter

.printdiameter:
	call	printnumber	; pinhole diameter

	; Calculate F-number

	fdivp	st1, st0
	fld	st0

	sub	ebp, ebp

.fnumber:
	fcom	st0, st6
	fstsw	ax
	sahf
	jb	.printfnumber
	fmul	st0, st5
	inc	ebp
	jmp	short .fnumber

.printfnumber:
	call	printnumber	; F number

	; Calculate normalized F-number
	fmul	st0, st0
	fld1
	fld	st1
	fyl2x
	frndint
	fld1
	fscale
	fsqrt
	fstp	st1

	sub	ebp, ebp
	call	printnumber

	; Calculate time multiplier from F-5.6

	fscale
	fld	st0

	; Round off to 4 significant digits
.fmul:
	fcom	st0, st6
	fstsw	ax
	sahf

	jb	.printfmul
	inc	ebp
	fmul	st0, st5
	jmp	short .fmul

.printfmul:
	call	printnumber	; F multiplier

	; Calculate F-stops from 5.6

	fld1
	fxch	st1
	fyl2x

	sub	ebp, ebp
	call	printnumber

	mov	al, 0Ah
	call	putchar
	jmp	.bigloop

.work0:
	mov	al, '0'
	call	putchar

align 4
.toobig:
	call	huh
	jmp	.bigloop

align 4
done:
	call	write		; flush output buffer

	; close files
	push	dword [fd.in]
	sys.close

	push	dword [fd.out]
	sys.close

	finit

	; return success
	push	dword 0
	sys.exit

align 4
skiptoeol:
	; Keep reading until you come to cr, lf, or eof
	call	getchar
	jc	done
	cmp	al, 0Ah
	jne	.cr
	ret

.cr:
	cmp	al, 0Dh
	jne	skiptoeol
	ret

align 4
getchar:
	or	ebx, ebx
	jne	.fetch

	call	read

.fetch:
	lodsb
	dec	ebx
	clc
	ret

read:
	jecxz	.read
	call	write

.read:
	push	dword BUFSIZE
	mov	esi, ibuffer
	push	esi
	push	dword [fd.in]
	sys.read
	add	esp, byte 12
	mov	ebx, eax
	or	eax, eax
	je	.empty
	sub	eax, eax
	ret

align 4
.empty:
	add	esp, byte 4
	stc
	ret

align 4
putchar:
	stosb
	inc	ecx
	cmp	ecx, BUFSIZE
	je	write
	ret

align 4
write:
	jecxz	.ret	; nothing to write
	sub	edi, ecx	; start of buffer
	push	ecx
	push	edi
	push	dword [fd.out]
	sys.write
	add	esp, byte 12
	sub	eax, eax
	sub	ecx, ecx	; buffer is empty now
.ret:
	ret

align 4
bcdload:
	; EBP contains the number of chars in dbuffer
	push	ecx
	push	esi
	push	edi

	lea	ecx, [ebp+1]
	lea	esi, [dbuffer+ebp-1]
	shr	ecx, 1

	std

	mov	edi, bbuffer
	sub	eax, eax
	mov	[edi], eax
	mov	[edi+4], eax
	mov	[edi+2], ax

.loop:
	lodsw
	sub	ax, 3030h
	shl	al, 4
	or	al, ah
	mov	[edi], al
	inc	edi
	loop	.loop

	fbld	[bbuffer]

	cld
	pop	edi
	pop	esi
	pop	ecx
	sub	eax, eax
	ret

align 4
printnumber:
	push	ebp
	mov	al, [separ]
	call	putchar

	; Print the integer at the TOS
	mov	ebp, bbuffer+9
	fbstp	[bbuffer]

	; Check the sign
	mov	al, [ebp]
	dec	ebp
	or	al, al
	jns	.leading

	; We got a negative number (should never happen)
	mov	al, '-'
	call	putchar

.leading:
	; Skip leading zeros
	mov	al, [ebp]
	dec	ebp
	or	al, al
	jne	.first
	cmp	ebp, bbuffer
	jae	.leading

	; We are here because the result was 0.
	; Print '0' and return
	mov	al, '0'
	jmp	putchar

.first:
	; We have found the first non-zero.
	; But it is still packed
	test	al, 0F0h
	jz	.second
	push	eax
	shr	al, 4
	add	al, '0'
	call	putchar
	pop	eax
	and	al, 0Fh

.second:
	add	al, '0'
	call	putchar

.next:
	cmp	ebp, bbuffer
	jb	.done

	mov	al, [ebp]
	push	eax
	shr	al, 4
	add	al, '0'
	call	putchar
	pop	eax
	and	al, 0Fh
	add	al, '0'
	call	putchar

	dec	ebp
	jmp	short .next

.done:
	pop	ebp
	or	ebp, ebp
	je	.ret

.zeros:
	mov	al, '0'
	call	putchar
	dec	ebp
	jne	.zeros

.ret:
	ret</pre><p>The code follows the same format as all the other filters
	we have seen before, with one subtle exception:</p><div class="blockquote"><blockquote class="blockquote"><p>We are no longer assuming that the end of input implies
	  the end of things to do, something we took for granted in
	  the <span class="emphasis"><em>character&#8211;oriented</em></span>
	  filters.</p><p>This filter does not process characters.  It processes a
	  <span class="emphasis"><em>language</em></span> (albeit a very simple one,
	  consisting only of numbers).</p><p>When we have no more input, it can mean one of two
	  things:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>We are done and can quit.  This is the same as
	      before.</p></li><li class="listitem"><p>The last character we have read was a digit.  We
	      have stored it at the end of our
	      <acronym class="acronym">ASCII</acronym>&#8211;to&#8211;float
	      conversion buffer.  We now need to convert the contents
	      of that buffer into a number and write the last line of
	      our output.</p></li></ul></div><p>For that reason, we have modified our
	  <code class="function">getchar</code> and our
	  <code class="function">read</code> routines to return with the
	  <code class="varname">carry flag</code>
	  <span class="emphasis"><em>clear</em></span> whenever we are fetching another
	  character from the input, or the <code class="varname">carry flag</code>
	  <span class="emphasis"><em>set</em></span> whenever there is no more
	  input.</p><p>Of course, we are still using assembly language magic to
	  do that! Take a good look at <code class="function">getchar</code>.
	  It <span class="emphasis"><em>always</em></span> returns with the <code class="varname">carry flag</code>
	  <span class="emphasis"><em>clear</em></span>.</p><p>Yet, our main code relies on the <code class="varname">carry flag</code> to tell it when to
	  quit&#8212;and it works.</p><p>The magic is in <code class="function">read</code>.  Whenever it
	  receives more input from the system, it just returns to
	  <code class="function">getchar</code>, which fetches a character from
	  the input buffer, <span class="emphasis"><em>clears</em></span> the <code class="varname">carry flag</code> and returns.</p><p>But when <code class="function">read</code> receives no more
	  input from the system, it does <span class="emphasis"><em>not</em></span>
	  return to <code class="function">getchar</code> at all.  Instead, the
	  <code class="function">add esp, byte 4</code> op code
	  adds <code class="constant">4</code> to <code class="varname">ESP</code>, <span class="emphasis"><em>sets</em></span>
	  the <code class="varname">carry flag</code>, and
	  returns.</p><p>So, where does it return to? Whenever a program uses the
	  <code class="function">call</code> op code, the
	  microprocessor <code class="function">push</code>es the
	  return address, i.e., it stores it on the top of the stack
	  (not the <acronym class="acronym">FPU</acronym> stack, the system stack,
	  which is in the memory).  When a program uses the <code class="function">ret</code> op code, the microprocessor
	  <code class="function">pop</code>s the return value
	  from the stack, and jumps to the address that was stored
	  there.</p><p>But since we added <code class="constant">4</code> to <code class="varname">ESP</code> (which is the stack pointer
	  register), we have effectively given the microprocessor a
	  minor case of <span class="emphasis"><em>amnesia</em></span>: It no longer
	  remembers it was <code class="function">getchar</code> that <code class="function">call</code>ed
	  <code class="function">read</code>.</p><p>And since <code class="function">getchar</code> never <code class="function">push</code>ed anything before <code class="function">call</code>ing
	  <code class="function">read</code>, the top of the stack now contains
	  the return address to whatever or whoever <code class="function">call</code>ed
	  <code class="function">getchar</code>.  As far as that caller is
	  concerned, he <code class="function">call</code>ed
	  <code class="function">getchar</code>, which <code class="function">ret</code>urned with the <code class="varname">carry flag</code> set!</p></blockquote></div><p>Other than that, the <code class="function">bcdload</code> routine
	is caught up in the middle of a Lilliputian conflict between
	the Big&#8211;Endians and the Little&#8211;Endians.</p><p>It is converting the text representation of a number into
	that number: The text is stored in the big&#8211;endian order,
	but the <span class="emphasis"><em>packed decimal</em></span> is
	little&#8211;endian.</p><p>To solve the conflict, we use the <code class="function">std</code>
	op code early on.  We cancel it with <code class="function">cld</code>
	later on: It is quite important we do not
	<code class="function">call</code> anything that may depend on the
	default setting of the <span class="emphasis"><em>direction flag</em></span>
	while <code class="function">std</code> is active.</p><p>Everything else in this code should be quit eclear,
	providing you have read the entire chapter that precedes
	it.</p><p>It is a classical example of the adage that programming
	requires a lot of thought and only a little coding.  Once we
	have thought through every tiny detail, the code almost writes
	itself.</p></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="x86-pinhole-using"></a>11.13.6. Using <span class="application">pinhole</span></h3></div></div></div><p>Because we have decided to make the program
	<span class="emphasis"><em>ignore</em></span> any input except for numbers (and
	even those inside a comment), we can actually perform
	<span class="emphasis"><em>textual queries</em></span>.  We do not
	<span class="emphasis"><em>have to</em></span>, but we
	<span class="emphasis"><em>can</em></span>.</p><p>In my humble opinion, forming a textual query, instead of
	having to follow a very strict syntax, makes software much
	more user friendly.</p><p>Suppose we want to build a pinhole camera to use the 4x5
	inch film.  The standard focal length for that film is about
	150mm.  We want to <span class="emphasis"><em>fine&#8211;tune</em></span> our
	focal length so the pinhole diameter is as round a number as
	possible.  Let us also suppose we are quite comfortable with
	cameras but somewhat intimidated by computers.  Rather than
	just have to type in a bunch of numbers, we want to
	<span class="emphasis"><em>ask</em></span> a couple of questions.</p><p>Our session might look like this:</p><pre class="screen"><code class="prompt">%</code> <strong class="userinput"><code>pinhole

Computer,

What size pinhole do I need for the focal length of 150?</code></strong>
150	490	306	362	2930	12
<strong class="userinput"><code>Hmmm... How about 160?</code></strong>
160	506	316	362	3125	12
<strong class="userinput"><code>Let's make it 155, please.</code></strong>
155	498	311	362	3027	12
<strong class="userinput"><code>Ah, let's try 157...</code></strong>
157	501	313	362	3066	12
<strong class="userinput"><code>156?</code></strong>
156	500	312	362	3047	12
<strong class="userinput"><code>That's it! Perfect! Thank you very much!
^D</code></strong></pre><p>We have found that while for the focal length of 150, our
	pinhole diameter should be 490 microns, or 0.49 mm, if we go
	with the almost identical focal length of 156 mm, we can get
	away with a pinhole diameter of exactly one half of a
	millimeter.</p></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="x86-pinhole-scripting"></a>11.13.7. Scripting</h3></div></div></div><p>Because we have chosen the <code class="constant">#</code>
	character to denote the start of a comment, we can treat our
	<span class="application">pinhole</span> software as a
	<span class="emphasis"><em>scripting language</em></span>.</p><p>You have probably seen <span class="application">shell</span>
	<span class="emphasis"><em>scripts</em></span> that start with:</p><pre class="programlisting">#! /bin/sh</pre><p>...or...</p><pre class="programlisting">#!/bin/sh</pre><p>...because the blank space after the
	<code class="function">#!</code> is optional.</p><p>Whenever <span class="trademark">UNIX</span>® is asked to run an executable
	file which starts with the <code class="function">#!</code>,
	it assumes the file is a script.  It adds the
	command to the rest of the first line of the
	script, and tries to execute that.</p><p>Suppose now that we have installed
	<span class="application">pinhole</span> in
	<span class="application">/usr/local/bin/</span>, we can now write a
	script to calculate various pinhole diameters suitable for
	various focal lengths commonly used with the 120 film.</p><p>The script might look something like this:</p><pre class="programlisting">#! /usr/local/bin/pinhole -b -i
# Find the best pinhole diameter
# for the 120 film

### Standard
80

### Wide angle
30, 40, 50, 60, 70

### Telephoto
100, 120, 140</pre><p>Because 120 is a medium size film, we may name this file
	<span class="application">medium</span>.</p><p>We can set its permissions to execute, and run it as if it
	were a program:</p><pre class="screen"><code class="prompt">%</code> <strong class="userinput"><code>chmod 755 medium</code></strong>
<code class="prompt">%</code> <strong class="userinput"><code>./medium</code></strong></pre><p><span class="trademark">UNIX</span>® will interpret that last command as:</p><pre class="screen"><code class="prompt">%</code> <strong class="userinput"><code>/usr/local/bin/pinhole -b -i ./medium</code></strong></pre><p>It will run that command and display:</p><pre class="screen">80	358	224	256	1562	11
30	219	137	128	586	9
40	253	158	181	781	10
50	283	177	181	977	10
60	310	194	181	1172	10
70	335	209	181	1367	10
100	400	250	256	1953	11
120	438	274	256	2344	11
140	473	296	256	2734	11</pre><p>Now, let us enter:</p><pre class="screen"><code class="prompt">%</code> <strong class="userinput"><code>./medium -c</code></strong></pre><p><span class="trademark">UNIX</span>® will treat that as:</p><pre class="screen"><code class="prompt">%</code> <strong class="userinput"><code>/usr/local/bin/pinhole -b -i ./medium -c</code></strong></pre><p>That gives it two conflicting options:
	<em class="parameter"><code>-b</code></em> and <em class="parameter"><code>-c</code></em>
	(Use Bender's constant and use Connors' constant).  We have
	programmed it so later options override early ones&#8212;our
	program will calculate everything using Connors'
	constant:</p><pre class="screen">80	331	242	256	1826	11
30	203	148	128	685	9
40	234	171	181	913	10
50	262	191	181	1141	10
60	287	209	181	1370	10
70	310	226	256	1598	11
100	370	270	256	2283	11
120	405	296	256	2739	11
140	438	320	362	3196	12</pre><p>We decide we want to go with Bender's constant after all.
	We want to save its values as a comma&#8211;separated
	file:</p><pre class="screen"><code class="prompt">%</code> <strong class="userinput"><code>./medium -b -e &gt; bender</code></strong>
<code class="prompt">%</code> <strong class="userinput"><code>cat bender</code></strong>
focal length in millimeters,pinhole diameter in microns,F-number,normalized F-number,F-5.6 multiplier,stops from F-5.6
80,358,224,256,1562,11
30,219,137,128,586,9
40,253,158,181,781,10
50,283,177,181,977,10
60,310,194,181,1172,10
70,335,209,181,1367,10
100,400,250,256,1953,11
120,438,274,256,2344,11
140,473,296,256,2734,11
<code class="prompt">%</code></pre></div></div><div class="sect1"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="x86-caveats"></a>11.14. Caveats</h2></div></div></div><p>Assembly language programmers who "grew up" under
	<acronym class="acronym"><span class="trademark">MS-DOS</span>®</acronym> and <span class="trademark">Windows</span>® often tend to take
	shortcuts.  Reading the keyboard scan codes and writing
	directly to video memory are two classical examples of
	practices which, under <acronym class="acronym"><span class="trademark">MS-DOS</span>®</acronym> are not
	frowned upon but considered the right thing to do.</p><p>The reason? Both the <acronym class="acronym">PC BIOS</acronym> and
	<acronym class="acronym"><span class="trademark">MS-DOS</span>®</acronym> are notoriously slow when
	performing these operations.</p><p>You may be tempted to continue similar practices in the
	<span class="trademark">UNIX</span>® environment.  For example, I have seen a web site which
	explains how to access the keyboard scan codes on a popular
	<span class="trademark">UNIX</span>® clone.</p><p>That is generally a <span class="emphasis"><em>very bad idea</em></span> in
	<span class="trademark">UNIX</span>® environment! Let me explain why.</p><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="x86-protected"></a>11.14.1. <span class="trademark">UNIX</span>® Is Protected</h3></div></div></div><p>For one thing, it may simply not be possible.  <span class="trademark">UNIX</span>®
	  runs in protected mode.  Only the kernel and device drivers
	  are allowed to access hardware directly.  Perhaps a
	  particular <span class="trademark">UNIX</span>® clone will let you read the keyboard scan
	  codes, but chances are a real <span class="trademark">UNIX</span>® operating system will
	  not.  And even if one version may let you do it, the next
	  one may not, so your carefully crafted software may become a
	  dinosaur overnight.</p></div><div class="sect2"><div xmlns="" class="titlepage"><div><div><h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="x86-abstraction"></a>11.14.2. <span class="trademark">UNIX</span>® Is an Abstraction</h3></div></div></div><p>But there is a much more important reason not to try
	  accessing the hardware directly (unless, of course, you are
	  writing a device driver), even on the <span class="trademark">UNIX</span>® like systems
	  that let you do it:</p><p><span class="emphasis"><em><span class="trademark">UNIX</span>® is an abstraction!</em></span></p><p>There is a major difference in the philosophy of design
	  between <acronym class="acronym"><span class="trademark">MS-DOS</span>®</acronym> and <span class="trademark">UNIX</span>®.
	  <acronym class="acronym"><span class="trademark">MS-DOS</span>®</acronym> was designed as a single-user
	  system.  It is run on a computer with a keyboard and a video
	  screen attached directly to that computer.  User input is
	  almost guaranteed to come from that keyboard.  Your
	  program's output virtually always ends up on that
	  screen.</p><p>This is NEVER guaranteed under <span class="trademark">UNIX</span>®.  It is quite
	  common for a <span class="trademark">UNIX</span>® user to pipe and redirect program input
	  and output:</p><pre class="screen"><code class="prompt">%</code> <strong class="userinput"><code>program1 | program2 | program3 &gt; file1</code></strong></pre><p>If you have written <span class="application">program2</span>,
	  your input does not come from the keyboard but from the
	  output of <span class="application">program1</span>.  Similarly,
	  your output does not go to the screen but becomes the input
	  for <span class="application">program3</span> whose output, in
	  turn, goes to <code class="filename">file1</code>.</p><p>But there is more! Even if you made sure that your input
	  comes from, and your output goes to, the terminal, there is
	  no guarantee the terminal is a PC: It may not have its video
	  memory where you expect it, nor may its keyboard be
	  producing <acronym class="acronym">PC</acronym>-style scan codes.  It may be
	  a <span class="trademark">Macintosh</span>®, or any other computer.</p><p>Now you may be shaking your head: My software is in
	  <acronym class="acronym">PC</acronym> assembly language, how can it run on a
	  <span class="trademark">Macintosh</span>®? But I did not say your software would be
	  running on a <span class="trademark">Macintosh</span>®, only that its terminal may be a
	  <span class="trademark">Macintosh</span>®.</p><p>Under <span class="trademark">UNIX</span>®, the terminal does not have to be directly
	  attached to the computer that runs your software, it can
	  even be on another continent, or, for that matter, on
	  another planet.  It is perfectly possible that a <span class="trademark">Macintosh</span>®
	  user in Australia connects to a <span class="trademark">UNIX</span>® system in North
	  America (or anywhere else) via
	  <span class="application">telnet</span>.  The software then runs
	  on one computer, while the terminal is on a different
	  computer: If you try to read the scan codes, you will get
	  the wrong input!</p><p>Same holds true about any other hardware: A file you are
	  reading may be on a disk you have no direct access to.  A
	  camera you are reading images from may be on a
	  space shuttle, connected to you via satellites.</p><p>That is why under <span class="trademark">UNIX</span>® you must never make any
	  assumptions about where your data is coming from and going
	  to.  Always let the system handle the physical access to the
	  hardware.</p><div xmlns="" class="note"><h3 class="admontitle">Note: </h3><p xmlns="http://www.w3.org/1999/xhtml">These are caveats, not absolute rules.  Exceptions are
	    possible.  For example, if a text editor has determined it
	    is running on a local machine, it may want to read the
	    scan codes directly for improved control.  I am not
	    mentioning these caveats to tell you what to do or what
	    not to do, just to make you aware of certain pitfalls that
	    await you if you have just arrived to <span class="trademark">UNIX</span>® form
	    <acronym class="acronym"><span class="trademark">MS-DOS</span>®</acronym>.  Of course, creative people
	    often break rules, and it is OK as long as they know they
	    are breaking them and why.</p></div></div></div><div class="sect1"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="x86-acknowledgements"></a>11.15. Acknowledgements</h2></div></div></div><p>This tutorial would never have been possible without the
	help of many experienced FreeBSD programmers from the
	<a class="link" href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-hackers" target="_top">FreeBSD technical discussions mailing list</a>, many of whom have patiently answered my
	questions, and pointed me in the right direction in my
	attempts to explore the inner workings of <span class="trademark">UNIX</span>® system
	programming in general and FreeBSD in particular.</p><p>Thomas M. Sommers opened the door for me . His <a class="link" href="https://web.archive.org/web/20090914064615/http://www.codebreakers-journal.com/content/view/262/27" target="_top">How
	  do I write "Hello, world" in FreeBSD assembler?</a> web
	page was my first encounter with an example of assembly
	language programming under FreeBSD.</p><p>Jake Burkholder has kept the door open by willingly
	answering all of my questions and supplying me with example
	assembly language source code.</p><p>Copyright © 2000-2001 G. Adam Stanislav.  All rights
	reserved.</p></div></div></div><div class="part"><div xmlns="" class="titlepage"><div><div><h1 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="appendices"></a>Part V. Appendices</h1></div></div></div><div class="toc"><div class="toc-title">Table of Contents</div><dl class="toc"><dt><span class="bibliography"><a href="#idp52615288">Bibliography</a></span></dt></dl></div><div class="bibliography"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp52615288"></a>Bibliography</h2></div></div></div><div class="biblioentry"><a id="COD"></a><p>[1] <span class="authorgroup"><span class="firstname">Dave</span> <span class="othername">A</span> <span class="surname">Patterson</span> and <span class="firstname">John</span> <span class="othername">L</span> <span class="surname">Hennessy</span>. </span><span class="copyright">Copyright © 1998 Morgan Kaufmann Publishers,
        Inc.. </span><span class="biblioid">1-55860-428-6. </span><span class="publisher"><span class="publishername">Morgan Kaufmann Publishers, Inc.. </span></span><span class="citetitle"><em class="citetitle">Computer Organization and Design</em>. </span><span class="subtitle">The Hardware / Software Interface. </span><span class="pagenums">1-2. </span></p></div><div class="biblioentry"><a id="idp52147192"></a><p>[2] <span class="authorgroup"><span class="firstname">W.</span> <span class="othername">Richard</span> <span class="surname">Stevens</span>. </span><span class="copyright">Copyright © 1993 Addison Wesley Longman,
        Inc.. </span><span class="biblioid">0-201-56317-7. </span><span class="publisher"><span class="publishername">Addison Wesley Longman, Inc.. </span></span><span class="citetitle"><em class="citetitle">Advanced Programming in the Unix Environment</em>. </span><span class="pagenums">1-2. </span></p></div><div class="biblioentry"><a id="idp52152184"></a><p>[3] <span class="authorgroup"><span class="firstname">Marshall</span> <span class="othername">Kirk</span> <span class="surname">McKusick</span> and <span class="firstname">George</span> <span class="surname">Neville-Neil</span>. </span><span class="copyright">Copyright © 2004 Addison-Wesley. </span><span class="biblioid">0-201-70245-2. </span><span class="publisher"><span class="publishername">Addison-Wesley. </span></span><span class="citetitle"><em class="citetitle">The Design and Implementation of the FreeBSD Operating System</em>. </span><span class="pagenums">1-2. </span></p></div><div class="biblioentry"><a id="Phrack"></a><p>[4] <span class="authorgroup"><span class="firstname">Aleph</span> <span class="surname">One</span>. </span><span class="citetitle"><em class="citetitle">Phrack 49; "Smashing the Stack for Fun and Profit"</em>. </span></p></div><div class="biblioentry"><a id="StackGuard"></a><p>[5] <span class="authorgroup"><span class="firstname">Chrispin</span> <span class="surname">Cowan</span>, <span class="firstname">Calton</span> <span class="surname">Pu</span>, and <span class="firstname">Dave</span> <span class="surname">Maier</span>. </span><span class="citetitle"><em class="citetitle">StackGuard; Automatic Adaptive Detection and Prevention of
        Buffer-Overflow Attacks</em>. </span></p></div><div class="biblioentry"><a id="OpenBSD"></a><p>[6] <span class="authorgroup"><span class="firstname">Todd</span> <span class="surname">Miller</span> and <span class="firstname">Theo</span> <span class="surname">de Raadt</span>. </span><span class="citetitle"><em class="citetitle">strlcpy and strlcat -- consistent, safe string copy and
	concatenation.</em>. </span></p></div></div></div><div class="index"><div xmlns="" class="titlepage"><div><div><h1 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="idp52655352"></a>Index</h1></div></div></div><div xmlns:xlink="http://www.w3.org/1999/xlink" class="index"><div class="indexdiv"><h3>A</h3><dl><dt id="ientry-idp49312120">arguments, <a class="indexterm" href="#secure-bufferov">Buffer Overflows</a></dt></dl></div><div class="indexdiv"><h3>B</h3><dl><dt id="ientry-idp49363704">bounds checking</dt><dd><dl><dt>compiler-based, <a class="indexterm" href="#idp49363192">Compiler based run-time bounds checking</a></dt><dt>library-based, <a class="indexterm" href="#idp49370232">Library based run-time bounds checking</a></dt></dl></dd><dt id="ientry-idp49309816">buffer overflow, <a class="indexterm" href="#secure-bufferov">Buffer Overflows</a>, <a class="indexterm" href="#idp49363192">Compiler based run-time bounds checking</a></dt></dl></div><div class="indexdiv"><h3>C</h3><dl><dt id="ientry-idp49383032">chroot(), <a class="indexterm" href="#secure-chroot">Limiting your program's environment</a></dt><dt id="ientry-idp49175416">contributed software, <a class="indexterm" href="#policies-contributed">Contributed Software</a></dt><dt id="ientry-idp49697784">core
		  team, <a class="indexterm" href="#policies-encumbered">Encumbered Files</a></dt></dl></div><div class="indexdiv"><h3>D</h3><dl><dt id="ientry-idp49451256">data validation, <a class="indexterm" href="#secure-trust">Trust</a></dt></dl></div><div class="indexdiv"><h3>F</h3><dl><dt id="ientry-idp49315960">frame pointer, <a class="indexterm" href="#secure-bufferov">Buffer Overflows</a></dt></dl></div><div class="indexdiv"><h3>G</h3><dl><dt id="ientry-idp49366008">gcc, <a class="indexterm" href="#idp49363192">Compiler based run-time bounds checking</a></dt><dt id="ientry-idp49484152">GTK, <a class="indexterm" href="#l10n-programming">Programming I18N Compliant Applications</a></dt></dl></div><div class="indexdiv"><h3>J</h3><dl><dt id="ientry-idp49400568">jail, <a class="indexterm" href="#idp49400056">FreeBSD's jail functionality</a></dt></dl></div><div class="indexdiv"><h3>L</h3><dl><dt id="ientry-idp49312888">LIFO, <a class="indexterm" href="#secure-bufferov">Buffer Overflows</a></dt></dl></div><div class="indexdiv"><h3>M</h3><dl><dt id="ientry-idp49310840">Morris Internet worm, <a class="indexterm" href="#secure-bufferov">Buffer Overflows</a></dt></dl></div><div class="indexdiv"><h3>N</h3><dl><dt id="ientry-idp49358328">NUL termination, <a class="indexterm" href="#idp49350392">Avoiding Buffer Overflows</a></dt></dl></div><div class="indexdiv"><h3>P</h3><dl><dt id="ientry-idp49488504">Perl, <a class="indexterm" href="#idp49487864">Perl and Python</a></dt><dt id="ientry-idp49452152">Perl Taint mode, <a class="indexterm" href="#secure-trust">Trust</a></dt><dt id="ientry-idp49575032">ports maintainer, <a class="indexterm" href="#policies-maintainer">MAINTAINER on Makefiles</a></dt><dt id="ientry-idp49450744">positive filtering, <a class="indexterm" href="#secure-trust">Trust</a></dt><dt id="ientry-idp49442680">POSIX.1e Process Capabilities, <a class="indexterm" href="#idp49441784">POSIX®.1e Process Capabilities</a></dt><dt id="ientry-idp49313400">process image</dt><dd><dl><dt>frame pointer, <a class="indexterm" href="#secure-bufferov">Buffer Overflows</a></dt><dt>stack pointer, <a class="indexterm" href="#secure-bufferov">Buffer Overflows</a></dt></dl></dd><dt id="ientry-idp49364984">ProPolice, <a class="indexterm" href="#idp49363192">Compiler based run-time bounds checking</a></dt><dt id="ientry-idp49489272">Python, <a class="indexterm" href="#idp49487864">Perl and Python</a></dt></dl></div><div class="indexdiv"><h3>Q</h3><dl><dt id="ientry-idp49483640">Qt, <a class="indexterm" href="#l10n-programming">Programming I18N Compliant Applications</a></dt></dl></div><div class="indexdiv"><h3>R</h3><dl><dt id="ientry-idp49455480">race conditions</dt><dd><dl><dt>access checks, <a class="indexterm" href="#secure-race-conditions">Race Conditions</a></dt><dt>file opens, <a class="indexterm" href="#secure-race-conditions">Race Conditions</a></dt><dt>signals, <a class="indexterm" href="#secure-race-conditions">Race Conditions</a></dt></dl></dd><dt id="ientry-idp49699832">release
		  engineering, <a class="indexterm" href="#policies-encumbered">Encumbered Files</a></dt><dt id="ientry-idp49317624">return address, <a class="indexterm" href="#secure-bufferov">Buffer Overflows</a></dt></dl></div><div class="indexdiv"><h3>S</h3><dl><dt id="ientry-idp49376760">seteuid, <a class="indexterm" href="#secure-setuid">SetUID issues</a></dt><dt id="ientry-idp49311608">stack, <a class="indexterm" href="#secure-bufferov">Buffer Overflows</a></dt><dt id="ientry-idp49314552">stack frame, <a class="indexterm" href="#secure-bufferov">Buffer Overflows</a></dt><dt id="ientry-idp49315064">stack pointer, <a class="indexterm" href="#secure-bufferov">Buffer Overflows</a></dt><dt id="ientry-idp49318136">stack-overflow, <a class="indexterm" href="#secure-bufferov">Buffer Overflows</a></dt><dt id="ientry-idp49365496">StackGuard, <a class="indexterm" href="#idp49363192">Compiler based run-time bounds checking</a></dt><dt id="ientry-idp49356024">string copy functions</dt><dd><dl><dt>strlcat, <a class="indexterm" href="#idp49350392">Avoiding Buffer Overflows</a></dt><dt>strlcpy, <a class="indexterm" href="#idp49350392">Avoiding Buffer Overflows</a></dt><dt>strncat, <a class="indexterm" href="#idp49350392">Avoiding Buffer Overflows</a></dt><dt>strncpy, <a class="indexterm" href="#idp49350392">Avoiding Buffer Overflows</a></dt></dl></dd><dt id="ientry-idp49567352">style, <a class="indexterm" href="#policies-style">Style Guidelines</a></dt></dl></div><div class="indexdiv"><h3>T</h3><dl><dt id="ientry-idp49443192">TrustedBSD, <a class="indexterm" href="#idp49441784">POSIX®.1e Process Capabilities</a></dt></dl></div><div class="indexdiv"><h3>U</h3><dl><dt id="ientry-idp49377656">user IDs</dt><dd><dl><dt>effective user ID, <a class="indexterm" href="#secure-setuid">SetUID issues</a></dt><dt>real user ID, <a class="indexterm" href="#secure-setuid">SetUID issues</a></dt></dl></dd></dl></div><div class="indexdiv"><h3>V</h3><dl><dt id="ientry-idp49310328">von Neumann, <a class="indexterm" href="#secure-bufferov">Buffer Overflows</a></dt></dl></div></div></div></div></body></html>