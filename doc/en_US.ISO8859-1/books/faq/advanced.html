<?xml version="1.0" encoding="iso-8859-1" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" /><title>Chapter 17. Advanced Topics</title><link rel="stylesheet" type="text/css" href="docbook.css" /><link rev="made" href="mailto:doc@FreeBSD.org" /><meta name="generator" content="DocBook XSL Stylesheets V1.79.1" /><link rel="home" href="index.html" title="Frequently Asked Questions for FreeBSD 11.X and 12.X" /><link rel="up" href="index.html" title="Frequently Asked Questions for FreeBSD 11.X and 12.X" /><link rel="prev" href="funnies.html" title="Chapter 16. The FreeBSD Funnies" /><link rel="next" href="acknowledgments.html" title="Chapter 18. Acknowledgments" /><link rel="copyright" href="legalnotice.html" title="Copyright" /><script xmlns="" type="text/javascript" src="/layout/js/google.js"></script></head><body><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">Chapter 17. Advanced Topics</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="funnies.html">Prev</a> </td><th width="60%" align="center"> </th><td width="20%" align="right"> <a accesskey="n" href="acknowledgments.html">Next</a></td></tr></table><hr /></div><div class="chapter"><div xmlns="" class="titlepage"><div><div><h1 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="advanced"></a>Chapter 17. Advanced Topics</h1></div></div></div><div class="qandaset"><a id="idp52427512"></a><dl><dt>17.1. <a href="advanced.html#idp52440056">How can I learn more about FreeBSD's internals?</a></dt><dt>17.2. <a href="advanced.html#idp52443512">How can I contribute to FreeBSD?  What can I do to
	    help?</a></dt><dt>17.3. <a href="advanced.html#idp52446456">What are snapshots and releases?</a></dt><dt>17.4. <a href="advanced.html#idp52462328">How can I make the most of the data I see when my
	    kernel panics?</a></dt><dt>17.5. <a href="advanced.html#idp52553976">Why has dlsym() stopped working
	    for ELF executables?</a></dt><dt>17.6. <a href="advanced.html#idp52559096">How can I increase or reduce the kernel address space
	    on i386?</a></dt></dl><table border="0" style="width: 100%;"><colgroup><col align="left" width="1%" /><col /></colgroup><tbody><tr class="question"><td align="left" valign="top"><a id="idp52440056"></a><a id="learn-advanced"></a><p><strong>17.1.</strong></p></td><td align="left" valign="top"><p>How can I learn more about FreeBSD's internals?</p></td></tr><tr class="answer"><td align="left" valign="top"></td><td align="left" valign="top"><p>See the <a class="link" href="../../../../doc/en_US.ISO8859-1/books/arch-handbook" target="_top">FreeBSD
	      Architecture Handbook</a>.</p><p>Additionally, much general <span class="trademark">UNIX</span>® knowledge is
	    directly applicable to FreeBSD.</p></td></tr><tr class="question"><td align="left" valign="top"><a id="idp52443512"></a><a id="how-to-contribute"></a><p><strong>17.2.</strong></p></td><td align="left" valign="top"><p>How can I contribute to FreeBSD?  What can I do to
	    help?</p></td></tr><tr class="answer"><td align="left" valign="top"></td><td align="left" valign="top"><p>We accept all types of contributions: documentation,
	    code, and even art.  See the article on <a class="link" href="../../../../doc/en_US.ISO8859-1/articles/contributing/article.html" target="_top">Contributing
	      to FreeBSD</a> for specific advice on how to do
	    this.</p><p>And thanks for the thought!</p></td></tr><tr class="question"><td align="left" valign="top"><a id="idp52446456"></a><a id="define-snap-release"></a><p><strong>17.3.</strong></p></td><td align="left" valign="top"><p>What are snapshots and releases?</p></td></tr><tr class="answer"><td align="left" valign="top"></td><td align="left" valign="top"><p>There are currently 3 active/semi-active
	    branches in the FreeBSD <a class="link" href="http://svnweb.FreeBSD.org/base/" target="_top">Subversion
	      Repository</a>.  (Earlier branches are only changed
	    very rarely, which is why there are only 3
	    active branches of development):</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p><span class="symbol">stable/11/</span> AKA
		<span class="emphasis"><em>11-STABLE</em></span></p></li><li class="listitem"><p><span class="symbol">stable/12/</span> AKA
		<span class="emphasis"><em>12-STABLE</em></span></p></li><li class="listitem"><p><span class="symbol">head/</span> AKA
		<span class="emphasis"><em>-CURRENT</em></span> AKA
		<span class="emphasis"><em>13-CURRENT</em></span></p></li></ul></div><p><code class="literal">HEAD</code> is not an actual branch tag.
	    It is a symbolic constant for
	    the current, non-branched development
		stream known as
	    <span class="emphasis"><em>-CURRENT</em></span>.</p><p>Right now, <span class="emphasis"><em>-CURRENT</em></span> is the
	    13.<em class="replaceable"><code>X</code></em> development stream; the <span class="emphasis"><em>12-STABLE</em></span>
	    branch, <span class="symbol">stable/12/</span>, forked off from
	    <span class="emphasis"><em>-CURRENT</em></span> in December 2018 and the
	    <span class="emphasis"><em>11-STABLE</em></span> branch, <span class="symbol">stable/11/</span>, forked off from
	    <span class="emphasis"><em>-CURRENT</em></span> in October 2016.</p></td></tr><tr class="question"><td align="left" valign="top"><a id="idp52462328"></a><a id="kernel-panic-troubleshooting"></a><p><strong>17.4.</strong></p></td><td align="left" valign="top"><p>How can I make the most of the data I see when my
	    kernel panics?</p></td></tr><tr class="answer"><td align="left" valign="top"></td><td align="left" valign="top"><p>Here is typical kernel panic:</p><pre class="programlisting">Fatal trap 12: page fault while in kernel mode
fault virtual address   = 0x40
fault code              = supervisor read, page not present
instruction pointer     = 0x8:0xf014a7e5
stack pointer           = 0x10:0xf4ed6f24
frame pointer           = 0x10:0xf4ed6f28
code segment            = base 0x0, limit 0xfffff, type 0x1b
                        = DPL 0, pres 1, def32 1, gran 1
processor eflags        = interrupt enabled, resume, IOPL = 0
current process         = 80 (mount)
interrupt mask          =
trap number             = 12
panic: page fault</pre><p>This message is not enough.  While the instruction
	    pointer value is important, it is also configuration
	    dependent as it varies depending on the kernel image.
	    If it is a <code class="filename">GENERIC</code> kernel
	    image from one of the snapshots, it is possible for
	    somebody else to track down the offending function, but
	    for a custom kernel, only you can tell us where the fault
	    occurred.</p><p>To proceed:</p><div class="procedure"><ol class="procedure" type="1"><li class="step"><p>Write down the instruction pointer value.  Note
		that the <code class="literal">0x8:</code> part at the beginning
		is not significant in this case: it is the
		<code class="literal">0xf0xxxxxx</code> part that we
		want.</p></li><li class="step"><p>When the system reboots, do the following:</p><pre class="screen"><code class="prompt">%</code> <strong class="userinput"><code>nm -n kernel.that.caused.the.panic | grep f0xxxxxx</code></strong></pre><p>where <code class="literal">f0xxxxxx</code> is the
		instruction pointer value.  The odds are you will not
		get an exact match since the symbols in the kernel
		symbol table are for the entry points of functions and
		the instruction pointer address will be somewhere
		inside a function, not at the start.  If you do not
		get an exact match, omit the last digit from the
		instruction pointer value and try again:</p><pre class="screen"><code class="prompt">%</code> <strong class="userinput"><code>nm -n kernel.that.caused.the.panic | grep f0xxxxx</code></strong></pre><p>If that does not yield any results, chop off
		another digit.  Repeat until there is some sort of
		output.  The result will be a possible list of
		functions which caused the panic.  This is a less than
		exact mechanism for tracking down the point of
		failure, but it is better than nothing.</p></li></ol></div><p>However, the best way to track down the cause of a
	    panic is by capturing a crash dump, then using
	    <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=kgdb&amp;sektion=1&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">kgdb</span>(1)</span></a> to generate a stack trace on the crash
	    dump.</p><p>In any case, the method is this:</p><div class="procedure"><ol class="procedure" type="1"><li class="step"><p>Make sure that the following line is included in
		the kernel configuration file:</p><pre class="programlisting">makeoptions     DEBUG=-g          # Build kernel with gdb(1) debug symbols</pre></li><li class="step"><p>Change to the <code class="filename">/usr/src</code>
		directory:</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>cd /usr/src</code></strong></pre></li><li class="step"><p>Compile the kernel:</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>make buildkernel KERNCONF=<em class="replaceable"><code>MYKERNEL</code></em></code></strong></pre></li><li class="step"><p>Wait for <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=make&amp;sektion=1&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">make</span>(1)</span></a> to finish compiling.</p></li><li class="step"><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>make installkernel KERNCONF=MYKERNEL</code></strong></pre></li><li class="step"><p>Reboot.</p></li></ol></div><div xmlns="" class="note"><h3 class="admontitle">Note: </h3><p xmlns="http://www.w3.org/1999/xhtml">If <code class="varname">KERNCONF</code> is not included,
	      the <code class="filename">GENERIC</code> kernel will instead
	      be built and installed.</p></div><p>The <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=make&amp;sektion=1&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">make</span>(1)</span></a> process will have built two kernels.
	    <code class="filename">/usr/obj/usr/src/sys/MYKERNEL/kernel</code>
	    and
	    <code class="filename">/usr/obj/usr/src/sys/MYKERNEL/kernel.debug</code>.
	    <code class="filename">kernel</code> was installed as
	    <code class="filename">/boot/kernel/kernel</code>, while
	    <code class="filename">kernel.debug</code> can be used as the
	    source of debugging symbols for <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=kgdb&amp;sektion=1&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">kgdb</span>(1)</span></a>.</p><p>To capture a crash dump, edit
	    <code class="filename">/etc/rc.conf</code> and set
	    <code class="literal">dumpdev</code> to point to either the swap
	    partition or <code class="literal">AUTO</code>.  This will cause the
	    <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=rc&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">rc</span>(8)</span></a> scripts to use the <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=dumpon&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">dumpon</span>(8)</span></a> command to
	    enable crash dumps.  This command can also be run
	    manually.  After a panic, the crash dump can be recovered
	    using <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=savecore&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">savecore</span>(8)</span></a>; if <code class="literal">dumpdev</code> is
	    set in <code class="filename">/etc/rc.conf</code>, the <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=rc&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">rc</span>(8)</span></a>
	    scripts will run <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=savecore&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">savecore</span>(8)</span></a> automatically and put
	    the crash dump in <code class="filename">/var/crash</code>.</p><div xmlns="" class="note"><h3 class="admontitle">Note: </h3><p xmlns="http://www.w3.org/1999/xhtml">FreeBSD crash dumps are usually the same size as
	      physical RAM.  Therefore, make sure there is enough
	      space in <code class="filename">/var/crash</code> to hold the
	      dump.  Alternatively, run <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=savecore&amp;sektion=8&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">savecore</span>(8)</span></a> manually
	      and have it recover the crash dump to another directory
	      with more room.  It is possible to limit the
	      size of the crash dump by using <code class="literal">options
		MAXMEM=N</code> where
	      <em class="replaceable"><code>N</code></em> is the size of kernel's
	      memory usage in KBs.  For example, for 1 GB
	      of RAM, limit the kernel's memory usage to
	      128 MB, so that the crash dump size
	      will be 128 MB instead of 1 GB.</p></div><p>Once the crash dump has been recovered , get a
	    stack trace as follows:</p><pre class="screen"><code class="prompt">%</code> <strong class="userinput"><code>kgdb /usr/obj/usr/src/sys/MYKERNEL/kernel.debug /var/crash/vmcore.0</code></strong>
<code class="prompt">(kgdb)</code> <strong class="userinput"><code>backtrace</code></strong></pre><p>Note that there may be several screens worth of
	    information.  Ideally, use <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=script&amp;sektion=1&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">script</span>(1)</span></a> to
	    capture all of them.  Using the unstripped kernel image
	    with all the debug symbols should show the exact line of
	    kernel source code where the panic occurred.  The stack
	    trace is usually read from the bottom up to trace
	    the exact sequence of events that lead to the crash.
	    <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=kgdb&amp;sektion=1&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">kgdb</span>(1)</span></a> can also be used to print out the contents of
	    various variables or structures to examine the system
	    state at the time of the crash.</p><div xmlns="" class="tip"><h3 class="admontitle">Tip: </h3><p xmlns="http://www.w3.org/1999/xhtml">If a second computer is available, <a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=kgdb&amp;sektion=1&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">kgdb</span>(1)</span></a> can
	      be configured to do remote debugging, including setting
	      breakpoints and single-stepping through the kernel
	      code.</p></div><div xmlns="" class="note"><h3 class="admontitle">Note: </h3><p xmlns="http://www.w3.org/1999/xhtml">If <code class="literal">DDB</code> is enabled and the
	      kernel drops into the debugger, a panic
	      and a crash dump can be forced by typing
	      <code class="literal">panic</code> at the <code class="literal">ddb</code>
	      prompt.  It may stop in the debugger again during the
	      panic phase.  If it does, type
	      <code class="literal">continue</code> and it will finish the crash
	      dump.</p></div></td></tr><tr class="question"><td align="left" valign="top"><a id="idp52553976"></a><a id="dlsym-failure"></a><p><strong>17.5.</strong></p></td><td align="left" valign="top"><p>Why has <code class="function">dlsym()</code> stopped working
	    for ELF executables?</p></td></tr><tr class="answer"><td align="left" valign="top"></td><td align="left" valign="top"><p>The ELF toolchain does not, by default, make the
	    symbols defined in an executable visible to the dynamic
	    linker.  Consequently <code class="function">dlsym()</code>
	    searches on handles obtained from calls to
	    <code class="function">dlopen(NULL, flags)</code> will fail to find
	    such symbols.</p><p>To search, using
	    <code class="function">dlsym()</code>, for symbols present in the
	    main executable of a process, link the
	    executable using the <code class="option">--export-dynamic</code>
	    option to the ELF linker (<a class="citerefentry" href="https://www.FreeBSD.org/cgi/man.cgi?query=ld&amp;sektion=1&amp;manpath=freebsd-release-ports"><span class="citerefentry"><span class="refentrytitle">ld</span>(1)</span></a>).</p></td></tr><tr class="question"><td align="left" valign="top"><a id="idp52559096"></a><a id="change-kernel-address-space"></a><p><strong>17.6.</strong></p></td><td align="left" valign="top"><p>How can I increase or reduce the kernel address space
	    on i386?</p></td></tr><tr class="answer"><td align="left" valign="top"></td><td align="left" valign="top"><p>By default, the kernel address space is 1 GB
	    (2 GB for PAE) for i386.  When running a
	    network-intensive server or using
	    ZFS, this will probably not be
	    enough.</p><p>Add the following line to the kernel configuration
	    file to increase available space and rebuild the
	    kernel:</p><pre class="programlisting">options KVA_PAGES=<em class="replaceable"><code>N</code></em></pre><p>To find the correct value of
	    <em class="replaceable"><code>N</code></em>, divide the desired address
	    space size (in megabytes) by four.  (For example, it is
	    <code class="literal">512</code> for 2 GB.)</p></td></tr></tbody></table></div></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="funnies.html">Prev</a> </td><td width="20%" align="center"> </td><td width="40%" align="right"> <a accesskey="n" href="acknowledgments.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top">Chapter 16. The FreeBSD Funnies </td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right" valign="top"> Chapter 18. Acknowledgments</td></tr></table></div><p xmlns="" align="center"><small>All FreeBSD documents are available for download
    at <a href="https://download.freebsd.org/ftp/doc/">https://download.freebsd.org/ftp/doc/</a></small></p><p xmlns="" align="center"><small>Questions that are not answered by the
    <a href="https://www.FreeBSD.org/docs.html">documentation</a> may be
    sent to &lt;<a href="mailto:freebsd-questions@FreeBSD.org">freebsd-questions@FreeBSD.org</a>&gt;.<br />
    Send questions about this document to &lt;<a href="mailto:freebsd-doc@FreeBSD.org">freebsd-doc@FreeBSD.org</a>&gt;.</small></p></body></html>